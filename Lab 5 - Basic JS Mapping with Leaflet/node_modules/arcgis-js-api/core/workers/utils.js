/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../has","../promiseUtils"],(function(e,r,t){"use strict";const s="worker:port-closed";var n;e.MessageType=void 0,(n=e.MessageType||(e.MessageType={}))[n.HANDSHAKE=0]="HANDSHAKE",n[n.OPEN=1]="OPEN",n[n.OPENED=2]="OPENED",n[n.RESPONSE=3]="RESPONSE",n[n.INVOKE=4]="INVOKE",n[n.ABORT=5]="ABORT",n[n.CLOSE=6]="CLOSE",n[n.OPEN_PORT=7]="OPEN_PORT",n[n.ON=8]="ON";let o=0;function a(){return o++}function i(e){return e&&"object"==typeof e&&("result"in e||"transferList"in e)}function f(e){return e?"string"==typeof e?JSON.stringify({name:"message",message:e}):e.toJSON?JSON.stringify(e):JSON.stringify({name:e.name,message:e.message,details:e.details||{stack:e.stack}}):null}function u(t,s,n,o){if(s.type===e.MessageType.OPEN_PORT)return void t.postMessage(s,[s.port]);if(s.type!==e.MessageType.INVOKE&&s.type!==e.MessageType.RESPONSE)return void t.postMessage(s);let a;if(i(n)?(a=g(n.transferList),s.data=n.result):(a=g(o),s.data=n),a){if(r("ff"))for(const r of a)if("byteLength"in r&&r.byteLength>267386880){const r="Worker call with large ArrayBuffer would crash Firefox";switch(s.type){case e.MessageType.INVOKE:throw r;case e.MessageType.RESPONSE:return void u(t,{type:e.MessageType.RESPONSE,jobId:s.jobId,error:f(r)})}}t.postMessage(s,a)}else t.postMessage(s)}function c(e){if(!e)return null;const r=e.data;return r?"string"==typeof r?JSON.parse(r):r:null}function g(e){if(!e?.length)return null;if(r("esri-workers-arraybuffer-transfer"))return e;const t=e.filter((e=>!l(e)));return t.length?t:null}function l(e){return e instanceof ArrayBuffer||"ArrayBuffer"===e?.constructor?.name}async function E(e){try{return await e}catch(r){const e=r?.name===s;if(!(t.isAbortError(r)||e))throw r;return}}e.ignoreConnectionErrors=E,e.isTransferrableResult=i,e.newJobId=a,e.portClosedErrorName=s,e.postMessage=u,e.receiveMessage=c,e.toInvokeError=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
