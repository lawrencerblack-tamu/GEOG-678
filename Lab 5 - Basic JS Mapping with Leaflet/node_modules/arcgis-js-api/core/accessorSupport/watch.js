/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../ArrayPool","../handleUtils","../lang","../ReentrantObjectPool","../scheduling","../SetUtils","../uid","./get","./interfaces","./trackingUtils","./utils"],(function(e,t,l,r,a,n,c,i,o,u,s,d){"use strict";var h;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(h||(h={}));class f{constructor(){this.uid=i.generateUID(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,t,l,a,n){return this.pool.acquire(h.Untracked,e,t,l,a,n,r.equals)}static acquireTracked(e,t,l,r){return this.pool.acquire(h.Tracked,e,t,l,null,null,r)}notify(e,t){this.type===h.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t,void 0,void 0)}acquire(e,t,l,r,a,n,c){this.uid=i.generateUID(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=l,this.getValue=r,this.target=a,this.path=n,this.equals=c}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=i.generateUID(),this.removed=!0}}f.pool=new a.ReentrantObjectPool(f);const v=new t,m=new Set;let k;function g(e){m.delete(e),m.add(e),k||(k=n.schedule(q))}function p(e){if(e.removed)return;const t=e.oldValue,l=e.getValue();e.equals(t,l)||(e.oldValue=l,e.notify(l,t))}function _(e){for(const t of m.values())t.target===e&&(t.removed=!0)}function q(){let e=10;for(;k&&e--;){k=null;const e=y(),t=v.acquire();for(const l of e){const e=l.uid;p(l),e===l.uid&&l.removed&&t.push(l)}for(const l of m)l.removed&&(t.push(l),m.delete(l));for(const l of t)f.pool.release(l);v.release(t),v.release(e),U.forEach((e=>e()))}}function y(){const e=v.acquire();e.length=m.size;let t=0;for(const l of m)e[t]=l,++t;return m.clear(),e}const U=new Set;function D(e){return U.add(e),l.makeHandle((()=>U.delete(e)))}function T(e,t,r){let a=d.parse(e,t,r,((e,t,r)=>{let n,c,i=s.reactionDeferred((()=>o.valueOf(e,t)),((l,i)=>{e.__accessor__?.lifecycle===u.Lifecycle.DESTROYED||n&&n.uid!==c?a.remove():(n||(n=f.acquireUntracked(l,r,i,e,t),c=n.uid),g(n))}));return l.makeHandle((()=>{i.remove(),n&&(n.uid!==c||n.removed||(n.removed=!0,g(n)),n=null),a=i=null}))}));return a}function V(e,t,l){const a=d.parse(e,t,l,((e,t,l)=>{let n=!1;return s.reaction((()=>o.valueOf(e,t)),((c,i)=>{e.__accessor__.lifecycle!==u.Lifecycle.DESTROYED?n||(n=!0,r.equals(i,c)||l.call(e,c,i,t,e),n=!1):a.remove()}))}));return a}function S(e,t,r,a=!1){return e.__accessor__&&e.__accessor__.lifecycle!==u.Lifecycle.DESTROYED?a?V(e,t,r):T(e,t,r):l.makeHandle()}function b(e,t,r){let a,n,c=s.reactionDeferred(e,((e,l)=>{a&&a.uid!==n?c.remove():(a||(a=f.acquireTracked(e,t,l,r),n=a.uid),g(a))}));return l.makeHandle((()=>{c.remove(),a&&(a.uid!==n||a.removed||(a.removed=!0,g(a)),a=null),c=null}))}function O(e,t,l){let r=!1;return s.reaction(e,((e,a)=>{r||(r=!0,l(a,e)||t(e,a),r=!1)}))}function w(e,t,l=!1,a=r.equalsShallow){return l?O(e,t,a):b(e,t,a)}function E(e){return c.someSet(m,(t=>t.oldValue===e))}e.afterDispatch=D,e.dispatch=q,e.isValueInUse=E,e.removeTarget=_,e.watch=S,e.watchTracked=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
