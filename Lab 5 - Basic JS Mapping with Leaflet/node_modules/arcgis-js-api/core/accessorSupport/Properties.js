/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../has","../lang","../Logger","../ObjectPool","./interfaces","./Property","./PropertyOrigin","./Store","./tracking","./tracking/Flags"],(function(e,t,i,s,r,a,n,o,c,l){"use strict";function h(e,t,i){return void 0!==e}function g(e,t,i,s){return void 0!==e&&(!(null==i&&e.flags&l.Flags.NonNullable)||(s.lifecycle,r.Lifecycle.INITIALIZING,!1))}class d{constructor(e){this.host=e,this.propertiesByName=new Map,this.ctorArgs=null,this.lifecycle=r.Lifecycle.INITIALIZING,this.store=new o.Store,this._origin=n.OriginId.USER;const t=this.host.constructor.__accessorMetadata__;for(const i in t){const e=new a.Property(i,t[i]);this.propertiesByName.set(i,e)}this.metadata=t}initialize(){this.lifecycle=r.Lifecycle.CONSTRUCTING}constructed(){this.lifecycle=r.Lifecycle.CONSTRUCTED}destroy(){this.lifecycle=r.Lifecycle.DESTROYED,this.propertiesByName.forEach((e=>e.destroy()))}get initialized(){return this.lifecycle!==r.Lifecycle.INITIALIZING}get(e){const t=this.propertiesByName.get(e);if(t.metadata.get)return t.getComputed(this);c.trackAccess(t);const i=this.store;return i.has(e)?i.get(e):t.metadata.value}originOf(e){const t=this.store.originOf(e);if(void 0===t){const t=this.propertiesByName.get(e);if(void 0!==t&&t.flags&l.Flags.HasDefaultValue)return"defaults"}return n.idToName(t)}has(e){return this.propertiesByName.has(e)&&this.store.has(e)}keys(){return[...this.propertiesByName.keys()]}internalGet(e){const t=this.propertiesByName.get(e);if(h(t))return this.store.has(e)?this.store.get(e):t.metadata.value}internalSet(e,t){const i=this.propertiesByName.get(e);h(i)&&this._internalSet(i,t)}getDependsInfo(e,t,i){const s=this.propertiesByName.get(t);if(!h(s))return"";const r=new Set,n=c.runTracked({onObservableAccessed:e=>r.add(e),onTrackingEnd:()=>{}},(()=>s.metadata.get?.call(e)));let o=`${i}${e.declaredClass.split(".").pop()}.${t}: ${n}\n`;if(0===r.size)return o;i+="  ";for(const c of r){if(!(c instanceof a.Property))continue;o+=`${i}${c.propertyName}: undefined\n`}return o}setAtOrigin(e,t,i){const s=this.propertiesByName.get(e);if(h(s))return this._setAtOrigin(s,t,i)}isOverridden(e){const t=this.propertiesByName.get(e);return void 0!==t&&!!(t.flags&l.Flags.Overridden)}clearOverride(e){const t=this.propertiesByName.get(e);t&&t.flags&l.Flags.Overridden&&(t.flags&=~l.Flags.Overridden,t.notifyChange())}override(e,t){const i=this.propertiesByName.get(e);if(!g(i,e,t,this))return;const s=i.metadata.cast;if(s){const e=this._cast(s,t),{valid:i,value:r}=e;if(u.release(e),!i)return;t=r}i.flags|=l.Flags.Overridden,this._internalSet(i,t)}set(e,t){const i=this.propertiesByName.get(e);if(!g(i,e,t,this))return;const s=i.metadata.cast;if(s){const e=this._cast(s,t),{valid:i,value:r}=e;if(u.release(e),!i)return;t=r}const r=i.metadata.set;r?r.call(this.host,t):this._internalSet(i,t)}setDefaultOrigin(e){this._origin=n.nameToId(e)}getDefaultOrigin(){return n.idToName(this._origin)}notifyChange(e){const t=this.propertiesByName.get(e);void 0!==t&&t.notifyChange()}invalidate(e){const t=this.propertiesByName.get(e);void 0!==t&&t.invalidate()}commit(e){const t=this.propertiesByName.get(e);void 0!==t&&t.commit()}_internalSet(e,t){const i=this.lifecycle!==r.Lifecycle.INITIALIZING?this._origin:n.OriginId.DEFAULTS;this._setAtOrigin(e,t,i)}_setAtOrigin(e,i,s){const r=this.store,a=e.propertyName;r.has(a,s)&&t.equals(i,r.get(a))&&~e.flags&l.Flags.Overridden&&s===r.originOf(a)||(e.invalidate(),r.set(a,i,s),e.commit(),c.initializeDependencyTracking(this.host,e))}_cast(e,t){const i=u.acquire();return i.valid=!0,i.value=t,e&&(i.value=e.call(this.host,t,i)),i}}class f{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}}const u=new s(f);return d}));
