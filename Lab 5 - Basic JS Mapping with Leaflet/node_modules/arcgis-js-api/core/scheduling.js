/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","./nextTick","./PerformanceSampler","./PooledArray","./promiseUtils","./time"],(function(e,t,n,r,s,i){"use strict";class a{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}}class o{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}}let c=0,l=0;const m={time:i.Milliseconds(0),deltaTime:i.Milliseconds(0),elapsedFrameTime:i.Milliseconds(0),frameDuration:i.Milliseconds(0)},u=["prepare","preRender","render","postRender","update","finish"],d=[],p=new r;class f{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}}function h(){null!=v&&(cancelAnimationFrame(v),v=requestAnimationFrame(M))}const w={frameTasks:p,willDispatch:!1,clearFrameTasks:A,dispatch:D,executeFrameTasks:x,reschedule:h};function k(e){const n=new o(e);return d.push(n),w.willDispatch||(w.willDispatch=!0,t.nextTick(D)),n}function T(e){const t=new a(e);return p.push(t),null==v&&(c=performance.now(),v=requestAnimationFrame(M)),new f(t)}let v=null;function A(e=!1){p.forAll((e=>{e.removed=!0})),e&&g()}function F(e){l=Math.max(0,e)}function M(){const e=performance.now();v=null,v=p.length>0?requestAnimationFrame(M):null,w.executeFrameTasks(e)}function x(e){const t=i.Milliseconds(e-c);c=e;const n=l>0?l:1e3/60,r=Math.max(0,t-n);m.time=e,m.frameDuration=i.Milliseconds(n-r);for(let s=0;s<u.length;s++){const n=performance.now(),r=u[s];p.forAll((n=>{if(n.paused||n.removed)return;0===s&&n.ticks++;n.phases[r]&&(m.elapsedFrameTime=i.Milliseconds(performance.now()-e),m.deltaTime=0===n.ticks?i.Milliseconds(0):t,n.phases[r]?.call(n,m))})),_[s].record(performance.now()-n)}g(),S.record(performance.now()-e)}const b=new r;function g(){p.forAll((e=>{e.removed&&b.push(e)})),p.removeUnorderedMany(b.data,b.length),b.clear()}function D(){for(;d.length;){const e=d.shift();e.isActive&&e.callback()}w.willDispatch=!1}function R(e=1,n){const r=s.createResolver(),i=()=>{s.isAborted(n)?r.reject(s.createAbortError()):0===e?r():(--e,t.nextTick((()=>i())))};return i(),r.promise}function y(e){return R(1,e)}function q(){const e=s.createResolver(),t=T({postRender:()=>{t.remove(),k(e)}});return e.promise}async function P(){await y(),await new Promise((e=>requestAnimationFrame(e)))}const _=u.map((e=>new n(e))),S=new n("total");e.FrameTaskHandle=f,e.addFrameTask=T,e.debug=w,e.performanceInfo=_,e.performanceTotal=S,e.schedule=k,e.setFrameDuration=F,e.waitAnimationFrame=P,e.waitRender=q,e.waitTick=y,e.waitTicks=R,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
