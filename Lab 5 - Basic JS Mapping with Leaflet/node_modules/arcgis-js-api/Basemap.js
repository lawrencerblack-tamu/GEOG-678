/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","./chunks/tslib.es6","./request","./core/Collection","./core/collectionUtils","./core/JSONSupport","./core/lang","./core/Loadable","./core/loadAll","./core/Logger","./core/maybe","./core/promiseUtils","./core/urlUtils","./core/accessorSupport/decorators/property","./core/has","./core/accessorSupport/decorators/subclass","./core/accessorSupport/decorators/writer","./geometry/SpatialReference","./portal/Portal","./portal/PortalItem","./support/basemapDefinitions","./support/BasemapStyle","./webdoc/support/writeUtils"],(function(e,t,r,a,s,o,i,n,l,c,p,y,d,h,u,m,f,b,L,w,g,I,_){"use strict";var S;let v=0;const O="esri.Basemap";let M=S=class extends(o.JSONSupportMixin(n)){constructor(e){super(e),this.id=null,this.portalItem=null,this.spatialReference=null,this.style=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+v++,this.baseLayers=new a,this.referenceLayers=new a;const t=e=>{e.parent&&e.parent!==this&&"remove"in e.parent&&e.parent.remove(e),e.parent=this,"elevation"===e.type&&c.getLogger(this).error(`Layer '${e.title}, id:${e.id}' of type '${e.type}' is not supported as a basemap layer and will therefore be ignored.`)},r=e=>{e.parent=null};this.addHandles([this.baseLayers.on("after-add",(e=>t(e.item))),this.referenceLayers.on("after-add",(e=>t(e.item))),this.baseLayers.on("after-remove",(e=>r(e.item))),this.referenceLayers.on("after-remove",(e=>r(e.item)))])}initialize(){this.when().catch((e=>{c.getLogger(this).error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,e)})),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.baseLayers.toArray();for(const r of e)r.destroy();const t=this.referenceLayers.toArray();for(const r of t)r.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),this.portalItem=p.destroyMaybe(this.portalItem)}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e}set baseLayers(e){this._set("baseLayers",s.referenceSetter(e,this._get("baseLayers")))}_writeBaseLayers(e,t,r){const a=[];e?(r={...r,layerContainerType:"basemap"},this.baseLayers.forEach((e=>{const t=_.getLayerJSON(e,r.webmap?r.webmap.getLayerJSONFromResourceInfo(e):null,r);null!=t&&a.push(t)})),this.referenceLayers.forEach((e=>{const t=_.getLayerJSON(e,r.webmap?r.webmap.getLayerJSONFromResourceInfo(e):null,r);null!=t&&("scene"!==e.type&&(t.isReference=!0),a.push(t))})),t.baseMapLayers=a):t.baseMapLayers=a}set referenceLayers(e){this._set("referenceLayers",s.referenceSetter(e,this._get("referenceLayers")))}writeTitle(e,t){t.title=e||"Basemap"}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return l.loadAll(this,(e=>{e(this.baseLayers,this.referenceLayers)}))}clone(){const e={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.map((e=>i.isClonable(e)?e.clone():e)),referenceLayers:this.referenceLayers.map((e=>i.isClonable(e)?e.clone():e))};return this.loaded&&(e.loadStatus="loaded"),new S({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}write(e,t){return e=e||{},t?.origin||(t={origin:"web-map",...t}),super.write(e,t),!this.loaded&&this.resourceInfo?.data.baseMapLayers&&(e.baseMapLayers=this.resourceInfo.data.baseMapLayers.map((e=>{const t=i.clone(e);return t.url&&d.isProtocolRelative(t.url)&&(t.url=`https:${t.url}`),t.templateUrl&&d.isProtocolRelative(t.templateUrl)&&(t.templateUrl=`https:${t.templateUrl}`),t}))),e}async _loadFromSource(e){const{resourceInfo:t,portalItem:r,style:a}=this;y.throwIfAborted(e);const s=[];if(t){const r=t.context?t.context.url:null;if(s.push(this._loadLayersFromJSON(t.data,r,e)),t.data.id&&!t.data.title){const e=t.data.id;s.push(g.getBasemapTitle(e).then((e=>{e&&this.read({title:e},t.context)})))}}else r?s.push(this._loadFromItem(r,e)):a&&s.push(this._loadFromStylesService(a,e));await Promise.all(s)}async _loadLayersFromJSON(t,r,a){const s=this.resourceInfo?.context,o=this.portalItem?.portal||s?.portal||null,i=R[s?.origin||""]??"web-map",{populateOperationalLayers:n}=await new Promise(((t,r)=>e(["./layers/support/layersCreator"],t,r))),l=[];if(y.throwIfAborted(a),t.baseMapLayers&&Array.isArray(t.baseMapLayers)){const e={context:{...s,origin:i,url:r,portal:o,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},a=e=>"web-scene"===i&&"ArcGISSceneServiceLayer"===e.layerType||e.isReference,c=n(this.baseLayers,t.baseMapLayers.filter((e=>!a(e))),e);l.push(c);const p=n(this.referenceLayers,t.baseMapLayers.filter(a),e);l.push(p)}await Promise.allSettled(l)}async _loadFromItem(e,t){const r=await e.load(t),a=await r.fetchData("json",t),s=d.urlToObject(e.itemUrl??"");return this._set("resourceInfo",{data:a.baseMap??{},context:{origin:x[e.type||""]??"web-map",portal:e.portal||L.getDefault(),url:s}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:a.spatialReference},this.resourceInfo.context),this.read({title:e.title,thumbnailUrl:e.thumbnailUrl},{origin:"portal-item",portal:e.portal||L.getDefault(),url:s}),this._loadLayersFromJSON(this.resourceInfo.data,s,t)}async _loadFromStylesService(e,t){const a=`${e.serviceUrl}/${e.id}`,s=(await r(a,{query:{language:e.getLanguageParamValue(),places:e.places,worldview:e.worldview},signal:t?.signal})).data,o=d.urlToObject(a);return this._set("resourceInfo",{data:s.baseMap??{},context:{origin:"web-map",url:o}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:s.spatialReference},this.resourceInfo.context),this._loadLayersFromJSON(this.resourceInfo.data,o,t)}static fromId(e){const t=g.esriBasemapDefinitions[e];return t?t.itemId?new S({portalItem:{id:t.itemId,portal:{url:"https://www.arcgis.com"}}}):S.fromJSON(t,{origin:t.is3d?"web-scene":"web-map"}):null}};t.__decorate([h.property({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(e,t,r,a){this._writeBaseLayers(e,t,a)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:a}},writer(e,t,r,a){this._writeBaseLayers(e,t,a)}}}}}})],M.prototype,"baseLayers",null),t.__decorate([h.property({type:String,json:{origins:{"web-scene":{write:!0}}}})],M.prototype,"id",void 0),t.__decorate([h.property({type:w})],M.prototype,"portalItem",void 0),t.__decorate([h.property()],M.prototype,"referenceLayers",null),t.__decorate([h.property({readOnly:!0})],M.prototype,"resourceInfo",void 0),t.__decorate([h.property({type:b})],M.prototype,"spatialReference",void 0),t.__decorate([h.property({type:I})],M.prototype,"style",void 0),t.__decorate([h.property()],M.prototype,"thumbnailUrl",void 0),t.__decorate([h.property({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],M.prototype,"title",void 0),t.__decorate([f.writer("title")],M.prototype,"writeTitle",null),M=S=t.__decorate([m.subclass(O)],M);const x={"Web Scene":"web-scene","Web Map":"web-map","Link Chart":"link-chart"},R={"web-scene":"web-scene","web-map":"web-map","link-chart":"link-chart"};return M}));
