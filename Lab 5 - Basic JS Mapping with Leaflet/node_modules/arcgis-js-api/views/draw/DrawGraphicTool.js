/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../Graphic","../../core/Evented","../../core/handleUtils","../../core/maybe","../../core/quantityUtils","../../core/reactiveUtils","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../layers/GraphicsLayer","../../layers/graphics/dehydratedFeatureComparison","../../support/elevationInfoUtils","./support/createUtils","./support/helpMessageUtils","./support/surfaceCoordinateSystems","../interactive/InteractiveToolBase","../interactive/keybindings","../interactive/sketch/SketchOptions","../interactive/tooltip/constraintUtils","../interactive/tooltip/DrawTooltipInfos","../interactive/tooltip/Tooltip","../support/angularMeasurementUtils","../support/automaticAreaMeasurementUtils","../support/automaticLengthMeasurementUtils","../support/euclideanLengthMeasurementUtils","../../core/accessorSupport/trackingUtils"],(function(e,t,o,r,i,n,a,l,s,c,p,h,u,d,y,m,g,v,_,w,f,O,T,G,D,k,C,I,V,x,b){"use strict";class M{constructor(){this.committedVertices=null,this.cursorVertex=null,this.full=null,this.outline=null,this.cursorEdge=null,this.circle=null,this.rectangle=null}}e.DrawGraphicTool=class extends(r.EventedMixin(f.InteractiveToolBase)){constructor(e){super(e),this._graphic=null,this._createOperationGeometry=null,this.defaultZ=0,this.directionOptions=null,this.geometryType=null,this.hasZ=!0,this.geometryToPlace=null,this.mode=null,this.snappingManager=null,this.snapToScene=!1,this.sketchOptions=new T}initialize(){this.internalGraphicsLayer=new y({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer);const e=this.drawOperation=this.makeDrawOperation(),{sketchOptions:t}=this,o=this.view.type;this.tooltipInfos={point:new D.DrawPointTooltipInfo({sketchOptions:t,viewType:o}),polyline:new D.DrawPolylineTooltipInfo({sketchOptions:t,viewType:o}),polygon:new D.DrawPolygonTooltipInfo({sketchOptions:t,viewType:o}),mesh:new D.DrawMeshTooltipInfo({sketchOptions:t,viewType:o}),rectangle:new D.DrawRectangleTooltipInfo({sketchOptions:t}),circle:new D.DrawCircleTooltipInfo({sketchOptions:t})},this.tooltip=new k.Tooltip({view:this.view}),this._initializeConstraints(),this.addHandles([e.on("vertex-add",(e=>this.onVertexAdd(e))),e.on("vertex-remove",(e=>this.onVertexRemove(e))),e.on("vertex-update",(e=>this.onVertexUpdate(e))),e.on("cursor-update",(e=>this.onCursorUpdate(e))),e.on("cursor-remove",(()=>this._updateGraphic())),e.on("complete",(e=>this.onComplete(e))),l.watch((()=>this.cursor),(t=>e.cursor=t),l.syncAndInitial),b.autorun((()=>this._updateTooltipInfo())),b.autorun((()=>{e.constraintZ=this._constraintZ}))]),this.finishToolCreation()}destroy(){this.drawOperation=n.destroyMaybe(this.drawOperation),this.tooltip=n.destroyMaybe(this.tooltip),this._destroyAllVisualizations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=n.destroyMaybe(this.internalGraphicsLayer),this._set("view",null)}get _defaultElevation(){const e=s.getMetersPerVerticalUnitForSR(this.drawOperation.coordinateHelper.spatialReference);return a.createLength(this.defaultZ*e,"meters")}get _inputModeAvailable(){const{inputEnabled:e,visibleElements:t}=this.sketchOptions.tooltips;return e&&!0===this.activeTooltipInfo?.editableFields.some((e=>!0===t[e.name]))}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(e){this._set("centered",e),this._updateGraphic()}get cursor(){return this._get("cursor")}set cursor(e){this._set("cursor",e)}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}set forceUniformSize(e){this._set("forceUniformSize",e),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(e){this._set("graphicSymbol",e),null!=this._graphic&&(this._graphic.symbol=e)}get updating(){return this.drawOperation?.updating??!1}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(e){if(!this.destroyed)return"key-down"===e.type&&e.key===O.tooltipKeys.enterInputMode&&this._inputModeAvailable?(this.tooltip.enterInputMode(),void e.stopPropagation()):void this.drawOperation.onInputEvent(e)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo(),0===this.drawOperation.numCommittedVertices&&this._initializeConstraints()}_destroyAllVisualizations(){this.removeHandles(z.outline),this.removeHandles(z.regularVertices),this.removeHandles(z.activeVertex),this.removeHandles(z.activeEdge),this.removeHandles(S)}_createOrUpdateGraphic(e){if(null!=this._graphic)return this.updateGraphicGeometry(e),this._graphic;const t=new o({...this.graphicProperties,symbol:this.graphicSymbol});return this._graphic=t,this.updateGraphicGeometry(e),this.internalGraphicsLayer.add(t),this.addHandles(this.initializeGraphic(t)),this.notifyChange("graphic"),this.addHandles(i.makeHandle((()=>{this.internalGraphicsLayer.remove(t),this._graphic===t&&(this._graphic=null)})),S),t}updateGraphicGeometry(e){this._graphic.geometry=e}_getCreateOperationGeometry(e={operationComplete:!1}){if(null==this.drawOperation)return;const{coordinateHelper:t,view:o,visualizationCursorVertex:r,lastVertex:i,committedVertices:n,geometryIncludingUncommittedVertices:a,numCommittedVertices:l}=this.drawOperation;if(!(l>0||null!=r))return;const s=e.operationComplete?n:a,c=s.length,p=null!=r?t.pointToArray(r):null,h=o.spatialReference,u="3d"===o.type&&"global"===o.viewingMode,d=new M;d.committedVertices=n,d.cursorVertex=p;const{geometryType:y}=this;switch(y){case"point":case"mesh":d.full=t.arrayToPoint(s[0]);break;case"multipoint":d.full=c>0?v.createMultipoint(s,h):null;break;case"polyline":case"polygon":c>0&&(d.full="polygon"===y?v.createPolygon([s],h,u,!0):v.createPolyline([s],h,u),d.cursorEdge=null!=p&&i&&!m.pointEquals(r,i)?v.createPolyline([[p,t.pointToArray(i)]],h,u):null,d.outline=c>1?d.full:null);break;case"circle":case"rectangle":{if(d.committedVertices=d.cursorVertex=null,!c)break;const t=w.createViewAlignedCoordinateSystem(o,s[0]),r=s[0],i=t.makeMapPoint(r[0]+P*o.resolution,r[1]);"circle"===y?1===c&&e.operationComplete?d.circle=v.createCircle([r,i],t,!0):2===c&&(this.forceUniformSize?d.circle=v.createCircle(s,t,this.centered):d.rectangle=v.createEllipse(s,t,this.centered)):1===c&&e.operationComplete?d.rectangle=v.createSquare([r,i],t,!0):2===c&&(d.rectangle=this.forceUniformSize?v.createSquare(s,t,this.centered):v.createRectangle(s,t,this.centered)),d.full=null!=d.circle?d.circle.geometry:d.rectangle?.geometry,d.outline="polygon"===d.full?.type?d.full:null;break}default:return null}return d}initializeGraphic(e){return i.makeHandle()}onComplete(e){if(!this.drawOperation)return;this._updateGraphic();let t=null;if(this.drawOperation.isCompleted){const e=this._getCreateOperationGeometry({operationComplete:!0});null!=e&&(t=this._createOrUpdateGraphic(e.full))}this._createOperationGeometry=null,this.emit("complete",{graphic:t,...e})}onCursorUpdate(e){this._updateGraphic(),this.emit("cursor-update",e)}onDeactivate(){const{drawOperation:e}=this;e&&(e.isCompleted||e.cancel())}onOutlineChanged(e){return i.makeHandle()}onCursorEdgeChanged(e){return i.makeHandle()}onVertexAdd(e){this._updateGraphic(),this._unlockConstraintsOnVertexAddOrRemove(),this._lockElevationOnVertexAdd(e.vertices.at(0)?.coordinates),this.emit("vertex-add",e)}onVertexRemove(e){this._updateGraphic(),this._unlockConstraintsOnVertexAddOrRemove(),this.emit("vertex-remove",e)}onVertexUpdate(e){this._updateGraphic(),this.emit("vertex-update",e)}_updateGraphic(){const e=this._getCreateOperationGeometry();this._createOperationGeometry=e,null!=e?(null!=e.cursorEdge?this.addHandles(this.onCursorEdgeChanged(e.cursorEdge),z.activeEdge):this.removeHandles(z.activeEdge),null!=e.outline?this.addHandles(this.onOutlineChanged(e.outline),z.outline):this.removeHandles(z.outline),null!=e.committedVertices?this.addHandles(this.onRegularVerticesChanged(e.committedVertices),z.regularVertices):this.removeHandles(z.regularVertices),null!=e.cursorVertex?this.addHandles(this.onActiveVertexChanged(e.cursorVertex),z.activeVertex):this.removeHandles(z.activeVertex),null!=e.full?this._createOrUpdateGraphic(e.full):this.removeHandles(S)):this._destroyAllVisualizations()}get activeTooltipInfo(){const{drawOperation:e,graphic:t,view:o}=this;if(!e)return null;const r=this.tooltipInfos,i=t?.geometry?.type;switch(this.geometryType){case"point":return"2d"===o.type&&0===this.defaultZ?null:"point"===i?r.point:null;case"polyline":return"polyline"===i?r.polyline:null;case"polygon":return"polygon"===i?r.polygon:null;case"rectangle":return"polygon"===i?r.rectangle:null;case"circle":return"polygon"===i?r.circle:null;case"mesh":return"mesh"===i?r.mesh:null;default:return null}}_updateTooltipInfo(){const{activeTooltipInfo:e,tooltip:t,sketchOptions:o}=this;switch(e?.type){case"draw-point":this._updateDrawPointTooltipInfo(e);break;case"draw-polyline":this._updateDrawPolylineTooltipInfo(e);break;case"draw-polygon":this._updateDrawPolygonTooltipInfo(e);break;case"draw-rectangle":this._updateDrawRectangleTooltipInfo(e);break;case"draw-circle":this._updateDrawCircleTooltipInfo(e);break;case"draw-mesh":this.updateDrawMeshTooltipInfo(e)}t.view=this.view,t.info=o.tooltips.effectiveEnabled?e:null}_updateDrawPointTooltipInfo(e){const{drawOperation:t,graphic:o,view:r,sketchOptions:i}=this,{coordinateHelper:n,cursorVertex:a}=t;if(e.sketchOptions=i,e.viewType=r.type,e.helpMessage=_.getDrawHelpMessage("point",o?.geometry),this.updateElevation(e.elevation),!a)return void(t.constraintInfo=void 0);const l=a,s=G.getConstraintContext(l,r,n.spatialReference,this._constraintElevationInfo,n.hasZ(),i.values.effectiveDirectionMode);t.constraintInfo={context:s,distance:null,direction:null,elevation:e.elevation.committed}}_updateDrawPolylineTooltipInfo(e){const t=this._createOperationGeometry,o=null!=t?t.full:null;if("polyline"!==o?.type)return;this._updatePolylineOrPolygonCommon(e);const r=V.autoLength2D(o);e.totalLength.actual=r??a.zeroMeters,e.sketchOptions=this.sketchOptions,e.viewType=this.view.type,e.helpMessage=_.getDrawHelpMessage("polyline",o)}_updateDrawPolygonTooltipInfo(e){const t=this._createOperationGeometry,o=null!=t?t.full:null;if("polygon"!==o?.type)return;this._updatePolylineOrPolygonCommon(e);const r=I.autoArea2D(o);e.area.actual=r??a.zeroSquareMeters,e.sketchOptions=this.sketchOptions,e.viewType=this.view.type,e.helpMessage=_.getDrawHelpMessage("polygon",o)}_updatePolylineOrPolygonCommon(e){const{view:t,drawOperation:o,sketchOptions:r}=this,{coordinateHelper:i,cursorVertex:n,lastVertex:l,secondToLastVertex:s}=o,c=r.values.effectiveDirectionMode,p=l&&n?V.autoDistanceBetweenPoints2D(l,n):null;if(e.distance.actual=p??a.zeroMeters,e.distance.readOnly=null==l,e.direction.actual=null,e.direction.readOnly=!0,l&&n&&("absolute"===c||s)){const t=C.directionForVertices(s,l,n,c);e.direction.actual=t??a.zeroDegreesGeographic,e.direction.readOnly=!1}this.updateElevation(e.elevation);const h=n??l;if(h){const r=G.getConstraintContext(h,t,i.spatialReference,this._constraintElevationInfo,i.hasZ(),c);o.constraintInfo={context:r,distance:e.distance.committed,direction:e.direction.committed,elevation:e.elevation.committed}}else o.constraintInfo=void 0}updateDrawMeshTooltipInfo(e){}_updateDrawRectangleTooltipInfo(e){e.sketchOptions=this.sketchOptions,e.xSize=this._xSize??a.zeroMeters,e.ySize=this._ySize??a.zeroMeters,e.area=this._fullGeometryArea??a.zeroSquareMeters}_updateDrawCircleTooltipInfo(e){const{forceUniformSize:t}=this;e.sketchOptions=this.sketchOptions,e.radius=t?this._circleRadius??a.zeroMeters:null,e.xSize=t?null:this._xSize??a.zeroMeters,e.ySize=t?null:this._ySize??a.zeroMeters,e.area=this._fullGeometryArea??a.zeroSquareMeters}get _circleRadius(){const e=this._createOperationGeometry;return null!=e?.circle?.center&&null!=e.circle.edge?V.autoDistanceBetweenPoints2D(e.circle.center,e.circle.edge):null}get _xSize(){const e=this._createOperationGeometry?.rectangle?.midpoints;return null!=e?V.autoDistanceBetweenPoints2D(e.left,e.right):null}get _ySize(){const e=this._createOperationGeometry?.rectangle?.midpoints;return null!=e?V.autoDistanceBetweenPoints2D(e.top,e.bottom):null}get _fullGeometryArea(){const e=this._createOperationGeometry?.full;return"polygon"!==e?.type?null:I.autoArea2D(e)}updateElevation(e){const{drawOperation:t}=this,o=t?.cursorVertex??t?.lastVertex;e.actual=x.elevationFromPoint(o)??this._defaultElevation,e.visible="3d"===this.view.type&&this.hasZ,e.readOnly=!1}get _constraintElevationInfo(){return this.drawOperation?.elevationInfo??g.absoluteHeightElevationInfo}get _constraintZ(){const{geometryType:e}=this;switch(e){case"point":case"mesh":case"polyline":case"polygon":{const t=this.tooltipInfos[e].elevation.committed;if(!t)return;const o=this.drawOperation.coordinateHelper.spatialReference;return a.valueInUnit(t,"meters")/s.getMetersPerVerticalUnitForSR(o)}default:return}}_initializeConstraints(){const{directionOptions:e,drawOperation:t,geometryType:o,tooltipInfos:r,sketchOptions:i}=this,n=e=>{const o=t.elevationInfo?.mode,i=r[e].elevation;"relative-to-ground"===o||"relative-to-scene"===o||"on-the-ground"===o?i.lock(this._defaultElevation):i.unlock()},a=t=>{if(e){const o=r[t].direction;o.committed=e.angle,o.unlockOnVertexPlacement=!1,i.values.directionMode=e.mode}};switch(o){case"polygon":case"polyline":n(o),a(o);break;case"point":case"mesh":n(o)}}_lockElevationOnVertexAdd(e){const{activeTooltipInfo:t,drawOperation:o,view:r}=this,i=this._constraintElevationInfo;if("2d"===r.type||!e||"absolute-height"!==i.mode||1!==o?.numCommittedVertices||!t||"draw-polyline"!==t.type&&"draw-polygon"!==t.type||t.elevation.locked)return;const[n,a,l]=e,s=this._getConvertedVertexElevation(n,a,l,i);null!=s&&t.elevation.lock(s)}_unlockConstraintsOnVertexAddOrRemove(){this.activeTooltipInfo?.allFields.forEach((e=>{e.unlockOnVertexPlacement&&e.unlock()}))}_getConvertedVertexElevation(e,t,o,r){const{view:i,drawOperation:n}=this;if("3d"!==i.type||!n)return;const{spatialReference:a}=n.coordinateHelper;o??=0;const l=n.elevationInfo,s=g.getConvertedElevationFromXYZ(i,e,t,o,a,l,r);return x.elevationFromZ(s,a)??this._defaultElevation}},t.__decorate([c.property()],e.DrawGraphicTool.prototype,"_createOperationGeometry",void 0),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"_defaultElevation",null),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"_inputModeAvailable",null),t.__decorate([c.property({value:!0})],e.DrawGraphicTool.prototype,"centered",null),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"cursor",null),t.__decorate([c.property({nonNullable:!0})],e.DrawGraphicTool.prototype,"defaultZ",void 0),t.__decorate([c.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"directionOptions",void 0),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"drawOperation",void 0),t.__decorate([c.property({value:!0})],e.DrawGraphicTool.prototype,"enabled",null),t.__decorate([c.property({value:!0})],e.DrawGraphicTool.prototype,"forceUniformSize",null),t.__decorate([c.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"geometryType",void 0),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"graphic",null),t.__decorate([c.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"graphicProperties",void 0),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"graphicSymbol",null),t.__decorate([c.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"hasZ",void 0),t.__decorate([c.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"geometryToPlace",void 0),t.__decorate([c.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"mode",void 0),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"snappingManager",void 0),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"snapToScene",void 0),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"tooltip",void 0),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"tooltipInfos",void 0),t.__decorate([c.property({constructOnly:!0,type:T})],e.DrawGraphicTool.prototype,"sketchOptions",void 0),t.__decorate([c.property({readOnly:!0})],e.DrawGraphicTool.prototype,"updating",null),t.__decorate([c.property({constructOnly:!0,nonNullable:!0})],e.DrawGraphicTool.prototype,"view",void 0),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"activeTooltipInfo",null),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"_circleRadius",null),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"_xSize",null),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"_ySize",null),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"_fullGeometryArea",null),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"_constraintElevationInfo",null),t.__decorate([c.property()],e.DrawGraphicTool.prototype,"_constraintZ",null),e.DrawGraphicTool=t.__decorate([d.subclass("esri.views.draw.DrawGraphicTool")],e.DrawGraphicTool);const S=Symbol("create-operation-graphic"),z={outline:Symbol("outline-visual"),regularVertices:Symbol("regular-vertices-visual"),activeVertex:Symbol("active-vertex-visual"),activeEdge:Symbol("active-edge-visual")};function E(e){switch(e){case"point":case"polyline":case"polygon":case"multipoint":return e;case"circle":case"rectangle":return"segment";case"mesh":return"point"}}const P=48;e.CreateOperationGeometry=M,e.geometryTypeToDrawOperationGeometryType=E,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
