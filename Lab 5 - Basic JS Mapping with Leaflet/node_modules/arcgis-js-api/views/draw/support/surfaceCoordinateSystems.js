/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../geometry","../../../core/arrayUtils","../../../core/libs/gl-matrix-2/math/mat2d","../../../core/libs/gl-matrix-2/factories/mat2df64","../../../core/libs/gl-matrix-2/math/quat","../../../core/libs/gl-matrix-2/factories/quatf64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/Axis","../../../geometry/Point"],(function(e,t,r,a,s,i,o,n,l,c,h){"use strict";function m(e,t,r=null){return null!=r?[e,t,r]:[e,t]}function f(e,t,r=null){return null!=r?{x:e,y:t,z:r}:{x:e,y:t}}class d{constructor(e){this.spatialReference=e}mapToLocalMultiple(e){return e.map((e=>this.mapToLocal(e))).filter(r.isSome)}get doUnnormalization(){return!1}}class u extends d{constructor(e,t,r=null){super(t),this._defaultZ=r,this.transform=s.create(),this.transformInv=s.create(),this.transform=s.clone(e),a.invert(this.transformInv,this.transform)}makeMapPoint(e,t){return m(e,t,this._defaultZ)}mapToLocal(e){return f(this.transform[0]*e[0]+this.transform[2]*e[1]+this.transform[4],this.transform[1]*e[0]+this.transform[3]*e[1]+this.transform[5])}localToMap(e){return m(this.transformInv[0]*e.x+this.transformInv[2]*e.y+this.transformInv[4],this.transformInv[1]*e.x+this.transformInv[3]*e.y+this.transformInv[5],this._defaultZ)}}class p extends d{constructor(e,t){super(e.spatialReference),this.view=e,this.defaultZ=null,this.pWS=l.create(),this.tangentFrameUpWS=l.create(),this.tangentFrameRightWS=l.create(),this.tangentFrameForwardWS=l.create(),this.localFrameRightWS=l.create(),this.localFrameUpWS=l.create(),this.worldToLocalTransform=o.create(),this.localToWorldTransform=o.create(),this.scale=1,this.scale=e.resolution,this.referenceMapPoint=t,this.defaultZ=t.hasZ?t.z:null;const r=e.state.camera.viewRight;this.view.renderCoordsHelper.toRenderCoords(this.referenceMapPoint,this.pWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,c.Axis.X,this.tangentFrameRightWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,c.Axis.Y,this.tangentFrameUpWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,c.Axis.Z,this.tangentFrameForwardWS);const a=l.create();n.scale(a,this.tangentFrameForwardWS,n.dot(r,this.tangentFrameForwardWS)),n.subtract(this.localFrameRightWS,r,a),n.normalize(this.localFrameRightWS,this.localFrameRightWS),n.cross(this.localFrameUpWS,this.tangentFrameForwardWS,this.localFrameRightWS),i.rotationTo(this.worldToLocalTransform,this.localFrameRightWS,this.tangentFrameRightWS),i.invert(this.localToWorldTransform,this.worldToLocalTransform)}get doUnnormalization(){return"global"===this.view.viewingMode}makeMapPoint(e,t){return m(e,t,this.defaultZ)}mapToLocal(e){const t=l.create();this.view.renderCoordsHelper.toRenderCoords(new h({x:e[0],y:e[1],spatialReference:this.spatialReference}),t),n.transformQuat(t,t,this.worldToLocalTransform);const r=this.view.renderCoordsHelper.fromRenderCoords(t,new h({spatialReference:this.view.spatialReference}));return null!=r?f(r.x/this.scale,r.y/this.scale):null}localToMap(e){const t=l.create();this.view.renderCoordsHelper.toRenderCoords(new h({x:e.x*this.scale,y:e.y*this.scale,spatialReference:this.spatialReference}),t),n.transformQuat(t,t,this.localToWorldTransform);const r=this.view.renderCoordsHelper.fromRenderCoords(t,new h({spatialReference:this.view.spatialReference}));return null!=r?m(r.x,r.y,this.defaultZ):null}}function g(e,t){if("2d"===e.type)return new u(e.state.transform,e.spatialReference,t.length>2?t[2]:null);if("3d"===e.type){const r=t.length>2?new h({x:t[0],y:t[1],z:t[2],spatialReference:e.spatialReference}):new h({x:t[0],y:t[1],spatialReference:e.spatialReference});return new p(e,r)}return null}e.AffineCoordinateSystem=u,e.SceneViewCoordinateSystem=p,e.SurfaceCoordinateSystem=d,e.createViewAlignedCoordinateSystem=g,e.makeMapPoint=m,e.makeSurfacePoint=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
