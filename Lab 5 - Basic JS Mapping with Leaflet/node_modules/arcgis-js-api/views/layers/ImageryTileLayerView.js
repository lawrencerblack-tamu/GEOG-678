/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../Graphic","../../core/Error","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../layers/support/commonProperties","../../layers/support/rasterFunctions/rasterProjectionHelper","./support/popupUtils"],(function(e,t,r,a,o,i,s,n,l,p,u){"use strict";const c=o=>{let i=class extends o{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}_getfullExtent(){return p.projectDatasetExtent(this.layer.serviceRasterInfo,this.view.spatialReference)}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){return p.getDefaultDatumTransformationForDataset(this.layer.fullExtent,this.view.spatialReference,!0)}supportsSpatialReference(e){return!!p.projectDatasetExtent(this.layer.serviceRasterInfo,e)}async fetchPopupFeaturesAtLocation(e,a){const{layer:o}=this;if(!e)throw new r("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:o});const{popupEnabled:i}=o,s=u.getFetchPopupTemplate(o,a);if(!i||null==s)throw new r("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:i,popupTemplate:s});const n=[],{value:l,magdirValue:p,processedValue:c}=await o.identify(e,{timeExtent:this.timeExtent,signal:a?.signal});let y="";if(l&&l.length){y="imagery-tile"===o.type&&o.hasStandardTime()&&null!=l[0]?l.map((e=>o.getStandardTimeValue(e))).join(", "):l.join(", ");const e={ObjectId:0},r="Raster.ServicePixelValue";e[r]="imagery-tile"===o.type&&"Function"===o.raster.datasetFormat?c?.join(", "):y,e[r+".Raw"]=y;const a=o.serviceRasterInfo.attributeTable;if(null!=a){const{fields:t,features:r}=a,o=t.find((({name:e})=>"value"===e.toLowerCase())),i=o?r.find((e=>String(e.attributes[o.name])===y)):null;if(i)for(const a in i.attributes)if(i.attributes.hasOwnProperty(a)){e[this._rasterFieldPrefix+a]=i.attributes[a]}}const i=o.serviceRasterInfo.dataType;"vector-magdir"!==i&&"vector-uv"!==i||(e["Raster.Magnitude"]=p?.[0],e["Raster.Direction"]=p?.[1]);const s=new t(this.fullExtent.clone(),null,e);s.layer=o,s.sourceLayer=s.layer,n.push(s)}return n}};return e.__decorate([a.property()],i.prototype,"layer",void 0),e.__decorate([a.property(l.combinedViewLayerTimeExtentProperty)],i.prototype,"timeExtent",void 0),e.__decorate([a.property()],i.prototype,"view",void 0),e.__decorate([a.property()],i.prototype,"fullExtent",null),e.__decorate([a.property()],i.prototype,"tileInfo",void 0),e.__decorate([a.property({readOnly:!0})],i.prototype,"hasTilingEffects",null),e.__decorate([a.property()],i.prototype,"datumTransformation",null),i=e.__decorate([n.subclass("esri.views.layers.ImageryTileLayerView")],i),i};return c}));
