/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","../chunks/tslib.es6","../Camera","../geometry","../Viewpoint","../core/Collection","../core/domUtils","../core/Error","../core/events","../core/handleUtils","../core/has","../core/Logger","../core/maybe","../core/ObservableChangesType","../core/promiseUtils","../core/reactiveUtils","../core/scheduling","../core/screenUtils","../core/workers/workers","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/RandomLCG","../core/accessorSupport/decorators/subclass","../core/accessorSupport/ensureType","../core/accessorSupport/overrideDefaultsFrom","../core/libs/gl-matrix-2/factories/vec3f64","../core/support/OwningCollection","../geometry/HeightModelInfo","../geometry/projection","../geometry/projection/projectBoundingRect","../geometry/projection/projectPointToVector","../geometry/support/aaBoundingRect","../chunks/boundedPlane","../geometry/support/coordinateSystem","../geometry/support/scaleUtils","../layers/support/layerUtils","../support/AnalysesCollection","./BreakpointsOwner","./DOMContainer","./GroundView","./PopupView","./View","./ViewAnimation","./ViewingMode","./3d/layerViewModuleImportUtils","./3d/analysis/AnalysisViewManager3D","./3d/constraints/Constraints","./3d/environment/SceneViewEnvironment","./3d/environment/SceneViewEnvironmentManager","./3d/input/SceneInputManager","./3d/layers/graphics/GraphicsDeconflictor","./3d/layers/graphics/Labeler","./3d/layers/support/FeatureTileTree3D","./3d/state/ViewState","./3d/state/ViewStateManager","./3d/state/helpers/SceneIntersectionHelper","./3d/support/CombinedElevationProvider","./3d/support/debugFlags","./3d/support/DisplayQualityProfile","./3d/support/ElevationProvider","./3d/support/HighlightOptions","./3d/support/hitTest","./3d/support/MapCoordsHelper","./3d/support/popupHitTest","./3d/support/PropertiesPool","./3d/support/QualitySettings","./3d/support/RenderCoordsHelper","./3d/support/ResourceController","./3d/support/SceneViewPerformanceInfo","./3d/support/SharedSymbolResources","./3d/support/TextureCollection","./3d/support/pointsOfInterest/PointsOfInterest","./3d/terrain/TerrainSurface","./3d/terrain/terrainUtils","./3d/webgl-engine/Stage","./3d/webgl-engine/lib/basicInterfaces","./3d/webgl-engine/lib/Intersector","./3d/webgl-engine/lib/verticalOffsetUtils","./support/layerViewUtils","./support/screenshotUtils","./support/screenUtils","./support/spatialReferenceSupport","./support/WebGLRequirements","./ui/DefaultUI","./ui/3d/DefaultUI3D","../webscene/Environment","../geometry/Extent","../geometry/SpatialReference","../geometry/Point"],(function(e,t,r,i,a,n,s,o,l,p,d,h,c,u,g,y,_,m,w,f,v,b,M,S,V,C,R,T,O,x,P,L,E,I,H,A,G,F,D,k,W,U,j,q,z,B,N,Q,Y,Z,$,J,K,X,ee,te,re,ie,ae,ne,se,oe,le,pe,de,he,ce,ue,ge,ye,_e,me,we,fe,ve,be,Me,Se,Ve,Ce,Re,Te,Oe,xe,Pe,Le,Ee,Ie,He){"use strict";const Ae=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));let Ge=class extends(F.BreakpointsOwner(W.PopupView(D.DOMContainer(U)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new de.PropertiesPool({slicePlane:E.BoundedPlaneClass},this),this._resourceController=ue.newResourceController(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new $.GraphicsDeconflictor({view:this}),this.labeler=new J.Labeler({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new G.AnalysesCollection,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new N.Constraints,this.environment=new Q,this.environmentManager=new Y.SceneViewEnvironmentManager,this.floors=new n,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new B({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new X,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new Pe,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlightOptions=new se,w.initialize();const t=(e=null)=>{null!=e&&e.type===u.ObservableChangesType.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach((async e=>{try{await e.when()}catch{}this._updatingChanged()})))};this.addHandles([y.on((()=>this.map?.allLayers),"after-changes",(e=>t(e)),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),y.watch((()=>this.map),(e=>{e&&"load"in e&&e.load&&e.load().catch((()=>{}))}))]),this.inputManager=new Z({view:this}),this.stateManager=new ee.ViewStateManager({view:this})}initialize(){this.groundView=new k({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.addHandles(y.on((()=>this.map?.allLayers),"after-changes",e,{onListenerAdd:e,onListenerRemove:e})),this.updatingHandles.add((()=>this.qualitySettings.memoryLimit),(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),y.initial),this.updatingHandles.add((()=>this.qualitySettings.additionalCacheMemory),(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),y.initial),this.updatingHandles.add((()=>this.qualitySettings.frameRate??0),(e=>_.setFrameDuration(e>0?1e3/Math.ceil(e):0)),y.initial),this.updatingHandles.add((()=>this.map?.ground),e,y.syncAndInitial),this.updatingHandles.add((()=>this.map?.ground?.opacity),(()=>this._updateDefaultHitTestOptions()),y.syncAndInitial),this.addHandles(y.watch((()=>this.spatialReference),(()=>this.notifyChange("clippingArea")),y.sync))}destroy(){this.destroyed||(this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=c.destroyMaybe(this.sharedSymbolResources),this._set("labeler",c.destroyMaybe(this.labeler)),this._set("deconflictor",c.destroyMaybe(this.deconflictor)),this._resourceController=c.destroyMaybe(this._resourceController),this._set("stateManager",c.destroyMaybe(this.stateManager)),this._set("inputManager",c.destroyMaybe(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",c.destroyMaybe(this.environmentManager)),this._set("environment",c.destroyMaybe(this.environment)),this.groundView=c.destroyMaybe(this.groundView),this._exitBasemapTerrain(),this._stage?.destroy())}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get center(){return this.stateManager?.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if("global"===this.viewingMode)return null;const e=this.map;let t=this._userClippingArea||c.maybeProperty(e,"clippingArea");return!this._userClippingArea&&!c.maybeProperty(e,"clippingEnabled")||null==t?(this._clippingArea=null,null):t instanceof Ee?this.spatialReference&&(t=Fe(t,this.spatialReference),null==t)?(h.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),null==t.intersection(this._groundAndLayersExtent)&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(h.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&null!=e?h.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===q.ViewingMode.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return null==t||null==e||t.spatialReference.equals(e)?t:Fe(t,e)}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||Ie.WGS84,r=Fe(this.clippingArea,t);null!=r&&(e=null!=e?e.intersection(r):r);const i=this._get("dataExtent");return null!=e&&e.equals(i)?i:e}get _groundAndLayersExtent(){const e=this.spatialReference||Ie.WGS84;let t;const r=r=>{const i=Fe(r,e);null!=i&&(null!=t?t.union(i):t=i.clone())},i=this.basemapTerrain;if(i?.spatialReference){const e=i.groundExtent;r(new Ee({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:i.spatialReference}))}if(this.map){const e=e=>{null==e.fullExtent||"graphics"===e.type&&e.internal||r(e.fullExtent)};this.map.allLayers.forEach((t=>e(t)))}if(null==t)return null;t.hasZ?(t.zmin=Math.min(0,t.zmin??0),t.zmax=Math.max(0,t.zmax??0)):(t.zmin=0,t.zmax=0);const a=this._get("_groundAndLayersExtent");return t.equals(a)?a:t}castEnvironment(e){return e?e instanceof Q?e:e instanceof Le?this.environment?.cloneWithWebsceneEnvironment(e)??Q.fromWebsceneEnvironment(e):S.ensureType(Q,e):new Q}get extent(){return this.stateManager?.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(null==this.state||this.state.stationary)}get navigating(){return this.state?.navigating??!1}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}set qualityProfile(e){ae.isValidProfile(e)&&(ae.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||ae.getDefaultProfile()}set slicePlane(e){if(null!=this._stage&&this._stage.renderer.setParameters({slicePlane:e}),null==e)return void this._set("slicePlane",null);const t=this._propertiesPool.get("slicePlane");E.copy(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&this.stateManager.preinit(this.spatialReference)}get resolution(){return null!=this.spatialReference?H.getResolutionForScale(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?T.deriveUnitFromSR(e,this.spatialReference):null}get updating(){if(this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,r=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((i=>{if(i.isFulfilled()){if(i.updating){if(t=!0,i.suspended||fe.isSurfaceLayerView(i))return;++r,e+=i.updatingProgress}}else++r}));for(const a of this._updatingObjects)if(null!=a&&a.updating){const t=.1;r+=t,e+=.5*t}for(const a of this._updatingObjectsWithProgress)null!=a&&a.updating&&(++r,e+=a.updatingProgress);const i=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(t=!!(t||r>0||this.updatingHandles.updating||!this.ready||!this.stationary||i||this._createGraphicsViewController||this.inputManager?.updating||this.map?.allLayers?.some((e=>!e.isFulfilled()))||this.textures?.updating),t?(this._numUpdating=Math.max(r,this._numUpdating),e+=this._numUpdating-r):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const r=performance.now();if(e<1){const t=Math.min((r-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-t)+e*t}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?r:0}return t}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){const e=this._predeterminedViewingMode;if(null!=e)return q.stringFromViewingMode(e);const t=this.spatialReference;return t?null!=this.defaultsFromMap?.viewingMode&&t.equals(this.defaultsFromMap.spatialReference)?q.stringFromViewingMode(this.defaultsFromMap.viewingMode):Te.isSpatialReferenceSupported(t,q.ViewingMode.Global)?"global":"local":"global"}set viewingMode(e){this.ready?h.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new ge(this)}on(e,t,r,i){const a=this.viewEvents.on(e,t,r,i);return a||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return h.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const r=Re.isSupportedScreenPointEvent(e)?Re.createScreenPointFromSupportedEvent(this,e):e;return oe.toMap(this,r,t,this._defaultToMapOptions)}toScreen(e){if(!this.ready)return h.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=(null==e.z?ne.getElevationAtPoint(this.elevationProvider,e):null)??0;return P.projectPointToVector(e,De,this.renderSpatialReference,t),this.state.camera.projectToScreen(De,ke),m.createScreenPoint(ke[0],ke[1])}pixelSizeAt(e){return this.ready?e?(P.projectPointToVector(e,De,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(De)):0:(h.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e,(()=>this.pixelSizeAt(e))):1}hitTest(e,t){if(!this.ready)return h.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const r=Re.isSupportedScreenPointEvent(e)?Re.createScreenPointFromSupportedEvent(this,e):e;return oe.hitTest(this,r,t,this._defaultHitTestOptions)}async popupHitTest(e){return pe.popupHitTest(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(null==e.parent)throw new o("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const r=await this._stage.renderView.takeScreenshot(t);return Ce.encode(r,t,this._pixelFormat())}async _takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const r=await this._stage.renderView.takeScreenshot(t);return Ce.encodeData(r,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(e){const t=this._completeSettings(e);await this.whenReady();const r=await this._stage.renderView.takeScreenshotWithOID(t);return[Ce.encodeData(r[0],this._pixelFormat()),Ce.encodeData(r[1],this._pixelFormat())]}_completeSettings(e){const t=Ce.toRenderSettings(e,this);return t.pixelRatio/=this.state.pixelRatio,Ce.screenshotSuperSampleSettings(t,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){return{takeScreenshot:e=>this._takeScreenshot(e),takeScreenshotWithObjectAndLayerId:e=>this._takeScreenshotWithObjectAndLayerId(e)}}async takeScreenshotWithObjectAndLayerId(e){if(!d("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");const t=this._completeSettings(e);await this.whenReady();const r=await this._stage.renderView.takeScreenshotWithOID(t),i=Ce.encode(r[0],t,this._pixelFormat()),a=this._completeSettings(e);a.format="png";return[i,Ce.encode(r[1],a,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){if(null==this._stage.renderView.objectAndLayerIdRenderHelper)throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return z.layerView3DImporter.importLayerView(e)}hasLayerViewModule(e){return z.layerView3DImporter.hasLayerViewModule(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.map&&"initialViewProperties"in this.map&&this.map.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let e=Oe.check(this.type);const t=d("safari");if(t&&t<9&&(e=new o("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),null!=e)throw h.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){const e=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties?.viewingMode:null)??null;return null!=e?q.viewingModeFromString(e):null}getSpatialReferenceSupport({spatialReference:e,layer:t}){const r=this._predeterminedViewingMode;if(null!=r)return this._validateSpatialReferenceForViewingMode(e,t,r)?{constraints:this._makeSpatialReferenceConstraints(e,t,r)}:null;const i=this._validateSpatialReferenceForViewingMode(e,t,q.ViewingMode.Local),a=this._validateSpatialReferenceForViewingMode(e,t,q.ViewingMode.Global);return i||a?i&&a?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:i?{constraints:this._makeSpatialReferenceConstraints(e,t,q.ViewingMode.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,q.ViewingMode.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,r){return!!Te.isSpatialReferenceSupported(e,r)&&(null==t||(!!A.isImageryTileLayer(t)||(!A.isTiledLayer(t)||null!=fe.getTiledLayerInfo(t,e,r))&&(!A.isVoxelLayer(t)||r!==q.ViewingMode.Global)))}_makeSpatialReferenceConstraints(e,t,r){if(null==t)return[{spatialReference:e,viewingMode:r}];const i=e.isWebMercator,a=e.isWGS84;if(A.isImageryTileLayer(t)&&(i||a)){return!a||r===q.ViewingMode.Local||null===fe.checkIfTileInfoSupportedForView(t.tileInfo,t.fullExtent,e,q.ViewingMode.Global)?[{spatialReference:e,viewingMode:r},{spatialReference:Ie.WebMercator,viewingMode:r}]:[{spatialReference:i?Ie.WGS84:Ie.WebMercator,viewingMode:r}]}return A.isTiledLayer(t)||A.isVoxelLayer(t)||!i&&!a?A.isTiledLayer(t)&&i&&r!==q.ViewingMode.Global?[{spatialReference:e,viewingMode:r},{spatialReference:Ie.WGS84,viewingMode:q.ViewingMode.Local}]:[{spatialReference:e,viewingMode:r}]:[{spatialReference:e,viewingMode:r},{spatialReference:i?Ie.WGS84:Ie.WebMercator,viewingMode:r}]}_validateSpatialReference(e){const t=null!=this.getSpatialReferenceSupport({spatialReference:e}),r=this._predeterminedViewingMode;return t||(null!=r?h.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${q.stringFromViewingMode(r)} viewing mode.`):e.isGeographic&&h.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}trackGraphicState(e){if(!e.graphic)return h.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let r=null,i=!1;const a=t=>{!i&&null!=t&&"processor"in t&&"graphics-3d"===t.processor?.type&&t.processor.graphicsCore&&(r=t.processor.graphicsCore.trackGraphicState(e))};return null!=t?a(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>a(e)),(()=>{})).catch((()=>{})),p.makeHandle((()=>{i=!0,null!=r&&(r.remove(),r=null)}))}highlight(e){if(Array.isArray(e))return p.handlesGroup(e.map((e=>this.highlight(e))));if(n.isCollection(e))return p.handlesGroup(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):p.makeHandle()}maskOccludee(e){if(!e)return h.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let r=null,i=!1;const a=t=>{!i&&null!=t&&Ve.occludeesSupported(t)&&(r=t.maskOccludee(e))};return null!=t?a(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>a(e)),(()=>{})).catch((()=>{})),p.makeHandle((()=>{i=!0,null!=r&&(r.remove(),r=null)}))}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){null!=this.graphicsView&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await y.whenOnce((()=>this.graphicsView)),this.graphicsView;if(!e.layer||!this.map)throw new o("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,r)=>{const i=this.map.allLayers.on("change",(a=>{a.added.includes(e.layer)&&(i.remove(),this.whenLayerView(e.layer).then(t,r))}))})):this.whenLayerView(e.layer)}_initBasemapTerrain(){this._set("basemapTerrain",new we({view:this})),this._set("elevationProvider",new re.CombinedElevationProvider({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new me.PointsOfInterest({view:this})),this._set("featureTiles",new K.FeatureTileTree3D({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const t=()=>{const e=this.basemapTerrain?.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=null!=this.basemapTerrain.extent&&null!=this.basemapTerrain.spatialReference?O.project(L.toExtent(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;null!=this.clippingArea?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add((()=>ie.debugFlags.FEATURE_TILE_TREE_SHOW_TILES),(t=>{t&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(new Promise(((t,r)=>e(["./3d/layers/support/FeatureTileTree3DDebugger"],t,r)))).then((({FeatureTileTree3DDebugger:e})=>{!this._featureTreeDebugger&&ie.debugFlags.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new e({view:this}))})):t||!this._featureTreeDebugger||ie.debugFlags.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)}),y.syncAndInitial),this.updatingHandles.add((()=>this.clippingArea),t,y.syncAndInitial),this.updatingHandles.add((()=>this.basemapTerrain.extent),t,y.syncAndInitial)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new le.MapCoordsHelper(this.map,e));const t=this.state.isGlobal,r=I.renderSRFromViewSR(t,e);r!==this.renderSpatialReference&&(this._set("renderCoordsHelper",ce.RenderCoordsHelper.create(this.state.viewingMode,r)),t||this.addHandles(y.watch((()=>this.basemapTerrain?.extent),(e=>{const t=this.renderCoordsHelper.spatialReference;null==e||0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!x.projectBoundingRect(e,this.basemapTerrain.spatialReference,We,t)||(this.renderCoordsHelper.extent=We)}),y.sync),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Me.defaultTolerance/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){null!=e&&e.type===u.ObservableChangesType.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.addHandles(y.watch((()=>[e.updating,e.updatingProgress]),(()=>this._updatingChanged()),y.sync),"updatingMonitors"),e.when((()=>this._updatingChanged()),(()=>this._updatingChanged())))})),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,r){if(!this.overlay||!this.overlay.hasVisibleItems)return r;const i=e.getContext("2d");return i.putImageData(r,0,0),this.overlay.renderCanvas(e,{disableDecorations:t===be.Decorations.OFF}),i.getImageData(0,0,r.width,r.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(e,t,r)=>this._renderScreenshotOverlay(e,t,r)}},t=new te.SceneIntersectionHelper(this.state.viewingMode,(e=>this._stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const r=s.byId(this.surface);this._stage=new ve.Stage({view:this,options:e,container:r}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this.addHandles([this.updatingHandles.add((()=>this.qualitySettings.highQualityTransparency),(e=>this._stage.renderer.setParameters({highQualityTransparency:e})),y.initial),y.watch((()=>this.magnifier),(e=>this._stage.renderView.magnifier=e),y.syncAndInitial),this.on("pointer-move",(()=>this._stage?.renderer.resetAnimation())),l.on(this._stage.renderView.canvas,"webglcontextlost",(e=>{this.fatalError=new o("webgl-context-lost",e.statusMessage)}))],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Me.defaultTolerance/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=c.destroyMaybe(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new ye.SharedSymbolResources({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this._updatingChanged()}async _createGraphicsViewAsync(t){const r=(await new Promise(((t,r)=>e(["./3d/layers/GraphicsView3D"],(e=>t(Ae(e))),r)))).default;g.throwIfAborted(t),await y.whenOnce((()=>this.basemapTerrain?.ready),t),this._set("graphicsView",new r({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),null!=this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=q.viewingModeFromString(this.viewingMode);e===q.ViewingMode.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.addHandles(y.on((()=>this.graphics),"after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded();const t=this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties?.environment:void 0;t&&V.overrideDefaultsFrom(this.environment,t),this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new _e.TextureCollection(this._stage,this.resourceController.scheduler));const r=this._resolveWhenReady;this._resolveWhenReady=[],r.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",c.destroyMaybe(this.textures)),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Se.terrainId);for(const e of this.map.allLayers.items)A.isIntegratedMeshLayer(e.type)&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Se.terrainId);for(const e of this.map.allLayers.items)A.isIntegratedMeshLayer(e.type)&&e.opacity<1&&this._defaultHitTestOptions.exclude.add(e.uid)}}};function Fe(e,t){return null!=e&&O.canProjectWithoutEngine(e.spatialReference,t)?O.project(e,t):null}Ge.type="3d",t.__decorate([f.property()],Ge.prototype,"_userClippingArea",void 0),t.__decorate([f.property()],Ge.prototype,"_resourceController",void 0),t.__decorate([f.property()],Ge.prototype,"_stage",void 0),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"deconflictor",void 0),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"labeler",void 0),t.__decorate([f.property(R.owningCollectionProperty(G.AnalysesCollection,"analyses"))],Ge.prototype,"analyses",void 0),t.__decorate([f.property({type:j,readOnly:!0})],Ge.prototype,"animation",null),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"basemapTerrain",void 0),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"elevationProvider",void 0),t.__decorate([f.property()],Ge.prototype,"camera",null),t.__decorate([f.property({type:r})],Ge.prototype,"contentCamera",null),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"canvas",void 0),t.__decorate([f.property({type:He})],Ge.prototype,"center",null),t.__decorate([f.property({type:Ee})],Ge.prototype,"clippingArea",null),t.__decorate([f.property({type:N.Constraints})],Ge.prototype,"constraints",void 0),t.__decorate([f.property({type:Ee,readOnly:!0})],Ge.prototype,"renderDataExtent",null),t.__decorate([f.property({type:Ee,readOnly:!0})],Ge.prototype,"dataExtent",null),t.__decorate([f.property({type:Ee,readOnly:!0})],Ge.prototype,"_groundAndLayersExtent",null),t.__decorate([f.property({type:Q})],Ge.prototype,"environment",void 0),t.__decorate([v.cast("environment")],Ge.prototype,"castEnvironment",null),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"environmentManager",void 0),t.__decorate([f.property({type:Ee})],Ge.prototype,"extent",null),t.__decorate([f.property()],Ge.prototype,"floors",void 0),t.__decorate([f.property()],Ge.prototype,"screenCenter",null),t.__decorate([f.property()],Ge.prototype,"frustum",null),t.__decorate([f.property({type:Number,readOnly:!0})],Ge.prototype,"fullOpacity",void 0),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"graphicsView",void 0),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"analysisViewManager",void 0),t.__decorate([f.property()],Ge.prototype,"groundView",void 0),t.__decorate([f.property({type:Boolean})],Ge.prototype,"initialExtentRequired",null),t.__decorate([f.property()],Ge.prototype,"_defaultsFromMapSettings",null),t.__decorate([f.property()],Ge.prototype,"interacting",null),t.__decorate([f.property()],Ge.prototype,"stationary",null),t.__decorate([f.property()],Ge.prototype,"navigating",null),t.__decorate([f.property()],Ge.prototype,"map",void 0),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"mapCoordsHelper",void 0),t.__decorate([f.property()],Ge.prototype,"padding",null),t.__decorate([f.property({type:me.PointsOfInterest,readOnly:!0})],Ge.prototype,"pointsOfInterest",void 0),t.__decorate([f.property({type:K.FeatureTileTree3D,readOnly:!0})],Ge.prototype,"featureTiles",void 0),t.__decorate([f.property()],Ge.prototype,"_featureTreeDebugger",void 0),t.__decorate([f.property({type:Boolean})],Ge.prototype,"screenSizePerspectiveEnabled",void 0),t.__decorate([f.property({constructOnly:!0})],Ge.prototype,"deactivatedWebGLExtensions",void 0),t.__decorate([f.property({constructOnly:!0})],Ge.prototype,"debugWebGLExtensions",void 0),t.__decorate([f.property({constructOnly:!0})],Ge.prototype,"renderCanvas",void 0),t.__decorate([f.property({constructOnly:!0})],Ge.prototype,"state",void 0),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"inputManager",void 0),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"stateManager",void 0),t.__decorate([f.property({type:["low","medium","high"]})],Ge.prototype,"qualityProfile",null),t.__decorate([f.property({type:he,get(){let e=this._get("qualitySettings");return e||(e=new he,ae.apply(this.qualityProfile,e)),e}})],Ge.prototype,"qualitySettings",void 0),t.__decorate([f.property()],Ge.prototype,"slicePlane",null),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"typeSpecificPreconditionsReady",null),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"renderCoordsHelper",void 0),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"sceneIntersectionHelper",void 0),t.__decorate([f.property({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Ge.prototype,"resolution",null),t.__decorate([f.property({type:Number})],Ge.prototype,"scale",null),t.__decorate([f.property()],Ge.prototype,"heightModelInfo",null),t.__decorate([f.property()],Ge.prototype,"spatialReference",void 0),t.__decorate([f.property({type:Boolean,constructOnly:!0})],Ge.prototype,"alphaCompositingEnabled",void 0),t.__decorate([f.property({constructOnly:!0})],Ge.prototype,"preserveDrawingBufferEnabled",void 0),t.__decorate([f.property({type:Boolean})],Ge.prototype,"supersampleScreenshotsEnabled",void 0),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"type",void 0),t.__decorate([f.property(),v.cast((e=>e instanceof xe?e:S.ensureClass(Pe,e)))],Ge.prototype,"ui",void 0),t.__decorate([f.property({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],Ge.prototype,"updating",null),t.__decorate([f.property()],Ge.prototype,"_updatingObjects",null),t.__decorate([f.property()],Ge.prototype,"_updatingObjectsWithProgress",null),t.__decorate([f.property({type:Number,readOnly:!0,dependsOn:["updating"]})],Ge.prototype,"updatingProgress",void 0),t.__decorate([f.property({type:["global","local"]})],Ge.prototype,"viewingMode",null),t.__decorate([f.property({type:a})],Ge.prototype,"viewpoint",null),t.__decorate([f.property({type:Number})],Ge.prototype,"zoom",null),t.__decorate([f.property({type:se})],Ge.prototype,"highlightOptions",void 0),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"quality",null),t.__decorate([f.property({readOnly:!0})],Ge.prototype,"resolutionScale",null),t.__decorate([f.property()],Ge.prototype,"textures",void 0),Ge=t.__decorate([M.subclass("esri.views.SceneView")],Ge);const De=C.create(),ke=m.createScreenPointArray(),We=L.create();return Ge}));
