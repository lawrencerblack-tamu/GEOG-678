/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Handles","../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../chunks/boundedPlane","../../../../../geometry/support/spatialReferenceUtils","./Manipulation","./utils","../../../../interactive/dragEventPipeline","../../../../interactive/GraphicManipulator","../../../../interactive/editGeometry/interfaces","../../../../interactive/editGeometry/operations/UpdateVertices","../../../../interactive/editGeometry/support/editPlaneUtils"],(function(t,e,i,a,r,n,s,o,l,c,h,p,u,d,_){"use strict";const g=10,v=1e-6,m=.3;function y(t){const e=r.length(t.basis1),i=r.length(t.basis2);return m*Math.min(e,i)}class b extends l.Manipulation{constructor(t){super(),this._handles=new e,this._planeStart=s.create(),this._displayPlaneStart=s.create(),this._originCache=n.create(),this._axisCache=a.create(),this._renderStartCache=n.create(),this._renderEndCache=n.create(),this._resizeOriginCache=n.create(),this._view=t.view,this._tool=t.tool,this._graphic=t.graphic,this._direction=t.direction,this._preserveAspectRatio=t.preserveAspectRatio,this._manipulator=this._createManipulator(),this._handles.add([this._manipulator.events.on("grab-changed",(t=>c.onGrabChangedHandle(t,this._manipulator)))]),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._handles.destroy(),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._graphic=null,this._manipulator=null,this._direction=null,this._handles=null,this._planeStart=null,this._displayPlaneStart=null,this._originCache=null,this._axisCache=null,this._renderStartCache=null,this._renderEndCache=null,this._resizeOriginCache=null,this._preserveAspectRatio=null}forEachManipulator(t){t(this._manipulator,l.ManipulatorType.SCALE)}createDragPipeline(t,e){let a=null,n=null,l=null,c=0,p=null,m=null;const b=this._planeStart,f=this._displayPlaneStart,x=this._direction;return h.createManipulatorDragEventPipeline(this._manipulator,((A,C)=>{C.next((e=>{if("start"===e.action){A.cursor="grabbing";const e=t();a=e.plane,n=e.displayPlane,l=e.editGeometryOperations,c=g*this._view.resolution,s.copy(a,b),s.copy(n,f);const i=o.getInfo(l.data.spatialReference);p=i?i.valid[1]-i.valid[0]-3*g*this._view.resolution:null}return e})).next(h.screenToMap(this._view)).next((t=>{const e=r.copy(this._renderStartCache,[t.mapStart.x,t.mapStart.y,0]),i=r.copy(this._renderEndCache,[t.mapEnd.x,t.mapEnd.y,0]),a=r.copy(this._resizeOriginCache,f.origin);r.scaleAndAdd(a,a,f.basis1,-x[0]),r.scaleAndAdd(a,a,f.basis2,-x[1]),r.subtract(i,i,a),r.subtract(e,e,a);const s=0!==x[0]&&0!==x[1],o=y(f),l=y(n)/o,h=(t,a)=>{if(0===t)return 1;let n=r.length(a),o=.5*t*r.dot(a,i)/n;const h=o<0?-1:1;if(s){o+=(n-.5*t*r.dot(a,e)/n)*h*l}const p=n<1.5*c?1:v;return n=Math.max(n-c,v),h>0&&(o-=g*this._view.resolution),h*Math.max(h*(o/n),p)},p=h(x[0],f.basis1),u=h(x[1],f.basis2);return{...t,direction:x,factor1:p,factor2:u}})).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next((t=>{const n=r.copy(this._originCache,b.origin);r.scaleAndAdd(n,n,b.basis1,-x[0]),r.scaleAndAdd(n,n,b.basis2,-x[1]);const o=i.set(this._axisCache,b.basis1[0],b.basis1[1]);i.normalize(o,o);const c=[];for(const e of l.data.components)c.push(...e.vertices);const h="start"===t.action?u.AccumulationBehavior.NEW_STEP:u.AccumulationBehavior.ACCUMULATE_STEPS,g=l.scaleVertices(c,n,o,t.factor1,t.factor2,h,d.AccumulationType.REPLACE);return p&&p<l.data.geometry.extent.width&&m?l.updateVertices(c,m):(s.copy(b,a),_.apply(g,a),m=g.operation,e(t,g)),t})).next((t=>("end"===t.action&&(A.cursor="grab"),t)))}))}_createManipulator(){return new p.GraphicManipulator({view:this._view,graphic:this._graphic,selectable:!0,cursor:"grab"})}}t.ScaleManipulation=b,t.calculateDiagonalResizeHandleScale=y,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
