/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/maybe","../../../../core/libs/gl-matrix-2/math/common","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f32","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","./VertexStream","./shaders/StencilPrograms","../../../webgl/enums","../../../webgl/ProgramTemplate"],(function(t,e,i,r,s,a,n,o,l,c,d,h){"use strict";const m=a.fromValues(-.5,-.5);class _{constructor(){this._centerNdc=o.create(),this._pxToNdc=o.create(),this._worldDimensionsPx=o.create(),this._mat3=s.create(),this._initialized=!1}dispose(){this._program=e.disposeMaybe(this._program),this._quad=e.disposeMaybe(this._quad)}render(t,e,i){const{context:r}=t,s=this._updateGeometry(t,i);if(null!=e){const{r:t,g:i,b:s,a}=e;r.setClearColor(a*t/255,a*i/255,a*s/255,a)}else r.setClearColor(0,0,0,0);if(r.setStencilFunction(d.CompareFunction.ALWAYS,0,255),r.setStencilWriteMask(255),!s)return r.setClearStencil(1),void r.clear(r.gl.STENCIL_BUFFER_BIT|r.gl.COLOR_BUFFER_BIT);r.setClearStencil(0),r.clear(r.gl.STENCIL_BUFFER_BIT|r.gl.COLOR_BUFFER_BIT),this._initialized||this._initialize(r),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setColorMask(!1,!1,!1,!1),r.setBlendingEnabled(!1),r.setStencilOp(d.StencilOperation.KEEP,d.StencilOperation.KEEP,d.StencilOperation.REPLACE),r.setStencilFunction(d.CompareFunction.ALWAYS,1,255),r.setStencilTestEnabled(!0),r.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind()}_initialize(t){if(this._initialized)return;const e=h.createProgram(t,c.stencil);e&&(this._program=e,this._quad=new l(t,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(t,e){const{state:s,pixelRatio:a}=t,{size:o,rotation:l}=s,c=Math.round(o[0]*a),d=Math.round(o[1]*a);if(!s.spatialReference.isWrappable)return!1;const h=i.toRadian(l),_=Math.abs(Math.cos(h)),u=Math.abs(Math.sin(h)),p=Math.round(c*_+d*u),g=Math.round(s.worldScreenWidth);if(p<=g)return!1;const b=c*u+d*_,f=g*a,S=(e.left-e.right)*a/c,x=(e.bottom-e.top)*a/d;n.set(this._worldDimensionsPx,f,b,1),n.set(this._pxToNdc,2/c,-2/d,1),n.set(this._centerNdc,S,x,1);const E=this._mat3;return r.fromTranslation(E,this._centerNdc),r.scale(E,E,this._pxToNdc),0!==l&&r.rotate(E,E,h),r.scale(E,E,this._worldDimensionsPx),r.translate(E,E,m),!0}}t.WorldExtentRenderer=_,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
