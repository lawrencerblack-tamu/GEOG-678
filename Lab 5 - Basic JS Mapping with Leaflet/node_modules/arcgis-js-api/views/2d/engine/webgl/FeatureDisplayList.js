/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","./enums","./cpuMapped/FreeList"],(function(t,e,n,a){"use strict";function i(t,e){return t<<16|255&e}function s(t){return 255&t}class r{constructor(t,e,n,a,i){this.instance=t,this.materialKey=e,this.target=n,this.start=a,this.count=i}get textureKey(){return s(this.materialKey)}get indexEnd(){return this.start+this.count}extend(t){this.count+=t}render(t){this.instance.techniqueRef.render(t,this)}}class d{constructor(){this._length=0,this._minOrderedLength=0,this._materialKeys=new Set}static fromDisplayEntities(t,e,n,a){const s=new d;for(const r of t.values())for(const t of r.records){const r=n.getInstance(t.instanceId),d=i(r.instanceId,t.textureKey);s.addRecord(r,d,t.indexStart,t.indexCount,t.vertexStart,t.vertexCount,e,a)}return s}get length(){return this._length}get minOrderedLength(){return this._minOrderedLength}get minUnorderedLength(){return this._materialKeys.size}render(t){const{drawPhase:e}=t;for(const n of this.infos())n.instance.techniqueRef.drawPhase&e&&n.render(t)}addRecord(t,e,i,s,d,h,l,o){let u=i,c=s;if(c||(u=d,c=h),!c)return;if(null==this._head){const n=new r(t,e,l,u,c);return this._head=new a.List(n),this._tail=this._head,this._length++,void this._minOrderedLength++}if(o===n.FeatureBatchingStrategy.STRICT_ORDER)return this._insert(t,e,l,u,c,this._tail,null);let _=null,g=this._head;const f=t.instanceId,y=t.techniqueRef.symbologyPlane;if(o===n.FeatureBatchingStrategy.STRICT_MARKERS_AND_TEXT&&(y===n.FeatureSymbologyDrawOrder.MARKER||y===n.FeatureSymbologyDrawOrder.TEXT))return this._insert(t,e,l,u,c,this._tail,null);for(;g;){const n=g.data.instance,a=n.instanceId,i=n.techniqueRef.symbologyPlane,s=_?.data.instance.instanceId;if(y<i||f===s&&f!==a)return this._insert(t,e,l,u,c,_,g);_=g,g=g.next}this._insert(t,e,l,u,c,_,null)}*infos(){if(null!=this._head)for(const t of this._head.values())yield t}_insert(t,e,n,i,s,d,h){if(null==d&&null==h){const d=new r(t,e,n,i,s);return this._head=new a.List(d),this._tail=this._head,this._length++,void this._minOrderedLength++}return e!==this._tail.data.materialKey&&this._minOrderedLength++,this._materialKeys.add(e),null==d&&null!=h?this._insertAtHead(t,e,n,i,s,h):null!=d&&null==h?this._insertAtEnd(t,e,n,i,s,d):null!=d&&null!=h?this._insertAtMiddle(t,e,n,i,s,d,h):void 0}_insertAtHead(t,e,n,i,s,d){const h=i+s;if(e===d.data.materialKey&&n===d.data.target&&h===d.data.start)d.data.start=i,d.data.count+=s;else{const h=new r(t,e,n,i,s);this._head=new a.List(h),this._head.next=d,this._length++}}_insertAtEnd(t,e,n,i,s,d){if(d.data.materialKey===e&&d.data.indexEnd===i)d.data.count+=s;else{const h=new r(t,e,n,i,s);this._tail=new a.List(h),d.next=this._tail,this._length++}}_insertAtMiddle(t,e,n,i,s,d,h){const l=i+s;if(d.data.materialKey===e&&d.data.target===n&&d.data.indexEnd===i)d.data.count+=s,d.data.materialKey===h.data.materialKey&&d.data.target===h.data.target&&d.data.indexEnd===h.data.start&&(d.data.count+=h.data.count,d.next=h.next,this._length--);else if(e===h.data.materialKey&&n===h.data.target&&l===h.data.start)h.data.start=i,h.data.count+=s;else{const l=new r(t,e,n,i,s),o=new a.List(l);d.next=o,o.next=h,this._length++}}}t.DisplayList=d,t.DisplayListInfo=r,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
