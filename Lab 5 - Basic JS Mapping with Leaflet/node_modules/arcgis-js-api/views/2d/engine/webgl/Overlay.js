/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../../../core/Error","../../../../core/events","../../../../core/Logger","../../../../core/maybe","../../../../core/perspectiveUtils","../../../../core/reactiveUtils","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../symbols/cim/enums","../DisplayObject","./animatedFormats/utils","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor","../../../webgl/VertexArrayObject"],(function(e,t,i,r,s,n,a,o,l,h,c,m,p,u,d,y,w){"use strict";const g=a.create(),f={none:h.AnimatedSymbolRepeatType.None,loop:h.AnimatedSymbolRepeatType.Loop,oscillate:h.AnimatedSymbolRepeatType.Oscillate};function x(e){return e?{...e,playAnimation:e.playing,repeatType:e.repeatType?f[e.repeatType]:void 0}:{}}class b extends c.DisplayObject{constructor(s){super(),this.elementView=s,this.isWrapAround=!1,this.perspectiveTransform=l.create(),this._playHandle=null,this._vertices=new Float32Array(20),this._handles=[],this._handles.push(n.watch((()=>this.elementView.element.opacity),(e=>this.opacity=e),n.initial),n.watch((()=>[this.elementView.coords]),(()=>{this.requestRender()}),n.initial),n.watch((()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions]),(()=>{this._playHandle?.remove(),this.texture=r.disposeMaybe(this.texture),this.requestRender()}),n.initial),n.when((()=>this.elementView.element.loaded),(()=>{const e=this.elementView.element;this.ready(),"video"===e.type&&null!=e.content&&this._handles.push(t.on(e.content,"play",(()=>this.requestRender())))}),n.initial)),s.element.load().catch((t=>{i.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new e("element-load-error","Element cannot be displayed",{element:s,error:t}))}))}getMesh(e){throw new Error("Method not implemented.")}destroy(){this._playHandle?.remove(),this._handles.forEach((e=>e.remove())),this.texture=r.disposeMaybe(this.texture)}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,i=this.elementView.element.content;if(null!=i){const e=i instanceof HTMLImageElement,r=i instanceof HTMLVideoElement,s=e?i.naturalWidth:r?i.videoWidth:i.width,n=e?i.naturalHeight:r?i.videoHeight:i.height;if(this._updatePerspectiveTransform(s,n),this.texture)r&&!i.paused&&(this.texture.setData(i),this.requestRender(),this.texture.generateMipmap());else{const e=new y.TextureDescriptor;if(e.wrapMode=u.TextureWrapMode.CLAMP_TO_EDGE,e.preMultiplyAlpha=!0,e.width=s,e.height=n,"getFrame"in i){const r=i=>{this.texture?this.texture.setData(i):this.texture=new d.Texture(t,e,i),this.requestRender()};"animationOptions"in this.elementView.element&&(this._playHandle=m.play(i,x(this.elementView.element.animationOptions),null,r))}else this.texture=new d.Texture(t,e,i);this.texture.generateMipmap(),r&&!i.paused&&this.requestRender()}}super.beforeRender(e)}_createTransforms(){return null}updateDrawCoords(e,t){const i=this.elementView.coords;if(null==i)return;const[r,s,n,a]=i.rings[0],o=this._vertices,{x:l,y:h}=e,c=0!==t;c?o.set([s[0]-l,s[1]-h,r[0]-l,r[1]-h,n[0]-l,n[1]-h,a[0]-l,a[1]-h,a[0]-l,a[1]-h,s[0]+t-l,s[1]-h,s[0]+t-l,s[1]-h,r[0]+t-l,r[1]-h,n[0]+t-l,n[1]-h,a[0]+t-l,a[1]-h]):o.set([s[0]-l,s[1]-h,r[0]-l,r[1]-h,n[0]-l,n[1]-h,a[0]-l,a[1]-h]),this.isWrapAround=c}getVAO(e,t,i){if(null==this.elementView.coords)return null;const r=this._vertices;if(this._vao)this._geometryVbo.setData(r);else{this._geometryVbo=p.BufferObject.createVertex(e,u.Usage.DYNAMIC_DRAW,r);const s=p.BufferObject.createVertex(e,u.Usage.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new w.VertexArrayObject(e,i,t,{geometry:this._geometryVbo,tex:s})}return this._vao}_updatePerspectiveTransform(e,t){const i=this._vertices;s.getProjectiveTransform(g,[0,0,e,0,0,t,e,t],[i[0],i[1],i[4],i[5],i[2],i[3],i[6],i[7]]),o.set(this.perspectiveTransform,g[6]/g[8]*e,g[7]/g[8]*t)}}return b}));
