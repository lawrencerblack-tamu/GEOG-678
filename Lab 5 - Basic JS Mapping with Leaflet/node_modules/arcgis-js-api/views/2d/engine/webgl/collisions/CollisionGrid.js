/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/mathUtils","../definitions","../../../layers/features/support/StaticBitSet"],(function(t,e,s,i){"use strict";const l=1,h=0,o=1,a=2;class c{constructor(t,e,s){this._debugMap=new Map,this._width=t*s,this._height=e*s,this._pixelRatio=s;const h=Math.ceil(this._width/l),o=Math.ceil(this._height/l);this._cols=h,this._rows=o,this._cells=i.StaticBitSet.create(h*o)}insertMetrics(t){this._markMetrics(t)}hasCollision(t){let e=0;for(const{computedX:i,computedY:l,width:h,height:c}of t.bounds){const t=(h+s.labelPlacementOffsetPadding)*this._pixelRatio,r=(c+s.labelPlacementOffsetPadding)*this._pixelRatio;switch(this._collide(i,l,t,r)){case a:return a;case o:e++}}return e===t.bounds.length?o:h}getCellId(t,e){return t+e*this._cols}has(t){return this._cells.has(t)}hasRange(t,e){return this._cells.hasRange(t,e)}set(t){this._cells.set(t)}setRange(t,e){this._cells.setRange(t,e)}_collide(t,s,i,c){const r=t-i/2,n=s-c/2,_=r+i,d=n+c;if(_<0||d<0||r>this._width||n>this._height)return o;const f=e.clamp(Math.floor(r/l),0,this._cols),u=e.clamp(Math.floor(n/l),0,this._rows),p=e.clamp(Math.ceil(_/l),0,this._cols),m=e.clamp(Math.ceil(d/l),0,this._rows);for(let e=u;e<=m;e++)for(let t=f;t<=p;t++){const s=this.getCellId(t,e);if(this.has(s))return a}return h}_mark(t,s,i,h,o){const a=t-i/2,c=s-h/2,r=a+i,n=c+h,_=e.clamp(Math.floor(a/l),0,this._cols),d=e.clamp(Math.floor(c/l),0,this._rows),f=e.clamp(Math.ceil(r/l),0,this._cols),u=e.clamp(Math.ceil(n/l),0,this._rows);for(let e=d;e<=u;e++)for(let t=_;t<=f;t++){const s=this.getCellId(t,e);this._debugMap.set(s,o),this.set(s)}return!1}_markMetrics(t){for(const{computedX:e,computedY:i,width:l,height:h}of t.bounds){const o=(l+s.labelPlacementOffsetPadding)*this._pixelRatio,a=(h+s.labelPlacementOffsetPadding)*this._pixelRatio;this._mark(e,i,o,a,t.entityTexel)}}}t.CollisionBitsetGrid=c,t.hasCollision=a,t.none=h,t.outsideExtent=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
