/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/has","../definitions","../VertexStream","./Effect"],(function(e,t,r,i,n){"use strict";class a extends n.Effect{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(e,n){if(!n?.size)return;const{context:a,renderingOptions:o}=e;this._quad||(this._quad=new i(a,[0,0,1,0,0,1,1,1]));const s=a.getBoundFramebufferObject(),{x:u,y:d,width:f,height:l}=a.getViewport(),c=n.getBlock(r.AttributeDataType.Animation);if(null==c)return;const m=n.getUniforms(a);a.setViewport(0,0,n.size,n.size);const x=m.filterFlags,_=m.animation,g=t("featurelayer-animation-enabled")?o.labelsAnimationTime:1,p=c.getFBO(a,1);a.unbindTexture(p.colorTexture),this._computeDelta(e,p,_,x,g);const b=c.getFBO(a);a.unbindTexture(b.colorTexture),this._updateAnimationState(e,p,b),a.bindFramebuffer(s),a.setViewport(u,d,f,l)}_computeDelta(e,t,r,i,n){const{context:a,painter:o,displayLevel:s}=e,u=o.materialManager.getProgram(this._desc,["delta"]);if(a.bindFramebuffer(t),a.setColorMask(!0,!0,!0,!0),a.setClearColor(0,0,0,0),a.clear(a.gl.COLOR_BUFFER_BIT),a.useProgram(u),!("type"in i.texture)||!("type"in r.texture))throw new Error("InternalError: Expected to find texture");a.bindTexture(i.texture,i.unit),a.bindTexture(r.texture,r.unit),u.setUniform1i("u_maskTexture",i.unit),u.setUniform1i("u_sourceTexture",r.unit),u.setUniform1f("u_timeDelta",e.deltaTime),u.setUniform1f("u_animationTime",n),u.setUniform1f("u_zoomLevel",Math.round(10*s)),this._quad.draw()}_updateAnimationState(e,t,r){const{context:i,painter:n}=e,a=n.materialManager.getProgram(this._desc,["update"]);i.bindTexture(t.colorTexture,1),i.useProgram(a),a.setUniform1i("u_sourceTexture",1),i.bindFramebuffer(r),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),this._quad.draw()}}e.AnimationEffect=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
