/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../definitions","./Effect","../../../../webgl/enums"],(function(t,e,s,i){"use strict";class n extends s.Effect{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions({pixelRatio:t},s,i=e.hittestRadius){if(!s.length)return null;const n=s.shift(),o=n.x,r=n.y;return this._outstanding=n,{type:"hittest",distance:i*t,smallSymbolDistance:0,smallSymbolSizeThreshold:3,position:[o,r]}}bind(t){const{context:s,attributeView:i}=t;if(!i.size)return;const n=i.getBlock(e.AttributeDataType.GPGPU);if(null==n)return;const o=n.getFBO(s);s.setViewport(0,0,i.size,i.size),s.bindFramebuffer(o),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT)}unbind(){}draw(t){if(null==this._outstanding)return;const e=this._outstanding;this._outstanding=null,this._resolve(t,e.resolvers)}async _resolve(t,s){const{context:n,attributeView:o}=t,r=o.getBlock(e.AttributeDataType.GPGPU);if(null==r)return void s.forEach((t=>t.resolve([])));const l=r.getFBO(n),a=new Uint8Array(l.width*l.height*4);try{await l.readPixelsAsync(0,0,l.width,l.height,i.PixelFormat.RGBA,i.PixelType.UNSIGNED_BYTE,a)}catch(u){return void s.forEach((t=>t.resolve([])))}const c=[];for(let e=0;e<a.length;e+=4){const t=e/4;a[e]&&c.push(t)}s.forEach((t=>t.resolve(c)))}}t.HittestEffect=n,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
