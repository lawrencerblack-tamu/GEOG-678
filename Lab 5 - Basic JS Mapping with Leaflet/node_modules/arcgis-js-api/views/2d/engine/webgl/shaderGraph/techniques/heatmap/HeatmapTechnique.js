/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../featureTechniqueUtils","../Technique","./HeatmapResources","../mesh/MeshWriterRegistry","../shaders/HeatmapAccumulateShader","../shaders/HeatmapResolveShader","../../../../../../webgl/enums"],(function(e,t,i,r,s,n,u,o){"use strict";class a extends i.Technique{constructor(){super(...arguments),this.meshWriter=s.meshWriterRegistry.HeatmapMeshWriter,this.shaders={accumulate:new n.HeatmapAccumulateShader,resolve:new u.HeatmapResolveShader},this.postProcessingEnabled=!0,this._isBound=!1,this._resources=new Map,this.overrideStencilRef=c}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,i){const{context:r,painter:s,state:n}=e,u=i.instance.getInput(),{isFieldActive:o}=u,a=this._getOrCreateResourcesRecord(r),l=a.loadQualityProfile(r);if(t.isHighlight(e))return;t.isHittest(e)||this._bind(e,a,u),s.setShader({shader:this.shaders.accumulate,uniforms:{...t.getFeatureUniforms(e,i.target),kernelControls:{radius:f(u,n),isFieldActive:o?1:0}},defines:{...t.getSelectionDefines(e),...l.defines},optionalAttributes:i.instance.optionalAttributes,useComputeBuffer:t.isHittest(e)});const c=t.isHittest(e)?d:h;s.setPipelineState(c),s.submitDraw(r,i)}postProcess(e,i){if(t.isHittest(e)||t.isHighlight(e))return;const{context:r,painter:s}=e,n=this._resources.get(r);if(null==this._prevFBO||null==this._prevViewport||!n?.initialized)return;const{defines:u}=n.loadQualityProfile(r),{minDensity:o,maxDensity:a,radius:l}=i.getInput(),c=8,h=9,d=n.accumulateFramebuffer,f=n.resolveGradientTexture;s.setShader({shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:c,texture:d.colorTexture},minAndInvRange:[o,1/(a-o)],normalization:3/(l*l*Math.PI)},gradient:{texture:{unit:h,texture:f}}},defines:u,optionalAttributes:{},useComputeBuffer:!1}),r.bindFramebuffer(this._prevFBO),r.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),r.bindTexture(d.colorTexture,c),r.bindTexture(f,h),s.setPipelineState(p),s.submitDrawQuad(r),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new r.HeatmapResources,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;const{context:r,state:s,pixelRatio:n}=e,u=r.getBoundFramebufferObject(),a=r.getViewport();this._prevFBO=u,this._prevViewport=a;const{gradient:c,gradientHash:h}=i;t.ensureResolveGradientTexture(r,h,c);const{width:d,height:p}=a,m=l(f(i,s),n),g=d*m,_=p*m,b=t.ensureAccumulateFBO(r,g,_);r.blitFramebuffer(u,b,0,0,u.width,u.height,0,0,b.width,b.height,o.ClearBufferBit.STENCIL_BUFFER_BIT,o.TextureSamplingMode.NEAREST),r.bindFramebuffer(b),r.setViewport(0,0,b.width,b.height),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear(o.ClearBufferBit.COLOR_BUFFER_BIT),this._isBound=!0}}function l(e,t){const i=t>1.5?.25:.5;return e<1/(2*i)?1:i}function c(e){return e.key.level+1}const h={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:c,compare:o.CompareFunction.GEQUAL,mask:255,op:{fail:o.StencilOperation.KEEP,zFail:o.StencilOperation.KEEP,zPass:o.StencilOperation.REPLACE}}}},d={...h,stencil:!1},p={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function f(e,t){const{referenceScale:i,radius:r}=e;return r*(0!==i?i/t.scale:1)}e.HeatmapTechnique=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
