/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/libs/gl-matrix-2/factories/vec2f32","../../vectorTiles/decluttering/config","../../vectorTiles/style/StyleDefinition","../definitions","../GeometryUtils","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,a,n,r,o,s){"use strict";const l=1/65536;class c extends o{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=t.create()}dispose(){}drawMany(e,t){const i=e.styleLayer;this._drawIcons(e,i,t),this._drawText(e,i,t)}_drawIcons(e,t,o){const{context:s,displayLevel:l,painter:c,spriteMosaic:u,state:f,styleLayerUID:p,requestRender:m,allowDelayedRender:g}=e,y=t.iconMaterial,d=c.vectorTilesMaterialManager;let _,h=!1;for(const i of o)if(i.layerData.has(p)&&(_=i.layerData.get(p),_.iconPerPageElementsMap.size>0)){h=!0;break}if(!h)return;const M=t.getPaintValue("icon-translate",l),T=t.getPaintValue("icon-translate-anchor",l);let P=t.getLayoutValue("icon-rotation-alignment",l);P===a.RotationAlignment.AUTO&&(P=t.getLayoutValue("symbol-placement",l)===a.SymbolPlacement.POINT?a.RotationAlignment.VIEWPORT:a.RotationAlignment.MAP);const U=P===a.RotationAlignment.MAP,S=t.getLayoutValue("icon-keep-upright",l)&&U,x=_.isIconSDF,E=this._iconProgramOptions;E.sdf=x;const v=d.getMaterialProgram(s,y,E);if(g&&null!=m&&!v.compiled)return void m();s.useProgram(v),v.setUniformMatrix3fv("u_displayViewMat3",P===a.RotationAlignment.MAP?f.displayViewMat3:f.displayMat3),v.setUniformMatrix3fv("u_displayMat3",T===a.TranslateAnchor.VIEWPORT?f.displayMat3:f.displayViewMat3),v.setUniform2fv("u_iconTranslation",M),v.setUniform1f("u_depth",t.z),v.setUniform1f("u_mapRotation",r.degToByte(f.rotation)),v.setUniform1f("u_keepUpright",S?1:0),v.setUniform1f("u_level",10*l),v.setUniform1i("u_texture",n.vtlTextureBindingUnitSprites),v.setUniform1f("u_fadeDuration",i.fadeDuration/1e3);let R=-1;for(const i of o){if(!i.layerData.has(p))continue;if(i.key.level!==R&&(R=i.key.level,y.setDataUniforms(v,l,t,R,u)),_=i.layerData.get(p),0===_.iconPerPageElementsMap.size)continue;_.prepareForRendering(s),_.updateOpacityInfo();const a=_.iconVAO;if(null!=a){s.bindVAO(a),v.setUniformMatrix3fv("u_dvsMat3",i.transforms.displayViewScreenMat3),v.setUniform1f("u_time",(performance.now()-_.lastOpacityUpdate)/1e3);for(const[t,a]of _.iconPerPageElementsMap)this._renderIconRange(e,v,a,t,i)}}}_renderIconRange(e,t,i,a,r){const{context:o,spriteMosaic:l}=e;this._spritesTextureSize[0]=l.getWidth(a)/4,this._spritesTextureSize[1]=l.getHeight(a)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),l.bind(o,s.TextureSamplingMode.LINEAR,a,n.vtlTextureBindingUnitSprites),this._setStencilState(e,r),o.drawElements(s.PrimitiveType.TRIANGLES,i[1],s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]),r.triangleCount+=i[1]/3}_drawText(e,o,s){const{context:c,displayLevel:u,glyphMosaic:f,painter:p,pixelRatio:m,spriteMosaic:g,state:y,styleLayerUID:d,requestRender:_,allowDelayedRender:h}=e,M=o.textMaterial,T=p.vectorTilesMaterialManager;let P,U=!1;for(const t of s)if(t.layerData.has(d)&&(P=t.layerData.get(d),P.glyphPerPageElementsMap.size>0)){U=!0;break}if(!U)return;const S=o.getPaintProperty("text-opacity");if(S&&!S.isDataDriven&&0===S.getValue(u))return;const x=o.getPaintProperty("text-color"),E=!x||x.isDataDriven||x.getValue(u)[3]>0,v=o.getPaintProperty("text-halo-width"),R=o.getPaintProperty("text-halo-color"),A=(!v||v.isDataDriven||v.getValue(u)>0)&&(!R||R.isDataDriven||R.getValue(u)[3]>0);if(!E&&!A)return;const D=24/8;let V=o.getLayoutValue("text-rotation-alignment",u);V===a.RotationAlignment.AUTO&&(V=o.getLayoutValue("symbol-placement",u)===a.SymbolPlacement.POINT?a.RotationAlignment.VIEWPORT:a.RotationAlignment.MAP);const I=V===a.RotationAlignment.MAP,L=o.getLayoutValue("text-keep-upright",u)&&I,w=.8*D/m;this._glyphTextureSize||(this._glyphTextureSize=t.fromValues(f.width/4,f.height/4));const O=o.getPaintValue("text-translate",u),N=o.getPaintValue("text-translate-anchor",u),b=this._sdfProgramOptions,z=T.getMaterialProgram(c,M,b);if(h&&null!=_&&!z.compiled)return void _();c.useProgram(z),z.setUniformMatrix3fv("u_displayViewMat3",V===a.RotationAlignment.MAP?y.displayViewMat3:y.displayMat3),z.setUniformMatrix3fv("u_displayMat3",N===a.TranslateAnchor.VIEWPORT?y.displayMat3:y.displayViewMat3),z.setUniform2fv("u_textTranslation",O),z.setUniform1f("u_depth",o.z+l),z.setUniform2fv("u_mosaicSize",this._glyphTextureSize),z.setUniform1f("u_mapRotation",r.degToByte(y.rotation)),z.setUniform1f("u_keepUpright",L?1:0),z.setUniform1f("u_level",10*u),z.setUniform1i("u_texture",n.vtlTextureBindingUnitGlyphs),z.setUniform1f("u_antialiasingWidth",w),z.setUniform1f("u_fadeDuration",i.fadeDuration/1e3);let G=-1;for(const t of s){if(!t.layerData.has(d))continue;if(t.key.level!==G&&(G=t.key.level,M.setDataUniforms(z,u,o,G,g)),P=t.layerData.get(d),0===P.glyphPerPageElementsMap.size)continue;P.prepareForRendering(c),P.updateOpacityInfo();const i=P.textVAO;if(null==i)continue;c.bindVAO(i),z.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),this._setStencilState(e,t);const a=(performance.now()-P.lastOpacityUpdate)/1e3;z.setUniform1f("u_time",a),P.glyphPerPageElementsMap.forEach(((e,i)=>{this._renderGlyphRange(c,e,i,f,z,A,E,t)}))}}_renderGlyphRange(e,t,i,a,r,o,l,c){a.bind(e,s.TextureSamplingMode.LINEAR,i,n.vtlTextureBindingUnitGlyphs),o&&(r.setUniform1f("u_halo",1),e.drawElements(s.PrimitiveType.TRIANGLES,t[1],s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),c.triangleCount+=t[1]/3),l&&(r.setUniform1f("u_halo",0),e.drawElements(s.PrimitiveType.TRIANGLES,t[1],s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),c.triangleCount+=t[1]/3)}_setStencilState(e,t){const{context:i,is3D:a,stencilSymbols:n}=e;if(i.setStencilTestEnabled(!0),n)return i.setStencilWriteMask(255),void i.setStencilFunction(s.CompareFunction.ALWAYS,t.stencilRef,255);i.setStencilWriteMask(0),a?i.setStencilFunction(s.CompareFunction.EQUAL,t.stencilRef,255):i.setStencilFunction(s.CompareFunction.GREATER,255,255)}}e.WGLBrushVTLSymbol=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
