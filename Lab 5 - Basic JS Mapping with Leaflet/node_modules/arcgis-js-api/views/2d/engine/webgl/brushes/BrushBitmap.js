/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../definitions","../VertexStream","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,n){"use strict";const a={nearest:{defines:[],samplingMode:n.TextureSamplingMode.NEAREST,mips:!1},bilinear:{defines:[],samplingMode:n.TextureSamplingMode.LINEAR,mips:!1},bicubic:{defines:["bicubic"],samplingMode:n.TextureSamplingMode.LINEAR,mips:!1},trilinear:{defines:[],samplingMode:n.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,mips:!0}},r=(e,t,i)=>{if("dynamic"===i.samplingMode){const{state:i}=e,n=t.resolution/t.pixelRatio/i.resolution,r=Math.round(e.pixelRatio)!==e.pixelRatio,s=n>1.05||n<.95;return i.rotation||s||r||t.isSourceScaled||t.rotation?a.bilinear:a.nearest}return a[i.samplingMode]};class s extends i{constructor(){super(...arguments),this._desc={vsPath:"raster/bitmap",fsPath:"raster/bitmap",attributes:new Map([["a_pos",0]])}}dispose(){this._quad&&this._quad.dispose()}prepareState({context:e}){e.setBlendingEnabled(!0),e.setColorMask(!0,!0,!0,!0),e.setStencilWriteMask(0),e.setStencilTestEnabled(!0)}draw(i,a){const{context:s,renderingOptions:o,painter:d,requestRender:l,allowDelayedRender:c}=i;if(!a.source||!a.isReady)return;const u=r(i,a,o),p=d.materialManager.getProgram(this._desc,u.defines);if(c&&null!=l&&!p.compiled)return void l();i.timeline.begin(this.name),"additive"===a.blendFunction?s.setBlendFunctionSeparate(n.BlendFactor.ONE,n.BlendFactor.ONE,n.BlendFactor.ONE,n.BlendFactor.ONE):s.setBlendFunctionSeparate(n.BlendFactor.ONE,n.BlendFactor.ONE_MINUS_SRC_ALPHA,n.BlendFactor.ONE,n.BlendFactor.ONE_MINUS_SRC_ALPHA),s.setStencilFunction(n.CompareFunction.EQUAL,a.stencilRef,255),this._quad||(this._quad=new t(s,[0,0,1,0,0,1,1,1]));const{coordScale:m,computedOpacity:f,transforms:M}=a;a.setSamplingProfile(u),a.bind(i.context,e.textureBindingBitmap),s.useProgram(p),p.setUniformMatrix3fv("u_dvsMat3",M.displayViewScreenMat3),p.setUniform1i("u_texture",e.textureBindingBitmap),p.setUniform2fv("u_coordScale",m),p.setUniform1f("u_opacity",f),this._quad.draw(),i.timeline.end(this.name)}}return s}));
