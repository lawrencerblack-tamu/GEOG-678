/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/mathUtils","../../../../../core/libs/gl-matrix-2/factories/mat3f32","../../../../../core/libs/gl-matrix-2/factories/vec4f32","../definitions","./WGLBrush","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject"],(function(t,e,r,i,o,a,s,n,c){"use strict";class l extends a{constructor(){super(...arguments),this._color=i.fromValues(1,0,0,1),this._patternMatrix=r.create(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(t,r){const{context:i,painter:a,requestRender:s,allowDelayedRender:c}=t;this._loadWGLResources(t);const l=t.displayLevel,u=t.styleLayer,f=u.backgroundMaterial,d=a.vectorTilesMaterialManager,g=u.getPaintValue("background-color",l),_=u.getPaintValue("background-opacity",l),p=u.getPaintValue("background-pattern",l),m=void 0!==p,h=1|window.devicePixelRatio,x=t.spriteMosaic;let v,b;const y=h>o.vtlHighResCutoff?2:1,M=this._programOptions;M.pattern=m;const w=d.getMaterialProgram(i,f,M);if(!c||null==s||w.compiled){if(i.bindVAO(this._vao),i.useProgram(w),m){const t=x.getMosaicItemPosition(p,!0);if(null!=t){const{tl:e,br:r,page:a}=t;v=r[0]-e[0],b=r[1]-e[1];const s=x.getPageSize(a);null!=s&&(x.bind(i,n.TextureSamplingMode.LINEAR,a,o.vtlTextureBindingUnitSprites),w.setUniform4f("u_tlbr",e[0],e[1],r[0],r[1]),w.setUniform2fv("u_mosaicSize",s),w.setUniform1i("u_texture",o.vtlTextureBindingUnitSprites))}w.setUniform1f("u_opacity",_)}else{const t=g[3]*_;this._color[0]=t*g[0],this._color[1]=t*g[1],this._color[2]=t*g[2],this._color[3]=t,w.setUniform4fv("u_color",this._color)}w.setUniform1f("u_depth",u.z||0);for(const t of r){if(w.setUniform1f("u_coord_range",t.rangeX),w.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),m){const r=Math.max(2**(Math.round(l)-t.key.level),1),i=y*t.width*r,o=i/e.nextPowerOfTwo(v),a=i/e.nextPowerOfTwo(b);this._patternMatrix[0]=o,this._patternMatrix[4]=a,w.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}i.setStencilFunction(n.CompareFunction.EQUAL,0,255),i.drawArrays(n.PrimitiveType.TRIANGLE_STRIP,0,4)}}else s()}_loadWGLResources(t){if(this._vao)return;const{context:e,styleLayer:r}=t,i=r.backgroundMaterial,o=new Int8Array([0,0,1,0,0,1,1,1]),a=s.BufferObject.createVertex(e,n.Usage.STATIC_DRAW,o),l=new c.VertexArrayObject(e,i.getAttributeLocations(),i.getLayoutInfo(),{geometry:a});this._vao=l}}t.WGLBrushVTLBackground=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
