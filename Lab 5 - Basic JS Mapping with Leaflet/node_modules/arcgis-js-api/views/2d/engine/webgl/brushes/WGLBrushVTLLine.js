/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../vectorTiles/style/StyleDefinition","../definitions","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,n,a){"use strict";class r extends n{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(e,n){const{context:r,displayLevel:s,state:o,painter:l,pixelRatio:u,spriteMosaic:f,styleLayerUID:d,requestRender:c,allowDelayedRender:p}=e;if(!n.some((e=>e.layerData.get(d)?.lineIndexCount??!1)))return;const g=e.styleLayer,m=g.lineMaterial,y=l.vectorTilesMaterialManager,v=g.getPaintValue("line-translate",s),T=g.getPaintValue("line-translate-anchor",s),M=g.getPaintProperty("line-pattern"),S=void 0!==M,U=S&&M.isDataDriven;let x,E;if(S&&!U){const e=M.getValue(s);x=f.getMosaicItemPosition(e)}let _=!1;if(!S){const e=g.getPaintProperty("line-dasharray");if(E=void 0!==e,_=E&&e.isDataDriven,E&&!_){const t=e.getValue(s),i=g.getDashKey(t,g.getLayoutValue("line-cap",s));x=f.getMosaicItemPosition(i)}}const P=1/u,I=this._programOptions;I.pattern=S,I.sdf=E;const D=y.getMaterialProgram(r,m,I);if(p&&null!=c&&!D.compiled)return void c();if(r.useProgram(D),D.setUniformMatrix3fv("u_displayViewMat3",o.displayViewMat3),D.setUniformMatrix3fv("u_displayMat3",T===t.TranslateAnchor.VIEWPORT?o.displayMat3:o.displayViewMat3),D.setUniform2fv("u_lineTranslation",v),D.setUniform1f("u_depth",g.z),D.setUniform1f("u_antialiasing",P),x&&null!=x){const{page:e}=x,t=f.getPageSize(e);null!=t&&(f.bind(r,a.TextureSamplingMode.LINEAR,e,i.vtlTextureBindingUnitSprites),D.setUniform2fv("u_mosaicSize",t),D.setUniform1i("u_texture",i.vtlTextureBindingUnitSprites))}let L=-1;for(const t of n){if(!t.layerData.has(d))continue;t.key.level!==L&&(L=t.key.level,m.setDataUniforms(D,s,g,L,f));const e=2**(s-L)/u;D.setUniform1f("u_zoomFactor",e);const n=t.layerData.get(d);if(!n.lineIndexCount)continue;n.prepareForRendering(r);const o=n.vao;if(null!=o){if(r.bindVAO(o),D.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),r.setStencilFunction(a.CompareFunction.EQUAL,t.stencilRef,255),U||_){const e=n.patternMap;if(!e)continue;for(const[t,n]of e){const e=f.getPageSize(t);null!=e&&(f.bind(r,a.TextureSamplingMode.LINEAR,t,i.vtlTextureBindingUnitSprites),D.setUniform2fv("u_mosaicSize",e),D.setUniform1i("u_texture",i.vtlTextureBindingUnitSprites),r.drawElements(a.PrimitiveType.TRIANGLES,n[1],a.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n[0]))}}else r.drawElements(a.PrimitiveType.TRIANGLES,n.lineIndexCount,a.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n.lineIndexStart);t.triangleCount+=n.lineIndexCount/3}}}}e.WGLBrushVTLLine=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
