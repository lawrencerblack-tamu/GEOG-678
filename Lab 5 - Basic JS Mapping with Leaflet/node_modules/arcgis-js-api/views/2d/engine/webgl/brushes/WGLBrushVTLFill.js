/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../vectorTiles/style/StyleDefinition","../definitions","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,n,a){"use strict";const l=1/65536;class r extends n{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(e,t){const{displayLevel:i,renderPass:n,spriteMosaic:a,styleLayerUID:l}=e;let r=!1;for(const M of t)if(M.layerData.has(l)){const e=M.layerData.get(l);if(e.fillIndexCount>0||e.outlineIndexCount>0){r=!0;break}}if(!r)return;const o=e.styleLayer,s=o.getPaintProperty("fill-pattern"),u=void 0!==s,f=u&&s.isDataDriven;let c;if(u&&!f){const e=s.getValue(i);c=a.getMosaicItemPosition(e,!0)}const d=!u&&o.getPaintValue("fill-antialias",i);let p=!0,y=1;if(!u){const e=o.getPaintProperty("fill-color"),t=o.getPaintProperty("fill-opacity");if(!e?.isDataDriven&&!t?.isDataDriven){const e=o.getPaintValue("fill-color",i);y=o.getPaintValue("fill-opacity",i)*e[3],y>=1&&(p=!1)}}if(p&&"opaque"===n)return;const g=o.getPaintValue("fill-translate",i),m=o.getPaintValue("fill-translate-anchor",i);(p||"translucent"!==n)&&this._drawFill(e,l,o,t,g,m,u,c,f);const v=!o.hasDataDrivenOutlineColor&&o.outlineUsesFillColor&&y<1;d&&"opaque"!==n&&!v&&this._drawOutline(e,l,o,t,g,m)}_drawFill(e,n,r,o,s,u,f,c,d){if(f&&!d&&null==c)return;const{context:p,displayLevel:y,state:g,painter:m,pixelRatio:v,spriteMosaic:M,requestRender:T,allowDelayedRender:P}=e,_=r.fillMaterial,E=m.vectorTilesMaterialManager,U=v>i.vtlHighResCutoff?2:1,x=this._fillProgramOptions;x.pattern=f;const S=E.getMaterialProgram(p,_,x);if(P&&null!=T&&!S.compiled)return void T();if(p.useProgram(S),null!=c){const{page:e}=c,t=M.getPageSize(e);null!=t&&(M.bind(p,a.TextureSamplingMode.LINEAR,e,i.vtlTextureBindingUnitSprites),S.setUniform2fv("u_mosaicSize",t),S.setUniform1i("u_texture",i.vtlTextureBindingUnitSprites))}S.setUniformMatrix3fv("u_displayMat3",u===t.TranslateAnchor.VIEWPORT?g.displayMat3:g.displayViewMat3),S.setUniform2fv("u_fillTranslation",s),S.setUniform1f("u_depth",r.z+l);let D=-1;for(const t of o){if(!t.layerData.has(n))continue;t.key.level!==D&&(D=t.key.level,_.setDataUniforms(S,y,r,D,M));const e=t.layerData.get(n);if(!e.fillIndexCount)continue;e.prepareForRendering(p);const l=e.fillVAO;if(null!=l){if(p.bindVAO(l),S.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),p.setStencilFunction(a.CompareFunction.EQUAL,t.stencilRef,255),f){const e=Math.max(2**(Math.round(y)-t.key.level),1),i=t.rangeX/(U*t.width*e);S.setUniform1f("u_patternFactor",i)}if(d){const t=e.patternMap;if(!t)continue;for(const[e,n]of t){const t=M.getPageSize(e);null!=t&&(M.bind(p,a.TextureSamplingMode.LINEAR,e,i.vtlTextureBindingUnitSprites),S.setUniform2fv("u_mosaicSize",t),S.setUniform1i("u_texture",i.vtlTextureBindingUnitSprites),p.drawElements(a.PrimitiveType.TRIANGLES,n[1],a.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n[0]))}}else p.drawElements(a.PrimitiveType.TRIANGLES,e.fillIndexCount,a.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e.fillIndexStart);t.triangleCount+=e.fillIndexCount/3}}}_drawOutline(e,i,n,r,o,s){const{context:u,displayLevel:f,state:c,painter:d,pixelRatio:p,spriteMosaic:y,requestRender:g,allowDelayedRender:m}=e,v=n.outlineMaterial,M=d.vectorTilesMaterialManager,T=.75/p,P=this._outlineProgramOptions,_=M.getMaterialProgram(u,v,P);if(m&&null!=g&&!_.compiled)return void g();u.useProgram(_),_.setUniformMatrix3fv("u_displayMat3",s===t.TranslateAnchor.VIEWPORT?c.displayMat3:c.displayViewMat3),_.setUniform2fv("u_fillTranslation",o),_.setUniform1f("u_depth",n.z+l),_.setUniform1f("u_outline_width",T);let E=-1;for(const t of r){if(!t.layerData.has(i))continue;t.key.level!==E&&(E=t.key.level,v.setDataUniforms(_,f,n,E,y));const e=t.layerData.get(i);if(e.prepareForRendering(u),!e.outlineIndexCount)continue;const l=e.outlineVAO;null!=l&&(u.bindVAO(l),_.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),u.setStencilFunction(a.CompareFunction.EQUAL,t.stencilRef,255),u.drawElements(a.PrimitiveType.TRIANGLES,e.outlineIndexCount,a.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e.outlineIndexStart),t.triangleCount+=e.outlineIndexCount/3)}}}e.WGLBrushVTLFill=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
