/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f32","../../../../core/libs/gl-matrix-2/factories/vec2f32","../../../../layers/support/rasterFunctions/vectorFieldUtils","../DisplayObject","../webgl/Utils","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexArrayObject"],(function(e,t,a,s,r,i,o,l,c,n,h){"use strict";class u extends o.DisplayObject{constructor(e=null){super(),this._source=null,this._symbolizerParameters=null,this._vaoInvalidated=!0,this.coordScale=[1,1],this.height=null,this.key=null,this.offset=null,this.stencilRef=0,this.resolution=null,this.pixelRatio=1,this.x=0,this.y=0,this.rotation=0,this.rawPixelData=null,this.vaoData=null,this.width=null,this.source=e}destroy(){null!=this.vaoData&&(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null)}get symbolizerParameters(){return this._symbolizerParameters}set symbolizerParameters(e){JSON.stringify(this._symbolizerParameters)!==JSON.stringify(e)&&(this._symbolizerParameters=e,this.invalidateVAO())}get source(){return this._source}set source(e){this._source=e,this.invalidateVAO()}invalidateVAO(){this._vaoInvalidated||null==this.vaoData||(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null,this._vaoInvalidated=!0,this.requestRender())}updateVectorFieldVAO(e){if(this._vaoInvalidated){if(this._vaoInvalidated=!1,null!=this.source&&null==this.vaoData){const{style:t}=this.symbolizerParameters;switch(t){case"beaufort_ft":case"beaufort_km":case"beaufort_kn":case"beaufort_m":case"beaufort_mi":case"classified_arrow":case"ocean_current_kn":case"ocean_current_m":case"single_arrow":{const t=i.createVFMesh(this.source,this.symbolizerParameters),a=this._createVectorFieldVAO(e.context,t);this.vaoData={magdir:a}}break;case"simple_scalar":{const t=i.createVFMeshScalar(this.source,this.symbolizerParameters),a=this._createVectorFieldVAO(e.context,t);this.vaoData={scalar:a}}break;case"wind_speed":{const t=i.createVFMesh(this.source,this.symbolizerParameters),a=this._createVectorFieldVAO(e.context,t),s=i.createVFMeshScalar(this.source,this.symbolizerParameters),r=this._createVectorFieldVAO(e.context,s);this.vaoData={magdir:a,scalar:r}}}}this.ready(),this.requestRender()}}_createTransforms(){return{displayViewScreenMat3:s.create()}}setTransform(e){const t=a.identity(this.transforms.displayViewScreenMat3),[s,i]=e.toScreenNoRotation([0,0],[this.x,this.y]),o=this.resolution/this.pixelRatio/e.resolution,l=o*this.width,c=o*this.height,n=Math.PI*this.rotation/180;a.translate(t,t,r.fromValues(s,i)),a.translate(t,t,r.fromValues(l/2,c/2)),a.rotate(t,t,-n),a.translate(t,t,r.fromValues(-l/2,-c/2)),a.scaleByVec2(t,t,r.fromValues(l,c)),a.multiply(this.transforms.displayViewScreenMat3,e.displayViewMat3,t)}onAttach(){this.invalidateVAO()}onDetach(){this.invalidateVAO()}_createVectorFieldVAO(e,t){const{vertexData:a,indexData:s}=t,r=c.BufferObject.createVertex(e,n.Usage.STATIC_DRAW,new Float32Array(a)),i=c.BufferObject.createIndex(e,n.Usage.STATIC_DRAW,new Uint32Array(s)),o=l.createProgramDescriptor("vector-field",{geometry:[{location:0,name:"a_pos",count:2,type:n.DataType.FLOAT,normalized:!1},{location:1,name:"a_offset",count:2,type:n.DataType.FLOAT,normalized:!1},{location:2,name:"a_vv",count:2,type:n.DataType.FLOAT,normalized:!1}]});return{vao:new h.VertexArrayObject(e,o.attributes,o.bufferLayouts,{geometry:r},i),elementCount:s.length}}}e.RasterVFDisplayObject=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
