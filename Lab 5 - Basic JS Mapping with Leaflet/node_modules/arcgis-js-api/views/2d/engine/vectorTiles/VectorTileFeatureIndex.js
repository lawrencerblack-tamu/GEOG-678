/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../../../Graphic","../../../../core/MapUtils","../../../../core/pbf","../../../../core/libs/rbush/PooledRBush","./enums","./Feature","./GeometryUtils","./SourceLayerData","./style/StyleLayer"],(function(e,t,s,r,l,i,n,o,a){"use strict";const y=8,c=512,u=4096,h=(e,t)=>{const s=e.vtlSymbol.sourceTile,r=t.vtlSymbol.sourceTile;return s.level!==r.level?s.level-r.level:s.row!==r.row?s.row-r.row:s.col!==r.col?s.col-r.col:e.styleLayerUID-t.styleLayerUID};class d{constructor(e,t,s,r,l){this.tileKey=e,this._index=null,this._styleRepository=null,this._tileHandler=null,this._tileKeyToPBF=new Map,this._tileLayerData=t,this._styleRepository=s,this._tileHandler=r,this._parentLayer=l}static create(e,t,s,r,l){return new d(e,t,s,r,l)}clear(){this._index?.clear(),this._tileKeyToPBF.clear()}async queryAttributes(e,t,s,l,i){if(0===this._tileLayerData.size||!this._styleRepository||!this._tileHandler)return[];null===this._index&&(this._index=new r.PooledRBush(100,_),await this._indexLayers());const n=[];return this._queryIndex(n,e,t,s,this.tileKey.level,l),i&&i?.length>0&&await this._getSymbolsAttributes(n,i),n}async _indexLayers(){const e=this.tileKey,t=this._styleRepository.layers,s=await this._getTilePayload(e);for(const[r,i]of this._tileLayerData){const n=t[r],o=s.find((e=>e.sourceName===n.source));if(!o)continue;const{protobuff:a,key:y}=o;if(i.type!==l.BucketType.SYMBOL){const t=1<<e.level-y.level,s=e.row-y.row*t,r=e.col-y.col*t;this._indexLayer(n,a,e.level,t,s,r)}}}_indexLayer(e,t,r,l,y,h){const d=e.sourceLayer,_=e.getFeatureFilter(),f=r,g=r+1,m=n.getTileMargins(f),w=new s(new Uint8Array(t),new DataView(t));for(;w.next();)switch(w.tag()){case 3:{const t=w.getMessage(),s=new o(t);if(t.release(),s.name!==d)continue;const n=s.getData(),x=s.extent/l,b=x*h-m,p=x*y-m,I=b+x+2*m,L=p+x+2*m,v=x/c,T=u/x,D=x*h,P=x*y;for(;n.nextTag(2);){const t=n.getMessage(),l=new i(t,s);if(t.release(),_&&!_.filter(l,r))continue;const o=l.values||{},y=o._minzoom,c=o._maxzoom;if(y&&y>=10*g||c&&c<=10*f)continue;const u=e.getFeatureInflatedBounds(l,f,s.extent,v);null==u||u[0]>I||u[1]>L||u[2]<b||u[3]<p||(u[0]=(u[0]-D)*T,u[1]=(u[1]-P)*T,u[2]=(u[2]-D)*T,u[3]=(u[3]-P)*T,this._index.insert(new a.IndexItem(e,l,u,T,D,P)))}break}default:w.skip()}}async _getSymbolsAttributes(e,t){if(!t||0===t.length)return e;const s=[];t.sort(h);let r=t[0].styleLayerUID,l=0;for(let a=0;a<t.length;a++)r!==t[a].styleLayerUID&&(s.push({from:l,to:a,styleLayerUID:r,sourceTileKey:t[a].vtlSymbol.sourceTile}),l=a,r=t[a].styleLayerUID);s.push({from:l,to:t.length,styleLayerUID:r,sourceTileKey:t[t.length-1].vtlSymbol.sourceTile});const i=this._styleRepository.layers;let n,o=null;for(const a of s){const s=await this._getTilePayload(a.sourceTileKey);n=i[a.styleLayerUID],o=!!n&&s.find((e=>e.sourceName===n.source)),o&&this._addSymbolsAttributes(e,t.slice(a.from,a.to).map((e=>e.vtlSymbol)),r,o)}return e}_addSymbolsAttributes(t,s,r,l){const i=this._styleRepository.layers,n=l.key,o=this.tileKey,a=1<<o.level-n.level,y=o.row-n.row*a,c=o.col-n.col*a;this._getSymbolAttributes(l.protobuff,s,r,a,y,c).forEach((s=>{const{attributes:l,tilePoint:n}=s;t.push({layerId:i[r].id,layerIndex:r,graphic:new e({attributes:l,origin:{type:"vector-tile",layerId:i[r].id,layerIndex:r,layer:this._parentLayer}}),tilePoint:n})}))}_getSymbolAttributes(e,t,r,l,n,a){const y=[],c=this._styleRepository.layers;let h=0;t.sort(((e,t)=>e.featureIndex-t.featureIndex));const d=new s(new Uint8Array(e),new DataView(e));for(;d.next();)switch(d.tag()){case 3:{const e=d.getMessage(),s=new o(e);if(e.release(),s.name!==c[r].sourceLayer)continue;const _=s.getData(),f=s.extent/l,g=u/f,m=f*a,w=f*n;let x=0;for(;_.nextTag(2);){const e=_.getMessage();if(x++===t[h].featureIndex){const t=new i(e,s),r=t.values,l=t.getGeometry(),n=null!=l?[g*(l[0][0].x-m),g*(l[0][0].y-w)]:null;y.push({attributes:r,tilePoint:n}),h++}if(e.release(),h===t.length)return y}break}default:d.skip()}return y}_queryIndex(t,s,r,l,i,n){const o=y*l*(window.devicePixelRatio||1);return this._index?.search({minX:s-o,minY:r-o,maxX:s+o,maxY:r+o},(o=>{const{layer:a,feature:y}=o;a.isIntersectingFeature(s,r,l,y,i,n,o)&&t.push({layerId:a.id,layerIndex:a.uid,tilePoint:null,graphic:new e({attributes:y.values,origin:{type:"vector-tile",layerId:o.layer.id,layerIndex:o.layer.uid,layer:this._parentLayer}})})})),t}async _getTilePayload(e){return t.getOrCreateMapValue(this._tileKeyToPBF,e.id,(()=>this._tileHandler.fetchTilePBFs(e))).then((e=>e))}}const _=e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]});return d}));
