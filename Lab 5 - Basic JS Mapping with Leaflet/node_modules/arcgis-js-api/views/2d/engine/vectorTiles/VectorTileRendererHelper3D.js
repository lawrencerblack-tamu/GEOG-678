/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../geometry","../../../../Viewpoint","../../tiling/TileInfoView","../../tiling/TileKey","../../tiling/TileQueue","../../tiling/TileStrategy","../../ViewState","./style/StyleDefinition","../webgl/RenderableTile","../webgl/TileReshuffleManager","../../../webgl/enums","../../../../geometry/Point"],(function(e,t,n,i,l,s,r,a,o,c,d,u,p){"use strict";const y=.125;class h{constructor(){this._renderParams={reshuffleManager:new d.TileReshuffleManager,context:null,drawPhase:1,state:new a({viewpoint:new n({targetGeometry:new p(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new c.RenderableTile(new l(0,0,0,0),0,0,0,512,512,4096,4096)}dispose(){this._renderParams=null}renderBackground(e,t,n,i,l,s,r,a,o,c){const d=this._backgroundTile;this._updateRenderParameters(e,t,d,n,l,s,r,a,o,c),this._renderParams.stencilSymbols=!1,n.drawBackground(this._renderParams,d,i)}renderContent(e,t,n,i,l,s,r,a,o,c,d,p){this._stencilSymbols(e,t,n,i,l,s,r,Math.round(1/a),o,c,d,p);let y=1;n.stencilRef=y++,e.setStencilFunction(u.CompareFunction.EQUAL,n.stencilRef,255),this._render(e,t,n,l,s,r,a,o,c,d,p),i.forAll((t=>{t.sourceLayerInfo.data.stencilRef=y++,this._renderSymbols(e,t.sourceLod,t.sourceLayerInfo.data,l,s,r,Math.round(1/a),t.offset,c,d,p)}))}_stencilSymbols(e,t,n,i,l,s,r,a,o,c,d,p){let y=1;n.stencilRef=y++,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(u.StencilOperation.KEEP,u.StencilOperation.KEEP,u.StencilOperation.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(u.CompareFunction.ALWAYS,n.stencilRef,255),this._stencilTileSymbols(e,t,n,l,s,r,a,o,c,d,p);for(const h of i.toArray()){const{sourceLod:t,offset:n,sourceLayerInfo:i}=h;i.data.stencilRef=y++,e.setStencilFunction(u.CompareFunction.ALWAYS,i.data.stencilRef,255),this._stencilTileSymbols(e,t,i.data,l,s,r,a,n,c,d,p)}e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,n,i,l,s,r,a,c,d,p){e.setStencilFunction(u.CompareFunction.EQUAL,n.stencilRef,255),this._render(e,t,n,i,l,s,r,a,c,d,p,o.StyleLayerType.SYMBOL)}_render(e,t,n,i,l,s,r,a,o,c,d,u){this._updateRenderParameters(e,t,n,i,s,r,a,o,c,d),this._renderParams.stencilSymbols=!1,i.drawTile(this._renderParams,n,l,u)}_stencilTileSymbols(e,t,n,i,l,s,r,a,o,c,d){this._updateRenderParameters(e,t,n,i,s,r,a,o,c,d),this._renderParams.stencilSymbols=!0,n.triangleCount=0,i.drawSymbols(this._renderParams,n,l)}_updateRenderParameters(e,t,n,i,l,s,r,a,o,c){"type"in n&&"vector-tile"===n.type&&!n.stage&&n.attachWithContext(e);const d=t[0]-l.getLevelShift(t[0]),u=this._renderParams;u.context=e,u.painter=i,u.glyphMosaic=i.glyphMosaic,u.spriteMosaic=i.spriteMosaic,u.pixelRatio=o*c,u.displayLevel=d,u.requiredLevel=d;const p=l.getScale(t[0]),[h,m]=l.getOffset(t,s*p),g=y*s*p/a,f=n.transforms.displayViewScreenMat3;f[0]=g,f[4]=-g,f[6]=-1-h-r[0]*s*2,f[7]=1+m+(1-r[1])*s*2-2,u.state.size[0]=a/c,u.state.size[1]=a/c,u.state.pixelRatio=c}}e.VectorTileRendererHelper3D=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
