/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../Viewpoint","../../core/Collection","../../core/mathUtils","../../core/unitUtils","../../core/libs/gl-matrix-2/math/common","../../core/libs/gl-matrix-2/math/mat2d","../../core/libs/gl-matrix-2/factories/mat2df64","../../core/libs/gl-matrix-2/math/vec2","../../core/libs/gl-matrix-2/factories/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/projection","../../geometry/SpatialReference","../../geometry/support/normalizeUtils","../../geometry/support/spatialReferenceUtils"],(function(e,t,n,r,a,o,i,c,s,l,u,f,y,m,g,p,d){"use strict";const x=96,h=39.37,b=180/Math.PI;function w(e){return e.wkid?e:e.spatialReference||g.WGS84}function R(e,t){return t.type?s.set(e,t.x,t.y):s.copy(e,t)}function G(e){return a.getMetersPerUnitForSR(e)}function S(e,t,n=0){let a=e.width,o=e.height;if(0!==n){const t=r.deg2rad(n),i=Math.abs(Math.cos(t)),c=Math.abs(Math.sin(t));a=e.width*i+e.height*c,o=e.width*c+e.height*i}const i=Math.max(1,t[0]),c=Math.max(1,t[1]);return Math.max(a/i,o/c)*B(e.spatialReference)}async function A(e,t,r,a){let o,i;if(!e)return null;if(Array.isArray(e)&&!e.length)return null;if(n.isCollection(e)&&(e=e.toArray()),Array.isArray(e)&&e.length&&"object"==typeof e[0]){const n=e.every((e=>"attributes"in e)),o=e.some((e=>!e.geometry));let i=e;if(n&&o&&t&&t.allLayerViews){const n=new Map;for(const t of e){const e=t.layer,r=n.get(e)||[],a=t.attributes[e.objectIdField];null!=a&&r.push(a),n.set(e,r)}const r=[];n.forEach(((e,n)=>{const a=t.allLayerViews.find((e=>e.layer.id===n.id));if(a&&"queryFeatures"in a){const t=n.createQuery();t.objectIds=e,t.returnGeometry=!0,r.push(a.queryFeatures(t))}}));const a=await Promise.all(r),o=[];for(const e of a)if(e&&e.features&&e.features.length)for(const t of e.features)null!=t.geometry&&o.push(t.geometry);i=o}for(const e of i)a=await A(e,t,r,a);return a}if(Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])o=new y(e);else if(e instanceof f)o=e;else if("geometry"in e)if(e.geometry)o=e.geometry;else if(e.layer){const n=e.layer,r=t.allLayerViews.find((e=>e.layer.id===n.id));if(r&&"queryFeatures"in r){const t=n.createQuery();t.objectIds=[e.attributes[n.objectIdField]],t.returnGeometry=!0;const a=await r.queryFeatures(t);o=a?.features?.[0]?.geometry}}if(null==o)return null;switch(o.type){case"point":i=new u({xmin:o.x,ymin:o.y,xmax:o.x,ymax:o.y,spatialReference:o.spatialReference});break;case"extent":case"multipoint":case"polygon":case"polyline":i=p.getDenormalizedExtent(o);break;default:i=o.extent}if(!i)return null;m.isLoaded()||m.canProjectWithoutEngine(i.spatialReference,r)||await m.load();const c=m.project(i,r);return c?a=a?a.union(c):c:null}function M(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&null!=e.layer?.minScale&&null!=e.layer.maxScale){const t=e.layer;return{min:t.minScale,max:t.maxScale}}if(Array.isArray(e)&&e.length&&e.every((e=>"layer"in e))){let t=0,n=0;for(const r of e){const e=r.layer;e?.minScale&&e.maxScale&&(t=e.minScale<t?e.minScale:t,n=e.maxScale>n?e.maxScale:n)}return t&&n?{min:t,max:n}:null}}}function j(e,t){return d.equals(w(e),t)?e:m.project(e,t)}async function T(e,n){if(!e||!n)return new t({targetGeometry:new y,scale:0,rotation:0});let r=n.spatialReference;const{constraints:a,padding:o,viewpoint:i,size:c}=n,s=[o?c[0]-o.left-o.right:c[0],o?c[1]-o.top-o.bottom:c[1]];let l=null;e instanceof t?l=e:e.viewpoint?l=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(l=e.target);let f=null;l?.targetGeometry?f=l.targetGeometry:e instanceof u?f=e:(e||e&&("center"in e||"extent"in e||"target"in e))&&(f=await A(e.center,n,r)||await A(e.extent,n,r)||await A(e.target,n,r)||await A(e,n,r)),!f&&i?.targetGeometry?f=i.targetGeometry:!f&&n.extent&&(f=n.extent),r||(r=w(n.spatialReference||n.extent||f)),m.isLoaded()||d.equals(f.spatialReference,r)||m.canProjectWithoutEngine(f.spatialReference,r)||await m.load();const g=j(f,r),x="center"in g?g.center:g;!1!==n.pickClosestTarget&&"point"===x.type&&"point"===i.targetGeometry?.type&&(x.x=p.getClosestDenormalizedXToReference(x.x,i.targetGeometry.x,x.spatialReference));let h=0;l?h=l.rotation:e.hasOwnProperty("rotation")?h=e.rotation:i&&(h=i.rotation);let b=0;if(null!=l?.targetGeometry&&"point"===l.targetGeometry.type)b=l.scale;else if("scale"in e&&e.scale)b=e.scale;else if("zoom"in e&&-1!==e.zoom&&a&&a.effectiveLODs)b=a.zoomToScale(e.zoom);else if(Array.isArray(f)||"point"===f.type||"extent"===f.type&&0===f.width&&0===f.height){const e=j(n.extent,r);b=null!=e?S(e,s,h):n.extent?S(n.extent,s,h):i.scale}else b=S(j(f.extent,r),s,h);const R=M(e.target??e);R&&(R.min&&R.min<b?b=R.min:R.max&&R.max>b&&(b=R.max));let G=new t({targetGeometry:x,scale:b,rotation:h});return a&&(G=a.fit(G),a.constrainByGeometry(G),a.rotationEnabled||(G.rotation=i.rotation)),G}function k(e,t){const n=e.targetGeometry,r=t.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function v(e,t,n){return n?s.set(e,.5*(t[0]-n.right+n.left),.5*(t[1]-n.bottom+n.top)):s.scale(e,t,.5)}const z=function(){const e=l.create();return function(t,n,r){const a=n.targetGeometry;R(e,a);const o=.5*N(n);return t.xmin=e[0]-o*r[0],t.ymin=e[1]-o*r[1],t.xmax=e[0]+o*r[0],t.ymax=e[1]+o*r[1],t.spatialReference=a.spatialReference,t}}();function P(e,t,n,r,a){return H(e,t,n.center),e.scale=S(n,r),a?.constraints?.constrain(e),e}function E(e,t,n,r){return C(e,t,n,r),i.invert(e,e)}const F=function(){const e=l.create();return function(t,n,r){return s.sub(t,I(t,n),v(e,n,r))}}(),V=function(){const e=c.create(),t=l.create();return function(n,r,a,o){const c=N(r),l=q(r);return s.set(t,c,c),i.fromScaling(e,t),i.rotate(e,e,l),i.translate(e,e,F(t,a,o)),i.translate(e,e,[0,o.top-o.bottom]),s.set(n,e[4],e[5])}}();function N(e){return e.scale*W(e.targetGeometry)}function W(e){return null!=e&&d.isValid(e.spatialReference)?1/(G(e.spatialReference)*h*x):1}function q(e){return o.toRadian(e.rotation)||0}function B(e){return d.isValid(e)?G(e)*h*x:1}function I(e,t){return s.scale(e,t,.5)}const L=function(){const e=l.create(),t=l.create(),n=l.create();return function(r,a,o,c,l,u){return s.negate(e,a),s.scale(t,o,.5*u),s.set(n,1/c*u,-1/c*u),i.fromTranslation(r,t),l&&i.rotate(r,r,l),i.scale(r,r,n),i.translate(r,r,e),r}}(),C=function(){const e=l.create();return function(t,n,r,a){const o=N(n),i=q(n);return R(e,n.targetGeometry),L(t,e,r,o,i,a)}}(),U=function(){const e=l.create();return function(t,n,r,a){const o=N(n);return R(e,n.targetGeometry),L(t,e,r,o,0,a)}}();function D(e){const t=d.getInfo(e);return t?t.valid[1]-t.valid[0]:0}function O(e,t){return Math.round(D(e)/t)}const Q=function(){const e=l.create(),t=l.create(),n=[0,0,0];return function(r,a,o){s.subtract(e,r,a),s.normalize(e,e),s.subtract(t,r,o),s.normalize(t,t),s.cross(n,e,t);let i=Math.acos(s.dot(e,t)/(s.length(e)*s.length(t)))*b;return n[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),X=function(){const e=l.create();return function(t,n,r,a){const o=t.targetGeometry;return k(t,n),V(e,n,r,a),o.x+=e[0],o.y+=e[1],t}}(),H=function(e,t,n){k(e,t);const r=e.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e},J=function(){const e=l.create();return function(t,n,r,a,o){o||(o="center"),s.sub(e,r,a),s.scale(e,e,.5);const i=e[0],c=e[1];switch(o){case"center":s.set(e,0,0);break;case"left":s.set(e,-i,0);break;case"top":s.set(e,0,c);break;case"right":s.set(e,i,0);break;case"bottom":s.set(e,0,-c);break;case"top-left":s.set(e,-i,c);break;case"bottom-left":s.set(e,-i,-c);break;case"top-right":s.set(e,i,c);break;case"bottom-right":s.set(e,i,-c)}return re(t,n,e),t}}();function K(e,t,n){return k(e,t),e.rotation+=n,e}function Y(e,t,n){return k(e,t),e.rotation=n,e}const Z=function(){const e=l.create();return function(t,n,r,a,o){return k(t,n),isNaN(r)||0===r||(te(e,a,n,o),t.scale=n.scale*r,ne(e,e,t,o),re(t,t,s.set(e,e[0]-a[0],a[1]-e[1]))),t}}();function $(e,t,n){return k(e,t),e.scale=n,e}const _=function(){const e=l.create();return function(t,n,r,a,o,i){return k(t,n),isNaN(r)||0===r||(te(e,o,n,i),t.scale=n.scale*r,t.rotation+=a,ne(e,e,t,i),re(t,t,s.set(e,e[0]-o[0],o[1]-e[1]))),t}}(),ee=function(){const e=l.create(),t=l.create();return function(n,r,a,o,i,c,l){return F(t,c,l),s.add(e,i,t),o?_(n,r,a,o,e,c):Z(n,r,a,e,c)}}(),te=function(){const e=c.create();return function(t,n,r,a){return s.transformMat2d(t,n,E(e,r,a,1))}}(),ne=function(){const e=c.create();return function(t,n,r,a){return s.transformMat2d(t,n,C(e,r,a,1))}}(),re=function(){const e=l.create(),t=c.create();return function(n,r,a){k(n,r);const o=N(r),c=n.targetGeometry;return i.fromRotation(t,q(r)),i.scale(t,t,l.fromValues(o,o)),s.transformMat2d(e,a,t),c.x+=e[0],c.y+=e[1],n}}();e.addPadding=X,e.angleBetween=Q,e.centerAt=H,e.copy=k,e.create=T,e.extentToScale=S,e.getAnchor=v,e.getExtent=z,e.getMatrix=L,e.getPaddingMapTranslation=V,e.getPaddingScreenTranslation=F,e.getResolution=N,e.getResolutionToScaleFactor=B,e.getTransform=C,e.getTransformNoRotation=U,e.getWorldScreenWidth=O,e.getWorldWidth=D,e.padAndScaleAndRotateBy=ee,e.resize=J,e.rotateBy=K,e.rotateTo=Y,e.scaleAndRotateBy=_,e.scaleTo=$,e.setExtent=P,e.toMap=te,e.toScreen=ne,e.translateBy=re,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
