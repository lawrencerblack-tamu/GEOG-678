/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/screenUtils","../../../../../../layers/support/OrderByInfo","./LabelMatcherSchema","./MatcherSchema","./StorageSchema","./VisualVariablesSchema"],(function(e,r,t,a,i,s,n){"use strict";async function l(e,r){const t=r.renderer,s=n.createVisualVariableUniforms(t);return{symbology:await i.createMatcherSchema(e,t),labels:await a.createLabelMatcherSchema(e,r,s)}}async function c(e,r,t,a){const i=t.featureReduction;if(i)switch(i.type){case"binning":return f(i,e,r,t,a);case"cluster":return d(i,e,r,t,a)}const n=y(t.orderBy,t.renderer,t.objectIdField);return{storage:s.createStorageSchema(t.renderer,r.filters),mesh:{displayRefreshVersion:a,strategy:{type:"feature"},factory:await l(e,t),sortKey:n,timeZone:r.timeZone}}}function o(e,r){return e.fields.map((e=>({...e.toJSON(),type:u(e,r)})))}function u(e,r){const{onStatisticExpression:t,onStatisticField:a,statisticType:i}=e;switch(i){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(t){const{returnType:e}=t;return e?"string"===e?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const e=r.find((e=>e.name===a));return e?e.type:"esriFieldTypeString"}}}async function f(e,r,t,l,c){const u=o(e,l.fields),f=e.renderer,d=await i.createMatcherSchema(r,f),y=s.createStorageSchema(f,[null,null]),m=n.createVisualVariableUniforms(f),g=await a.createLabelMatcherSchema(r,{geometryType:"polygon",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},m);return{storage:y,mesh:{displayRefreshVersion:c,strategy:{type:"binning",fields:u,fixedBinLevel:e.fixedBinLevel,featureFilter:t.filters[0]},factory:{labels:g,symbology:d},sortKey:null,timeZone:t.timeZone}}}async function d(e,t,l,c,u){const f=o(e,c.fields),d={type:"cluster",feature:await i.createMatcherSchema(t,e.effectiveFeatureRenderer),cluster:await i.createMatcherSchema(t,e.effectiveClusterRenderer)},y=n.createVisualVariableUniforms(e.effectiveFeatureRenderer),m={type:"cluster",feature:await a.createLabelMatcherSchema(t,c,y),cluster:await a.createLabelMatcherSchema(t,{geometryType:"point",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},y)};return{storage:s.createStorageSchema(e.effectiveFeatureRenderer,[null,null]),mesh:{displayRefreshVersion:u,strategy:{type:"cluster",fields:f,featureFilter:l.filters[0],clusterRadius:r.pt2px(e.clusterRadius/2)},factory:{labels:m,symbology:d},sortKey:null,timeZone:l.timeZone}}}function y(e,r,a){const i=null!=r&&"unique-value"===r.type&&r.orderByClassesEnabled;if("default"!==e||i||(e=[new t({field:a,order:"descending"})]),"default"!==e&&e.length){e.length;const r=e[0],t="ascending"===r.order?"asc":"desc";return r.field?{field:r.field,order:t}:r.valueExpression?{expression:r.valueExpression,order:t}:null}if(i){return{byRenderer:!0,order:"asc"}}return null}e.createSimpleProcessorSchema=c,e.getAggregateFields=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
