/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/screenUtils","../../../../../../core/unitUtils","../../../../../../renderers/support/lengthUtils","../../../../engine/webgl/definitions","../../../../engine/webgl/shaderGraph/techniques/shaders/constants","./schemaUtils","../../support/rendererUtils"],(function(e,a,i,l,s,t,r,n){"use strict";const u=1.25,o=128,p=128;function c(e){if(!e.stops?.length)return null;const a=e.stops.sort(((e,a)=>e.value-a.value)),i=r.padStops(a,8),l=i.map((({value:e})=>e)),s=i.map((({color:e})=>r.premultiplyColor(e)));return{values:l,colors:s}}function V(e){if(!e.stops?.length)return null;const a=e.stops.sort(((e,a)=>e.value-a.value)),i=r.padStops(a,8);return{opacityValues:i.map((({value:e})=>e)),opacities:i.map((({opacity:e})=>e))}}function v(e){return{rotationType:"geographic"===e.rotationType?t.RotationType.Geographic:t.RotationType.Arithmatic}}function S(e){if(!e.stops?.length)return null;if(e.stops.some((e=>e.useMaxValue||e.useMinValue)))return(i,l)=>{const t=i.statisticsByLevel.get(l.key.level),n=e.stops.map((i=>({value:i.useMaxValue?t?.get(e.field)?.maxValue??0:i.useMinValue?t?.get(e.field)?.minValue??0:i.value,size:i.size?a.pt2px(i.size):s.nanMagicNumber}))).sort(((e,a)=>e.value-a.value)),u=r.padStops(n,8);return{values:u.map((({value:e})=>e)),sizes:u.map((({size:e})=>e))}};const i=e.stops.sort(((e,a)=>e.value-a.value)),l=r.padStops(i,8);return{values:l.map((({value:e})=>e)),sizes:l.map((({size:e})=>a.pt2px(e)))}}function b(e){if(!e.stops?.length)return null;const i=e.stops.sort(((e,a)=>e.value-a.value)),l=r.padStops(i,8);return{values:l.map((({value:e})=>e)),sizes:l.map((({size:e})=>a.pt2px(e)))}}function f(e){return a=>{const{state:s}=a;return{unitValueToPixelsRatio:i.getMetersPerUnitForSR(s.spatialReference)/l.meterIn[e.valueUnit]/s.resolution}}}function z(e,a){const i=a.length;if(e<a[0].value||1===i)return a[0].size;for(let l=1;l<i;l++)if(e<a[l].value){const i=(e-a[l-1].value)/(a[l].value-a[l-1].value);return a[l-1].size+i*(a[l].size-a[l-1].size)}return a[i-1].size}function x(e){const{minDataValue:i,maxDataValue:l,minSize:s,maxSize:t}=e;if("object"==typeof s&&"object"==typeof t)return(e,r)=>{const n=e.state.scale,u=a.pt2px(z(n,s.stops)),o=a.pt2px(z(n,t.stops));return{minMaxValueAndSize:[i,l,u,o]}};if("object"==typeof s||"object"==typeof t)throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[i,l,a.pt2px(s),a.pt2px(t)]}}const m={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function y(e,a=p,i=u){if(e.visualVariableSizeMinMaxValue)return e.visualVariableSizeMinMaxValue instanceof Function?o:Math.max(e.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*i,a);if(e.visualVariableSizeScaleStops){if(e.visualVariableSizeScaleStops instanceof Function)return o;const l=e.visualVariableSizeScaleStops.sizes;return Math.max(l[l.length-1]*i,a)}if(e.visualVariableSizeStops){if(e.visualVariableSizeStops instanceof Function)return o;const l=e.visualVariableSizeStops.sizes;return Math.max(l[l.length-1]*i,a)}return e.visualVariableSizeUnitValue?2*o:0}function M(e){const a={...m};if(!e||!("visualVariables"in e)||!e.visualVariables)return a;for(const i of n.simplifyVisualVariables(e.visualVariables))switch(i.type){case"color":a.visualVariableColor=c(i);break;case"opacity":a.visualVariableOpacity=V(i);break;case"rotation":a.visualVariableRotation=v(i);break;case"size":switch(d(i)){case"field-stops":a.visualVariableSizeStops=S(i);break;case"scale-stops":"outline"===i.target?a.visualVariableSizeOutlineScaleStops=S(i):a.visualVariableSizeScaleStops=S(i);break;case"min-max":a.visualVariableSizeMinMaxValue=x(i);break;case"unit-value":a.visualVariableSizeUnitValue=f(i)}break;default:console.error("Unable to handle VV type")}return a}function d(e){if("number"==typeof e.minDataValue&&"number"==typeof e.maxDataValue&&null!=e.minSize&&null!=e.maxSize)return"min-max";if((e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops))return"scale-stops";if((null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels))return"field-stops";if((null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit)return"unit-value";throw new Error("InternalError: Found unknown sizeVV type")}e.createVisualVariableColor=c,e.createVisualVariableOpacity=V,e.createVisualVariableRotation=v,e.createVisualVariableSizeMinMaxValue=x,e.createVisualVariableSizeScaleStops=b,e.createVisualVariableSizeStops=S,e.createVisualVariableSizeUnitValue=f,e.createVisualVariableUniforms=M,e.getMaxSizeVVSize=y,e.noVisualVariables=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
