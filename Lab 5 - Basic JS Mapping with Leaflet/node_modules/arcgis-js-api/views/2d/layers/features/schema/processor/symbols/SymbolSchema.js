/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../../../symbols","../../../../../../../core/screenUtils","../../../../../../../renderers/support/heatmapUtils","../../../../../../../symbols/cim/CIMSymbolHelper","../../../../../../../symbols/cim/enums","../../../../../../../symbols/cim/SDFHelper","../../../../../engine/webgl/alignmentUtils","../../../../../engine/webgl/color","../../../../../engine/webgl/definitions","../../../../../engine/webgl/shaderGraph/techniques/TechniqueRegistry","../schemaUtils","../VisualVariablesSchema","./ComplexSymbolSchema","./utils","../../../../../../../symbols/SimpleFillSymbol"],(function(e,a,i,l,t,r,o,s,n,u,c,p,m,S,b,f){"use strict";async function V(e,a){if(!e)return[];switch(e.type){case"simple-fill":return R(e,a);case"picture-fill":return w(e,a);case"simple-marker":return g(e,a);case"picture-marker":return d(e,a);case"simple-line":return L(e,a,!1);case"text":return M(e,a);case"label":return C(e,a);case"cim":return S.createComplexSymbolInstances(e.data,a);case"web-style":{const i=await e.fetchCIMSymbol();return S.createComplexSymbolInstances(i.data,a)}default:throw new Error(`symbol not supported ${e.type}`)}}async function y(e,a){const{schemaOptions:i}=a,{store:l}=i,t=new Array(u.dotDensityMaxFields),r=new Array(u.dotDensityMaxFields/4);for(let c=0;c<u.dotDensityMaxFields;c++){const a=c<e.attributes.length?e.attributes[c].color:null;t[c]=[0,0,0,0],n.writeColor(t[c],a)}for(let n=0;n<u.dotDensityMaxFields/4;n++)r[n]=[0,0,0,0],r[n][0]=4*n<e.attributes.length?1:0,r[n][1]=4*n+1<e.attributes.length?1:0,r[n][2]=4*n+2<e.attributes.length?1:0,r[n][3]=4*n+3<e.attributes.length?1:0;const o={isActive:r,colors:t,dotValue:e.dotValue,dotScale:e.referenceScale,blending:e.dotBlendingEnabled,dotSize:e.dotSize,seed:e.seed},s=l.ensureInstance(c.Techniques.dotDensity,o,{}).createMeshInfo({params:{effects:null}}),p=[];if(e.backgroundColor){const i=new f({color:e.backgroundColor,outline:null}),l=await V(i,a);p.push(...l)}if(p.push(s),e.outline){const i=L(e.outline,a,!0);p.push(...i)}return p}async function h(e,a){const{store:t}=a,{radius:r,minDensity:o,maxDensity:s,referenceScale:n,field:u,valueExpression:p,colorStops:m}=e,S=l.generateGradient(m);return[t.ensureInstance(c.Techniques.heatmap,{radius:i.pt2px(r),minDensity:o,maxDensity:s,referenceScale:n,isFieldActive:!(!u&&!p),gradient:S,gradientHash:S.join(",")},{}).createMeshInfo({params:{effects:null}})]}function v(e,a){const{store:l}=a,t=e.outline?.width||0,r=m.createVisualVariableUniforms(e),o=l.ensureInstance(c.Techniques.pieChart,{geometry:{outlineWidth:Math.round(i.pt2px(t)),defaultColor:p.premultiplyColor(e.defaultColor),outlineColor:p.premultiplyColor(e.outline?.color),othersColor:p.premultiplyColor(e.othersCategory?.color),donutRatio:e.holePercentage,sectorThreshold:e.othersCategory?.threshold||0,colors:e.attributes.map((e=>p.premultiplyColor(e.color))),visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue,hittestUniforms:null},numberOfFields:e.attributes.length},{}).createMeshInfo({params:{size:e.size,outlineWidth:t,effects:null,scaleInfo:null,minPixelBuffer:m.getMaxSizeVVSize(r)}});return[...e.backgroundFillSymbol?R(e.backgroundFillSymbol,{schemaOptions:a,path:"",uniforms:m.noVisualVariables}):[],o]}function z(e){if("path"===e.style){if(null==e.path)throw new Error("Symbol with a style of type path must define a path");return{type:"sprite-rasterization-param",overrides:[],resource:{type:"path",path:e.path,asFill:!0}}}const a=t.CIMSymbolHelper.fromSimpleMarker(e);if("outline"in e&&e.outline&&"none"!==e.outline.style){if("solid"!==e.outline.style){if(!a||!a.symbolLayers)throw new Error("Error handling marker! ");return{type:"sprite-rasterization-param",resource:a.symbolLayers[0],overrides:[]}}}return{type:"sprite-rasterization-param",resource:o.getSDFInfo(a),overrides:[]}}async function g(e,a){const{uniforms:i,schemaOptions:l}=a,{store:o}=l;if("path"===e.style||e.outline&&"solid"!==e.outline.style&&"none"!==e.outline.style){const l=t.CIMSymbolHelper.fromSimpleMarker(e);if(!l||!l.symbolLayers)throw new Error("Error handling marker! ");if(i.visualVariableRotation&&(l.angleAlignment="Map"),"path"!==e.style){const e=l.symbolLayers[0];if(b.hasSizeVVUniform(a.uniforms)){const i=m.getMaxSizeVVSize(a.uniforms,0,1);if(i>e.size){const a=i/e.size;e.size=i;const l=e.markerGraphics?.[0].symbol;(l.symbolLayers&&l.symbolLayers[0]).width*=a}}}return S.createComplexSymbolInstances({type:"CIMSymbolReference",symbol:l},a)}const s=o.ensureInstance(c.Techniques.marker,{geometry:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation}},{zoomRange:!1}),n=z(e);let u=e.color?.toArray()??[0,0,0,0];"CIMVectorMarker"===n.resource.type&&(u=[255,255,255,255]);const p="triangle"===e.style?124/116:1,f=e.size,V=f*p,y=null!=i.visualVariableColor&&("cross"===e.style||"x"===e.style);return[s.createMeshInfo({params:{type:"simple",color:u,height:f,width:V,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:b.hasRotationVVUniform(i)?r.Alignment.MAP:r.Alignment.SCREEN,outlineColor:e.outline?.color?.toArray()??[0,0,0,0],outlineSize:e.outline?.width??1,referenceSize:f,sprite:n,overrideOutlineColor:y,hasSizeVV:b.hasSizeVVUniform(i),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:m.getMaxSizeVVSize(i)}})]}function d(e,a){const{uniforms:i,schemaOptions:l}=a,{store:o}=l,s=o.ensureInstance(c.Techniques.marker,{geometry:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation}},{zoomRange:!1}),n=t.CIMSymbolHelper.createPictureMarkerRasterizationParam(e);if(!n)return[];return[s.createMeshInfo({params:{type:"picture",color:[255,255,255,255],height:e.height,width:e.width,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:b.hasRotationVVUniform(i)?r.Alignment.MAP:r.Alignment.SCREEN,outlineColor:null,outlineSize:0,referenceSize:e.height,sprite:n,overrideOutlineColor:!1,hasSizeVV:b.hasSizeVVUniform(i),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:m.getMaxSizeVVSize(i)}})]}function x(e,a,i){const{uniforms:l,schemaOptions:t}=i,{store:o}=t,s=o.ensureInstance(c.Techniques.marker,{geometry:{visualVariableColor:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity,visualVariableSizeMinMaxValue:l.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:l.visualVariableSizeScaleStops,visualVariableSizeStops:l.visualVariableSizeStops,visualVariableSizeUnitValue:l.visualVariableSizeUnitValue,visualVariableRotation:l.visualVariableRotation}},{zoomRange:!1}),n=z(e),u=6,p=u*a.width,S=p,f=e.color?.toArray()??a.color?.toArray()??[0,0,0,0],V="cross"===e.style||"x"===e.style;let y;switch(e.placement){case"begin-end":y=r.ExtremityPlacement.Both;break;case"begin":y=r.ExtremityPlacement.JustBegin;break;case"end":y=r.ExtremityPlacement.JustEnd;break;default:y=r.ExtremityPlacement.None}const h={type:"cim-marker-placement-info",placement:{type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:y,offsetAlongLine:0},overrides:[]};return[s.createMeshInfo({params:{type:"simple",color:f,height:S,width:p,offsetX:0,offsetY:0,angle:0,alignment:b.hasRotationVVUniform(l)?r.Alignment.MAP:r.Alignment.SCREEN,outlineColor:f,outlineSize:V?a.width:0,referenceSize:S/u,sprite:n,overrideOutlineColor:V&&null!=l.visualVariableColor,hasSizeVV:b.hasSizeVVUniform(l),placement:h,transforms:null,effects:null,scaleInfo:null,minPixelBuffer:m.getMaxSizeVVSize(l)}})]}function M(e,a){const{uniforms:i,schemaOptions:l}=a,{store:r}=l;return[r.ensureInstance(c.Techniques.text,{geometry:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue}},{zoomRange:!1,clipAngle:!1,referenceSymbol:!1}).createMeshInfo({params:{boxBackgroundColor:e.backgroundColor?.toArray(),boxBorderLineColor:e.borderLineColor?.toArray(),boxBorderLineSize:e.borderLineSize??0,color:e.color?.toArray()??[0,0,0,0],offsetX:e.xoffset,offsetY:e.yoffset,postAngle:e.angle,fontSize:e.font.size,decoration:e.font.decoration,haloColor:e.haloColor?.toArray()??[0,0,0,0],haloFontSize:e.haloSize??0,lineWidth:e.lineWidth,lineHeightRatio:e.lineHeight,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:e.font.toJSON(),textString:e.text,symbol:t.CIMSymbolHelper.createCIMTextSymbolfromTextSymbol(e)},overrides:[]},referenceSize:null,effects:null,placement:null,scaleInfo:null,transforms:null,scaleFactor:1,minPixelBuffer:m.getMaxSizeVVSize(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1}})]}function C(e,a){const{schemaOptions:l,uniforms:r}=a,{store:o}=l,n=e.symbol,{allowOverrun:u,repeatLabel:p,repeatLabelDistance:S}=e,b={maxScale:e.maxScale??0,minScale:e.minScale??0},f=o.ensureInstance(c.Techniques.label,{geometry:{visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:r.visualVariableRotation,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue}},{zoomRange:!0,clipAngle:!0,referenceSymbol:!0}),V=e.labelPlacement,[y,h]=s.getAlignmentFromPlacement(V);return[f.createMeshInfo({params:{boxBackgroundColor:n.backgroundColor?.toArray(),boxBorderLineColor:n.borderLineColor?.toArray(),boxBorderLineSize:n.borderLineSize??0,color:n.color?.toArray()??[0,0,0,0],offsetX:n.xoffset,offsetY:n.yoffset,postAngle:n.angle,fontSize:n.font.size,decoration:n.font.decoration,haloColor:n.haloColor?.toArray()??[0,0,0,0],haloFontSize:n.haloSize??0,lineWidth:n.lineWidth,lineHeightRatio:n.lineHeight,horizontalAlignment:y,verticalAlignment:h,repeatLabel:p,repeatLabelDistance:i.pt2px(S),allowOverrun:u,labelPosition:e.labelPosition,scaleInfo:b,minPixelBuffer:m.getMaxSizeVVSize(r),useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:n.font.toJSON(),textString:n.text,symbol:t.CIMSymbolHelper.createCIMTextSymbolfromTextSymbol(n),primitiveName:"label-override"},useLegacyLabelEvaluationRules:null==e.labelExpressionInfo?.expression,overrides:[{type:"CIMPrimitiveOverride",valueExpressionInfo:{type:"CIMExpressionInfo",expression:e.labelExpressionInfo?.expression??e.labelExpression,returnType:"String"},primitiveName:"label-override",propertyName:"textString",defaultValue:""}]},referenceSize:null,effects:null,placement:null,transforms:null,scaleFactor:1,isLineLabel:!1}})]}function I(e,a){const i=e.width;return{outlineColor:e.color?.toArray()||[0,0,0,1],width:i,referenceWidth:i,capType:e.cap??"round",joinType:e.join??"round",miterLimit:e.miterLimit,hasSizeVV:a}}function O(e,a){const{uniforms:i,schemaOptions:l}=a,{store:t}=l,r=e.color?.toArray()??[0,0,0,0],o={type:"sprite-rasterization-param",resource:{type:"fill-style",style:e.style},overrides:[]};if("solid"===e.outline?.style){return[t.ensureInstance(c.Techniques.patternOutlineFill,{geometry:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null}},{zoomRange:!1}).createMeshInfo({params:{color:r,...I(e.outline,!!i.visualVariableSizeOutlineScaleStops),sprite:o,scaleInfo:null,effects:null}})]}const s=[],n=t.ensureInstance(c.Techniques.patternFill,{geometry:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!1}).createMeshInfo({params:{color:e.color?.toArray()??[0,0,0,0],sprite:o,scaleInfo:null,effects:null}});return s.push(n),e.outline&&s.push(...L(e.outline,a,!0)),s}function A(e,a){const{uniforms:i,schemaOptions:l}=a,{store:t}=l,r=e.color?.toArray()??[0,0,0,0];if("none"!==e.style&&"solid"===e.outline?.style){return[t.ensureInstance(c.Techniques.outlineFill,{geometry:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null}},{zoomRange:!1}).createMeshInfo({params:{color:r,...I(e.outline,!!i.visualVariableSizeOutlineScaleStops),scaleInfo:null,effects:null}})]}const o=[];if("none"!==e.style){const e=t.ensureInstance(c.Techniques.fill,{geometry:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!1}).createMeshInfo({params:{color:r,scaleInfo:null,effects:null}});o.push(e)}return e.outline&&o.push(...L(e.outline,a,!0)),o}function R(e,a){const{style:i}=e;return i&&"none"!==i&&"solid"!==i?O(e,a):A(e,a)}function w(e,a){const{outline:i}=e,{uniforms:l,schemaOptions:r}=a,{store:o}=r,s=[],n=t.CIMSymbolHelper.createPictureFillRasterizationParam(e);if(!n)return[];const{width:u,height:p,xoffset:m,yoffset:S,xscale:b,yscale:f}=e,V={color:[255,255,255,255],sprite:n,height:p,aspectRatio:u/p,offsetX:m,offsetY:S,scaleX:b,scaleY:f,angle:0,applyRandomOffset:!1,sampleAlphaOnly:!1,scaleProportionally:!1,effects:null,scaleInfo:null};if("solid"===i?.style){return[o.ensureInstance(c.Techniques.complexOutlineFill,{geometry:{visualVariableColor:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity,visualVariableSizeScaleStops:l.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null}},{zoomRange:!1}).createMeshInfo({params:{...V,...I(i,!!l.visualVariableSizeOutlineScaleStops)}})]}const y=o.ensureInstance(c.Techniques.complexFill,{geometry:{visualVariableColor:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity}},{zoomRange:!1});return s.push(y.createMeshInfo({params:V})),i&&s.push(...L(i,a,!0)),s}function L(e,a,i){const{color:l,style:r,width:o,cap:s,join:n}=e,{schemaOptions:u}=a,{store:p}=u,S=[],f=i?{...m.noVisualVariables,visualVariableSizeScaleStops:a.uniforms.visualVariableSizeOutlineScaleStops}:a.uniforms,V={geometry:{visualVariableColor:f.visualVariableColor,visualVariableOpacity:f.visualVariableOpacity,visualVariableSizeMinMaxValue:f.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:f.visualVariableSizeScaleStops,visualVariableSizeStops:f.visualVariableSizeStops,visualVariableSizeUnitValue:f.visualVariableSizeUnitValue}},y={color:l?.toArray()??[0,0,0,0],width:o,referenceWidth:o,capType:s,joinType:n,miterLimit:e.miterLimit,hasSizeVV:b.hasSizeVVUniform(f),effects:null,scaleInfo:null};if(null==r||"solid"===r){const e=p.ensureInstance(c.Techniques.line,V,{zoomRange:!1}).createMeshInfo({params:y});S.push(e)}else if("none"!==r){const e=p.ensureInstance(c.Techniques.texturedLine,V,{zoomRange:!1}).createMeshInfo({params:{...y,shouldScaleDash:!0,shouldSampleAlphaOnly:!1,isSDF:!0,sprite:{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:t.slsDashToTemplateArray(r,s),capStyle:t.capTypeToEnum(s)},overrides:[]}}});S.push(e)}return null!=e.marker&&S.push(...x(e.marker,e,a)),S}e.createDotDensityMeshSchemas=y,e.createHeatmapMeshSchemas=h,e.createLineInstance=L,e.createPieChartMeshSchemas=v,e.createSymbolMeshSchemas=V,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
