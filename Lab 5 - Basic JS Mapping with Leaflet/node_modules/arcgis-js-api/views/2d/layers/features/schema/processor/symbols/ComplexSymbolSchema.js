/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../../../symbols/cim/CIMSymbolHelper","../../../../../../../symbols/cim/defaultCIMValues","../../../../../engine/webgl/shaderGraph/techniques/TechniqueRegistry","../VisualVariablesSchema","./utils"],(function(e,a,i,l,o,r){"use strict";function s(e){return e.minScale||e.maxScale?{minScale:e.minScale??0,maxScale:e.maxScale??0}:null}function t(e){if(null==e)return null;if(Array.isArray(e)){const[a,i,l,o]=e;return[a,i,l,255*o]}return"string"==typeof e?e:{...e,defaultValue:t(e?.defaultValue)}}async function n(e,i){const{cimResourceManager:l,cimAnalyzer:o,scaleExpression:r}=i.schemaOptions;await Promise.all(a.CIMSymbolHelper.fetchResources(e.symbol,l,[]));const t=o.analyzeSymbolReference(e,!1),n={scaleInfo:s(e),scaleExpression:r},u=[];for(const a of t)switch(a.type){case"marker":u.push(...c(a,i,n));break;case"fill":u.push(...m(a,i,n));break;case"line":u.push(...b(a,i,n));break;case"text":u.push(...v(a,i,n))}return u}function c(e,a,i){const{uniforms:r,schemaOptions:s}=a,{store:t}=s,n=e.isOutline?{...o.noVisualVariables,visualVariableSizeScaleStops:r.visualVariableSizeOutlineScaleStops}:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue,visualVariableRotation:r.visualVariableRotation};return u(t.ensureInstance(l.Techniques.marker,{geometry:n},{zoomRange:!!i.scaleInfo}),e,r,i)}function u(e,a,l,{scaleInfo:s,scaleExpression:n}){const c=r.hasSizeVVUniform(l);return[e.createMeshInfo({params:{size:a.size,scaleX:a.scaleX,anchorX:a.anchorPoint.x,anchorY:a.anchorPoint.y,angle:a.rotation,color:t(a.color)??[0,0,0,0],colorLocked:a.colorLocked,frameHeight:a.frameHeight,widthRatio:a.widthRatio,scaleInfo:s,offsetX:a.offsetX,offsetY:a.offsetY,outlineColor:t(a.outlineColor)??[0,0,0,0],outlineSize:a.outlineWidth,referenceSize:a.referenceSize||i.defaultCIMValues.CIMVectorMarker.size,rotateClockwise:a.rotateClockwise,scaleFactor:n??1,sizeRatio:a.sizeRatio,alignment:a.alignment,isAbsoluteAnchorPoint:a.isAbsoluteAnchorPoint,scaleSymbolsProportionally:a.scaleSymbolsProportionally,sprite:a.spriteRasterizationParam,hasSizeVV:c,placement:a.markerPlacement,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null,transforms:a.transform,minPixelBuffer:o.getMaxSizeVVSize(l)}})]}function f(e,a,i){const{uniforms:o,schemaOptions:r}=a,{store:s}=r;return p(s.ensureInstance(l.Techniques.fill,{geometry:{visualVariableColor:e.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity}},{zoomRange:!!i.scaleInfo}),e,i)}function p(e,a,{scaleInfo:i}){return[e.createMeshInfo({params:{color:t(a.color)??[0,0,0,0],scaleInfo:i,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null}})]}function m(e,a,i){if(!e.spriteRasterizationParam)return f(e,a,i);const{uniforms:o,schemaOptions:r}=a,{store:s}=r;return S(s.ensureInstance(l.Techniques.complexFill,{geometry:{visualVariableColor:e.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity}},{zoomRange:!!i.scaleInfo}),e,null!=o.visualVariableColor,i)}function S(e,a,i,{scaleInfo:l}){if(!a.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const o=!!a.hasUnresolvedReplacementColor&&(!i||a.colorLocked),r=a.sampleAlphaOnly&&!o,s=a.spriteRasterizationParam;return[e.createMeshInfo({params:{color:t(a.color)??[0,0,0,0],height:a.height,aspectRatio:a.scaleX,offsetX:a.offsetX,offsetY:a.offsetY,scaleX:1,scaleY:1,angle:a.angle,applyRandomOffset:a.applyRandomOffset,sampleAlphaOnly:r,scaleProportionally:"CIMHatchFill"===s.resource.type,sprite:s,scaleInfo:l,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null}})]}function b(e,a,i){const{uniforms:r,schemaOptions:s}=a,{store:t}=s,n=e.isOutline?{...o.noVisualVariables,visualVariableSizeScaleStops:r.visualVariableSizeOutlineScaleStops}:{visualVariableColor:e.colorLocked?null:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue},c={geometry:n},u=!!(n.visualVariableSizeMinMaxValue||n.visualVariableSizeScaleStops||n.visualVariableSizeStops||n.visualVariableSizeUnitValue);if(!e.spriteRasterizationParam){return h(t.ensureInstance(l.Techniques.line,c,{zoomRange:!!i.scaleInfo}),e,u,i)}return z(t.ensureInstance(l.Techniques.texturedLine,c,{zoomRange:!!i.scaleInfo}),e,u,i)}function V(e,a,{scaleInfo:i}){return{params:{color:t(e.color)??[0,0,0,0],width:e.width,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,scaleInfo:i,hasSizeVV:a,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}}}function h(e,a,i,l){if(a.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");return[e.createMeshInfo({params:V(a,i,l).params})]}function z(e,a,i,l){const{spriteRasterizationParam:o,scaleDash:r,sampleAlphaOnly:s}=a;if(!o)throw new Error("InternalError: Sprite should be defined");return[e.createMeshInfo({params:{...V(a,i,l).params,shouldScaleDash:r??!1,shouldSampleAlphaOnly:s,isSDF:"CIMPictureStroke"!==o.resource.type,sprite:o}})]}function v(e,a,i){const{uniforms:o,schemaOptions:r}=a,{store:s}=r;return y(s.ensureInstance(l.Techniques.text,{geometry:{visualVariableColor:e.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity,visualVariableRotation:o.visualVariableRotation,visualVariableSizeMinMaxValue:o.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:o.visualVariableSizeScaleStops,visualVariableSizeStops:o.visualVariableSizeStops,visualVariableSizeUnitValue:o.visualVariableSizeUnitValue}},{zoomRange:!!i.scaleInfo,referenceSymbol:!1,clipAngle:!1}),e,o,i)}function y(e,a,i,{scaleInfo:l,scaleExpression:r}){return[e.createMeshInfo({params:{boxBackgroundColor:t(a.backgroundColor),boxBorderLineColor:t(a.borderLineColor),boxBorderLineSize:a.borderLineWidth??0,color:t(a.color)??[0,0,0,0],offsetX:a.offsetX,offsetY:a.offsetY,postAngle:a.angle,fontSize:a.size,referenceSize:a.referenceSize,decoration:a.decoration,haloColor:t(a.outlineColor)??[0,0,0,0],haloFontSize:a.outlineSize,lineWidth:a.lineWidth||512,lineHeightRatio:1,horizontalAlignment:a.horizontalAlignment??"center",verticalAlignment:a.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:a.textRasterizationParam,scaleInfo:l,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null,placement:a.markerPlacement,transforms:a.transform,scaleFactor:r??1,minPixelBuffer:o.getMaxSizeVVSize(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1}})]}e.createComplexFillMeshInfos=S,e.createComplexMarkerMeshInfos=u,e.createComplexSimpleFillMeshInfos=p,e.createComplexSimpleLineMeshInfos=h,e.createComplexSymbolInstances=n,e.createComplexTextMeshInfos=y,e.createComplexTexturedLineMeshInfos=z,e.getScaleInfo=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
