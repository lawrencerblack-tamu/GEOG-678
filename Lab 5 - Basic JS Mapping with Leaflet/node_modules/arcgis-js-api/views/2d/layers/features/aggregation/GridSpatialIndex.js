/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/unitUtils","../../../engine/webgl/definitions","./GridCell"],(function(e,t,i,s){"use strict";const l=96;function o(e,i){return t.getMetersPerUnitForSR(e)*t.inchesPerMeter*l/i}class r{constructor(e){this._options=e,this._cells=new Map,this._pixelsPerMapUnit=o(e.spatialReference,e.scale)}insert(e,t){const i=e.getCursor(),s={$view:{scale:this._options.scale,timeZone:this._options.timeZone}};for(;i.next();)this._insertFeature(i,s,t)}putCellsInBounds(e,t){const[i,s,l,o]=t,r=Math.floor(i*this._pixelsPerMapUnit/this._options.cellSize),n=Math.floor(s*this._pixelsPerMapUnit/this._options.cellSize),c=Math.ceil(l*this._pixelsPerMapUnit/this._options.cellSize),a=Math.ceil(o*this._pixelsPerMapUnit/this._options.cellSize);for(let p=n;p<=a;p++)for(let t=r;t<=c;t++){const i=`${t}.${p}`,s=this._cells.get(i);if(!s)continue;const l=e.get(s.id);l?s&&!e.has(s.id)&&l.merge(s):e.set(s.id,s.clone())}}putCells(e){for(const t of this._cells.values()){const i=e.get(t.id);i?i.merge(t):e.set(t.id,t.clone())}}_insertFeature(e,t,s){const{featureFilter:l}=this._options;if(null!==l&&!l.check(e))return;let o=0,r=0;if("esriGeometryPoint"===e.geometryType)o=e.readXWorldSpace(),r=e.readYWorldSpace();else{if(s){const t=e.readCentroidForDisplay();if(null==t)return;const[s,l]=t.coords;if(s<0||s>i.tileSize||l<0||l>i.tileSize)return}const t=e.readCentroidWorldSpace();if(null==t)return;o=t.coords[0],r=t.coords[1]}const n=o*this._pixelsPerMapUnit,c=r*this._pixelsPerMapUnit,a=Math.floor(n/this._options.cellSize),p=Math.floor(c/this._options.cellSize);this._getCellOrCreate(a,p).insert(e,t,o,r)}_getCellOrCreate(e,t){const i=s.GridCell.createId(e,t);let l=this._cells.get(i);if(!l){const o=1*this._options.cellSize/this._pixelsPerMapUnit;l=s.GridCell.create(e,t,this._options.fields,o),this._cells.set(i,l)}return l}}e.GridSpatialIndex=r,e.pixelsPerMapUnit=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
