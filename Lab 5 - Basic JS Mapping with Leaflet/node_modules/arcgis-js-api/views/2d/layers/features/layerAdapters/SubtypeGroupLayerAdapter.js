/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/has","../../../../../core/lang","../../../../../core/mathUtils","../../../../../core/sql","../../../../../layers/support/arcgisLayerUrl","../../../../../layers/support/FeatureFilter","../../../../../layers/support/layerUtils","./featureServiceUtils","./floorFilterUtils","./geometryUtils","./labelingUtils","../schema/SourceSchema","../schema/processor/SubtypeProcessorSchema"],(function(e,t,s,r,i,a,l,o,n,y,u,c,p,d){"use strict";class h{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){return[{vvEvaluators:{},deconflictionEnabled:this.layer.sublayers.every((e=>c.getLayerDeconflictionEnabled(e)))}]}async createServiceOptions(e){const r=this.layer,i=o.getEffectiveLayerCapabilities(r),{capabilities:l,datesInUnknownTimezone:y,editingInfo:c,globalIdField:p,objectIdField:d,refreshInterval:h,subtypeField:b}=r,m=r.fieldsIndex.toJSON(),f=u.getEffectiveGeometryType(r),g=r.timeInfo?.toJSON(),S=r.spatialReference.toJSON(),F=s.clone(this.layer.parsedUrl),I=d,x=!(null!=c?.lastEditDate)&&h>0,E=t("featurelayer-snapshot-enabled")&&"point"===r.geometryType&&l?.query.supportsPagination&&!l?.operations.supportsEditing&&!x,v=E&&n.exceedsMinimumSnapshotCoverage(e,r.fullExtent);return{type:"feature-service",source:F,isSourceHosted:a.isHostedAgolService(F.path),orderByFields:I,metadata:{timeReferenceUnknownClient:y,subtypeField:b,globalIdField:p,fieldsIndex:m,geometryType:f,objectIdField:d,timeInfo:g,spatialReference:S,subtypes:this.layer.subtypes?.map((e=>e.toJSON())),typeIdField:null,types:null},queryMetadata:{capabilities:l,effectiveCapabilities:i,lastEditDate:c?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:E,supportsSnapshotMaxThreshold:v,snapshotCountThresholds:{min:t("featurelayer-snapshot-point-min-threshold"),max:t("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t,s){const{definitionExpression:r,customParameters:a,gdbVersion:l,historicMoment:o,subtypeField:n,timeExtent:y,apiKey:u}=this.layer,c=this.layer.sublayers.map((e=>e.subtypeCode)).join(","),d=this.layer.sublayers.length?`${this.layer.subtypeField} IN (${c})`:"1=2",h={definitionExpression:i.sqlAnd(r,d),customParameters:a,gdbVersion:l,historicMoment:o,subtypeField:n,timeExtent:y};return p.createFeatureSourceSchema(e,h,t,s,u)}createProcessorSchema(e,t,s){const r={subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,(e=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible,renderer:e.renderer,subtypeCode:e.subtypeCode,orderBy:null})))};return d.createSubtypeProcessorSchema(e,t,r,s)}hasFilters(e){return y.hasFloorFilter(this.layer,e)||b(this.layer,e)}addFilters(e,t){e=y.addFloorFilter(this.layer,e,t);const s=this.layer.sublayers.filter((e=>!m(e,t))).map((e=>e.subtypeCode));if(!s.length)return e;e??=new l;const r=`NOT ${this.layer.subtypeField} IN (${s.join(",")})`;return e.where=i.sqlAnd(e.where,r),e}get hasRequiredSupport(){return!0}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,gdbVersion:r,apiKey:i}=t,a=t.historicMoment?.getTime()??void 0,l=JSON.stringify(t.customParameters),o=y.hasFloorFilter(this.layer,e)?e.floors:null;return{gdbVersion:r,definitionExpression:s,historicMoment:a,customParameters:l,apiKey:i,sublayerHash:"sublayers"in this.layer&&this.layer.sublayers.items.reduce(((e,t)=>e+`${t.visible?1:0}.${JSON.stringify(t.renderer)}.${t.labelsVisible}\n.${JSON.stringify(t.labelingInfo)}`),""),floors:o}}setGraphicOrigin(e){const t=this.layer.fieldsIndex.get(this.layer.subtypeField),s=e.attributes[t.name],r=this.layer.sublayers.find((e=>e.subtypeCode===s));e.layer=e.sourceLayer=r}}function b(e,t){return e.sublayers.some((e=>!m(e,t)))}function m(e,t){return e.visible&&(0===e.minScale||r.floatEqualAbsolute(t.scale,e.minScale)||t.scale<e.minScale)&&(0===e.maxScale||r.floatEqualAbsolute(t.scale,e.maxScale)||t.scale>e.maxScale)}e.SubtypeGroupLayerAdapter=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
