/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/Error","../../../../../layers/support/layerUtils","./featureReductionUtils","./geometryUtils","./labelingUtils","../schema/SourceSchema","../schema/processor/SimpleProcessorSchema","../support/rendererUtils"],(function(e,t,r,i,n,o,l,a,s){"use strict";function c(e){if(!("openPorts"in e))throw new t("source-not-supported")}class d{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,r=o.getFeatureReductionDeconflictionEnabled(t,e)??o.getLayerDeconflictionEnabled(t);return[{vvEvaluators:{0:o.createLabelVVEvaluator(t.renderer)},deconflictionEnabled:r}]}async createServiceOptions(e){const t=this.layer,i=r.getEffectiveLayerCapabilities(t),{capabilities:o,objectIdField:l}=t,a=t.fieldsIndex.toJSON(),s=n.getEffectiveGeometryType(t),d=t.timeInfo?.toJSON(),u=t.spatialReference.toJSON();c(t.source);return{type:"memory",source:await t.source.openPorts(),orderByFields:l,metadata:{fieldsIndex:a,geometryType:s,objectIdField:l,timeInfo:d,spatialReference:u,subtypes:null,subtypeField:null,globalIdField:null,typeIdField:null,types:null,timeReferenceUnknownClient:null},queryMetadata:{capabilities:o,effectiveCapabilities:i,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,t,r){const{definitionExpression:i,timeExtent:n}=this.layer,o={definitionExpression:i,timeExtent:n,customParameters:null};return l.createFeatureSourceSchema(e,o,t,r,null)}createProcessorSchema(e,t,r){const{fields:n,renderer:o,geometryType:l,labelingInfo:s,labelsVisible:c,orderBy:d,objectIdField:u}=this.layer,f={fields:n.map((e=>e.toJSON())),renderer:o?.clone(),featureReduction:i.getEffectiveFeatureReduction(this.layer,t),geometryType:l,labelingInfo:s,labelsVisible:c,objectIdField:u,orderBy:d??"default"};return a.createSimpleProcessorSchema(e,t,f,r)}get hasRequiredSupport(){return s.isRendererSupported(this.layer.renderer)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:r,renderer:n}=t,o=this.layer.labelsVisible?this.layer.labelingInfo:null,l=i.getEffectiveFeatureReduction(t,e)?.toJSON();return{orderBy:JSON.stringify(t.orderBy),definitionExpression:r,renderer:n,labelingInfo:o,featureReduction:l}}}e.InMemoryLayerAdapter=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
