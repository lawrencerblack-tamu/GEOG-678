/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/has","../../../../../core/lang","../../../../../layers/support/arcgisLayerUrl","../../../../../layers/support/layerUtils","./featureReductionUtils","./featureServiceUtils","./floorFilterUtils","./geometryUtils","./labelingUtils","../schema/SourceSchema","../schema/processor/SimpleProcessorSchema","../support/rendererUtils"],(function(e,t,r,i,s,o,l,a,n,d,c,u,p){"use strict";class f{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,r=d.getFeatureReductionDeconflictionEnabled(t,e)??d.getLayerDeconflictionEnabled(t);return[{vvEvaluators:{0:d.createLabelVVEvaluator(t.renderer)},deconflictionEnabled:r}]}async createServiceOptions(e){const o=this.layer,a=s.getEffectiveLayerCapabilities(o),{capabilities:d,objectIdField:c,globalIdField:u,orderBy:p,refreshInterval:f}=o,y=o.fieldsIndex.toJSON(),h=y.fields,m=n.getEffectiveGeometryType(o),g=o.timeInfo?.toJSON(),b=o.spatialReference.toJSON(),S=r.clone(this.layer.parsedUrl);let F=this.layer.objectIdField;if(p?.length){const e=!p[0].valueExpression&&p[0].field;e&&(F=e)}const I=f>0,E=t("featurelayer-snapshot-enabled")&&"point"===o.geometryType&&d?.query.supportsPagination&&!d?.operations.supportsEditing&&!I,v=E&&l.exceedsMinimumSnapshotCoverage(e,o.fullExtent);return{type:"feature-service",source:S,isSourceHosted:i.isHostedAgolService(S.path),orderByFields:F,metadata:{globalIdField:u,fields:h,fieldsIndex:y,geometryType:m,objectIdField:c,timeInfo:g,spatialReference:b,timeReferenceUnknownClient:!1,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{capabilities:d,effectiveCapabilities:a,lastEditDate:null,snapshotInfo:{supportsSnapshotMinThreshold:E,supportsSnapshotMaxThreshold:v,snapshotCountThresholds:{min:t("featurelayer-snapshot-point-min-threshold"),max:t("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t,r){const{definitionExpression:i,customParameters:s,timeExtent:o}=this.layer,l={definitionExpression:i,customParameters:s,timeExtent:o};return c.createFeatureSourceSchema(e,l,t,r,null)}createProcessorSchema(e,t,r){const{fields:i,renderer:s,geometryType:l,labelingInfo:a,labelsVisible:n,orderBy:d,objectIdField:c}=this.layer,p={fields:i.map((e=>e.toJSON())),renderer:s?.clone(),featureReduction:o.getEffectiveFeatureReduction(this.layer,t),geometryType:l,labelingInfo:a,labelsVisible:n,objectIdField:c,orderBy:d??"default"};return u.createSimpleProcessorSchema(e,t,p,r)}get hasRequiredSupport(){return p.isRendererSupported(this.layer.renderer)}hasFilters(e){return a.hasFloorFilter(this.layer,e)}addFilters(e,t){return a.addFloorFilter(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:r,renderer:i}=t,s=this.layer.labelsVisible?this.layer.labelingInfo:null,l=JSON.stringify(t.customParameters),n=o.getEffectiveFeatureReduction(t,e)?.toJSON();return{orderBy:JSON.stringify(t.orderBy),definitionExpression:r,renderer:i,labelingInfo:s,featureReduction:n,customParameters:l,floors:a.hasFloorFilter(this.layer,e)?e.floors:null}}}e.OrientedImageryLayerAdapter=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
