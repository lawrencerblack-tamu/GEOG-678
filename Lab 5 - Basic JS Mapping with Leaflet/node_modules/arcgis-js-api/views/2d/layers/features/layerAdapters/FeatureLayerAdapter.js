/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/has","../../../../../core/lang","../../../../../layers/support/arcgisLayerUrl","../../../../../layers/support/layerUtils","./featureReductionUtils","./featureServiceUtils","./floorFilterUtils","./geometryUtils","./labelingUtils","../schema/SourceSchema","../schema/processor/SimpleProcessorSchema","../support/rendererUtils"],(function(e,t,r,i,s,o,a,l,n,d,c,p,u){"use strict";class y{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,r=d.getFeatureReductionDeconflictionEnabled(t,e)??d.getLayerDeconflictionEnabled(t);return[{vvEvaluators:{0:d.createLabelVVEvaluator(t.renderer)},deconflictionEnabled:r}]}async createServiceOptions(e){const o=this.layer,l=s.getEffectiveLayerCapabilities(o),{capabilities:d,editingInfo:c,objectIdField:p,typeIdField:u,globalIdField:y,datesInUnknownTimezone:f,orderBy:h,subtypeField:m,refreshInterval:b}=o,g=o.fieldsIndex.toJSON(),S=g.fields,F=n.getEffectiveGeometryType(o),I=o.timeInfo?.toJSON(),E=o.spatialReference.toJSON(),v=o.types?.map((e=>e.toJSON())),x=r.clone(this.layer.parsedUrl);this.layer.dynamicDataSource&&(x.query={layer:JSON.stringify({source:this.layer.dynamicDataSource})});let O=this.layer.objectIdField;if(h?.length){const e=!h[0].valueExpression&&h[0].field;e&&(O=e)}const T=!(null!=c?.lastEditDate)&&b>0,U=t("featurelayer-snapshot-enabled")&&"point"===o.geometryType&&d?.query.supportsPagination&&!d?.operations.supportsEditing&&!T,R=U&&a.exceedsMinimumSnapshotCoverage(e,o.fullExtent);return{type:"feature-service",source:x,isSourceHosted:i.isHostedAgolService(x.path),orderByFields:O,metadata:{typeIdField:u??void 0,types:v,timeReferenceUnknownClient:f,subtypeField:m,globalIdField:y,fields:S,fieldsIndex:g,geometryType:F,objectIdField:p,timeInfo:I,spatialReference:E,subtypes:this.layer.subtypes?.map((e=>e.toJSON()))},queryMetadata:{capabilities:d,effectiveCapabilities:l,lastEditDate:c?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:U,supportsSnapshotMaxThreshold:R,snapshotCountThresholds:{min:t("featurelayer-snapshot-point-min-threshold"),max:t("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t,r){const{definitionExpression:i,customParameters:s,gdbVersion:o,historicMoment:a,subtypeCode:l,subtypeField:n,timeExtent:d,apiKey:p}=this.layer,u={definitionExpression:i,customParameters:s,gdbVersion:o,historicMoment:a,subtypeCode:l,subtypeField:n,timeExtent:d};return c.createFeatureSourceSchema(e,u,t,r,p)}createProcessorSchema(e,t,r){const{fields:i,renderer:s,geometryType:a,labelingInfo:l,labelsVisible:n,orderBy:d,objectIdField:c}=this.layer,u={fields:i.map((e=>e.toJSON())),renderer:s?.clone(),featureReduction:o.getEffectiveFeatureReduction(this.layer,t),geometryType:a,labelingInfo:l,labelsVisible:n,objectIdField:c,orderBy:d??"default"};return p.createSimpleProcessorSchema(e,t,u,r)}get hasRequiredSupport(){return u.isRendererSupported(this.layer.renderer)}hasFilters(e){return l.hasFloorFilter(this.layer,e)}addFilters(e,t){return l.addFloorFilter(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:r,renderer:i,gdbVersion:s,apiKey:a,subtypeCode:n}=t,d=this.layer.labelsVisible?this.layer.labelingInfo:null,c=t.historicMoment?.getTime()??void 0,p=JSON.stringify(t.customParameters),u=o.getEffectiveFeatureReduction(t,e)?.toJSON(),y=JSON.stringify(t.orderBy);return{apiKey:a,customParameters:p,definitionExpression:r,featureReduction:u,floors:l.hasFloorFilter(this.layer,e)?e.floors:null,gdbVersion:s,historicMoment:c,labelingInfo:d,orderBy:y,renderer:i,subtypeCode:n}}}e.FeatureLayerAdapter=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
