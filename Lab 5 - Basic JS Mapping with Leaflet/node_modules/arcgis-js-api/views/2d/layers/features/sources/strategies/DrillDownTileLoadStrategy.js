/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/has","../../../../../../core/promiseUtils","./ATileLoadStrategy","./chunks/DrillDownTileSourceChunk","../../support/FeatureSetReaderJSON"],(function(e,t,o,i,r,s){"use strict";class n{constructor(e,t){this.subscription=e,this._tileIdToResult=new Map,this._controller=new AbortController,o.onAbort(e.options,(()=>this._controller.abort())),o.onAbort(t,(()=>this._controller.abort()))}get(e){return this._tileIdToResult.get(e)}set(e,t){this._tileIdToResult.set(e,t)}get options(){return{signal:this._controller.signal}}}class l extends i.ATileLoadStrategy{constructor(){super(...arguments),this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(e){this._loadStates.has(e.key.id)||this._loadStates.set(e.key.id,new n(e,this._options));const t=this._loadStates.get(e.key.id);let i;try{for await(const i of this._fetchChunkInfos(t,e.tile,0)){const{queryJSON:t,reader:s,sourceTile:n,sourceTileDepth:l,tile:a}=i,u=new r.DrillDownTileSourceChunk(s,t,a,n,l,!1);o.throwIfAborted(e.options),this._addChunk(u)}}catch(a){i=a}const l=new r.DrillDownTileSourceChunk(s.FeatureSetReaderJSON.empty(this._metadata),null,e.tile,null,-1,!0);if(this._addChunk(l),i)throw i}unload(e){super.unload(e),this._loadStates.delete(e.key.id)}async*_fetchChunkInfos(e,o,i){let r=e.get(o.id);const s=!!r;if(r||(r=await this._fetchChunkInfo(e,o,i),e.set(o.id,r)),r.reader.exceededTransferLimit&&i<t("featurelayer-query-max-depth"))for(const t of o.createChildTiles())yield*this._fetchChunkInfos(e,t,i+1);else s||(yield r)}async _fetchChunkInfo(e,t,o){const i=e.subscription.tile.getQuantizationParameters(),r=this._queryInfo.createTileQuery(t,{returnExceededLimitFeatures:!1,quantizationParameters:i});return{reader:await this._fetch(r,e.subscription.options),queryJSON:r.inner.toJSON(),tile:e.subscription.tile,sourceTile:t,sourceTileDepth:o}}}e.DrillDownTileLoadStrategy=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
