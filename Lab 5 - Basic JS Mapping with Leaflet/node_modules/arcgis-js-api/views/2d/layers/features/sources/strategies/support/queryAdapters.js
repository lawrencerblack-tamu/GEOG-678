/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../../../core/has","../../../../../../../core/workers/Connection","../../../../../../../geometry/support/quantizationUtils","../../../../../../../layers/graphics/featureConversionUtils","../../../../../../../layers/ogc/ogcFeatureUtils","../../../../../../../rest/query/operations/query","../../../support/FeatureSetReaderJSON","../../../support/FeatureSetReaderPBF"],(function(e,t,a,r,i,s,u,n,o){"use strict";class c{constructor(e,t){this.service=e,this._metadata=t}destroy(){}}function d(e,a){switch(e.type){case"memory":return new y(e,a);case"ogc":return new f(e,a);case"feature-service":return e.queryMetadata.capabilities.query.supportsFormatPBF&&t("featurelayer-pbf")?new p(e,a):new l(e,a)}}async function m(e){const t=new a;return await t.open(e,{}),t}class y extends c{constructor(e,t){super(e,t),this._portsOpen=m(e.source).then((e=>this.client=e))}destroy(){this.client.close(),this.client=null}async executeQuery(e,t){await this._portsOpen;const a=await this.client.invoke("queryFeatures",e.toJSON(),t);return n.FeatureSetReaderJSON.fromFeatureSet(a,this._metadata)}}class p extends c{async executeQuery(e,t){const{data:a}=await u.executeQueryPBFBuffer(this.service.source,e,t),r=!e.quantizationParameters;return o.FeatureSetReaderPBF.fromBuffer(a,this._metadata,r)}}class l extends c{async executeQuery(e,t){const{source:a,queryMetadata:s}=this.service,o=s.capabilities;if(null!=e.quantizationParameters&&!o.query.supportsQuantization){const s=e.clone(),o=r.toQuantizationTransform(s.quantizationParameters);s.quantizationParameters=null;const{data:c}=await u.executeQuery(a,s,this._metadata.spatialReference,t),d=i.convertFromFeatureSet(c,this._metadata.objectIdField);return i.quantizeOptimizedFeatureSet(o,d),n.FeatureSetReaderJSON.fromOptimizedFeatureSet(d,this._metadata)}const{data:c}=await u.executeQuery(a,e,this._metadata.spatialReference,t);return"esriGeometryPoint"===this._metadata.geometryType&&(c.features=c.features?.filter((e=>{if(null!=e.geometry){const t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0}))),n.FeatureSetReaderJSON.fromFeatureSet(c,this._metadata)}}class f extends c{async executeQuery(e,t){const{capabilities:a}=this.service.queryMetadata;if(e.quantizationParameters&&!a.query.supportsQuantization){const a=e.clone(),u=r.toQuantizationTransform(a.quantizationParameters);a.quantizationParameters=null;const o=await s.queryOptimizedFeatureSet(this.service.source,e,t);return i.quantizeOptimizedFeatureSet(u,o),n.FeatureSetReaderJSON.fromOptimizedFeatureSet(o,this._metadata)}const u=await s.queryOptimizedFeatureSet(this.service.source,e,t);return n.FeatureSetReaderJSON.fromOptimizedFeatureSet(u,this._metadata)}}e.SourceAdapter=c,e.createQueryAdapter=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
