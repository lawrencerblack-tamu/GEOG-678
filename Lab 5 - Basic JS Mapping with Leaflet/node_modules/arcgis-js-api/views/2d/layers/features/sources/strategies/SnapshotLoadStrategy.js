/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/Error","../../../../../../core/promiseUtils","../../../../../../core/RandomLCG","./AFetchLoadStrategy","./chunks/FeatureSnapshotSourceChunk","../../support/FeatureSetReaderJSON"],(function(e,t,r,o,a,n,s){"use strict";class i extends a.AFetchLoadStrategy{constructor(e,t,r,a,n,s){super(e,t,r,n,s),this._random=new o(1e3),this._featureCount=a}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}load(e){return null==this._promise&&(this._promise=this._downloadPages(this._featureCount)),this._promise}unload(e){}async _downloadPages(e){const r=Math.ceil(e/this._queryInfo.pageSize),o=Array.from({length:r},((e,t)=>t)).sort(((e,t)=>this._random.getInt()-this._random.getInt())),a=await Promise.all(o.map((e=>this._downloadPage(e)))),i=new n.FeatureSnapshotSourceChunk(s.FeatureSetReaderJSON.empty(this._metadata),null,-1,!0);this._store.insert(i);const u=a.filter((e=>e));if(u.length)throw new t("featurelayer-query","Encountered errors when downloading data",{errors:u})}async _downloadPage(e){try{const t=this._queryInfo.createPagedQuery(e),o=await this._fetch(t,this._options),a=new n.FeatureSnapshotSourceChunk(o,t.inner.toJSON(),e,!1);return r.throwIfAborted(this._options),this._store.insert(a),null}catch(t){return t}}}e.SnapshotLoadStrategy=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
