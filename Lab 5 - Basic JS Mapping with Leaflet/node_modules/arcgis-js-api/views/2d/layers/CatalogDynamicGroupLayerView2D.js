/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../core/Collection","../../../core/Logger","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/sql","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","./LayerView2D","../../layers/LayerView"],(function(e,t,r,i,s,a,n,d,o,l,c,h){"use strict";const u=Symbol();let y=class extends(c.LayerView2DMixin(h)){constructor(){super(...arguments),this.layerViews=new t,this._debouncedUpdate=i.debounce((async()=>{const{layer:e,parent:{footprintLayerView:t}}=this;let r=[];if(t){const i=this._createQuery(),{features:s}=await t.queryFeatures(i);this.suspended||(r=s.map((t=>e.acquireLayer(t))))}this.removeHandles(u),this.addHandles(r,u)}))}attach(){this.addAttachHandles([this._updatingHandles.addOnCollectionChange((()=>this.layerViews),(()=>this._updateStageChildren()),{initial:!0}),s.when((()=>!1===this.parent.footprintLayerView?.dataUpdating),(()=>this._updateLayers())),s.watch((()=>[this.layer.maximumVisibleSublayers,this.suspended,this.parent.footprintLayerView?.filter]),(()=>this._updateLayers()))])}detach(){this.container.removeAllChildren(),this.removeHandles(u)}update(e){}moveStart(){}viewChange(){}moveEnd(){}isUpdating(){return this.layerViews.some((e=>e.updating))}_updateStageChildren(){this.container.removeAllChildren(),this.layerViews.forEach(((e,t)=>this.container.addChildAt(e.container,t)))}_updateLayers(){this.suspended?this.removeHandles(u):this._updatingHandles.addPromise(this._debouncedUpdate().catch((e=>{r.getLogger(this).error(e)})))}_createQuery(){const{parent:{footprintLayerView:e},layer:{maximumVisibleSublayers:t,parent:{itemTypeField:r,itemSourceField:i,objectIdField:s,orderBy:n}}}=this,d=`${r} <> 'Scene Service'`,o=e.createQuery();o.returnGeometry=!1,o.num=t,o.outFields=[s,i],o.where=a.sqlAnd(o.where,d);const l=n?.find((e=>e.field&&!e.valueExpression));return l?.field&&(o.orderByFields=[`${l.field} ${"descending"===l.order?"DESC":"ASC"}`]),o}};y=e.__decorate([l.subclass("esri.views.2d.layers.CatalogDynamicGroupLayerView2D")],y);return y}));
