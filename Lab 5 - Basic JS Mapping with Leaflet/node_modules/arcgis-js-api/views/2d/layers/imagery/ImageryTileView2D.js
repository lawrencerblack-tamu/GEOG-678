/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../engine/imagery/RasterTileContainer","./BaseImageryTileSubView2D","../support/util","../../../layers/support/Geometry"],(function(e,t,r,s,i,n,o,a,l,c){"use strict";let u=class extends a.BaseImageryTileSubView2D{constructor(){super(...arguments),this.type="raster"}attach(){super.attach(),this.container=new o.RasterTileContainer(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()}detach(){super.detach(),this.container.removeAllChildren(),this.container=null}canUseWebGLForProcessing(){const{symbolizer:e}=this.layer,t=e.lookup?.colormapLut?.indexedColormap,r=t&&t.length>this._maxIndexedColormapSize;return this.useWebGLForProcessing&&e.canRenderInWebGL&&!r&&!("majority"===this.layer.interpolation&&l.canUseMajorityInterpolationOnDataSource(this.layer))}fetchTile(e,t){return this.layer.fetchTile(e.level,e.row,e.col,t)}updateRasterFunctionParameters(){const{clips:e,view:t}=this.layerView;null!=this._geometry&&e.remove(this._geometry);const{raster:r,type:s}=this.layer;if("Function"===r.datasetFormat){const s=r.getClippingGeometry(t.spatialReference);if(s){const t=new c({geometry:s});e.add(t),this._geometry=t}}const{container:i}=this;if("Function"!==r.datasetFormat||"wcs"===s)return i.rasterFunctionChain=null,i.children.forEach((e=>{const{bitmap:t}=e;t&&(t.suspended=!0,t.processed=!1,t.projected&&(t.invalidateTexture(),t.rasterTexture=null))})),void(this._rasterFunctionState="na");const n=this._rasterFunctionState,{rasterFunction:o,primaryRasters:a}=r,l=o.supportsGPU&&(!a||a.rasters.length<=1),u=l?o.flatWebGLFunctionChain:null,{renderer:p}=this.layer,d=!l||!u?.functions.length||"raster-stretch"===p?.type&&p.dynamicRangeAdjustment||!this.canUseWebGLForProcessing();i.rasterFunctionChain=d?null:u;const h=null==o?"na":i.rasterFunctionChain?"gpu":"cpu";i.children.forEach((e=>{const{bitmap:t}=e;t&&(t.suspended=n!==h,t.processed=!1,t.processedTexture=null)})),this._rasterFunctionState=h}async updateTileSource(e,t){const r=this._getBandIds(),s=this._getLayerInterpolation(),i=this.canUseWebGLForProcessing(),{source:n,globalSymbolizerParams:o,suspended:a,coords:l,resolution:c}=t,u=this.layerView.hasTilingEffects?o:t.symbolizerParams,{bitmap:p}=e;if([p.x,p.y]=l,p.resolution=c,null!=n?.pixelBlock){const e={extent:n.extent,pixelBlock:n.pixelBlock,srcPixelSize:n.srcTilePixelSize};if(p.rawPixelData=e,i)p.source=n.pixelBlock,p.isRendereredSource=!1;else{const t=await this.layer.applyRenderer(e,"stretch"===o?.type?o:void 0);p.source=t,p.isRendereredSource=!0}p.symbolizerParameters=i?u:null,p.transformGrid=i?n.transformGrid:null}else{const e=this.createEmptyTilePixelBlock();p.source=e,p.symbolizerParameters=i?u:null,p.transformGrid=null}p.bandIds=i?r:null,p.width=this._tileInfoView.tileInfo.size[0],p.height=this._tileInfoView.tileInfo.size[1],p.interpolation=s,p.suspended=a,p.invalidateTexture()}async updateTileSymbolizerParameters(e,t){const{local:r,global:s}=t,i=this._getBandIds(),n=this._getLayerInterpolation(),o=this.canUseWebGLForProcessing(),{bitmap:a}=e,{rawPixelData:l}=a;o||null==l?(a.isRendereredSource&&null!=l&&(a.source=l.pixelBlock),a.isRendereredSource=!1):(a.source=await this.layer.applyRenderer(l,"stretch"===s?.type?s:void 0),a.isRendereredSource=!0),a.symbolizerParameters=o?this.layerView.hasTilingEffects?s:r:null,a.bandIds=o?i:null,a.interpolation=n,a.suspended=!1}_getLayerInterpolation(){const{interpolation:e,renderer:t}=this.layer;if(!t)return e;const r=t.type;return"raster-colormap"===r||"unique-value"===r||"class-breaks"===r?"nearest":"raster-stretch"===t.type&&null!=t.colorRamp?"bilinear"===e||"cubic"===e?"bilinear":"nearest":e}};e.__decorate([t.property()],u.prototype,"container",void 0),e.__decorate([t.property()],u.prototype,"layer",void 0),e.__decorate([t.property()],u.prototype,"type",void 0),u=e.__decorate([n.subclass("esri.views.2d.layers.imagery.ImageryTileView2D")],u);return u}));
