/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../Color","../../core/Accessor","../../core/asyncUtils","../../core/colorUtils","../../core/handleUtils","../../core/mathUtils","../../core/promiseUtils","../../core/quantityFormatUtils","../../core/reactiveUtils","../../core/screenUtils","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/libs/gl-matrix-2/math/vec2","../../core/libs/gl-matrix-2/factories/vec2f64","../../chunks/vec32","../../geometry/support/coordsUtils","../../geometry/support/vectorStacks","../../intl/messages","../../support/elevationInfoUtils","../../support/getDefaultUnitForView","../overlay/TextOverlayItem","../support/automaticLengthMeasurementUtils"],(function(e,t,s,o,r,n,a,i,l,c,d,h,p,u,g,b,_,y,m,x,f,v,L,U,I,S,C,w){"use strict";const k=3025,D={default:15,far:25};function P(e,t,s,o,r){const n=[];if(t.data.components[r].iterateVertices((e=>{n.push(o.toXYZ(e.pos,L.sv3d.get()))})),0===r&&null!=s&&n.push(o.toXYZ(s,L.sv3d.get())),n.length<2)return n;const a=n[0],i=n[n.length-1];return"polygon"===e.type&&n.length>2&&!f.equals(a,i)&&n.push(a),n}function M(e,t,s,o){if("2d"===t.type)return!0;const r=p.getMetersPerUnit(o)??1,n=p.getMetersPerVerticalUnitForSR(o),a=e=>I.getConvertedElevationFromVector(t,e,o,s,I.absoluteHeightElevationInfo)??0;for(let i=1;i<e.length;++i){const t=e[i-1],s=e[i],o=(s[0]-t[0])*r,l=(s[1]-t[1])*r,c=(a(s)-a(t))*n;if(Math.abs(c)/Math.sqrt(o*o+l*l)>O)return!1}return!0}e.SegmentLabels=class extends o{constructor(e){super(e),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const e=r.createTask((async e=>{const t=await U.fetchMessageBundle("esri/core/t9n/Units");l.throwIfAborted(e),this._messagesUnits=t}));this.addHandles([d.watch((()=>[null!=this.context&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits]),(()=>this._update())),...["vertex-add","vertex-update","vertex-remove"].map((e=>d.on((()=>this.context?.editGeometryOperations),e,(()=>this._update())))),a.makeHandle((()=>e.abort())),d.watch((()=>this._colors),(e=>this._updateStyle(e)))])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return null==this._messagesUnits}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map((e=>e.label.text))}}get _edgeDistancePixels(){return D[this.edgeDistance]}get _colors(){const e=this.context?.view.effectiveTheme.textColor??s.fromArray([255,255,255]);return{textColor:e,backgroundColor:n.multiplyOpacity(n.getContrast(e,n.BrightnessThreshold.Low),.6)}}_update(){if(this.destroyed)return;this._nextLabelIndex=0;const{context:e,stagedVertex:t}=this;if(!e)return this._destroyUnusedLabels();const{editGeometryOperations:s}=e,{components:o,geometry:r,coordinateHelper:n}=s.data;if(!r)return this._destroyUnusedLabels();const a=o.length;for(let i=0;i<a;++i){const o=P(r,s,t,n,i);if(o.length<2||!M(o,e.view,e.elevationInfo,n.spatialReference))continue;const l=1===a&&!v.isClockwise(o);let c=F,d=T;this.toScreenPointArray(e,o[0],c);for(let t=1;t<o.length;++t){const s=o[t-1],r=o[t];this.toScreenPointArray(e,r,d),this._addLabel(e,s,c,r,d,l),[c,d]=[d,c]}}this._destroyUnusedLabels()}_updateStyle({textColor:e,backgroundColor:t}){const s=this._nextLabelIndex,o=this._labelInfos;for(let r=0;r<s;++r){const{label:s}=o[r];s.textColor=e,s.backgroundColor=t}}_addLabel(e,t,s,o,r,n){const{label:a}=this._getOrCreateLabel(e);if(!this.visible||m.squaredDistance(s,r)<k)return void(a.visible=!1);const{spatialReference:i}=e.editGeometryOperations.data,l=w.autoDistance2D(t,o,i),d=this._messagesUnits,h=S.getDefaultUnitForView(e.view);a.text=null!=d&&null!=l?c.formatLength(d,l,h):"",a.visible=!0;const p=r[0]-s[0],u=r[1]-s[1];n?m.set(V,-u,p):m.set(V,u,-p),m.normalize(V,V),m.scale(V,V,this._edgeDistancePixels),m.lerp(A,s,r,.5),m.add(A,A,V),a.position=[A[0],A[1]],Math.abs(V[0])>Math.abs(V[1])?a.anchor=V[0]>0?"left":"right":a.anchor=-V[1]<0?"top":"bottom"}_getOrCreateLabel(e){const t=this._labelInfos.length>this._nextLabelIndex,{textColor:s,backgroundColor:o}=this._colors;if(t){const e=this._labelInfos[this._nextLabelIndex++],{label:t}=e;return t.textColor=s,t.backgroundColor=o,e}const r=new C({anchor:"center",fontSize:8,textColor:s,backgroundColor:o});e.view.overlay?.items.add(r);const n={label:r};return this._labelInfos.push(n),this._nextLabelIndex=this._labelInfos.length,n}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:e}){this.context?.view.overlay?.items.remove(e),e.destroy()}},t.__decorate([u.property()],e.SegmentLabels.prototype,"context",void 0),t.__decorate([u.property()],e.SegmentLabels.prototype,"stagedVertex",void 0),t.__decorate([u.property()],e.SegmentLabels.prototype,"visible",void 0),t.__decorate([u.property()],e.SegmentLabels.prototype,"edgeDistance",void 0),t.__decorate([u.property()],e.SegmentLabels.prototype,"updating",null),t.__decorate([u.property()],e.SegmentLabels.prototype,"_messagesUnits",void 0),t.__decorate([u.property()],e.SegmentLabels.prototype,"_edgeDistancePixels",null),t.__decorate([u.property()],e.SegmentLabels.prototype,"_colors",null),e.SegmentLabels=t.__decorate([y.subclass("esri.views.interactive")],e.SegmentLabels);const O=i.deg2rad(5),V=x.create(),A=x.create(),F=h.createScreenPointArray(),T=h.createScreenPointArray();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
