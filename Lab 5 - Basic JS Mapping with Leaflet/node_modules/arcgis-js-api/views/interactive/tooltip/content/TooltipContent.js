/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/tslib.es6","../../../../intl","../../../../core/a11yUtils","../../../../core/memoize","../../../../core/promiseUtils","../../../../core/quantityFormatUtils","../../../../core/scheduling","../../../../core/unitFormatUtils","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../support/getDefaultUnitForView","../../keybindings","../css","../../../support/angularMeasurementUtils","../../../../widgets/Widget","../../../../chunks/componentsUtils","../../../../widgets/support/widgetUtils","../../../../widgets/support/decorators/messageBundle","../../../../widgets/support/jsxFactory","../../../../intl/number"],(function(t,e,o,i,n,r,s,a,l,c,p,u,d,h,m,g,_,f,y,b,v,w,C,T,x,A){"use strict";function F(t){t?.setFocus()}function U(t){return(Array.isArray(t)?t:[t]).flat(10).filter((t=>!!t))}e.TooltipContent=class extends v{constructor(){super(...arguments),this._focusAbortController=new AbortController,this._transition=null,this._mode="feedback",this._getFormatters=r.memoize(((t,e)=>({angleRelative:t=>A.formatNumber(t,{minimumFractionDigits:k,maximumFractionDigits:k,signDisplay:"exceptZero"}),direction:t=>a.formatAngle(t,t.rotationType,k),directionRelative:t=>{const e=b.getDegreesGeographic(t);return A.formatNumber(e,{style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:k,minimumFractionDigits:k,signDisplay:e>0?"never":"exceptZero"})},directionRelativeBilateral:t=>a.formatAngle(t,t.rotationType,k),area:(o,i)=>a.formatArea(t,o,i??e.area),length:(o,i,n)=>a.formatLength(t,o,i??e.length,n),lengthRelative:(o,i)=>a.formatRelativeLength(t,o,i??e.length),totalLength:(o,i)=>a.formatLength(t,o,i??e.length),verticalLength:(o,i)=>a.formatVerticalLength(t,o,i??e.length),verticalLengthRelative:(o,i)=>a.formatRelativeVerticalLength(t,o,i??e.verticalLength),percentage:t=>A.formatNumber(t.value,{style:"percent"}),scale:t=>A.formatNumber(t,{style:"percent",maximumFractionDigits:0})}))),this._onDiscard=()=>{this.exitInputMode()},this._onCommit=(t,e)=>{if("commit-and-exit"===e)return void this.exitInputMode();const o=this._getFocusableElements(),i=o.length,n=o.indexOf(t);if(-1===n)return void this.exitInputMode();const r=((n+("commit-and-next"===e?1:-1))%i+i)%i;F(o.at(r))},this._handleTab=t=>{if(t.code!==f.tooltipKeys.next)return;const e=this._getFocusableElements(),o=e.at(0),i=e.at(-1);o&&i&&(t.shiftKey?document.activeElement===o&&(t.preventDefault(),F(i)):document.activeElement===i&&(t.preventDefault(),F(o)))}}get mode(){return this._mode}get _displayUnits(){const t=_.getDefaultUnitForView(this.tooltip.view);return{length:t,verticalLength:t,area:t,angle:"degrees"}}get _inputUnitInfos(){const t=this._messagesUnits,e=e=>({unit:e,abbreviation:c.unitName(t,e,"abbr")}),o=_.getDefaultUnitForView(this.tooltip.view),i=e(p.defaultLengthUnit(o)),n=e(p.defaultVerticalLengthUnit(o)),r=e(p.defaultAreaUnit(o)),s=e("degrees");return{length:i,lengthRelative:i,verticalLength:n,verticalLengthRelative:n,area:r,direction:s,orientation:s,rotation:s}}get _formatters(){return this._getFormatters(this._messagesUnits,this._displayUnits)}get fieldContext(){return{formatters:this._formatters,inputUnitInfos:this._inputUnitInfos,messages:this._messagesTooltip,sketchOptions:this.info.sketchOptions,onCommit:this._onCommit,onDiscard:this._onDiscard}}render(){const t=U(this._renderContent()),{visibleElements:e}=this.info.sketchOptions.tooltips,o=e.helpMessage?this._getHelpMessage():null,i=t.length>0,n=i||!!o,r="input"===this.mode,s=U(this._renderActions());return x.tsx("div",{class:C.classes(y.content,r&&y.contentInputMode),onkeydown:this._handleTab},r&&n&&e.header?x.tsx("div",{class:y.contentHeader,key:"header"},x.tsx("calcite-button",{appearance:"transparent",iconFlipRtl:"both",iconStart:"chevron-left",key:"discard-button",kind:"neutral",onclick:this._onDiscard,scale:"s",tabIndex:-1}),s.length>0?x.tsx(x.tsxFragment,null,x.tsx("div",{class:y.contentHeaderSpacer,key:"spacer"}),x.tsx("div",{class:y.contentHeaderActions,key:"actions"},s)):null):null,i?x.tsx("div",{class:y.table,key:"content"},...t):null,o?x.tsx("div",{class:y.helpMessage,key:"help-message"},o):null)}_renderActions(){return null}loadDependencies(){return w.loadCalciteComponents({button:()=>new Promise(((e,o)=>t(["../../../../chunks/calcite-button"],e,o))),icon:()=>new Promise(((e,o)=>t(["../../../../chunks/calcite-icon"],e,o))),input:()=>new Promise(((e,o)=>t(["../../../../chunks/calcite-input"],e,o)))})}async enterInputMode(t){try{await this._transitionTo("input"),await this._focusField(t)}catch(e){s.throwIfNotAbortError(e)}}async exitInputMode(){try{await this._transitionTo("feedback"),document.querySelector(".esri-view-surface").focus()}catch(t){s.throwIfNotAbortError(t)}}_getHelpMessage(t){const{info:e}=this,{helpMessage:o,viewType:i}=e,n=t??o,r="3d"===i?"helpMessages3d":"helpMessages2d";return n?this._messagesTooltip?.sketch?.[r]?.[n]:void 0}async _focusField(t){this._focusAbortController?.abort(),this._focusAbortController=new AbortController;const{signal:e}=this._focusAbortController;await this._waitForInputs(),s.throwIfAborted(e);const o=this._getFocusableInputs();F(t?o.find((e=>e.getAttribute("data-field-name")===t)):o.at(0))}async _transitionTo(t){if(this._mode===t)return;const e=()=>{this._mode=t,this.tooltip.positionMode="input"===t?"fixed":"follow-cursor"};if(!this.domNode?.firstChild||!document.startViewTransition||n.prefersReducedMotion())return void e();this.autoRenderingEnabled=!1,this._transition?.skipTransition();const o=this._transition=document.startViewTransition((()=>{if(!this.destroyed)return this.autoRenderingEnabled=!0,e(),this.renderNow(),l.waitTick()}));try{await this._transition.finished}finally{o===this._transition&&(this._transition=null)}}async _waitForInputs(){const t=Date.now(),e=()=>Array.from(this.domNode?.querySelectorAll("calcite-input")??[]);for(;0===e().length;)if(await s.after(D),Date.now()-t>I)return}_getFocusableInputs(){return Array.from(this.domNode?.querySelectorAll("calcite-input:not([read-only]):not([disabled])")??[])}_getFocusableElements(){const t=this.domNode?.querySelector(`.${y.drawContentHeaderActions}`);return[...Array.from(t?.querySelectorAll("calcite-action:not([disabled])")??[]),...this._getFocusableInputs()]}},o.__decorate([T.messageBundle("esri/core/t9n/Units"),u.property()],e.TooltipContent.prototype,"_messagesUnits",void 0),o.__decorate([T.messageBundle("esri/views/interactive/tooltip/t9n/Tooltip"),u.property()],e.TooltipContent.prototype,"_messagesTooltip",void 0),o.__decorate([u.property()],e.TooltipContent.prototype,"info",void 0),o.__decorate([u.property()],e.TooltipContent.prototype,"tooltip",void 0),o.__decorate([u.property()],e.TooltipContent.prototype,"_mode",void 0),o.__decorate([u.property()],e.TooltipContent.prototype,"mode",null),o.__decorate([u.property()],e.TooltipContent.prototype,"_displayUnits",null),o.__decorate([u.property()],e.TooltipContent.prototype,"_inputUnitInfos",null),o.__decorate([u.property()],e.TooltipContent.prototype,"_formatters",null),o.__decorate([u.property()],e.TooltipContent.prototype,"fieldContext",null),e.TooltipContent=o.__decorate([g.subclass("esri.views.interactive.tooltip.content.TooltipContent")],e.TooltipContent);const k=1,D=50,I=1e3;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
