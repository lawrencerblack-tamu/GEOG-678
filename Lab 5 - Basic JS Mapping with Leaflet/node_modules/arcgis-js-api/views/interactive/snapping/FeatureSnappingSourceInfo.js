/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Logger","../../../core/reactiveUtils","../../../core/sql","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/support/FeatureFilter","../../../layers/support/floorFilterUtils","../../../layers/support/layerUtils","./snappingUtils","../../support/layerViewUtils"],(function(e,r,t,i,o,a,l,n,s,u,p,c,y,d,f){"use strict";function g(e,r){return null==e?new p({where:r}):e.where?new p({where:a.sqlAnd(e.where,r)}):new p({where:r})}e.FeatureSnappingSourceInfo=class extends t{get layerView(){return this.view?.allLayerViews?.find((e=>e.layer===this.layer))}get valid(){return this._valid}get subtypeFilter(){const{layer:e,snappingSource:r}=this;if(!y.isSubtypeGroupLayer(e)||!e.subtypes?.length)return{mode:"not-in-use",filter:null};const t=r.layerSource.sublayerSources.filter((e=>e.enabled&&e.layer.visible&&f.scaleBoundsPredicate(this.view?.scale,e.layer.effectiveScaleRange.minScale,e.layer.effectiveScaleRange.maxScale))).map((e=>e.layer.subtypeCode));if(!t.length)return{mode:"none-visible",filter:null};if(t.length===e.subtypes.length)return{mode:"all-visible",filter:null};const i=e.fieldsIndex.get(e.subtypeField)?.name??e.subtypeField;return 1===t.length?{mode:"in-use",filter:`${i} = ${t.getItemAt(0)}`}:{mode:"in-use",filter:`${i} IN (${t.join(", ")})`}}get floorFilter(){const{view:e,layer:r}=this;return e&&r?c.getFloorFilterClause({view:e,layer:r}):null}constructor(e){super(e),this.rulesTable=null,this._valid=!1}initialize(){if(!this.snappingSource||!this.layer)return;const{layer:e,snappingSource:r}=this;if("refresh"in e){const t=e;this.addHandles(t.on("refresh",(()=>r.refresh())))}this.loadRules(),this.addHandles([o.watch((()=>r.updating),(e=>r.layerSource.updating=e),o.syncAndInitial),o.watch((()=>r.availability),(e=>r.layerSource.availability=e),o.syncAndInitial)])}getFetchCandidatesParameters(e,r,t){if(!this.valid)return[];const{layer:i,layerView:o,floorFilter:l,rulesTable:n,subtypeFilter:s}=this,u={distance:t,mode:this.view?.type??"2d",point:e,coordinateHelper:r.coordinateHelper,...this._types,filter:o&&"filter"in o?o.filter:null};if(l&&(u.filter=g(u.filter,l)),"not-in-use"!==s.mode&&"all-visible"!==s.mode){if("none-visible"===s.mode)return[];u.filter?u.filter.where=a.sqlAnd(u.filter.where,s.mode):u.filter=new p({where:s.filter})}const c=r.feature,f="subtype-sublayer"===c?.sourceLayer?.type?c.sourceLayer.parent:c?.sourceLayer;if(n&&c&&d.isUtilityNetworkWebMap(this.view?.map)&&(y.isFeatureLayer(i)||y.isSubtypeGroupLayer(i))&&i.layerId&&(y.isFeatureLayer(f)||y.isSubtypeGroupLayer(f))&&this.view.map.utilityNetworks?.find((e=>e.isUtilityLayer(f)))){if("loaded"!==n.loadStatus)return[];const e=[],r=i.layerId,t=n.getFeatureSQL(f,c)?.[r];if(!t)return[];const o=t.anyVertex;let a=t.endVertex;return a&&o&&a===o&&(a=""),a&&e.push({...u,returnEdge:!1,vertexMode:"ends",filter:g(u.filter,a)}),o&&e.push({...u,returnEdge:!1,vertexMode:"all",filter:g(u.filter,o)}),e}return[u]}async loadRules(){const{layer:e,view:r}=this;if(e&&r&&d.isUtilityNetworkWebMap(r?.map)&&(y.isFeatureLayer(e)||y.isSubtypeGroupLayer(e))){const o=r.map.utilityNetworks?.find((r=>r.isUtilityLayer(e)));if(o)try{this.rulesTable=await o.getRulesTable(),await(this.rulesTable?.load())}catch(t){return void i.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}}this._valid=!0}get _types(){return{returnEdge:!0,vertexMode:"all"}}remove(){this.destroy()}destroy(){this.snappingSource?.destroy()}},r.__decorate([l.property({constructOnly:!0})],e.FeatureSnappingSourceInfo.prototype,"layer",void 0),r.__decorate([l.property({constructOnly:!0})],e.FeatureSnappingSourceInfo.prototype,"snappingSource",void 0),r.__decorate([l.property({constructOnly:!0})],e.FeatureSnappingSourceInfo.prototype,"view",void 0),r.__decorate([l.property()],e.FeatureSnappingSourceInfo.prototype,"layerView",null),r.__decorate([l.property()],e.FeatureSnappingSourceInfo.prototype,"rulesTable",void 0),r.__decorate([l.property()],e.FeatureSnappingSourceInfo.prototype,"valid",null),r.__decorate([l.property()],e.FeatureSnappingSourceInfo.prototype,"subtypeFilter",null),r.__decorate([l.property()],e.FeatureSnappingSourceInfo.prototype,"floorFilter",null),r.__decorate([l.property()],e.FeatureSnappingSourceInfo.prototype,"_valid",void 0),e.FeatureSnappingSourceInfo=r.__decorate([u.subclass("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],e.FeatureSnappingSourceInfo),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
