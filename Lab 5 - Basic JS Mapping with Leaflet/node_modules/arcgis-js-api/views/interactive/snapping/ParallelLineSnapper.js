/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../support/elevationInfoUtils","../sketch/normalizedPoint","./Settings","./SnappingAlgorithm","./snappingUtils","./candidates/ParallelLineSnappingCandidate","../support/viewUtils","../../support/geometry2dUtils"],(function(e,t,i,n,r,s,o,a,l,c,d){"use strict";class h extends o.SnappingAlgorithm{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,o=i.vertices.length,l=[];if(s<2)return l;const{view:d}=this,h=c.vectorToScreenPoint(e,t.spatialReference,n.absoluteHeightElevationInfo,d),p=r.fromAnyMapPoint(i.vertices[o-1].pos,d,t),g=r.fromAnyMapPoint(i.vertices[0].pos,d,t),f=i.edges[s-1];let u=f;do{if(this.edgeExceedsShortLineThreshold(u,t)){const i=a.editEdgeToSnappingEdge(u,d,t);this._checkEdgeForParallelLines(i,p,e,h,t,l),this._checkEdgeForParallelLines(i,g,e,h,t,l)}u=u.leftVertex.leftEdge}while(u&&u!==f);return l}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,o=s.component;if(o.edges.length<3)return i;const{view:l}=this,d=c.vectorToScreenPoint(e,t.spatialReference,n.absoluteHeightElevationInfo,l),h=s.leftEdge,p=s.rightEdge,g=o.vertices[0],f=r.fromAnyMapPoint(g.pos,l,t),u=o.vertices.length,P=o.vertices[u-1],v=r.fromAnyMapPoint(P.pos,l,t),V=o.edges[0];let E=V;do{if(E!==h&&E!==p&&this.edgeExceedsShortLineThreshold(E,t)){const n=a.editEdgeToSnappingEdge(E,l,t);h&&this._checkEdgeForParallelLines(n,r.fromAnyMapPoint(h.leftVertex.pos,l,t),e,d,t,i),p&&this._checkEdgeForParallelLines(n,r.fromAnyMapPoint(p.rightVertex.pos,l,t),e,d,t,i),s===g?this._checkEdgeForParallelLines(n,v,e,d,t,i):s===P&&this._checkEdgeForParallelLines(n,f,e,d,t,i)}E=E.rightVertex.rightEdge}while(E&&E!==V);return i}_checkEdgeForParallelLines(e,i,o,h,g,f){const u=e.left,P=e.right;if(d.projectPointToLine(p,r.asVec2(i),r.asVec2(u),r.asVec2(P)),t.squaredDistance(p,r.asVec2(i))<s.defaults.parallelLineThreshold)return;d.projectPointToLine(p,r.asVec2(o),r.asVec2(u),r.asVec2(P),r.asVec2(i));const{spatialReference:v,pointer:V}=g,E=r.fromValues(p[0],p[1],o[2]);if(a.squaredScreenDistance(h,c.vectorToScreenPoint(E,v,n.absoluteHeightElevationInfo,this.view))<this.squaredProximityThreshold(V)){if(this.isVertical(E,i,g)||this.isVertical(u,P,g))return;if(this._parallelToPreviousCandidate(e,f))return;f.push(new l.ParallelLineSnappingCandidate({referenceLine:e,lineStart:i,targetPoint:E,isDraped:"on-the-ground"===g.elevationInfo?.mode}))}}_parallelToPreviousCandidate(e,i){const n=e.left,o=e.right;for(const a of i)if(d.projectPointToLine(p,r.asVec2(o),r.asVec2(a.constraint.start),r.asVec2(a.constraint.end),r.asVec2(n)),t.squaredDistance(p,r.asVec2(o))<s.defaults.parallelLineThreshold)return a.addReferenceLine(e),!0;return!1}}const p=i.create();e.ParallelLineSnapper=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
