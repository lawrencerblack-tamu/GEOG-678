/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../chunks/tslib.es6","../core/arrayUtils","../core/Collection","../core/Evented","../core/MapUtils","../core/maybe","../core/ReactiveMap","../core/reactiveUtils","../core/SetUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/accessorSupport/decorators/subclass","../layers/support/layerUtils","../rest/support/Query"],(function(e,t,s,i,n,o,r,l,c,a,h,u,d,p,y){"use strict";let f=class extends i.EventedAccessor{constructor(e){super(e),this._selectionMap=new r,this._trashCan=[],this._layerEditHandles=new s,this._vizTaskId=0,this.showHighlight=!0}initialize(){this.addHandles([l.watch((()=>[this.view,this.showHighlight]),(()=>this._refreshVisualization())),l.on((()=>this.sources),"change",(e=>{const t=this._selectionMap;for(const s of e.removed)t.delete(s);this._refreshListeners(),this._refreshVisualization()}),{onListenerAdd:()=>this._refreshListeners()})]);const e=new s;this.view.when().then((()=>{this.view.map.allLayers.flatten((e=>"sublayers"in e&&e.sublayers?e.sublayers:null)).forEach((t=>{(_(t)&&!p.isSubtypeGroupLayer(t)||p.isSubtypeSublayer(t))&&e.add(t)})),this._set("sources",e)}))}destroy(){this._layerEditHandles.drain(o.removeMaybe)}get selections(){return Array.from(this._selectionMap.entries()).map((e=>{const[t,s]=e;return{layer:t,selection:[...s.selection]}}))}get count(){let e=0;for(const t of this._selectionMap.values())e+=t.selection.length;return e}get hasSelection(){return this.count>0}get sources(){return this._get("sources")}set sources(e){this._set("sources",e)}async getSelectedFeatures(e,t={},s="layerView"){const{view:i,selections:n}=this,o=(void 0!==e?n.filter((t=>e.includes(t.layer))):n).filter((e=>e.selection.length>0)).map((async e=>{const{layer:n,selection:o}=e,r=p.isSubtypeSublayer(n)?n.parent:n;if(null==r||!v(r))return null;if("layer"===s)return w(r,o,t);const l=await i.whenLayerView(r);return w(l,o,t)}));return(await Promise.all(o)).filter((e=>null!==e))}updateSelection(e){const s=new Map;for(const[t,n]of this._selectionMap)s.set(t,[...n.selection]);let i=!1;const o=e.current.concat(e.added);for(const t of o){const e=t.sourceLayer,o=t.getObjectId();if(this.sources.includes(e)&&(_(e)||p.isSubtypeSublayer(e))&&null!==o){const t=n.getOrCreateMapValue(s,e,(()=>[]));t.includes(o)||(t.push(o),i=!0)}}for(const t of e.removed){const e=t.sourceLayer,n=t.getObjectId();if(this.sources.includes(e)&&(_(e)||p.isSubtypeSublayer(e))&&null!==n){const t=s.get(e),o=t?.indexOf(n);void 0!==o&&o>=0&&(t?.splice(o,1),i=!0)}}if(i){const{_selectionMap:e,_trashCan:i}=this,n=[];for(const[o,r]of s){const s=e.get(o);void 0!==s&&i.push(s),e.set(o,{selection:r}),n.push({layer:o,selection:r,...t.difference(void 0!==s?s.selection:[],r)})}this._onSelectionChange(n)}}setSelection(e,t){this._setSelection(e,t)}getSelection(e){const t=this._selectionMap.get(e);return t?.selection}appendToSelection(e,t){const s=this._selectionMap.get(e),i=void 0!==s?[...s.selection]:[];for(const n of t)i.includes(n)||i.push(n);this._setSelection(e,i)}removeFromSelection(e,t){const s=this._selectionMap.get(e);if(!s)return;const i=[];for(const n of s.selection)t.includes(n)||i.push(n);this._setSelection(e,i)}toggleInSelection(e,t){const s=this._selectionMap.get(e);if(!s||0===s.selection.length)return void this._setSelection(e,t);const i=new Set(s.selection),n=new Set(t),o=c.symmetricDifference(i,n);this._setSelection(e,Array.from(o))}clear(){const e=this._selectionMap.values();this._trashCan.push(...e);const t=[];for(const[s,i]of this._selectionMap.entries())t.push({layer:s,added:[],removed:[...i.selection],selection:[]});this._selectionMap.clear(),this._onSelectionChange(t)}_onSelectionChange(e){this._refreshVisualization(),this.emit("selection-change",{view:this.view,changes:e})}_refreshVisualization(){if(null==this.view||null==this.sources)return;for(this._vizTaskId++;this._trashCan.length>0;){const e=this._trashCan.pop();e?.highlightHandle?.remove()}const{sources:e,view:t,_selectionMap:s,showHighlight:i}=this,n=this._vizTaskId;for(const o of e){const e=s.get(o),r=p.isSubtypeSublayer(o)?o.parent:o;null!=r&&v(r)&&t.whenLayerView(r).then((t=>{e?.highlightHandle?.remove(),void 0!==e&&i&&n===this._vizTaskId&&"highlight"in t&&"function"==typeof t.highlight&&e.selection.length>0&&(e.highlightHandle=t.highlight(e.selection,"selection"))}))}}_refreshListeners(){this._layerEditHandles.drain(o.removeMaybe);for(const e of this.sources){const t=p.isSubtypeSublayer(e)?e.parent:e;if(null!=t&&_(t)){const s=t.on("edits",(t=>{this._handleEditChanges(t,e)}));this._layerEditHandles.push(s)}}}_handleEditChanges(e,s){if(void 0!==e.deletedFeatures&&e.deletedFeatures.length>0&&this._selectionMap.has(s)){const i=e.deletedFeatures.filter((e=>null==e.error)).map((e=>e.objectId)).filter(t.isSome);this.removeFromSelection(s,i)}}_setSelection(e,s){if(!this.sources.includes(e))throw new Error(`Cannot set selection on layer ${e.title} because it is not in 'sources'`);const i=this._selectionMap.get(e);if(void 0===i||!S(i,{selection:s})){void 0!==i&&this._trashCan.push(i),this._selectionMap.set(e,{selection:[...s]});const n={layer:e,selection:[...s],...t.difference(void 0!==i?i.selection:[],s)};this._onSelectionChange([n])}}};e.__decorate([a.property({readOnly:!0,nonNullable:!0})],f.prototype,"selections",null),e.__decorate([a.property({readOnly:!0,nonNullable:!0})],f.prototype,"count",null),e.__decorate([a.property({constructOnly:!0,nonNullable:!0})],f.prototype,"view",void 0),e.__decorate([a.property({readOnly:!0,nonNullable:!0})],f.prototype,"hasSelection",null),e.__decorate([a.property()],f.prototype,"showHighlight",void 0),e.__decorate([a.property()],f.prototype,"sources",null),f=e.__decorate([d.subclass("esri.views.SelectionManager")],f);const _=e=>void 0!==e.createQuery&&void 0!==e.on,g=e=>void 0!==e.layer,v=e=>void 0!==e?.when,S=(e,t)=>{if(null==e&&null==t)return!0;if(null!=e&&null==t||null==e&&null!=t)return!1;if(null!=e&&null!=t&&null!=e.selection&&null!=t.selection){const s=[...e.selection],i=[...t.selection];if(s.length!==i.length)return!1;s.sort(),i.sort();for(let e=0;e<s.length;e++)if(s[e]!==i[e])return!1}return!0},w=async(e,t,s={})=>{let i;if(g(e)){const n=e;i=void 0===n?null:await n.queryFeatures(new y({...s,objectIds:t})).then((t=>({data:t,layer:e.layer})))}else{const n=e;i=void 0===n?null:await n.queryFeatures(new y({...s,objectIds:t})).then((e=>({data:e,layer:n})))}return i};return f}));
