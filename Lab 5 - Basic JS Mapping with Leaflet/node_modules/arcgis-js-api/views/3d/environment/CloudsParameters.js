/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../core/mathUtils","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/axisAngleDegrees","../../../geometry/support/Ellipsoid","./CloudsData","./weather","../../support/RenderState"],(function(e,t,a,i,s,o,d,r,h,n,c){"use strict";class F{constructor(){this.readChannels=h.CloudsTextureChannels.RG,this.renderingStage=h.CloudsRenderingStages.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=o.create(),this.parallax=new u,this.parallaxNew=new u,this.pointOnGround=o.create(),this.fadeMode=e.FadeMode.HIDE,this.fadeFactor=0,this.opacity=0}updateParallax(t){const o=this.parallax,h=s.length(t.eye);if(o.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(h*h-r.earth.radius*r.earth.radius,0))/h,d.fromPoints(f,o.anchorPointClouds,p),a.rotate(o.transform,i.IDENTITY,p[3],d.axis(p)),this.fadeMode===e.FadeMode.CROSS_FADE){const e=this.parallaxNew;d.fromPoints(f,e.anchorPointClouds,p),a.rotate(e.transform,i.IDENTITY,p[3],d.axis(p))}}updateFading(e,t,a,i){this.isFading&&this._advanceFading(a,i),this._evaluateFading(e,t,a)}_evaluateFading(t,a,i){const s=t.relativeElevation,o=this._calculateDistanceToAnchorPoint(t);if((s>1.7*n.weatherHeightLimit||s<-n.weatherHeightLimit||o>E)&&this.opacity>0)this._setFade(e.FadeMode.HIDE,i);else if(!this.isFading)if((s>n.weatherHeightLimit||s<-.35*n.weatherHeightLimit||o>_)&&this.opacity>0)this._setFade(e.FadeMode.FADE_OUT,i);else if(s<=n.weatherHeightLimit&&s>=-.35*n.weatherHeightLimit&&a===c.RenderState.IDLE&&h.ensureClouds(this.data)){if(0===this.opacity)return void this._setFade(e.FadeMode.FADE_IN,i);(o>D||this.renderingStage===h.CloudsRenderingStages.FADING)&&this._setFade(e.FadeMode.CROSS_FADE,i)}}_advanceFading(e,t){this._switchReadChannels(),this._updateAnchorPoint(),this._advanceFadingFactorAndOpacity(e,t)}_advanceFadingFactorAndOpacity(a,i){if(this.fadeFactor<1)return this.fadeFactor=i?t.clamp((a-this.startTime)/(g*i),0,1):1,this.fadeMode===e.FadeMode.FADE_OUT&&(this.opacity=1-this.fadeFactor),this.fadeMode===e.FadeMode.FADE_IN&&(this.opacity=this.fadeFactor),void(this.fadeMode===e.FadeMode.CROSS_FADE&&(this.opacity=1));this.fadeFactor=0,this.fadeMode===e.FadeMode.FADE_OUT&&(this.opacity=0),this.fadeMode===e.FadeMode.FADE_IN&&(this.opacity=1),this.fadeMode===e.FadeMode.CROSS_FADE&&(this.opacity=1),this.fadeMode=e.FadeMode.NONE}_switchReadChannels(){const t=this.fadeMode===e.FadeMode.CROSS_FADE&&1===this.fadeFactor,a=this.fadeMode===e.FadeMode.FADE_IN&&0===this.fadeFactor;this.renderingStage===h.CloudsRenderingStages.FADING&&(t||a)&&(this.readChannels=1-this.readChannels,this.renderingStage=h.CloudsRenderingStages.FINISHED)}_calculateDistanceToAnchorPoint(e){return s.normalize(this.pointOnGround,e.eye),s.scale(this.pointOnGround,this.pointOnGround,r.earth.radius),s.length(s.subtract(M,this.parallax.anchorPointClouds,this.pointOnGround))}_updateAnchorPoint(){this.fadeMode===e.FadeMode.CROSS_FADE&&(0===this.fadeFactor&&s.copy(this.parallaxNew.anchorPointClouds,this.pointOnGround),1===this.fadeFactor&&s.copy(this.parallax.anchorPointClouds,this.parallaxNew.anchorPointClouds)),this.fadeMode===e.FadeMode.FADE_IN&&0===this.fadeFactor&&s.copy(this.parallax.anchorPointClouds,this.pointOnGround)}_setFade(t,a){switch(t){case e.FadeMode.HIDE:this.opacity=0;break;case e.FadeMode.FADE_OUT:this.opacity=1;break;case e.FadeMode.FADE_IN:this.opacity=0;break;case e.FadeMode.CROSS_FADE:this.opacity=1}this.fadeMode=t,this.fadeFactor=0,this.startTime=a}get isFading(){return this.fadeMode===e.FadeMode.FADE_OUT||this.fadeMode===e.FadeMode.FADE_IN||this.fadeMode===e.FadeMode.CROSS_FADE}}var l;e.FadeMode=void 0,(l=e.FadeMode||(e.FadeMode={}))[l.NONE=0]="NONE",l[l.HIDE=1]="HIDE",l[l.FADE_OUT=2]="FADE_OUT",l[l.FADE_IN=3]="FADE_IN",l[l.CROSS_FADE=4]="CROSS_FADE";class u{constructor(){this.anchorPointClouds=o.create(),this.radiusCurvatureCorrectionFactor=0,this.transform=i.create()}}const f=o.fromValues(0,0,1),p=d.create(),M=o.create(),g=1.25,D=34e3,_=64e3,E=2e5;e.CloudsParameters=F,e.crossFadeDistanceThreshold=D,e.fadeOutDistanceThreshold=_,e.hideDistanceThreshold=E,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
