/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/FloatArray","../../../../../geometry/support/Indices","../../../../ViewingMode","./ComponentIntersectionData","../../lib/Attribute","../../lib/ComponentUtils","../../materials/internal/MaterialUtil"],(function(t,n,e,o,s,i,a,c,r,m,p,h,d){"use strict";class l{constructor(t,n,e){this.viewingMode=t,this.positionData=n,this._components=e,this._planetCenter=o.create(),this._planetNorth=o.create(),this._componentIndicesForBsp=null,this._componentBspNodes=[],this._aabb=[0,0,0,0,0,0],this._indices=n.indices?c.compactIndices(n.indices):c.getContinuousIndexArray(n.positions.length/3),this._positions=n.positions,this._componentIntersectionData=new Array(e.count)}destroy(){this._positions=null,this._indices=null,this._componentIntersectionData.length=0,this._perComponentAabbs=null}getComponentAabb(t,n){const e=this._ensureComponentAabbs(),o=6*t;return n[0]=e[o],n[1]=e[o+1],n[2]=e[o+2],n[3]=e[o+3],n[4]=e[o+4],n[5]=e[o+5],n}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(t,n){n.indices=this._indices,n.data=this._positions,n.stride=3,n.startIndex=this._components.offsets[t],n.endIndex=this._components.offsets[t+1]}intersect(n,o,s,i,a,c,h,l){const{position:x}=h,_=e.sub(u,n,x),v=e.sub(C,o,x),w=t.invert(f,h.rotationScale);e.transformMat3(_,_,w),e.transformMat3(v,v,w);const B=t.transpose(M,w),D=new p.Vertices(this._positions,3),z=this._indices,N=this._components.offsets,V=d.computeInvDir(_,v,b);if(this.viewingMode===r.ViewingMode.Global){const t=this._planetCenter;e.negate(t,x),e.transformMat3(t,t,w);const n=this._planetNorth;e.set(n,0,0,1),e.transformMat3(n,n,w),e.normalize(n,n)}const k=e.copy(g,_),F=e.copy(A,v),P=e.sub(y,v,_);e.normalize(P,P);const R=t=>{const n=this.getComponentAabb(t,I);if(null!=a){const n=a[t];null==i||l?(_[2]=k[2]-n,v[2]=F[2]-n):i.componentOffset=n}if(null==i||l||i.applyToAabb(n),!d.intersectAabbInvDir(n,_,V,s))return;const o=N[t]/3,r=N[t+1]/3,p=(n,o,s)=>c(t,n,e.transformMat3(o,o,B),s);(null==i||l)&&r-o>m.componentMinimalSizeForIntersectionData?(null==this._componentIntersectionData[t]&&(this._componentIntersectionData[t]=new m.ComponentIntersectionData(this._indices,o,r,D)),this._componentIntersectionData[t].intersectRay(_,v,p)):d.intersectTriangles(_,v,o,r,z,D,void 0,i,p)};this._intersectComponents(R,l,_,v)}_intersectComponents(t,n,o,s){const i=this._components.pickability,a=this._components.visibility;if(this._components.visibility.componentCount<k){const n=n=>(h.getVisibility(i,n)&&t(n),!0);return void a.forEachComponent(n)}0===this._componentBspNodes.length&&this._generateComponentBspRoot();const c=this._componentIndicesForBsp,r=n=>{h.getVisibility(i,n)&&a.isVisible(n)&&t(n)},m=(t,n)=>{for(let e=t;e<n;++e)r(c[e])};if(n){let t=0;for(;t>=0;){const n=this._componentBspNodes[t],s=n.plane;if(!s||-1===n.child0&&-1===n.child1){m(n.minComponentIndexIndex,n.maxComponentIndexIndex);break}{m(n.minMidComponentIndexIndex,n.maxMidComponentIndexIndex);const i=e.dot(s,o)-s[3];if(i<0){if(-1===n.child0){m(n.minComponentIndexIndex,n.minMidComponentIndexIndex);break}t=n.child0}else{if(!(i>0))break;if(-1===n.child1){m(n.maxMidComponentIndexIndex,n.maxComponentIndexIndex);break}t=n.child1}}}}else{const t=F;e.sub(t,s,o),e.normalize(t,t);const n=this._componentBspNodes,i=s=>{const a=n[s],c=a.plane;if(!c||-1===a.child0&&-1===a.child1)m(a.minComponentIndexIndex,a.maxComponentIndexIndex);else{const n=e.dot(c,o)-c[3],s=e.dot(c,t);a.minComponentIndexIndex<a.minMidComponentIndexIndex&&(n<=0||s<0)&&(-1!==a.child0?i(a.child0):m(a.minComponentIndexIndex,a.minMidComponentIndexIndex)),m(a.minMidComponentIndexIndex,a.maxMidComponentIndexIndex),a.maxMidComponentIndexIndex<a.maxComponentIndexIndex&&(n>=0||s>0)&&(-1!==a.child1?i(a.child1):m(a.maxMidComponentIndexIndex,a.maxComponentIndexIndex))}};i(0)}}_generateComponentBspRoot(){const t=this._components.count,n=new Uint16Array(t);this._componentIndicesForBsp=n;for(let e=0;e<t;++e)n[e]=e;const o=this._ensureComponentAabbs(),i=this._planetCenter,a=this._planetNorth,c=B;e.negate(c,i),e.normalize(c,c);const m=D;e.cross(m,a,c);const p=this._aabb,h=p[2],d=[];let l=0;const b=this._componentBspNodes;b.length=0;const I=(t,n)=>{const s=6*t,i=o[s],a=o[s+1],c=o[s+2],r=o[s+3],m=o[s+4],p=o[s+5],h=e.set(z,.5*(i+r),.5*(a+m),.5*(c+p)),d=.5*(r-i),l=.5*(m-a),x=.5*(p-c),b=Math.sqrt(d*d+l*l+x*x),I=n,_=n[3],u=e.dot(I,h)-_;return Math.abs(u)>b?Math.sign(u):0},u=(t,e,s)=>{let i=1/0,a=1/0,c=1/0,r=-1/0,m=-1/0,p=-1/0;for(let h=e;h<s;++h){const t=6*n[h];i=Math.min(i,o[t]),r=Math.max(r,o[t+3]),a=Math.min(a,o[t+1]),m=Math.max(m,o[t+4]),c=Math.min(c,o[t+2]),p=Math.max(p,o[t+5])}t[0]=i,t[1]=a,t[2]=c,t[3]=r,t[4]=m,t[5]=p},C=this.viewingMode===r.ViewingMode.Local;let f=!1;if(!C){const t=e.set(z,.5*(p[0]+p[3]),.5*(p[1]+p[4]),.5*(p[2]+p[5])),n=e.dist(i,t);f=h>.5*n}const M=(t,o,c,r,m)=>{const p=b.length;let h;if(f||c>=V||o-t<N)h=new x(t,o,o,o,null);else{u(_,t,o);const r=_[0],m=_[1],l=_[2],b=_[3],f=_[4],g=b-r,A=f-m,y=s.create(),B=y;if(C)g>=A?(e.set(B,1,0,0),y[3]=-.5*(r+b)):(e.set(B,0,1,0),y[3]=-.5*(m+f));else{const t=v,n=w,o=.5*(r+b),s=.5*(m+f);e.set(t,o,s,l),e.sub(t,t,i),e.normalize(t,t),e.cross(n,t,a),e.normalize(n,n),g>=A?e.copy(B,n):(e.cross(B,n,t),e.normalize(B,B)),y[3]=e.dot(B,i)}let D,z;{let e=t,s=o;for(;e<s;){const t=n[e];I(t,y)<0?++e:(--s,n[e]=n[s],n[s]=t)}D=e;let i=e;for(s=o;i<s;){const t=n[s-1];I(t,y)>0?--s:(n[s-1]=n[i],n[i]=t,++i)}z=s}h=new x(t,D,z,o,y),D>=t+N&&d.push((()=>M(t,D,c+1,p,!0))),o>=z+N&&d.push((()=>M(z,o,c+1,p,!1)))}if(b.push(h),-1!==r){const t=b[r];m?t.child0=p:t.child1=p}};for(d.push((()=>M(0,t,0,-1,!1)));l<d.length;){(0,d[l])(),++l}}_computePerComponentAabbs(){const t=this._components.count,n=a.newFloatArray(6*t),e=this._indices,o=this._positions,s=this._components.offsets;let i=0,c=1/0,r=1/0,m=1/0,p=-1/0,h=-1/0,d=-1/0;for(let a=0;a<t;a++){const t=s[a],l=s[a+1];let x=1/0,b=1/0,I=1/0,_=-1/0,u=-1/0,C=-1/0;for(let n=t;n<l;n++){const t=3*e[n],s=o[t],i=o[t+1],a=o[t+2];x=Math.min(x,s),b=Math.min(b,i),I=Math.min(I,a),_=Math.max(_,s),u=Math.max(u,i),C=Math.max(C,a)}n[i++]=x,n[i++]=b,n[i++]=I,n[i++]=_,n[i++]=u,n[i++]=C,c=Math.min(c,x),r=Math.min(r,b),m=Math.min(m,I),p=Math.max(p,_),h=Math.max(h,u),d=Math.max(d,C)}return this._aabb[0]=c,this._aabb[1]=r,this._aabb[2]=m,this._aabb[3]=p,this._aabb[4]=h,this._aabb[5]=d,n}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}}class x{constructor(t,n,e,o,s){this.minComponentIndexIndex=t,this.minMidComponentIndexIndex=n,this.maxMidComponentIndexIndex=e,this.maxComponentIndexIndex=o,this.plane=s,this.child0=-1,this.child1=-1}}const b=o.create(),I=i.create(),_=[0,0,0,0,0,0],u=o.create(),C=o.create(),f=n.create(),M=n.create(),g=o.create(),A=o.create(),y=o.create(),v=o.create(),w=o.create(),B=o.create(),D=o.create(),z=o.create(),N=5,V=10,k=7,F=o.create();return l}));
