/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/PooledArray","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../core/libs/gl-matrix-2/math/quat","../../../../../core/libs/gl-matrix-2/factories/quatf64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/plane","../../lib/depthRange"],(function(t,e,n,r,o,a,c,s,l,i){"use strict";function u(t,e){const n=i.empty(),{eye:r,frustum:o,viewForward:a}=t;e.forAll((t=>{const e=null!=t.offsetObb?t.offsetObb:t.obb,s=c.dot(c.sub(S,e.center,r),a),l=e.projectedRadius(a);if(i.within(n,s-l)&&i.within(n,s+l))return;const u=O(e,o);if(-1===u)return;if(0===u)return b.far=s+l,b.near=s-l,void i.union(n,b);const h=f.pushNew();h.near=s-l,h.far=s+l,h.mask=u,h.object=t}));for(let s=0;s<f.length;s++){const t=f.data[s];if(i.within(n,t.near)&&i.within(n,t.far))continue;b.far=t.far,b.near=1/0;const e=y(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,r,g,(e=>{let n=m;for(let r=0;r<v&&e.length>0;r++){if(0==(t.mask&1<<r))continue;p(o[r],e,n);const a=e;e=n,n=a}for(let t=0;t<e.length;t+=3){c.set(h,e.data[t],e.data[t+1],e.data[t+2]);const n=c.dot(c.sub(h,h,r),a);b.near=Math.min(b.near,n)}}));0===e&&(b.near=0),i.union(n,b)}return f.length=0,n}const f=new e({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),b=i.empty(),h=s.create(),d=s.create(),g=new e({deallocator:null}),m=new e({deallocator:null});function p(t,e,n){n.length=0;const r=e.length-3;w(h,e,r);const o=l.signedDistance(t,h);o<=0&&(n.push(h[0]),n.push(h[1]),n.push(h[2]));let a=0,s=o;for(;a<r;a+=3){w(d,e,a);const r=l.signedDistance(t,d);if(s*r<0){const t=r/(r-s);c.lerp(h,d,h,t),j(n,h)}r<=0&&j(n,d),s=r,c.copy(h,d)}if(s*o<0){w(d,e,r);const t=o/(o-s);c.lerp(h,d,h,t),j(n,h)}}function w(t,e,n){return c.set(t,e.data[n],e.data[n+1],e.data[n+2])}function j(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2])}function y(t,e,r,a){o.conjugate(q,t.quaternion),c.sub(S,e,t.center),c.transformQuat(S,S,q);const s=t.halfSize,l=8*((S[0]<-s[0]?-1:S[0]>s[0]?1:0)+3*(S[1]<-s[1]?-1:S[1]>s[1]?1:0)+9*(S[2]<-s[2]?-1:S[2]>s[2]?1:0)+13),i=x[l];if(0===i)return i;n.fromQuat(k,t.quaternion),n.scale(k,k,t.halfSize);const u=(e,n)=>{const r=x[l+n+1];return c.set(e,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),c.transformMat3(e,e,k),c.add(e,t.center,e)};return r.length=0,j(r,u(A,0)),j(r,u(D,1)),j(r,u(S,2)),j(r,u(M,3)),a(r),1===i?i:(r.length=0,j(r,A),j(r,M),j(r,u(S,4)),j(r,u(P,5)),a(r),2===i||(r.length=0,j(r,A),j(r,P),j(r,u(S,6)),j(r,D),a(r)),i)}const x=(()=>{const t=new Array(216);let e=0;const n=n=>{for(let r=0;r<n.length;r++)t[e+r]=n[r];e+=8};return n([3,0,6,2,3,1,5,4]),n([2,0,2,3,1,5,4,0]),n([3,1,0,2,3,7,5,4]),n([2,0,1,3,2,6,4,0]),n([1,0,1,3,2,0,0,0]),n([2,1,5,7,3,2,0,0]),n([3,2,0,1,3,7,6,4]),n([2,2,0,1,3,7,6,0]),n([3,3,0,1,5,7,6,2]),n([2,0,1,5,4,6,2,0]),n([1,0,1,5,4,0,0,0]),n([2,1,3,7,5,4,0,0]),n([1,0,2,6,4,0,0,0]),n([0,0,0,0,0,0,0,0]),n([1,1,3,7,5,0,0,0]),n([2,2,3,7,6,4,0,0]),n([1,2,3,7,6,0,0,0]),n([2,3,1,5,7,6,2,0]),n([3,4,0,1,5,7,6,2]),n([2,5,7,6,4,0,1,0]),n([3,5,0,1,3,7,6,4]),n([2,4,5,7,6,2,0,0]),n([1,4,5,7,6,0,0,0]),n([2,5,1,3,7,6,4,0]),n([3,6,0,2,3,7,5,4]),n([2,6,2,3,7,5,4,0]),n([3,7,6,2,3,1,5,4]),t})(),v=4;function O(t,e){let n=0;for(let r=0;r<v;r++){const o=t.intersectPlane(e[r]);if(o>0)return-1;0===o&&(n|=1<<r)}return n}const k=r.create(),q=a.create(),S=s.create(),A=s.create(),D=s.create(),M=s.create(),P=s.create();t.computeDepthRange=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
