/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/tslib.es6","../../../../../../core/has","../../../../../../core/maybe","../../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../chunks/vec42","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../layers/support/symbolColorUtils","../../../../terrain/OverlayContent","./ComponentTechnique","./ComponentTechniqueConfiguration","./shader/ComponentData.glsl","./shader/VertexDiscardByOpacity.glsl","../../../core/material/MaterialBase","../../../core/renderPasses/AllRenderPasses","../../../core/shaderLibrary/ShaderOutput","../../../core/shaderLibrary/attributes/NormalAttribute.glsl","../../../core/shaderLibrary/shading/Normals.glsl","../../../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../../../core/shaderLibrary/util/AlphaCutoff","../../../core/shaderLibrary/util/EllipsoidMode","../../../core/util/TwoVectorPosition","../../../lib/basicInterfaces","../../../lib/TransparencyPassType","../../../materials/pbrUtils"],(function(e,t,r,a,o,s,i,n,l,u,d,p,c,m,h,y,M,g,x,T,v,C,b,P,_,f,S,O){"use strict";class w extends M.MaterialBase{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=u.fromValues(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=n.fromArray(O.defaultAdvancedMRRFactors),this.emissiveFactor=n.fromValues(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new A,this.componentParameters=new q,this.textureAlphaCutoff=b.defaultMaskAlphaCutoff,this.alphaDiscardMode=f.AlphaDiscardMode.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=P.EllipsoidMode.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new m.ComponentTechniqueConfiguration;const r=new _.TwoVectorPosition(e.position),a=s.clone(e.rotationScale);o.invert(a,a),o.transpose(a,a),this.transformNormalGlobalFromModel=a,this.transformWorldFromModelTL=r.low,this.transformWorldFromModelTH=r.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=a.releaseMaybe(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return null!=this.baseColorTexture?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return null!=this.metallicRoughnessTexture?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return null!=this.emissionTexture?this.emissionTexture.glTexture:null}get textureOcclusion(){return null!=this.occlusionTexture?this.occlusionTexture.glTexture:null}get textureNormal(){return null!=this.normalTexture?this.normalTexture.glTexture:null}prepareTechnique(e,t,a,o){const s=this._techniqueConfiguration;s.hasVertexColors=o.colors,s.hasNormals=o.hasNormals,s.textureCoordinateType=o.textureCoordinates,s.hasMetallicRoughnessTexture=null!=this.metallicRoughnessTexture,s.hasEmissionTexture=null!=this.emissionTexture,s.hasOcclusionTexture=null!=this.occlusionTexture,s.hasNormalTexture=null!=this.normalTexture,s.transparencyPassType=t.identifier===g.RenderPassIdentifier.Material&&null!=a.transparencyPassType?a.transparencyPassType:S.TransparencyPassType.NONE,s.multipassEnabled=t.identifier===g.RenderPassIdentifier.Material&&a.multipassEnabled,s.cullAboveGround=t.identifier===g.RenderPassIdentifier.Material&&a.multipassTerrain.cullAboveGround,s.ellipsoidMode=this.ellipsoidMode,s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?v.NormalsDoubleSidedMode.View:v.NormalsDoubleSidedMode.None,s.hasColorTexture=null!=this.baseColorTexture;const i=this._computeWhichMaterialPass();if(s.blendingEnabled=i===D.Transparent||i===D.OpaqueAndTransparent,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?F(a)?B(a)?m.IntegratedMeshMode.ColorOverlayWithWater:m.IntegratedMeshMode.ColorOverlay:m.IntegratedMeshMode.NoOverlay:m.IntegratedMeshMode.None,s.hasPolygonOffset=this.polygonOffsetEnabled,s.pbrMode=s.integratedMeshMode===m.IntegratedMeshMode.ColorOverlayWithWater?C.PBRMode.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?r("enable-feature:im-shading")&&this.isIntegratedMesh?C.PBRMode.Simplified:C.PBRMode.Schematic:C.PBRMode.Normal:C.PBRMode.Disabled,s.normalType=o.needsNormals?s.hasNormals?T.NormalType.Compressed:T.NormalType.ScreenDerivative:T.NormalType.Ground,s.hasSlicePlane=null!=a.slicePlane&&this.commonMaterialParameters.hasSlicePlane,t.identifier===g.RenderPassIdentifier.ShadowMap)s.output=x.ShaderOutput.Shadow,s.vertexDiscardMode=y.VertexDiscardMode.None;else if(t.identifier===g.RenderPassIdentifier.Highlight)s.output=x.ShaderOutput.Highlight,s.vertexDiscardMode=y.VertexDiscardMode.None;else{switch(i===D.OpaqueAndTransparent?s.vertexDiscardMode=t.transparent?y.VertexDiscardMode.Opaque:y.VertexDiscardMode.Transparent:s.vertexDiscardMode=y.VertexDiscardMode.None,s.output=t.output,s.receiveAmbientOcclusion=!1,s.receiveShadows=!1,t.output){case x.ShaderOutput.Color:s.receiveAmbientOcclusion=null!=a.ssao,s.hasOccludees=a.hasOccludees,s.receiveShadows=a.shadowMap.ready,s.hasScreenSpaceReflections=null!=a.ssr.lastFrameColor,s.hasCloudsReflections=null!=a.cloudsFade.data;break;case x.ShaderOutput.Alpha:s.hasOccludees=a.hasOccludees;break;case x.ShaderOutput.ObjectAndLayerIdColor:s.objectAndLayerIdColor=!0}s.snowCover=this.hasSnowCover(a)}return this._technique=e.releaseAndAcquire(c.ComponentTechnique,s,this._technique),this._setClean(),this._technique}hasSnowCover(e){return null!=e.weather&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}submit(t,r,a){if(0===this.objectOpacity)return;const o=a.renderable.geometry,s=a.components,i=a.renderable.meta.cameraDepthSquared,n=s.geometryRanges,l=s.highlightRanges,u=s.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case D.Opaque:t.materialOpaque.submitDraw(this,o,n,i);break;case D.Transparent:t.materialTransparent.submitDraw(this,o,n,i);break;case D.OpaqueAndTransparent:t.materialOpaque.submitDraw(this,o,n,i),t.materialTransparent.submitDraw(this,o,n,i);break;case D.IntegratedMesh:t.materialIntegratedMesh.submitDraw(this,o,n,i),I(r)&&t.highlightIntegratedMesh.submitDraw(this,o,n,i)}const d=this.componentParameters.castShadows!==e.ComponentParameterSummary.None;d&&t.shadowMap.submitDraw(this,o,n,i),null!=l&&(t.highlight.submitDraw(this,o,l,i),d&&t.highlightShadowMap.submitDraw(this,o,l,i)),d&&null!=u&&t.defaultShadowMap.submitDraw(this,o,u,i)}_computeWhichMaterialPass(){return this.isIntegratedMesh?D.IntegratedMesh:this.objectOpacity<1?D.Transparent:this.componentParameters.opaqueOverride===e.ComponentParameterSummary.All?D.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===f.AlphaDiscardMode.Blend||this.alphaDiscardMode===f.AlphaDiscardMode.MaskBlend?D.Transparent:this.componentParameters.transparent===e.ComponentParameterSummary.None?D.Opaque:this.componentParameters.transparent===e.ComponentParameterSummary.All?D.Transparent:D.OpaqueAndTransparent}}var D,N;t.__decorate([M.parameter({vectorOps:l.vec4})],w.prototype,"baseColor",void 0),t.__decorate([M.parameter()],w.prototype,"usePBR",void 0),t.__decorate([M.parameter()],w.prototype,"hasParametersFromSource",void 0),t.__decorate([M.parameter({vectorOps:i.vec3})],w.prototype,"mrrFactors",void 0),t.__decorate([M.parameter({vectorOps:i.vec3})],w.prototype,"emissiveFactor",void 0),t.__decorate([M.parameter({dispose:!0})],w.prototype,"baseColorTexture",void 0),t.__decorate([M.parameter({dispose:!0})],w.prototype,"metallicRoughnessTexture",void 0),t.__decorate([M.parameter({dispose:!0})],w.prototype,"emissionTexture",void 0),t.__decorate([M.parameter({dispose:!0})],w.prototype,"occlusionTexture",void 0),t.__decorate([M.parameter({dispose:!0})],w.prototype,"normalTexture",void 0),t.__decorate([M.parameter()],w.prototype,"objectOpacity",void 0),t.__decorate([M.parameterBlock()],w.prototype,"commonMaterialParameters",void 0),t.__decorate([M.parameterBlock()],w.prototype,"componentParameters",void 0),t.__decorate([M.parameter()],w.prototype,"textureAlphaCutoff",void 0),t.__decorate([M.parameter()],w.prototype,"alphaDiscardMode",void 0),t.__decorate([M.parameter()],w.prototype,"isIntegratedMesh",void 0),t.__decorate([M.parameter()],w.prototype,"polygonOffsetEnabled",void 0),t.__decorate([M.parameter()],w.prototype,"ellipsoidMode",void 0),t.__decorate([M.parameter()],w.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(D||(D={}));class A extends M.MaterialParameterBlock{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=f.CullFaceOptions.Back,this.hasSlicePlane=!0}}t.__decorate([M.parameter()],A.prototype,"doubleSided",void 0),t.__decorate([M.parameter()],A.prototype,"cullFace",void 0),t.__decorate([M.parameter()],A.prototype,"hasSlicePlane",void 0);class q extends M.MaterialParameterBlock{constructor(){super(...arguments),this.externalColor=u.fromValues(1,1,1,1),this.externalColorMixMode=d.ColorMixModeEnum.Multiply,this.castShadows=e.ComponentParameterSummary.All}get transparent(){return this.externalColor[3]<1?e.ComponentParameterSummary.All:e.ComponentParameterSummary.None}get opaqueOverride(){return this.externalColorMixMode===d.ColorMixModeEnum.Replace&&1===this.externalColor[3]?e.ComponentParameterSummary.All:e.ComponentParameterSummary.None}get visible(){return this.externalColor[3]>0?e.ComponentParameterSummary.All:e.ComponentParameterSummary.None}get type(){return h.ComponentDataType.Uniform}}t.__decorate([M.parameter({vectorOps:l.vec4})],q.prototype,"externalColor",void 0),t.__decorate([M.parameter()],q.prototype,"externalColorMixMode",void 0),t.__decorate([M.parameter()],q.prototype,"castShadows",void 0),e.ComponentParameterSummary=void 0,(N=e.ComponentParameterSummary||(e.ComponentParameterSummary={}))[N.All=0]="All",N[N.Some=1]="Some",N[N.None=2]="None";class R extends M.MaterialParameterBlock{constructor(){super(...arguments),this.texture=null,this.transparent=e.ComponentParameterSummary.None,this.opaqueOverride=e.ComponentParameterSummary.None,this.castShadows=e.ComponentParameterSummary.None}get type(){return h.ComponentDataType.Varying}}function I(e){return null!=e.overlay?.getTexture(p.OverlayContent.Highlight)}function B(e){return null!=e.overlay?.getTexture(p.OverlayContent.WaterNormal)}function F(e){return null!=e.overlay?.getTexture(p.OverlayContent.ColorNoRasterImage)}t.__decorate([M.parameter()],R.prototype,"texture",void 0),t.__decorate([M.parameter()],R.prototype,"transparent",void 0),t.__decorate([M.parameter()],R.prototype,"opaqueOverride",void 0),t.__decorate([M.parameter()],R.prototype,"castShadows",void 0),e.CommonMaterialParameters=A,e.ComponentMaterial=w,e.ComponentParametersUniform=q,e.ComponentParametersVarying=R,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
