/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/buffer/BufferView","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../lib/basicInterfaces","../lib/GLMaterial","../lib/OrderIndependentTransparency","../lib/RenderSlot","../lib/Util","../lib/VertexAttribute","./DefaultBufferWriter","./PatternStyle","./TriangleMaterial","./VisualVariablePassParameters","./internal/bufferWriterUtils","../shaders/PatternTechnique"],(function(e,t,r,i,a,s,n,o,u,l,c,h,f,d,p,g,b,A){"use strict";class O extends p.TriangleMaterial{constructor(e){super(e,new _),this.supportsEdges=!0,this.produces=new Map([[l.RenderSlot.OPAQUE_MATERIAL,e=>s.isOIDorHighlight(e)],[l.RenderSlot.TRANSPARENT_MATERIAL,e=>s.isColorOrAlpha(e)],[l.RenderSlot.TRANSPARENT_NO_SSAO_DEPTH,e=>e===s.ShaderOutput.LinearDepth&&this.parameters.writeLinearDepth],[l.RenderSlot.DRAPED_MATERIAL,e=>this.parameters.draped&&e===s.ShaderOutput.Color||s.isOIDorHighlight(e)]]),this._vertexAttributeLocations=t("enable-feature:objectAndLayerId-rendering")?A.vertexAttributeLocationsOID:A.vertexAttributeLocations,this._configuration=new A.PatternTechniqueConfiguration}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<u.OITPolygonOffsetLimit,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}createGLMaterial(e){return new m(e)}createBufferWriter(){const e=a.newLayout().vec3f(h.VertexAttribute.POSITION).vec4f(h.VertexAttribute.UVMAPSPACE);return this.parameters.draped||e.mat3f(h.VertexAttribute.BOUNDINGRECT),this.parameters.vvColor?e.f32(h.VertexAttribute.COLORFEATUREATTRIBUTE):e.vec4u8(h.VertexAttribute.COLOR),t("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(h.VertexAttribute.OBJECTANDLAYERIDCOLOR),new S(e)}}class m extends o{_updateParameters(e){return this.ensureTechnique(A.PatternTechnique,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==s.ShaderOutput.Color&&this._output!==s.ShaderOutput.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class S extends f.DefaultBufferWriter{write(e,t,r,a,s){b.writeDefaultAttributes(r,this.vertexBufferLayout,e,t,a,s);for(const n of this.vertexBufferLayout.fields.keys()){const t=r.attributes.get(n),o=t?.indices;if(t&&o)switch(n){case h.VertexAttribute.UVMAPSPACE:{c.assert(4===t.size);const e=a.getField(n,i.BufferViewVec4f);e&&b.writeBufferVec4(t,e,s);break}case h.VertexAttribute.BOUNDINGRECT:{c.assert(9===t.size);const r=a.getField(n,i.BufferViewMat3f);r&&this.writeBoundingRect(t,e,r,s);break}}}}writeBoundingRect(e,t,r,i){const{data:a,indices:s}=e,n=t,o=r.typedBuffer,u=r.typedBufferStride,l=s.length;i*=u;for(let c=0;c<l;++c){const e=9*s[c],t=a[e],r=a[e+1],l=a[e+2];o[i]=n[0]*t+n[4]*r+n[8]*l+n[12],o[i+1]=n[1]*t+n[5]*r+n[9]*l+n[13],o[i+2]=n[2]*t+n[6]*r+n[10]*l+n[14];for(let s=3;s<9;++s)o[i+s]=a[e+s];i+=u}}}class _ extends g.VisualVariablePassParameters{constructor(){super(...arguments),this.color=r.fromValues(1,1,1,1),this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=n.CullFaceOptions.None,this.hasOccludees=!1,this.style=d.Style.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}}e.Parameters=_,e.PatternMaterial=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
