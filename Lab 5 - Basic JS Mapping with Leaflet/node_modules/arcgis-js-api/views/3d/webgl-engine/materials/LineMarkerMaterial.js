/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../lib/GLTextureMaterial","../lib/Material","../lib/RenderSlot","../lib/VertexAttribute","./VisualVariablePassParameters","../shaders/LineMarkerTechnique","../shaders/LineMarkerTechniqueConfiguration","../shaders/RibbonLineTechniqueConfiguration"],(function(e,t,r,a,i,s,n,u,h,o,c,l,p){"use strict";class d extends n.Material{constructor(e){super(e,new A),this.produces=new Map([[u.RenderSlot.OPAQUE_MATERIAL,e=>e===i.ShaderOutput.Highlight||i.isColorOrAlpha(e)&&this.parameters.renderOccluded===n.RenderOccludedFlag.OccludeAndTransparentStencil],[u.RenderSlot.OPAQUE_NO_SSAO_DEPTH,e=>e===i.ShaderOutput.LinearDepth],[u.RenderSlot.OCCLUDER_MATERIAL,e=>i.isColorAlphaHighlightOrDepth(e)&&this.parameters.renderOccluded===n.RenderOccludedFlag.OccludeAndTransparentStencil],[u.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,e=>i.isColorAlphaHighlightOrDepth(e)&&this.parameters.renderOccluded===n.RenderOccludedFlag.OccludeAndTransparentStencil],[u.RenderSlot.TRANSPARENT_MATERIAL,e=>i.isColorOrAlpha(e)&&this.parameters.writeDepth],[u.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>i.isColorOrAlpha(e)&&!this.parameters.writeDepth],[u.RenderSlot.DRAPED_MATERIAL,e=>e===i.ShaderOutput.Color||e===i.ShaderOutput.Highlight]]),this._vertexAttributeLocations=c.vertexAttributeLocations,this._configuration=new l.LineMarkerTechniqueConfiguration,this._layout=this.createLayout()}getConfiguration(e,t){return this._configuration.output=e,this._configuration.space=t.slot===u.RenderSlot.DRAPED_MATERIAL?l.LineMarkerSpace.Draped:this.parameters.worldSpace?l.LineMarkerSpace.World:l.LineMarkerSpace.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==p.CapType.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===n.RenderOccludedFlag.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=a.newLayout().vec3f(h.VertexAttribute.POSITION).vec3f(h.VertexAttribute.PREVPOSITION).vec2f(h.VertexAttribute.UV0);return this.parameters.worldSpace&&e.vec3f(h.VertexAttribute.NORMAL),this.parameters.vvSize?e.f32(h.VertexAttribute.SIZEFEATUREATTRIBUTE):e.f32(h.VertexAttribute.SIZE),this.parameters.vvColor?e.f32(h.VertexAttribute.COLORFEATUREATTRIBUTE):e.vec4f(h.VertexAttribute.COLOR),this.parameters.vvOpacity&&e.f32(h.VertexAttribute.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new T(this._layout,this.parameters)}createGLMaterial(e){return new m(e)}}class m extends s.GLTextureMaterial{constructor(){super(...arguments),this._markerPrimitive=null}dispose(){super.dispose(),this._markerTextureRepository.release(this._markerPrimitive),this._markerPrimitive=null}_updateParameters(e){const t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextureRepository.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(c.LineMarkerTechnique,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==i.ShaderOutput.Color&&this._output!==i.ShaderOutput.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class A extends o.VisualVariablePassParameters{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=p.CapType.BUTT,this.anchor=l.LineMarkerAnchor.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1,this.markerTexture=null}}class T{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(e,r,a,i,s){const n=a.attributes.get(h.VertexAttribute.POSITION).data,u=n.length/3;let o=[1,0,0];const c=a.attributes.get(h.VertexAttribute.NORMAL);this._parameters.worldSpace&&null!=c&&(o=c.data);let l=1,p=0;this._parameters.vvSize?p=a.attributes.get(h.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:a.attributes.has(h.VertexAttribute.SIZE)&&(l=a.attributes.get(h.VertexAttribute.SIZE).data[0]);let d=[1,1,1,1],m=0;this._parameters.vvColor?m=a.attributes.get(h.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:a.attributes.has(h.VertexAttribute.COLOR)&&(d=a.attributes.get(h.VertexAttribute.COLOR).data);let A=0;this._parameters.vvOpacity&&(A=a.attributes.get(h.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);const T=new Float32Array(i.buffer);let _=s*(this.vertexBufferLayout.stride/4);const g=(e,t,r,a)=>{if(T[_++]=e[0],T[_++]=e[1],T[_++]=e[2],T[_++]=t[0],T[_++]=t[1],T[_++]=t[2],T[_++]=r[0],T[_++]=r[1],this._parameters.worldSpace&&(T[_++]=o[0],T[_++]=o[1],T[_++]=o[2]),this._parameters.vvSize?T[_++]=p:T[_++]=l,this._parameters.vvColor)T[_++]=m;else{const e=Math.min(4*a,d.length-4);T[_++]=d[e],T[_++]=d[e+1],T[_++]=d[e+2],T[_++]=d[e+3]}this._parameters.vvOpacity&&(T[_++]=A)};let v;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(v||(v={}));const E=(r,a)=>{const i=t.set(O,n[3*r],n[3*r+1],n[3*r+2]),s=S;let h=r+a;do{t.set(s,n[3*h],n[3*h+1],n[3*h+2]),h+=a}while(t.equals(i,s)&&h>=0&&h<u);e&&(t.transformMat4(i,i,e),t.transformMat4(s,s,e)),g(i,s,[-1,-1],r),g(i,s,[1,-1],r),g(i,s,[1,1],r),g(i,s,[-1,-1],r),g(i,s,[1,1],r),g(i,s,[-1,1],r)},R=this._parameters.placement;"begin"!==R&&"begin-end"!==R||E(0,v.ASCENDING),"end"!==R&&"begin-end"!==R||E(u-1,v.DESCENDING)}}const O=r.create(),S=r.create();e.LineMarkerMaterial=d,e.Parameters=A,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
