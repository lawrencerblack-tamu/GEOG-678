/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/arrayUtils","../../../../../core/MapUtils","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/NestedMap","../../../../../core/PooledArray","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../support/buffer/glUtil","../../core/shaderLibrary/ShaderOutput","../../effects/RenderPlugin","../../lib/GLMaterials","../../lib/ModelDirtyTypes","../../lib/RenderSlot","../../lib/Util","../DrawParameters","./BufferRange","./Instance","./PerBufferData","./PerOriginData","./VaoCache"],(function(e,t,r,a,i,s,n,o,l,u,h,d,c,f,g,m,p,y,_,b,v,w,O,S,C,M,R){"use strict";e.MergedRenderer=class extends p.SyncPrepareRenderPlugin{constructor(e){super(e),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._produces=new Map,this.drapedPriority=0}destroy(){this._glMaterials=s.disposeMaybe(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=s.disposeMaybe(this._vaoCache)}initialize(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==m.ShaderOutput.Highlight&&t!==m.ShaderOutput.ShadowHighlight||this._hasHighlights))&&e(t)))}))}get produces(){return this._produces}initializeRenderContext(e,t){const{rctx:r}=e.renderContext;this._glMaterials=new y.GLMaterials(this.material,t??e.materialRepository),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new R.VaoCache(r,this.material.vertexAttributeLocations,g.glLayout(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get hasOccludees(){return this._hasOccludees}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get materialReference(){return this.material}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.usedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter;if(null===t)return;const r=t.vertexBufferLayout.stride/4;for(const a of e){const e=a.renderGeometry,i=this._dataByOrigin.get(e.localOrigin.id),s=i?.findBuffer(e.id);if(null==s)return;const n=s.instances.get(e.id);if(a.updateType&(_.DirtyState.GEOMETRY|_.DirtyState.TRANSFORMATION)){const a=V(t.elementCount(n.geometry.geometry)*r),i=t.vertexBufferLayout.createView(a.buffer);this._writeGeometry(e,i,0),s.vao.vertexBuffers.geometry.setSubData(a,n.from*r,0,n.numElements*r)}a.updateType&(_.DirtyState.HIGHLIGHT|_.DirtyState.OCCLUDEE|_.DirtyState.VISIBILITY)&&(s.drawCommandsDirty=!0)}}_computeDeltas(e,t){const r=new n.NestedMap;for(const a of e){const e=a.localOrigin;if(null==e)continue;let t=r.get(e.id,null);null==t&&(t=new A(e.vec3),r.set(e.id,null,t)),t.changes.push(a)}for(const a of t){const e=a.localOrigin;if(null==e)continue;const t=this._dataByOrigin.get(e.id),i=t?.findBuffer(a.id);if(null==i)continue;let s=r.get(e.id,i);null==s&&(s=new A(e.vec3),r.set(e.id,i,s)),s.changes.push(a)}return r}_addAndRemoveGeometries(e,t){if(null===this._bufferWriter||null===this._vaoCache)return;const{_bufferWriter:a,_dataByOrigin:i}=this,s=a.vertexBufferLayout.stride/4,n=this._computeDeltas(e,t);n.forEach(((e,t)=>{const o=e.get(null),l=null!=o?o.changes:[];n.delete(t,null);let u=i.get(t);if(e.forEach(((e,o)=>{if(n.delete(t,o),null==o)return void v.assert(!1,"No VAO for removed geometries");if(o.instances.size===e.changes.length)return this._vaoCache.deleteVao(o.vao),r.removeUnordered(u.buffers,o),void(0===u.buffers.length&&0===l.length&&i.delete(t));const h=o.numElements,d=o.vao.byteSize/4,c=l.reduce(((e,t)=>e+a.elementCount(t.geometry)),0),f=e.changes.reduce(((e,t)=>e+a.elementCount(t.geometry)),0),g=Math.min((h+c-f)*s,G),m=g>d;g>L&&g<d/2?(e.changes.forEach((({id:e})=>o.deleteInstance(e))),o.instances.forEach((({geometry:e})=>l.push(e))),this._vaoCache.deleteVao(o.vao),r.removeUnordered(u.buffers,o)):m?this._applyAndRebuild(o,l,e):this._applyRemoves(o,e)})),l.length>0)for(null==u&&(u=new M.PerOriginData(o.origin),i.set(t,u)),u.buffers.forEach((e=>this._applyAdds(e,l)));l.length>0;)u.buffers.push(this._applyAndRebuild(new C.PerBufferData,l,null))}))}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,a.someMap(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,r){if(null!=r)for(const f of r.changes)e.deleteInstance(f.id);const a=this._bufferWriter,i=a.vertexBufferLayout.stride,s=i/4,n=Math.floor(G/s);let o=e.numElements;for(;t.length>0;){const r=t.pop(),i=a.elementCount(r.geometry);if(o+i>n&&o>0){t.push(r);break}o+=i;const s=new S.Instance(r,0,0);v.assert(null==e.instances.get(r.id)),e.addInstance(r.id,s)}const l=o*s,u=V(l),h=a.vertexBufferLayout.createView(u.buffer);let d=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,r)=>{this._writeGeometry(t.geometry,h,d);const i=d;d+=a.elementCount(t.geometry.geometry),e.updateInstance(r,i,d),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(U(l)),e.vao.vertexBuffers.geometry.setSubData(u,0,0,d*s),e.holes.clear();const c=e.holes.pushNew();return c.from=d,c.to=Math.floor(e.vao.byteSize/i),e.updateDrawCommands(i),e}_applyRemoves(e,t){if(0===t.changes.length||null===this._bufferWriter)return;for(const n of t.changes){const t=n.id,r=e.instances.get(t);if(!r)continue;e.deleteInstance(t);const a=x.back();if(a){if(a.to===r.from){a.to=r.to;continue}if(a.from===r.to){a.from=r.from;continue}}const i=x.pushNew();i.from=r.from,i.to=r.to}O.mergeAdjacentRanges(x);const r=this._bufferWriter.vertexBufferLayout.stride/4,a=x.reduce(((e,t)=>Math.max(e,t.numElements)),0)*r,i=V(a);i.fill(0,0,a);const s=e.vao.vertexBuffers.geometry;x.forAll((e=>s.setSubData(i,e.from*r,0,e.numElements*r))),e.holes.pushArray(x.data,x.length),x.forAll(((e,t)=>x.data[t]=null)),x.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null===this._bufferWriter)return;if(!C.hasVao(e))return void this._applyAndRebuild(e,t,null);const a=this._bufferWriter,i=a.vertexBufferLayout.stride/4,s=e.numElements,n=t.reduce(((e,t)=>e+a.elementCount(t.geometry)),0),o=Math.min((s+n)*i,G),l=4*o;if(e.vao.byteSize<U(G-L)&&l>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);O.mergeAdjacentRanges(e.holes);const u=new Array;for(const r of t){const t=a.elementCount(r.geometry),i=D(e.holes,t);u.push(i)}const h=e.vao.vertexBuffers.geometry;let d=0,c=0,f=0;const g=V(o),m=a.vertexBufferLayout.createView(g.buffer);t.forEach(((t,r)=>{const s=u[r];if(null==s)return;if(!(f===s)){const e=f-c;e>0&&h.setSubData(g,c*i,0,e*i),c=s,d=0}const n=a.elementCount(t.geometry);this._writeGeometry(t,m,d),d+=n,f=s+n;const o=new S.Instance(t,s,s+n);v.assert(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0}));const p=f-c;p>0&&h.setSubData(g,c*i,0,p*i),r.filterInPlace(t,((e,t)=>null==u[t]))}_writeGeometry(e,t,r){if(null===this._bufferWriter)return;const a=e.localOrigin.vec3;v.setMatrixTranslation3(B,-a[0],-a[1],-a[2]);const i=c.multiply(E,B,e.transformation);c.invert(H,i),c.transpose(H,H),this._bufferWriter.write(i,H,e.geometry,t,r)}updateAnimation(e){return this.material.update(e)}prepareTechnique(e){if(!this.material.shouldRender(e))return null;const{output:t,bindParameters:r}=e,a=this.material.produces.get(r.slot);if(!a||!a(t))return null;const i=t===m.ShaderOutput.Highlight||t===m.ShaderOutput.ShadowHighlight;if(i&&!this._hasHighlights)return null;const s=t===m.ShaderOutput.ShadowExcludeHighlight,n=!(i||s);for(const o of this._dataByOrigin.values())for(const a of o.buffers){if(i&&!a.hasHighlights)continue;const o=(i?a.drawCommandsHighlight:s&&a.needsMultipleCommands()?a.drawCommandsShadowHighlightRest:a.drawCommandsDefault)||null,l=n&&a.drawCommandsOccludees||null;if(o?.length||l?.length){const a=this._glMaterials.load(e.rctx,r.slot,t),i=null!=a?a.beginSlot(r):null;if(null!=i)return i}}return null}renderNode(e,t){const{output:r,bindParameters:a}=e,i=r===m.ShaderOutput.Highlight||r===m.ShaderOutput.ShadowHighlight,s=r===m.ShaderOutput.ShadowExcludeHighlight,n=!(i||s),o=e.rctx,l=e.bindParameters.slot===b.RenderSlot.OCCLUDER_MATERIAL,u=e.bindParameters.slot===b.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL;o.runAppleAmdDriverHelper(),o.bindTechnique(t,a,this.material.parameters);for(const h of this._dataByOrigin.values())for(const e of h.buffers){if(i&&!e.hasHighlights)continue;const r=(i?e.drawCommandsHighlight:s&&e.needsMultipleCommands()?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,d=n&&e.drawCommandsOccludees||null;if(r?.length||d?.length){t.program.bindDraw(new w.DrawParameters(h.origin),a,this.material.parameters),t.ensureAttributeLocations(e.vao),o.bindVAO(e.vao),r?.length&&(o.setPipelineState(t.getPipeline(!1,l,u)),r.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))),d?.length&&(o.setPipelineState(t.getPipeline(!0,l,u)),d.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count))))}}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}},t.__decorate([l.property({constructOnly:!0})],e.MergedRenderer.prototype,"material",void 0),e.MergedRenderer=t.__decorate([d.subclass("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],e.MergedRenderer);class A{constructor(e){this.origin=e,this.changes=new Array}}function D(e,t){let r;if(!e.some((e=>!(e.numElements<t)&&(r=e,!0))))return null;const a=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),a}const B=f.create(),E=f.create(),H=f.create(),x=new o({allocator:e=>e||new O.BufferRange,deallocator:null}),L=65536,P=4*L,I=1024,T=16777216,G=T/4;let W=new Float32Array(L);function V(e){return W.length<e&&(W=new Float32Array(e)),W}function U(e){const t=4*e;return t<=I?I:t<P?i.nextHighestPowerOfTwo(t):Math.max(Math.min(Math.ceil(1.5*t/P)*P,T),t)}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
