/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","exports","../../../../../chunks/tslib.es6","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../support/requestImageUtils","../../../webgl/formats","../RenderPlugin","./SMAABlendWeightsTechnique","./SMAABlurTechnique","./SMAAEdgeDetectTechnique","./SMAAPassParameters","../../lib/RenderFeature","../../lib/RenderSlot","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,s,i,a,o,n,l,u,c,h,d,_,b,x,T,p,m,A,g,f,q){"use strict";function C(e,t,r,s){const i=new q.TextureDescriptor;return i.pixelFormat=r,i.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE,i.width=s.width,i.height=s.height,i.samplingMode=t,new f.Texture(e,i,s)}t.SMAA=class extends _.SyncRenderPlugin{constructor(e){super(e),this._context=null,this._areaTexture=null,this._searchTexture=null,this._isEnabled=!1,this._smaaParameters=new p.SMAAPassParameters,this.produces=new Map([[A.RenderSlot.ANTIALIASING,()=>this._isEnabled&&null!=this._context]])}consumes(){return _.ConsumesCompositeColor}get updating(){return null!=this._abortController}initializeRenderContext(e){this._context=e,this.addHandles([a.watch((()=>this.view.qualitySettings.antialiasingEnabled),(()=>this.renderFeatureChanged()),a.syncAndInitial)])}renderFeatureChanged(){this.view.qualitySettings.antialiasingEnabled||this._context?.isFeatureEnabled(m.RenderFeature.Antialiasing)?this.enable():this.disable()}uninitializeRenderContext(){this.disable(),this._context=null}async enable(){if(this._isEnabled||!this._context||this._abortController)return;if(this._edgeTechnique??=this._context.techniqueRepository.acquire(T.SMAAEdgeDetectTechnique),this._blendTechnique??=this._context.techniqueRepository.acquire(b.SMAABlendWeightsTechnique),this._blurTechnique??=this._context.techniqueRepository.acquire(x.SMAABlurTechnique),this._areaTexture&&this._searchTexture)return void(this._isEnabled=!0);this._abortController=new AbortController;const t=this._abortController.signal;try{const r=await new Promise(((t,r)=>e(["./SMAAData"],t,r)));await this._loadTextures(this._context,r,t),this._context?.requestRender()}catch{}this._abortController=null}async _loadTextures(e,t,r){if(i.throwIfAborted(r),!e)throw i.createAbortError();const[s,a]=await Promise.allSettled([h.requestImage(t.areaTexture,{signal:r}),h.requestImage(t.searchTexure,{signal:r})]);i.throwIfAborted(r),"fulfilled"===s.status&&"fulfilled"===a.status&&(this._areaTexture=C(e.fbos.rctx,g.TextureSamplingMode.LINEAR,g.PixelFormat.RGB,s.value),this._searchTexture=C(e.fbos.rctx,g.TextureSamplingMode.NEAREST,g.PixelFormat.LUMINANCE,a.value),this._isEnabled=!0)}_disposeTextures(){this._areaTexture=s.disposeMaybe(this._areaTexture),this._searchTexture=s.disposeMaybe(this._searchTexture)}disable(){this._abortController=s.abortMaybe(this._abortController),this._isEnabled=!1}destroy(){this.disable(),this._disposeTextures()}renderNode(e,t,r,s){const i=r?.get("composite-color")?.getTexture();if(!(this._isEnabled&&this._context&&r&&i))return s;if(!(this._edgeTechnique?.compiled&&this._blendTechnique?.compiled&&this._blurTechnique?.compiled))return this._context.requestRender(),s;const a=i.descriptor.width,o=i.descriptor.height,n=this._context.fbos,l=e.rctx;l.setViewport(0,0,a,o);const u=n.acquire(a,o,"smaa edges",d.ColorFormat.RG);l.unbindTexture(u.fbo.colorTexture),l.bindFramebuffer(u.fbo),l.setClearColor(0,0,0,1),l.clear(g.ClearBufferBit.COLOR_BUFFER_BIT),this._smaaParameters.color=i,l.bindTechnique(this._edgeTechnique,null,this._smaaParameters),l.screen.draw();const c=n.acquire(a,o,"smaa blend");return l.unbindTexture(c.fbo.colorTexture),l.bindFramebuffer(c.fbo),l.setClearColor(0,0,1,1),l.clear(g.ClearBufferBit.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=u.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(this._blendTechnique,null,this._smaaParameters),l.screen.draw(),l.bindFramebuffer(s?.fbo),u.release(),l.setClearColor(0,1,0,1),l.clear(g.ClearBufferBit.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=c.getTexture(),l.bindTechnique(this._blurTechnique,null,this._smaaParameters),l.screen.draw(),c.release(),s}},r.__decorate([o.property()],t.SMAA.prototype,"view",void 0),r.__decorate([o.property()],t.SMAA.prototype,"_context",void 0),r.__decorate([o.property()],t.SMAA.prototype,"_abortController",void 0),r.__decorate([o.property({readOnly:!0})],t.SMAA.prototype,"updating",null),t.SMAA=r.__decorate([c.subclass("esri.views.3d.webgl-engine.effects.smaa.SMAA")],t.SMAA),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
