/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/time","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../webgl/formats","../../core/shaderLibrary/shading/ScreenSpaceConstants","../RenderPlugin","./SSAOBlurTechnique","./SSAONoiseData","./SSAOParameters","./SSAOTechnique","../../lib/RenderFeature","../../lib/RenderSlot","../../../../../chunks/SSAO.glsl","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,s,i,a,n,o,u,c,l,h,d,_,m,b,p,x,T,S,w,P,f,q,g){"use strict";const A=2;e.SSAO=class extends m.SyncRenderPlugin{constructor(e){super(e),this._context=null,this._passParameters=new x.SSAOPassParameters,this._drawParameters=new x.BlurDrawParameters,this.produces=new Map([[w.RenderSlot.SSAO,()=>this._produces()]])}_getCameraElevation(){return this._context?.renderContext.bindParameters.camera.relativeElevation??1/0}_produces(){return null!=this._enableTime&&null!=this._context&&this._getCameraElevation()<_.distanceFadeEnd}consumes(){return this._produces()?m.ConsumesDepthNormal:m.ConsumesNone}initializeRenderContext(e){this._context=e,this.addHandles([i.watch((()=>this.view.qualitySettings.ambientOcclusion||this._context?.isFeatureEnabled(S.RenderFeature.SSAO)),(e=>e?this._enable():this._disable()),i.syncAndInitial)])}uninitializeRenderContext(){this._disable(),this._context=null}_disable(){this._passParameters.noiseTexture=s.disposeMaybe(this._passParameters.noiseTexture),this._enableTime=null}destroy(){this._disable()}_enable(){if(null!=this._enableTime||!this._context)return;const e=Uint8Array.from(atob(p.noiseData),(e=>e.charCodeAt(0))),t=new g.TextureDescriptor;t.wrapMode=f.TextureWrapMode.CLAMP_TO_EDGE,t.pixelFormat=f.PixelFormat.RGB,t.wrapMode=f.TextureWrapMode.REPEAT,t.hasMipmap=!0,t.width=32,t.height=32,this._passParameters.noiseTexture=new q.Texture(this._context.renderContext.rctx,t,e),null==this._ssaoTechnique&&(this._ssaoTechnique=this._context.techniqueRepository.acquire(T.SSAOTechnique)),null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(b.SSAOBlurTechnique)),this._enableTime=a.Milliseconds(0),this._context?.requestRender()}renderNode(e,t,s){const i=e.bindParameters,a=s?.get("normals"),n=a?.getTexture(),o=a?.getTexture(f.DepthStencilAttachment);if(null==this._enableTime||null==this._context||!n||!o)return;if(!this._ssaoTechnique.compiled||!this._blurTechnique.compiled)return this._enableTime=e.time,void this._context.requestRender();0===this._enableTime&&(this._enableTime=e.time);const u=e.rctx,c=i.camera,l=this.view.qualitySettings.fadeDuration,m=c.relativeElevation,b=r.clamp((_.distanceFadeEnd-m)/(_.distanceFadeEnd-_.distanceFadeStart),0,1),p=l>0?Math.min(l,e.time-this._enableTime)/l:1,x=p*b;this._passParameters.normalTexture=n,this._passParameters.depthTexture=o,this._passParameters.projScale=1/c.computeScreenPixelSizeAtDist(1),this._passParameters.intensity=4*O/P.getRadius(c)**6*x;const T=c.fullViewport[2],S=c.fullViewport[3],w=Math.round(T/A),q=Math.round(S/A),g=this._context.fbos,R=g.acquire(T,S,"ssao input",d.ColorFormat.RG);u.unbindTexture(R.fbo.colorTexture),u.bindFramebuffer(R.fbo),u.setViewport(0,0,T,S),u.bindTechnique(this._ssaoTechnique,i,this._passParameters,this._drawParameters),u.screen.draw();const y=g.acquire(w,q,"ssao blur",d.ColorFormat.RED);u.unbindTexture(y.fbo.colorTexture),u.bindFramebuffer(y.fbo),this._drawParameters.colorTexture=R.getTexture(),h.set(this._drawParameters.blurSize,0,A/S),u.bindTechnique(this._blurTechnique,i,this._passParameters,this._drawParameters),u.setViewport(0,0,w,q),u.screen.draw(),R.release();const C=g.acquire(w,q,"ssao",d.ColorFormat.RED);return u.unbindTexture(C.fbo.colorTexture),u.bindFramebuffer(C.fbo),u.setViewport(0,0,T,S),u.setClearColor(1,1,1,0),u.clear(f.ClearBufferBit.COLOR_BUFFER_BIT),this._drawParameters.colorTexture=y.getTexture(),h.set(this._drawParameters.blurSize,A/T,0),u.bindTechnique(this._blurTechnique,i,this._passParameters,this._drawParameters),u.setViewport(0,0,w,q),u.screen.draw(),u.setViewport4fv(c.fullViewport),y.release(),p<1&&this._context.requestRender(),C}},t.__decorate([n.property({constructOnly:!0})],e.SSAO.prototype,"view",void 0),t.__decorate([n.property()],e.SSAO.prototype,"_context",void 0),e.SSAO=t.__decorate([l.subclass("esri.views.3d.webgl-engine.effects.ssao.SSAO")],e.SSAO);const O=.5;e.blurSizePixels=A,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
