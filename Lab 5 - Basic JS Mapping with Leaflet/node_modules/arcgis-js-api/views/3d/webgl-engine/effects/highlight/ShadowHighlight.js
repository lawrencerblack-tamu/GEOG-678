/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/colorUtils","../../../../../core/mathUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../ViewingMode","../RenderPlugin","./HighlightDefaults","./ShadowHighlightTechnique","../../lib/RenderSlot"],(function(e,t,i,s,a,o,h,r,c,n,d,l,p,u,g,_,w){"use strict";const m=.001953125,y=4e4,f=5e4;e.ShadowHighlight=class extends u.SyncRenderPlugin{constructor(e){super(e),this._maxOpacity=1,this._passParameters=new _.ShadowHighlightPassParameters,this._shadowDifference=.2,this._context=null,this.produces=new Map([[w.RenderSlot.SHADOW_HIGHLIGHT,()=>this._isVisible]])}consumes(){return u.ConsumesHighlight}initializeRenderContext(e){this._context=e,this.addHandles([a.watch((()=>this.view.highlightOptions.shadowOpacity),(e=>{this._passParameters.shadowOpacity=e??g.defaultShadowOpacity,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),a.syncAndInitial),a.watch((()=>this.view.highlightOptions.shadowDifference),(e=>{this._shadowDifference=e??g.defaultShadowDifference,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),a.syncAndInitial),a.watch((()=>this.view.highlightOptions.shadowColor),(e=>{this._passParameters.shadowColor=i.unitRGBAFromColor(e??g.defaultShadowColor),this._updateMaxOpacity()}),a.syncAndInitial)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}uninitializeRenderContext(){this._context=null}enable(){this._context&&null==this._technique&&(this._technique=this._context.techniqueRepository.acquire(_.ShadowHighlightTechnique))}renderNode(e,t,i,s){const a=i?.get("highlights")?.getTexture();if(!this._context||!a||!this._isVisible)return;if(!this._technique?.compiled)return void this._context.requestRender();const o=e.bindParameters;if(!o.shadowMap.enabled||!o.linearDepth)return;this._passParameters.highlight=a,this._passParameters.origin=o.camera.center;const h=e.rctx;h.bindFramebuffer(s?.fbo),h.bindTechnique(this._technique,o,this._passParameters),h.screen.draw()}updateParameters(e,t){this._passParameters.opacityElevation=1-s.smoothstep(y,f,e.relativeElevation);const i=this.viewingMode===p.ViewingMode.Global?d.normalize(S,e.center):d.set(S,0,0,1),a=d.dot(i,t);this._passParameters.dayNightTerminator=s.smoothstep(0,1,s.clamp(30*a,0,1)),this._isVisible&&this.enable()}get _isVisible(){const{opacityElevation:e,dayNightTerminator:t}=this._passParameters;return this._maxOpacity*e*t>=m}},t.__decorate([o.property()],e.ShadowHighlight.prototype,"_context",void 0),t.__decorate([o.property()],e.ShadowHighlight.prototype,"view",void 0),t.__decorate([o.property()],e.ShadowHighlight.prototype,"viewingMode",void 0),e.ShadowHighlight=t.__decorate([n.subclass("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],e.ShadowHighlight);const S=l.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
