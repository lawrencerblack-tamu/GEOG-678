/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/colorUtils","../../../../../core/has","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../webgl/formats","../RenderPlugin","./HighlightApplyTechnique","./HighlightBlurTechnique","./HighlightDefaults","./HighlightDownsampleTechnique","./HighlightPassParameters","../../lib/DefaultVertexAttributeLocations","../../lib/DefaultVertexBufferLayouts","../../lib/RenderSlot","../../lib/VertexArrayObject","../../../../../chunks/HighlightBlur.glsl","../../../../../chunks/HighlightDownsample.glsl","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/Util"],(function(e,t,i,r,s,a,l,o,h,n,c,u,g,p,d,_,m,b,w,x,f,y,T,C,P,v,q){"use strict";e.Highlight=class extends g.SyncRenderPlugin{constructor(e){super(e),this._context=null,this._passParameters=new b.HighlightPassParameters,this._downsampleDrawParameters=new C.HighlightDownsampleDrawParameters,this._blurDrawParameters=new T.HighlightBlurDrawParameters,this._blurColorFormat=r("mac")?u.ColorFormat.RGBA:u.ColorFormat.RGBA4,this._grid={coverage:null,vao:null,verticalCellCount:0,horizontalCellCount:0,viewportWidth:0,viewportHeight:0},this.produces=new Map([[f.RenderSlot.HIGHLIGHT,()=>!0]])}consumes(){return g.ConsumesHighlight}initializeRenderContext(e){this._context=e,null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(d.HighlightBlurTechnique)),null==this._downsampleTechnique&&(this._downsampleTechnique=this._context.techniqueRepository.acquire(m.HighlightDownsampleTechnique)),null==this._applyTechnique&&(this._applyTechnique=this._context.techniqueRepository.acquire(p.HighlightApplyTechnique)),this.addHandles([a.watch((()=>this.view.highlightOptions.color),(e=>{this._passParameters.color=i.unitRGBAFromColor(e??_.defaultColor),this.view.highlightOptions.haloColor||(this._passParameters.haloColor=this._passParameters.color),this._context.requestRender()}),a.syncAndInitial),a.watch((()=>this.view.highlightOptions.haloColor),(e=>{this._passParameters.haloColor=null!=e?i.unitRGBAFromColor(e):this._passParameters.color,this._context.requestRender()}),a.syncAndInitial),a.watch((()=>this.view.highlightOptions.haloOpacity),(e=>{this._passParameters.haloOpacity=e??_.defaultHaloOpacity,this._passParameters.haloOpacityOccluded=.25*this._passParameters.haloOpacity,this._context.requestRender()}),a.syncAndInitial),a.watch((()=>this.view.highlightOptions.fillOpacity),(e=>{this._passParameters.fillOpacity=e??_.defaultFillOpacity,this._passParameters.fillOpacityOccluded=.25*this._passParameters.fillOpacity,this._context.requestRender()}),a.syncAndInitial)])}uninitializeRenderContext(){this._context=null}dispose(){this._blurTechnique=s.releaseMaybe(this._blurTechnique),this._downsampleTechnique=s.releaseMaybe(this._downsampleTechnique),this._applyTechnique=s.releaseMaybe(this._applyTechnique),this._grid.coverage=s.releaseMaybe(this._grid.coverage),this._grid.vao=s.disposeMaybe(this._grid.vao)}renderNode(e,t,i,r){const s=i?.get("highlights")?.getTexture();if(!this._context||!s)return;if(!(this._blurTechnique.compiled&&this._downsampleTechnique.compiled&&this._applyTechnique.compiled))return void this._context.requestRender();const a=e.bindParameters.camera,l=a.fullWidth,o=a.fullHeight,h=a.pixelRatio,n=Math.ceil(l/h),u=Math.ceil(o/h),g=this._context.fbos,p=g.rctx;this._gridUpdateResources(s),this._gridComputeCoverage(s,e.bindParameters),this._passParameters.highlightTexture=s,this._passParameters.coverageTexture=this._grid.coverage?.getTexture();const{width:d,height:_}=s.descriptor;c.set(this._passParameters.coverageRounding,d/(Math.ceil(d/C.gridCellPixelSize)*C.gridCellPixelSize),_/(Math.ceil(_/C.gridCellPixelSize)*C.gridCellPixelSize));const m=this._grid.vao;p.bindVAO(m);const b=g.acquire(n,u,"highlight blur",this._blurColorFormat);p.unbindTexture(b.fbo.colorTexture),p.bindFramebuffer(b.fbo),p.setClearColor(0,0,0,0),p.clearSafe(v.ClearBufferBit.COLOR_BUFFER_BIT),p.setViewport(0,0,n,u),this._blurDrawParameters.blurInputTexture=s,c.set(this._blurDrawParameters.blurSize,1/n,0);const w=p.bindTechnique(this._blurTechnique,e.bindParameters,this._passParameters,this._blurDrawParameters);p.drawArrays(this._blurTechnique.primitiveType,0,q.vertexCount(m,"geometry"));const x=g.acquire(n,u,"highlight blur",this._blurColorFormat);p.unbindTexture(x.fbo.colorTexture),p.bindFramebuffer(x.fbo),p.setClearColor(0,0,0,0),p.clearSafe(v.ClearBufferBit.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=b.getTexture(),c.set(this._blurDrawParameters.blurSize,0,1/u),w.bindDraw(this._blurDrawParameters,e.bindParameters,this._passParameters),p.drawArrays(this._blurTechnique.primitiveType,0,q.vertexCount(m,"geometry")),p.bindFramebuffer(r?.fbo),p.setViewport4fv(a.fullViewport),this._passParameters.blurTexture=x.getTexture(),p.bindTechnique(this._applyTechnique,e.bindParameters,this._passParameters),p.drawArrays(this._applyTechnique.primitiveType,0,q.vertexCount(m,"geometry")),b.release(),x.release()}_gridUpdateResources(e){if(!this._context)return;const t=this._context.fbos.rctx,i=this._grid,r=Math.ceil(e.descriptor.height/C.gridCellPixelSize),s=Math.ceil(e.descriptor.width/C.gridCellPixelSize);if(i.vao&&i.verticalCellCount===r&&i.horizontalCellCount===s)return;i.verticalCellCount=r,i.horizontalCellCount=s;const a=r+1,l=s+1,o=1/r,h=1/s,n=new Float32Array(6*4*a*l);let c=0;for(let u=0;u<a;u++)for(let e=0;e<l;e++)n[c++]=(e-.5)*h*2-1,n[c++]=(u-.5)*o*2-1,n[c++]=e*h,n[c++]=u*o,n[c++]=(e+.5)*h*2-1,n[c++]=(u-.5)*o*2-1,n[c++]=e*h,n[c++]=u*o,n[c++]=(e-.5)*h*2-1,n[c++]=(u+.5)*o*2-1,n[c++]=e*h,n[c++]=u*o,n[c++]=(e-.5)*h*2-1,n[c++]=(u+.5)*o*2-1,n[c++]=e*h,n[c++]=u*o,n[c++]=(e+.5)*h*2-1,n[c++]=(u-.5)*o*2-1,n[c++]=e*h,n[c++]=u*o,n[c++]=(e+.5)*h*2-1,n[c++]=(u+.5)*o*2-1,n[c++]=e*h,n[c++]=u*o;i.vao?.dispose(),i.vao=new y.VertexArrayObject(t,w.Default3D,{geometry:x.Pos2Tex},{geometry:P.BufferObject.createVertex(t,v.Usage.STATIC_DRAW,n)})}_gridComputeCoverage(e,t){if(!this._context)return;const i=this._context.fbos.rctx,r=this._grid,s=e.descriptor,a=Math.ceil(s.width/C.gridCellPixelSize),l=Math.ceil(s.height/C.gridCellPixelSize);this._downsampleDrawParameters.input=e,r.coverage?.release(),r.coverage=this._context.fbos.acquire(a,l,"highlight coverage",u.ColorFormat.RG),i.unbindTexture(r.coverage.fbo.colorTexture),i.bindFramebuffer(r.coverage.fbo),i.bindTechnique(this._downsampleTechnique,t,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,a,l),i.screen.draw()}get test(){return{coverage:this._grid.coverage}}},t.__decorate([l.property()],e.Highlight.prototype,"_context",void 0),t.__decorate([l.property()],e.Highlight.prototype,"view",void 0),e.Highlight=t.__decorate([n.subclass("esri.views.3d.webgl-engine.effects.highlight.Highlight")],e.Highlight),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
