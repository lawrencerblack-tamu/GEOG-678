/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../core/signal","../core/shaderLibrary/ShaderOutput","./RenderPlugin","../lib/basicInterfaces","../lib/depthRange","../lib/Material","../lib/RenderSlot"],(function(e,r,t,n,s,i,o,d,l,u){"use strict";class a{constructor(e){this._context=e,this._renderPlugins=new r,this._slots=new Array,this._renderVersion=n.signal(0);for(let r=0;r<u.RenderSlot.MAX_SLOTS;++r)this._slots[r]=[]}destroy(){this._renderPlugins.forEach((e=>e.destroy())),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(e,r){const n=()=>{if(r?.aborted)throw e.uninitializeRenderContext(),t.createAbortError();this._renderPlugins.push(e),e.produces.forEach(((r,t)=>{this._slots[t].push(e)})),this._context.requestRender(),this._renderVersion.value++},s=e.initializeRenderContext(this._context,r);if(t.isPromiseLike(s))return s.then(n);n()}remove(e){if(null!=this._renderPlugins.removeUnordered(e)){for(let r=0;r<this._slots.length;++r)this._slots[r]=this._slots[r].filter((r=>r!==e));e.uninitializeRenderContext(),this._context.requestRender(),this._renderVersion.value++}}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)}))}updateAnimation(e){let r=!1;return this._renderPlugins.forAll((t=>{t.updateAnimation&&(r=t.updateAnimation(e)||r)})),r}renderFeatureChanged(){this._renderPlugins.forAll((e=>{e.renderFeatureChanged&&e.renderFeatureChanged()}))}prepare(e){this._context.renderContext.bindParameters.slot=e,this._slots[e].forEach((r=>{const t=r.produces.get(e);t&&t(s.ShaderOutput.Color)&&(i.isPrepareRenderPlugin(r)&&r.prepareTechnique(this._context.renderContext),i.isPreparesRenderPlugin(r)&&r.prepareTechniques(this._context.renderContext))}))}_getRenderables(e){this._context.renderContext.bindParameters.slot=e;const r=this._context.renderContext.output??s.ShaderOutput.Color,t=new Map;return this._slots[e].forEach((n=>{const s=n.produces.get(e);if(s&&s(r)&&(!n.isDecoration||this._context.renderContext.bindParameters.decorations!==o.Decorations.OFF))if(i.isPrepareRenderPlugin(n)){const e=n.prepareTechnique(this._context.renderContext);null!=e&&t.set(n,e)}else if(i.isPreparesRenderPlugin(n)){const e=n.prepareTechniques(this._context.renderContext);null!=e&&t.set(n,e)}else t.set(n,null)})),t}render(e,r=null,t=null){return this._getRenderables(e).forEach(((e,n)=>t=n.renderNode(this._context.renderContext,e,r,t))),t}queryDepthRange(e){const r=new d.DepthRange;return this._renderPlugins.forAll((t=>{const n=t.queryDepthRange?.(e);d.union(r,n)})),r}get updating(){return this._renderVersion.value>=0&&this._renderPlugins.some((e=>e.running))}produces(e,r=s.ShaderOutput.Color){return this._slots[e].some((t=>{const n=t.produces.get(e);return!!n&&n(r)}))}consumes(e){return this._renderPlugins.some((r=>r.consumes().required.includes(e)))}getMaterialRenderer(e){return this._renderPlugins.find((r=>r.materialReference===e))}removeEmptyMaterialRenderers(){this._renderPlugins.filterInPlace((e=>!e.materialReference||0!==e.numGeometries||(e.destroy(),!1)))}get hasDecorations(){return this._renderPlugins.some((e=>e.isDecoration))}get hasOccludees(){return this._renderPlugins.some((e=>e.hasOccludees))}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,r)=>e|r.renderOccludedFlags),l.RenderOccludedFlag.None)}get usedMemory(){return this._renderPlugins.reduce(((e,r)=>null!==r.materialReference?e:e+(r.usedMemory??0)),0)}get test(){return{plugins:this._renderPlugins}}}e.RenderPluginManager=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
