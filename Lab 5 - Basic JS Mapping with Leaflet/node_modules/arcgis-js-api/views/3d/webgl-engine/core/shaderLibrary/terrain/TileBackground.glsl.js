/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../output/BlendOptions","./BackgroundGrid.glsl","../util/BlendModes.glsl","../../shaderModules/Float3PassUniform","../../shaderModules/FloatPassUniform","../../shaderModules/interfaces","../../shaderModules/Texture2DPassUniform"],(function(o,e,r,l,a,t,s,u,d){"use strict";var i,c,n;o.BlendLayersOutput=void 0,(i=o.BlendLayersOutput||(o.BlendLayersOutput={}))[i.Composite=0]="Composite",i[i.ColorComposite=1]="ColorComposite",i[i.GridComposite=2]="GridComposite",i[i.GroupBackgroundComposite=3]="GroupBackgroundComposite",i[i.COUNT=4]="COUNT",o.BaseOpacityMode=void 0,(c=o.BaseOpacityMode||(o.BaseOpacityMode={}))[c.NotRequired=0]="NotRequired",c[c.Required=1]="Required",c[c.COUNT=2]="COUNT",o.PremultipliedAlphaSource=void 0,(n=o.PremultipliedAlphaSource||(o.PremultipliedAlphaSource={}))[n.Off=0]="Off",n[n.On=1]="On",n[n.COUNT=2]="COUNT";class p extends u.NoParameters{constructor(){super(...arguments),this.baseOpacity=1,this.backgroundColor=e.ZEROS,this.fboTexture=null}}function g(e,i){const c=i.output===o.BlendLayersOutput.GridComposite,n=i.output===o.BlendLayersOutput.ColorComposite,p=i.output===o.BlendLayersOutput.GroupBackgroundComposite,g=i.output===o.BlendLayersOutput.Composite;c&&e.fragment.include(l.BackgroundGrid),n&&e.fragment.uniforms.add(new t.Float3PassUniform("backgroundColor",(o=>o.backgroundColor)));const m=i.baseOpacityMode===o.BaseOpacityMode.Required;m&&e.fragment.uniforms.add(new s.FloatPassUniform("baseOpacity",(o=>o.baseOpacity))),g&&e.fragment.uniforms.add(new d.Texture2DPassUniform("fboColor",(o=>o.fboTexture)));const y=i.blendMode!==r.LayerBlendMode.Normal,C=i.premultipliedSource===o.PremultipliedAlphaSource.On;e.fragment.include(a.BlendModes,i),e.fragment.code.add(u.glsl`
    vec4 getBackground(vec2 uv) {
      return ${m?u.glsl`baseOpacity *`:""} ${p?u.glsl`vec4(0.0, 0.0, 0.0, 0.0)`:n?u.glsl`vec4(backgroundColor, 1.0)`:c?u.glsl`vec4(gridColor(uv), 1.0)`:u.glsl`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`};
    }

    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {
      ${y?u.glsl`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:u.glsl`
          float composeAlpha = colorLayer.a * opacity;
          return ${!C&&(g&&!m||p)?u.glsl`colorLayer * opacity;`:u.glsl`bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}o.TileBackground=g,o.TileBackgroundPassParameters=p,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})}));
