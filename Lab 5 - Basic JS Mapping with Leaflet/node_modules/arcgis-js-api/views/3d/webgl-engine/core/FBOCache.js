/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../webgl/formats","../../webgl/ManagedColorAttachment","../../webgl/ManagedDepthAttachment","../../webgl/ManagedFBO","../../webgl/ManagedFBObject","./FBOPool","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Renderbuffer","../../../webgl/RenderbufferDescriptor","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,r,a,o,i,c,h,n,s,l,d,p){"use strict";class u{constructor(e){this.rctx=e,this._acquired=new Set,this._cache=new c.FBOPool(e.newCache,"FBOCache"),this._depthCache=new c.FBOPool(e.newCache,"DepthAttachmentCache"),this._colorCache=new c.FBOPool(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback&&this.debugCallback()}frameEnd(){const e=this.debugCallback;e&&this._acquired.forEach((t=>t.type===i.AttachmentType.FBO&&e(t.name,t.fbo)))}get usedMemory(){return Array.from(this._acquired.values()).reduce(((e,t)=>e+("getTexture"in t?t.getTexture()?.usedMemory??0:t.usedMemory)),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}acquire(e,r,a,i=t.ColorFormat.RGBA){const c=_(i,e,r);let h=this._cache.pop(c);return h?(h.retain(),h.setName(a)):h=new o(c,a,new n.FramebufferObject(this.rctx,{...E[i],width:e,height:r}),(e=>{e??=t.DepthFormat.DEPTH_STENCIL_TEXTURE;const r=this._acquireDepth(e,h.fbo.width,h.fbo.height,`${h.name} depth`);return h.attachDepth(r),r.release(),h}),((a,o)=>{o??=t.ColorFormat.RGBA;const i=this._acquireColor(o,e,r,`${h.name} color ${a}`);return h.attachColor(i,a),i.release(),h}),(()=>{this.debugCallback&&this.debugCallback(h.name,h.fbo),this._acquired.delete(h),h.detachAll(),this._cache.put(h)})),this._trackHandle(h)}acquireDepth(e,t,r,a){return this._acquireDepth(e,t,r,a)}_acquireDepth(e,r,o,i){const c=_(e,r,o),h=this._depthCache.pop(c);if(h)return h.retain(),h.name=i,this._trackHandle(h);const n=e===t.DepthFormat.DEPTH_STENCIL_TEXTURE?new a.ManagedDepthAttachment(c,new d.Texture(this.rctx,{...D[e],width:r,height:o}),(()=>{this._acquired.delete(n),this._depthCache.put(n)})):new a.ManagedDepthAttachment(c,new s.Renderbuffer(this.rctx,{...D[e],width:r,height:o}),(()=>{this._acquired.delete(n),this._depthCache.put(n)}));return n.name=i,this._trackHandle(n)}_acquireColor(e,t,a,o){const i=_(e,t,a),c=this._colorCache.pop(i);if(c)return c.retain(),c.name=o,this._trackHandle(c);const h=new r.ManagedColorAttachment(i,new d.Texture(this.rctx,{...E[e],width:t,height:a}),(()=>{this._acquired.delete(h),this._colorCache.put(h)}));return h.name=o,this._trackHandle(h)}_trackHandle(e){return this._acquired.add(e),e}}function _(e,t,r){return`${e}x${t}x${r}`}const m=new p.TextureDescriptor;m.pixelFormat=h.PixelFormat.RED,m.internalFormat=h.SizedPixelFormat.R8,m.wrapMode=h.TextureWrapMode.CLAMP_TO_EDGE;const T=new p.TextureDescriptor;T.pixelFormat=h.PixelFormat.RG,T.internalFormat=h.SizedPixelFormat.RG8,T.wrapMode=h.TextureWrapMode.CLAMP_TO_EDGE;const C=new p.TextureDescriptor;C.internalFormat=h.SizedPixelFormat.RGBA4,C.dataType=h.PixelType.UNSIGNED_SHORT_4_4_4_4,C.wrapMode=h.TextureWrapMode.CLAMP_TO_EDGE;const F=new p.TextureDescriptor;F.wrapMode=h.TextureWrapMode.CLAMP_TO_EDGE;const x=new p.TextureDescriptor;x.wrapMode=h.TextureWrapMode.CLAMP_TO_EDGE,x.samplingMode=h.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,x.hasMipmap=!0,x.maxAnisotropy=8;const w=new p.TextureDescriptor;w.pixelFormat=h.PixelFormat.RED,w.dataType=h.PixelType.HALF_FLOAT,w.internalFormat=h.SizedPixelFormat.R16F,w.samplingMode=h.TextureSamplingMode.NEAREST;const M=new p.TextureDescriptor;M.dataType=h.PixelType.HALF_FLOAT,M.internalFormat=h.SizedPixelFormat.RGBA16F,M.samplingMode=h.TextureSamplingMode.NEAREST;const E={[t.ColorFormat.RED]:m,[t.ColorFormat.RG]:T,[t.ColorFormat.RGBA4]:C,[t.ColorFormat.RGBA]:F,[t.ColorFormat.RGBA_MIPMAP]:x,[t.ColorFormat.R16F]:w,[t.ColorFormat.RGBA16F]:M},g=new p.TextureDescriptor;g.pixelFormat=h.PixelFormat.DEPTH_STENCIL,g.dataType=h.PixelType.UNSIGNED_INT_24_8,g.samplingMode=h.TextureSamplingMode.NEAREST,g.wrapMode=h.TextureWrapMode.CLAMP_TO_EDGE;const D={[t.DepthFormat.DEPTH_STENCIL_TEXTURE]:g,[t.DepthFormat.DEPTH16_BUFFER]:new l.RenderbufferDescriptor(h.RenderbufferFormat.DEPTH_COMPONENT16,4)};e.FBOCache=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
