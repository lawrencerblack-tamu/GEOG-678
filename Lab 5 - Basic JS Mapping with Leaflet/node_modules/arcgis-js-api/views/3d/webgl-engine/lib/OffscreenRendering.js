/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/has","../../../../core/maybe","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../webgl/formats","./rendererUtils","./TransparencyPassType","../../../webgl/enums","../../../webgl/FramebufferObject"],(function(t,e,r,i,s,h,o,a,c,l){"use strict";class f{constructor(t,e){this._fbos=t,this.compositingHelper=e,this._width=4,this._height=4,this._clearColor=s.create()}dispose(){this._color=r.releaseMaybe(this._color),this.releaseBuffers()}get framebuffer(){return this.color.attachDepth(this.depth),this.color.fbo}get colorTexture(){return this.color.getTexture()}get depthTexture(){return this.depth.attachment}initializeFrame(t,e,r){this._fbos.interactive=r===o.RendererTarget.Default;const s=this._fbos.rctx;this._width=t.fullWidth,this._height=t.fullHeight,l.ensureAttachmentMaxSize(this,s.parameters.maxTextureSize);const h=this._color;return this._color=null,this.releaseBuffers(),i.copy(this._clearColor,e),h}releaseBuffers(){this._color?.detachDepth(),this._depth=r.releaseMaybe(this._depth)}renderHUDVisibility(t,e,r){return t?.fbo.width===this._width&&t?.fbo.height===this._height||(t?.release(),t=this._fbos.acquire(this._width,this._height,"hud visibility",h.ColorFormat.RGBA4)),t.attachDepth(r||this.depth),this._fbos.rctx.bindFramebuffer(t.fbo),this._fbos.rctx.clearFramebuffer(n),e(),t.detachDepth(),t}compositeToHUDVisibility(t,e){this._fbos.rctx.bindFramebuffer(t.hudVisibility?.fbo),this.compositingHelper.compositeHUD(t,e)}renderOITPass(t,e,r){let i,s;const{_width:o,_height:c}=this;switch(e){case a.TransparencyPassType.Color:i=this._fbos.acquire(o,c,r?"oit hud color":"oit color",h.ColorFormat.RGBA16F),s=[0,0,0,0];break;case a.TransparencyPassType.Alpha:i=this._fbos.acquire(o,c,r?"oit hud alpha":"oit alpha",h.ColorFormat.R16F),s=[1,1,1,1];break;case a.TransparencyPassType.FrontFace:i=this._fbos.acquire(o,c,r?"oit hud front":"oit front"),s=[0,0,0,0]}return r?i.acquireDepth(h.DepthFormat.DEPTH16_BUFFER):i.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(i.fbo),this._fbos.rctx.clearFramebuffer(s,r,r),t(),i.detachDepth(),i}compositeToFramebuffer(t,e,r,i){this.bindFbo(),this.compositingHelper.composite(t,e,r,i)}compositeTransparentOntoOpaque(t,e,r,i,s){s?(this._fbos.rctx.bindFramebuffer(s.fbo),this._fbos.rctx.setClearColor(0,0,0,1e-13),this._fbos.rctx.clearSafe(c.ClearBufferBit.COLOR_BUFFER_BIT)):this.bindFbo(),this.compositingHelper.compositeOIT(t,e.getTexture(),r.getTexture(),i.getTexture())}renderDepthDetached(t){this._bindTarget(this.color),t(),this._bindTarget(this.color,this.depth)}renderToCachedFBO(t,e,i,s,o=h.ColorFormat.RGBA,a=h.DepthFormat.DEPTH16_BUFFER,c=this._width,l=this._height,f=null){return t?.fbo.width===c&&t?.fbo.height===l||(t=r.releaseMaybe(t)),t=t??this._fbos.acquire(c,l,e,o),f?.forEach((e=>t.acquireColor(e.attachment,e.format))),null!=a&&t.acquireDepth(a),this._fbos.rctx.bindFramebuffer(t.fbo),this._fbos.rctx.clearFramebuffer(s,!0,!0),i(),t}renderToTargets(t,e,r,i,s=!1,h=!1){this._bindTarget(e,r),this._fbos.rctx.clearFramebuffer(i,s,h),t(),e.detachDepth()}bindFbo(){const t=null==this._color;if(this._bindTarget(this.color,this.depth),t){const t=this._fbos.rctx;t.setClearStencil(0),t.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),t.clearSafe(c.ClearBufferBit.COLOR_BUFFER_BIT|c.ClearBufferBit.DEPTH_BUFFER_BIT|c.ClearBufferBit.STENCIL_BUFFER_BIT)}}_bindTarget(t,e){t.attachDepth(e),this._fbos.rctx.bindFramebuffer(t.fbo)}get width(){return this._width}get height(){return this._height}get color(){return this._ensureColor()}_ensureColor(){return this._color||(this._color=this._fbos.acquire(this._width,this._height,"composite-color")),this._color}updateColor(t,e){const r=this._ensureColor();r.attachDepth(this.depth),r.setName(e),this._color=t(r)}get depth(){return this._depth||(this._depth=this._fbos.acquireDepth(h.DepthFormat.DEPTH_STENCIL_TEXTURE,this._width,this._height,"depth")),this._depth}}const n=[0,1,0,1];t.OffscreenRendering=f,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
