/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/floatRGBA","../../../../core/PooledArray","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/frustum","../../../../chunks/sphere","../../support/mathUtils","./depthRange","./Octree","./Util"],(function(e,t,r,n,i,a,s,o,h,c,f,l,_,u){"use strict";const d=1e4,m=100,g=500,p=500,b=.1;function R(e,r,n){return t.unpackFloatRGBA(r,e)*(n[1]-n[0])+n[0]}function w(e,t,r){let n=0;if(!t.some((e=>!!e.materialReference&&(n+=e.numGeometries,n>=d))))return P.compute(e,t);const i=l.empty();return r.forAll((t=>l.union(i,v(e,t)))),i}function v(e,t){if(!t.visible)return;const r=l.empty(),n=t.getSpatialQueryAccelerator();return n?C(r,e,n):M(r,e,t.objects),r}function C(e,t,r){const n=t.eye,i=t.viewForward,a=t.frustum,s=e=>e.visible,o=r.objectCount;if(o<g)l.set(S,t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(n,i,_.DepthOrder.FRONT_TO_BACK,S,((r,n)=>{A(e,t,r),S.far=e.near,n.setRange(S)}),a,s),l.set(S,Math.max(e.far,t.near),t.far),r.forEachInDepthRange(n,i,_.DepthOrder.BACK_TO_FRONT,S,((r,n)=>{A(e,t,r),S.near=e.far,n.setRange(S)}),a,s);else{const n=Math.max(Math.min(o,p),Math.ceil(o*b)),h=r.findClosest(i,_.DepthOrder.FRONT_TO_BACK,a,s,n),c=r.findClosest(i,_.DepthOrder.BACK_TO_FRONT,a,s,n);h&&c&&(B(e,t,h.boundingVolumeWorldSpace.bounds),B(e,t,c.boundingVolumeWorldSpace.bounds))}}function M(e,t,r){I.clear(),r.forAll((e=>{e.visible&&0!==e.geometries.length&&I.add(e)})),I.empty||(I.sort(t),l.set(S,t.near,Math.min(e.near,t.far)),I.forEachInDepthRange(S,_.DepthOrder.FRONT_TO_BACK,((r,n)=>{n<e.near&&A(e,t,r)})),l.set(S,Math.max(e.far,t.near),t.far),I.forEachInDepthRange(S,_.DepthOrder.BACK_TO_FRONT,((t,r,n)=>{e.far=Math.max(e.far,n)})))}function A(e,t,r){if(!r.visible)return;if(!h.intersectsSphere(t.frustum,r.boundingVolumeWorldSpace.bounds))return;const i=r.transformation,a=j;r.geometries.forEach((r=>{n.multiply(a,i,r.transformation);const s=f.maxScale(a);y(e,t,r.boundingInfo,a,s)}))}function y(e,t,r,n,i){if(null==r)return;a.transformMat4(c.getCenter(F),r.center,n);const{eye:s,viewForward:o}=t,f=o[0]*(F[0]-s[0])+o[1]*(F[1]-s[1])+o[2]*(F[2]-s[2]);if(F[3]=r.radius*i,!(f-F[3]>e.near&&f+F[3]<e.far)&&h.intersectsSphere(t.frustum,F))if(r.radius>m&&r.getChildren())for(const a of r.getChildren())y(e,t,a,n,i);else N.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,n,r.bbMin,r.bbMax)}function B(e,t,r){const n=t.eye,i=t.viewForward,a=(r[0]-n[0])*i[0]+(r[1]-n[1])*i[1]+(r[2]-n[2])*i[2];e.near=Math.min(e.near,a-r[3]),e.far=Math.max(e.far,a+r[3])}class O{constructor(){this._items=new r({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,r=e.viewForward;this._items.forAll((e=>{const n=e.object.boundingVolumeWorldSpace.bounds,i=(n[0]-t[0])*r[0]+(n[1]-t[1])*r[1]+(n[2]-t[2])*r[2];e.distance=i,e.near=i-n[3],e.far=i+n[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,r){if(t===_.DepthOrder.FRONT_TO_BACK)for(let n=0;n<this._items.length;++n){const t=this._items.data[n];t.far<e.near||t.near>e.far||r(t.object,t.near,t.far)}else for(let n=this._items.length-1;n>=0;--n){const t=this._items.data[n];t.far<e.near||t.near>e.far||r(t.object,t.near,t.far)}}}class x{constructor(){this._view=i.create(),this._viewProj=i.create(),this._frustum=h.create(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,t){this._reset(),n.copy(this._view,e.viewMatrix),n.multiply(this._viewProj,e.projectionMatrix,this._view),h.copy(this._frustum,e.frustum);const r=this._view,i=r[2],a=r[6],s=r[10],o=r[14];t.forAll((e=>{e.materialReference&&e.forEachGeometry&&e.forEachGeometry((e=>{if(!e.visible||!e.castShadow)return;const t=e.boundingSphere,r=i*t[0]+a*t[1]+s*t[2]+o,n=r-t[3],h=r+t[3];this._geometries.push(e),this._near.push(-h),this._far.push(-n)}))}));const c=new l.DepthRange;if(0===this._geometries.length)return c;for(let n=0;n<this._geometries.length;++n)this._near[n]>c.far&&(c.far=this._near[n]),this._near[n]>2&&this._far[n]<c.near&&(c.near=this._far[n]);const f=this._looseRange;f.near=Math.max(.5*c.near,2),f.far=2*c.far;let _=0,u=0;for(let n=0;n<this._geometries.length;++n)this._near[n]<c.near&&(this._near[n]>=f.near?c.near=this._near[n]:this._nearCandidates[_++]=n),this._far[n]>c.far&&(this._far[n]<=f.far?c.far=this._far[n]:this._farCandidates[u++]=n);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return c;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let n=0;n<this._nearCandidates.length;++n){const e=this._nearCandidates[n];if(this._near[e]<c.near){const t=this._geometries[e],r=t.boundingInfo;this._includeNearBoundingInfoRec(r,t.shaderTransformation,c)}}for(let n=0;n<this._farCandidates.length;++n){const e=this._farCandidates[n];if(this._far[e]>c.far){const t=this._geometries[e],r=t.boundingInfo;this._includeFarBoundingInfoRec(r,t.shaderTransformation,c)}}return this._reset(),c}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,t,r){if(null==e)return;const n=e.center;a.transformMat4(c.getCenter(F),n,t);const i=f.maxScale(t),s=F[0],o=F[1],h=F[2],l=e.radius*i,_=this._frustum;if(_[0][0]*s+_[0][1]*o+_[0][2]*h+_[0][3]>l||_[1][0]*s+_[1][1]*o+_[1][2]*h+_[1][3]>l||_[2][0]*s+_[2][1]*o+_[2][2]*h+_[2][3]>l||_[3][0]*s+_[3][1]*o+_[3][2]*h+_[3][3]>l)return;const u=this._view[2]*s+this._view[6]*o+this._view[10]*h+this._view[14],d=u+l;if(!(-(u-l)<2||-d>=r.near))if(-d>this._looseRange.near)r.near=-d;else{if(l>m){const n=e.getChildren();if(void 0!==n){for(const e of n)this._includeNearBoundingInfoRec(e,t,r);return}}N.unionDepthRangeWithAABB(r,this._viewProj,t,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,t,r){if(null==e)return;let n=e.radius;const i=e.center;a.transformMat4(c.getCenter(F),i,t);const s=f.maxScale(t),o=F[0],h=F[1],l=F[2];n*=s;const _=this._frustum;if(_[0][0]*o+_[0][1]*h+_[0][2]*l+_[0][3]>n||_[1][0]*o+_[1][1]*h+_[1][2]*l+_[1][3]>n||_[2][0]*o+_[2][1]*h+_[2][2]*l+_[2][3]>n||_[3][0]*o+_[3][1]*h+_[3][2]*l+_[3][3]>n)return;const u=this._view[2]*o+this._view[6]*h+this._view[10]*l+this._view[14]-n;if(!(-u<=r.far))if(-u<this._looseRange.far)r.far=-u;else{if(n>m){const n=e.getChildren();if(void 0!==n){for(const e of n)this._includeFarBoundingInfoRec(e,t,r);return}}N.unionDepthRangeWithAABB(r,this._viewProj,t,e.bbMin,e.bbMax)}}}class T{constructor(){this._modelViewProj=i.create(),this._clipPosition=[o.create(),o.create(),o.create(),o.create(),o.create(),o.create(),o.create(),o.create()]}unionDepthRangeWithAABB(e,t,r,i,a){const s=this._modelViewProj;n.multiply(s,t,r);let o=!1;for(let n=0;n<8;++n){const e=this._clipPosition[n],t=0===n||3===n||4===n||7===n?i[0]:a[0],r=0===n||1===n||4===n||5===n?i[1]:a[1],o=n<4?i[2]:a[2];e[0]=s[0]*t+s[4]*r+s[8]*o+s[12],e[1]=s[1]*t+s[5]*r+s[9]*o+s[13],e[2]=s[2]*t+s[6]*r+s[10]*o+s[14],e[3]=s[3]*t+s[7]*r+s[11]*o+s[15]}for(let n=0;n<12;++n){const t=this._clipPosition[D[n][0]],r=this._clipPosition[D[n][1]],i=this._clipPosition[D[n][2]],a=this._clipTriangle(t,r,i);let s=!0;for(let e=0;e<a.length;++e){if(a[e][3]>=2){s=!1;break}}if(!s){o=!0;for(let t=0;t<a.length;++t){const r=a[t][3];Number.isFinite(r)&&(e.near=Math.min(r,e.near),e.far=Math.max(r,e.far))}}}return o}_inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void u.assert(!1)}_intersect(e,t,r){let n=0;return 0===r?n=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?n=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?n=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(n=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),s.lerp(o.create(),e,t,n)}_clipTriangle(e,t,r){let n=[e,t,r];for(let i=0;i<4;++i){const e=n;n=[];for(let t=0;t<e.length;++t){const r=e[t],a=e[(t+1)%e.length];this._inside(a,i)?(this._inside(r,i)||n.push(this._intersect(r,a,i)),n.push(a)):this._inside(r,i)&&n.push(this._intersect(r,a,i))}}return n}}const D=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],F=c.create(),j=i.create(),S=l.empty(),I=new O,P=new x,N=new T;e.DepthRangeFromRenderGeometries=x,e.depthRangeFromLayer=v,e.depthRangeFromScene=w,e.textureToDepth=R,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
