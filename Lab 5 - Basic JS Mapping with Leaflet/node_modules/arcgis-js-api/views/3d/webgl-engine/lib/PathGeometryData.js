/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/FloatArray","../../../../geometry/support/Indices","./Attribute","./Normals","./VertexAttribute","../materials/internal/MaterialUtil"],(function(t,e,r,i,s,o,a,n,l,h,u,c){"use strict";class b{constructor(t){this.builder=t}onPathChanged(t){this.builder.onPathChanged()}}class A extends b{constructor(t){super(t),this.vertexAttributeColor=o.fromValues(255,255,255,255),this.size=new Array,this.vertexAttributePosition=a.newFloatArray(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Int16Array(2*this.builder.numVerticesTotal)}bakeVertexColors(t){this.vertexAttributeColor[0]=255*t[0],this.vertexAttributeColor[1]=255*t[1],this.vertexAttributeColor[2]=255*t[2],this.vertexAttributeColor[3]=255*(t.length>3?t[3]:1)}bake(t){this.size=t;const{numVerticesTotal:r,pathVertexData:s,path:o,positions:a,profileRightAxes:n,profileUpAxes:l,profileVertexAndNormals:u}=this.builder;for(let c=0;c<r;++c){let r=s[c];const b=0===r||r===o.vertices.length-1;r*=3;const A=m;let x=0,f=0;const I=4*c,y=i.set(V,n[I],n[I+1],n[I+2]),C=i.set(P,l[I],l[I+1],l[I+2]),O=e.set(v,u[I]*t[0],u[I+1]*t[1]);if(b)i.cross(A,C,y),x=n[I+3]*t[0],f=l[I+3];else{const t=d,r=p;e.set(t,n[I+3],l[I+3]);const s=e.length(t);e.normalize(t,t);const o=e.dot(O,t);if(Math.abs(o)>s){e.set(r,-t[1],t[0]);const i=e.dot(O,r);e.scale(t,t,s*Math.sign(o)),e.scale(r,r,i),e.add(O,t,r)}i.set(A,0,0,0)}const w=i.set(g,y[0]*O[0]+C[0]*O[1],y[1]*O[0]+C[1]*O[1],y[2]*O[0]+C[2]*O[1]),D=3*c;this.vertexAttributePosition[D]=a[r]+w[0]+A[0]*x,this.vertexAttributePosition[D+1]=a[r+1]+w[1]+A[1]*x,this.vertexAttributePosition[D+2]=a[r+2]+w[2]+A[2]*x;const N=e.set(v,u[I+2],u[I+3]);h.compressNormal(this.vertexAttributeNormal,c,y[0]*N[0]+C[0]*N[1]+A[0]*f,y[1]*N[0]+C[1]*N[1]+A[1]*f,y[2]*N[0]+C[2]*N[1]+A[2]*f)}}createGeometryData(){const t=this.builder.vertexIndices.length,{normalIndices:e,vertexIndices:r}=this.builder;return[[u.VertexAttribute.POSITION,new l.Attribute(this.vertexAttributePosition,r,3,!0)],[u.VertexAttribute.NORMALCOMPRESSED,new l.Attribute(this.vertexAttributeNormal,e,2,!0)],[u.VertexAttribute.COLOR,new l.Attribute(this.vertexAttributeColor,n.getZeroIndexArray(t),4)]]}onPathChanged(t){super.onPathChanged(t),this.bake(this.size)}intersect(t,e,r){const i=this.builder.vertexIndices,s=new l.Vertices(this.vertexAttributePosition,3),o=i.length/3;c.intersectTriangles(t,e,0,o,i,s,void 0,void 0,r)}}class x extends b{constructor(t,e,r,i){super(t),this.sizeAttributeValue=e,this.colorAttributeValue=r,this.opacityAttributeValue=i,this.vvData=null,this.baked=new A(t),this.vvData=a.newFloatArray(4*this.builder.path.vertices.length);for(let s=0;s<this.builder.path.vertices.length;++s){this.vvData[4*s]=e,this.vvData[4*s+1]=r,this.vvData[4*s+2]=i;const t=0===s||s===this.builder.path.vertices.length-1;this.vvData[4*s+3]=t?1:0}}createGeometryData(){const{positions:t,profileRightAxes:e,profileUpAxes:r,profileVertexAndNormals:i,pathVertexIndices:s,vertexIndices:o}=this.builder;return[[u.VertexAttribute.POSITION,new l.Attribute(t,s,3,!0)],[u.VertexAttribute.PROFILERIGHT,new l.Attribute(e,o,4,!0)],[u.VertexAttribute.PROFILEUP,new l.Attribute(r,o,4,!0)],[u.VertexAttribute.PROFILEVERTEXANDNORMAL,new l.Attribute(i,o,4,!0)],[u.VertexAttribute.FEATUREVALUE,new l.Attribute(this.vvData,s,4,!0)]]}onPathChanged(t){super.onPathChanged(t);const e=t.getMutableAttribute(u.VertexAttribute.POSITION);e&&(e.data=this.builder.positions)}}const v=r.create(),d=r.create(),p=r.create(),g=s.create(),m=s.create(),V=s.create(),P=s.create();t.FastUpdatePathGeometry=x,t.PathGeometryData=b,t.StaticPathGeometry=A,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
