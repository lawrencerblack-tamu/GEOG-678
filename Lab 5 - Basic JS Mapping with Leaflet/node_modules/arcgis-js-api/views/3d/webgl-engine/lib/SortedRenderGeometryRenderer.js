/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/PooledArray","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/sphere","../../terrain/Intersector","../core/shaderLibrary/ShaderOutput","./ChangeSet","./Intersector","./IntersectorInterfaces","./Material","./ModelDirtyTypes","./rendererUtils","./RenderSlot","../materials/renderers/MergedRenderer"],(function(e,r,t,s,i,n,o,a,d,h,l,c,p,u,m,g,y,_,R,f,S){"use strict";e.SortedRenderGeometryRenderer=class extends t{constructor(e){super(e),this._pending=new G,this._changes=new u.ChangeSet,this._materialRenderers=new s,this._sortedMaterialRenderers=new s,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forAll((e=>e.destroy())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){return this._materialRenderers.some((e=>0!==e.numGeometries&&!e.queryRenderOccludedState(y.RenderOccludedFlag.Occlude)))}get isEmpty(){return!this.updating&&0===this._materialRenderers.length&&0===this._geometries.size}getMemoryForMaterial(e){if(null==e)return 0;const r=this._materialRenderers.find((r=>r.materialReference===e));return r?.usedMemory??0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=R.splitRenderGeometryChangeSetByMaterial(this._changes);let r=!1;return e.forEach(((e,t)=>{let s=this._materialRenderers.find((e=>e.materialReference===t));if(!s&&e.adds.length>0){const e=new S.MergedRenderer({material:t});e.initializeRenderContext(this.rendererContext.pluginContext,this._materialRepository),s=e,this._materialRenderers.push(s),r=!0}s&&(s.modify(e),0===s.numGeometries&&(this._materialRenderers.removeUnordered(s),s.destroy(),r=!0))})),this._changes.clear(),r&&this._updateSortedMaterialRenderers(),this._hasHighlights=this._materialRenderers.some((e=>{const r=e.produces.get(f.RenderSlot.DRAPED_MATERIAL);return!!r&&r(p.ShaderOutput.Highlight)})),this._hasWater=this._materialRenderers.some((e=>{const r=e.produces.get(f.RenderSlot.DRAPED_WATER);return!!r&&r(p.ShaderOutput.Normal)})),this.notifyChange("updating"),!0}addGeometries(e,r){if(0===e.length)return;const t=this._validateRenderGeometries(e);for(const i of t)this._geometries.set(i.id,i);const s=this._pending.empty;for(const i of t)this._pending.adds.add(i);s&&this.notifyChange("updating"),r===_.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,r){const t=this._pending.empty,s=this._pending.adds;for(const i of e)s.has(i)?(this._pending.removed.add(i),s.delete(i)):this._pending.removed.has(i)||this._pending.removes.add(i),this._geometries.delete(i.id);t&&!this._pending.empty&&this.notifyChange("updating"),r===_.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,r){const t=0===this._changes.updates.length;for(const s of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(s),e.updateType=r}switch(t&&this._changes.updates.length>0&&this.notifyChange("updating"),r){case _.DirtyState.TRANSFORMATION:case _.DirtyState.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case _.DirtyState.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let r=!1;return this._sortedMaterialRenderers.forAll((t=>r=!!t.updateAnimation&&t.updateAnimation(e)||r)),r}shouldRender(e){return this._sortedMaterialRenderers.some((r=>r.prepareTechnique(e)))}render(e){this._sortedMaterialRenderers.forAll((r=>{const t=r.prepareTechnique(e);null!=t&&r.renderNode(e,t)}))}intersect(e,r,t,s,i){return this._geometries.forEach((n=>{if(s&&!s(n))return;this._intersectRenderGeometry(n,t,r,0,e,i);const o=this.rendererContext.longitudeCyclical;o&&(n.boundingSphere[0]-n.boundingSphere[3]<o.min&&this._intersectRenderGeometry(n,t,r,o.range,e,i),n.boundingSphere[0]+n.boundingSphere[3]>o.max&&this._intersectRenderGeometry(n,t,r,-o.range,e,i)),i++})),i}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear(),this._materialRenderers.forAll(((e,r)=>{e.drapedPriority=r,this._sortedMaterialRenderers.push(e)})),this._sortedMaterialRenderers.sort(((e,r)=>r.materialReference?.renderPriority===e.materialReference?.renderPriority?e.drapedPriority-r.drapedPriority:(r.materialReference?.renderPriority||0)-(e.materialReference?.renderPriority||0)))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const r=this._changes.updates.data[e];this._pending.has(r.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,r,t,s,i,n){if(!e.visible)return;let o=0;s+=e.transformation[12],o=e.transformation[13],C[0]=t[0]-s,C[1]=t[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,i,C,((t,s,o)=>{v(r,o,n,e.material.renderPriority,i,e.layerUid,e.graphicUid)}),r)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let r;for(const t of e){const e=t.graphicUid;null!=e&&e!==r&&(this.drapeSource.notifyGraphicGeometryChanged(e),r=e)}}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let r;for(const t of e){const e=t.graphicUid;null!=e&&e!==r&&(this.drapeSource.notifyGraphicVisibilityChanged(e),r=e)}}_validateRenderGeometries(e){for(const r of e)this._validateRenderGeometry(r);return e}_validateRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin(l.getCenter(e.boundingSphere))),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}},r.__decorate([i.property()],e.SortedRenderGeometryRenderer.prototype,"drapeSource",void 0),r.__decorate([i.property()],e.SortedRenderGeometryRenderer.prototype,"updating",null),r.__decorate([i.property()],e.SortedRenderGeometryRenderer.prototype,"rctx",null),r.__decorate([i.property({constructOnly:!0})],e.SortedRenderGeometryRenderer.prototype,"rendererContext",void 0),r.__decorate([i.property()],e.SortedRenderGeometryRenderer.prototype,"_materialRepository",null),r.__decorate([i.property()],e.SortedRenderGeometryRenderer.prototype,"_localOriginFactory",null),r.__decorate([i.property({readOnly:!0})],e.SortedRenderGeometryRenderer.prototype,"isEmpty",null),r.__decorate([i.property()],e.SortedRenderGeometryRenderer.prototype,"_materialRenderers",void 0),r.__decorate([i.property()],e.SortedRenderGeometryRenderer.prototype,"_geometries",void 0),e.SortedRenderGeometryRenderer=r.__decorate([d.subclass("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],e.SortedRenderGeometryRenderer);class G{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}function v(e,r,t,s,i,n,o){const a=new c.OverlayTarget(n,o,r),d=r=>{r.set(g.IntersectorType.OVERLAY,a,e.dist,e.normal,e.transformation,t,s)};if((null==i.results.min.drapedLayerOrder||t>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&d(i.results.min),i.options.store!==g.StoreResults.MIN&&(null==i.results.max.drapedLayerOrder||t<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&d(i.results.max),i.options.store===g.StoreResults.ALL){const e=m.newIntersectorResult(i.ray);d(e),i.results.all.push(e)}}const C=h.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
