/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/arrayUtils","../../../../core/colorUtils","../../../../core/has","../../../../core/maybe","../../../../core/PooledArray","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/accessorSupport/interfaces","../../../../core/accessorSupport/tracking/Flags","../../../../core/Warning","../../../../core/Error","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../chunks/boundedPlane","../../support/debugFlags","../../terrain/TerrainRenderer","../../webgl/formats","../core/FBOCache","../core/renderPasses/RenderPassManager","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/hud/HUDRenderStyle","../effects/RenderNodes","../effects/RenderPlugin","../effects/RenderPluginManager","../effects/blit/Blit","../effects/highlight/Highlight","../effects/highlight/ShadowHighlight","../effects/smaa/SMAA","../effects/ssao/SSAO","./AnimationTimeStep","./basicInterfaces","./BoundingInfo","./depthRange","./depthRangeUtils","./Material","./OffscreenRendering","./RenderContext","./rendererUtils","./RenderFeature","./RenderSlot","./ShadowAccumulator","./ShadowMap","./SliceHelper","./TransparencyPassType","./edgeRendering/EdgeView","./edgeRendering/interfaces","../materials/renderers/MergedRenderer","../shaders/CompositingTechniqueConfiguration","../statistics/RendererPerformanceInfo","../../../support/RenderState","../../../webgl/enums"],(function(e,r,t,s,i,a,n,h,o,d,l,_,p,u,c,m,g,f,T,R,S,A,b,E,P,y,C,O,D,I,w,M,N,F,H,L,x,v,U,B,q,G,V,Q,k,W,j,Y,X,z,J,K,Z,$,ee,re,te){"use strict";class se{constructor(e,r,t,a,n,d,l,_){this._stage=e,this._techniqueRepository=a,this._rctx=n,this._compositingHelper=d,this._magnifierHelper=l,this._requestRender=_,this._pluginsHas={hudElements:!1,water:!1},this._hasOverlayWater=!1,this.renderOverlay=e=>{},this._isRendering=!1,this._backgroundColor=T.fromValues(0,0,0,1),this._sliceHelper=new X,this._state=o.signal(re.RenderState.IDLE),this._highQualityTransparencyEnabled=!0,this._terrainTransparency=A.TransparencyMode.Opaque,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new L.AnimationTimeStep,this._reprojectionMatrixVersion=o.signal(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new Map,this._releaseNormals=e=>{e.find((({name:e})=>"normals"===e))?.release()&&this._pluginInput.delete("normals")},this._debugLinearDepth=!1,this.fboCache=new E.FBOCache(n),this._renderStateFeatures=o.signal(k.setupFeatureDefaults(!i("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._offscreen=new G.OffscreenRendering(this.fboCache,this._compositingHelper),this.performanceInfo=new ee.RendererPerformanceInfo(this._rctx),this._shadowMap=new Y.ShadowMap(this.fboCache,e.viewingMode),this._highlight=new M.Highlight({view:e.view}),this._shadowHighlight=new N.ShadowHighlight({view:e.view,viewingMode:e.viewingMode}),this._shadowAccumulator=new j.ShadowAccumulator(this.fboCache,a,e,(e=>{const r=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=r}),((e,r,t)=>{const s=this._stage.view.qualitySettings.maximumPixelRatio;e.shadowMap.start(e.camera,r,t,!0,s),this._renderShadowCascades(y.ShaderOutput.Shadow,e.shadowMap),e.shadowMap.finish(),e.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(e.camera,e.contentCamera)}),_),this._ssao=new H.SSAO({view:this._stage.view}),this._renderContext=new V.RenderContext(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper),this._nodes=new O.RenderNodes(this._renderContext),this._plugins=new I.RenderPluginManager({renderContext:this._renderContext,techniqueRepository:a,textureRepository:t,materialRepository:r,requestRender:_,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this.renderPassManager=new P.RenderPassManager,this._plugins.add(this.renderPassManager),this._smaa=new F.SMAA({view:this._stage.view}),this._plugins.add(this._smaa),this._blit=new w.Blit({opacity:1,alphaMode:$.AlphaMode.None}),this._plugins.add(this._blit),this._plugins.add(this._ssao),this._plugins.add(this._highlight),this._plugins.add(this._shadowHighlight),this._handles=[h.watch((()=>this._stage.view.state.camera),(()=>_()),h.syncAndInitial),h.watch((()=>S.debugFlags.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(K.Transparency.TRANSPARENT):()=>{},_()}),h.initial),h.watch((()=>this._stage.view.environment.background?.color),(e=>{const r=e?s.unitRGBAFromColor(e):T.ZEROS;f.set(this._backgroundColor,r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),_()}),h.syncAndInitial)]}destroy(){this._handles.forEach((e=>e.remove())),this._gpuTimerHandle=a.removeMaybe(this._gpuTimerHandle),this._nodes.destroy(),this._offscreen.dispose(),this._shadowMap.dispose(),this._highlight.dispose(),this._shadowAccumulator.dispose(),this._edgeView=a.destroyMaybe(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),v.BoundingInfo.prune()}get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(e=null,r=!i("disable-feature:high-quality-idle")){this._renderStateFeatures.value=k.setupFeatureDefaults(r,e),this._plugins.renderFeatureChanged(),this._requestRender()}isFeatureEnabled(e,r=this._state.value){return this._renderStateFeatures.value.get(r,e)??!1}setFeatureEnabled(e,r,t){this._renderStateFeatures.mutate((s=>s.set(r,e,t))),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(k.RenderFeature.HighQualityTransparency)}get hasReflections(){return(this._pluginsHas.water||this._hasOverlayWater)&&(this._ssrEnabled||this.isFeatureEnabled(k.RenderFeature.WaterReflection))}get hasDecorations(){return this._plugins.hasDecorations}get hasHighlights(){return this._plugins.produces(W.RenderSlot.OPAQUE_MATERIAL,y.ShaderOutput.Highlight)||this._plugins.produces(W.RenderSlot.TRANSPARENT_MATERIAL,y.ShaderOutput.Highlight)||this._plugins.produces(W.RenderSlot.DRAPED_MATERIAL,y.ShaderOutput.Highlight)}get _magnifierEnabled(){return this._bindParameters.decorations===x.Decorations.ON&&this._magnifierHelper.enabled}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(k.RenderFeature.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=a.releaseMaybe(this._bindParameters.ssr.lastFrameColor),this._bindParameters.multipassTerrain.linearDepth=a.releaseMaybe(this._bindParameters.multipassTerrain.linearDepth),this._bindParameters.multipassGeometry.linearDepth=a.releaseMaybe(this._bindParameters.multipassGeometry.linearDepth)}_disposeOffscreenBuffers(){this._offscreen.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.linearDepth=a.releaseMaybe(this._bindParameters.linearDepth),this._bindParameters.hudVisibility=a.releaseMaybe(this._bindParameters.hudVisibility)}get updating(){return this._smaa.updating||null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}ensureEdgeView(){if(null==this._edgeView){const e=this._stage.view.resourceController;this._edgeView=new J.EdgeView({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:_e(e)}),this._handles.push(h.watch((()=>this._edgeView?.updating),(()=>this._requestRender()),h.sync)),this._requestRender()}return this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&m.equals(this._bindParameters.ssr.reprojectionMatrix,g.IDENTITY)}set _reprojectionMatrix(e){t.update(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:r,_bindParameters:t}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&r.maxCascades!==e.shadowMapMaxCascades&&(r.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){null!=e.environment.weather&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const r="virtual"!==e.environment.lighting.type;t.enableFillLights!==r&&(t.enableFillLights=r,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,r){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:s,updates:i}=e;if(0===t.length&&0===s.length&&0===i.length)return;const a=Q.splitRenderGeometryChangeSetByMaterial(e);let n=!1;a.forEach(((t,s)=>{if(r.done)return;let i=this._plugins.getMaterialRenderer(s);if(null==i&&t.adds.length>0){const e=new Z.MergedRenderer({material:s});e.initializeRenderContext(this._plugins._context),i=e,this._plugins.add(i)}i&&(i.modify(t),0===i.numGeometries&&(n=!0)),t.removes.forEach((r=>e.removes.removeUnordered(r))),t.adds.forEach((r=>e.adds.removeUnordered(r))),t.updates.forEach((r=>e.updates.removeUnordered(r))),r.madeProgress()})),n&&this._plugins.removeEmptyMaterialRenderers(),this._updateHasFlags(),this._requestRender()}_updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(W.RenderSlot.LINE_CALLOUTS_HUD_DEPTH)||this._plugins.produces(W.RenderSlot.HUD_MATERIAL)||this._plugins.produces(W.RenderSlot.LABEL_MATERIAL),e.water=this._plugins.produces(W.RenderSlot.DRAPED_WATER,y.ShaderOutput.Normal),this._bindParameters.hasOccludees=this._plugins.hasOccludees}updateAnimation(e){const r=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(e),this._hasAnimations=this._nodes.updateAnimation()||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?a.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,r,t=Q.RendererTarget.Default,s=x.Decorations.ON){this._isRendering=!0,this.performanceInfo.startFrame(),this.fboCache.frameStart(),this._disposeBindBuffers();const i=this._offscreen,{camera:n,contentCamera:h,mode:o,alignPixelEnabled:d}=e;this._state.value=o,this._bindParameters.overlay=this.renderOverlay(r),this.performanceInfo.advance(ee.PerformanceCategory.OVERLAY),this._renderContext.time=r,this._bindParameters.transparencyPassType=z.TransparencyPassType.NONE,this._bindParameters.alignPixelEnabled=d,this._bindParameters.decorations=s,this._bindParameters.mainColor=this._bindParameters.mainDepth=null;const l=R.create(this._sliceHelper.plane);s===x.Decorations.OFF&&(this._sliceHelper.plane=null),n.setGLViewport(this._rctx);const _=i.initializeFrame(n,this._backgroundColor,t);this.hasReflections?this._bindParameters.ssr.lastFrameColor=_:_?.release(),this._ensureBindParametersCamera(n,h),this._plugins.prepareRender(),this.performanceInfo.advance(ee.PerformanceCategory.PREPARE);const p=this._computeDepthRange(n);this._renderShadowMap(n,this._bindParameters.lighting.mainLight.direction,p),this.performanceInfo.advance(ee.PerformanceCategory.SHADOW_MAP),this._ensureBindParametersCamera(n,h);const u=this._plugins.produces(W.RenderSlot.OPAQUE_TERRAIN)&&(this._terrainTransparency===A.TransparencyMode.Semitransparent||this._terrainTransparency===A.TransparencyMode.TransparentWithDraped),c=this._highQualityTransparency&&u,m=this._plugins.produces(W.RenderSlot.TRANSPARENT_MATERIAL,y.ShaderOutput.Color);this._prepareShaders(c,m),this._pluginInput.set("normals",this._renderNormals()),this.performanceInfo.advance(ee.PerformanceCategory.NORMALS),this._renderSSAO(),this.performanceInfo.advance(ee.PerformanceCategory.SSAO),this._renderLinearDepth(),this.performanceInfo.advance(ee.PerformanceCategory.LINEAR_DEPTH),this._renderShadowAccumulation(p,n,h),this.performanceInfo.advance(ee.PerformanceCategory.ACCUMULATED_SHADOWS),this._ensureBindParametersSSR(r),this._renderContext.output=y.ShaderOutput.Color,i.bindFbo(),this._bindParameters.mainColor=i.colorTexture,this._bindParameters.mainDepth=i.depthTexture,this._renderOpaqueGeometry(),this._offscreen.updateColor((e=>this._invokeRenderNodes(e)),"opaque-color"),this._plugins.render(W.RenderSlot.ENVIRONMENT_OPAQUE),this.performanceInfo.advance(ee.PerformanceCategory.OPAQUE),this.fboCache.debugCallback&&this.fboCache.debugCallback("opaque-color",this._offscreen.color.fbo),this._renderTerrainLinearDepth(c),this._setMultipassTerrain(c),this._renderEdges(K.Transparency.OPAQUE),this.performanceInfo.advance(ee.PerformanceCategory.OPAQUE_EDGES),i.bindFbo(),this._plugins.render(W.RenderSlot.VOXEL),this.performanceInfo.advance(ee.PerformanceCategory.VOXEL),this._renderHiddenTransparentEdges(),m&&(this._oitEnabled?this._renderOITPass(ie.Geometry):this._renderTransparentMaterial()),this._offscreen.updateColor((e=>this._invokeRenderNodes(e)),"transparent-color"),this.performanceInfo.advance(ee.PerformanceCategory.TRANSPARENT);const g=this._renderGeometryLinearDepth(c);this._renderHUDVisibility(g),c||this._plugins.render(W.RenderSlot.LINE_CALLOUTS),this.performanceInfo.advance(ee.PerformanceCategory.HUD_VISIBILITY);const f=t===Q.RendererTarget.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this.performanceInfo.advance(ee.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(K.Transparency.TRANSPARENT,g),g?.release(),this.performanceInfo.advance(ee.PerformanceCategory.TRANSPARENT_EDGES);const T=u?this._renderTransparentTerrain():null;T&&this._bindParameters.hudVisibility&&(c?this._renderLineCallouts(C.HUDRenderStyle.Occluded):i.compositeToHUDVisibility(this._bindParameters,T.getTexture()),this._renderHUD(C.HUDRenderStyle.Occluded,i.color),this.performanceInfo.advance(ee.PerformanceCategory.HUD_OCCLUDED)),this.performanceInfo.advance(ee.PerformanceCategory.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),T&&(i.compositeToFramebuffer(this._bindParameters,T.getTexture(),$.AlphaMode.PremultipliedAlpha,1),T.release(),c&&(this._renderEdges(K.Transparency.OPAQUE),this.performanceInfo.advance(ee.PerformanceCategory.OPAQUE_EDGES),m&&(this._oitEnabled?this._renderOITPass(ie.Geometry):this._renderTransparentMaterial()),this.performanceInfo.advance(ee.PerformanceCategory.TRANSPARENT),this._renderEdges(K.Transparency.TRANSPARENT),this.performanceInfo.advance(ee.PerformanceCategory.TRANSPARENT_EDGES))),this._bindParameters.ssao=a.releaseMaybe(this._bindParameters.ssao),c&&this._renderLineCallouts(C.HUDRenderStyle.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),i.bindFbo(),this._plugins.render(W.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.render(W.RenderSlot.ENVIRONMENT_TRANSPARENT),this.performanceInfo.advance(ee.PerformanceCategory.ENVIRONMENT),this._renderLaserlines(),this.performanceInfo.advance(ee.PerformanceCategory.LASER_LINES),this._renderOccluded(),this.performanceInfo.advance(ee.PerformanceCategory.OCCLUDED);let S=this._renderHighlightPrepass();S&&this._renderShadowHighlights(S,this._bindParameters);const b=this._magnifierEnabled&&t===Q.RendererTarget.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"magnifier"):null,E=t!==Q.RendererTarget.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"screenshot"):null,P=this._renderComposite(b??E,S)??E;return this.performanceInfo.advance(ee.PerformanceCategory.ANTIALIASING),this._renderHUD(C.HUDRenderStyle.NotOccluded,P),this.performanceInfo.advance(ee.PerformanceCategory.HUD),S&&(this._renderHighlights(P,S,this._bindParameters),S=a.releaseMaybe(S)),this.performanceInfo.advance(ee.PerformanceCategory.HIGHLIGHTS),this._magnifierEnabled&&this._magnifierHelper.render(this._rctx,this._bindParameters),P!==E&&(this._rctx.bindFramebuffer(E?.fbo),this._compositingHelper.composite(this._bindParameters,b?.getTexture(),$.AlphaMode.None)),t===Q.RendererTarget.Default&&b?.release(),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),this._offscreen.releaseBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=l,this._isRendering=!1,this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),t!==Q.RendererTarget.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),{screen:E,oid:f}}_prepareShaders(e,r){this._renderContext.output=y.ShaderOutput.Color,this._prepareOpaqueGeometry(),this._setMultipassTerrain(e),this._plugins.prepare(W.RenderSlot.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),e||this._plugins.prepare(W.RenderSlot.LINE_CALLOUTS),r&&this._prepareTransparencySlots(),this._plugins.prepare(W.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.prepare(W.RenderSlot.ENVIRONMENT_TRANSPARENT),this._plugins.prepare(W.RenderSlot.LASERLINES),this._rctx.gl.flush()}_renderObjectAndLayerIdColor(){if(!i("enable-feature:objectAndLayerId-rendering"))return;const e=this._renderContext.output,r=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oid");return r.acquireDepth(b.DepthFormat.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(r.fbo),this.fboCache.rctx.clearFramebuffer([0,0,0,0],!0,!0),this._renderAllGeometry(y.ShaderOutput.ObjectAndLayerIdColor),this._rctx.bindFramebuffer(r.fbo),this.fboCache.rctx.clearFramebuffer(void 0,!0,!0),this._bindParameters.hudRenderStyle=C.HUDRenderStyle.NotOccluded,this._plugins.render(W.RenderSlot.HUD_MATERIAL),this._renderContext.output=e,r}finish(e){this._hasAnimations||this._animationTimestep.clear();const r=this.performanceInfo.gpuSamplingEnabled,t=e===x.RenderRequestType.BACKGROUND;if(t||r){const e=t?this.performanceInfo.elapsedTime:0,s=r?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),i=Math.max(e,s);this._animationTimestep.frame(i,t)}}readDepthPixels(e,r,t){const s=this._bindParameters.linearDepth?.fbo;if(s?.colorTexture)return void s.readPixels(r[0],r[1],r[2],r[3],te.PixelFormat.RGBA,te.PixelType.UNSIGNED_BYTE,t);const i=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"depth").acquireDepth(b.DepthFormat.DEPTH16_BUFFER);this._rctx.bindFramebuffer(i.fbo),this._ensureBindParametersCamera(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const a=te.ClearBufferBit.COLOR_BUFFER_BIT|te.ClearBufferBit.DEPTH_BUFFER_BIT|te.ClearBufferBit.STENCIL_BUFFER_BIT;this._rctx.clearSafe(a),this._renderAllGeometry(y.ShaderOutput.LinearDepth),i.fbo.readPixels(r[0],r[1],r[2],r[3],te.PixelFormat.RGBA,te.PixelType.UNSIGNED_BYTE,t),i.release()}readHUDVisibility(e,r,t,s,i){this._bindParameters.hudVisibility?.fbo.readPixels(e,r,t,s,te.PixelFormat.RGBA,te.PixelType.UNSIGNED_BYTE,i)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_setMultipassTerrain(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)}_setMultipassEnabled(e){this._bindParameters.multipassEnabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderEdges(e,r){const t=this._edgeView;if(t?.shouldRender()){const{width:s,height:i,depth:a}=this._offscreen,n=this.fboCache.acquire(s,i,"edges"),h=()=>t.render(this._bindParameters,e);this._offscreen.renderToTargets(h,n,r??a,ne),this._offscreen.compositeToFramebuffer(this._bindParameters,n.getTexture(),$.AlphaMode.Alpha,1),n.release()}}_renderShadowMap(e,r,t){const s=this._shadowMap;s.enabled&&(s.start(e,r,t,this.isFeatureEnabled(k.RenderFeature.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._shadowHighlight.updateParameters(e,r),this._needsShadowHighlight?(this._renderShadowCascades(y.ShaderOutput.ShadowHighlight,this._shadowMap),s.moveSnapshot(Y.SnapshotSlot.Highlight),this._renderShadowCascades(y.ShaderOutput.ShadowExcludeHighlight,this._shadowMap),s.copySnapshot(Y.SnapshotSlot.ExcludeHighlight),this._renderShadowCascades(y.ShaderOutput.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(y.ShaderOutput.Shadow),s.finish(),e.setGLViewport(this._rctx))}_renderShadowCascades(e,r=this._shadowMap){for(const t of r.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._renderAllGeometry(e)}get _needsLinearDepth(){return this._plugins.consumes(y.ShaderOutput.LinearDepth)||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast||this._debugLinearDepth}_renderLinearDepth(){this._needsLinearDepth?(this._bindParameters.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.linearDepth,"linear-depth",(()=>this._renderAllGeometry(y.ShaderOutput.LinearDepth)),[0,0,0,0],b.ColorFormat.RGBA,b.DepthFormat.DEPTH_STENCIL_TEXTURE),this._bindParameters.linearDepth.detachDepth()):this._bindParameters.linearDepth=a.releaseMaybe(this._bindParameters.linearDepth)}_renderTerrainLinearDepth(e){if(e){const e=this._renderContext.output;this._renderContext.output=y.ShaderOutput.LinearDepth,this._bindParameters.multipassTerrain.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassTerrain.linearDepth,"terrain depth",(()=>this._renderTransparentTerrain()),[-1e10,-1e10,-1e10,1]),this._bindParameters.multipassTerrain.linearDepth.detachDepth(),this._renderContext.output=e}else this._bindParameters.multipassTerrain.linearDepth=a.releaseMaybe(this._bindParameters.multipassTerrain.linearDepth)}_renderGeometryLinearDepth(e){if(!e)return void(this._bindParameters.multipassGeometry.linearDepth=a.releaseMaybe(this._bindParameters.multipassGeometry.linearDepth));const r=this._renderContext.output;this._bindParameters.multipassGeometry.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassGeometry.linearDepth,"geometry depth",(()=>this._renderOpaqueGeometryAndTransparentMaterial(y.ShaderOutput.LinearDepth)),[1,1,1,1]),this._renderContext.output=r;const t=this._bindParameters.multipassGeometry.linearDepth.getAttachment(te.DepthStencilAttachment);return t?.retain(),this._bindParameters.multipassGeometry.linearDepth.detachDepth(),t}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(e){if(!this._needsDepthRange)return U.zero;const r=B.depthRangeFromScene(e,this._plugins.plugins,this._stage.layers);return U.union(r,this._plugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r}_renderNormals(){const e=this._plugins.produces(W.RenderSlot.SSAO),r=this._nodes.require("normals","composite-color")+this._nodes.require("normals","opaque-color")+this._nodes.require("normals","transparent-color");let t=(e?1:0)+r+(e||r>0?this._nodes.optional("normals","composite-color")+this._nodes.optional("normals","opaque-color")+this._nodes.optional("normals","transparent-color"):0);if(0===t)return;const s=this._offscreen.renderToCachedFBO(null,"normals",(()=>this._renderGeometryForSSAO(y.ShaderOutput.Normal)),[0,0,0,0],b.ColorFormat.RGBA,b.DepthFormat.DEPTH_STENCIL_TEXTURE);for(;--t>0;)s.retain();return s}_renderSSAO(){const e=this._pluginInput.get("normals");this._plugins.produces(W.RenderSlot.SSAO)&&e&&(this._bindParameters.ssao=this._plugins.render(W.RenderSlot.SSAO,this._pluginInput),e.detachDepth(),e.release()&&this._pluginInput.delete("normals"))}_renderAllGeometry(e){this._renderContext.output=e,this._plugins.prepare(W.RenderSlot.TRANSPARENT_TERRAIN),this._renderOpaqueGeometryAndTransparentMaterial(e),this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(e){this._renderContext.output=e,this._plugins.prepare(W.RenderSlot.TRANSPARENT_MATERIAL),this._plugins.prepare(W.RenderSlot.TRANSPARENT_NO_SSAO_DEPTH),this._renderOpaqueGeometry(),this._renderTransparentMaterial()}_renderGeometryForSSAO(e){this._renderContext.output=e,this._plugins.render(W.RenderSlot.INTEGRATED_MESH),this._plugins.render(W.RenderSlot.OPAQUE_TERRAIN),this._plugins.render(W.RenderSlot.OPAQUE_MATERIAL),this._plugins.render(W.RenderSlot.TRANSPARENT_MATERIAL),this._renderTransparentTerrain()}_prepareOpaqueGeometry(){this._plugins.prepare(W.RenderSlot.INTEGRATED_MESH),this._plugins.prepare(W.RenderSlot.OPAQUE_TERRAIN),this._plugins.prepare(W.RenderSlot.OPAQUE_MATERIAL),this._plugins.prepare(W.RenderSlot.OPAQUE_NO_SSAO_DEPTH),this._plugins.prepare(W.RenderSlot.ENVIRONMENT_OPAQUE)}_renderOpaqueGeometry(){this._plugins.render(W.RenderSlot.INTEGRATED_MESH),this._plugins.render(W.RenderSlot.OPAQUE_TERRAIN),this._plugins.render(W.RenderSlot.OPAQUE_MATERIAL),this._plugins.render(W.RenderSlot.OPAQUE_NO_SSAO_DEPTH)}_renderTransparentMaterial(){this._plugins.render(W.RenderSlot.TRANSPARENT_MATERIAL),this._plugins.render(W.RenderSlot.TRANSPARENT_NO_SSAO_DEPTH)}_renderTransparentTerrain(){if(!this._plugins.produces(W.RenderSlot.TRANSPARENT_TERRAIN))return;const e=()=>this._plugins.render(W.RenderSlot.TRANSPARENT_TERRAIN,null);if(this._renderContext.output!==y.ShaderOutput.Color)return void e();const{width:r,height:t,depth:s}=this._offscreen,i=this.fboCache.acquire(r,t,"transparent terrain");return this._offscreen.renderToTargets(e,i,s,[0,0,0,0]),i}_renderHUDVisibility(e){this._plugins.produces(W.RenderSlot.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,(()=>this._plugins.render(W.RenderSlot.OCCLUSION_PIXELS)),e),this._offscreen.bindFbo()):this._bindParameters.hudVisibility=a.releaseMaybe(this._bindParameters.hudVisibility)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===C.HUDRenderStyle.Occluded){const e=()=>{this._plugins.render(W.RenderSlot.LINE_CALLOUTS)},{width:r,height:t,color:s}=this._offscreen,i=this.fboCache.acquireDepth(b.DepthFormat.DEPTH16_BUFFER,r,t,"line callouts");this._offscreen.renderToTargets(e,s,i,void 0,!0,!0),i.release()}else this._plugins.render(W.RenderSlot.LINE_CALLOUTS)}_renderLaserlines(){if(this._plugins.render(W.RenderSlot.LASERLINES),this._plugins.produces(W.RenderSlot.LASERLINES_CONTRAST_CONTROL)){const e=this._offscreen,{width:r,height:t,depth:s}=e,i=this.fboCache.acquire(r,t,"laser lines"),a=()=>this._plugins.render(W.RenderSlot.LASERLINES_CONTRAST_CONTROL);e.renderToTargets(a,i,s,ne),e.compositeToFramebuffer(this._bindParameters,i.getTexture(),$.AlphaMode.PremultipliedAlpha,1),i.release()}}_renderHUD(e,r){if(this._pluginsHas.hudElements)if(this._oitEnabled){const t=this._renderOITPass(ie.HUD,e);this._rctx.bindFramebuffer(r?.fbo),this._compositingHelper.composite(this._bindParameters,t.getTexture(),$.AlphaMode.PremultipliedAlpha),t.release()}else if(e===C.HUDRenderStyle.Occluded){this._renderContext.output=y.ShaderOutput.Color;const r=()=>this._renderHUDElements(e),{width:t,height:s,color:i}=this._offscreen,a=this.fboCache.acquireDepth(b.DepthFormat.DEPTH16_BUFFER,t,s,"hud");this._offscreen.renderToTargets(r,i,a,void 0,!0,!0),a.release()}else this._renderContext.output=y.ShaderOutput.Color,this._rctx.bindFramebuffer(null),r?.acquireDepth(b.DepthFormat.DEPTH16_BUFFER),this._rctx.bindFramebuffer(r?.fbo),this._renderHUDElements(e),r?.detachDepth()}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.prepare(W.RenderSlot.LINE_CALLOUTS_HUD_DEPTH),this._plugins.prepare(W.RenderSlot.HUD_MATERIAL),this._plugins.prepare(W.RenderSlot.LABEL_MATERIAL),this._plugins.render(W.RenderSlot.LINE_CALLOUTS_HUD_DEPTH),this._plugins.render(W.RenderSlot.HUD_MATERIAL),this._plugins.render(W.RenderSlot.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._plugins.produces(W.RenderSlot.SHADOW_HIGHLIGHT)&&this._plugins.produces(W.RenderSlot.OPAQUE_MATERIAL,y.ShaderOutput.ShadowHighlight)}_renderHighlightPrepass(){if(!this.hasHighlights)return;const e=()=>{this._renderAllGeometry(y.ShaderOutput.Highlight),this._rctx.clearSafe(te.ClearBufferBit.DEPTH_BUFFER_BIT),this._renderHUDElements(C.HUDRenderStyle.Both)},r=this._offscreen.renderToCachedFBO(null,"highlights",e,[0,0,0,0],b.ColorFormat.RGBA4,b.DepthFormat.DEPTH_STENCIL_TEXTURE);return r.detachDepth(),r}_renderShadowHighlights(e,r){this.hasHighlights&&r.decorations!==x.Decorations.OFF&&this._needsShadowHighlight&&this._offscreen.updateColor((r=>(this._pluginInput.set("highlights",e),this._plugins.render(W.RenderSlot.SHADOW_HIGHLIGHT,this._pluginInput,r),r)),"transparent-color")}_renderHighlights(e,r,t){this.hasHighlights&&t.decorations!==x.Decorations.OFF&&this._plugins.produces(W.RenderSlot.HIGHLIGHT)&&(this._pluginInput.set("highlights",r),this._plugins.render(W.RenderSlot.HIGHLIGHT,this._pluginInput,e))}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(e,r,t){this._needsShadowCast&&this._bindParameters.linearDepth?.getTexture()&&this._shadowAccumulator.renderAccumulation(this._bindParameters.linearDepth,e,r,t)}_prepareTransparencySlots(){this._renderContext.output=y.ShaderOutput.Alpha,this._bindParameters.transparencyPassType=z.TransparencyPassType.Alpha,this._plugins.prepare(W.RenderSlot.TRANSPARENT_MATERIAL),this._renderContext.output=y.ShaderOutput.Color,this._bindParameters.transparencyPassType=z.TransparencyPassType.Color,this._plugins.prepare(W.RenderSlot.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=z.TransparencyPassType.FrontFace,this._plugins.prepare(W.RenderSlot.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=z.TransparencyPassType.NONE}_renderOITPass(e,r=C.HUDRenderStyle.Both){const t=e===ie.HUD,s=t?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oit hud composite"):null,i=t?()=>this._renderHUDElements(r):()=>this._renderTransparentMaterial(),a=this._renderContext.output;this._renderContext.output=y.ShaderOutput.Alpha,this._bindParameters.transparencyPassType=z.TransparencyPassType.Alpha;const n=this._offscreen.renderOITPass(i,z.TransparencyPassType.Alpha,t);this._renderContext.output=y.ShaderOutput.Color,this._bindParameters.transparencyPassType=z.TransparencyPassType.Color;const h=this._offscreen.renderOITPass(i,z.TransparencyPassType.Color,t);this._bindParameters.transparencyPassType=z.TransparencyPassType.FrontFace;const o=this._offscreen.renderOITPass(i,z.TransparencyPassType.FrontFace,t);return this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,h,n,o,s),s?.detachDepth(),o.release(),h.release(),n.release(),this._bindParameters.transparencyPassType=z.TransparencyPassType.NONE,this._renderContext.output=a,s}_renderOccluded(){let e=0;he.clear(),this._plugins.plugins.forAll((r=>{if(!r.materialReference)return;r.queryRenderOccludedState(q.RenderOccludedFlag.OccludeAndTransparentStencil)&&(e|=q.RenderOccludedFlag.OccludeAndTransparentStencil,he.push(r))}));const r=this._offscreen,t=(t,s,i,a,n)=>{if(0==(e&s))return;const{width:h,height:o,depth:d}=r,l=this.fboCache.acquire(h,o,"tmp color");r.renderToTargets(i,l,d,[0,0,0,0],a,n),r.compositeToFramebuffer(this._bindParameters,l.getTexture(),$.AlphaMode.PremultipliedAlpha,t),l.release()},s=(e,r)=>{this._bindParameters.slot=e,r.forAll((e=>{if(D.isPrepareRenderPlugin(e)){const r=e.prepareTechnique(this._renderContext);r&&e.renderNode(this._renderContext,r)}}))};0!==he.length&&(s(W.RenderSlot.OCCLUDER_MATERIAL,he),t(.5,q.RenderOccludedFlag.OccludeAndTransparentStencil,(()=>s(W.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,he)),!1,!1)),he.clear(),this._plugins.plugins.forAll((r=>{if(!r.materialReference)return;const t=r.queryRenderOccludedState(q.RenderOccludedFlag.OccludeAndTransparent),s=r.queryRenderOccludedState(q.RenderOccludedFlag.Transparent),i=r.queryRenderOccludedState(q.RenderOccludedFlag.Opaque);(t||s||i)&&(e|=t?q.RenderOccludedFlag.OccludeAndTransparent:s?q.RenderOccludedFlag.Transparent:q.RenderOccludedFlag.Opaque,he.push(r))}));const i=this._plugins.renderOccludedFlags;if(e|=i,!e)return;const a=e=>{this._renderContext.renderOccludedMask=e,i>q.RenderOccludedFlag.Occlude&&this._plugins.render(W.RenderSlot.OCCLUDED_TERRAIN),s(W.RenderSlot.OPAQUE_MATERIAL,he),s(W.RenderSlot.TRANSPARENT_MATERIAL,he),s(W.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,he),this._renderContext.renderOccludedMask=V.defaultRenderOccludedMask};this._renderContext.output=y.ShaderOutput.Color,t(.5,q.RenderOccludedFlag.OccludeAndTransparent,(()=>a(q.RenderOccludedFlag.OccludeAndTransparent)),!0,x.StencilBits.OutlineVisualElementMask),t(.5,q.RenderOccludedFlag.Transparent,(()=>a(q.RenderOccludedFlag.Transparent)),!0,x.StencilBits.OutlineVisualElementMask),t(1,q.RenderOccludedFlag.Opaque,(()=>a(q.RenderOccludedFlag.Opaque)),!0,x.StencilBits.OutlineVisualElementMask),he.clear()}_invokeRenderNodes(e){return this._nodes.render(e,this._pluginInput,this._releaseNormals)}_renderComposite(e,r){this._offscreen.updateColor((e=>(this._pluginInput.set("highlights",r),e=this._nodes.render(e,this._pluginInput,this._releaseNormals),this._pluginInput.set(e.name,e),this._pluginInput.delete("highlights"),e)),"composite-color");const t=this._plugins.produces(W.RenderSlot.ANTIALIASING);return this._plugins.render(t?W.RenderSlot.ANTIALIASING:W.RenderSlot.BLIT,this._pluginInput,e)}_ensureBindParametersCamera(e,r){this._bindParameters.camera=e,this._bindParameters.contentCamera=r}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=g.IDENTITY:(m.invert(de,this._bindParameters.camera.viewMatrix),m.invert(oe,this._bindParameters.camera.projectionMatrix),m.multiply(le,de,oe),m.multiply(le,this._renderContext.lastFrameCamera.viewMatrix,le),m.multiply(le,this._renderContext.lastFrameCamera.projectionMatrix,le),this._reprojectionMatrix=le);const r=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=r>0?Math.min(r,e-this._ssrEnableTime)/r:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=g.IDENTITY,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}get test(){return{offscreen:this._offscreen,shadowMap:this._shadowMap,highlight:this._highlight,lighting:this._bindParameters.lighting,renderPlugins:this._plugins,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{this._renderStateFeatures.value=k.setupFeatureDefaults(),this._plugins.renderFeatureChanged(),this._requestRender()},getFramebufferTexture:r=>{switch(r){case e.FramebufferId.Color:return this._offscreen.colorTexture;case e.FramebufferId.LinearDepth:return this._bindParameters.linearDepth?.getTexture();case e.FramebufferId.ShadowMap:return this._shadowMap.depthTexture;case e.FramebufferId.HudVisibility:return this._bindParameters.hudVisibility?.getTexture()}},debugLinearDepth:e=>{this._debugLinearDepth=e,this._requestRender()}}}}var ie,ae;r.__decorate([d.property({readOnly:!0})],se.prototype,"fullResolutionAtmosphere",null),r.__decorate([d.property()],se.prototype,"_smaa",void 0),r.__decorate([d.property()],se.prototype,"_blit",void 0),r.__decorate([d.property()],se.prototype,"_edgeView",void 0),r.__decorate([d.property()],se.prototype,"updating",null),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(ie||(ie={})),e.FramebufferId=void 0,(ae=e.FramebufferId||(e.FramebufferId={}))[ae.Color=0]="Color",ae[ae.LinearDepth=1]="LinearDepth",ae[ae.ShadowMap=2]="ShadowMap",ae[ae.HudVisibility=3]="HudVisibility";const ne=[0,0,0,0],he=new n,oe=g.create(),de=g.create(),le=g.create();function _e(e){return r=>e.immediate.schedule(r)}e.Renderer=se,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
