/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/arrayUtils","../../../../../core/Logger","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../core/support/UpdatingHandles","../../../../../chunks/sphere","../../../../../chunks/vec33","../../../../ViewingMode","../../collections/Component/Material/shader/ComponentData.glsl","../../core/util/TwoVectorPosition","../Attribute","../GridLocalOriginFactory","../localOriginHelper","../LocalOriginManager","../Object3D","../VertexArrayObject","../VertexAttribute","./bufferLayouts","./edgeBufferWriters","./edgePreprocessing","./EdgeRenderer","./EdgeShaderParameters","./EdgeWorkerHandle","./interfaces","./strokes","./util","../TextureBackedBuffer/BufferManager","../../shaders/sources/edgeRenderer/EdgeUtil.glsl","../../../../webgl/BufferObject","../../../../webgl/enums"],(function(e,t,r,s,n,a,i,o,c,d,l,u,g,h,p,f,m,b,y,_,O,E,w,R,x,j,T,v,M,C,S,D,L,P,A,B,V,U,I,k,H){"use strict";function G(e){null!=e&&(e.vao.vertexBuffers.instances.dispose(),e.vao.disposeVAOOnly(),e.vao=null)}function N(e){let t=null,r=null;for(let n=0;n<e.geometries.length;n++){const a=e.geometries[n];if(a.material.supportsEdges){if(t){if(!s.equals(t,a.transformation))return!1}else t=a.transformation;if(r||null==a.localOrigin){if(null!=r?.localOrigin&&null!=a.localOrigin&&r.localOrigin.id!==a.localOrigin.id)return!1}else r=a}}return!0}e.EdgeView=class extends r{constructor(e){super(e),this._updatingHandles=new f.UpdatingHandles,this._perObjectData=new Map,this._perObjectDataEvictionCache=new Set,this._renderers=new Map,this._gpuMemoryUsage=0,this._workerAbort=new AbortController,this._tmpModelPosition=p.create(),this._localOrigins=new x.LocalOriginManager(new w.GridLocalOriginFactory(e.renderSR))}initialize(){this._worker=new P.EdgeWorkerHandle(this.schedule),this._componentColorManager=new U.BufferManager(this.rctx,3);const e=M.VertexLayout.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this._verticesBufferObject=k.BufferObject.createVertex(this.rctx,H.Usage.STATIC_DRAW,e.buffer)}destroy(){this.destroyed||(this._perObjectData.forEach((e=>this._discardObjectEntry(e))),this._perObjectData.clear(),this._strokesTexture=i.disposeMaybe(this._strokesTexture),this._componentColorManager=i.destroyMaybe(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=i.disposeMaybe(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy(),this._set("schedule",te))}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return this._renderers.size>0}async addComponentObject(e,t,r,s,n,a){if(this.hasObject(e))return this.getObjectMemoryUsage(e);let i;const o=new W(new Promise((e=>i=e)),e.obb.center,e.obb.radius);this._perObjectData.set(e,o);const c=await this._updatingHandles.addPromise(this._addComponentGeometry(e.transform,o,t,r,s,n,a));return this.setNeedsRender(),i(),c}async addOrUpdateObject3D(e,t,r,s){if(this.destroyed)return void n.getLogger(this).warn("Attempt to add an object to a destroyed instance");const a=this._perObjectData.get(e);let i;a?.renderables.length>0&&this._perObjectDataEvictionCache.add(a);const o=e.boundingVolumeWorldSpace.bounds,c=new W(new Promise((e=>i=e)),m.getCenter(o),m.getRadius(o));this._perObjectData.set(e,c);const d=new Array;if(r.mergeGeometries&&e.geometries.length>1&&N(e))d.push(this._addObjectMergedGeometries(e,c,t,r,s));else for(let n=0;n<e.geometries.length;n++){const a=e.geometries[n];a.material.supportsEdges&&d.push(this._addGeometry(e,c,a,t[0],r,s))}await this._updatingHandles.addPromise(Promise.all(d)),this._perObjectDataEvictionCache.delete(c),this._discardObjectEntry(a),this.setNeedsRender(),i()}fastUpdateObject3DEdgesTransform(e){if(this.destroyed)return!1;const t=this._perObjectData.get(e);if(!t)return!1;const{geometries:r}=e,{renderables:s}=t;if(0===r.length||0===s.length)return!0;if(s.length>1)return!1;const[n]=s,a=n.transform;if(!(a instanceof z))return!1;const[i]=r;if(i.localOrigin!==a.origin.origin)return!1;const o=g.create(),c=this._computeModelTransformWithLocalOrigin(e,i,o);return n.transform=new z(o,c),this.setNeedsRender(),!0}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this._removeRenderable(e))),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this._perObjectData.has(e)}async updateAllComponentOpacities(e,t){const r=await this._updatingHandles.addPromise(this._getObjectEntry(e));if(null==r)return;const s=t instanceof Array?e=>t[e]:()=>t;r.renderables.forEach((e=>{const t=e.components.meta.length;for(let r=0;r<t;r++){const t=s(r),n=e.components.meta[r],a=n.index;n.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(a,1,3,255*t)}this._updateTransparency(e)})),this.setNeedsRender()}async getObjectMemoryUsage(e){const t=await this._getObjectEntry(e);return null!=t?t.renderables.reduce(((e,t)=>e+t.statistics.gpuMemoryUsage),0):0}async updateAllComponentMaterials(e,t,r,s){const n=e instanceof j.Object3D,a=!!r.hasSlicePlane,i=V.determineRendererType(t),o=D.EdgeRenderer.getKey(i,a,n),c=await this._updatingHandles.addPromise(this._getObjectEntry(e));null!=c&&(c.renderables.forEach((e=>{if(o!==e.rendererKey){const t=this._renderers.get(e.rendererKey),r=this._acquireRenderer(i,a,n);t.removeRenderable(e),--t.refCount,e.rendererKey=o,r.addRenderable(e)}for(let r=0;r<t.length;r++)e.components.meta[r].material=t[r];s&&this._updateComponentBuffer(e.components),this._updateTransparency(e)})),this.setNeedsRender())}async updateAllVerticalOffsets(e,t){const r=await this._updatingHandles.addPromise(this._getObjectEntry(e));null!=r&&(r.renderables.forEach((e=>{const r=e.components.meta;for(let s=0;s<r.length;s++)e.components.meta[s].verticalOffset=t?.[s]??0;this._updateComponentBuffer(e.components)})),this.setNeedsRender())}async updateObjectVisibility(e,t){const r=await this._updatingHandles.addPromise(this._getObjectEntry(e));null!=r&&(r.renderables.forEach((e=>e.visible=t)),this.setNeedsRender())}removeObject(e){const t=this._perObjectData.get(e);t&&(this._perObjectData.delete(e),this._discardObjectEntry(t))}async _getObjectEntry(e){const t=this._perObjectData.get(e);if(!t)throw new Error("no object");return await t.loaded,null==t.loaded?null:t}render(e,t){if(null==this._componentColorManager)return;this._localOrigins.updateViewMatrices(e.camera.viewMatrix);const r=e.camera.viewInverseTransposeMatrix,s=p.create(),n=new O.TwoVectorPosition;let a=0,i=0;if(this._renderers.forEach((r=>{if(0===r.refCount)return this._renderers.delete(r.key),void r.dispose();let s=!0,n=!0;r.forEachRenderable((t=>{t.visible&&(a+=t.statistics.averageEdgeLength,i++,s&&t.regular&&(r.updateTechnique(e,!1),s=!1),n&&t.silhouette&&(r.updateTechnique(e,!0),n=!1))}),t)})),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),0===i)return;const o=40*a/i,c=new L.EdgePassParameters(o,t);h.set(s,r[3],r[7],r[11]),n.set(s),h.copy(c.transformWorldFromViewTH,n.high),h.copy(c.transformWorldFromViewTL,n.low),l.fromMat4(c.transformViewFromCameraRelativeRS,e.camera.viewMatrix),l.transpose(ee,c.transformViewFromCameraRelativeRS),l.invert(c.transformNormalViewFromGlobal,ee),c.transformProjFromView=e.camera.projectionMatrix,this._updateObjectCameraDistances(e),this._renderers.forEach((t=>{this._renderRegularEdges(t,e,c),this._renderSilhouetteEdges(t,e,c)}))}_updateTransparency(e){const t=V.determineEdgeTransparency(e.components.meta),r=V.determineObjectTransparency(e.components.meta);t===e.edgeTransparency&&r===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=r,this._renderers.get(e.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(e,t,r){e.getCombinedShaderTransformation(t,r);const s=null!=t.localOrigin?this._localOrigins.register(t.localOrigin):this._localOrigins.acquire(h.set(this._tmpModelPosition,r[12],r[13],r[14]));return t.localOrigin=s.origin,R.applyToModelMatrix(s.origin.vec3,r),s}_updateComponentBuffer(e){const{meta:t,buffer:r}=e,s=new Uint8Array(4);for(let n=0;n<t.length;n++){const e=t[n].material,i=t[n].index,o=a.clamp(Math.round(e.size*D.lineWidthFractionFactor),0,255),c=a.clamp(e.extensionLength,-D.extensionLengthOffset,255-D.extensionLengthOffset)+D.extensionLengthOffset,d="solid"===e.type?S.EdgeType.SOLID:S.EdgeType.SKETCH,l=255*e.opacity,u=e.color,g=255*u[0],h=255*u[1],p=255*u[2],f=255*u[3];r.textureBuffer.setData(i,0,g,h,p,f),r.textureBuffer.setData(i,1,o,c,d,l),_.encodeElevationOffset(t[n].verticalOffset,s),r.textureBuffer.setData(i,2,s[0],s[1],s[2],s[3])}}_createComponentBuffers(e){if(null==this._componentColorManager)return null;const t=new Array,r=this._componentColorManager.getBuffer(e.length);for(let n=0;n<e.length;n++){const s=e[n],a=r.acquireIndex();t.push({index:a,verticalOffset:0,material:s})}const s=new q(r,t);return this._updateComponentBuffer(s),s}_extractEdges(e,t,r,s,n,a=n.length){return this._worker.process({data:t,indices:n,indicesLength:a,writerSettings:e,skipDeduplicate:r},this._workerAbort.signal,s)}_createRenderable(e,t,r,s,n){const a=t=>null!=this._verticesBufferObject?new F(new T.VertexArrayObject(this.rctx,M.EdgeShaderAttributeLocations,{vertices:M.glVertexLayout,instances:t===I.EdgeSilhouette.REGULAR?C.RegularEdgeBufferWriter.glLayout:C.SilhouetteEdgeBufferWriter.glLayout},{vertices:this._verticesBufferObject,instances:k.BufferObject.createVertex(this.rctx,H.Usage.STATIC_DRAW,t===I.EdgeSilhouette.REGULAR?e.regular.instancesData.buffer:e.silhouette.instancesData.buffer)}),t===I.EdgeSilhouette.REGULAR?e.regular.lodInfo:e.silhouette.lodInfo):null,i=e.regular.lodInfo.lengths.length>0?a(I.EdgeSilhouette.REGULAR):null,o=e.silhouette.lodInfo.lengths.length>0?a(I.EdgeSilhouette.SILHOUETTE):null,c=(i?.vao.usedMemory??0)+(o?.vao.usedMemory??0);return new K(i,o,{gpuMemoryUsage:c,externalMemoryUsage:n,averageEdgeLength:e.averageEdgeLength},r,V.determineEdgeTransparency(t.meta),V.determineObjectTransparency(t.meta),t,s)}async _addGeometry(e,t,r,s,n,a){if(r.edgeIndicesLength<=0)return;const i=r.attributes.get(v.VertexAttribute.POSITION),o=g.create(),c=this._computeModelTransformWithLocalOrigin(e,r,o),d=new $(i,o,c);return this._addPositionData(t,d,r.edgeIndicesLength,s,n,a)}async _addPositionData(e,t,r,s,n,a=!1){if(null==e.loaded)return;const i=this._createComponentBuffers([s]);if(null==i)return;const o=this._acquireRenderer(s.type,!!n.hasSlicePlane,!0),{modelTransform:c,origin:d}=t,l=t.position.indices,u=t.position,g=u.data.length/u.size,h=M.EdgeInputBufferLayout.createBuffer(g);for(let m=0;m<g;m++)h.position.set(m,0,u.data[m*u.size]),h.position.set(m,1,u.data[m*u.size+1]),h.position.set(m,2,u.data[m*u.size+2]);V.fillComponenBufferIndices(i.meta,[0,h.componentIndex.count],h.componentIndex);const p=await this._updatingHandles.addPromise(this._extractEdges(o.writerSettings,h,!1,a,l,r));if(null==e.loaded)return;const f=this._createRenderable(p,i,new z(c,d),o.key,!1);e.renderables.push(f),o.addRenderable(f),this._gpuMemoryUsage+=f.statistics.gpuMemoryUsage}async _addComponentGeometry(e,t,r,s,n,a,i){if(null==t.loaded)return 0;const o=this._createComponentBuffers(a);if(null==o)return 0;const c=V.determineRendererType(a),d=this._acquireRenderer(c,i.hasSlicePlane||!1,!1),l=M.EdgeInputBufferLayout.createBuffer(r.length/3);b.copy(l.position.typedBuffer,r,l.position.typedBufferStride,3),V.fillComponenBufferIndices(o.meta,n,l.componentIndex,s);const u=!0,g=d.writerSettings,h=await this._updatingHandles.addPromise(this._extractEdges(g,l,u,!1,s));if(null==t.loaded)return 0;const p=this._createRenderable(h,o,e,d.key,!0);return t.renderables.push(p),d.addRenderable(p),p.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(e,t,r,s,n){const a=new Map;let i=0,o=null,c=0;const d=e.geometries.filter((e=>{if(e.edgeIndicesLength<=0||!e.material.supportsEdges)return!1;!o&&e.localOrigin&&(o=e);const t=e.attributes.get(v.VertexAttribute.POSITION);return c+=t.data.length/t.size,i+=e.edgeIndicesLength,!0}));if(0===d.length)return;const l=c>=65536?Uint32Array:Uint16Array,u=i?new l(i):null,h=[];let p=0;d.forEach((e=>{const t=e.attributes.get(v.VertexAttribute.POSITION),r=t.indices;let s=a.get(t.data);if(null==s){s=h.length/3;for(let e=0;e<t.data.length;e+=t.size)h.push(t.data[e]),h.push(t.data[e+1]),h.push(t.data[e+2]);a.set(t.data,s)}for(let n=0;n<e.edgeIndicesLength;n++)u[p++]=s+r[n]}));const f=o||e.geometries[0],m=g.create(),b=this._computeModelTransformWithLocalOrigin(e,f,m);for(let g=0;g<e.geometries.length;g++)e.geometries[g].localOrigin=b.origin;const y=new $(new E.Attribute(h,u,3),m,b);await this._updatingHandles.addPromise(this._addPositionData(t,y,u.length,r[0],s,n))}_acquireRenderer(e,t,r){const s=D.EdgeRenderer.getKey(e,t,r);let n=this._renderers.get(s);return null==this._strokesTexture&&(this._strokesTexture=B.generateStrokesTexture(this.rctx)),n||(n=new D.EdgeRenderer(this.rctx,this.techniqueRepository,{type:e,hasSlicePlane:t,strokesTexture:this._strokesTexture,legacy:r,spherical:this.viewingMode===y.ViewingMode.Global}),this._renderers.set(s,n)),++n.refCount,n}_removeRenderable(e){G(e.regular),G(e.silhouette);const t=this._renderers.get(e.rendererKey);if(t){t.removeRenderable(e),--t.refCount,"origin"in e.transform&&this._localOrigins.release(e.transform.origin),this._gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}_updateObjectCameraDistances(e){const t=e.camera.eye,r=e.camera.viewForward,s=p.create(),n=e=>{h.sub(s,e.center,t);const n=h.dot(s,r),a=e.radius,i=n<-a?1/0:n<a?0:n-a;e.renderables.forEach((e=>e.distanceToCamera=i))};this._perObjectData.forEach(n),this._perObjectDataEvictionCache.forEach(n)}_renderRegularEdges(e,t,r){const s=e.bindRegularEdges(r,t),n=r.transparency,a=t.camera.perScreenPixelRatio;e.forEachRenderable((n=>{if(!J(n)||!n.visible)return;const i=Z(n.regular.lod.lengths,n.distanceToCamera,a);e.renderRegularEdges(s,n,r,t,i)}),n)}_renderSilhouetteEdges(e,t,r){const s=e.bindSilhouetteEdges(r,t),n=r.transparency,a=t.camera.perScreenPixelRatio;e.forEachRenderable((n=>{if(!Y(n)||!n.visible)return;const i=Z(n.silhouette.lod.lengths,n.distanceToCamera,a);e.renderSilhouetteEdges(s,n,r,t,i)}),n)}get test(){return{hasRenderedPrimitives:e=>{let t=!1;const r=e.perScreenPixelRatio,s=(e,s)=>e.forEachRenderable((e=>{e.visible&&!t&&(J(e)&&(t=Z(e.regular.lod.lengths,e.distanceToCamera,r)>0),!t&&Y(e)&&(t=Z(e.silhouette.lod.lengths,e.distanceToCamera,r)>0))}),s);return this._renderers.forEach((e=>{t||(s(e,A.Transparency.OPAQUE),s(e,A.Transparency.TRANSPARENT))})),t},getObjectData:e=>this._perObjectData.get(e)}}},t.__decorate([o.property({constructOnly:!0})],e.EdgeView.prototype,"rctx",void 0),t.__decorate([o.property({constructOnly:!0})],e.EdgeView.prototype,"renderSR",void 0),t.__decorate([o.property({constructOnly:!0})],e.EdgeView.prototype,"viewingMode",void 0),t.__decorate([o.property({constructOnly:!0})],e.EdgeView.prototype,"techniqueRepository",void 0),t.__decorate([o.property({constructOnly:!0})],e.EdgeView.prototype,"setNeedsRender",void 0),t.__decorate([o.property({constructOnly:!0})],e.EdgeView.prototype,"schedule",void 0),t.__decorate([o.property({readOnly:!0})],e.EdgeView.prototype,"_updatingHandles",void 0),t.__decorate([o.property({readOnly:!0})],e.EdgeView.prototype,"updating",null),e.EdgeView=t.__decorate([d.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],e.EdgeView);class W{constructor(e,t,r){this.radius=r,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0)})),this.center=p.clone(t)}}class q{constructor(e,t){this.buffer=e,this.meta=t}}class F{constructor(e,t){this.vao=e,this.lod=t}}class z{constructor(e,t){this.modelMatrix=e,this.origin=t}}class K{constructor(e,t,r,s,n,a,i,o){this.regular=e,this.silhouette=t,this.statistics=r,this.transform=s,this.edgeTransparency=n,this.objectTransparency=a,this.components=i,this.rendererKey=o,this.distanceToCamera=0,this.visible=!0}}class Q extends K{}function J(e){return null!=e.regular}class X extends K{}function Y(e){return null!=e.silhouette}function Z(e,t,r){const n=t*r,a=s.binaryIndexOf(e,n,!0);return-1===a?n<e[0]?e.length:0:e.length-a}class ${constructor(e,t,r){this.position=e,this.modelTransform=t,this.origin=r}}const ee=u.create(),te=()=>Promise.reject();e.LegacyTransform=z,e.RegularRenderable=Q,e.Renderable=K,e.SilhouetteRenderable=X,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
