/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../geometry","../../../../core/screenUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection","../../../../geometry/support/plane","../../../../geometry/support/ray","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../../../support/elevationInfoUtils","../../support/geometryUtils/ray","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/verticalOffsetUtils","../../../interactive/dragEventPipeline","../../../../geometry/Point"],(function(e,r,n,t,o,c,a,l,s,i,u,p,d,f,y,m,g){"use strict";function S(e,r){return E(e,(()=>r))}function T(e){return E(e,(e=>e.plane))}function E(e,r){const t=o.create(),c=o.create();let l=!1;return o=>{const s=r(o);if("start"===o.action){const r=n.screenPointObjectToArray(o.screenStart,n.castScreenPointArray(i.sv2d.get())),c=p.fromScreen(e.state.camera,r,j);null!=c&&(l=a.intersectRay(s,c,t))}if(!l)return null;const u=n.screenPointObjectToArray(o.screenEnd,n.castScreenPointArray(i.sv2d.get())),d=p.fromScreen(e.state.camera,u,j);return null==d?null:a.intersectRay(s,d,c)?{...o,renderStart:t,renderEnd:c,plane:s,ray:d}:null}}function v(e,r,t=0,o=null,a=null){let l=null;return s=>{if("start"===s.action&&(l=e.sceneIntersectionHelper.intersectElevationFromScreen(n.createScreenPointArray(s.screenStart.x,s.screenStart.y),r,t,a),null!=l&&null!=o&&!c.projectPoint(l,l,o)))return null;if(null==l)return null;const i=e.sceneIntersectionHelper.intersectElevationFromScreen(n.createScreenPointArray(s.screenEnd.x,s.screenEnd.y),r,t,a);return null!=i&&(null==o||c.projectPoint(i,i,o))?{...s,mapStart:l,mapEnd:i}:null}}function P(e,r,n,t=null,o=null){return v(e,n,u.getZForElevationMode(r,e,n),t,o)}function R(e,r,n,t=null,o=null){return P(e,n,u.getGraphicEffectiveElevationInfo(r),t,o)}function b(e,r,n,t){const o=r.toMap(e.screenStart,{include:[n]});return null!=o?R(r,n,o,t):null}function I(e,r){const n=U,o=H,c=a.create();e.renderCoordsHelper.worldUpAtPosition(r,n);const l=t.cross(a.getNormal(c),n,t.subtract(o,r,e.state.camera.eye));return t.cross(l,l,n),a.fromPositionAndNormal(r,l,c)}function w(e,r,n){let t=null;const o=new m.EventPipeline;return o.next(S(e,I(e,r))).next(x(e,r)).next(A(e,n)).next((e=>{e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,t=e})),e=>(t=null,o.execute(e),t)}function x(e,r){const n=o.create(),c=t.length(r);e.renderCoordsHelper.worldUpAtPosition(r,n);const a=o.create(),l=o.create(),i=o=>{if(t.subtract(o,o,r),s.projectPoint(n,o,o),"global"===e.viewingMode){t.length(o)*Math.sign(t.dot(n,o))<.001-c&&t.subtract(o,t.scale(o,n,.001),r)}return t.add(o,o,r),o};return e=>(e.renderStart=i(t.copy(a,e.renderStart)),e.renderEnd=i(t.copy(l,e.renderEnd)),e)}function A(e,r){const n=e.renderCoordsHelper;return e=>{const t=n.fromRenderCoords(e.renderStart,new g({spatialReference:r})),o=n.fromRenderCoords(e.renderEnd,new g({spatialReference:r}));return null!=t&&null!=o?{...e,mapStart:t,mapEnd:o}:null}}var M;function O(e){let r=null;return n=>{switch(n.action){case"start":r=e.disableDisplay();break;case"end":case"cancel":null!=r&&(r.remove(),r=null)}return n}}function h(r,t=null){const c=d.newIntersector(r.state.viewingMode);c.options.selectionMode=!0,c.options.store=f.StoreResults.MIN,c.options.hud=!1;const a=n.createScreenPointArray(),l={requiresGroundFeedback:!0,enableDraped:!0,exclude:new Set},s=o.create(),i=t??r.spatialReference,u=t=>{r.map.ground&&r.map.ground.opacity<1?l.exclude.add(y.terrainId):l.exclude.delete(y.terrainId),r.sceneIntersectionHelper.intersectIntersectorScreen(n.screenPointObjectToArray(t,a),c,l);const o=c.results.min;let u;if(o.getIntersectionPoint(s))u=o.intersector===f.IntersectorType.TERRAIN?e.SurfaceType.GROUND:e.SurfaceType.OTHER;else{if(!c.results.ground.getIntersectionPoint(s))return null;u=e.SurfaceType.GROUND}return{location:r.renderCoordsHelper.fromRenderCoords(s,new g({spatialReference:i})),surfaceType:u}};let p;return e=>{if("start"===e.action){const r=u(e.screenStart);p=null!=r?r.location:null}if(null==p)return null;const r=u(e.screenEnd);return null!=r?.location?{...e,mapStart:p,mapEnd:r.location,surfaceType:r.surfaceType}:null}}e.SurfaceType=void 0,(M=e.SurfaceType||(e.SurfaceType={}))[M.GROUND=0]="GROUND",M[M.OTHER=1]="OTHER";const U=o.create(),H=o.create(),j=l.create();e.convertToMapCoordinates=A,e.hideManipulatorWhileDragging=O,e.projectToWorldUp=x,e.screenToMap3D=h,e.screenToMapXYAtLocation=P,e.screenToMapXYForGraphic=b,e.screenToMapXYForGraphicAtLocation=R,e.screenToRenderPlane=S,e.screenToRenderPlaneFromEvent=T,e.screenToZConstrained=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
