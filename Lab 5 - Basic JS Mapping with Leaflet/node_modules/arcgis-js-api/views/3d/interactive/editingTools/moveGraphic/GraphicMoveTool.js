/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Collection","../../../../../core/Evented","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/quantityUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/support/UpdatingHandles","../../../../../layers/graphics/dehydratedPoint","../../../../../support/elevationInfoUtils","../../manipulatorUtils","../../SnappingVisualizer3D","../geometryUtils","../isSupportedGraphicUtils","../manipulatorUtils","../meshFastUpdateUtils","../visualElementUtils","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","../manipulations/MoveXYGraphicManipulation","./isSupportedGraphic","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/sketch/SketchOptions","../../../../interactive/snapping/SnappingContext","../../../../interactive/snapping/SnappingDragPipelineStep","../../../../interactive/tooltip/Tooltip","../../../../interactive/tooltip/TranslateTooltipInfos","../../../../support/automaticLengthMeasurementUtils","../../../../support/euclideanLengthMeasurementUtils"],(function(t,e,i,a,o,n,s,p,l,r,h,c,u,d,v,g,M,f,m,_,y,T,G,w,E,S,b,I,x,D,O,H,X,k,U,P,Y,z,A,R){"use strict";class Z{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class C{constructor(t,e,i){this.dx=t,this.dy=e,this.allGraphics=i,this.type="graphic-move"}}class V{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}const F="manipulators";t.GraphicMoveTool=class extends(a.EventedMixin(H.InteractiveToolBase)){constructor(t){super(t),this._infos=new Map,this.graphics=new i,this.enableZ=!0,this.sketchOptions=new k,this.type="move-3d",this.tooltip=null,this._updatingHandles=new d.UpdatingHandles,this._moveManipulation=null,this._latestTooltipInfo=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{view:t}=this;this.addHandles([this.graphics.on("change",(t=>{t.removed.forEach((t=>this.removeHandles(t))),this._updateGraphicInfos(t),this._setupFastTransformUpdates(t.added),this._refreshManipulators()})),p.watch((()=>this.sketchOptions.tooltips.effectiveEnabled),(e=>{this.tooltip=e?new Y.Tooltip({info:this._latestTooltipInfo,view:t}):n.destroyMaybe(this.tooltip)}),p.syncAndInitial)]);const e=this.graphics.toArray();this._updateGraphicInfos({added:e,removed:[]}),this._setupFastTransformUpdates(e),this._refreshManipulators(),this.finishToolCreation()}destroy(){this.tooltip=n.destroyMaybe(this.tooltip),this._moveManipulation=n.destroyMaybe(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}reset(){}_updateGraphicInfos({added:t,removed:e}){for(const i of t){if(I.isSupportedGraphic(i)!==_.SupportedGraphicResult.SUPPORTED)continue;const t=new B(i),e=this.view.trackGraphicState(t.state);this._infos.set(t.graphic,{info:t,handle:e})}for(const i of e)this._infos.get(i)?.handle.remove(),this._infos.delete(i)}_setupFastTransformUpdates(t){const{view:e}=this;for(const i of t){const{info:t}=this._infos.get(i);this.addHandles(T.meshTransformFastUpdateHandles(t.state,e),i)}}_refreshManipulators(){if(this.removeHandles(F),this._moveManipulation=n.destroyMaybe(this._moveManipulation),this.manipulators.removeAll(),0===this._infos.size)return;const t=Array.from(this._infos.values(),(({info:t})=>t));this._createManipulators(t),this._createVisualElements(t),this._updateMoveManipulation(t)}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new b.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator((t=>this.addHandles([t.events.on("immediate-click",(t=>{this.emit("immediate-click",{...t,graphic:i.graphic}),t.stopPropagation()})),t.events.on("grab-changed",(({action:t})=>{"start"===t?this._showTooltip(E.ManipulationType.XY):this._hideTooltip()}))],F))),this.addHandles(e.manipulationXY.createDragPipeline(((e,i,a,o)=>this._buildDragEventPipeline(t,E.ManipulationType.XY,e,i,a,o))),F)}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new E.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?E.MoveManipulation.radiusForSymbol(t[0].graphic.symbol):w.discRadius});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator((t=>{this.addHandles(t.events.on("immediate-click",(i=>{e.zManipulation.hasManipulator(t)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.at(0)}),i.stopPropagation()})),F)}));const i=t=>e=>{this.addHandles([e.events.on("focus-changed",(({action:e})=>{"focus"===e?this._showTooltip(t):this._hideTooltip()})),e.events.on("grab-changed",(()=>{this._latestTooltipInfo&&(this._latestTooltipInfo.distance=s.zeroMeters)}))],F)};this._moveManipulation.xyManipulation.forEachManipulator(i(E.ManipulationType.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(E.ManipulationType.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(E.ManipulationType.Z));const a=()=>this._updateMoveManipulation(t);for(const n of t)this.addHandles([n.state.on("changed",a),p.watch((()=>n.state.displaying),a)],F);const o=t[t.length-1];this.addHandles(o.state.on("changed",(()=>this._updateMoveManipulationAngle(o))),F),this.addHandles(e.createDragPipeline(((e,i,a,o,n)=>this._buildDragEventPipeline(t,e,i,a,o,n)),g.getGraphicEffectiveElevationInfo(o.graphic),o.graphic.geometry.spatialReference,o.graphic),F),this._updateMoveManipulationAngle(o)}_createVisualElements(t){for(const e of t){const i=e.graphic,a=G.createVisualElements({view:this.view,graphic:i,forEachManipulator:t=>{e.manipulationXY?.forEachManipulator(t),this._moveManipulation?.forEachManipulator(t)},onManipulatorsChanged:()=>o.makeHandle()});null!=a&&(e.geometryRepresentation=a.visualElement,e.geometryRepresentation instanceof x.OutlineVisualElement&&this.addHandles([e.geometryRepresentation.events.on("attachment-origin-changed",(()=>{e.state.isDraped||this._updateMoveManipulation(t)})),p.watch((()=>e.state.isDraped),(()=>this._updateMoveManipulation(t)))],F),this.addHandles(a,F))}}_updateMoveManipulationAngle(t){this._moveManipulation&&(this._moveManipulation.angle=m.orientation(t.graphic.geometry))}_updateMoveManipulation(t){const e=v.makeDehydratedPoint(0,0,0,this.view.spatialReference);let i=0,a=!1;const o=this._moveManipulation;if(o){for(const o of t){if(!o.state.displaying)continue;const t=o.state.graphic;this.enableZ&&y.canMoveZ(t)&&(a=!0);const n=o.geometryRepresentation instanceof x.OutlineVisualElement&&!o.state.isDraped?o.geometryRepresentation.attachmentOrigin:M.getGraphicAttachmentOrigin(this.view,t);if(null!=n){const{x:t,y:a,z:o}=n;e.x+=t,e.y+=a,o&&(e.z??=0,e.z+=o),i++}}i>0?(e.x/=i,e.y/=i,e.z??=0,e.z/=i,o.location=e,o.xyManipulation.available=!0,o.xyAxisManipulation.available=!0,o.zManipulation.available=a):o.available=!1}}_buildDragEventPipeline(t,e,i,a,o,n){const s=[],p=[];let l=null,r=null;const h=()=>{for(const t of s)t.dragging=!1;s.length=0,p.length=0,l=null,r=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===t.length&&e===E.ManipulationType.XY){const e=t[0].graphic;({steps:a,cancel:o}=this._buildSnappingPipelineSteps(e,g.getGraphicEffectiveElevationInfo(e),a,o,n))}return o=o.next((t=>r?.(t))).next((()=>(this.emit("graphic-move-stop",new V(p)),this.destroyed||h(),null))),{steps:a=a.next((e=>{if("start"===e.action){s.length=0,p.length=0;for(const e of t)e.dragging||!e.manipulationXY?.hasManipulator(i)&&e.manipulationXY?.grabbing||(s.push(e),p.push(e.graphic),e.dragging=!0);if(0!==p.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),l=O.dragGraphicMany(p),r=O.resetGraphicMany(p),this.emit("graphic-move-start",new Z(p)),this.destroyed))return null}return 0!==p.length?e:null})).next((t=>l?.(t))).next((t=>(this._updateMoveTooltip(e,t),t))).next((t=>{switch(t.action){case"start":case"update":if(t.translationX||t.translationY||t.translationZ){const e=this.view.toScreen(t.mapStart),i=this.view.toScreen(t.mapEnd),a=i.x-e.x,o=i.y-e.y;if(this.emit("graphic-move",new C(a,o,p)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new V(p)),this.destroyed)return null;h()}return null})),cancel:o}}_showTooltip(t){this._updateMoveTooltip(t),this._latestTooltipInfo&&(this._latestTooltipInfo.distance=s.zeroMeters)}_hideTooltip(){this.tooltip?.clear(),this._latestTooltipInfo=null}_updateMoveTooltip(t,e){const{sketchOptions:i,tooltip:a}=this;switch(t){case E.ManipulationType.XY:this._latestTooltipInfo=this._translateGraphicTooltipInfo??=new z.TranslateGraphicTooltipInfo({sketchOptions:i}),this._updateMoveTooltipDistance(this._latestTooltipInfo,e,((t,e)=>A.autoDistanceBetweenPoints2D(t,e)));break;case E.ManipulationType.XY_AXIS:this._latestTooltipInfo=this._translateGraphicXYTooltipInfo??=new z.TranslateGraphicXYTooltipInfo({sketchOptions:i}),this._updateMoveTooltipDistance(this._latestTooltipInfo,e,((t,i)=>s.scale(A.autoDistanceBetweenPoints2D(t,i),S.axisConstrainedDragSign(e))));break;case E.ManipulationType.Z:this._latestTooltipInfo=this._translateGraphicZTooltipInfo??=new z.TranslateGraphicZTooltipInfo({sketchOptions:i}),this._updateMoveTooltipDistance(this._latestTooltipInfo,e,R.verticalSignedDistanceBetweenPoints)}this._latestTooltipInfo.sketchOptions=i,a&&(a.info=this._latestTooltipInfo)}_updateMoveTooltipDistance(t,e,i){if(null==e||"end"===e.action)return;const{mapStart:a,mapEnd:o}=e,n=i(a,o);t.distance=null!=n?n:s.zeroMeters}_buildSnappingPipelineSteps(t,e,i,a,o){const n=t.geometry;if(null==n||"point"!==n.type&&"mesh"!==n.type)return{steps:i,cancel:a};const s=("point"===n.type?n:n.anchor).clone(),p=new U.SnappingContext({elevationInfo:e,pointer:o,editGeometryOperations:X.EditGeometryOperations.fromGeometry(s,this.view.state.viewingMode),visualizer:new f.SnappingVisualizer3D,excludeFeature:t}),l=this.snappingManager,{snappingStep:r,cancelSnapping:h}=P.createSnapDragEventPipelineStep({snappingContext:p,snappingManager:l,updatingHandles:this._updatingHandles});return a=a.next(h),{steps:i=i.next((e=>{s.z=g.getConvertedElevation(this.view,s,g.getGraphicEffectiveElevationInfo(t),{mode:"absolute-height",offset:0});return{...e,snapOrigin:p.coordinateHelper.pointToVector(s)}})).next(...r),cancel:a}}},e.__decorate([l.property({constructOnly:!0,nonNullable:!0})],t.GraphicMoveTool.prototype,"view",void 0),e.__decorate([l.property()],t.GraphicMoveTool.prototype,"graphics",void 0),e.__decorate([l.property({constructOnly:!0,nonNullable:!0})],t.GraphicMoveTool.prototype,"enableZ",void 0),e.__decorate([l.property({constructOnly:!0,type:k})],t.GraphicMoveTool.prototype,"sketchOptions",void 0),e.__decorate([l.property({constructOnly:!0})],t.GraphicMoveTool.prototype,"snappingManager",void 0),e.__decorate([l.property()],t.GraphicMoveTool.prototype,"type",void 0),e.__decorate([l.property()],t.GraphicMoveTool.prototype,"updating",null),e.__decorate([l.property()],t.GraphicMoveTool.prototype,"tooltip",void 0),t.GraphicMoveTool=e.__decorate([u.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],t.GraphicMoveTool);class B{constructor(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new D.GraphicState({graphic:t})}get graphic(){return this.state.graphic}}t.GraphicMoveEvent=C,t.GraphicMoveStartEvent=Z,t.GraphicMoveStopEvent=V,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
