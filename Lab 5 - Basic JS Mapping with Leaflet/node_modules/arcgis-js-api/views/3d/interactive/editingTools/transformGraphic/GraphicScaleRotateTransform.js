/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/colorUtils","../../../../../core/Cyclical","../../../../../core/Evented","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/quantityUtils","../../../../../core/reactiveUtils","../../../../../core/scheduling","../../../../../core/screenUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/plane","../../../../../geometry/support/ray","../../../../../geometry/support/vectorStacks","../../../../../support/elevationInfoUtils","../../Manipulator3D","../../manipulatorUtils","../../RenderObject","../dragEventPipeline3D","../ManipulatorType","../manipulations/config","../../../webgl-engine/lib/basicInterfaces","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Material","../../../webgl-engine/materials/ColorMaterial","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces","../../../../interactive/tooltip/Tooltip","../../../../interactive/tooltip/TransformTooltipInfos"],(function(t,e,a,i,o,r,n,s,c,l,d,h,u,p,g,m,f,_,S,T,v,M,y,D,R,b,I,w,O,k,A,P,F,C,E,U,L,x,G){"use strict";var j,z;function N(t,e){const a=T.subtract(D.sv3d.get(),e.renderStart,t.origin),i=T.subtract(D.sv3d.get(),e.renderEnd,t.origin),o=T.length(a),r=T.length(i);return 0===o?0:r/o}function H(t,e,a,i){const{renderStart:o,renderEnd:r}=t,n=B(o,i,D.sv3d.get()),s=B(r,i,D.sv3d.get());if(T.squaredDistance(n,s)<A.dragThresholdPx*A.dragThresholdPx)return null;const c=T.subtract(D.sv3d.get(),o,a),l=T.cross(D.sv3d.get(),c,M.getNormal(e)),d=o,h=T.add(D.sv3d.get(),d,l),u=B(a,i,D.sv3d.get()),p=n,g=B(h,i,D.sv3d.get()),m=T.subtract(D.sv3d.get(),g,p),f=T.subtract(D.sv3d.get(),n,u),_=y.wrap(p,m),S=y.wrap(u,f);return y.distance2(_,s)<y.distance2(S,s)?"rotate":"scale"}function B(t,e,a){return e.projectToScreen(t,K),T.set(a,K[0],K[1],0)}function V(t,e){let a=null,i=1;const o=()=>i;return{start:()=>{i=t.getScale(),a=t.getScale,t.getScale=o,e()},update:t=>(i+=((i+1)/2-i)*Math.min(t*A.ringResetAnimationSpeedFactor,1),e(),Math.abs(i-1)<.01?z.STOP:z.CONTINUE),destroy:()=>{a&&(t.getScale=a),e()}}}function q(t,e,a){let i=0,o=null;const r=()=>!1;return{start:()=>{o=t.getFocused,t.getFocused=r,i=0,e()},update:t=>(i+=t,!o?.()||i>=a.delayMs?z.STOP:z.CONTINUE),destroy:()=>{o&&(t.getFocused=o),e()}}}function J(t){switch(t){case"integer":case"long":return 0;default:return null}}!function(t){t.ScaleIn=L.ManipulatorStateCustomFlags.Custom2,t.ScaleOut=L.ManipulatorStateCustomFlags.Custom3,t.RotateLeft=L.ManipulatorStateCustomFlags.Custom4,t.RotateRight=L.ManipulatorStateCustomFlags.Custom5,t.Unlocked=L.ManipulatorStateCustomFlags.Custom7,t.DelayedFocused=L.ManipulatorStateCustomFlags.Custom8,t.TouchInput=L.ManipulatorStateCustomFlags.Custom12}(j||(j={})),t.GraphicScaleRotateTransform=class extends a{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}get updating(){return!!this._activeAnimation}constructor(t){super(t),this.mode=null,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=A.ringIndicatorDelayMs,this._absoluteTooltipInfo=null,this._scaleTooltipInfo=null,this._rotateTooltipInfo=null,this.events=new r,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>"scale"===this._scaleRotateDragData?.mode?this.adapter.scale:1}initialize(){this._tooltip=new x.Tooltip({view:this.tool.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this.addHandles([l.when((()=>!this.sketchOptions.tooltips.effectiveEnabled),(()=>this._tooltip.clear()),l.initial),l.watch((()=>{const{adapter:t}=this,{info:e}=this._tooltip;return e===this._absoluteTooltipInfo&&this.getFocused()?[e,t.size,t.orientationClockwise]:[null]}),(([t])=>{t&&this._updateFocusTooltip()}))])}destroy(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=null,this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=s.destroyMaybe(this._tooltip)}startAnimation(t){this.cancelActiveAnimation(),t.start();const e=d.addFrameTask({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=s.destroyMaybe(this._activeAnimation)}forEachManipulator(t){t(this._ringManipulator,k.ManipulatorType.SCALE_ROTATE)}_createManipulator(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const e=this.tool.graphicState.graphic,a=U.createManipulatorDragEventPipeline(t,((t,a,i)=>{this._scaleRotateDragData=null;const r=this.adapter.startInteraction(),s={mode:"none",origin:v.clone(t.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=s,this._updateDragState();const c=D.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(t.renderLocation,c),a.next(O.screenToRenderPlane(this.tool.view,M.fromPositionAndNormal(t.renderLocation,c,M.create()))).next((t=>{const a=M.getNormal(t.plane),i=I.calculateInputRotationTransform(t.renderStart,t.renderEnd,s.origin,a),c=o.cyclicalPI.shortestSignedDiff(s.angle,i);s.angleDir=n.clamp(s.angleDir+c,-A.rotateIndicatorDirectionBuffer,A.rotateIndicatorDirectionBuffer),s.angle=i;const l=N(s,t),d=l-this.adapter.scale;if(s.scaleDir=n.clamp(s.scaleDir+d,-A.scaleIndicatorDirectionBuffer,A.scaleIndicatorDirectionBuffer),this._onScaleChanged(),"none"===s.mode){const a=this.mode||H(t,t.plane,s.origin,this.tool.view.state.camera);if(null!=a){switch(a){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:e,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:e,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}s.mode=a}}switch(s.mode){case"rotate":r.state.angle=s.initialAngle+i;break;case"scale":r.state.scale=l,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),t.action){case"start":case"update":switch(s.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:e,angle:n.rad2deg(s.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:e,xScale:l,yScale:l})}break;case"end":switch(s.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:n.rad2deg(s.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:l,yScale:l})}}return"end"===t.action&&(this.startAnimation(V(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState(),r.done()),t})).next(this._updateTooltipPipelineStep(s)),i.next((()=>{if(r.cancel(),null!=this._scaleRotateDragData){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:1,yScale:1})}this.startAnimation(V(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()}))}));this.addHandles([a,t.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(q(this,(()=>this._updateDelayedFocusedState()),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()})),t.events.on("immediate-click",(t=>{t.stopPropagation()})),l.watch((()=>this.tool.graphicState?.displaying),(t=>this._ringManipulator.available=t),l.initial)])}_updateTooltipPipelineStep(t){return e=>{const{sketchOptions:a}=this,{effectiveEnabled:i,visualVariables:o}=a.tooltips;if(!i)return e;if("end"===e.action)return this._updateFocusTooltip(),e;const r=this._tooltip;switch(t.mode){case"scale":{r.info=this._scaleTooltipInfo??=new G.TransformScaleTooltipInfo({sketchOptions:a});const{size:t,scale:e}=this.adapter,i=o?.size,n=r.info;n.sketchOptions=a,n.scale={value:e},n.size=null!=t?c.createLength(t,"meters"):void 0,n.sizePrecision=J(i?.valueType),n.sizeUnit=i?.unit;break}case"rotate":{r.info=this._rotateTooltipInfo??=new G.TransformRotateTooltipInfo({sketchOptions:a});const{orientationClockwise:t,relativeAngleClockwise:e}=this.adapter,i=o?.rotation,n=J(i?.valueType),s=r.info;s.sketchOptions=a,s.rotation=null!=e?c.createAngle(e,"radians","geographic"):void 0,s.rotationPrecision=n,s.rotationType=i?.rotationType??"geographic",s.orientation=null!=t?c.createAngle(t,"radians","geographic"):void 0,s.orientationPrecision=n;break}}return e}}_updateFocusTooltip(){const{sketchOptions:t,_tooltip:e}=this,{effectiveEnabled:a,visualVariables:i}=t.tooltips;if(!a)return;if(this.getFocused()){const a=i?.rotation,o=i?.size,r=this.mode,{size:n,orientationClockwise:s}=this.adapter,l=null!=s&&(null==r||"rotate"===r),d=null!=n&&(null==r||"scale"===r);e.info=this._absoluteTooltipInfo??=new G.TransformAbsoluteTooltipInfo({sketchOptions:t});const h=e.info;h.sketchOptions=t,h.orientation=l?c.createAngle(s,"radians","geographic"):void 0,h.orientationPrecision=J(a?.valueType),h.rotationType=a?.rotationType??"geographic",h.size=d?c.createLength(n,"meters"):void 0,h.sizeUnit=o?.unit,h.sizePrecision=J(o?.valueType)}else e.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(j.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(j.Unlocked,!(null!=this._scaleRotateDragData&&"none"!==this._scaleRotateDragData?.mode)),null!=this._scaleRotateDragData)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(j.ScaleIn|j.ScaleOut,!1),this._ringManipulator.updateStateEnabled(j.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(j.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(j.RotateLeft|j.RotateRight,!1),this._ringManipulator.updateStateEnabled(j.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(j.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(j.ScaleIn|j.ScaleOut|j.RotateLeft|j.RotateRight,!1)}_updateManipulatorTransform(){const t=_.fromRotation(D.sm4d.get(),this.adapter.angle,v.fromValues(0,0,1));if(null==t)return;const e=this.getScale(),a=_.fromScaling(D.sm4d.get(),T.set(D.sv3d.get(),e,e,e));this._ringManipulator.modelTransform=_.multiply(D.sm4d.get(),a,t)}_createRingManipulator(){const t=(t,e,a)=>{const i=[],o=Math.ceil(A.geometrySegments*(e-t)/(2*Math.PI));for(let r=0;r<o+1;r++){const n=t+r*(e-t)/o;i.push(v.fromValues(a*Math.cos(n),a*Math.sin(n),0))}return i},e=e=>t(0,2*Math.PI,e),a=t=>[[-t/2,0],[t/2,0],[t/2,A.ringHeight/2],[-t/2,A.ringHeight/2]],i=this._createMaterial(1),o=(t,e,o=i)=>F.createPathExtrusionGeometry(o,a(e),t,[],[],!1),r=e(A.ringRadius),n=o(r,A.ringThickness),s={left:new Array,right:new Array},c=[];for(let v=0;v<2;v++){const e=v*Math.PI-Math.PI/4,a=Math.PI/2-A.rotateIndicatorArcLength,r=e+a,n=e+Math.PI/2-a,l=t(r,n,A.innerIndicatorRadius),d=o(l,A.indicatorThickness);c.push(l),c.push(t(r,n,A.outerIndicatorRadius-A.ringThickness/2)),s.left.push(d),s.right.push(d.instantiate());for(let t=0;t<2;t++){const e=0===t,a=S.create();if(e){_.scale(a,a,[1,-1,1]),_.rotate(a,a,-r,[0,0,1]);const t=Math.round(A.rotateIndicatorArrowPlacementPercentage*(l.length-1));a[12]=l[t][0],a[13]=l[t][1],a[14]=l[t][2]}else{_.rotate(a,a,n,[0,0,1]);const t=Math.round((1-A.rotateIndicatorArrowPlacementPercentage)*(l.length-1));a[12]=l[t][0],a[13]=l[t][1],a[14]=l[t][2]}const o=F.createExtrudedTriangle(i,A.rotateIndicatorArrowTipLength,0,A.rotateIndicatorArrowTipRadius,A.ringHeight);F.transformInPlace(o,a),(e?s.left:s.right).push(o)}}const l=[];for(let _=0;_<2;_++){const e=_*Math.PI-Math.PI/4,a=Math.PI/2-A.scaleIndicatorArcLength,i=e+a,r=e+Math.PI/2-a,n=t(i,r,A.outerIndicatorRadius);l.push(o(n,A.indicatorThickness))}const d=this._createMaterial(.66),h=this._createMaterial(.5),u=this._createMaterial(.33),p=e(A.ringRadius+A.scaleIndicatorOffset1),g=e(A.ringRadius+A.scaleIndicatorOffset2),m=o(p,A.indicatorThickness,d),f=o(g,A.indicatorThickness,u),T=e(A.ringRadius-A.scaleIndicatorOffset1),M=e(A.ringRadius-A.scaleIndicatorOffset2),y=o(T,A.indicatorThickness,d),D=o(M,A.indicatorThickness,u);let I=[new w.RenderObject(n,j.DelayedFocused),new w.RenderObject(n.instantiate({material:h}),L.ManipulatorStateFlags.None)];this.mode&&"scale"!==this.mode||(I=I.concat([...l.map((t=>new w.RenderObject(t,j.DelayedFocused|j.Unlocked))),new w.RenderObject(m,j.DelayedFocused|j.ScaleIn),new w.RenderObject(f,j.DelayedFocused|j.ScaleIn),new w.RenderObject(y,j.DelayedFocused|j.ScaleOut),new w.RenderObject(D,j.DelayedFocused|j.ScaleOut)])),this.mode&&"rotate"!==this.mode||(I=I.concat([...s.right.map((t=>new w.RenderObject(t.instantiate(),j.DelayedFocused|j.Unlocked))),...s.left.map((t=>new w.RenderObject(t,j.DelayedFocused|j.RotateLeft))),...s.right.map((t=>new w.RenderObject(t,j.DelayedFocused|j.RotateRight)))]));const O=[r,...c];return new b.Manipulator3D({view:this.tool.view,renderObjects:I,autoScaleRenderObjects:!1,worldOriented:!0,radius:A.ringThickness,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:R.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:O,direction:v.fromValues(0,0,1)}})}_createMaterial(t){const e=new E.ColorMaterial({cullFace:P.CullFaceOptions.Back,renderOccluded:C.RenderOccludedFlag.Transparent,isDecoration:!0});return this.addHandles(l.watch((()=>({color:i.multiplyOpacityToUnitRGBA(this.tool.view.effectiveTheme.accentColor,t)})),(t=>e.setParameters(t)),l.initial)),e}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:t=>this._ringIndicatorDelayMs=t,tooltip:this._tooltip}}},e.__decorate([u.property({constructOnly:!0})],t.GraphicScaleRotateTransform.prototype,"tool",void 0),e.__decorate([u.property({constructOnly:!0})],t.GraphicScaleRotateTransform.prototype,"adapter",void 0),e.__decorate([u.property({constructOnly:!0})],t.GraphicScaleRotateTransform.prototype,"sketchOptions",void 0),e.__decorate([u.property()],t.GraphicScaleRotateTransform.prototype,"mode",void 0),e.__decorate([u.property()],t.GraphicScaleRotateTransform.prototype,"_activeAnimation",void 0),e.__decorate([u.property()],t.GraphicScaleRotateTransform.prototype,"updating",null),t.GraphicScaleRotateTransform=e.__decorate([f.subclass("esri.views.3d.interactive.editingTools.transformGraphic.GraphicScaleRotateTransform")],t.GraphicScaleRotateTransform),function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"}(z||(z={}));const K=h.createScreenPointArray();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
