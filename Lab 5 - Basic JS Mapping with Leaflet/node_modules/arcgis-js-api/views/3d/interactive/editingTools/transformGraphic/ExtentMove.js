/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/quantityUtils","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/vectorStacks","../../../analysis/Slice/ShiftManipulator","../../../analysis/Slice/sliceToolUtils","../dragEventPipeline3D","../ManipulatorType","../manipulations/MoveXYGraphicManipulation","../../../../interactive/dragEventPipeline","../../../../interactive/editGeometry/interfaces","../../../../interactive/editGeometry/support/editPlaneUtils","../../../../interactive/tooltip/TranslateTooltipInfos","../../../../support/automaticLengthMeasurementUtils","../../../../support/euclideanLengthMeasurementUtils"],(function(t,e,i,a,o,n,r,s,p,l,c,u,h,d,m,v,g){"use strict";class M{constructor(t,e,i,a){this._tool=t,this._graphicState=e,this._editGeometryOperations=i,this._bounds=a,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;const o=this._tool,n=o.view;this.moveXYGraphicManipulation=new c.MoveXYGraphicManipulation({view:n,tool:o,graphicState:this._graphicState}),o.addHandles(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=new r.ShiftManipulator(n,r.OffsetMode.CENTER_ON_CALLOUT),this.moveZManipulator.state|=s.IsShiftEdgeOnScreenFlag,o.manipulators.add(this.moveZManipulator),o.addHandles([this._createMoveZDragPipeline()]),o.addHandles([o.on("graphic-translate-stop",(()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null}))])}destroy(){this.moveXYGraphicManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(t){this.moveXYGraphicManipulation.forEachManipulator(t),t(this.moveZManipulator,l.ManipulatorType.TRANSLATE_Z)}updateManipulators(t,e){const o=this.moveZManipulator,r=i.rotateZ(n.sm4d.get(),t,Math.PI);r[12]=0,r[13]=0,r[14]=0,o.modelTransform=r,o.renderLocation=a.subtract(n.sv3d.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.moveXYGraphicManipulation.grabbing||this.moveXYGraphicManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){const t=this._tool,i=this._moveXYTooltipInfo??=new m.TranslateGraphicTooltipInfo({sketchOptions:t.sketchOptions});if(this.moveXYGraphicManipulation.dragging){const e=this._bounds,a=e.mapBoundsStart.origin,o=e.mapBounds.origin,{renderSpatialReference:n}=t.view;if(!n)return null;const r=v.autoDistance2D(a,o,n);if(null==r)return null;i.distance=r}else i.distance=e.zeroMeters;return i}_computeMoveZTooltipInfo(){const t=this._tool,i=this._moveZTooltipInfo??=new m.TranslateGraphicZTooltipInfo({sketchOptions:t.sketchOptions});if(this.moveZManipulator.dragging){const e=this._bounds,a=e.mapBoundsStart.origin,o=e.mapBounds.origin,{renderSpatialReference:n}=t.view;if(!n)return null;const r=g.verticalSignedDistance(a,o,n);if(null==r)return null;i.distance=r}else i.distance=e.zeroMeters;return i}_createMoveXYGraphicDragPipeline(){return this.moveXYGraphicManipulation.createDragPipeline(((t,e,i)=>this._applyGraphicMoveSteps(e,i)))}_createMoveZDragPipeline(){const t=this._editGeometryOperations.data.spatialReference;return u.createManipulatorDragEventPipeline(this.moveZManipulator,((e,i,a)=>{const n=o.clone(e.renderLocation),r=i.next(p.screenToZConstrained(this._tool.view,n,t)).next(u.addScreenDelta());this._applyGraphicMoveSteps(r,a)}))}_applyGraphicMoveSteps(t,e){const i=this._tool,a=i.graphic,o=t.next((t=>("start"===t.action&&(i.inputState={type:"move"},this._bounds.backupMapBounds(),i.emit("graphic-translate-start",{graphic:a,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY})),t))).next(u.addMapDelta()).next(this._moveDragUpdateGeometry()).next((t=>{const e={graphic:a,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY};switch(t.action){case"start":case"update":(t.mapEnd.x-t.mapStart.x||t.mapEnd.y-t.mapStart.y||(t.mapEnd.z??0)-(t.mapStart.z??0))&&i.emit("graphic-translate",e);break;case"end":i.inputState=null,i.emit("graphic-translate-stop",e)}return t}));return e.next((()=>{null!=i.inputState&&i.emit("graphic-translate-stop",{graphic:a,dxScreen:0,dyScreen:0}),i.cancel()})),o}_moveDragUpdateGeometry(){const t=this._tool;return e=>{if(null==t.inputState||"move"!==t.inputState.type)return e;const i=[];for(const t of this._editGeometryOperations.data.components)i.push(...t.vertices);const a="start"===e.action?h.AccumulationBehavior.NEW_STEP:h.AccumulationBehavior.ACCUMULATE_STEPS,o=this._editGeometryOperations.moveVertices(i,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,a);return d.apply(o,this._bounds.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,e}}}t.ExtentMove=M,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
