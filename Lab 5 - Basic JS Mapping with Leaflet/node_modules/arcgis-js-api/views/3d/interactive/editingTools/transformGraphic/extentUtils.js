/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/unitUtils","../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../chunks/boundedPlane","../../../../../geometry/support/vectorStacks","../../../../../support/elevationInfoUtils","../geometryUtils","../../../layers/graphics/elevationAlignmentUtils","../../../layers/graphics/ElevationContext","../../../../interactive/editGeometry/support/editPlaneUtils","../../../../support/extentUtils"],(function(t,e,s,i,a,o,n,r,c,d,l,u,p){"use strict";class g{constructor(t,e,s){this._tool=t,this._onDisplayBoundsChanged=e,this.mapBounds=o.create(),this.mapBoundsStart=o.create(),this.displayBounds=o.create(),this._calculateMapBounds(s)}get displayBoundsMargin(){const{view:t,graphic:e}=this._tool,s=t.pointsOfInterest?.centerOnSurfaceFrequent.location??e.geometry?.extent?.center;return s?b*t.pixelSizeAt(s):0}backupMapBounds(){o.copy(this.mapBounds,this.mapBoundsStart)}updateDisplayBounds(){this._calculateDisplayBounds(),this._onDisplayBoundsChanged()}_calculateMapBounds(t){const{view:i,attachmentOrigin:a}=this._tool,o=t.geometry,n=c.mainAxis(o);s.scale(n,n,-1);const r=i.spatialReference,d=o.spatialReference,l=a?i.pixelSizeAt(a)*e.getMetersPerCartesianUnitForSR(r)/e.getMetersPerUnitForSR(d):0,p=h*l;u.calculateOrientedBounds(n,t,p,this.mapBounds)}_calculateDisplayBounds(){const{view:t,attachmentOrigin:e,graphic:s}=this._tool;if(!s.geometry)return;const i=e?.z??d.evaluateElevationAlignmentAtPoint(this.mapBounds.origin,t.elevationProvider,l.ElevationContext.fromElevationInfo(r.getGraphicEffectiveElevationInfo(s)),t.renderCoordsHelper),a=o.copy(this.mapBounds);a.origin[2]=i??0,m(a,t.renderCoordsHelper,s.geometry.spatialReference,this.displayBoundsMargin,this.displayBounds)}}const b=10,h=80;function m(t,e,s,a=0,r){r||(r=o.create()),e.toRenderCoords(t.origin,s,r.origin);const c=n.sv3d.get();i.add(c,t.origin,t.basis1),i.add(c,c,t.basis2),e.toRenderCoords(c,s,c);const d=n.sv3d.get();i.add(d,t.origin,t.basis1),i.subtract(d,d,t.basis2),e.toRenderCoords(d,s,d);const l=n.sv3d.get();i.subtract(l,t.origin,t.basis1),i.subtract(l,l,t.basis2),e.toRenderCoords(l,s,l);const u=n.sv3d.get();i.subtract(u,t.origin,t.basis1),i.add(u,u,t.basis2),e.toRenderCoords(u,s,u);const p=i.lerp(n.sv3d.get(),c,d,.5);i.subtract(p,p,r.origin);const g=i.lerp(n.sv3d.get(),l,u,.5);i.subtract(g,r.origin,g),i.lerp(r.basis1,p,g,.5);const b=i.lerp(n.sv3d.get(),u,c,.5);i.subtract(b,b,r.origin);const h=i.lerp(n.sv3d.get(),d,l,.5);i.subtract(h,r.origin,h),i.lerp(r.basis2,b,h,.5);const m=i.cross(n.sv3d.get(),r.basis1,r.basis2),v=i.cross(m,m,r.basis1);return i.normalize(v,v),i.scale(r.basis2,v,i.dot(r.basis2,v)),i.scale(r.basis1,r.basis1,1+a/i.length(r.basis1)),i.scale(r.basis2,r.basis2,1+a/i.length(r.basis2)),o.updateUnboundedPlane(r),r}function v(t,e,s){return i.subtract(A,i.subtract(A,t.origin,t.basis1),t.basis2),i.scaleAndAdd(B,A,t.basis1,2),i.scaleAndAdd(y,B,t.basis2,2),i.scaleAndAdd(f,A,t.basis2,2),A[2]=B[2]=y[2]=f[2]=e,p.autoSize2D({topLeft:f,topRight:y,bottomRight:B,bottomLeft:A,spatialReference:s})}const f=a.create(),y=a.create(),B=a.create(),A=a.create();t.TransformBounds=g,t.mapPlaneAutoSize2D=v,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
