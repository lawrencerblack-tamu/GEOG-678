/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/time","../../../../../core/Logger","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../camera/constraintUtils","../../../camera/constraintUtils/ConstraintOptions","../../../camera/constraintUtils/ConstraintTypes","../../../camera/constraintUtils/InteractionType","../../../layers/VoxelWasm","../PointToPointAnimationController","../../utils/navigationUtils","../../../webgl-engine/lib/Camera","../../../webgl-engine/lib/Intersector","../../../../animation/easing"],(function(t,e,i,a,o,r,s,n,c,m,l,h,p,_,C,y,u,g,b,d,w){"use strict";const z=.6,v=4,M=60;t.ZoomStepController=class extends u.PointToPointAnimationController{constructor(){super(...arguments),this._zoomLocation=l.create(),this._tmpCamera=new b.Camera,this._tmpRayDir=l.create(),this._tmpCenter=l.create(),this._beginCamera=new b.Camera,this._constraintOptions=new p.ConstraintOptions(_.ConstraintTypes.ALL,C.InteractionType.ZOOM,null,this._beginCamera)}zoomStep(t,e){if(!this.active)return;const a=this.view.state;this.animation.finished?this._beginCamera.copyFrom(a.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(a.camera);const o=d.newIntersector(this.view.state.viewingMode);let r=!1;t>0?(r=this.intersectionHelper.intersectScreenFreePointFallback(e,this._zoomLocation,0===this.view.map.ground.opacity?g.contentIntersectorOptions:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,o,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,o,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:m.copy(this._zoomLocation,this._tmpCamera.center);const s=z**t;let n=this.view._stage.renderView.getMinimalDepthForArea(y.getVoxelWasm(this.view),e[0],e[1],this.view.state.camera,M);m.subtract(D,this._tmpCamera.eye,this._zoomLocation),m.normalize(D,D);const c=i.clamp(Math.min(g.zoomDistanceModifier,1/Math.abs(m.dot(f,D)))*Math.abs(this.view.camera.position.z),g.zoomMinDistanceModifier,g.zoomMaxDistanceModifier);if(n=null!=n?n:c,n){const t=l.create();m.subtract(t,this._zoomLocation,this._tmpCamera.eye),(n<m.length(t)||!r)&&(m.normalize(t,t),m.add(this._zoomLocation,this._tmpCamera.eye,m.scale(t,t,n)))}this._updateCamera(this._tmpCamera,s,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:a.Milliseconds(600),easing:w.outExpo}}_updateCamera(t,e,i){m.subtract(this._tmpRayDir,i,t.eye);const a=m.length(this._tmpRayDir);let o=a*e;const r=e<=1,s=Math.max(v,1.01*t.nearFar[0]);0!==o&&(r&&o<s&&(o=s,e=o/a),Math.abs(a-o)<1e-6||(m.scale(this._tmpRayDir,this._tmpRayDir,e),t.eye=m.subtract(L,i,this._tmpRayDir),t.center=m.lerp(L,t.center,i,1-e),h.applyAll(this.view,t,this._constraintOptions)))}},t.ZoomStepController=e.__decorate([c.subclass("esri.views.3d.state.controllers.local.ZoomStepController")],t.ZoomStepController);const L=l.create(),f=l.fromValues(0,0,1),D=l.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
