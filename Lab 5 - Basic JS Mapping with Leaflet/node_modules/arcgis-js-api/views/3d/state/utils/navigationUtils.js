/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl-engine/lib/Camera","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,a,n,r,o,i,c,s,l,d,m,u,p,h,g,f,y,M,P){"use strict";var b;e.SpherePickPointFallback=void 0,(b=e.SpherePickPointFallback||(e.SpherePickPointFallback={}))[b.Ellipsoid=0]="Ellipsoid",b[b.Silhouette=1]="Silhouette";const v=30,S=[1,3e8],x=80,A=8,z=200,I=1508e5,T=5,R=50,k=5,C=10,D=90,E={exclude:new Set([P.terrainId])};function F(e,t,a){return a[0]=t[0]/(e.fullWidth/e.pixelRatio),a[1]=t[1]/(e.fullHeight/e.pixelRatio),a}function w(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function N(e,t,a){const n=r.fromRotation(g.sm4d.get(),a[3],d.axis(a));null==n||r.exactEquals(n,o.IDENTITY)||(s.subtract(Ce,e.eye,t),s.transformMat4(Ce,Ce,n),e.eye=s.add(Ce,Ce,t),s.subtract(Ce,e.center,t),s.transformMat4(Ce,Ce,n),e.center=s.add(Ce,Ce,t),e.up=s.transformMat4(Ce,e.up,n))}function H(e,t,a,n){return u.intersectRay(e,f.fromScreen(t,a,Ne),n)}function O(e,t,a,n){return u.intersectRay(e,f.fromScreenAtEye(t,a,Ne),n)}function q(e,t,a,n){const r=g.sv3d.get();let o=1-a;s.subtract(r,t,e.eye);const i=s.length(r);let c=i*(1-o);o>=0&&c<n&&(c=n,o=-(c-i)/i),Math.abs(i-c)<1e-6||(s.scale(r,r,o),e.eye=s.add(Ce,e.eye,r),e.center=s.lerp(Ce,e.center,t,o))}function V(e,t,a){t.getScreenCenter(G),y.intersectScreen(e,t,G,Ce)&&(t.center=Ce);const n=t.distance,r=n*a;if(Math.abs(n-r)<1e-6)return;const o=s.scale(g.sv3d.get(),t.viewForward,r);t.eye=s.subtract(Ce,t.center,o)}const G=n.createScreenPointArray();function U(e,t){s.set(t,0,0,0);for(const a of e)s.add(t,t,a);s.scale(t,t,1/e.length)}function W(e,t,a,n){return Math.sin(e/s.length(t))*(a+n.radius)}function Z(e,t,a,n){return W(Math.PI/2,t,a,n)+(e-Math.PI/2)}var j;e.NavigationMode=void 0,(j=e.NavigationMode||(e.NavigationMode={}))[j.Vertical=0]="Vertical",j[j.Horizontal=1]="Horizontal";const L={Elevation:3e4,Angle:a.deg2rad(16)},Y={Pole:.95,Angle:a.deg2rad(18),Tilt:45},B=a.deg2rad(80);function J(t,a,n,r,o,i){const c=l.create(),d=p.create();let m=!0,u=!0;return t.intersectScreen(n,c,i)?d[3]=s.length(c):(u=!1,a.aboveGround&&o!==e.SpherePickPointFallback.Ellipsoid?d[3]=Math.max(s.length(a.center),.9*r.radius):d[3]=s.length(a.eye)-a.relativeElevation,o===e.SpherePickPointFallback.Silhouette?$(d,a,n,c):m=y.intersectScreen(d,a,n,c)),{sphere:d,scenePickPoint:m?c:null,hasGeometryIntersection:u}}function K(t,a,n){if(s.length(t.eye)-n.radius>L.Elevation)return e.NavigationMode.Horizontal;f.fromScreenAtEye(t,a,He);return-Math.sign(t.relativeElevation)*(.5*Math.PI+h.angle(t.eye,He.direction))<L.Angle?e.NavigationMode.Vertical:e.NavigationMode.Horizontal}function Q(e,t,a){s.subtract(X,a,t),e.eye=s.subtract(Ce,e.eye,X),e.center=s.subtract(Ce,e.center,X)}const X=l.create();function $(e,t,a,n){const r=f.fromScreenAtEye(t,a,Ne);return null!=r&&(p.closestPointOnSilhouette(e,r,_),p.intersectRay(e,r,n)?!(s.squaredDistance(_,r.origin)<s.squaredDistance(n,r.origin))||(s.copy(n,_),!1):(s.subtract(ee,t.eye,t.center),s.normalize(ee,ee),u.fromNormalAndOffset(ee,-s.dot(s.normalize(ee,ee),_),te),u.intersectRay(te,r,n),!1))}const _=l.create(),ee=l.create(),te=u.create();function ae(e,n,r,o,i,c){let d=0;if(s.cross(Fe,e,n),s.subtract(De,e,n),s.length(e)<=i||!o.aboveGround){s.cross(r,De,o.eye);const m=s.dot(e,n)/(s.length(e)*s.length(n));if(m<.9999)d=a.acosClamped(m);else{const t=s.length(s.cross(l.create(),e,n))/(s.length(e)*s.length(n));d=a.asinClamped(t)}const u=Math.cos(a.clamp(t.cyclicalPI.normalize(a.deg2rad(c)),0,B));d=-d-Math.max(0,s.length(n)-i)/(u*i)}else s.subtract(ne,o.eye,o.center),s.cross(r,De,ne),d=-s.length(De)/i;return s.normalize(r,r),s.scale(r,r,s.length(Fe)),d}const ne=l.create();function re(e,n,r,o){let i,c;const s=Math.cos(a.clamp(t.cyclicalPI.normalize(a.deg2rad(o)),0,B));return i=n>r?-(n-r)/(s*r):n<-r?Math.PI-(n+r)/(s*r):a.acosClamped(n/r),c=e>r?-(e-r)/(s*r):e<-r?Math.PI-(e+r)/(s*r):a.acosClamped(e/r),(c-i)*r}function oe(e,t,a,n,r,o,c,l,d,m){const u=re(e[2],t[2],o[3],l),p=d?re(e[0],t[0],o[3],180):t[0]-e[0],h=Math.sin(c)*p-Math.cos(c)*u,g=Math.cos(c)*p+Math.sin(c)*u;s.normalize(Ce,r);const f=d?h/Math.sqrt(Math.abs(o[3]**2-s.dot(a,Ce)**2)):h/o[3],y=g/Math.sqrt(Math.abs(o[3]**2-s.dot(a,n)**2));i.set(m,f,y)}function ie(e,t,a,n,r,o,i,c,l,d){s.cross(Fe,e,t),m.coordinateSystemFromOneAxisAndNormalVector(o.up,o.eye,Pe,be,ve),m.coordinateSystemFromOneAxisAndNormalVector([0,0,1],o.eye,fe,ye,Me),s.copy(a,ye),s.copy(n,fe),s.normalize(a,a),s.scale(a,a,s.length(Fe)),m.vectorCoordinates(e,s.normalize(be,be),s.normalize(ve,ve),s.normalize(Pe,Pe),Se),m.vectorCoordinates(t,be,ve,Pe,xe),oe(Se,xe,e,fe,ye,i,c,l,d,r)}function ce(e,t,a,n,o,i,c){r.fromRotation(Ie,o,n),r.fromRotation(Te,c,i),r.multiply(Re,Ie,Te),s.subtract(t,e,a),s.transformMat4(t,t,Re),s.add(t,t,a)}function se(e,t,a,n,o,i){r.fromRotation(Ie,n,a),r.fromRotation(Te,i,o),r.multiply(Re,Ie,Te),s.subtract(Ce,e.eye,t),s.transformMat4(Ce,Ce,Re),e.eye=s.add(Ce,Ce,t),s.subtract(Ce,e.center,t),s.transformMat4(Ce,Ce,Re),e.center=s.add(Ce,Ce,t),s.subtract(Ce,e.up,t),s.transformMat4(Ce,Ce,Re),e.up=s.add(Ce,Ce,t)}function le(e,t,a,n,r,o){return(Math.abs(n)>Math.PI-Y.Angle||Math.abs(n)<Y.Angle)&&(Math.abs(e[2])<a*Y.Pole||Math.abs(t)>a)&&o.aboveGround&&r<Y.Tilt}function de(e,t,a,n,r,o){if(o)d.fromPoints(a,n,ze),N(t,p.getCenter(e),ze);else{const o=ae(a,n,we,t,e[3],r);N(t,p.getCenter(e),d.wrapAxisAngle(we,o))}}function me(e,t,a,n,r,o,i){const c=i?20:1,l=1e-12;let d,m;s.copy(ke,n),Ee.copyFrom(t);for(let u=0;u<c&&s.squaredDistance(a,ke)>l&&(d=s.squaredDistance(a,ke),ie(a,ke,ye,fe,Ae,Ee,e,r,o,i),se(Ee,p.getCenter(e),fe,Ae[1],ye,Ae[0]),ce(ke,ke,p.getCenter(e),fe,Ae[1],ye,Ae[0]),m=s.squaredDistance(a,ke),m<d||0===u);u++)t.copyFrom(Ee)}function ue(e,n,r,o,i,c,l){le(r,s.dot(n.up,r),e[3],-t.cyclicalPI.normalize(a.deg2rad(i)),c,n)?me(e,n,r,o,-t.cyclicalPI.normalize(a.deg2rad(i)),c,l):de(e,n,r,o,c,l)}function pe(e,t,a,n,o,i){const{eye:c}=e;m.coordinateSystemFromOneAxisAndNormalVector([0,0,1],c,fe,ye,Me);const l=t.translation[0]*a.pan,d="zoom"===o.mode?0:t.translation[1]*a.pan,u=Math.max(Math.sqrt(Math.abs(1-s.dot(e.center,fe)**2/s.length(e.center)**2)),.5),p=(Math.sin(i)*d+Math.cos(i)*l)/u,h=-Math.cos(i)*d+Math.sin(i)*l;switch(r.rotate(n.pan.matrix,n.pan.matrix,p,fe),n.pan.enabled=!0,o.mode){case"pan":r.rotate(n.pan.matrix,n.pan.matrix,h,ye),n.pan.enabled=!0;break;case"zoom":n.zoom=-t.translation[1]*a.zoom}}function he(e,t,a,n,o){const{eye:i,viewRight:c}=e,l=s.cross(g.sv3d.get(),c,i),d=t.translation[0]*a.pan;switch(0!==d&&(r.rotate(n.pan.matrix,n.pan.matrix,-d,l),n.pan.enabled=!0),o.mode){case"pan":{const e=t.translation[1]*a.pan;0!==e&&(r.rotate(n.pan.matrix,n.pan.matrix,e,c),n.pan.enabled=!0);break}case"zoom":n.zoom=-t.translation[1]*a.zoom}}function ge(e,n,r,o,i,c,l,d,m){le(e.center,s.dot(e.up,e.center),s.length(e.center),-t.cyclicalPI.normalize(a.deg2rad(c)),l,n)?pe(n,r,o,d,m,-t.cyclicalPI.normalize(a.deg2rad(i))):he(n,r,o,d,m)}const fe=l.create(),ye=l.create(),Me=l.create(),Pe=l.create(),be=l.create(),ve=l.create(),Se=l.create(),xe=l.create(),Ae=c.create(),ze=d.create(),Ie=o.create(),Te=o.create(),Re=o.create(),ke=l.create(),Ce=l.create(),De=l.create(),Ee=new M.Camera,Fe=l.create(),we=l.create(),Ne={origin:l.create(),direction:l.create()},He={origin:l.create(),direction:l.create()};e.PreservingHeadingThreshold=Y,e.TiltThresholdPanningSpeed=B,e.VerticalPanTresholds=L,e.applyPanPlanar=Q,e.applyPanSphericalDirectRotation=de,e.applyPanSphericalPreserveHeading=me,e.applyRotation=N,e.applyRotationWithTwoAxes=se,e.applyZoomOnSphere=V,e.applyZoomToPoint=q,e.centroid=U,e.contentIntersectorOptions=E,e.decideNavigationMode=K,e.distanceClampValues=S,e.intersectPlaneFromScreenPoint=H,e.intersectPlaneFromScreenPointAtEye=O,e.lengthFromPoints=re,e.minHeightLimit=R,e.normalizeCoordinate=F,e.normalizeRotationDelta=w,e.offSurfaceTiltToEyeTiltGlobal=Z,e.onSurfaceTiltToEyeTiltGlobal=W,e.panDistanceModifier=T,e.panMotionToRotationMatrix=ge,e.panToPosition=ue,e.pickPointAndInitSphere=J,e.pivotDistanceModifier=v,e.preserveHeadingThreshold=le,e.rotatePivotDistanceModifier=k,e.rotatePivotMinDistanceModifier=C,e.rotatePointAroundTwoAxes=ce,e.rotateScreenPixelArea=D,e.rotationAngleAndAxisDirectRotation=ae,e.rotationAnglesAndAxesHeadingPreserving=ie,e.rotationAnglesHeadingPreserving=oe,e.screenPixelArea=x,e.sphereOrPlanePointFromScreenPoint=$,e.zoomDistanceModifier=A,e.zoomMaxDistanceModifier=I,e.zoomMinDistanceModifier=z,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
