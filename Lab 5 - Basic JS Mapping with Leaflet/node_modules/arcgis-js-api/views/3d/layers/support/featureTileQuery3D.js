/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/SetUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/dehydratedFeatures","../../../../rest/query/operations/query","../../support/PBFDecoder"],(function(e,r,t,o,s,u,a,i,y,c,l,n,p,d){"use strict";let h=class extends t{constructor(e){super(e)}get implicitFields(){const e=this.layer.outFields?.includes("*");if(!e)return new Set;const r=new Set(this.layerView.requiredFields),t=new Set(this.layerView.availableFields);return u.difference(t,r)}get queryFeaturesDehydrated(){const{layer:e}=this,r=e.capabilities,t=r&&r.query,o=t&&t.supportsFormatPBF,u=e.parsedUrl;if(o){null==this._decoder&&(this._decoder=new d.PBFDecoder(this.controller));const r={sourceSpatialReference:e.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:m};return(e,t)=>p.runQuery(u,e,"pbf",this._createRequestOptions(t)).then((e=>(s.throwIfAborted(t),null!=this._decoder?this._decoder.invoke({buffer:e.data,options:r},t.signal):Promise.reject(s.createAbortError()))))}return(r,t)=>p.executeQuery(u,r,e.spatialReference,this._createRequestOptions(t)).then((e=>n.fromFeatureSetJSON(e.data,{maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:m})))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}destroy(){this._decoder=o.destroyMaybe(this._decoder)}_createRequestOptions(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...e?.query}}}};r.__decorate([a.property({constructOnly:!0})],h.prototype,"layer",void 0),r.__decorate([a.property({constructOnly:!0})],h.prototype,"layerView",void 0),r.__decorate([a.property({constructOnly:!0})],h.prototype,"controller",void 0),r.__decorate([a.property({readOnly:!0})],h.prototype,"implicitFields",null),r.__decorate([a.property({readOnly:!0})],h.prototype,"queryFeaturesDehydrated",null),h=r.__decorate([l.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],h);let F=class extends t{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.layer.queryFeatures(e,r)}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}};r.__decorate([a.property({constructOnly:!0})],F.prototype,"layer",void 0),r.__decorate([a.property({readOnly:!0})],F.prototype,"queryFeaturesDehydrated",null),F=r.__decorate([l.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],F);let _=class extends t{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.layer.queryFeatures(e,r)}};r.__decorate([a.property({constructOnly:!0})],_.prototype,"layer",void 0),_=r.__decorate([l.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],_);let f=class extends t{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.source.queryFeaturesJSON(e,r).then(n.fromFeatureSetJSON,(t=>{if(t&&"query-features-json:unsupported"===t.name)return this.layer.queryFeatures(e,r);throw t}))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}};function q(e,r){const{layer:t}=e;return"feature"===t.type&&"feature-layer"===t.source.type?null!=t.infoFor3D?new F({layer:t}):new h({layer:t,layerView:e,controller:r}):"feature"===t.type&&"memory"===t.source.type||"csv"===t.type||"geojson"===t.type||"oriented-imagery"===t.type||"wfs"===t.type?new f({layer:t,source:t.source}):"ogc-feature"===t.type?new _({layer:t}):null}r.__decorate([a.property({constructOnly:!0})],f.prototype,"layer",void 0),r.__decorate([a.property({constructOnly:!0})],f.prototype,"source",void 0),f=r.__decorate([l.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],f);const m=1024;e.createFeatureTileQuery3D=q,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
