/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/mathUtils","../../../../core/ObjectPool","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/projection/projectBuffer","../../../../geometry/projection/projectVec3Array","../../../../geometry/support/frustum","../../../../geometry/support/plane","../../../../geometry/support/ray","../../../ViewingMode","./FeatureTileDescriptor3D","../../state/Frustum","../../support/FrustumExtentIntersection"],(function(e,t,r,i,s,n,o,c,a,u,l,d,_,h,f){"use strict";class m{constructor(e){this._renderCoordsHelper=e,this._surfaceElevation=0,this._cache=new Map,this._frustumBoundingSphereCenter=s.create(),this._frustumBoundingSphereRadius=0,this._frustum=new h.Frustum(e),this._extendedFrustum=new h.Frustum(e),this._intersector=new f.FrustumExtentIntersection({renderCoordsHelper:e}),this._renderCoordsHelper=e}begin(e,t){this._surfaceElevation=t,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>t,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e),this._updateFrustumBoundingSphere()}end(){this._cache.clear()}calculate(e){const t=this._renderCoordsHelper.viewingMode===d.ViewingMode.Global&&e.lij[0]>=T&&e.lij[0]<p,r=this._getOrCalculateSingleTileVisibility(e,!t);return r!==_.Visibility.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):r}_shortenFrustumFarPlane(e){const t=h.Frustum.nearFarLineIndices,r=e.mutablePoints;for(const s of t){const[e,t]=s,n=r[e],o=r[t];i.subtract(g,o,n),i.scale(g,g,F),i.add(r[t],n,g)}e.updatePoints(r)}_calculateAggregatedChildrenVisibility(e){let t=_.Visibility.INVISIBLE;const r=this._cache.get(e.id);if(null!=r)return r;const i=E.acquire();e.getChildren(i);for(const s of i){const e=this.calculate(s);if(e!==_.Visibility.INVISIBLE&&(t=e,e===_.Visibility.VISIBLE_ON_SURFACE))break}return E.release(i),this._cache.set(e.id,t),t}_getOrCalculateSingleTileVisibility(e,t){const r=this._cache.get(e.id);if(null!=r)return r;const i=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,i),i}_calculateSingleTileVisibility(e){if(!this._aboveGround&&this._renderCoordsHelper.viewingMode===d.ViewingMode.Global&&e.lij[0]<I){return this._calculateSingleTileVisibilitySided(e,!1)===_.Visibility.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0}return this._calculateSingleTileVisibilitySided(e,this._aboveGround)}_isTileVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===d.ViewingMode.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,r=k;i.normalize(r,e.direction);const s=e.points,n=q;i.sub(n,s[4],t);const o=.5*i.dot(n,n)/i.dot(r,n),c=this._frustumBoundingSphereCenter;i.scaleAndAdd(c,t,r,o);const a=1+o;this._frustumBoundingSphereRadius=a}_isTileVisibleInFrustumLocal(e){const t=e.tilingScheme.spatialReference,r=e.extent,s=this._renderCoordsHelper.spatialReference,n=N;if(n[0]=r[0],n[1]=r[1],n[2]=0,n[3]=r[2],n[4]=r[3],n[5]=0,!o.projectBuffer(n,t,0,n,s,0,2))return!1;const c=C;i.set(c[0],n[0],n[1],0),i.set(c[1],n[3],n[1],0),i.set(c[2],n[3],n[4],0),i.set(c[3],n[0],n[4],0);const a=G;i.set(a,.5*(n[0]+n[3]),.5*(n[1]+n[4]),.5*(n[2]+n[5]));const u=L;i.set(u,0,0,1);const l=.5*i.dist(c[0],c[2]),d=this._frustum,_=this._frustumBoundingSphereRadius,h=this._frustumBoundingSphereCenter,f=Y;i.sub(f,h,a);const m=i.dot(u,f),T=X;i.scaleAndAdd(T,a,u,m);if(i.dist(T,h)>l+_)return!1;const p=M,I=m+_,F=m-_;for(let o=0;o<4;++o)i.scaleAndAdd(p[o],c[o],u,I),i.scaleAndAdd(p[o+4],c[o],u,F);return!B(d.planes,p,8)}_isTileVisibleInFrustumGlobal(e){const t=e.tilingScheme.spatialReference,r=e.extent,o=this._renderCoordsHelper.spatialReference;if(e.lij[0]<y)return!0;const a=C,u=.5*(r[0]+r[2]);if(i.set(a[0],r[0],r[1],0),i.set(a[1],r[2],r[1],0),i.set(a[2],r[2],r[3],0),i.set(a[3],r[0],r[3],0),i.set(a[4],u,r[1],0),i.set(a[5],u,r[3],0),!c.projectVec3Array(a,t,0,a,o,0,6))return!1;const l=a[0][2]>0,d=a[3][2]<0,_=l||d,h=n.getReferenceEllipsoid(o).radius;if(_){const e=s.fromValues(0,0,1),t=w;A(t,e,a[0]);const r=j;if(A(r,e,a[1]),l){const s=v,n=a[4],o=D;A(o,n,e),A(s,o,n);const c=a[0];i.cross(c,t,s),O(c,h);const u=a[1];i.cross(u,r,s),O(u,h)}else if(d){const s=v,n=a[5],o=D;A(o,n,e),A(s,n,o);const c=a[3];i.cross(c,s,t),O(c,h);const u=a[2];i.cross(u,s,r),O(u,h)}}const f=G;{const e=$;i.sub(e,a[3],a[0]),i.normalize(e,e);const t=ee;i.add(t,a[0],a[3]),i.scale(t,t,.5);const r=-i.dot(t,e),s=te,n=re;i.add(s,a[0],a[1]),i.scale(s,s,.5),i.add(n,a[2],a[3]),i.scale(n,n,.5);const o=ie;i.sub(o,n,s),i.normalize(o,o);const c=-(r+i.dot(e,s))/i.dot(e,o);i.scaleAndAdd(f,s,o,c),O(f,h)}const m=this._frustumBoundingSphereRadius,T=this._frustumBoundingSphereCenter,p=this._frustum,I=p.planes;if(a.some((e=>p.intersectsPoint(e))))return!0;if(p.intersectsPoint(f))return!0;const F=z;i.normalize(F,f);const P=K;i.sub(P,T,J);const g=i.dot(P,F);if(g<-m)return!1;const x=W;i.normalize(x,a[0]);const b=i.dot(x,F);if(b<=0)return!0;const E=U;i.scale(E,F,g);const V=i.dist(E,T),S=t.isWGS84,M=e.lij,N=S&&M[2]===2**M[0]-1,L=S&&0===M[2],k=L?he:N?de:ue,q=L?fe:N?_e:le,X=p.points;{const e=a,t=me,r=se,i=ne,s=J;for(const n of k){const o=e[n];if(R(r,e[(n+1)%4],o),R(i,s,o),A(t,i,r),H(t,X,1))return!1}}let Y=null;if(g<2*m){const e=2.5*m;if(V>b*e+m)return!1;const t=Z,r=e/b;for(let s=0;s<4;++s)i.scale(t[s],a[s],r/h);i.set(t[4],0,0,0),Y=t}else{const e=(g+m)/b,t=(g-m)/b,r=Q;for(let s=0;s<4;++s){const n=a[s];i.scale(r[s+4],n,t/h),i.scale(r[s],n,e/h)}Y=r}if(B(I,Y,Y.length))return!1;const ae=p.lines,Te=oe,pe=ce;for(const s of q){i.normalize(Te,a[s]);for(const e of ae)if(i.normalize(pe,e.direction),Fe(pe,Te,Y,X))return!1}return!0}_calculateSingleTileVisibilitySided(e,t){if(this._isTileVisibleInFrustum(e)){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t);const r=n.getReferenceEllipsoid(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._frustum,r,!0)?_.Visibility.VISIBLE_ON_SURFACE:_.Visibility.VISIBLE_WHEN_EXTENDED}return _.Visibility.INVISIBLE}_updateExtendedFrustum(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);const r=this._renderCoordsHelper.worldUpAtPosition(e.eye,g);this._aboveGround||i.negate(r,r);const s=t.acosClamped(-i.dot(r,e.viewForward));if(this._hasExtendedFrustum=s>e.fovY/2,!this._hasExtendedFrustum)return;const n=this._extendedFrustumParameters(),o=this._extendedFrustum.mutablePoints;for(let t=0;t<4;t++){const e=n.pointIndices[t],r=o[e],s=this._renderCoordsHelper.getAltitude(r);if(n.needsAltitudeAdjustment(s)){switch(this._renderCoordsHelper.worldUpAtPosition(r,g),e){case a.PointIndex.FAR_BOTTOM_LEFT:case a.PointIndex.FAR_TOP_LEFT:case a.PointIndex.NEAR_BOTTOM_LEFT:case a.PointIndex.NEAR_TOP_LEFT:u.projectVector(this._extendedFrustum.planes[a.PlaneIndex.LEFT],g,g);break;case a.PointIndex.FAR_BOTTOM_RIGHT:case a.PointIndex.FAR_TOP_RIGHT:case a.PointIndex.NEAR_BOTTOM_RIGHT:case a.PointIndex.NEAR_TOP_RIGHT:u.projectVector(this._extendedFrustum.planes[a.PlaneIndex.RIGHT],g,g)}i.scale(g,g,n.direction),this._renderCoordsHelper.intersectInfiniteManifold(l.wrap(r,g),n.zWithMargin,r)}}if(this._extendedFrustum.updatePoints(o),u.fromPoints(o[a.PointIndex.NEAR_BOTTOM_LEFT],o[a.PointIndex.NEAR_BOTTOM_RIGHT],o[a.PointIndex.NEAR_TOP_RIGHT],x),u.fromPoints(o[a.PointIndex.NEAR_BOTTOM_RIGHT],o[a.PointIndex.NEAR_TOP_RIGHT],o[a.PointIndex.NEAR_TOP_LEFT],b),i.dot(u.getNormal(x),u.getNormal(b))<0){const e=this._extendedFrustum.mutablePoints;this._aboveGround?[e[a.PointIndex.NEAR_BOTTOM_LEFT],e[a.PointIndex.NEAR_BOTTOM_RIGHT]]=[e[a.PointIndex.NEAR_BOTTOM_RIGHT],e[a.PointIndex.NEAR_BOTTOM_LEFT]]:[e[a.PointIndex.NEAR_TOP_LEFT],e[a.PointIndex.NEAR_TOP_RIGHT]]=[e[a.PointIndex.NEAR_TOP_RIGHT],e[a.PointIndex.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(e)}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this._surfaceElevation-P;return{zWithMargin:e,pointIndices:h.Frustum.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}_extendedFrustumParametersBelowSurface(){const e=this._surfaceElevation+P;return{zWithMargin:e,pointIndices:h.Frustum.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const T=2,p=6,I=12,F=.95,P=1,g=s.create(),x=u.create(),b=u.create(),E=new r(Array,(e=>{4!==e.length&&(e[0]=new _.FeatureTileDescriptor3D,e[1]=new _.FeatureTileDescriptor3D,e[2]=new _.FeatureTileDescriptor3D,e[3]=new _.FeatureTileDescriptor3D)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));function A(e,t,r){return i.cross(e,t,r),i.normalize(e,e),e}function R(e,t,r){return i.sub(e,t,r),i.normalize(e,e),e}function O(e,t){return i.scale(e,e,t/i.len(e)),e}const V=[a.PlaneIndex.LEFT,a.PlaneIndex.RIGHT,a.PlaneIndex.BOTTOM,a.PlaneIndex.TOP,a.PlaneIndex.FAR];function S(e,t,r){for(let i=0;i<r;++i)if(u.signedDistance(e,t[i])<0)return!1;return!0}function B(e,t,r){for(const i of V)if(S(e[i],t,r))return!0;return!1}const y=3;function H(e,t,r){for(const s of t)if(i.dot(s,e)<r)return!1;return!0}const M=[s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create()],N=[0,0,0,0,0,0],C=[s.create(),s.create(),s.create(),s.create(),s.create(),s.create()],G=s.create(),L=s.create(),v=s.create(),w=s.create(),j=s.create(),D=s.create(),z=s.create(),U=s.create(),W=s.create(),k=s.create(),q=s.create(),X=s.create(),Y=s.create(),J=s.fromValues(0,0,0),K=s.create(),Q=[s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create()],Z=[s.create(),s.create(),s.create(),s.create(),s.create()],$=s.create(),ee=s.create(),te=s.create(),re=s.create(),ie=s.create(),se=s.create(),ne=s.create(),oe=s.create(),ce=s.create(),ae=s.create(),ue=[0,1,2,3],le=[0,1,2,3],de=[0,1,3],_e=[0,1,3],he=[1,2,3],fe=[1,2,3],me=s.create();function Te(e,t,r){let s=1/0,n=-1/0;for(const o of r){const e=i.dot(t,o);s=Math.min(s,e),n=Math.max(n,e)}e[0]=s,e[1]=n}function pe(e,t,r,s){let n=1/0,o=-1/0;for(const c of s){const s=i.dot(r,c);if(n=Math.min(n,s),o=Math.max(o,s),n<=t&&o>=e)return!1}return!0}const Ie=[0,0];function Fe(e,t,r,i){const s=ae;A(s,e,t);const n=Ie;return Te(n,s,r),pe(n[0],n[1],s,i)}e.FeatureTileVisibility3D=m,e.globalTileLevelThreshold=y,e.isConvexHullOutsideOfFrustum=B,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
