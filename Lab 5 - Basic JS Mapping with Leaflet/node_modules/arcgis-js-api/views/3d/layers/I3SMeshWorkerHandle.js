/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../core/Logger","../../../core/PooledArray","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/workers/WorkerHandle","../../../geometry/projection","../../../geometry/projection/projectVectorToVector","../../../libs/i3s/enums"],(function(e,s,o,t,r,i,n,p){"use strict";class a extends r.WorkerHandle{constructor(e){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},e,{hasInitialize:!0})}setModifications(e,s,o,t){const r={context:e,modifications:u(s,o,t),isGeodetic:t.isGeographic};this.broadcast(r,"setModifications")}setLegacySchema(e,s){const o=JSON.stringify(s);return this.broadcast({context:e,jsonSchema:o},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}project(e,s){return this.invokeMethod("project",e,s)}transformNormals(e,s){return this.invokeMethod("transformNormals",e,s)}}const c=new o({deallocator:null}),h=t.create();function u(e,o,t){c.clear();let r=1/0,a=1/0,u=-1/0,f=-1/0,l=!1;for(const g of o){const e="clip"===g.type?p.ModificationType.Inside:"mask"===g.type?p.ModificationType.Outside:p.ModificationType.Replace,o=g.geometry;let d=e=>e;if(o.spatialReference){if(!i.canProjectWithoutEngine(o.spatialReference,t)){s.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}d=e=>(n.projectVectorToVector(e,o.spatialReference,h,t),h)}else o.hasZ||(h[2]=0,d=e=>(h[0]=e[0],h[1]=e[1],h));l=l||e===p.ModificationType.Outside,c.push(e),c.push(o.rings.length);for(const s of o.rings){c.push(s.length);for(const e of s){const s=d(e);c.push(s[0]),c.push(s[1]),c.push(s[2]),r=Math.min(r,s[0]),a=Math.min(a,s[1]),u=Math.max(u,s[0]),f=Math.max(f,s[1])}}}if(null!=e)if(l){const s=1e-4;c.push(p.ModificationType.Inside),c.push(2),c.push(4),c.push(r-s),c.push(a-s),c.push(0),c.push(u+s),c.push(a-s),c.push(0),c.push(u+s),c.push(f+s),c.push(0),c.push(r-s),c.push(f+s),c.push(0),c.push(4),c.push(e[0]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[3]),c.push(0),c.push(e[0]),c.push(e[3]),c.push(0)}else c.push(p.ModificationType.Outside),c.push(1),c.push(4),c.push(e[0]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[3]),c.push(0),c.push(e[0]),c.push(e[3]),c.push(0);c.push(p.ModificationType.Finished);const d=new Float64Array(c.length);for(let s=0;s<c.length;++s)d[s]=c.at(s);return d}e.I3SMeshWorkerHandle=a,e.toWasmModification=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
