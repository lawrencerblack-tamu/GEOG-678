/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../Graphic","../../../core/Accessor","../../../core/arrayUtils","../../../core/Collection","../../../core/handleUtils","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../layers/buildingSublayers/BuildingGroupSublayer","./BuildingComponentSublayerView3D","./BuildingSublayerView3D","./LayerView3D","./i3s/BuildingFilterUtil","./i3s/I3SUtil","../support/updatingProperties","../../layers/BuildingSceneLayerView"],(function(e,r,t,s,i,n,o,l,a,u,c,h,p,y,d,g,f,b,w,V,_){"use strict";const m=g.BuildingSublayerView3DMixin(t);let S=class extends(f.LayerView3D(_)){constructor(e){super(e),this.type="building-scene-3d",this.sublayerViews=new i,this._abortController=new AbortController,this._loadingComponents=0,this._pendingWhenSublayerViews=new Map,this.ignoresMemoryFactor=!1}get filterExpression(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null,t=null!=r?r.filterBlocks?.find((e=>"solid"===e.filterMode.type)):null;return t?t.filterExpression:null}get filterExpressions(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null;return r?.filterBlocks?r.filterBlocks.toArray().map((e=>[e.filterExpression??"",b.parseFilterMode(e)])):[]}get updatingProgressValue(){const e=this.sublayerViews,r=this._loadingComponents+(e?e.length:0);return e.reduce(((e,r)=>e+r.updatingProgress),0)/r}isUpdating(){return this._loadingComponents>0||this.sublayerViews&&this.sublayerViews.some((e=>e.updating))}initialize(){w.checkSpatialReference(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this._initializeSubLayerViews(this.layer.sublayers,this)}destroy(){this.sublayerViews&&(this.sublayerViews.forEach((e=>e.destroy())),this.sublayerViews=null),this._abortController=l.abortMaybe(this._abortController)}_initializeSubLayerViews(e,r){const t=this,s=this.view;e.forEach((e=>{if(!e.isEmpty)if("building-group"===e.type){const t=new m({sublayer:e,view:s,parent:r});this._initializeSubLayerViews(e.sublayers,t)}else"mesh"===e.geometryType&&(this._loadingComponents++,e.load({signal:this._abortController.signal}).then((()=>{const i=new d({sublayer:e,layerView:t,view:s,parent:r});this.sublayerViews.push(i);const n=this._pendingWhenSublayerViews.get(e);if(n){for(const e of n)e.resolve(i);this._pendingWhenSublayerViews.delete(e)}this.addHandles([u.watch((()=>i.updating),(()=>this.notifyChange("updating")),u.syncAndInitial),u.watch((()=>i.updatingProgress),(()=>this.notifyChange("updatingProgressValue")),u.syncAndInitial)])})).catch((r=>{a.isAbortError(r)||o.getLogger(this).error(`Error while creating view for sublayer ${e.id}\nLayer: ${this.layer.url}\n`,r)})).then((()=>{this._loadingComponents--,this.notifyChange("updating"),this.notifyChange("updatingProgressValue")})))}))}getGraphicFromIntersectorTarget(e){for(const r of this.sublayerViews.items)if(r.sublayer.uid===e.sublayerUid)return r.getGraphicFromIntersectorTarget(e);return null}async fetchPopupFeaturesFromGraphics(e,r){if(0===e.length)return[];const t=s.groupToMap(e,(e=>e.sourceLayer)),i=[];for(const[s,o]of t){const e=this._findComponent(s);null!=e&&i.push(e.fetchPopupFeaturesFromGraphics(o,r))}const n=await a.allSettledValues(i);return a.throwIfAborted(r),n.flat()}whenGraphicBounds(e){const r=this._findComponent(e.sourceLayer);return null==r?Promise.reject():r.whenGraphicBounds(e)}getAABBFromIntersectorTarget(e){for(const r of this.sublayerViews.items)if(r.sublayer.uid===e.sublayerUid)return r.getAABBFromIntersectorTarget(e);return null}async whenSublayerView(e){const r=this._findComponent(e);if(null!=r)return r;const t=this._pendingWhenSublayerViews.get(e),s=a.createResolver();return t?t.push(s):this._pendingWhenSublayerViews.set(e,[s]),s.promise}_findComponent(e){return this.sublayerViews.find((r=>e===r.sublayer))}highlight(e){e instanceof r?e=[e]:e instanceof i&&(e=e.toArray());const t=[];if(Array.isArray(e)&&e.length>0&&e[0]instanceof r){const r=e,s=new Map;for(const e of r){let r=s.get(e.sourceLayer);null==r&&(r=[],s.set(e.sourceLayer,r)),r.push(e)}this.sublayerViews.forEach((e=>{const r=s.get(e.sublayer);r&&t.push(e.highlight(r))}))}return n.handlesGroup(t)}get usedMemory(){return this.sublayerViews.reduce(((e,r)=>e+r.usedMemory),0)}get unloadedMemory(){return this.sublayerViews.reduce(((e,r)=>e+r.unloadedMemory),0)}};e.__decorate([c.property()],S.prototype,"sublayerViews",void 0),e.__decorate([c.property({readOnly:!0})],S.prototype,"filterExpression",null),e.__decorate([c.property({readOnly:!0})],S.prototype,"filterExpressions",null),e.__decorate([c.property(V.updatingProgress)],S.prototype,"updatingProgress",void 0),e.__decorate([c.property({readOnly:!0,dependsOn:[]})],S.prototype,"updatingProgressValue",null),S=e.__decorate([p.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],S);return S}));
