/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../geometry/spatialReferenceEllipsoidUtils","../../../../geometry/support/aaBoundingBox"],(function(e,t,s){"use strict";class n{constructor(e,s,n){this._pages=[],this.pageSize=0,this._nodeSR=e,this._renderSR=s,this._renderSRSphericalPCPF=t.getSphericalPCPF(s),this.pageSize=n}addPage(e,t,s=0){for(;this._pages.length<e;)this._pages.push(null);o(t,this._nodeSR,this._renderSR,s,this._renderSRSphericalPCPF),this._pages[e]={nodes:t,parents:new Uint32Array(this.pageSize)},r(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const t=this.pageSize;return this._pages[a(e,t)].nodes[p(e,t)]}getRenderObb(e){const t=this.pageSize;return this._pages[a(e,t)].nodes[p(e,t)].obbInRenderSR}setRenderObb(e,t){const s=this.pageSize;this._pages[a(e,s)].nodes[p(e,s)].obbInRenderSR.copy(t)}getParentId(e){const t=this.pageSize;return this._pages[a(e,t)].parents[p(e,t)]}hasNodes(e,t){const s=a(e,this.pageSize),n=a(e+t-1,this.pageSize);for(let i=s;i<=n;i++)if(null==this._pages[i])return!1;return!0}forEachNodeId(e){for(let t=0;t<this._pages.length;t++){const s=this._pages[t];if(s)for(let n=0;n<s.nodes.length;n++)e(t*this.pageSize+n)}}createVisibilityTraverse(){const e={index:this,queue:[],masks:[],tempAabb:s.create()};return(t,s)=>i(e,t,s)}}function i(e,t,n){const i=e.index;if(!i.hasNodes(0,1))return;const o=e.queue;o.length=0,o.push(0);const r=e.masks;for(r.length=0,r.push(0);o.length>0;){const p=o.pop();let h=r.pop();const g=i.getNode(p),c=i.getRenderObb(p);let l=!0;if(null!=t.clippingBox){const n=1<<t.frustum.length;0==(h&n)&&(c.toAaBoundingBox(e.tempAabb),s.contains(t.clippingBox,e.tempAabb)?h|=n:s.intersects(t.clippingBox,e.tempAabb)||(l=!1))}for(let e=0;e<t.frustum.length&&l;e++){const s=1<<e;if(0==(h&s)){const n=c.intersectPlane(t.frustum[e]);n>0?l=!1:n<0&&(h|=s)}}if(n.predicate(p,g,l)){const e=g.firstChild,t=g.childCount;let s=!1;const c=a(e,i.pageSize),l=a(e+t-1,i.pageSize);for(let o=c;o<=l;o++)if(!i.hasPage(o)){n.pageMiss(p,o),s=!0;break}if(!s)for(let n=0;n<t;n++)o.push(e+n),r.push(h)}}}function o(e,t,s,n,i){for(let o=0;o<e.length;o++){const r=e[o];r.obb.transform(r.obbInRenderSR,t,s,n,i)}}function r(e,t){const s=[0];for(;s.length;){const n=s.pop(),i=e[a(n,t)].nodes[p(n,t)];for(let o=0;o<i.childCount;o++){const r=i.firstChild+o;null!=e[a(r,t)]&&(e[a(r,t)].parents[p(r,t)]=n,s.push(r))}}}function a(e,t){return e/t|0}function p(e,t){return e%t}e.PagedNodeIndex=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
