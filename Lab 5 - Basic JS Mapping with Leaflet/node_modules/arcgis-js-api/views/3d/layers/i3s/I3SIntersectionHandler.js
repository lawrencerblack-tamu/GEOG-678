/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../ViewingMode","./I3SUtil","./Intersector","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,i,n,s,r,l){"use strict";class o{constructor(e){this.type=r.IntersectorType.I3S,this._needVerticalOffset=!1,this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this._collection=e.collection,this._traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}updateElevationAlignState(e,i){this._needVerticalOffset=e&&i===t.ViewingMode.Global}intersect(e,t,o,a,d,u){const b=u??!1,f=e.results,y=e.options.store===r.StoreResults.ALL,h=e.ray.direction,g=e.tolerance;let I=e=>e,R=e=>e;const S=l.getVerticalOffsetI3S(e.verticalOffset??(this._needVerticalOffset?0:null));null!=e.verticalOffset&&null!=S&&(I=e=>S.applyToMbs(e),R=e=>S.applyToObb(e));const p=(r,l)=>{if(0===r.childrenLoaded)return!1;const d=r.serviceObbInRenderSR?.isValid?r.serviceObbInRenderSR:null;return!(d&&!R(d).intersectRay(o,h,g))&&(!l||!d&&i.isValidMbs(r.serviceMbsInRenderSR)&&!c(I(r.serviceMbsInRenderSR),o,h,g)||null!=r.geometryObbInRenderSR&&!R(r.geometryObbInRenderSR).intersectRay(o,h,g)||this._collection.intersect(l,o,a,g,S,((i,l,c,d)=>{if(l<0||null!=t&&!t(o,a,l))return;const u=e=>{const t=new n.I3sTarget(this.layerUid,this.sublayerUid,r.index,i,d);e.set(this.type,t,l,c)};if(this.isGround&&(null==f.ground.dist||l<f.ground.dist)&&u(f.ground),!e.options.isFiltered&&((null==f.min.dist||l<f.min.dist)&&u(f.min),(null==f.max.dist||l>f.max.dist)&&u(f.max),y)){const t=s.newIntersectorResult(e.ray);u(t),e.results.all.push(t)}}),b),!0)};this._traverseNodeHierarchy(p)}}function c(e,t,i,n=0){const s=e[3]+n,r=t[0]-e[0],l=t[1]-e[1],o=t[2]-e[2],c=i[0],a=i[1],d=i[2],u=c*r+a*l+d*o;return u*u-(c*c+a*a+d*d)*(r*r+l*l+o*o-s*s)>=0}e.I3SIntersectionHandler=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
