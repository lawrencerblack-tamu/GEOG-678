/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/support/aaBoundingRect","../../../../chunks/sphere","../../support/ElevationRange","../../support/ElevationUpdateEvent","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces"],(function(e,t,r,n,o,i,s,a,l,c,p,u,d,v,h,m,E,g,y,_){"use strict";e.LayerElevationProvider=class extends(n.EventedMixin(r)){constructor(e){super(e),this._tmpEvent=new g.ElevationUpdateEvent,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=y.newIntersector(this.view.state.viewingMode),this._intersector.options.store=_.StoreResults.MIN,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,t,r,n){const i=this._renderCoordsHelper,s=u.set(R,e,t,r);if(!i.toRenderCoords(s,n,s))return o.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:a,_intersector:l,intersectionHandler:c}=this,p=a.fullExtent,d=null!=p&&Number.isFinite(p.xmin)&&Number.isFinite(p.xmax)&&Number.isFinite(p.ymin)&&Number.isFinite(p.ymax)&&Number.isFinite(p.zmin)&&Number.isFinite(p.zmax)?new E.ElevationRange(p.zmin,p.zmax):a.elevationRange;if(null==d)return null;const v=a.elevationOffset,h=d.elevationRangeMin+v,m=d.elevationRangeMax+v,g=i.setAltitude(b,m,s),y=i.setAltitude(S,h,s);return l.reset(g,y,null),c.intersect(l,null,g,y,null,!0),l.results.min.getIntersectionPoint(s)?i.getAltitude(s):null}getSphereElevationBounds(e,t){return v.projectBoundingSphere(e,t,x,this._renderSR),this._layerElevationSource.getElevationRange(x)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new E.ElevationRange(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){h.empty(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){h.empty(t);for(const r of e)this._expandExtent(r,t)}_expandExtent(e,t){const r=this.spatialReference;if(null==r)return;if(null==e)return;c.fromQuat(f,e.quaternion),f[12]=e.center[0],f[13]=e.center[1],f[14]=e.center[2];const n=e.halfSize;for(let o=0;o<8;++o)R[0]=1&o?n[0]:-n[0],R[1]=2&o?n[1]:-n[1],R[2]=4&o?n[2]:-n[2],u.transformMat4(R,R,f),this._renderCoordsHelper.fromRenderCoords(R,R,r),h.expand(t,R,t)}},t.__decorate([i.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"layerElevationSource",void 0),t.__decorate([i.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"intersectionHandler",void 0),t.__decorate([i.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"view",void 0),t.__decorate([i.property()],e.LayerElevationProvider.prototype,"spatialReference",null),e.LayerElevationProvider=t.__decorate([l.subclass("esri.views.3d.layers.i3s.LayerElevationProvider")],e.LayerElevationProvider);const f=p.create(),x=m.fromValues(0,0,0,0),R=d.create(),b=d.create(),S=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
