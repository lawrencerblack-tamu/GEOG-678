/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../Color","../../../../core/unitUtils","../../../../chunks/earcut","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/math/common","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/DoubleArray","./ElevationAligners","./elevationAlignmentUtils","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./polygonUtils","../../support/renderInfoUtils/polygon","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/WaterMaterial","../../webgl-engine/materials/internal/waterMaterialUtils"],(function(e,t,r,o,a,n,i,s,l,c,h,d,u,p,y,g,m,b,v,x,_,D){"use strict";const f=["polyline","polygon","extent"];class C extends g.Graphics3DSymbolLayer{constructor(e,t,r,o){super(e,t,r,o)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,f,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,r,t.uid)}ensureMaterial(){if(this._materials[0])return;const e=new _.WaterMaterialParameters,r=this.symbolLayer.color;null!=r&&(e.color=t.toUnitRGBA(r));const o=this._getCombinedOpacity(r,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],o],e.transparent=o<1||this.needsDrivenTransparentPass,e.waveDirection=null!=this.symbolLayer.waveDirection?C.headingVectorFromAngle(this.symbolLayer.waveDirection):n.fromValues(0,0);const a=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,i=D.wavePresets[a];e.waveStrength=i.waveStrength,e.waveTextureRepeat=i.textureRepeat,e.waveVelocity=i.waveVelocity,e.flowStrength=i.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.draped=this.draped,this._materials[0]=new _.WaterMaterial(e),this._context.stage.add(this._materials[0])}layerOpacityChanged(){if(null==this._materials[0])return;const e=this._materials[0].parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=t<1||this.needsDrivenTransparentPass;this._materials[0].setParameters({color:[e[0],e[1],e[2],t],transparent:r})}layerElevationInfoChanged(e,t,r){const o=this._elevationContext.mode,a=u.elevationModeChangeUpdateType(C.elevationModeChangeTypes,r,o);if(a!==u.SymbolUpdateType.UPDATE)return a;const n=u.needsElevationUpdates2D(o);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,r){const o=m.geometryAsPolygon(e.geometry);if(null==o)return null;const a=b.geometryToRenderInfo(o,this._context.elevationProvider,this._context.renderCoordsHelper,t),n=a.position.length/3,i=h.newDoubleArray(2*n);this._createUVCoordsFromVertices(i,a.mapPositions,n,this._context.elevationProvider.spatialReference);const s=new P(a,i,this._context.layer.uid,e.uid);if(s.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(s),this._create3DShapeGeometries(s),this._logGeometryCreationWarnings(s.renderData,o.rings,"rings","WaterSymbol3DLayer"),0===s.outGeometries.length)return null;const l=new v.Object3D({geometries:s.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:r}),c=new y.Graphics3DObject3DGraphicLayer(this,l,s.outGeometries,null,null,d.perVertexElevationAligner,t);return c.alignedSampledElevation=s.renderData.sampledElevation,c.needsElevationUpdates=u.needsElevationUpdates2D(t.mode),c}_createUVCoordsFromVertices(e,t,o,n){const s=r.getMetersPerUnitForSR(n);c.empty(G);for(let r=0;r<o;r++)a.set(A,t[3*r],t[3*r+1]),c.expandPointInPlace(G,A);i.scale(G,G,s);const l=G[0]%C.unitSizeOfTexture,h=G[1]%C.unitSizeOfTexture;S[0]=G[0]-l,S[1]=G[1]-h;for(let r=0;r<o;r++)e[2*r]=(t[3*r]*s-S[0])/C.unitSizeOfTexture,e[2*r+1]=(t[3*r+1]*s-S[1])/C.unitSizeOfTexture}_create3DShapeGeometries(e){const t=e.renderData.polygons,r=e.uvCoords;for(const{count:a,index:n,position:i,mapPositions:s,holeIndices:c}of t){if(null!=this._context.clippingExtent&&(l.empty(w),l.expandWithBuffer(w,s),!l.intersectsClippingArea(w,this._context.clippingExtent)))continue;const t=o.earcut(s,c,3);if(0===t.length)continue;const d=h.doubleSubArray(r,2*n,2*a),u=m.createWaterGeometry({material:this._materials[0],indices:t,mapPositions:s,attributeData:{position:i,uv0:d}},e.objectAndLayerIdColor);e.outGeometries.push(u)}}_createAsOverlay(e){const t=m.geometryAsPolygon(e.geometry);if(null==t)return null;this._materials[0].renderPriority=this._renderPriority;const r=b.geometryToRenderInfoDraped(t,this._context.overlaySR),o=r.position.length/3,a=h.newDoubleArray(2*o);this._createUVCoordsFromVertices(a,r.position,o,this._context.overlaySR);const n=new E(r,a,this._context.layer.uid,e.uid);return n.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(n),n.outBoundingBox=l.empty(),this._createAsOverlayWater(n),this._logGeometryCreationWarnings(n.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===n.outGeometries.length?null:new p.Graphics3DDrapedGraphicLayer(this,n.outGeometries,n.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){const t=e.uvCoords,r=e.renderData.polygons;for(const{position:a,holeIndices:n,index:i,count:s}of r){if(l.empty(w),l.expandWithBuffer(w,a),!l.intersectsClippingArea(w,this._context.clippingExtent))continue;l.expandWithAABB(e.outBoundingBox,w);const r=o.earcut(a,n,3);if(0===r.length)continue;const c=h.doubleSubArray(t,2*i,2*s),d=m.createWaterGeometry({material:this._materials[0],indices:r,attributeData:{position:a,uv0:c}},e.objectAndLayerIdColor);e.outGeometries.push(new x.RenderGeometry(d,e))}}static headingVectorFromAngle(e){const t=n.create(),r=s.toRadian(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t}test(){return{...super.test(),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}C.unitSizeOfTexture=100,C.elevationModeChangeTypes={definedChanged:u.SymbolUpdateType.RECREATE,staysOnTheGround:u.SymbolUpdateType.NONE,onTheGroundChanged:u.SymbolUpdateType.RECREATE};const S=n.create(),G=c.create(),A=n.create(),w=l.create();class P extends m.PolygonCreationDataBase{constructor(e,t,r,o){super(e,r,o),this.uvCoords=t}}class E extends m.PolygonCreationDataBase{constructor(e,t,r,o){super(e,r,o),this.uvCoords=t}}e.Graphics3DWaterSymbolLayer=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
