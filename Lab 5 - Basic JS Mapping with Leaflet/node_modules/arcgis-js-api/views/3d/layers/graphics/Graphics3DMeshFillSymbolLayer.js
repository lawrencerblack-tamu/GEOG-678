/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../Color","../../../../core/has","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/projection","../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../geometry/projection/projectBuffer","../../../../geometry/projection/projectVectorToPoint","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/FloatArray","../../../../geometry/support/Indices","../../../../geometry/support/MeshComponent","../../../../geometry/support/MeshMaterialMetallicRoughness","../../../../geometry/support/MeshTextureTransform","../../../../geometry/support/meshVertexSpaceUtils","../../../../geometry/support/spatialReferenceUtils","../../../../chunks/vec3","../../../../geometry/support/meshUtils/georeference","../../../../geometry/support/meshUtils/projection","../../../../layers/graphics/dehydratedPoint","../../../../layers/graphics/sources/interfaces","../../../ViewingMode","../../glTF/internal/resourceUtils","../../glTF/internal/TextureTransformUtils","./ElevationAligners","./elevationAlignmentUtils","./Graphics3DMeshObject3DGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./MeshFastUpdateProcessor","../support/edgeUtils","../support/symbolColorUtils","../../support/debugFlags","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/ContentObjectType","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Texture","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/NativeLineMaterial","../../webgl-engine/materials/pbrUtils","../../../webgl/enums"],(function(e,t,r,a,o,n,s,i,l,c,u,m,h,p,f,d,g,x,T,_,b,y,v,M,C,A,O,w,R,P,E,N,I,S,F,U,B,j,D,V,L,G,$,H,k,W,q,z,Y,Z,J,K){"use strict";const Q=["mesh"];class X extends B.Graphics3DSymbolLayer{constructor(e,t,r,a){super(e,t,r,a),this._materialInfoCache=new j.MaterialInfoCache,this._fastUpdateProcessor=new j.MeshFastUpdateProcessor,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){L.debugFlags.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new Z.NativeLineMaterial({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new Z.NativeLineMaterial({color:[0,1,1,1]}))}destroy(){super.destroy(),this._textures.forEach((e=>e.unload())),this._context.stage.removeMany(this._materialInfoCache.materials),this._context.stage.removeMany(Array.from(this._textures.values())),this._materialInfoCache.clear(),this._textures.clear(),this._fastUpdateProcessor.destroy(this._context.stage)}get materials(){return this._materialInfoCache.materials}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Q,"fill on mesh-3d"))return null;const r=this.setGraphicElevationContext(t),a=e.renderingInfo;return this._createAs3DShape(t,a,r,t.uid)}onRemoveGraphic(e){this._fastUpdateProcessor.onRemoveGraphic(e,this._materialInfoCache,this._context)}layerOpacityChanged(e,t){const r=this._getLayerOpacity();this._updateMaterialParameters((e=>{e.material.setParameters({layerOpacity:r});const t=e.material.parameters;this._setMaterialTransparentParameter(t,e),e.material.setParameters({transparent:t.transparent})})),e.forEach((e=>t(e)?.layerOpacityChanged(r,this._context.isAsync)))}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,S.needsElevationUpdates3D)}slicePlaneEnabledChanged(e,t){return this._updateMaterialParameters((({material:e})=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),e.forEach((e=>t(e)?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync))),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._updateMaterialParameters((({material:t})=>t.setParameters({usePBR:e}))),!0}updateTransform(e,t,r,a){const o=e.fastTransformUpdatesEnabled;switch(a){case R.MeshTransformUpdateAction.EnableFastUpdates:if(o)return!0;break;case R.MeshTransformUpdateAction.DisableFastUpdates:if(!o)return!0;break;default:if(!o)return!1}const n=this._context.renderCoordsHelper.spatialReference,s=le,{origin:i,transform:l}=r;if(!p.computeTranslationToOriginAndRotation(t,c.set(re,i.x,i.y,i.z??0),s,n))return!1;switch(a){case R.MeshTransformUpdateAction.EnableFastUpdates:this._fastUpdateProcessor.enable(e,this._materialInfoCache,this._context);break;case R.MeshTransformUpdateAction.DisableFastUpdates:this._fastUpdateProcessor.disable(e,this._materialInfoCache,this._context);break;case R.MeshTransformUpdateAction.UpdateFastLocalOrigin:e.updateFastLocalOrigin(s,l,this._context.localOriginFactory)}const{elevationContext:u}=e;u.centerPointInElevationSR=this._getCenterPointInElevationSR(s);const{elevationProvider:m,renderCoordsHelper:h}=this._context,f=(e,t)=>S.evaluateElevationInfoAtPoint(e,m,u,h,t);return e.alignedSampledElevation=I.perObjectElevationAligner(e,u,m.spatialReference,f,h,s),e.updateTransform(s,l,this._context.isAsync),!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return null==e?"-":e instanceof t?e.toHex():e.contentHash}_materialPropertiesDefault(e,t){const r=this._requiresSymbolVertexColors(),a=!!e.vertexAttributes.color,o=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:r,hasVertexColors:a,hasVertexTangents:o,uid:`vc:${a},vt:${o},vct${t},svc:${r}`}}_textureTransformUid(e){const{offset:t,scale:r,rotation:a}=e??me;return`${t[0]},${t[1]},${a},${r[0]},${r[1]}`}_materialProperties(e,t,r){const a=this._materialPropertiesDefault(e,r);if(!t.material)return a;const{color:o,colorTexture:n,colorTextureTransform:s,normalTexture:i,normalTextureTransform:l,doubleSided:c,alphaCutoff:u,alphaMode:m}=t.material,h=this._colorOrTextureUid(o),p=this._colorOrTextureUid(n),f=this._textureTransformUid(s),d=this._colorOrTextureUid(i),g=this._textureTransformUid(l);if(a.color=o,a.colorTexture=n,a.normalTexture=i,a.uid=`${a.uid},cmuid:${h},ctmuid:${p},cttuid:${f},ntmuid:${d},nttuid:${g},ds:${c},ac:${u},am:${m}`,t.material instanceof b){const{metallic:e,roughness:r,metallicRoughnessTexture:o,metallicRoughnessTextureTransform:n,emissiveColor:i,emissiveTexture:c,emissiveTextureTransform:u,occlusionTexture:m,occlusionTextureTransform:h}=t.material,p=this._colorOrTextureUid(o),f=this._textureTransformUid(n),d=this._colorOrTextureUid(i),g=this._colorOrTextureUid(c),x=this._textureTransformUid(u),T=this._colorOrTextureUid(m),_=this._textureTransformUid(h);a.metallic=e,a.roughness=r,a.metallicRoughnessTexture=o,a.emissiveColor=i,a.emissiveTexture=c,a.occlusionTexture=m,a.colorTextureTransform=this._convertTextureTransform(s),a.normalTextureTransform=this._convertTextureTransform(l),a.emissiveTextureTransform=this._convertTextureTransform(u),a.occlusionTextureTransform=this._convertTextureTransform(h),a.metallicRoughnessTextureTransform=this._convertTextureTransform(n),a.uid=`${a.uid},mrm:${e},mrr:${r},mrt:${p},mrtt:${f},emuid:${d},etmuid:${g},ett:${x},otmuid:${T},ott:${_}`}return a}_convertTextureTransform(e){if(!e)return null;const{scale:t,offset:r,rotation:o}=e;return{scale:t,offset:r,rotation:a.deg2rad(o)}}_setInternalColorValueParameters(e,r){r.diffuse=t.toUnitRGB(e),r.opacity=e.a}_getLoadableTextureResource(e){return e.data??e.url}_getInternalTextureId(e){const t=this._getInternalTexture(e,$.AlphaDiscardMode.Opaque);return t?.id}_getInternalTexture(e,t){const r=this._getLoadableTextureResource(e);if(!r)return null;const a=`${e.contentHash}/${t}`;let o=this._textures.get(a);if(!o){let n=null;const s=this._context.stage.renderView.renderingContext.parameters.maxMaxAnisotropy,i={wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,maxAnisotropy:s,mipmap:s>1};E.isEncodedMeshTexture(r)?(n=r.data,i.preMultiplyAlpha=!1,i.encoding=r.encoding):(n=r,i.preMultiplyAlpha=t!==$.AlphaDiscardMode.Opaque,i.downsampleUncompressed=this._context.graphicsCoreOwner.view.qualitySettings.graphics3D.uncompressedTextureDownsamplingEnabled),o=new q.Texture(n,i),this._textures.set(a,o),o.load(this._context.stage.renderView.renderingContext),this._context.stage.add(o)}return o}_castTextureWrap(e="repeat"){if("string"==typeof e){const t=this._castTextureWrapIndividual(e);return{s:t,t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return K.TextureWrapMode.CLAMP_TO_EDGE;case"mirror":return K.TextureWrapMode.MIRRORED_REPEAT;default:return K.TextureWrapMode.REPEAT}}_setInternalMaterialParameters(e,r){if(null!=e.color&&this._setInternalColorValueParameters(e.color,r),null!=e.colorTexture){const t=this._getInternalTexture(e.colorTexture,r.textureAlphaMode);t?(r.textureId=t.id,r.textureAlphaPremultiplied=!!t.parameters.preMultiplyAlpha):r.textureId=void 0}e.normalTexture&&(r.normalTextureId=this._getInternalTextureId(e.normalTexture)),e.emissiveColor&&(r.emissiveFactor=t.toUnitRGB(e.emissiveColor)),e.emissiveTexture&&(r.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),e.occlusionTexture&&(r.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),e.metallicRoughnessTexture&&(r.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture)),r.colorTextureTransformMatrix=N.getTransformMatrix(e.colorTextureTransform),r.normalTextureTransformMatrix=N.getTransformMatrix(e.normalTextureTransform);const a=null!=e.normalTextureTransform?.scale?e.normalTextureTransform?.scale:l.ONES;r.scale=[a[0],a[1]],r.occlusionTextureTransformMatrix=N.getTransformMatrix(e.occlusionTextureTransform),r.emissiveTextureTransformMatrix=N.getTransformMatrix(e.emissiveTextureTransform),r.metallicRoughnessTextureTransformMatrix=N.getTransformMatrix(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(e){const r=this._drivenProperties.color;let a=this.symbolLayer.material?.colorMixMode??null;if(r)e.externalColor=m.ONES;else{const r=this.symbolLayer.material?.color??null;r?e.externalColor=t.toUnitRGBA(r):(a=null,e.externalColor=m.ONES)}a&&(e.colorMixMode=a),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const t=e.vertexAttributes.color;if(null==t)return!1;for(let r=3;r<t.length;r+=4)if(255!==t[r])return!0;return!1}_getOrCreateMaterial(e,r){const a=r.material?.color,o=r.material?.colorTexture,n=r.material?.alphaMode,s="blend"===n,i=!("opaque"===n)&&(this._hasTransparentVertexColors(e)||null!=a&&a.a<1||o?.transparent||s),l=this._materialProperties(e,r,i),c=this._materialInfoCache.byUid(l.uid);if(c)return c.material;const m={uid:l.uid,material:null,isComponentTransparent:i,alphaMode:r.material?r.material.alphaMode:"opaque"},h=J.useSchematicPBR({normalTexture:l.normalTexture,metallicRoughnessTexture:l.metallicRoughnessTexture,metallicFactor:l.metallic,roughnessFactor:l.roughness,emissiveTexture:l.emissiveTexture,emissiveFactor:t.toUnitRGB(l.emissiveColor),occlusionTexture:l.occlusionTexture}),p={usePBR:this._usePBR(),isSchematic:h,hasVertexColors:l.hasVertexColors,hasSymbolColors:l.hasSymbolVertexColors,hasVertexTangents:l.hasVertexTangents,ambient:u.ZEROS,diffuse:u.ONES,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:$.CullFaceOptions.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};p.mrrFactors=h?[...J.defaultSchematicMRRFactors]:[l.metallic,l.roughness,J.defaultAdvancedMRRFactors[2]],r.material&&(p.doubleSided=r.material.doubleSided,p.cullFace=r.material.doubleSided?$.CullFaceOptions.None:$.CullFaceOptions.Back,p.textureAlphaCutoff=r.material.alphaCutoff),this._setExternalMaterialParameters(p),this._setMaterialTransparentParameter(p,m),this._setInternalMaterialParameters(l,p);const f=new Y.DefaultMaterial(p);return m.material=f,this._materialInfoCache.set(l.uid,m),this._context.stage.add(f),f}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?$.AlphaDiscardMode.MaskBlend:$.AlphaDiscardMode.Opaque:e.textureAlphaMode="opaque"===t.alphaMode?$.AlphaDiscardMode.Opaque:"mask"===t.alphaMode?$.AlphaDiscardMode.Mask:$.AlphaDiscardMode.Blend}_addDebugNormals(e,t){const r=t.length,a=e.spatialReference.isGeographic?20015077/180:1,o=.1*Math.max(e.extent.width*a,e.extent.height*a,e.extent.zmax-e.extent.zmin),n=[],s=[],i=[],l=[];for(let p=0;p<r;p++){const e=t[p],r=e.attributes.get(z.VertexAttribute.POSITION),a=e.attributes.get(z.VertexAttribute.NORMAL),u=r.data,m=r.indices,h=a.data,f=a.indices;for(let t=0;t<m.length;t++){const e=3*m[t],r=3*f[t];for(let t=0;t<3;t++)n.push(u[e+t]);for(let t=0;t<3;t++)n.push(u[e+t]+h[r+t]*o);if(s.push(s.length),s.push(s.length),t%3==0){this._calculateFaceNormal(u,m,t,ne),this._getFaceVertices(u,m,t,re,ae,oe),c.add(re,re,ae),c.add(re,re,oe),c.scale(re,re,1/3);for(let e=0;e<3;e++)i.push(re[e]);for(let e=0;e<3;e++)i.push(re[e]+ne[e]*o);l.push(l.length),l.push(l.length)}}}const u=t[0].transformation,m=new k.Geometry(this._debugVertexNormalMaterial,[[z.VertexAttribute.POSITION,new G.Attribute(n,s,3,!0)]],null,H.ContentObjectType.Line);t.push(m),m.transformation=u;const h=new k.Geometry(this._debugFaceNormalMaterial,[[z.VertexAttribute.POSITION,new G.Attribute(i,l,3,!0)]],null,H.ContentObjectType.Line);h.transformation=u,t.push(h)}_createAs3DShape(e,t,r,a){const o=e.geometry;if("mesh"!==o.type)return null;const n=this._createGeometryInfo(o,t,a);if(null==n)return null;const{geometries:s,objectTransformation:i}=n;L.debugFlags.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(o,s);const l=new W.Object3D({geometries:s,layerUid:this._context.layer.uid,graphicUid:a,isElevationSource:!0});l.transformation=i;const c=D.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()}),u=c?new U.Object3DEdgeState(s[0].material,[c],{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}):null,m=new F.Graphics3DMeshObject3DGraphicLayer(this,l,s,null,null,I.perObjectElevationAligner,r,u);this._fastUpdateProcessor.onAddGraphic(),m.needsElevationUpdates=S.needsElevationUpdates3D(r.mode),m.useObjectOriginAsAttachmentOrigin=!0,r.centerPointInElevationSR=this._getCenterPointInElevationSR(l.transformation);const{elevationProvider:h,renderCoordsHelper:p}=this._context,f=(e,t)=>S.evaluateElevationInfoAtPoint(e,h,r,p,t);return m.alignedSampledElevation=I.perObjectElevationAligner(m,r,h.spatialReference,f,p),m}_getCenterPointInElevationSR(e){const t=w.makeDehydratedPoint(0,0,0,null!=this._context.elevationProvider.spatialReference?this._context.elevationProvider.spatialReference:null);return d.projectVectorToPoint([e[12],e[13],e[14]],this._context.renderCoordsHelper.spatialReference,t),t}_createComponentNormals(e,t,r,a){switch(r.shading||"flat"){default:case"source":return this._createComponentNormalsSource(e,t,r,a);case"flat":return this._createComponentNormalsFlat(e,a);case"smooth":return this._createComponentNormalsSmooth(e,a)}}_createComponentNormalsSource(e,t,r,a){if(null==t)return this._createComponentNormalsFlat(e,a);let o=!1;if(!r.trustSourceNormals)for(let n=0;n<a.length;n+=3){this._calculateFaceNormal(e,a,n,ne);for(let e=0;e<3;e++){const r=3*a[n+e];re[0]=t[r],re[1]=t[r+1],re[2]=t[r+2],c.dot(ne,re)<0&&(t[r]=-t[r],t[r+1]=-t[r+1],t[r+2]=-t[r+2],o=!0)}}return new ee(t,a,o)}_createComponentNormalsFlat(e,t){const r=x.newFloatArray(t.length),a=new Array(3*t.length);for(let o=0;o<t.length;o+=3){const n=this._calculateFaceNormal(e,t,o,ne);for(let e=0;e<3;e++)r[o+e]=n[e],a[o+e]=o/3}return new ee(r,a,!1)}_createComponentNormalsSmooth(e,t){const r={};for(let n=0;n<t.length;n+=3){const a=this._calculateFaceNormal(e,t,n,ne);for(let e=0;e<3;e++){const o=t[n+e];let s=r[o];s||(s={normal:u.create(),count:0},r[o]=s),c.add(s.normal,s.normal,a),s.count++}}const a=x.newFloatArray(3*t.length),o=new Array(3*t.length);for(let n=0;n<t.length;n++){const e=r[t[n]];1!==e.count&&(c.normalize(e.normal,e.normal),e.count=1);for(let t=0;t<3;t++)a[3*n+t]=e.normal[t];o[n]=n}return new ee(a,o,!1)}_getFaceVertices(e,t,r,a,o,n){const s=3*t[r],i=3*t[r+1],l=3*t[r+2];a[0]=e[s],a[1]=e[s+1],a[2]=e[s+2],o[0]=e[i],o[1]=e[i+1],o[2]=e[i+2],n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2]}_calculateFaceNormal(e,t,r,a){return this._getFaceVertices(e,t,r,re,ae,oe),c.subtract(ae,ae,re),c.subtract(oe,oe,re),c.cross(re,ae,oe),c.normalize(a,re),a}_getOrCreateComponents(e){return e.components??ue}_createPositionBuffer(e,t){let r=e.vertexAttributes.position;const a=t.reprojection===he.RENDER?t.transformBeforeProject:null;if(a&&(r=C.transformMat4(new Float64Array(r.length),r,a)),t.reprojection===he.NONE)return t.needsBufferCopy?new Float64Array(r):r;const o=a?r:new Float64Array(r.length);return f.projectBuffer(r,e.spatialReference,0,o,this._context.renderCoordsHelper.spatialReference,0,r.length/3),o}_createNormalBuffer(e,t,r){let a=e.vertexAttributes.normal;if(null==a)return null;const o=r.reprojection===he.RENDER?r.transformBeforeProject:null;o&&(a=O.transformNormal(a,new Float32Array(a.length),o));if("local"===this._context.graphicsCoreOwner.view.viewingMode||r.reprojection===he.NONE)return r.needsBufferCopy&&e.vertexAttributes.normal===a?new Float32Array(a):a;const n=e.vertexAttributes.position,s=o?a:new Float32Array(a.length);return O.projectNormalToPCPF(a,n,t,e.spatialReference,s)}_createTangentBuffer(e,t,r){let a=e.vertexAttributes.tangent;if(null==a)return null;const o=r.reprojection===he.RENDER?r.transformBeforeProject:null;o&&(a=O.transformTangent(a,new Float32Array(a.length),o));if("local"===this._context.graphicsCoreOwner.view.viewingMode||r.reprojection===he.NONE)return r.needsBufferCopy&&e.vertexAttributes.normal===a?new Float32Array(a):a;const n=e.vertexAttributes.position,s=o?a:new Float32Array(a.length);return O.projectTangentToPCPF(a,n,t,e.spatialReference,s)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const t=this._getVertexOpacityAndColor(e),r=V.parseColorMixMode(this.symbolLayer?.material?.colorMixMode),a=new Uint8Array(4);return V.encodeSymbolColor(t,r,a),a}return null}_createBuffers(e,t){const r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const a=e.vertexAttributes.normal,o=e.vertexAttributes.uv,n=e.vertexAttributes.tangent;if(a&&a.length!==r.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(n&&n.length/4!=r.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(o&&o.length/2!=r.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const s=this._computeReprojectionInfo(e),l=this._createPositionBuffer(e,s),c=this._createColorBuffer(e),u=this._createSymbolColorBuffer(t),m=this._createNormalBuffer(e,l,s),h=this._createTangentBuffer(e,l,s);return{positionBuffer:l,normalBuffer:m,tangentBuffer:h,uvBuffer:o,colorBuffer:c,symbolColorBuffer:u,objectTransformation:s.reprojection===he.NONE&&s.objectTransformation?s.objectTransformation:this._transformOriginLocal(e,l,m,h),geometryTransformation:s.reprojection===he.NONE&&s.geometryTransformation?s.geometryTransformation:i.create()}}_computeReprojectionInfo(e){const{vertexSpace:t}=e,r="georeferenced"===t.type?M.equals(this._context.renderCoordsHelper.spatialReference,e.spatialReference)?he.NONE:he.RENDER:he.NONE;if(v.isRelativeVertexSpace(t)){const a=t.origin,o=i.create(),n=e.transform?.localMatrix??i.IDENTITY;if(r===he.NONE){p.computeTranslationToOriginAndRotation(e.spatialReference,a,o,this._context.renderCoordsHelper.spatialReference);return{reprojection:r,objectTransformation:o,geometryTransformation:i.clone(n),needsBufferCopy:!1}}const l=s.fromTranslation(i.create(),a);return s.multiply(l,l,n),{reprojection:r,transformBeforeProject:l,needsBufferCopy:!0}}return{reprojection:r,needsBufferCopy:!0}}_transformOriginLocal(e,t,r,a){const n=this._context.renderCoordsHelper.spatialReference,l=e.anchor;te[0]=l.x,te[1]=l.y,te[2]=l.z??0;const c=i.create();return p.computeTranslationToOriginAndRotation(e.spatialReference,te,c,n),s.invert(se,c),C.transformMat4(t,t,se),(r||a)&&(o.fromMat4(ie,c),o.transpose(ie,ie),r&&C.transformMat3(r,r,ie),a&&C.transformMat3(a,a,ie,4)),c}_validateFaces(e,t){const r=e.vertexAttributes.position.length/3,a=t.faces;if(a){let e=-1;for(let t=0;t<a.length;t++){const r=a[t];r>e&&(e=r)}if(r<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(r%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,t){return t.faces??T.getContinuousIndexArray(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const t=e.vertexAttributes?.position;if(!t)return!1;const r=this._context.elevationProvider.spatialReference,a=A.project({positions:t,transform:e.transform,vertexSpace:e.vertexSpace,inSpatialReference:e.spatialReference,outSpatialReference:r??e.spatialReference,localMode:this._context.stage.viewingMode===P.ViewingMode.Local}),o=a.length/3;return g.empty(ce),g.expandWithBuffer(ce,a,0,o),!g.intersectsClippingArea(ce,this._context.clippingExtent)}_createGeometryInfo(e,t,r){if(!h.canProjectWithoutEngine(e.spatialReference,this._context.renderCoordsHelper.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(!this._validateVertexSpace(e))return null;if(this._isOutsideClippingArea(e))return null;const a=this._createBuffers(e,t);if(null==a)return null;const{positionBuffer:o,uvBuffer:n,colorBuffer:i,symbolColorBuffer:l,normalBuffer:c,tangentBuffer:u,objectTransformation:m,geometryTransformation:p}=a,f=this._getOrCreateComponents(e),d=new Array;let g=!1;const x=s.getTranslation(re,m),_=this._context.localOriginFactory.getOrigin(x);for(const s of f){if(!this._validateFaces(e,s))return null;const t=this._getOrCreateFaces(e,s);if(0===t.length)continue;const a=this._createComponentNormals(o,c,s,t);a.didFlipNormals&&(g=!0);const m=[[z.VertexAttribute.POSITION,new G.Attribute(o,t,3,!0)],[z.VertexAttribute.NORMAL,new G.Attribute(a.normals,a.indices,3,!0)]];i&&m.push([z.VertexAttribute.COLOR,new G.Attribute(i,t,4,!0)]),l&&m.push([z.VertexAttribute.SYMBOLCOLOR,new G.Attribute(l,T.getZeroIndexArray(t.length),4,!0)]),n&&m.push([z.VertexAttribute.UV0,new G.Attribute(n,t,2,!0)]),u&&m.push([z.VertexAttribute.TANGENT,new G.Attribute(u,t,4,!0)]);const h=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerUid:this._context.layer.uid}),f=this._getOrCreateMaterial(e,s),x=new k.Geometry(f,m,null,H.ContentObjectType.Mesh,h);x.transformation=p,x.localOrigin=_,d.push(x)}return g&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:d,objectTransformation:m}}_updateMaterialParameters(e){this._materialInfoCache.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachClonedMaterial(((e,t)=>{t.setParameters(e.parameters)}))}_validateVertexSpace(e){const{_context:{graphicsCoreOwner:{view:{state:{viewingMode:t}}}}}=this,{vertexSpace:r}=e;return t!==P.ViewingMode.Local||"local"!==r.type||(this.logger.warn("Displaying a mesh with a local vertex space in a view in local viewing mode is not supported."),!1)}test(){return{...super.test(),materials:this._materialInfoCache.materials}}}class ee{constructor(e,t,r){this.normals=e,this.indices=t,this.didFlipNormals=r}}const te=u.create(),re=u.create(),ae=u.create(),oe=u.create(),ne=u.create(),se=i.create(),ie=n.create(),le=i.create(),ce=g.create(),ue=[new _],me=new y;var he;!function(e){e[e.NONE=0]="NONE",e[e.RENDER=1]="RENDER"}(he||(he={})),e.Graphics3DMeshFillSymbolLayer=X,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
