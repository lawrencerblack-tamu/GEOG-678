/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../geometry","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectPointToVector","../../../../layers/graphics/dehydratedPoint","../../../../support/elevationInfoUtils","./elevationAlignmentUtils","./ElevationContext","./featureExpressionInfoUtils","../../../../geometry/SpatialReference"],(function(e,t,o,n,r,i,a,s,c,l,f){"use strict";async function p(e,t,p,d,v){const{elevationProvider:u,renderCoordsHelper:I}=e,{elevationInfo:g}=t,{pointsInFeatures:y,spatialReference:m}=d,x=f.fromJSON(m),E=!0,P=l.extractExpressionInfo(g,E),h=await l.createContext(P,x,v);o.throwIfAborted(v);const S=[],b=new Set,j=new Set,w=new c.ElevationContext,A=i.makeDehydratedPoint(0,0,0,f.WGS84),C=new s.SampleElevationInfo,R=n.create();A.spatialReference=x;const z=e.elevationProvider.spatialReference??e.spatialReference;for(const{objectId:o,points:n}of y){const e=p(o);if(null==e){for(const e of n)S.push(e.z??0);b.add(o);continue}e.isDraped&&j.add(o);const i=e.graphic.geometry;w.setFromElevationInfo(a.getGeometryEffectiveElevationInfo(i,g)),w.updateFeatureExpressionInfoContext(h,e.graphic,t);for(const{x:t,y:o,z:a}of n)A.x=t,A.y=o,A.z=a??0,await r.projectPointToVectorAsync(A,R,z,0,{signal:v}),s.evaluateElevationInfoAtPoint(R,u,w,I,C),S.push(C.z)}return{elevations:S,drapedObjectIds:j,failedObjectIds:b}}e.elevationAlignPointsInFeatures=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
