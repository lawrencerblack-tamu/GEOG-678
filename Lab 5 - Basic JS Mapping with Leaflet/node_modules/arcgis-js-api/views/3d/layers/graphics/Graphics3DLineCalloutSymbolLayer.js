/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../Color","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DGraphicCreationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DObjectMetadata","./Graphics3DSymbolLayer","./graphicUtils","./pointUtils","./SymbolComplexity","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/ContentObjectType","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/LineCalloutMaterial"],(function(e,t,a,r,n,i,l,o,s,c,d,h,u,p,m,y,b,f,g,C,v){"use strict";class x extends u.Graphics3DSymbolLayer{constructor(e,t){super(e,null,t,E),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new v.LineCalloutMaterial(this._materialParameters),this._context.stage.add(this._materials[0])}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const e=new v.Parameters,r=this.symbol,n=r.callout;if(e.color=null!=n.color?t.toUnitRGBA(n.color):[0,0,0,0],e.color[3]*=this._getLayerOpacity(),e.size=a.pt2px(n.size||0),r.verticalOffset){const{screenLength:t,minWorldLength:n,maxWorldLength:i}=r.verticalOffset;e.verticalOffset={screenLength:a.pt2px(t),minWorldLength:n||0,maxWorldLength:null!=i?i:1/0}}e.borderColor=null!=n.border?.color?t.toUnitRGBA(n.border.color):null;const i="object"===r.symbolLayers.at(0).type,l="label-3d"===r.type;return e.occlusionTest=!i,e.shaderPolygonOffset=i?0:void 0,e.depthHUDAlignStart=l,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return _}createGraphics3DGraphic(e){const t=e.renderingInfo,a=e.graphic,r=this.setGraphicElevationContext(a,new s.ElevationContext,t.elevationOffset||0),n=t.symbol,l="on-the-ground"===this._elevationContext.mode&&("cim"===n.type||!n.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==n.type&&l)return null;if("point-3d"===n.type&&n.symbolLayers.every((e=>"text"===e.type&&!i.textSymbolLayerSupportsVerticalOffset(e))))return null;const o=p.computeCentroid(a.geometry);return null==o?null:this._createAs3DShape(o,r,t,a.uid)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,a){const r=this._elevationContext.mode,n=o.elevationModeChangeUpdateType(x.elevationModeChangeTypes,a,r);return n!==o.SymbolUpdateType.UPDATE||e.forEach((e=>{const a=t(e);null!=a&&this.updateGraphicElevationContext(e.graphic,a)})),n}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t,a=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(a),t}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,null!=t.metadata?t.metadata.elevationOffset:0),t.needsElevationUpdates=o.needsElevationUpdates2D(t.elevationContext.mode)}computeComplexity(){return new y.SymbolComplexity({verticesPerFeature:6})}_createVertexData(e){const{translation:t,centerOffset:a}=e,r=t?new b.Attribute([t[0],t[1],t[2]],O,3,!0):new b.Attribute([0,0,0],O,3,!0),n=a?new b.Attribute([a[0],a[1],a[2],a[3]],O,4,!0):new b.Attribute([0,0,0,1],O,4,!0);return[[C.VertexAttribute.POSITION,r],[C.VertexAttribute.NORMAL,new b.Attribute([0,0,1],O,3,!0)],[C.VertexAttribute.CENTEROFFSETANDDISTANCE,n]]}_getOrCreateMaterial(e){const t=this._perInstanceMaterialParameters(e),a=v.LineCalloutMaterial.uniqueMaterialIdentifier(t);if(a===this._materials[0]?.uniqueMaterialIdentifier)return{material:this._materials[0],isUnique:!1};if(null!=e.materialCollection){let r=e.materialCollection.get(a);return null==r&&(r=new v.LineCalloutMaterial(t),e.materialCollection.add(a,r)),{material:r,isUnique:!1}}return{material:new v.LineCalloutMaterial(t),isUnique:!0}}_createAs3DShape(e,t,a,r){const n=this._context.layer.uid,i=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerUid:n}),s=this._getOrCreateMaterial(a),c=new g.Geometry(s.material,this._createVertexData(a),null,f.ContentObjectType.Point,i),u=m.createStageObject(this._context,e,c,t,r);if(null==u)return null;const p=new d.Graphics3DObject3DGraphicLayer(this,u.object,[c],s.isUnique?[s.material]:null,null,l.perObjectElevationAligner,t);return p.metadata=new h.Graphics3DObjectMetadata(a.elevationOffset),p.alignedSampledElevation=u.sampledElevation,p.needsElevationUpdates=o.needsElevationUpdates2D(t.mode),m.extendPointGraphicElevationContext(p,e,this._context.elevationProvider),p}}x.elevationModeChangeTypes={definedChanged:o.SymbolUpdateType.UPDATE,staysOnTheGround:o.SymbolUpdateType.UPDATE,onTheGroundChanged:o.SymbolUpdateType.RECREATE};const O=[0],_={mode:"relative-to-ground",offset:0},E={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class S{constructor(e,t,a=r.create(),i=n.create(),l=0,o="world",s=0,c=null){this.renderer=e,this.symbol=t,this.translation=a,this.centerOffset=i,this.horizontalScreenOffset=l,this.centerOffsetUnits=o,this.elevationOffset=s,this.materialCollection=c}}class U extends c.Graphics3DGraphicCreationContext{}e.Graphics3DLineCalloutSymbolLayer=x,e.LineCalloutCreationContext=U,e.LineCalloutSymbolLayerRenderingInfo=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
