/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/mathUtils","../../../../core/PooledArray","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/ellipsoidUtils","../../../../geometry/support/aaBoundingRect","../../../../chunks/boundedPlane","../../../../geometry/support/ray","../../../../chunks/sphere","./deconflictorDebug","./enums","../../webgl-engine/lib/Camera","../../webgl-engine/lib/screenSizePerspectiveUtils","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/HUDMaterial","../../webgl-engine/materials/ScaleInfo"],(function(i,t,e,s,r,a,c,o,n,l,h,u,p,d,_,f,b,g,v,y,m,S,G,D,w,B,N,C,I){"use strict";const P=_.create(),V=b.create(),A=b.create(),x=_.create(),O=u.create(),M=S.create(),E=m.create(),F=_.create(),T=v.create();class z{constructor(){this.aabr=v.create(),this.distance=0,this.culled=!1,this.visible=!1}}class R{constructor(i,t){this.graphics3DGraphic=i,this.slicePlaneEnabled=t,this.info={}}}var L;i.State=void 0,(L=i.State||(i.State={}))[L.Idle=0]="Idle",L[L.Process=1]="Process",L[L.Sort=2]="Sort",L[L.Deconflict=3]="Deconflict",L[L.NumStates=4]="NumStates";class X{constructor(){this.camera=new w.Camera,this.slicePlane=y.create(),this.slicePlaneEnabled=!1}copyFrom(i){this.camera.copyFrom(i.camera),y.copy(i.slicePlane,this.slicePlane),this.slicePlaneEnabled=i.slicePlaneEnabled}}function Y(i,t){const e=i.graphics3DGraphic;e.destroyed||e.setVisibilityFlag(t,D.VisibilityFlag.DECONFLICTION,!0)}function*j(i){if(Map.prototype.entries){const t=i.entries();for(let i=t.next();!i.done;i=t.next())yield i.value[1]}else yield*i.values()}function*W(i,t,e){t.clear(),i.forEach(((i,s)=>{const r=t.pushNew();r.id=s,r.visible=i.graphics3DGraphic.getVisibilityFlag(e,D.VisibilityFlag.DECONFLICTION);const a=i.info?.[e];r.prio=i.graphics3DGraphic.deconflictionPriority,r.distance=a?a.distance:Number.MAX_VALUE})),yield;const s=t.iterableSort(((i,t)=>i.prio!==t.prio?t.prio-i.prio:i.distance!==t.distance?i.distance-t.distance:i.visible!==t.visible?i.visible?-1:1:i.id-t.id));for(let r=s.next();!r.done;r=s.next())yield;t.forAll((t=>{const e=i.get(t.id);e&&(i.delete(t.id),i.set(t.id,e))})),t.clear()}i.Deconflictor=class extends e{get dirty(){return this._dirty}get state(){return this._state}constructor(t){super(t),this._dirty=!1,this._viewState=new X,this._state=i.State.Idle,this._active=new Map,this._visible=new Map,this._iterators=new H,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==i.State.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const t=this._state/i.State.NumStates;return this._dirty?.5*t:t}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(t){switch(this._state){case i.State.Idle:this._startUpdate(),t.madeProgress();case i.State.Process:if(this._state=i.State.Process,!this._processActiveGraphics(t))return;case i.State.Sort:if(this._state=i.State.Sort,!this._sortVisibleGraphics(t))return;case i.State.Deconflict:if(this._state=i.State.Deconflict,!this._deconflictVisibleGraphics(t))return;default:G.drawAccelerationStruct(this,this._visible),this._state=i.State.Idle,this.notifyChange("updating")}}modifyGraphics(i,t){t?i.forEach((i=>this.addToActiveGraphics(i))):i.forEach((i=>this.removeFromActiveGraphics(i))),this.setDirty()}layerSupportsDeconfliction(i){if(null==i||"object3d"!==i.type)return!1;const t=i.stageObject;if(1!==(t?.geometries.length??0))return!1;const e=t?.geometries[0],s=e?.material;return s instanceof C.HUDMaterial}_startUpdate(){G.prepare(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:i,fullHeight:t}=this._viewState.camera;this._initBins(i,t),this._resetIterators()}addToActiveGraphics(i){i.info[this.visibilityGroup]=new z,this._active.set(i.graphics3DGraphic.graphic.uid,i),this.setDirty()}removeFromActiveGraphics(i){this._visible.delete(i.graphics3DGraphic.graphic.uid),Y(i,this.visibilityGroup),delete i.info[this.visibilityGroup],this._active.delete(i.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(i){const t=this._ensureActiveGraphicsIterator(),e=h.invertOrIdentity(O,this._viewState.camera.projectionMatrix),s="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._viewState.camera.relativeElevation>0?M:null;let r=0;for(null!=s&&(d.transformMat4(S.getCenter(s),_.ZEROS,this._viewState.camera.viewMatrix),s[3]=g.getReferenceEllipsoid(this.view.spatialReference).radius,r=S.distanceToSilhouette(s,_.ZEROS));!i.done;){i.madeProgress();const a=t.next();if(!0===a.done)return this._resetActiveGraphicsIterator(),!0;const c=a.value,o=c?.info[this.visibilityGroup];o&&(this._collectGraphics3DGraphics(c,e,s,r),o.culled?this._visible.delete(c.graphics3DGraphic.graphic.uid):this._visible.set(c.graphics3DGraphic.graphic.uid,c))}return!1}_sortVisibleGraphics(i){const t=this._ensureSortGraphicsIterator();for(;!i.done;){const e=t.next();if(i.madeProgress(),!0===e.done)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(i){const t=this._ensureVisibleGraphicsIterator(),e=this.visibilityGroup===D.VisibilityGroup.LABEL;for(;!i.done;){i.madeProgress();const s=t.next();if(!0===s.done)return this._resetVisibleGraphicsIterator(),!0;const r=s.value,a=r.info[this.visibilityGroup];if(!a||a.culled){this._setGraphicVisibility(r,!1);continue}const c=r.graphics3DGraphic,o=!e||c.isVisible();a.visible=o&&!this._isConflicted(r),a.visible&&this._addToBins(r),this._setGraphicVisibility(r,a.visible),G.drawPoly(a,a.visible)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=j(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=j(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=W(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(i,t,e,s){const r=i.graphics3DGraphic;if(r.destroyed)return;const a=i.info[this.visibilityGroup];if(!r.isVisible(D.VisibilityGroup.GRAPHIC,D.VisibilityFlag.DECONFLICTION))return void(a.culled=!0);const c=this.getGraphicsLayers(r);v.empty(a.aabr);let o=null;for(const n of c){if(!this.layerSupportsDeconfliction(n))continue;const r=n.stageObject.geometries[0].material;if(null==o&&(o=q,this._getProjectionInfo(n,t,o),o.isOutsideScreen||this._isCulledBySlice(i,P)||null!=e&&this._isCulledByHorizon(o,e,s)))return void(a.culled=!0);this._expandBoundingRect(a,n,r,o)}null==o?a.culled=!0:(a.distance=o.distance,a.culled=!1)}_getProjectionInfo(i,t,e){const s=this._viewState.camera,r=i.stageObject,a=r.geometries[0],c=a.material,o=S.getCenter(r.boundingVolumeWorldSpace.bounds);d.transformMat4(P,o,s.viewMatrix);const n=a.attributes,l=n.get(N.VertexAttribute.NORMAL).data,h=n.get(N.VertexAttribute.CENTEROFFSETANDDISTANCE).data;c.applyShaderOffsetsView(P,l,r.transformation,h,s,e.scaleInfo,P),f.set(V,P[0],P[1],P[2],1),f.transformMat4(A,V,s.projectionMatrix),d.scale(e.positionNDC,A,1/A[3]),c.applyShaderOffsetsNDC(e.positionNDC,h,s,e.positionNDC,x),e.distanceWithoutPolygonOffset=s.depthNDCToWorld(x[2]),e.distance=x[2]===e.positionNDC[2]?e.distanceWithoutPolygonOffset:s.depthNDCToWorld(e.positionNDC[2]),f.set(A,e.positionNDC[0],e.positionNDC[1],e.positionNDC[2],1),f.transformMat4(V,A,t),f.scale(V,V,1/V[3]),d.set(e.positionView,P[0],P[1],P[2])}_isCulledByHorizon(i,t,e){return d.copy(E.direction,i.positionView),d.set(E.origin,0,0,0),!!S.intersectRay(t,E,F)&&i.distanceWithoutPolygonOffset>e}_isCulledBySlice(i,t){return i.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&y.extrusionContainsPoint(this._viewState.slicePlane,t)}_expandBoundingRect(i,t,e,{positionNDC:r,scaleInfo:a}){const c=this._viewState.camera,o=t.getScreenSize(k);B.applyPrecomputedScaleFactor(o,a.factor,o),o[0]*=c.pixelRatio,o[1]*=c.pixelRatio;const n=v.offset(e.calculateRelativeScreenBounds(o,a.factorAlignment.scale,T),s.lerp(0,c.fullWidth,.5+.5*r[0]),s.lerp(0,c.fullHeight,.5+.5*r[1])),l=this.marginFactor;if(0!==l){const i=l*Math.min(v.width(n),v.height(n));n[0]-=i,n[1]-=i,n[2]+=i,n[3]+=i}v.expand(i.aabr,n,i.aabr)}_isConflicted(i){const t=i.graphics3DGraphic.graphic.uid,e=i.info[this.visibilityGroup];let s=!0;for(let r=Math.floor(e.aabr[0]/this._accBinsSizeX);r<=Math.floor(e.aabr[2]/this._accBinsSizeX);r++)if(!(r<0||r>=this._accBinsNumX))for(let i=Math.floor(e.aabr[1]/this._accBinsSizeY);i<=Math.floor(e.aabr[3]/this._accBinsSizeY);i++){if(i<0||i>=this._accBinsNumY)continue;s=!1;const a=this._accBins[r][i];for(let i=0;i<a.length;i++){const s=a.data[i],r=s.info[this.visibilityGroup];if(r&&r.visible&&s.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,v.intersects(r.aabr,e.aabr)))return!0}}return s}_initBins(i,t){if(null==this._accBins){this._accBins=[];for(let i=0;i<this._accBinsNumX;i++){this._accBins.push([]);const i=this._accBins[this._accBins.length-1];for(let t=0;t<this._accBinsNumY;t++)i.push(new r)}}else for(let e=0;e<this._accBinsNumX;e++)for(let i=0;i<this._accBinsNumY;i++)this._accBins[e][i].clear();this._accBinsSizeX=i/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY,this.accNumTests=0}_addToBins(i){const t=i.info[this.visibilityGroup],e=Math.floor(t.aabr[0]/this._accBinsSizeX),s=Math.floor(t.aabr[2]/this._accBinsSizeX),r=Math.floor(t.aabr[1]/this._accBinsSizeY),a=Math.floor(t.aabr[3]/this._accBinsSizeY);for(let c=e;c<=s;c++)if(!(c<0||c>=this._accBinsNumX))for(let t=r;t<=a;t++)t<0||t>=this._accBinsNumY||this._accBins[c][t].push(i)}_setGraphicVisibility(i,t){const e=i.graphics3DGraphic;e.destroyed||(e.setVisibilityFlag(this.visibilityGroup,D.VisibilityFlag.DECONFLICTION,t),this.visibilityGroup===D.VisibilityGroup.LABEL&&this.view.labeler.setLabelGraphicVisibility(e,t))}},t.__decorate([a.property({constructOnly:!0})],i.Deconflictor.prototype,"view",void 0),t.__decorate([a.property({type:Boolean,readOnly:!0})],i.Deconflictor.prototype,"updating",null),i.Deconflictor=t.__decorate([l.subclass("esri.views.3d.layers.graphics.Deconflictor")],i.Deconflictor);class U{constructor(){this.id=0,this.visible=!1,this.prio=0,this.distance=0}}class H{constructor(i=null,t=null,e=null){this.active=i,this.visible=t,this.sort=e,this.sortArray=new r({allocator:i=>i||new U})}}const k=p.create();class Z{constructor(){this.positionView=_.create(),this.positionNDC=_.create(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new I.ScaleInfo}get isOutsideScreen(){const i=this.positionNDC;return i[0]<-1||i[1]<-1||i[2]<-1||i[0]>=1||i[1]>=1}}const q=new Z;i.DeconflictorGraphic=R,i.DeconflictorViewState=X,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})}));
