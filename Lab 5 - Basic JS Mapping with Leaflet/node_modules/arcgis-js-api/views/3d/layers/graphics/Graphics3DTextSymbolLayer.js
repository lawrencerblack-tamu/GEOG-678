/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Error","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DObjectMetadata","./Graphics3DSymbolLayer","./graphicUtils","./LabelParameters","./placementUtils","./pointUtils","../../webgl-engine/lib/FontMetrics","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureFactory","../../webgl-engine/materials/HUDMaterial"],(function(e,t,n,r,a,l,i,s,o,c,h,m,u,p,d,f,y,g,b,x,v,P){"use strict";const O=l.fromValues(0,0,1);class S extends u.Graphics3DSymbolLayer{constructor(e,t,n,r){super(e,t,n,r),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=p.validateSymbolLayerSize(this.symbolLayer.size);if(e)throw new t("graphics3dtextsymbollayer:invalid-size",e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await x.TextRenderParameters.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const t=e.graphic,n=y.placePointOnGeometry(t.geometry);if(null==n)return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;const r=this.symbolLayer.text;if(null==r||""===r)return null;const a=i.hasCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(null!=a&&!i.textSymbolLayerSupportsVerticalOffset(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const{verticalAlignment:l}=this.symbolLayer,s=new d.LabelPlacement(a);f.verticalScreenOffsetFromAlignment(l,s.screenOffset);const o=new d.LabelParameters(s,this.symbolLayer.horizontalAlignment,f.verticalPlacementFromAlignment(l));return this._createAs3DShape(t,n,r,o)}createLabel(e,t,n,r,a){const l=e.graphic,i=y.placePointOnGeometry(l.geometry);if(null==i)return this.logger.warn(`unsupported geometry type for label: ${l.geometry.type}`),null;const s=t.text;return!s||/^\s+$/.test(s)?null:this._createAs3DShape(l,i,s,t,n,r,a)}setGraphicElevationContext(e,t,n=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(n),t}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return E(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e)})),o.SymbolUpdateType.UPDATE}slicePlaneEnabledChanged(e,t){return E(e,t,(e=>{for(const t of e.stageObject.geometries)t.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return!1}updateGraphicElevationContext(e,t){const n=t.elevationContext;this.setGraphicElevationContext(e,n,null!=t.metadata?t.metadata.elevationOffset:0),t.needsElevationUpdates=o.needsElevationUpdates2D(n.mode)||"absolute-height"===n.mode}_defaultElevationInfoNoZ(){return w}_createAs3DShape(e,t,l,i,u=null,p=null,d=(()=>i.placement.elevationOffset)){const x=this.setGraphicElevationContext(e,new c.ElevationContext,i.placement.elevationOffset),S="polyline"===e.geometry?.type,E=e.uid;let w=null,G=null;if(null==p){const e=f.textRenderAlignmentFromHorizontalPlacement(i.horizontalPlacement);w=new v(l,e,this._textRenderParameters);let t=null;if(null!=this._context.sharedResources.textures){G=this._context.sharedResources.textures.fromData(w.key,(()=>w.create())),G.texture.events.on("unloaded",(()=>t?.release()));const e=this._context.stage.renderView.textureRepository.acquire(G.texture.id);if(null==e||n.isPromiseLike(e))return G.release(),null;t=e}}const D=L(w,i),U={occlusionTest:!0,screenOffset:i.placement.screenOffset,anchorPosition:D,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:i.placement.centerOffsetUnits,drawInSecondSlot:!0};if(p?U.textureId=p.id:G&&(U.textureId=G.texture.id),null!=i.placement.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:n}=i.placement.verticalOffset;U.verticalOffset={screenLength:r.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=n?n:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources,n=g.getFontMetrics(this._textRenderParameters);U.screenSizePerspective=t.overrideFontHeight(n.maxHeight),U.screenSizePerspectiveAlignment=e}S&&(U.shaderPolygonOffset=1e-4),U.hasSlicePlane=this._context.slicePlaneEnabled;const _=(e,t)=>{const n=JSON.stringify(t);let r=e.get(n);return null==r&&(r=new P.HUDMaterial(t),e.add(n,r)),r},z=u?_(u,U):new P.HUDMaterial(U),A=i.placement.translation,C=w?a.fromValues(w.displayWidth,w.displayHeight):a.ZEROS,R=i.placement.centerOffset,T=O,j=a.create(),H=b.createPointGeometry(z,T,A,null,C,R,j,null),M=y.createStageObject(this._context,t,H,x,E);if(null==M)return null;const F=(t,n,r,a,l,o)=>{const c=d()||i.placement.elevationOffset,h=this.setGraphicElevationContext(e,n,c);return s.perObjectElevationAligner(t,h,r,a,l,o)},V=new h.Graphics3DObject3DGraphicLayer(this,M.object,[H],null==u?[z]:null,G,F,x);V.alignedSampledElevation=M.sampledElevation,V.needsElevationUpdates=o.needsElevationUpdates2D(x.mode)||"absolute-height"===x.mode,V.getScreenSize=(e=a.create())=>(e[0]=w?w.displayWidth:i.displaySize[0],e[1]=w?w.displayHeight:i.displaySize[1],e);const W=new m.Graphics3DObjectMetadata(i.placement.elevationOffset,l);return V.metadata=W,y.extendPointGraphicElevationContext(V,t,this._context.elevationProvider),V}}function E(e,t,n){e&&e.forEach((e=>{const r=t(e);null!=r&&n(r,e.graphic)}))}function L(e,t){if("baseline"===t.verticalPlacement){const n=f.horizontalPlacementToAnchorX[t.horizontalPlacement],r=null!=e?e.baselineAnchorY:0;return a.fromValues(n,r)}const n=f.anchorFromPlacements(t.horizontalPlacement,t.verticalPlacement);return f.namedAnchorToHUDMaterialAnchorPos[n]}const w={mode:"relative-to-ground",offset:0};e.Graphics3DTextSymbolLayer=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
