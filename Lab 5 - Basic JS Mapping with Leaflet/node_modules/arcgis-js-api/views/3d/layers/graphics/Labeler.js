/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Logger","../../../../core/MapUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../layers/graphics/hydratedFeatures","../../../../layers/support/labelFormatUtils","../../../../symbols/callouts/calloutUtils","./enums","./Graphics3DCalloutSymbolLayerFactory","./Graphics3DLineCalloutSymbolLayer","./graphicSymbolUtils","./LabelParameters","./labelPlacement","./placementUtils","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/lib/TextRenderer","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureAtlas","../../webgl-engine/lib/WebGLLayer","../../../support/Scheduler","../../../support/Yield"],(function(e,t,l,s,i,a,r,o,n,c,h,b,d,u,y,g,p,x,C,f,_,L,m,v,T,A,G,w,D,I,P){"use strict";class R{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.addedToTextureAtlas=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class S{constructor(e,t,l,s,i){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=l,this.textRenderParameters=s,this.labelFunction=i,this.calloutSymbolLayerIndex=0}}class V{constructor(e,t,l,s,i,a,r,o){this.layer=t,this.graphics3DCore=l,this.scaleVisibility=s,this.emptySymbolLabelSupported=i,this.elevationInfoOverride=a,this.disablePlacement=r,this.active=o,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new D.WebGLLayer(e,{pickable:!0,disableOctree:!0},t.uid)}destroy(){this.stageLayer.destroy()}}function E(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function F(e){return!e||0===e.length}function O(e){return!0===e.labelsVisible&&!!e.labelingInfo?.some((e=>!!e.symbol))}e.Labeler=class extends l{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([n.watch((()=>this.view.state?.camera),(()=>this.setDirty())),n.watch((()=>this.view.state?.rasterPixelRatio),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(I.TaskPriority.LABELER,this)]),this._textTextureAtlas=new w.TextTextureAtlas({view:this.view}),this._hudMaterialCollection=new T.MaterialCollection(this.view._stage),this._calloutMaterialCollection=new T.MaterialCollection(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=r.disposeMaybe(this._textTextureAtlas),this._hudMaterialCollection=r.disposeMaybe(this._hudMaterialCollection),this._calloutMaterialCollection=r.disposeMaybe(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),M.graphic=null,M.renderingInfo=null,M.layer=null}_activateLabelingContext(e){e.graphics.forEach(((t,l)=>{const s=new R(e,t);this._labels.set(l,s),e.labelsToInitialize.set(l,s),t.setVisibilityFlag(x.VisibilityGroup.LABEL,x.VisibilityFlag.USER,!0)})),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(x.VisibilityGroup.LABEL,x.VisibilityFlag.USER,!1),this.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const l=e.textRenderers[t._labelIndex];l&&(this._textTextureAtlas.addTextTexture(l,t.stageObject),e.addedToTextureAtlas=!0)}}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const l=e.textRenderers[t._labelIndex];null!=l&&(this._textTextureAtlas.removeTextTexture(l,t.stageObject),e.addedToTextureAtlas=!1)}}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),P.Yield}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(E(t))this._dirty=!0;else if(F(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else a.someMap(t.labelsToInitialize,((l,s)=>(this._ensureGraphics3DResources(l)&&(this._labels.set(s,l),this.deconflictor.setDirty(),e.madeProgress()),(l.visible&&l.textInitialized||!l.visible&&l.hasGraphics3DResources)&&(t.labelsToInitialize.delete(s),e.madeProgress()),e.done)))&&(this._dirty=!0);this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;e.layer.when&&await e.layer.when(),o.throwIfAborted(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const l=e.graphics3DCore,a=l.layer,r=a.labelingInfo?.filter((e=>!!e.symbol));if(!r||0===r.length)return;let n=!1;await s.forEach(r,(async(a,r)=>{const c=a.symbol,h=_.getGraphics3DSymbol(l.getOrCreateGraphics3DSymbol(c));if(null==h)return void i.getLogger(this).error("Failed to create Graphics3DSymbol for label");await h.load(),o.throwIfAborted(t);let b=null;p.hasCalloutSupport(c)&&c.hasVisibleCallout()&&(b=C.make(c,l.symbolCreationContext),await b.load(),o.throwIfAborted(t));const d=await s.result(g.createLabelFunction(a,e.layer.fieldsIndex,this.view.spatialReference));if(o.throwIfAborted(t),!0===d.ok){const l=await this._createTextRenderParameters(h.symbol);o.throwIfAborted(t),e.labelClassContexts[r]=new S(a,h,b,l,d.value)}else i.getLogger(this).error(`Label expression failed to evaluate: ${d.error}`),n=!0})),o.throwIfAborted(t)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(o.isAbortError(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==t?.type?null:G.TextRenderParameters.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const l of e.labelClassContexts)--l.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,r.abortMaybe(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,l,s,i,a){const r=new L.LabelParameters(l,v.horizontalPlacementFromAnchor(l.anchor),v.verticalPlacementFromAnchor(l.anchor),e.text,u.fromValues(e.displayWidth,e.displayHeight));return M.graphic=t,M.renderingInfo=null,M.layer=s,i.createLabel(M,r,this._hudMaterialCollection,this._textTextureAtlas,(()=>{const e=m.getLabelPlacement(a);return e?e.elevationOffset:null}))}_createLineCalloutGraphic(e,t,l,s,i){M.graphic=e,M.layer=i;const a=s.screenOffset[0];return M.renderingInfo=new f.LineCalloutSymbolLayerRenderingInfo(null,t,s.translation,s.centerOffset,a,s.centerOffsetUnits,s.elevationOffset,this._calloutMaterialCollection),l.createGraphics3DGraphic(M)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const l=e.labelingContext,s=l.labelClassContexts;if(F(s)||!l.emptySymbolLabelSupported&&0===t.layers.length)return!1;let i=!1;const a=t.graphic,r=l.layer,o=O(l.layer);for(let n=0;n<s.length;n++){const c=e.textRenderers[n],h=e.textLabelPlacements[n];if(null==c||null==h)continue;const b=s[n],d=b.graphics3DSymbol,u=d.symbol&&"label-3d"===d.symbol.type?d.symbol:null,y=d.symbolLayers[0];if(!y)continue;y.setElevationInfoOverride(l.elevationInfoOverride);const g=new m.LabelInfo(t,u,b.labelClass),p=this._createTextSymbolGraphic(c,a,h,r,y,g);if(null==p)return!1;p._labelClass=b.labelClass,p._labelIndex=n,t.addLabelGraphic(p,l.stageLayer),t.deconflictionPriority=b.textRenderParameters?.definition.size??0,t.setVisibilityFlag(x.VisibilityGroup.LABEL,x.VisibilityFlag.USER,o),t.setVisibilityFlag(x.VisibilityGroup.LABEL,x.VisibilityFlag.SCALE_RANGE,!0),t.setVisibilityFlag(x.VisibilityGroup.LABEL,x.VisibilityFlag.DECONFLICTION,!1),i=!0;const C=b.graphics3DCalloutSymbolLayer;if(C&&h.hasLabelVerticalOffset){C.setElevationInfoOverride(l.elevationInfoOverride);const e=this._createLineCalloutGraphic(a,u,C,h,r);null!=e&&(b.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,l.stageLayer))}break}return l.scaleVisibility&&i&&l.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const l of e.graphics3DGraphic.labelLayers){if(null==l._labelClass)continue;const e=t[l._labelIndex].graphics3DSymbol.symbolLayers[0];e?.onRemoveGraphic(l)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,l=t.labelClassContexts;if(F(l))return;const s=e.graphics3DGraphic.graphic;for(let a=0;a<l.length;a++){const r=l[a];if(e.textRenderers[a]=null,e.textLabelPlacements[a]=null,null==r?.textRenderParameters)continue;const o=r.labelFunction;let n;if("arcade"===o.type)try{const e=o.needsHydrationToEvaluate()?y.hydrateGraphic(s,t.layer):s;n=o.evaluate(e)}catch(i){n=null}else n=o.evaluate(s);if(null==n||""===n||/^\s+$/.test(n))continue;const c=r.graphics3DSymbol,h="label-3d"===c.symbol?.type?c.symbol:null;if(!c.symbolLayers[0])continue;const b=e.graphics3DGraphic,d=r.labelClass,u=t.disablePlacement,g=m.getLabelPlacement({graphics3DGraphic:b,labelSymbol:h,labelClass:d,disablePlacement:u});if(null==g)continue;const p=v.horizontalPlacementFromAnchor(g.anchor),x=v.textRenderAlignmentFromHorizontalPlacement(p);e.textRenderers[a]=new A.TextRenderer(n,x,r.textRenderParameters,w.TextTextureAtlas.maxSize),e.textLabelPlacements[a]=g}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const l=t.graphic.uid;if(e.graphics.set(l,t),e.active){const s=new R(e,t);this._labels.set(l,s),e.labelsToInitialize.set(l,s)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const l=t.graphic.uid,s=this._labels.get(l);e.graphics.delete(l),s&&(this._destroyGraphic(s,l),e.labelsToInitialize.delete(l),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const l of t){const t=e.graphics.get(l);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const l of t.labelClassContexts){const s=new Map;t.graphics.forEach((e=>s.set(e.graphic.uid,e)));const i=e=>e.labelLayers[0];if(l.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,s,i),l.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[l.calloutSymbolLayerIndex];l.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,s,t)}}}_visibilityInfoChange(e){const t=O(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach(((t,l)=>{const s=this._labels.get(l);s&&(this._destroyGraphic(s,l),s.visible=!1,e.labelsToInitialize.set(l,s))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,l){const s=l&&l.emptySymbolLabelSupported||!1,i=l?.elevationInfoOverride||null,a=l?.disablePlacement||null;if(this._findLabelingContext(e))return;const r=e.layer,o=new V(this.view._stage,r,e,t,s,i,a,O(r));return this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>O(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const l=this._labelingContexts.indexOf(t);this._labelingContexts.splice(l,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),t.destroy(),this.setDirty()}setLabelGraphicVisibility(e,t){const l=e.graphic.uid,s=this._labels.get(l);s&&s.visible!==t&&(t&&!s.addedToTextureAtlas?(this._addLabelTextureToAtlas(s),s.textInitialized||s.labelingContext.labelsToInitialize.set(l,s)):!t&&s.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(s),s.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some((e=>E(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(E(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}},t.__decorate([c.property({constructOnly:!0})],e.Labeler.prototype,"view",void 0),t.__decorate([c.property({constructOnly:!0})],e.Labeler.prototype,"deconflictor",void 0),t.__decorate([c.property()],e.Labeler.prototype,"_textTextureAtlas",void 0),t.__decorate([c.property({type:Boolean,readOnly:!0})],e.Labeler.prototype,"updating",null),e.Labeler=t.__decorate([d.subclass("esri.views.3d.layers.graphics.Labeler")],e.Labeler);const M=new f.LineCalloutCreationContext(null,null,null);e.areLabelsVisible=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
