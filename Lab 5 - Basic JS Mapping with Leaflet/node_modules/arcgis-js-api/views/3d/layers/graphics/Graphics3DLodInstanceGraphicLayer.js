/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","./elevationAlignmentUtils","./featureExpressionInfoUtils","./graphicUtils","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Object3DStateID"],(function(e,t,i,n,a,s,r,o,l,h){"use strict";class c{constructor(e,t,i,n){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=n,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this._lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){r.setContextFeature(this.elevationContext.featureExpressionInfoContext,i);const n=(i,n)=>s.evaluateElevationInfoAtPoint(i,e,this.elevationContext,t,n),a=this.elevationAligner(this,this.elevationContext,e.spatialReference,n,t);null!=a&&(this.alignedSampledElevation=a)}}getCenterObjectSpace(e=n.create()){return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,f),i.transformMat4(e,this._lodRenderer.baseBoundingSphere.center,f)}getBoundingBoxObjectSpace(e=a.create()){this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,f);const t=this._lodRenderer.baseBoundingBox;a.empty(e);for(let n=0;n<8;++n)i.set(g,0==(1&n)?t[0]:t[3],0==(2&n)?t[1]:t[4],0==(4&n)?t[2]:t[5]),i.transformMat4(g,g,f),a.expandWithVec3(e,g);return e}computeAttachmentOrigin(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,f),e.render.origin[0]+=f[12],e.render.origin[1]+=f[13],e.render.origin[2]+=f[14],e.render.num++}async getProjectedBoundingBox(e,t,n,s,r){const l=this.getBoundingBoxObjectSpace(r),h=m,c=a.isPoint(l)?1:h.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,f);for(let a=0;a<c;a++){const e=h[a];g[0]=l[e[0]],g[1]=l[e[1]],g[2]=l[e[2]],i.transformMat4(g,g,f),d[3*a]=g[0],d[3*a+1]=g[1],d[3*a+2]=g[2]}if(!e(d,0,c))return null;a.empty(l);let x=null;this.calculateRelativeScreenBounds&&(x=this.calculateRelativeScreenBounds());for(let i=0;i<3*c;i+=3){for(let e=0;e<3;e++)l[e]=Math.min(l[e],d[i+e]),l[e+3]=Math.max(l[e+3],d[i+e]);x&&n.push({location:d.slice(i,i+3),screenSpaceBoundingRect:x})}if(t&&(a.center(l,u),"absolute-height"!==this.elevationContext.mode)){let e;const i=o.demResolutionForBoundingBox(l,t.service.spatialReference,t);try{e=await t.service.queryElevation(u[0],u[1],s,i,"ground")}catch(b){}null!=e&&a.offset(l,0,0,-this.alignedSampledElevation+e)}return l}addObjectState(e,t){if(e===l.Object3DState.Highlight){const i=new h.Object3DStateID(e);this._addHighlightId(i),t.addExternal((e=>{this._removeHighlightId(e)}),i)}}removeObjectState(e){this._highlights.forEach((t=>e.remove(t)))}_addHighlightId(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],g=n.create(),u=n.create(),m=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],f=t.create();e.Graphics3DLodInstanceGraphicLayer=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
