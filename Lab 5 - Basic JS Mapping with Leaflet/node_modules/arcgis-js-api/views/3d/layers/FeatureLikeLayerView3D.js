/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/tslib.es6","../../../core/Error","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/graphics/hydratedFeatures","../../../layers/graphics/controllers/FeatureTileController3D","../../../rest/support/Query","../../../symbols/support/utils","./graphics/elevationAlignPointsInFeatures","./graphics/Graphics3DFeatureProcessor","./graphics/QueryEngine","./graphics/queryForSymbologySnapping","./support/HeatmapFeatureProcessor","./support/LayerViewPerformanceInfo","./support/projectExtentUtils","../webgl-engine/lib/UpdatePolicy","../../support/Scheduler"],(function(e,t,r,s,o,i,a,n,l,p,c,d,h,u,y,g,_,m,E,b,f,w,C){"use strict";const O=e=>{let a=class extends e{constructor(){super(...arguments),this._dataUpdatingState=v.NONE,this.controller=null,this.updatePolicy=w.UpdatePolicy.SYNC,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.supportsHeightUnitConversion=!0,this._pendingController=null,this.queryEngine=null}initialize(){const e=this.layer;if("isTable"in e&&e.isTable)return void this.addResolvingPromise(Promise.reject(new r("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e})));this.addResolvingPromise(this._validateGeometryType()),this._updatingHandles.add((()=>this.layer.renderer),(e=>this._recreateProcessor(e)),o.initial),this.addResolvingPromise((async()=>{const e=await f.toViewIfLocal(this);this.fullExtentInLocalViewSpatialReference=e,await this._initializeController()})()),this._updatingHandles.add((()=>this.updatePolicy),(e=>this.processor.preferredUpdatePolicy=e));const t=()=>this.processor.featureStore;this.queryEngine=new _.QueryEngine({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return t()},hasZ:this.hasZ,hasM:this.hasM},priority:C.TaskPriority.FEATURE_QUERY_ENGINE}),this.notifyChange("updating")}destroy(){this._destroyPendingController(),this.controller=s.destroyMaybe(this.controller),this._set("processor",s.destroyMaybe(this.processor)),this.queryEngine=s.destroyMaybe(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this._pendingController=s.destroyMaybe(this._pendingController)}get dataUpdating(){return this._dataUpdatingState!==v.NONE}get legendEnabled(){return this.canResume()&&this.processor?.legendEnabled}get graphics3DProcessor(){return"graphics-3d"===this.processor?.type?this.processor:null}get heatmapProcessor(){return"heatmap"===this.processor?.type?this.processor:null}get symbologySnappingSupported(){const e=this.layer?.renderer?.getSymbols();return e?.some(u.symbolHasExtrudeSymbolLayer)??!1}get hasAllFeatures(){return!(!this.controller||!("hasAllFeatures"in this.controller))&&this.controller.hasAllFeatures}get hasAllFeaturesInView(){return!(!this.controller||!("hasAllFeaturesInView"in this.controller))&&this.controller.hasAllFeaturesInView}get hasFullGeometries(){return!(!this.controller||!("hasFullGeometries"in this.controller))&&this.controller.hasFullGeometries}getHit(e){let t;return this.loadedGraphics?.forEach((r=>{r.uid===e&&(t=c.hydrateGraphic(r,this.layer))})),t?{type:"graphic",graphic:t,layer:t.layer}:null}whenGraphicBounds(e,t){return this.processor?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.processor?.computeAttachmentOrigin(e,t)}async elevationAlignPointsInFeatures(e,t){const s=this.graphics3DProcessor;if(null==s)throw new r("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");return y.elevationAlignPointsInFeatures(this.view,this.layer,(e=>s.getGraphics3DGraphicByObjectId(e)),e,t)}async queryForSymbologySnapping(e,t){return this.symbologySnappingSupported?m.queryForSymbologySnapping(this.graphics3DProcessor,e,t):{candidates:[],sourceCandidateIndices:[]}}queryFeatures(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),t?.signal)}queryObjectIds(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),t?.signal)}queryFeatureCount(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),t?.signal)}queryExtent(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),t?.signal)}_ensureQuery(e){return null==e?this.createQuery():h.from(e)}highlight(e){return this.processor.highlight(e,this.layer.objectIdField)}maskOccludee(e){return this.processor.maskOccludee(e)}canResume(){return super.canResume()&&!this.processor?.scaleVisibilitySuspended}getSuspendInfo(){const e=super.getSuspendInfo();return this.processor?{...e,...this.processor.suspendInfo}:e}isUpdating(){return!(!this.processor||this.processor.destroyed)&&!(this._controllerCreated&&!this.controller?.updating&&this.view?.basemapTerrain?.ready&&!this.processor.updating)}async _initializeController(){const e=this.createController();this._pendingController=e,this._setupDataUpdating(e),await e.when(),this._setControllerWhenInitialized(e)}_setupDataUpdating(e){"dataUpdating"in e&&this.addHandles([o.watch((()=>e.dataUpdating),(e=>{e&&this._dataUpdatingState===v.NONE?this._dataUpdatingState=v.CONTROLLER:e||this._dataUpdatingState!==v.CONTROLLER||(this._dataUpdatingState=v.NONE)}),o.sync),o.watch((()=>!!this.graphics3DProcessor?.dataUpdating),(t=>{t&&this._dataUpdatingState===v.CONTROLLER?this._dataUpdatingState=v.CORE:t||this._dataUpdatingState!==v.CORE||(this._dataUpdatingState=e.dataUpdating?v.CONTROLLER:v.NONE)}),o.sync)])}async _setControllerWhenInitialized(e){try{await this.when()}catch(t){}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(await o.whenOnce((()=>this.view?.basemapTerrain?.ready)),this.beforeSetController(e),this._pendingController=null,this.controller=e,this.loadedGraphics=e.graphics,this.notifyChange("updating")):this._destroyPendingController()}_updateClippingExtent(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}async _validateGeometryType(){switch(this.layer.geometryType){case"multipatch":case"multipoint":throw new r("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType})}}_recreateProcessor(e){const t="heatmap"===e?.type,r="heatmap"===this.processor?.type,s=this.processor;if(s&&t===r)return;const o=t?new E.HeatmapFeatureProcessor({owner:this}):new g.Graphics3DFeatureProcessor({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:e=>this._updateClippingExtent(e)});this._set("processor",o),s?.destroy(),this.queryEngine?.clear(),this.addResolvingPromise(o.initializePromise)}get performanceInfo(){const e=this.controller instanceof d.FeatureTileController3D?this.controller:null;return new b.LayerViewPerformanceInfo(this.processor.usedMemory,this.loadedGraphics?.length,e?.serviceDataCount??-1,e?.maximumNumberOfFeatures??-1,0,this.processor.performanceInfo)}};return t.__decorate([i.property()],a.prototype,"loadedGraphics",void 0),t.__decorate([i.property()],a.prototype,"_dataUpdatingState",void 0),t.__decorate([i.property({readOnly:!0})],a.prototype,"dataUpdating",null),t.__decorate([i.property()],a.prototype,"suspended",void 0),t.__decorate([i.property({readOnly:!0})],a.prototype,"legendEnabled",null),t.__decorate([i.property()],a.prototype,"updating",void 0),t.__decorate([i.property()],a.prototype,"controller",void 0),t.__decorate([i.property()],a.prototype,"processor",void 0),t.__decorate([i.property({readOnly:!0})],a.prototype,"updatePolicy",void 0),t.__decorate([i.property({readOnly:!0})],a.prototype,"suspendResumeExtentMode",void 0),t.__decorate([i.property({type:Boolean})],a.prototype,"slicePlaneEnabled",void 0),t.__decorate([i.property({readOnly:!0})],a.prototype,"suspendInfo",void 0),t.__decorate([i.property()],a.prototype,"graphics3DProcessor",null),t.__decorate([i.property()],a.prototype,"heatmapProcessor",null),t.__decorate([i.property()],a.prototype,"symbologySnappingSupported",null),t.__decorate([i.property({readOnly:!0})],a.prototype,"hasAllFeatures",null),t.__decorate([i.property({readOnly:!0})],a.prototype,"hasAllFeaturesInView",null),t.__decorate([i.property({readOnly:!0})],a.prototype,"hasFullGeometries",null),a=t.__decorate([p.subclass("esri.views.3d.layers.FeatureLikeLayerView3D")],a),a};var v;!function(e){e[e.NONE=0]="NONE",e[e.CONTROLLER=1]="CONTROLLER",e[e.CORE=2]="CORE"}(v||(v={})),e.FeatureLikeLayerView3D=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
