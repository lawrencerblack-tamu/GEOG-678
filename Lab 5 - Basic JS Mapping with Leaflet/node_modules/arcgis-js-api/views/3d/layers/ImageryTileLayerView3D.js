/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../core/Error","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/support/rasterFunctions/rasterProjectionHelper","./LayerView3D","./TiledLayerView3D","../terrain/RasterTile","../../layers/ImageryTileLayerView","../../layers/LayerView","../../layers/RefreshableLayerView","../../support/drapedUtils","../../webgl/capabilities"],(function(e,t,r,i,a,s,n,l,o,c,d,h,p,y,m,u,g){"use strict";let b=class extends(p(m(d.TiledLayerView3D(c.LayerView3D(y))))){constructor(){super(...arguments),this.type="imagery-tile-3d",this.isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),null==this.fullExtent&&this.addResolvingPromise(Promise.reject(new t("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const e=r.whenOnce((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const e=this.view.basemapTerrain.tilingScheme,t=this.layer.tileInfo,r=["png","png24","png32","jpg","mixed"].includes(t.format)&&e.compatibleWith(t);this.isAlignedMapTile=r;const i=r?t:e.toTileInfo();this.tileInfo=i,this._updatingHandles.add((()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent]),(()=>this.refresh()))}));this.addResolvingPromise(e)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null}get _blankTile(){const e=document.createElement("canvas"),t=e.getContext("2d"),[r,i]=this.tileInfo.size;return e.width=r,e.height=i,t.clearRect(0,0,r,i),t.getImageData(0,0,r,i)}get imageFormatIsOpaque(){return"jpg"===this.layer.tileInfo.format}get hasMixedImageFormats(){return"mixed"===this.layer.tileInfo.format}get dataLevelRange(){const e=this.layer.tileInfo,t=this.tileInfo.lodAt(0)?.scale,r=this.layer.tileInfo.lodAt(e.lods.length-1)?.scale;return this.levelRangeFromScaleRange(t,r)}_getfullExtent(){return o.projectDatasetExtent(this.layer.serviceRasterInfo,null!=this.view.basemapTerrain?.spatialReference?this.view.basemapTerrain.spatialReference:this.view.spatialReference)}async fetchTile(e,t,r,i){const a=this.tileInfo,s=this._canSymbolizeInWebGL(),n={tileInfo:a,requestRawData:s,signal:i.signal,timeExtent:this.timeExtent,requestAsImageElement:this.isAlignedMapTile,noClip:!1},{layer:l}=this,o=await l.fetchTile(e,t,r,n);if(o instanceof HTMLImageElement)return o;let c=o?.pixelBlock;if(null==c)return this._blankTile;if(!s&&(c=await l.applyRenderer(o),null==c))return this._blankTile;const d=new h.RasterTile([e,t,r],c,a.size[0],a.size[1]);return s?(d.symbolizerRenderer=l.symbolizer.rendererJSON,d.symbolizerParameters=l.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e)),d.transformGrid=o.transformGrid,d.bandIds=l.bandIds):(d.isRendereredSource=!0,d.bandIds=null),d.interpolation=l.interpolation,d}_getSymbolizerOptions(e){const t=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:null!=this.view.basemapTerrain?.spatialReference?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))}createFetchPopupFeaturesQueryGeometry(e,t){return u.createQueryGeometry(e,t,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){const e=g.getWebGLCapabilities(),{symbolizer:t}=this.layer,r=t.lookup?.colormapLut?.indexedColormap,i=!!this.layer.rasterFunction?.hasClipFunction,a=r&&r.length>4*(e.maxTextureSize||4906);return t.canRenderInWebGL&&!a&&!i}};e.__decorate([i.property({readOnly:!0})],b.prototype,"_blankTile",null),e.__decorate([i.property({readOnly:!0})],b.prototype,"imageFormatIsOpaque",null),e.__decorate([i.property({readOnly:!0})],b.prototype,"hasMixedImageFormats",null),e.__decorate([i.property({readOnly:!0})],b.prototype,"dataLevelRange",null),b=e.__decorate([l.subclass("esri.views.3d.layers.ImageryTileLayerView3D")],b);return b}));
