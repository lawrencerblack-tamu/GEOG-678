/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../../core/arrayUtils","../../../core/typedArrayUtil","../../../core/libs/gl-matrix-2/math/quat","../../../core/libs/gl-matrix-2/factories/quatf64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f32","../../../geometry/SpatialReference","../../../geometry/projection/projectBuffer","./i3s/PointCloudWorkerUtil","../support/orientedBoundingBox"],(function(t,e,r,a,o,n,i,u,f,s){"use strict";class l{transform(t){const r=this._transform(t),a=[r.points.buffer,r.rgb.buffer];null!=r.pointIdFilterMap&&a.push(r.pointIdFilterMap.buffer);for(const o of r.attributes)"buffer"in o.values&&e.isArrayBuffer(o.values.buffer)&&o.values.buffer!==r.rgb.buffer&&a.push(o.values.buffer);return Promise.resolve({result:r,transferList:a})}_transform(e){const r=f.readGeometry(e.schema,e.geometryBuffer);let a=r.length/3,o=null;const n=new Array,u=f.getAttributeValues(e.primaryAttributeData,r,a);null!=e.primaryAttributeData&&u&&n.push({attributeInfo:e.primaryAttributeData.attributeInfo,values:u});const l=f.getAttributeValues(e.modulationAttributeData,r,a);null!=e.modulationAttributeData&&l&&n.push({attributeInfo:e.modulationAttributeData.attributeInfo,values:l});let b=f.evaluateRenderer(e.rendererInfo,u,l,a);if(e.filterInfo&&e.filterInfo.length>0&&null!=e.filterAttributesData){const i=e.filterAttributesData.filter(t.isSome).map((t=>{const e=f.getAttributeValues(t,r,a),o={attributeInfo:t.attributeInfo,values:e};return n.push(o),o}));o=new Uint32Array(a),a=f.filterInPlace(r,b,o,e.filterInfo,i)}for(const t of e.userAttributesData){const e=f.getAttributeValues(t,r,a);n.push({attributeInfo:t.attributeInfo,values:e})}3*a<b.length&&(b=new Uint8Array(b.buffer.slice(0,3*a))),this._applyElevationOffsetInPlace(r,a,e.elevationOffset);const c=this._transformCoordinates(r,a,s.Obb.fromData(e.obbData),i.fromJSON(e.inSR),i.fromJSON(e.outSR));return{obbData:e.obbData,points:c,rgb:b,attributes:n,pointIdFilterMap:o}}_transformCoordinates(t,e,a,i,f){if(!u.projectBuffer(t,i,0,t,f,0,e))throw new Error("Can't reproject");const s=n.clone(a.center),l=n.create(),c=n.create(),m=n.clone(a.halfSize);r.conjugate(b,a.quaternion);const p=new Float32Array(3*e);for(let r=0;r<e;r++){let e=3*r;l[0]=t[e]-s[0],l[1]=t[e+1]-s[1],l[2]=t[e+2]-s[2],o.transformQuat(c,l,b),m[0]=Math.max(m[0],Math.abs(c[0])),m[1]=Math.max(m[1],Math.abs(c[1])),m[2]=Math.max(m[2],Math.abs(c[2])),p[e++]=l[0],p[e++]=l[1],p[e]=l[2]}return a.halfSize=m,p}_applyElevationOffsetInPlace(t,e,r){if(0!==r)for(let a=0;a<e;a++)t[3*a+2]+=r}}const b=a.create();function c(){return new l}return c}));
