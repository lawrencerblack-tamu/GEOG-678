/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Cyclical","../../../core/has","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/vec2","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/ellipsoidUtils","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingRect","../../../geometry/support/ray","../../../chunks/sphere","../../../geometry/support/vector","../../../geometry/support/webMercatorUtils","../state/utils/viewUtils","../support/debugFlags","../support/debugUtils","./interfaces","./OverlayRenderer","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/Intersector","../webgl-engine/lib/LocalOriginFactory","../webgl-engine/lib/Material","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/textureUtils","../webgl-engine/parts/requireUtils","../../support/Scheduler","../../support/Yield"],(function(e,t,r,i,s,a,n,o,l,c,d,h,u,p,y,_,g,v,R,O,m,f,w,T,x,D,S,E,M,P,I,b,C,U,N,A,q,V,G){"use strict";const L=1.3,F=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let B;function j(e,t){const r=1e-5,i=S.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?0:r*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=i&&Math.abs(t[1]-e[1])<=i&&Math.abs(t[2]-e[2])<=i&&Math.abs(t[3]-e[3])<=i}e.OverlayManager=class extends r{constructor(e){super(e),this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=s("esri-mobile")?2048:4096,this._animationTimeLast=0}initialize(){const e=this.view;this.renderer=new P.OverlayRenderer({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),e._stage.renderer.plugins.add(this.renderer);const t=()=>this.setDrawTexturesDirty();this._groundIntersector=b.newIntersector(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([o.watch((()=>this.renderer.hasHighlights),t),this.renderer.events.on("has-water",(t=>e._stage?.renderer.setParameters({hasOverlayWater:t}))),this.renderer.events.on("content-changed",t),o.watch((()=>e.state.camera.pixelRatio),t),o.watch((()=>e.state.alignPixelEnabled),t),this.renderer.events.on("textures-disposed",(()=>this.surface.requestRender())),o.watch((()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location]),(()=>this.setPlacementDirty())),o.watch((()=>[e.state?.pixelRatio,e.state?.contentPixelRatio]),(()=>this.setPlacementDirty()),o.sync),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.on("resize",(()=>this.setPlacementDirty())),e.resourceController.scheduler.registerTask(V.TaskPriority.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(V.noBudget,e.camera,I.RenderRequestType.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(I.RenderRequestType.BACKGROUND,e)}))]),e._stage.renderer.renderOverlay=e=>this._renderOverlay(e)}destroy(){this.view?._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.renderOverlay=()=>{}),B&&(B.hide(),B=null),this.renderer=n.destroyMaybe(this.renderer)}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||S.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?R.getReferenceEllipsoid(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return L/this.view.resolutionScale}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}_renderOverlay(e){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._dispatchAnimationUpdate(e),this._drawOverlays(I.RenderRequestType.UPDATE,this.view.state)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new i.Cyclical(-20037508.342787,20037508.342787):new i.Cyclical(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}registerDrapeSource(e,t,r){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const i=this.renderer.createDrapeSourceRenderer(e,t,r);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),i}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,N.SortedRenderGeometryRenderer)}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,I.RenderRequestType.UPDATE)}_updateOverlays(e,t,r){if(!this._spatialReference)return G.Yield;const i=this._computeOverlayResolution(t);this._computeOverlayExtents(t,i,z),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,z.stretch);const s=this._updateOverlay(M.OverlayIndex.INNER,z.inner,i,1*z.pixelRatioAdjustment,z.mapUnitsPerPixel),a=m.width(z.inner)/m.width(z.outer),n=this._updateOverlay(M.OverlayIndex.OUTER,z.outer,i,a*z.pixelRatioAdjustment,z.mapUnitsPerPixel);s!==Z.EXTENT&&n!==Z.EXTENT||(this._drapeSources.forEach((e=>this._updateDrapeSourceExtent(e))),this.surface.updateTileOverlayParams(r)),s===Z.NONE&&n===Z.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,r=e.fullWidth/e.pixelRatio*t,i=e.fullHeight/e.pixelRatio*t,s=Math.ceil(1.5*Math.max(r,i));return Math.min(A.applyTextureResizeModulo(s),this._maxResolution)}_updateOverlay(e,t,r,i,s){if(0===this.renderer.overlays.length)return Z.NONE;const a=this.renderer.overlays[e],n=a.mapUnitsPerPixel;if(a.mapUnitsPerPixel=s,a.pixelRatio=i,j(t,a.extent)&&r===a.resolution)return n===s?Z.NONE:Z.RERENDER_ONLY;m.copy(a.extent,t),a.resolution=r;const o=m.center(a.extent);return a.renderLocalOrigin=C.fromValues(o[0],o[1],0,"OV_"+this._latestOriginId++),Z.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const r=this.renderer.overlays[M.OverlayIndex.INNER],i=this.renderer.overlays[M.OverlayIndex.OUTER],s=e.extent;this._rectInsideRect(r.extent,s)||this._rectanglesOverlap(s,r.extent)||this._rectanglesOverlap(s,i.extent)?(this._setTileOverlayData(s,M.OverlayIndex.INNER,t),this._setTileOverlayData(s,M.OverlayIndex.OUTER,t)):(this._clearTileOverlayData(M.OverlayIndex.INNER,t),this._clearTileOverlayData(M.OverlayIndex.OUTER,t))}else this._clearTileOverlayData(M.OverlayIndex.INNER,t),this._clearTileOverlayData(M.OverlayIndex.OUTER,t)}overlayPixelSizeInMapUnits(e,t){if(0===this.renderer.overlays.length)return t();const r=this.renderer.overlays[M.OverlayIndex.INNER],i=this.renderer.overlays[M.OverlayIndex.OUTER],s=this._pointIsInExtent(e,r.extent)?r:i;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,t,r){if(0===this.renderer.overlays.length)return;const i=this.renderer.overlays[t].extent,s=m.width(i),a=m.height(i);let n=e[0];if(this._longitudeCyclical){n=this._longitudeCyclical.minimalMonotonic(i[0],n);const t=this._longitudeCyclical.minimalMonotonic(i[0],e[2]);n>t&&(n=t-(e[2]-e[0]))}r.setScale(t,m.width(e)/s,m.height(e)/a),r.setOffset(t,(n-i[0])/s,(e[1]-i[1])/a)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){q.removeLoadedShaderModules(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(V.noBudget)}_dispatchAnimationUpdate(e){const t=l.Milliseconds(e-this._animationTimeLast);if(t>=this.surface.view._stage.renderer.animationTimestep||null!=this.view.state.forcedAnimationTime||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const r=l.Milliseconds(t/this.surface.view._stage.renderer.animationTimeDilation),i=new U.UpdateParameters(this.view.state.camera,r,this.view.state.forcedAnimationTime);this.renderer.updateAnimation(i)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,t,r,i){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,K,t,r);if(null==s)return!1;const a=s.origin,n=y.add(Y,s.origin,s.direction);return this._groundIntersector.reset(a,n,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,n),this._groundIntersector.results.min.getIntersectionPoint(i)}_findHorizonBasedPointOfInterest(e,t){let r=.5;const s=.55,n=this.view.renderCoordsHelper.getAltitude(e.eye),o=this.view.pointsOfInterest.centerOnSurfaceFrequent,l=1e-5,c=a.clamp(o.estimatedSurfaceAltitude,e.aboveGround?-1/0:n+l,e.aboveGround?n-l:1/0),d=e.aboveGround;if("global"===this.view.viewingMode){const t=Y;w.closestPointOnSilhouette(w.fromRadius(w.tmpSphere,R.getReferenceEllipsoid(this.view.spatialReference).radius+c),f.wrap(e.eye,e.viewForward),t),y.subtract(t,t,e.eye);const a=i.cyclicalPI.normalize(T.angleAroundAxis(e.viewForward,t,e.viewRight))/e.fovY+.5,n=a<=0||a>=1?.5:s;r=d?n*a:a+n*(1-a)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),i=Math.tan(t),n=v.fromValues(0,i,1,0),o=g.transformMat4(n,n,e.projectionMatrix)[1],l=a.clamp(.5+.5*o,0,1);r=1===l||0===l?.5:d?l*s:1-(1-l)*s}return!!this._intersectGroundFromView(e,.5,r,t)&&y.sqrDist(t,e.eye)<o.distance*o.distance}_computeOverlayExtents(e,t,r){const i=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=_.create();this._findHorizonBasedPointOfInterest(e,s)||y.copy(s,i),S.debugFlags.OVERLAY_SHOW_CENTER?(null==B&&(B=new E.PointGraphics(this.view.graphics,"red")),B.show(s,this._renderSR)):null!=B&&B.hide();const n=Math.max(.1,y.distance(e.eye,s)),o=D.viewAngle(this.view.renderCoordsHelper,i,e.eye);this._overlaySREqualsRenderSR||O.projectVectorToVector(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent,c=!this._isSpherical&&this._spatialReference&&this._spatialReference.isGeographic,d=c&&this._spatialReference?1/R.getReferenceEllipsoid(this._spatialReference).metersPerDegree:1,h=this.view.state.contentPixelRatio,u=e.perScreenPixelRatio/h*n*d;r.mapUnitsPerPixel=u/this._worldToPCSRatio,r.stretch=this._overlayStretch;let v=t*u/2*r.stretch,f=!1,w=c?90:1/0;this._isSpherical&&l&&this._spatialReference&&(this._spatialReference.isWebMercator?(v/=Math.cos(x.y2lat(s[1])),w=l[3]):(f=!0,v/=R.getReferenceEllipsoid(this._spatialReference).metersPerDegree,w=90),v>=w&&(v=w,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let T=1;f&&(T=1/Math.max(.2,Math.cos(Math.abs(a.deg2rad(s[1])))),v*T>180&&(T=180/v),r.mapUnitsPerPixel*=T);const M=Math.log(2)/12;v=Math.exp(Math.round(Math.log(v)/M)*M);const P=v*T,I=32,b=.5*t/(I*P),C=.5*t/(I*v);s[0]=Math.round(s[0]*b)/b,s[1]=Math.round(s[1]*C)/C;const U=r.inner;U[0]=s[0]-P,U[1]=s[1]-v,U[2]=s[0]+P,U[3]=s[1]+v,this._isSpherical&&this._shiftExtentToFitBounds(U,1/0,w);const N=r.outer;if(6*P>m.width(l))m.copy(N,l);else{if(Math.PI/2-Math.abs(o-Math.PI/2)<=.25*Math.PI)N[0]=U[0]-P,N[1]=U[1]-v,N[2]=U[2]+P,N[3]=U[3]+v;else{O.projectVectorToVector(e.eye,this._renderSR,Y,this._spatialReference),p.subtract(H,s,Y);let t=-Math.atan2(H[1],H[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const r=Math.floor(t/(.25*Math.PI));g.scale(H,F[r],2*v),H[0]*=T,H[2]*=T,g.add(N,U,H)}}if(this._isSpherical)N[0]=this._longitudeCyclical.clamp(N[0]),N[2]=this._longitudeCyclical.clamp(N[2]),N[1]=Math.max(N[1],-w),N[3]=Math.min(N[3],w);else{const e=m.intersection(U,l,W),t=m.intersection(N,l,X);m.contains(e,t)&&(N[2]=N[0],N[3]=N[1])}const A=Math.abs(U[2]-U[0])/t;r.mapUnitsPerPixel=Math.max(r.mapUnitsPerPixel,A),r.pixelRatioAdjustment=r.mapUnitsPerPixel/A}_drawOverlays(e,t){if(!this.renderer.hasOverlays)return;if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const r=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const i=this.renderer.computeValidity();this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t);return i!==this.renderer.computeValidity()&&this.surface.updateTileOverlayParams(I.RenderRequestType.UPDATE),r?(this.surface.requestRender(e),e===I.RenderRequestType.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(I.RenderRequestType.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):m.intersects(e,t))}_rectInsideRect(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:m.contains(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const r=e.x,i=e.y;return r>t[0]&&r<t[2]&&i>t[1]&&i<t[3]}_shiftExtentToFitBounds(e,t,r){let i=0,s=0;e[0]<-t?i=e[0]+t:e[2]>t&&(i=t-e[2]),e[1]<-r?s=e[1]+r:e[3]>r&&(s=r-e[3]),m.offset(e,i,s)}get test(){return{renderer:this.renderer,update:()=>this.runTask(V.noBudget)}}},t.__decorate([c.property()],e.OverlayManager.prototype,"_spatialReference",void 0),t.__decorate([c.property({readOnly:!0})],e.OverlayManager.prototype,"running",null),t.__decorate([c.property()],e.OverlayManager.prototype,"_placementDirty",void 0),t.__decorate([c.property()],e.OverlayManager.prototype,"_contentUpdated",void 0),t.__decorate([c.property()],e.OverlayManager.prototype,"_isSpherical",null),t.__decorate([c.property()],e.OverlayManager.prototype,"_worldToPCSRatio",null),t.__decorate([c.property()],e.OverlayManager.prototype,"renderer",void 0),t.__decorate([c.property({constructOnly:!0})],e.OverlayManager.prototype,"view",void 0),t.__decorate([c.property({constructOnly:!0})],e.OverlayManager.prototype,"surface",void 0),t.__decorate([c.property()],e.OverlayManager.prototype,"suspended",null),t.__decorate([c.property()],e.OverlayManager.prototype,"updating",null),t.__decorate([c.property({type:Boolean})],e.OverlayManager.prototype,"rendersOccludedDraped",null),e.OverlayManager=t.__decorate([u.subclass("esri.views.3d.terrain.OverlayManager")],e.OverlayManager);class k{constructor(){this.inner=m.create(),this.outer=m.create(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=L}}const H=v.create(),Y=_.create(),z=new k,W=m.create(),X=m.create(),K=f.create();var Z;!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(Z||(Z={})),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
