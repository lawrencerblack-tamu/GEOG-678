/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/SpatialReference","../../../geometry/support/spatialReferenceUtils","../layers/graphics/ElevationQuery","./ElevationRange"],(function(e,t,n,r,o,s,i,a,l,c,u,h,d,v,p){"use strict";function g(e,t,n,r,o,s,i){for(const a of t){const t=a.getElevation(n,r,o,s,i);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}e.CombinedElevationProvider=class extends(r.EventedMixin(n)){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=o.destroyMaybe(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,n,r,o){if(this._cacheEnabled&&null!=this.lastElevationQuery){const s=this.lastElevationQuery;if(e===s.x&&t===s.y&&n===s.z&&d.equals(r,s.spatialReference)&&o===s.queryContext)return s.result}let s=null;return s=g(s,this._im,e,t,n,r,o),null==s&&(s=g(s,this._ground,e,t,n,r,o)),"scene"===o&&(s=g(s,this._scene,e,t,n,r,o)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:n,spatialReference:r,queryContext:o,result:s}),s}getSphereElevationBounds(e,t,n){const r=new p.ElevationRange;function o(o){for(const s of o)if(s.getSphereElevationBounds){const o=s.getSphereElevationBounds(e,t,n);null!=o&&r.expandElevationRangeValues(o.elevationRangeMin,o.elevationRangeMax)}}return o(this._ground),o(this._im),"scene"===n&&o(this._scene),r}getRootElevationBounds(){const e=new p.ElevationRange;for(const t of[this._im,this._ground,this._scene])t.forEach((t=>{if(t.getRootElevationBounds){const n=t.getRootElevationBounds();null!=n&&e.expandElevationRangeValues(n.elevationRangeMin,n.elevationRangeMax)}}));return e}async queryElevation(e,t,n,r,o,i=null,a=0){const l=this._getElevationQuery(r);try{const s=await l.queryElevation(e,t,i,a);return"scene"===o?g(s,this._scene,e,t,n,r,o):s}catch(c){return s.throwIfAbortError(c),this.getElevation(e,t,n,r,o)}}register(e,t){this.addHandles(t.on("elevation-change",(e=>this.emit("elevation-change",e))),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const n=t.indexOf(e);n>-1&&t.splice(n,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(null!=t&&d.equals(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:n,wkt:r,wkt2:o,latestWkid:s}=e,i=new v.ElevationQuery(this.view.resourceController.scheduler,new h({wkid:n,wkt:r,wkt2:o,latestWkid:s}),(()=>this.view.map?.ground),{maximumAutoTileRequests:4});return this._cachedQuery=i,i}},t.__decorate([i.property({constructOnly:!0})],e.CombinedElevationProvider.prototype,"view",void 0),t.__decorate([i.property()],e.CombinedElevationProvider.prototype,"spatialReference",null),e.CombinedElevationProvider=t.__decorate([u.subclass("esri.views.3d.support.CombinedElevationProvider")],e.CombinedElevationProvider),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
