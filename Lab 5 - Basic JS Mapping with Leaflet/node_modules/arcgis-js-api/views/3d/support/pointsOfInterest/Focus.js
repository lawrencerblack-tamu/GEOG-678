/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../../../../geometry/support/ray","../PropertiesPool","./PointOfInterest","../../webgl-engine/lib/Camera","../../../support/Scheduler","../../../support/Yield"],(function(e,t,r,o,n,i,s,c,a,d,p,l,u,h,y,_,g,P,f,S){"use strict";const m=Array;e.Focus=class extends g.PointOfInterest{constructor(e){super(e),this._propertiesPool=new _.PropertiesPool({location:h,renderLocation:m},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([n.watch((()=>this.centerOnSurface.renderLocation),(()=>this.updateRenderLocation())),n.watch((()=>this.state.contentCamera),(()=>this.updateRenderLocation()))]),this.scheduler&&this.addHandles(this.scheduler.registerTask(f.TaskPriority.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=o.destroyMaybe(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,o=this.renderCoordsHelper,n=this.state.contentCamera;this._dirty=!1,o.worldUpAtPosition(t,L);const i=Math.max(0,(Math.acos(l.dot(L,n.viewForward))-.5*Math.PI)*(n.aboveGround?1:-1));if(Number.isNaN(i)){if(!e||!l.equals(e,t)){const e=this._propertiesPool.get("renderLocation");l.copy(e,t),this._set("renderLocation",e)}return S.Yield}const s=1-r.clamp(i/(.5*Math.PI),0,1),c=s*s*s;this._calculateScreenHorizontalEdgeOnSurface(R);const a=this._propertiesPool.get("renderLocation");return l.lerp(a,t,R,c),e&&l.equals(e,a)||this._set("renderLocation",a),S.Yield}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,r=t.getRenderCenter(i.createRenderScreenPointArray3());if(r[1]=t.aboveGround?t.padding[P.PaddingSide.BOTTOM]:t.fullHeight-t.padding[P.PaddingSide.TOP],this.estimateSurfaceIntersectionAtRenderPoint(r,e))return e;const o=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(r,O)){l.subtract(O,O,t.eye);const r=l.normalize(O,O);if(this.renderCoordsHelper.intersectInfiniteManifold(y.wrap(t.eye,r),o,e))return e}return this.renderCoordsHelper.setAltitude(e,o,t.eye)}updateRenderLocation(){this._dirty=!0}},t.__decorate([s.property()],e.Focus.prototype,"_dirty",void 0),t.__decorate([s.property({constructOnly:!0})],e.Focus.prototype,"scheduler",void 0),t.__decorate([s.property({constructOnly:!0})],e.Focus.prototype,"centerOnSurface",void 0),t.__decorate([s.property({constructOnly:!0})],e.Focus.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),t.__decorate([s.property()],e.Focus.prototype,"updating",null),t.__decorate([s.property()],e.Focus.prototype,"location",null),t.__decorate([s.property()],e.Focus.prototype,"renderLocation",void 0),t.__decorate([s.property()],e.Focus.prototype,"worldUnitsPerContentPixel",null),e.Focus=t.__decorate([p.subclass("esri.views.3d.support.pointsOfInterest.Focus")],e.Focus);const L=u.create(),O=u.create(),R=u.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
