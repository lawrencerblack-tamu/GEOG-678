/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../Graphic","../../../core/typedArrayUtil","../../../core/workers/WorkerHandle","../../../geometry/SpatialReference","../../../layers/support/Field"],(function(e,r,t,s,o,n){"use strict";class a{constructor(e){this._controller=e,this._handle=new i((r=>e.schedule(r)))}destroy(){this._handle.destroy()}invoke(e,t){return e.buffer&&0!==e.buffer.byteLength?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof o&&(e.options={...e.options,sourceSpatialReference:e.options.sourceSpatialReference.toJSON()}),this._handle.invoke(e,t).then((e=>{let t=0,s=0;const a=o.fromJSON(e.spatialReference);e.spatialReference=a;const i=async o=>{const l=e.fields;if(l)for(;t<l.length;)if(l[t]=n.fromJSON(l[t]),t++,o.madeProgress())return this._controller.reschedule((e=>i(e)));const p=e.features;for(;s<p.length;){const e=p[s];++s,e.uid=r.generateUID();const t=e.geometry;if(null!=t&&(t.spatialReference=a,c(t),o.madeProgress()))return this._controller.reschedule((e=>i(e)))}return e};return this._controller.schedule((e=>i(e)))}))):Promise.resolve(null)}}function c(e){switch(e.type){case"polyline":e.paths.reduce(((e,r)=>e+r.length),0)<t.nativeArrayMaxSize&&(e.paths=e.hasZ||e.hasM?e.paths.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.paths.map((e=>e.map((e=>[e[0],e[1]])))));break;case"polygon":e.rings.reduce(((e,r)=>e+r.length),0)<t.nativeArrayMaxSize&&(e.rings=e.hasZ||e.hasM?e.rings.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.rings.map((e=>e.map((e=>[e[0],e[1]])))))}}class i extends s.WorkerHandle{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:e=>[e.buffer]},e)}}e.PBFDecoder=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
