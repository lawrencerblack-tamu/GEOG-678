/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../layers/support/layerUtils","../terrain/LayerClass","../../support/hitTestSelectUtils"],(function(e,a,t,r){"use strict";async function s(e,t){const{results:s,ground:o}=await r.hitTestSelectSimilarDistance(e,t),y=(!o.layer||!a.isIntegratedMeshLayer(o.layer.type))&&o.mapPoint,c=[],p=l(e),u=y?n(e,p):i;let d=0,f=0;const h=()=>{const e=u.layerViews[f];y&&e&&"fetchPopupFeaturesAtLocation"in e&&c.push({mapPoint:o.mapPoint,layerView:e}),++f};let w=null;for(;d<s.length||f<u.layerViews.length;){const a=s[d];if(a&&"graphic"!==a.type)++d;else if("scene"!==a?.layer?.type||a?.layer?.parent!==e?.map?.basemap)if(a){const e=a.layer?.uid,t=u.layerUids.has(e)&&a.distance===o.distance,r=p.get(a.layer?.uid);if(w??=a.mapPoint,f<u.layerViews.length&&(t||(a.distance??0)>o.distance)&&u.layerViews[f]!==r){h();continue}c.push({graphic:a.graphic,layerView:r}),++d}else h();else++d}return w??=o.mapPoint,{hits:c,location:w}}function n(e,a){const r=new Set,s=[];for(let i=e.basemapTerrain.numLayers(t.LayerClass.MAP)-1;i>=0;i--){const a=e.basemapTerrain.layerViewByIndex(i,t.LayerClass.MAP);r.add(a.layer.uid),s.push(a)}const n=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:t}of n){const e=a.get(t);e&&(r.add(t),s.push(e))}return s.reverse(),{layerUids:r,layerViews:s}}const i={layerUids:new Set,layerViews:[]};function l(e){const a=new Map;for(const t of e.allLayerViews){const e=t.layer.uid;a.set(e,t)}return a}e.popupHitTest=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
