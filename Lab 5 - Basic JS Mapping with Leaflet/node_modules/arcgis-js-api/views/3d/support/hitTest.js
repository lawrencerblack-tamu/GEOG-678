/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../geometry","../../../Graphic","../../../core/iteratorUtils","../../../core/screenUtils","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/projection/projectVectorToVector","../../../layers/LayerConstants","../../../layers/support/layerUtils","./debugFlags","./ElevationProvider","../webgl-engine/lib/Intersector","../webgl-engine/lib/IntersectorInterfaces","../webgl-engine/lib/intersectorUtils","../webgl-engine/lib/intersectorUtilsConversions","../webgl-engine/lib/verticalOffsetUtils","../../../geometry/SpatialReference","../../../geometry/Point"],(function(e,t,n,r,i,c,o,s,l,a,u,d,p,g,f,y,h,I){"use strict";async function b(e,t,n,r){const c=n?T(e,n):r,o=i.createScreenPointArray(t.x,t.y);c.requiresGroundFeedback=!0,c.enableDraped=!0;const s=d.newIntersector(e.state.viewingMode);s.options.selectionMode=!0,s.options.store=p.StoreResults.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(o,s,c);const u=S(e,s.results.all,c.graphics),y=s.results.ground,h=f.toOwner(y,e),I=null!=h&&"type"in h&&l.isIntegratedMeshLayer(h.type)?h:null,b={screenPoint:t,results:u,ground:{mapPoint:w(e,y),distance:g.isValidIntersectorResult(y)?y.distanceInRenderSpace:0,layer:I}};return a.debugFlags.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(b.intersector=s),b}function U(e,t,n,r){const c=n?T(e,n):r,o=null!=c.graphics&&(null!=c.graphics.include||null!=c.graphics.exclude),s=i.screenPointObjectToArray(t);c.enableDraped=c.include&&!c.include.has(y.terrainId)||c.exclude&&c.exclude.has(y.terrainId);const l=e.sceneIntersectionHelper,a=d.newIntersector(e.state.viewingMode);if(a.options.selectionMode=!0,a.options.store=o?p.StoreResults.ALL:p.StoreResults.MIN,a.options.hud=!n?.excludeHud,l.intersectIntersectorScreen(s,a,c),o){for(const t of a.results.all){const n=f.toHit(t,e);if(null==n)return w(e,t);if("graphic"!==n.type||m(c.graphics,n.graphic))return w(e,t)}return null}return w(e,a.results.min)}function S(e,t,n){const r=new Array;let i=null;for(let c=0;c<t.length;c++){const o=t[c],s=f.toOwner(o,e);if(null!=s&&(s===e.map.ground||"type"in s&&l.isIntegratedMeshLayer(s.type)))break;const a=f.toHit(o,e);if(null==a)continue;if("graphic"===a.type){if(null==i&&c!==t.length-1&&(i=new Set),null!=i){const e=E(a.graphic);if(i.has(e))continue;i.add(e)}if(!m(n,a.graphic))continue}const u=w(e,o),d=o.distanceInRenderSpace;if("media"===a.type){const e=a.element.toSource(u);r.push({...a,mapPoint:u,distance:d,sourcePoint:e})}else r.push({...a,mapPoint:u,distance:d})}return r}function w(e,t,n){return t.getIntersectionPoint(V)?(n=R(e,V,n),t.intersector===p.IntersectorType.TERRAIN&&e.basemapTerrain&&(n.z=u.getElevationAtPoint(e.basemapTerrain,n)??0),n):null}function E(e){const t=e.sourceLayer,n=e.layer,r=t&&"objectIdField"in t?t:n&&"objectIdField"in n?n:t;if(r){const t=r.objectIdField??s.fallbackObjectIDAttribute,n=e.attributes?.[t];if(n)return`o-${r.id}-${n}`}return`u-${e.uid}`}function m(e,t){const n=E(t);return null==e||(null==e.include||e.include.has(n))&&(null==e.exclude||!e.exclude.has(n))}function R(e,t,n){let r=e.spatialReference||h.WGS84;return o.projectVectorToVector(t,e.renderSpatialReference,V,r)?t=V:(r=h.WGS84,o.projectVectorToVector(t,e.renderSpatialReference,V,r)&&(t=V)),n?(n.x=t[0],n.y=t[1],n.z=t[2],n.spatialReference=r):n=new I(t,r),n}function T(e,t){const n=L(e,t.include,v.INCLUDE),r=L(e,t.exclude,v.EXCLUDE);return{include:n.layerUids,exclude:r.layerUids,graphics:{include:n.graphicUids,exclude:r.graphicUids}}}function L(e,t,i,c={layerUids:void 0,graphicUids:void 0}){if(!t)return c;if(t instanceof n)P(c,E(t)),i===v.INCLUDE&&(null!=e.graphicsView&&t.layer===e?x(c,e.graphicsView.processor.layer.id):t.layer&&x(c,t.layer.uid));else if(r.isIterable(t))for(const n of t)n===e.graphics&&null!=e.graphicsView?x(c,e.graphicsView.processor.layer.id):n===e.map.ground?x(c,y.terrainId):L(e,n,i,c);else"uid"in t&&x(c,t.uid);return c}function x(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function P(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}const V=c.create();var v;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(v||(v={})),e.computeMapPointFromVec3d=R,e.externalToInternalIntersectOptions=T,e.getGraphicFilterUid=E,e.hitTest=b,e.intersectResultToMapPoint=w,e.toMap=U,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
