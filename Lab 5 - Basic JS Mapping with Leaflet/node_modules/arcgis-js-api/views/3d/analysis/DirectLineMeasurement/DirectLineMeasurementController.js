/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Logger","../../../../core/quantityUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/geometryEngine","../../../../geometry/Polyline","../../../../geometry/projection","../../../../geometry/SpatialReference","../../../../geometry/spatialReferenceEllipsoidUtils","../../../../geometry/projection/projectPointToVector","../../../../geometry/projection/projectPointToWGS84ComparableLonLat","../../../../geometry/support/geodesicUtils","../interfaces","../support/projectionUtils","../support/UnitNormalizer","../../../support/geodesicMeasurementUtils"],(function(e,t,i,o,r,n,a,s,c,l,p,d,u,h,m,g,v,P,y,_,D,L,f,w){"use strict";e.DirectLineMeasurementController=class extends i{constructor(e){super(e),this._unitNormalizer=new f.UnitNormalizer,this._tempStartPosition=d.create(),this._tempEndPosition=d.create(),this._tempCornerPosition=d.create()}initialize(){const e=this.view.spatialReference,t=v.getSphericalPCPF(e),i=t===v.SphericalECEFSpatialReference?v.WGS84ECEFSpatialReference:t;this._sphericalPCPF=i;const o=m.canProjectWithoutEngine(e,i);this._unitNormalizer.spatialReference=o?i:e,this.addHandles([n.watch((()=>({viewData:this.viewData,startPoint:this.analysis.startPoint})),(({viewData:e,startPoint:t})=>{e.elevationAlignedStartPoint=this._applyProjectionAndElevationAlignment(t)}),n.syncAndInitial),n.watch((()=>({viewData:this.viewData,endPoint:this.analysis.endPoint})),(({viewData:e,endPoint:t})=>{e.elevationAlignedEndPoint=this._applyProjectionAndElevationAlignment(t)}),n.syncAndInitial),n.watch((()=>({result:this._computedResult,viewData:this.viewData})),(({result:e,viewData:t})=>{t.result=e}),n.syncAndInitial)])}_applyProjectionAndElevationAlignment(e){if(null==e)return e;const{spatialReference:t,elevationProvider:i}=this.view,r=L.applyProjectionAndElevationAlignment(e,t,i);return r??(L.logFailedGeometryProjectionError(this.analysis,e.spatialReference,o.getLogger(this)),null)}get _computedResult(){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,measurementMode:i}=this.viewData;if(null==e||null==t)return null;const o=this._euclideanDistances(e,t),r=this._geodesicDistance(e,t);let n,a;switch(i){case D.MeasurementMode.Auto:a=null!=r?"geodesic":"euclidean",n=r??o.horizontal;break;case D.MeasurementMode.Geodesic:if(null==r)return null;a="geodesic",n=r;break;case D.MeasurementMode.Euclidean:a="euclidean",n=o.horizontal}return{mode:a,directDistance:o.direct,horizontalDistance:n,verticalDistance:o.vertical,distance:i===D.MeasurementMode.Euclidean||o.horizontal.value<=w.geodesicDistanceThreshold?o.direct:r??o.horizontal}}_euclideanDistances(e,t){const i=e.clone();i.z=t.z;const o=this._tempStartPosition,n=this._tempEndPosition,a=this._tempCornerPosition,s=this.view.spatialReference,c=this._sphericalPCPF,l=m.canProjectWithoutEngine(s,c)?c:s;P.projectPointToVector(e,o,l),P.projectPointToVector(t,n,l),P.projectPointToVector(i,a,l);const d=p.distance(o,n),u=p.distance(a,n),h=Math.abs(t.z-e.z),g=e=>this._unitNormalizer.normalizeDistance(e),v=g(d),y=g(u),_=g(h);return{direct:r.createLength(v,"meters"),horizontal:r.createLength(y,"meters"),vertical:r.createLength(_,"meters")}}_geodesicDistance(e,t){const{spatialReference:i}=e,o=new h({spatialReference:i});o.addPath([e,t]);const n=i.isGeographic&&_.isSupported(i)?_.geodesicLengths([o],"meters")[0]:i.isWebMercator?u.geodesicLength(o,"meters"):null,a=null!=n?n:this._fallbackGeodesicDistance(e,t);return null!=a?r.createLength(a,"meters"):null}_fallbackGeodesicDistance(e,t){if(y.projectPointToWGS84ComparableLonLat(e,M)&&y.projectPointToWGS84ComparableLonLat(t,S)){const e=new _.InverseGeodeticSolverResult;return _.inverseGeodeticSolver(e,M,S,g.WGS84),e.distance}return null}},t.__decorate([a.property()],e.DirectLineMeasurementController.prototype,"view",void 0),t.__decorate([a.property()],e.DirectLineMeasurementController.prototype,"analysis",void 0),t.__decorate([a.property()],e.DirectLineMeasurementController.prototype,"viewData",void 0),t.__decorate([a.property()],e.DirectLineMeasurementController.prototype,"_computedResult",null),e.DirectLineMeasurementController=t.__decorate([l.subclass("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementController")],e.DirectLineMeasurementController);const M=d.create(),S=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
