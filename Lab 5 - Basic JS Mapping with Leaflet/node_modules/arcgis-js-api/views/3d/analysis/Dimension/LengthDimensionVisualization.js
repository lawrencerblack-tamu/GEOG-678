/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Handles","../../../../core/lang","../../../../core/maybe","../../../../core/quantityFormatUtils","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","./lengthDimensionUtils","./settings","../../interactive/visualElements/LabelVisualElement","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/MarkerVisualElement","../../interactive/visualElements/support/Segment"],(function(e,t,s,n,i,l,a,m,o,r,f,c,d,u){"use strict";class S{set visible(e){for(const t of this._visualElements.values())t.attached=e}constructor(e){this.destroyed=!1,this._handles=new t,this._messages=null,this._labelSegment=new u.EuclideanSegment;const{analysis:n,computation:i,view:m,messages:o,isDecoration:r}=e;this.analysis=n,this.computation=i,this.view=m,this._messages=o;const S=e.visible,h={view:m,attached:S,isDecoration:r},{fontSize:g,textColor:b,textBackgroundColor:v}=n.style;this._visualElements=new p({marker:new d.MarkerVisualElement(h,e.markerMaterial),dimension:new c.LineVisualElement(h,e.dimensionLineMaterial),startOffset:new c.LineVisualElement(h,e.offsetLineMaterial),endOffset:new c.LineVisualElement(h,e.offsetLineMaterial),dimensionSmall:new c.LineVisualElement(h,e.smallDimensionLineMaterial),startOffsetSmall:new c.LineVisualElement(h,e.smallOffsetLineMaterial),endOffsetSmall:new c.LineVisualElement(h,e.smallOffsetLineMaterial),label:new f.LabelVisualElement({view:m,attached:S,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:a.pt2px(g),textColor:b.clone(),backgroundColor:v.clone(),isDecoration:r})}),this._handles.add([l.watch((()=>i.geometry),(e=>{this.updateCameraDependentElements(m.state.camera,e,n.style),null!=i.geometry&&this._updateLines(i.geometry)}),{...l.initial,equals:s.equals}),l.watch((()=>i.length),(e=>this._updateLabelContent(e)),l.initial)])}destroy(){this.destroyed=!0,this._handles=n.destroyMaybe(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const t=o.computeSpanningSegment(h,o.OffsetSegmentLocation.Start,e.directSegment,e.dimensionSegment),s=o.computeSpanningSegment(g,o.OffsetSegmentLocation.End,e.directSegment,e.dimensionSegment),n=this._visualElements;n.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),n.dimension.setGeometryFromSegment(e.dimensionSegment),n.startOffset.setGeometryFromSegment(t),n.endOffset.setGeometryFromSegment(s),n.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),n.startOffsetSmall.setGeometryFromSegment(t),n.endOffsetSmall.setGeometryFromSegment(s)}updateCameraDependentElements(e,t,s){const n=this._visualElements;if(null==t){for(const e of n.values())e.visible=!1;return}const i=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,b)),l=o.maxScreenLengthSquaredFromGeometry(t,i),m=l<(a.pt2px(s.lineSize)*r.smallScreenLengthLineSizeFactor)**2,f=!m;n.marker.visible=f,n.dimension.visible=f,n.startOffset.visible=f,n.endOffset.visible=f,n.dimensionSmall.visible=m,n.startOffsetSmall.visible=m,n.endOffsetSmall.visible=m;const c=a.pt2px(s.fontSize)*r.minScreenLengthFontSizeFactor,{label:d}=n;if(d.visible=l>=c**2,!d.visible)return;const{dimensionSegment:u,primaryOffsetAxis:S}=t,{offset:h}=this.computation.dimension,g=(Math.sign(h)>=0?1:-1)*this._labelOffsetPx(s)*i;o.offsetSegment(this._labelSegment,u,S,g),d.updateLabelPosition()}updateLabelStyle(e){const{label:t}=this._visualElements;t.fontSize=a.pt2px(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)}_updateLabelContent(e){const{label:t}=this._visualElements;null!=e&&null!=this._messages?t.text=i.formatDecimal(this._messages,e,e.unit):t.text=""}_labelOffsetPx(e){return 1.5*a.pt2px(e.fontSize)+r.labelMarginPx+a.pt2px(e.lineSize/2)}}const h=new u.EuclideanSegment,g=new u.EuclideanSegment,b=m.create();class p{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}e.LengthDimensionVisualElements=p,e.LengthDimensionVisualization=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
