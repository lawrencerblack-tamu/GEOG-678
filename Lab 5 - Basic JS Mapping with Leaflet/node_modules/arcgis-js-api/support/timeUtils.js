/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../TimeExtent","../core/arrayUtils","../core/lang","../core/timeUtils","../webmap/utils"],(function(t,e,n,i,r,l){"use strict";function s(t){return void 0!==t.timeInfo}async function u(t,e){const{fullTimeExtent:n}=t.widgets?.timeSlider??{};return n||m(t.allLayers,e)}function o(t){const e=t.numThumbs??2,n=t.currentTimeExtent;if(n){const{start:t,end:i}=n;return null!=t&&null!=i&&t.getTime()===i.getTime()?"instant":2===e?"time-window":null==t||0===t.getTime()?"cumulative-from-start":"cumulative-from-end"}return 2===e?"time-window":"cumulative-from-start"}function a(t){const{numStops:e,stopInterval:n,stops:r}=t;return r?{dates:i.clone(r)}:n?{interval:n.clone()}:{count:e??5}}async function m(t,i){if(0===t.length)return e.allTime;const r=t.filter(s);await Promise.all(r.map((t=>t.load({signal:i}))));const l=[],u=[];for(const e of r)"feature"!==e?.type&&"map-image"!==e?.type||!e.timeInfo?.hasLiveData?u.push(e):l.push(e);const o=t=>null==t||t.isAllTime,a=u.map((t=>t.timeInfo?.fullTimeExtent));if(a.some(o))return e.allTime;const m=l.map((async t=>{const{timeExtent:e}=await t.fetchRecomputedExtents({signal:i});return e||t.timeInfo?.fullTimeExtent})),f=(await Promise.allSettled(m)).map((t=>"fulfilled"===t.status?t.value:null));if(f.some(o))return e.allTime;return[...f,...a].filter(n.isSome).reduce(((t,e)=>t.union(e)))}function f(t,n){const i=t.currentTimeExtent;if(!i)return null;const{start:r,end:l}=i,s=r??l??null;switch(n){case"time-window":return new e({start:r,end:l});case"cumulative-from-start":return new e({start:null,end:s});case"cumulative-from-end":return new e({start:s,end:null});case"instant":return new e({start:s,end:s})}}async function c(t,e){if(null==t||!l.isWebMap(t))return null;await t.load({signal:e});const n=t?.widgets?.timeSlider;if(!n)return null;const i=await u(t,e),r=n.loop,s=o(n);return{fullTimeExtent:i,loop:r,mode:s,playRate:n.stopDelay??2e3,stops:a(n),timeExtent:f(n,s)}}function d(t){if(!t)return t;const{start:n,end:i}=t;return new e({start:null!=n?r.offsetDate(n,-n.getTimezoneOffset(),"minutes"):n,end:null!=i?r.offsetDate(i,-i.getTimezoneOffset(),"minutes"):i})}function T(t){if(!t)return t;const{start:n,end:i}=t;return new e({start:null!=n?r.offsetDate(n,n.getTimezoneOffset(),"minutes"):n,end:null!=i?r.offsetDate(i,i.getTimezoneOffset(),"minutes"):i})}t.getTimeExtentFromLayers=m,t.getTimeSliderSettingsFromWebMap=c,t.toLocalTimeExtent=T,t.toUTCTimeExtent=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
