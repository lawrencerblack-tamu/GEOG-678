/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../core/BidiText","../../core/has","../../core/lang","../../core/Logger","../../core/RandomLCG","../../core/screenUtils","../../geometry/support/aaBoundingRect","../../geometry/support/boundsUtils","../Font","./CIMPlacements","./CIMSymbolDrawHelper","./defaultCIMValues","./enums","./utils","../support/defaults","../../views/2d/engine/vectorTiles/GeometryUtils","../../views/2d/engine/webgl/definitions","../../views/2d/engine/webgl/mesh/templates/shapingUtils"],(function(e,t,r,a,o,i,n,s,l,c,m,f,y,u,h,p,g,S,M){"use strict";const d=Math.PI,b=d/2,C=Math.PI/180,I=96/72,x=4,k=()=>o.getLogger("esri.symbols.cim.CIMSymbolHelper");function P(e){let t;switch(e.type){case"cim":return e.data;case"web-style":return e;case"simple-marker":{const r=D.fromSimpleMarker(e);if(!r)throw new Error("InternalError: Cannot convert symbol to CIM");t=r;break}case"picture-marker":t=D.fromPictureMarker(e);break;case"simple-line":t=D.fromSimpleLineSymbol(e);break;case"simple-fill":t=D.fromSimpleFillSymbol(e);break;case"picture-fill":t=D.fromPictureFillSymbol(e);break;case"text":t=D.fromTextSymbol(e)}return{type:"CIMSymbolReference",symbol:t}}function w(e,t,r){switch(t.type){case"CIMSymbolReference":return w(e,t.symbol,r);case"CIMPointSymbol":null==r&&(r={x:0,y:0}),e.drawSymbol(t,r);break;case"CIMLineSymbol":null==r&&(r={paths:[[[0,0],[10,0]]]}),e.drawSymbol(t,r);break;case"CIMPolygonSymbol":null==r&&(r={rings:[[[0,0],[0,10],[10,10],[10,0],[0,0]]]}),e.drawSymbol(t,r);break;case"CIMTextSymbol":{const r={x:0,y:0};e.drawSymbol(t,r);break}case"CIMVectorMarker":{const r=new m.Placement;e.drawMarker(t,r);break}}return e.envelope()}function L(e){if(!e)return 0;switch(e.type){case"CIMMarkerPlacementAlongLineSameSize":case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAtExtremities":case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementAtRatioPositions":case"CIMMarkerPlacementOnLine":case"CIMMarkerPlacementOnVertices":return Math.abs(e.offset);default:return 0}}function F(e){if(!e)return 0;switch(e.type){case"CIMGeometricEffectArrow":return Math.abs(.5*e.width);case"CIMGeometricEffectBuffer":return Math.abs(e.size);case"CIMGeometricEffectExtension":case"CIMGeometricEffectRadial":return Math.abs(e.length);case"CIMGeometricEffectJog":return Math.abs(.5*e.length);case"CIMGeometricEffectMove":return Math.max(Math.abs(h.getValue(e.offsetX)),Math.abs(h.getValue(e.offsetY)));case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":return Math.abs(e.offset);case"CIMGeometricEffectRegularPolygon":return Math.abs(e.radius);case"CIMGeometricEffectRotate":case"CIMGeometricEffectScale":default:return 0;case"CIMGeometricEffectTaperedPolygon":return.5*Math.max(Math.abs(e.fromWidth),Math.abs(e.toWidth));case"CIMGeometricEffectWave":return Math.abs(e.amplitude);case"CIMGeometricEffectDonut":return Math.abs(e.width)}}function E(e){if(!e)return 0;let t=0;for(const r of e)t+=F(r);return t}class T{static getSymbolInflateSize(e,t,r,a,o){return e||(e=[0,0,0,0]),t?this._getInflateSize(e,t,r,a,o):e}static safeSize(e){const t=Math.max(Math.abs(e[0]),Math.abs(e[2])),r=Math.max(Math.abs(e[1]),Math.abs(e[3]));return Math.sqrt(t*t+r*r)}static _vectorMarkerBounds(e,t,r,a){let o=!0;const i=s.create();if(t?.markerGraphics)for(const n of t.markerGraphics){const t=[0,0,0,0];n.geometry&&(l.getBoundsXY(i,n.geometry),t[0]=0,t[1]=0,t[2]=0,t[3]=0,this.getSymbolInflateSize(t,n.symbol,r,0,a),i[0]+=t[0],i[1]+=t[1],i[2]+=t[2],i[3]+=t[3],o?(e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],o=!1):(e[0]=Math.min(e[0],i[0]),e[1]=Math.min(e[1],i[1]),e[2]=Math.max(e[2],i[2]),e[3]=Math.max(e[3],i[3])))}return e}static _getInflateSize(e,t,r,a,o){if(Y(t)){const i=this._getLayersInflateSize(e,t.symbolLayers,r,a,o),n=E(t.effects);return n>0&&(i[0]-=n,i[1]-=n,i[2]+=n,i[3]+=n),i}return this._getTextInflatedSize(e,t,o)}static _getLayersInflateSize(e,t,r,a,o){let i=!0;if(!t)return e;for(const n of t){if(!n)continue;let t=[0,0,0,0];switch(n.type){case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":{const e=n;let r=e.width;null!=r&&(e.capStyle===u.LineCapStyle.Square||e.joinStyle===u.LineJoinStyle.Miter?r/=1.4142135623730951:r/=2,t[0]=-r,t[1]=-r,t[2]=r,t[3]=r);break}case"CIMCharacterMarker":case"CIMVectorMarker":case"CIMPictureMarker":{const e=n;if("CIMVectorMarker"===n.type){const e=n;if(t=this._vectorMarkerBounds(t,e,r,o),e.frame){const r=(e.frame.xmin+e.frame.xmax)/2,a=(e.frame.ymin+e.frame.ymax)/2;if(t[0]-=r,t[1]-=a,t[2]-=r,t[3]-=a,null!=e.size){const r=e.size/(e.frame.ymax-e.frame.ymin);t[0]*=r,t[1]*=r,t[2]*=r,t[3]*=r}}}else if("CIMPictureMarker"===n.type){const a=n,o=r.getResource(a.url);let i=1;if(null!=o&&o.height&&(i=o.width/o.height),null!=e.size){const r=e.size/2,o=e.size*i*a.scaleX/2;t=[-o,-r,o,r]}}else if(null!=e.size){const r=e.size/2;t=[-r,-r,r,r]}if(e.anchorPoint){let r,a;"Absolute"===e.anchorPointUnits?(r=e.anchorPoint.x,a=e.anchorPoint.y):(r=e.anchorPoint.x*(t[2]-t[0]),a=e.anchorPoint.y*(t[3]-t[1])),t[0]-=r,t[1]-=a,t[2]-=r,t[3]-=a}let i=h.getValue(e.rotation);if(e.rotateClockwise&&(i=-i),a&&(i-=a),i){const e=C*i,r=Math.cos(e),a=Math.sin(e),o=s.create([g.cInfinity,g.cInfinity,-g.cInfinity,-g.cInfinity]);s.expandPointInPlace(o,[t[0]*r-t[1]*a,t[0]*a+t[1]*r]),s.expandPointInPlace(o,[t[0]*r-t[3]*a,t[0]*a+t[3]*r]),s.expandPointInPlace(o,[t[2]*r-t[1]*a,t[2]*a+t[1]*r]),s.expandPointInPlace(o,[t[2]*r-t[3]*a,t[2]*a+t[3]*r]),t=o}let l=h.getValue(e.offsetX),c=h.getValue(e.offsetY);if(a){const e=C*a,t=Math.cos(e),r=Math.sin(e),o=l*r+c*t;l=l*t-c*r,c=o}t[0]+=l,t[1]+=c,t[2]+=l,t[3]+=c;const m=L(e.markerPlacement);m>0&&(t[0]-=m,t[1]-=m,t[2]+=m,t[3]+=m);break}}const l=E(n.effects);l>0&&(t[0]-=l,t[1]-=l,t[2]+=l,t[3]+=l),i?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],i=!1):(e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[2]),e[3]=Math.max(e[3],t[3]))}return e}static _getTextInflatedSize(e,t,r){const a=t.height??y.defaultCIMValues.CIMTextSymbol.height;if(e[0]=-a/2,e[1]=-a/2,e[2]=a/2,e[3]=a/2,!r)return e;const o=r.get(t);if(!o)return e;if(!o.glyphMosaicItems.glyphs.length)return e;const{lineGapType:i,lineGap:n}=t,s=i?f.lineGapType2LineHeight(i,n??0,a):0,l="CIMBackgroundCallout"===t.callout?.type,c=M.shapeGlyphs(o.glyphMosaicItems,{scale:a/S.glyphSize,angle:h.getValue(t.angle),xOffset:h.getValue(t.offsetX),yOffset:h.getValue(t.offsetY),horizontalAlignment:t.horizontalAlignment,verticalAlignment:t.verticalAlignment,maxLineWidth:512,lineHeight:S.magicLabelLineHeight*Math.max(.25,Math.min(s||1,4)),decoration:t.font.decoration||"none",useCIMAngleBehavior:!0,hasBackground:l}).boundsT;return e[0]=c.x-c.halfWidth,e[1]=-c.y-c.halfHeight,e[2]=c.x+c.halfWidth,e[3]=-c.y+c.halfHeight,e}}class D{static getEnvelope(e,t,r){if(!e)return null;const a=new f.EnvDrawHelper(r);if(Array.isArray(e)){let r;for(const o of e)r?r.union(w(a,o,t)):r=w(a,o,t);return r}return w(a,e,t)}static getTextureAnchor(e,t){const r=this.getEnvelope(e,null,t);if(!r)return[0,0,0];const a=(r.x+.5*r.width)*I,o=(r.y+.5*r.height)*I,i=r.width*I+2,n=r.height*I+2;return[-a/i,-o/n,n]}static rasterize(e,t,r,a,o=!0){const i=r||this.getEnvelope(t,null,a);if(!i)return[null,0,0,0,0];const n=(i.x+.5*i.width)*I,s=(i.y+.5*i.height)*I;e.width=i.width*I,e.height=i.height*I,r||(e.width+=2,e.height+=2);const l=e.getContext("2d",{willReadFrequently:!0}),c=f.Transformation.createScale(I,-I);c.translate(.5*e.width-n,.5*e.height+s);const y=new f.CanvasDrawHelper(l,a,c);switch(t.type){case"CIMPointSymbol":{const e={type:"point",x:0,y:0};y.drawSymbol(t,e);break}case"CIMVectorMarker":{const e=new m.Placement;y.drawMarker(t,e);break}}const u=l.getImageData(0,0,e.width,e.height),h=new Uint8Array(u.data);if(o){let e;for(let t=0;t<h.length;t+=4)e=h[t+3]/255,h[t]=h[t]*e,h[t+1]=h[t+1]*e,h[t+2]=h[t+2]*e}return[h,e.width,e.height,-n/e.width,-s/e.height]}static fromTextSymbol(e){const{text:t}=e;return{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,anchorPointUnits:"Relative",dominantSizeAxis3D:"Y",size:10,billboardMode3D:"FaceNearPlane",frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:D.createCIMTextSymbolfromTextSymbol(e),textString:t}],scaleSymbolsProportionally:!0,respectFrame:!0}],scaleX:1,angleAlignment:"Display"}}static fromPictureFillSymbol(e){const{height:t,outline:r,width:a,xoffset:o,xscale:i,yoffset:n,yscale:s}=e,l=[],c={type:"CIMPolygonSymbol",symbolLayers:l};if(r){const e=q(r);e&&l.push(e)}let m=e.url;"esriPFS"===e.type&&e.imageData&&(m=e.imageData);const f="angle"in e?e.angle??0:0,y=(a??0)*(i||1),p=(t??0)*(s||1);return l.push({type:"CIMPictureFill",invertBackfaceTexture:!1,scaleX:1,textureFilter:u.TextureFilter.Picture,tintColor:null,url:m,height:p,width:y,offsetX:h.getValue(o),offsetY:h.getValue(n),rotation:h.getValue(-f),colorSubstitutions:null}),c}static fromSimpleFillSymbol(e){const{color:t,style:r,outline:o}=e,i=[],s={type:"CIMPolygonSymbol",symbolLayers:i};if(o){const e=q(o);e&&i.push(e)}if(r&&"solid"!==r&&"none"!==r&&"esriSFSSolid"!==r&&"esriSFSNull"!==r){const e={type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",color:A(t),capStyle:u.LineCapStyle.Butt,joinStyle:u.LineJoinStyle.Miter,width:.75}]};let o=0;const s=n.px2pt(O(r)?8:10);switch(r){case"vertical":case"esriSFSVertical":o=90;break;case"forward-diagonal":case"esriSFSForwardDiagonal":case"diagonal-cross":case"esriSFSDiagonalCross":o=-45;break;case"backward-diagonal":case"esriSFSBackwardDiagonal":o=45;break;case"cross":case"esriSFSCross":o=0}i.push({type:"CIMHatchFill",lineSymbol:e,offsetX:0,offsetY:0,rotation:o,separation:s}),"cross"===r||"esriSFSCross"===r?i.push({type:"CIMHatchFill",lineSymbol:a.clone(e),offsetX:0,offsetY:0,rotation:90,separation:s}):"diagonal-cross"!==r&&"esriSFSDiagonalCross"!==r||i.push({type:"CIMHatchFill",lineSymbol:a.clone(e),offsetX:0,offsetY:0,rotation:45,separation:s})}else!r||"solid"!==r&&"esriSFSSolid"!==r||i.push({type:"CIMSolidFill",enable:!0,color:A(t)});return s}static fromSimpleLineSymbol(e){const{cap:t,color:r,join:a,marker:o,miterLimit:i,style:n,width:s}=e;let l=null;"solid"!==n&&"none"!==n&&"esriSLSSolid"!==n&&"esriSLSNull"!==n&&(l=[{type:"CIMGeometricEffectDashes",dashTemplate:N(n,t),lineDashEnding:"NoConstraint",scaleDash:!0,offsetAlongLine:null}]);const c=[];if(o){let e;switch(o.placement){case"begin-end":e=u.ExtremityPlacement.Both;break;case"begin":e=u.ExtremityPlacement.JustBegin;break;case"end":e=u.ExtremityPlacement.JustEnd;break;default:e=u.ExtremityPlacement.None}const t=D.fromSimpleMarker(o,s,r).symbolLayers[0];t.markerPlacement={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:e,offsetAlongLine:0},c.push(t)}return c.push({type:"CIMSolidStroke",color:"none"!==n&&"esriSLSNull"!==n?A(r):[0,0,0,0],capStyle:G(t),joinStyle:V(a),miterLimit:i,width:s,effects:l}),{type:"CIMLineSymbol",symbolLayers:c}}static fromPictureMarker(e){const{angle:t,height:r,width:a,xoffset:o,yoffset:i}=e;let n=e.url;return"esriPMS"===e.type&&e.imageData&&(n=e.imageData),{type:"CIMPointSymbol",symbolLayers:[{type:"CIMPictureMarker",invertBackfaceTexture:!1,scaleX:1,textureFilter:u.TextureFilter.Picture,tintColor:null,url:n,size:r,width:a,offsetX:h.getValue(o),offsetY:h.getValue(i),rotation:h.getValue(-t)}]}}static createCIMTextSymbolfromTextSymbol(e){const{angle:r,color:a,font:o,haloColor:i,haloSize:n,horizontalAlignment:s,kerning:l,text:c,verticalAlignment:m,xoffset:f,yoffset:y,backgroundColor:p,borderLineColor:g,borderLineSize:S}=e;let M,d,b,C,I,x;o&&(M=o.family,d=o.style,b=o.weight,C=o.size,I=o.decoration);let k=!1;if(c){k=t.bidiText(c)[1]}return(p||S)&&(x={type:"CIMBackgroundCallout",margin:null,backgroundSymbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",color:A(p)},{type:"CIMSolidStroke",color:A(g),width:S}]},accentBarSymbol:null,gap:null,leaderLineSymbol:null,lineStyle:null}),{type:"CIMTextSymbol",angle:r,blockProgression:u.BlockProgression.BTT,depth3D:1,extrapolateBaselines:!0,fontEffects:u.FontEffects.Normal,fontEncoding:u.FontEncoding.Unicode,fontFamilyName:M||"Arial",fontStyleName:B(d,b),fontType:u.FontType.Unspecified,haloSize:n,height:C,hinting:u.GlyphHinting.Default,horizontalAlignment:v(s??"center"),kerning:l,letterWidth:100,ligatures:!0,lineGapType:"Multiple",offsetX:h.getValue(f),offsetY:h.getValue(y),strikethrough:"line-through"===I,underline:"underline"===I,symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:A(a)}]},haloSymbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:A(i)}]},shadowColor:[0,0,0,255],shadowOffsetX:1,shadowOffsetY:1,textCase:"Normal",textDirection:k?u.TextReadingDirection.RTL:u.TextReadingDirection.LTR,verticalAlignment:R(m??"baseline"),verticalGlyphOrientation:u.VerticalGlyphOrientation.Right,wordSpacing:100,billboardMode3D:u.BillBoardMode.FaceNearPlane,callout:x}}static createPictureMarkerRasterizationParam(e){const{angle:t,height:r,width:a,xoffset:o,yoffset:i}=e,n=e.url??e.source?.url??e.source?.imageData;return n?{type:"sprite-rasterization-param",overrides:[],resource:{type:"CIMPictureMarker",invertBackfaceTexture:!1,scaleX:1,textureFilter:u.TextureFilter.Picture,tintColor:null,url:n,size:r,width:a,offsetX:h.getValue(o),offsetY:h.getValue(i),rotation:h.getValue(-t)}}:null}static createPictureFillRasterizationParam(e){const{width:t,height:r,xoffset:a,yoffset:o,url:i}=e;return i?{type:"sprite-rasterization-param",overrides:[],resource:{type:"CIMPictureFill",scaleX:1,textureFilter:u.TextureFilter.Picture,tintColor:null,url:i,width:t,height:r,offsetX:h.getValue(a),offsetY:h.getValue(o),rotation:0}}:null}static fromSimpleMarker(e,t,r){const{style:a}=e,o=e.color??r;if("path"===a||"esriSMSPath"===a){const t=[];if("outline"in e&&e.outline){const r=e.outline;t.push({type:"CIMSolidStroke",enable:!0,width:r.width,color:A(r.color),path:e.path})}t.push({type:"CIMSolidFill",enable:!0,color:A(o),path:e.path});const[r,a]=_("square");return{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:-h.getValue(e.angle),size:h.getValue(e.size||6),offsetX:h.getValue(e.xoffset),offsetY:h.getValue(e.yoffset),scaleSymbolsProportionally:!1,frame:r,markerGraphics:[{type:"CIMMarkerGraphic",geometry:a,symbol:{type:"CIMPolygonSymbol",symbolLayers:t}}]}]}}const i=[];let n,s,l=e.size;if("outline"in e&&e.outline&&"none"!==e.outline.style&&"esriSLSNull"!==e.outline.style){const t=e.outline,r="solid"!==t.style&&"esriSLSSolid"!==t.style;[n,s]=r?_(a,e.size):_(a);const o=t.width??p.defaultPolylineSymbol2D.width;if(r){const t=o/e.size,r=(n.xmax-n.xmin)*t/2,a=(n.ymax-n.ymin)*t/2;n.xmin-=r,n.xmax+=r,n.ymin-=a,n.ymax+=a,l&&(l+=o)}const c="cross"!==e.style&&"x"!==e.style||"dot"===e?.outline.style||"short-dot"===e?.outline.style?u.LineDashEnding.HalfGap:u.LineDashEnding.FullPattern,m=r?[{type:"CIMGeometricEffectAddControlPoints"},{type:"CIMGeometricEffectDashes",dashTemplate:N(t.style,null).map((e=>t.width&&t.width>0?e*t.width:e)),lineDashEnding:c,controlPointEnding:u.LineDashEnding.FullPattern}]:void 0;i.push({type:"CIMSolidStroke",capStyle:r?u.LineCapStyle.Round:u.LineCapStyle.Butt,enable:!0,width:o,color:A(t.color),effects:m})}else!t||"line-marker"!==e.type||"cross"!==e.style&&"x"!==e.style?[n,s]=_(a):([n,s]=_(a),i.push({type:"CIMSolidStroke",enable:!0,width:t,color:A(o)}));i.push({type:"CIMSolidFill",enable:!0,color:A(o)});const c={type:"CIMPolygonSymbol",symbolLayers:i};return{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:h.getValue(-e.angle),size:h.getValue(l||6*t),offsetX:h.getValue(e.xoffset),offsetY:h.getValue(e.yoffset),scaleSymbolsProportionally:!1,frame:n,markerGraphics:[{type:"CIMMarkerGraphic",geometry:s,symbol:c}]}]}}static fromCIMHatchFill(e,t){const r=t*(e.separation??y.defaultCIMValues.CIMHatchFill.separation),o=r/2,i=a.clone(e.lineSymbol);i.symbolLayers?.forEach((e=>{switch(e.type){case"CIMSolidStroke":null!=e.width&&(e.width*=t),e.effects?.forEach((e=>{if("CIMGeometricEffectDashes"===e.type){const r=e.dashTemplate;e.dashTemplate=r.map((e=>e*t))}}));break;case"CIMVectorMarker":{null!=e.size&&(e.size*=t);const r=e.markerPlacement;null!=r&&"placementTemplate"in r&&(r.placementTemplate=r.placementTemplate.map((e=>e*t)));break}}}));let n=this._getLineSymbolPeriod(i)||x;for(;n<x;)n*=2;const s=n/2;return{type:"CIMVectorMarker",frame:{xmin:-s,xmax:s,ymin:-o,ymax:o},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{paths:[[[-s,0],[s,0]]]},symbol:i}],size:r}}static fetchResources(e,t,r,a=null){return e&&t?(z(e,(e=>{U(e,t,r),"url"in e&&e.url&&r.push(t.fetchResource(e.url,{signal:a}))})),r):r}static fetchFonts(e,t,r){if(e&&t)if("symbolLayers"in e&&e.symbolLayers){for(const a of e.symbolLayers)if("CIMVectorMarker"===a.type&&a.markerGraphics)for(const e of a.markerGraphics)e?.symbol&&D.fetchFonts(e.symbol,t,r)}else if("CIMTextSymbol"===e.type){const{fontFamilyName:a,fontStyleName:o}=e;if(!a||"calcitewebcoreicons"===a.toLowerCase())return;const{style:i,weight:n}=h.fromCIMFontStyle(o),s=h.fromCIMFontDecoration(e),l=new c({family:a,style:i,weight:n,decoration:s});r.push(t.loadFont(l).catch((()=>{k().error(`Unsupported font ${a} in CIM symbol`)})))}}static _getLineSymbolPeriod(e){if(e){const t=this._getEffectsRepeat(e.effects);if(t)return t;if(e.symbolLayers)for(const r of e.symbolLayers)if(r){const e=this._getEffectsRepeat(r.effects);if(e)return e;switch(r.type){case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":case"CIMObjectMarker3D":case"CIMglTFMarker3D":{const e=this._getPlacementRepeat(r.markerPlacement);if(e)return e}}}}return 0}static _getEffectsRepeat(e){if(e)for(const t of e)if(t)switch(t.type){case"CIMGeometricEffectDashes":{const e=t.dashTemplate;if(e&&e.length){let t=0;for(const r of e)t+=r;return 1&e.length&&(t*=2),t}break}case"CIMGeometricEffectWave":return t.period;default:k().error(`unsupported geometric effect type ${t.type}`)}return 0}static _getPlacementRepeat(e){if(e)switch(e.type){case"CIMMarkerPlacementAlongLineSameSize":case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineVariableSize":{const t=e.placementTemplate;if(t&&t.length){let e=0;for(const r of t)e+=+r;return 1&t.length&&(e*=2),e}break}}return 0}static fromCIMInsidePolygon(e){const t=e.markerPlacement,r={...e};r.markerPlacement=null,r.anchorPoint=null;const a=Math.abs(t.stepX),o=Math.abs(t.stepY),s=(t.randomness??100)/100;let l,c,m,f;if("Random"===t.gridType){const e=n.px2pt(S.randomInsidePolygonTextureSize),r=Math.max(Math.floor(e/a),1),y=Math.max(Math.floor(e/o),1);l=r*a/2,c=y*o/2,m=2*c;const u=new i(t.seed),h=s*a/1.5,p=s*o/1.5;f=[];for(let t=0;t<r;t++)for(let e=0;e<y;e++){const r=t*a-l+h*(.5-u.getFloat()),i=e*o-c+p*(.5-u.getFloat());f.push({x:r,y:i}),0===t&&f.push({x:r+2*l,y:i}),0===e&&f.push({x:r,y:i+2*c})}}else!0===t.shiftOddRows?(l=a/2,c=o,m=2*o,f=[{x:-l,y:0},{x:l,y:0},{x:0,y:c},{x:0,y:-c}]):(l=a/2,c=o/2,m=o,f=[{x:-a,y:0},{x:0,y:-o},{x:-a,y:-o},{x:0,y:0},{x:a,y:0},{x:0,y:o},{x:a,y:o},{x:-a,y:o},{x:a,y:-o}]);return{type:"CIMVectorMarker",frame:{xmin:-l,xmax:l,ymin:-c,ymax:c},markerGraphics:f.map((e=>({type:"CIMMarkerGraphic",geometry:e,symbol:{type:"CIMPointSymbol",symbolLayers:[r]}}))),size:m}}}function z(e,t){if(e)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const r=e.symbolLayers;if(!r)return;for(const e of r)if(t(e),"CIMVectorMarker"===e.type){const r=e.markerGraphics;if(!r)continue;for(const e of r)if(e){const r=e.symbol;r&&z(r,t)}}break}}}const G=e=>{if(!e)return u.LineCapStyle.Butt;switch(e){case"butt":return u.LineCapStyle.Butt;case"square":return u.LineCapStyle.Square;case"round":return u.LineCapStyle.Round}},V=e=>{if(!e)return u.LineJoinStyle.Miter;switch(e){case"miter":return u.LineJoinStyle.Miter;case"round":return u.LineJoinStyle.Round;case"bevel":return u.LineJoinStyle.Bevel}},v=e=>{if(null==e)return"Center";switch(e){case"left":return"Left";case"right":return"Right";case"center":return"Center"}},R=e=>{if(null==e)return"Center";switch(e){case"baseline":return"Baseline";case"top":return"Top";case"middle":return"Center";case"bottom":return"Bottom"}},A=e=>{if(!e)return[0,0,0,0];const{r:t,g:r,b:a,a:o}=e;return[t,r,a,255*o]},B=(e,t)=>{const r=X(t),a=H(e);return r&&a?`${r}-${a}`:`${r}${a}`},X=e=>{if(!e)return"";switch(e.toLowerCase()){case"bold":case"bolder":return"bold"}return""},H=e=>{if(!e)return"";switch(e.toLowerCase()){case"italic":case"oblique":return"italic"}return""},N=(e,t)=>{const a=r("safari")?.001:0,o="butt"===t;switch(e){case"dash":case"esriSLSDash":return o?[4,3]:[3,4];case"dash-dot":case"esriSLSDashDot":return o?[4,3,1,3]:[3,4,a,4];case"dot":case"esriSLSDot":return o?[1,3]:[a,4];case"long-dash":case"esriSLSLongDash":return o?[8,3]:[7,4];case"long-dash-dot":case"esriSLSLongDashDot":return o?[8,3,1,3]:[7,4,a,4];case"long-dash-dot-dot":case"esriSLSDashDotDot":return o?[8,3,1,3,1,3]:[7,4,a,4,a,4];case"short-dash":case"esriSLSShortDash":return o?[4,1]:[3,2];case"short-dash-dot":case"esriSLSShortDashDot":return o?[4,1,1,1]:[3,2,a,2];case"short-dash-dot-dot":case"esriSLSShortDashDotDot":return o?[4,1,1,1,1,1]:[3,2,a,2,a,2];case"short-dot":case"esriSLSShortDot":return o?[1,1]:[a,2];case"solid":case"esriSLSSolid":case"none":return k().error("Unexpected: style does not require rasterization"),[0,0];default:return k().error(`Tried to rasterize SLS, but found an unexpected style: ${e}!`),[0,0]}};function Y(e){return void 0!==e.symbolLayers}const _=(e,t=100)=>{const r=t/2;let a,o;const i=e;if("circle"===i||"esriSMSCircle"===i){const e=.25;let t=Math.acos(1-e/r),i=Math.ceil(d/t/4);0===i&&(i=1),t=b/i,i*=4;const n=[];n.push([r,0]);for(let a=1;a<i;a++)n.push([r*Math.cos(a*t),-r*Math.sin(a*t)]);n.push([r,0]),a={rings:[n]},o={xmin:-r,ymin:-r,xmax:r,ymax:r}}else if("cross"===i||"esriSMSCross"===i){const e=0;a={paths:[[[e,r],[e,-r]],[[r,e],[-r,e]]]},o={xmin:-r,ymin:-r,xmax:r,ymax:r}}else if("diamond"===i||"esriSMSDiamond"===i)a={rings:[[[-r,0],[0,r],[r,0],[0,-r],[-r,0]]]},o={xmin:-r,ymin:-r,xmax:r,ymax:r};else if("square"===i||"esriSMSSquare"===i)a={rings:[[[-r,-r],[-r,r],[r,r],[r,-r],[-r,-r]]]},o={xmin:-r,ymin:-r,xmax:r,ymax:r};else if("x"===i||"esriSMSX"===i)a={paths:[[[r,r],[-r,-r]],[[r,-r],[-r,r]]]},o={xmin:-r,ymin:-r,xmax:r,ymax:r};else if("triangle"===i||"esriSMSTriangle"===i){const e=t*.5773502691896257,r=-e,i=2/3*t,n=i-t;a={rings:[[[r,n],[0,i],[e,n],[r,n]]]},o={xmin:r,ymin:n,xmax:e,ymax:i}}else"arrow"===i&&(a={rings:[[[-50,50],[50,0],[-50,-50],[-33,-20],[-33,20],[-50,50]]]},o={xmin:-r,ymin:-r,xmax:r,ymax:r});return[o,a]},O=e=>"vertical"===e||"horizontal"===e||"cross"===e||"esriSFSCross"===e||"esriSFSVertical"===e||"esriSFSHorizontal"===e;function U(e,t,r){if(!e.effects||null!=t.geometryEngine)return;if(t.geometryEnginePromise)return void r.push(t.geometryEnginePromise);h.isGeometryEngineRequired(e.effects)&&(t.geometryEnginePromise=h.importGeometryEngine(),r.push(t.geometryEnginePromise),t.geometryEnginePromise.then((e=>t.geometryEngine=e)))}function q(e){if(!e)return null;let t=null;const{cap:r,color:a,join:o,miterLimit:i,style:n,width:s}=e;return"solid"!==n&&"none"!==n&&"esriSLSSolid"!==n&&"esriSLSNull"!==n&&(t=[{type:"CIMGeometricEffectDashes",dashTemplate:N(n,r),lineDashEnding:"NoConstraint",scaleDash:!0,offsetAlongLine:null}]),{type:"CIMSolidStroke",color:"esriSLSNull"!==n&&"none"!==n?A(a):[0,0,0,0],capStyle:G(r),joinStyle:V(o),miterLimit:i,width:s,effects:t}}e.CIMSymbolHelper=D,e.CIMSymbolInflatedSizeHelper=T,e.capTypeToEnum=G,e.getEffectsInflateSize=E,e.slsDashToTemplateArray=N,e.symbolToCIM=P,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
