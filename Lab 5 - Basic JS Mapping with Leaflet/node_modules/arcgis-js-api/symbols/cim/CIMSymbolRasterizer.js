/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","./CIMResourceManager","./CIMSymbolDrawHelper","./CIMSymbolHelper","./OverrideHelper","./utils"],(function(e,t,a,r,i,n){"use strict";const s=96/72;class l{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new t}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,t,a,s,l,h,c,y,m){if(!e)return null;const{data:g}=e;if(!g||"CIMSymbolReference"!==g.type||!g.symbol)return null;const{symbol:u}=g;h||(h=n.mapCIMSymbolToGeometryType(u));const d=await i.OverrideHelper.resolveSymbolOverrides(g,t,this._spatialReference,l,h,c,y),b=this._cimResourceManager,w=[];r.CIMSymbolHelper.fetchResources(d,b,w),r.CIMSymbolHelper.fetchFonts(d,b,w),w.length>0&&await Promise.all(w);const{width:p,height:M}=a,C=o(h,p,M,s),S=r.CIMSymbolHelper.getEnvelope(d,C,b);if(!S)return null;let I=1,f=0,v=0;switch(u.type){case"CIMPointSymbol":case"CIMTextSymbol":{let e=1;S.width>p&&(e=p/S.width);let t=1;S.height>M&&(t=M/S.height),"preview"===s&&(S.width<p&&(e=p/S.width),S.height<M&&(t=M/S.height)),I=Math.min(e,t),f=S.x+S.width/2,v=S.y+S.height/2}break;case"CIMLineSymbol":{(m||S.height>M)&&(I=M/S.height),v=S.y+S.height/2;const e=S.x*I+p/2,t=(S.x+S.width)*I+p/2,{paths:a}=C;a[0][0][0]-=e/I,a[0][2][0]-=(t-p)/I}break;case"CIMPolygonSymbol":{f=S.x+S.width/2,v=S.y+S.height/2;const e=S.x*I+p/2,t=(S.x+S.width)*I+p/2,a=S.y*I+M/2,r=(S.y+S.height)*I+M/2,{rings:i}=C;e<0&&(i[0][0][0]-=e,i[0][3][0]-=e,i[0][4][0]-=e),a<0&&(i[0][0][1]+=a,i[0][1][1]+=a,i[0][4][1]+=a),t>p&&(i[0][1][0]-=t-p,i[0][2][0]-=t-p),r>M&&(i[0][2][1]+=r-M,i[0][3][1]+=r-M)}}const R={type:"cim",data:{type:"CIMSymbolReference",symbol:d}};return this.rasterize(R,p,M,f,v,I,h,1,C)}rasterize(e,t,r,i,l,h,c,y=0,m=null){const{data:g}=e;if(!g||"CIMSymbolReference"!==g.type||!g.symbol)return null;const{symbol:u}=g,d=this._canvas,b=(window.devicePixelRatio||1)*s;d.width=t*b,d.height=r*b,c||(c=n.mapCIMSymbolToGeometryType(u)),m||(m=o(c,t,r,"legend")),d.width+=2*y,d.height+=2*y;const w=d.getContext("2d",{willReadFrequently:!0}),p=a.Transformation.createIdentity();p.translate(-i,-l),p.scale(h*b,-h*b),p.translate(t*b/2+y,r*b/2+y),w.clearRect(0,0,d.width,d.height);return new a.CanvasDrawHelper(w,this._cimResourceManager,p,!0).drawSymbol(u,m),w.getImageData(0,0,d.width,d.height)}}function o(e,t,a,r){const i=1,n=-t/2+i,s=t/2-i,l=a/2-i,o=-a/2+i;switch(e){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[n,0],[0,0],[s,0]]]};default:return"legend"===r?{rings:[[[n,l],[s,0],[s,o],[n,o],[n,l]]]}:{rings:[[[n,l],[s,l],[s,o],[n,o],[n,l]]]}}}e.CIMSymbolRasterizer=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
