/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../core/fontUtils","../../core/has","../../core/lang","../../core/Logger","../../core/ObjectPool","../../core/screenUtils","../../geometry/GeometryCursor","../../geometry/support/aaBoundingRect","../../geometry/support/boundsUtils","../../geometry/support/centroid","../../geometry/support/jsonUtils","./CIMEffects","./CIMImageColorSubstitutionHelper","./CIMOperators","./CIMPlacements","./defaultCIMValues","./enums","./imageUtils","./Rect","./TextRasterizer","./utils","../../views/2d/engine/webgl/definitions","../../views/2d/engine/webgl/mesh/templates/shapingUtils"],(function(t,e,i,s,r,n,o,a,l,h,c,m,u,f,g,d,y,p,_,P,S,x,M,w){"use strict";const b=Math.PI/180,C=.5,k=()=>r.getLogger("esri.symbols.cim.CIMSymbolDrawHelper");class I{constructor(t){this._t=t}static createIdentity(){return new I([1,0,0,0,1,0])}clone(){const t=this._t;return new I(t.slice())}transform(t){const e=this._t;return[e[0]*t[0]+e[1]*t[1]+e[2],e[3]*t[0]+e[4]*t[1]+e[5]]}static createScale(t,e){return new I([t,0,0,0,e,0])}scale(t,e){const i=this._t;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=e,i[4]*=e,i[5]*=e,this}scaleRatio(){return Math.sqrt(this._t[0]*this._t[0]+this._t[1]*this._t[1])}static createTranslate(t,e){return new I([0,0,t,0,0,e])}translate(t,e){const i=this._t;return i[2]+=t,i[5]+=e,this}static createRotate(t){const e=Math.cos(t),i=Math.sin(t);return new I([e,-i,0,i,e,0])}rotate(t){return I.multiply(this,I.createRotate(t),this)}angle(){const t=this._t[0],e=this._t[3],i=Math.sqrt(t*t+e*e);return[t/i,e/i]}static multiply(t,e,i){const s=t._t,r=e._t,n=s[0]*r[0]+s[3]*r[1],o=s[1]*r[0]+s[4]*r[1],a=s[2]*r[0]+s[5]*r[1]+r[2],l=s[0]*r[3]+s[3]*r[4],h=s[1]*r[3]+s[4]*r[4],c=s[2]*r[3]+s[5]*r[4]+r[5],m=i._t;return m[0]=n,m[1]=o,m[2]=a,m[3]=l,m[4]=h,m[5]=c,i}invert(){const t=this._t;let e=t[0]*t[4]-t[1]*t[3];if(0===e)return new I([0,0,0,0,0,0]);e=1/e;const i=(t[1]*t[5]-t[2]*t[4])*e,s=(t[2]*t[3]-t[0]*t[5])*e,r=t[4]*e,n=-t[1]*e,o=-t[3]*e,a=t[0]*e;return new I([r,n,i,o,a,s])}}class T{constructor(t,e){this._resourceManager=t,this._transfos=[],this._sizeTransfos=[],this._geomUnitsPerPoint=1,this._placementPool=new n(d.Placement,void 0,void 0,100),this._earlyReturn=!1,this._mapRotation=0,this._transfos.push(e||I.createIdentity()),this._sizeTransfos.push(e?e.scaleRatio():1)}setTransform(t,e){this._transfos=[t||I.createIdentity()],this._sizeTransfos=[e||(t?t.scaleRatio():1)]}setGeomUnitsPerPoint(t){this._geomUnitsPerPoint=t}transformPt(t){return this._transfos[this._transfos.length-1].transform(t)}transformSize(t){return t*this._sizeTransfos[this._sizeTransfos.length-1]}reverseTransformPt(t){return this._transfos[this._transfos.length-1].invert().transform(t)}reverseTransformSize(t){return t/this._sizeTransfos[this._sizeTransfos.length-1]}reverseTransformScalar(t){return t/this._transfos[this._transfos.length-1].scaleRatio()}getTransformAngle(){return this._transfos[this._transfos.length-1].angle()}geomUnitsPerPoint(){return this.isEmbedded()?1:this._geomUnitsPerPoint}prevGeomUnitsPerPoint(){return this._transfos.length>2?1:this._geomUnitsPerPoint}isEmbedded(){return this._transfos.length>1}back(){return this._transfos[this._transfos.length-1]}push(t,e){const i=e?t.scaleRatio():1;I.multiply(t,this.back(),t),this._transfos.push(t),this._sizeTransfos.push(this._sizeTransfos[this._sizeTransfos.length-1]*i)}pop(){this._transfos.splice(-1,1),this._sizeTransfos.splice(-1,1)}drawSymbol(t,e,i){if(t)switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this.drawMultiLayerSymbol(t,e);break;case"CIMTextSymbol":this.drawTextSymbol(t,e,i)}}drawMultiLayerSymbol(t,e){if(!t||!e)return;const i=t.symbolLayers;if(!i)return;const s=t.effects;if(s&&s.length>0){const t=this.executeEffects(s,e);if(t){let e=t.next();for(;e;)this.drawSymbolLayers(i,e.asJSON()),e=t.next()}}else this.drawSymbolLayers(i,e)}executeEffects(t,e){const i=this._resourceManager.geometryEngine;let s=new u.SimpleEffectCursor(a.GeometryCursor.fromJSONCIM(e));for(const r of t){const t=g.getEffectOperator(r);t&&(s=t.execute(s,r,this.geomUnitsPerPoint(),null,i))}return s}drawSymbolLayers(t,e){let i=t.length;for(;i--;){const s=t[i];if(!s||!1===s.enable)continue;const r=s.effects;if(r&&r.length>0){const t=this.executeEffects(r,e);if(t){let e=null;for(;(e=t.next())&&(this.drawSymbolLayer(s,e.asJSON()),!this._earlyReturn););}}else this.drawSymbolLayer(s,e);if(this._earlyReturn)return}}drawSymbolLayer(t,e){switch(t.type){case"CIMSolidFill":this.drawSolidFill(e,t.color);break;case"CIMHatchFill":this.drawHatchFill(e,t);break;case"CIMPictureFill":this.drawPictureFill(e,t);break;case"CIMGradientFill":this.drawGradientFill(e,t);break;case"CIMSolidStroke":this.drawSolidStroke(e,t.color,t.width,t.capStyle,t.joinStyle,t.miterLimit);break;case"CIMPictureStroke":this.drawPictureStroke(e,t);break;case"CIMGradientStroke":this.drawGradientStroke(e,t);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":this.drawMarkerLayer(t,e)}}drawHatchFill(t,e){const i=this._buildHatchPolyline(e,t,this.geomUnitsPerPoint());i&&(this.pushClipPath(t),this.drawMultiLayerSymbol(e.lineSymbol,i),this.popClipPath())}drawPictureFill(t,e){}drawGradientFill(t,e){}drawPictureStroke(t,e){}drawGradientStroke(t,e){}drawMarkerLayer(t,e){const i=t.markerPlacement;if(i){const s=g.getPlacementOperator(i);if(s){const r="CIMMarkerPlacementInsidePolygon"===i.type||"CIMMarkerPlacementPolygonCenter"===i.type&&i.clipAtBoundary;r&&this.pushClipPath(e);const n=s.execute(a.GeometryCursor.fromJSONCIM(e),i,this.geomUnitsPerPoint(),null,this._resourceManager.geometryEngine);if(n){let e=null;for(;(e=n.next())&&(this.drawMarker(t,e),!this._earlyReturn););}r&&this.popClipPath()}}else{const i=this._placementPool.acquire();if(m.isPoint(e))i.tx=e.x,i.ty=e.y,this.drawMarker(t,i);else if(m.isPolygon(e)){const s=c.polygonCentroid(e);s&&([i.tx,i.ty]=s,this.drawMarker(t,i))}else for(const s of e.points)if(i.tx=s[0],i.ty=s[1],this.drawMarker(t,i),this._earlyReturn)break;this._placementPool.release(i)}}drawMarker(t,e){switch(t.type){case"CIMCharacterMarker":case"CIMPictureMarker":this.drawPictureMarker(t,e);break;case"CIMVectorMarker":this.drawVectorMarker(t,e)}}drawPictureMarker(t,e){if(!t)return;const i=this._resourceManager.getResource(t.url),s=x.getValue(t.size,y.defaultCIMValues.CIMPictureMarker.size);if(null==i||s<=0)return;const r=i.width,n=i.height;if(!r||!n)return;const o=r/n,a=x.getValue(t.scaleX,1),l=I.createIdentity(),h=t.anchorPoint;if(h){let e=h.x,i=h.y;"Absolute"!==t.anchorPointUnits&&(e*=s*o*a,i*=s),l.translate(-e,-i)}let c=x.getValue(t.rotation);t.rotateClockwise&&(c=-c),this._mapRotation&&(c+=this._mapRotation),c&&l.rotate(c*b);let m=x.getValue(t.offsetX),u=x.getValue(t.offsetY);if(m||u){if(this._mapRotation){const t=b*this._mapRotation,e=Math.cos(t),i=Math.sin(t),s=m*i+u*e;m=m*e-u*i,u=s}l.translate(m,u)}const f=this.geomUnitsPerPoint();1!==f&&l.scale(f,f);const g=e.getAngle();g&&l.rotate(g),l.translate(e.tx,e.ty),this.push(l,!1),this.drawImage(t,s),this.pop()}drawVectorMarker(t,e){if(!t)return;const i=t.markerGraphics;if(!i)return;const s=x.getValue(t.size,y.defaultCIMValues.CIMVectorMarker.size),r=t.frame,n=r?r.ymax-r.ymin:0,o=s&&n?s/n:1,a=I.createIdentity();r&&a.translate(.5*-(r.xmax+r.xmin),.5*-(r.ymax+r.ymin));const l=t.anchorPoint;if(l){let e=l.x,i=l.y;"Absolute"!==t.anchorPointUnits?r&&(e*=r.xmax-r.xmin,i*=r.ymax-r.ymin):(e/=o,i/=o),a.translate(-e,-i)}1!==o&&a.scale(o,o);let h=x.getValue(t.rotation);t.rotateClockwise&&(h=-h),this._mapRotation&&(h+=this._mapRotation),h&&a.rotate(h*b);let c=x.getValue(t.offsetX),m=x.getValue(t.offsetY);if(c||m){if(this._mapRotation){const t=b*this._mapRotation,e=Math.cos(t),i=Math.sin(t),s=c*i+m*e;c=c*e-m*i,m=s}a.translate(c,m)}const u=this.geomUnitsPerPoint();1!==u&&a.scale(u,u);const f=e.getAngle();f&&a.rotate(f),a.translate(e.tx,e.ty),this.push(a,t.scaleSymbolsProportionally);for(const g of i){g?.symbol&&g.geometry||k().error("Invalid marker graphic",g);let t=g.textString;if("number"==typeof t&&(t=t.toString()),this.drawSymbol(g.symbol,g.geometry,t),this._earlyReturn)break}this.pop()}drawTextSymbol(t,e,i){if(!t)return;if(!m.isPoint(e))return;if(x.getValue(t.height,y.defaultCIMValues.CIMTextSymbol.height)<=0)return;const s=I.createIdentity();let r=x.getValue(t.angle);r=-r,r&&s.rotate(r*b);const n=x.getValue(t.offsetX),o=x.getValue(t.offsetY);(n||o)&&s.translate(n,o);const a=this.geomUnitsPerPoint();1!==a&&s.scale(a,a),s.translate(e.x,e.y),this.push(s,!1),this.drawText(t,i),this.pop()}_buildHatchPolyline(t,e,i){let s=x.getValue(t.separation,y.defaultCIMValues.CIMHatchFill.separation)*i,r=x.getValue(t.rotation);if(0===s)return null;s<0&&(s=-s);let n=0;const o=.5*s;for(;n>o;)n-=s;for(;n<-o;)n+=s;const a=l.create();h.getBoundsXY(a,e),a[0]-=o,a[1]-=o,a[2]+=o,a[3]+=o;const c=[[a[0],a[1]],[a[0],a[3]],[a[2],a[3]],[a[2],a[1]]];for(;r>180;)r-=180;for(;r<0;)r+=180;const m=Math.cos(r*b),u=Math.sin(r*b),f=-s*u,g=s*m;let d,p,_,P;n=x.getValue(t.offsetX)*i*u-x.getValue(t.offsetY)*i*m,d=_=Number.MAX_VALUE,p=P=-Number.MAX_VALUE;for(const l of c){const t=l[0],e=l[1],i=m*t+u*e,s=-u*t+m*e;d=Math.min(d,i),_=Math.min(_,s),p=Math.max(p,i),P=Math.max(P,s)}_=Math.floor(_/s)*s;let S=m*d-u*_-f*n/s,M=u*d+m*_-g*n/s,w=m*p-u*_-f*n/s,C=u*p+m*_-g*n/s;const k=1+Math.round((P-_)/s),I=[];for(let l=0;l<k;l++)S+=f,M+=g,w+=f,C+=g,I.push([[S,M],[w,C]]);return{paths:I}}}class R extends T{constructor(t,e){super(t,e),this.reset()}reset(){this._xmin=this._ymin=1/0,this._xmax=this._ymax=-1/0,this._clipCount=0}envelope(){return new P(this._xmin,this._ymin,this._xmax-this._xmin,this._ymax-this._ymin)}bounds(){return l.fromValues(this._xmin,this._ymin,this._xmax,this._ymax)}drawSolidFill(t){if(t&&!(this._clipCount>0))if(m.isPolygon(t))this._processPath(t.rings,0);else if(m.isPolyline(t))this._processPath(t.paths,0);else if(m.isExtent(t)){const e=z(t);e&&this._processPath(e.rings,0)}else console.error("drawSolidFill Unexpected geometry type!")}drawSolidStroke(t,e,i){if(!t||this._clipCount>0||null==i||i<=0)return;const s=Math.max(.5*this.transformSize(x.getValue(i,y.defaultCIMValues.CIMSolidStroke.width)),.5*C);if(m.isPolygon(t))this._processPath(t.rings,s);else if(m.isPolyline(t))this._processPath(t.paths,s);else if(m.isExtent(t)){const e=z(t);e&&this._processPath(e.rings,s)}else console.error("drawSolidStroke unexpected geometry type!")}drawMarkerLayer(t,e){m.isPolygon(e)&&t.markerPlacement&&("CIMMarkerPlacementInsidePolygon"===t.markerPlacement.type||"CIMMarkerPlacementPolygonCenter"===t.markerPlacement.type&&t.markerPlacement.clipAtBoundary)?this._processPath(e.rings,0):super.drawMarkerLayer(t,e)}drawHatchFill(t,e){this.drawSolidFill(t)}drawPictureFill(t,e){this.drawSolidFill(t)}drawGradientFill(t,e){this.drawSolidFill(t)}drawPictureStroke(t,e){this.drawSolidStroke(t,null,e.width)}drawGradientStroke(t,e){this.drawSolidStroke(t,null,e.width)}pushClipPath(t){this.drawSolidFill(t),this._clipCount++}popClipPath(){this._clipCount--}drawImage(t,e){const{url:i}=t,s=x.getValue(t.scaleX,1);let r=s*e,n=e;const o=this._resourceManager.getResource(i);if(null!=o){const t=o.height/o.width;r=s*(e?t>1?e:e/t:o.width),n=e?t>1?e*t:e:o.height}this._merge(this.transformPt([-r/2,-n/2]),0),this._merge(this.transformPt([-r/2,n/2]),0),this._merge(this.transformPt([r/2,-n/2]),0),this._merge(this.transformPt([r/2,n/2]),0)}drawText(t,e){if(!e||0===e.length)return;this._textRasterizer||(this._textRasterizer=new S);const i=A(t);let[s,r]=this._textRasterizer.computeTextSize(e,i);s=o.px2pt(s),r=o.px2pt(r);let n=0;switch(t.horizontalAlignment){case"Left":n=s/2;break;case"Right":n=-s/2}let a=0;switch(t.verticalAlignment){case"Bottom":a=r/2;break;case"Top":a=-r/2;break;case"Baseline":a=r/6}this._merge(this.transformPt([-s/2+n,-r/2+a]),0),this._merge(this.transformPt([-s/2+n,r/2+a]),0),this._merge(this.transformPt([s/2+n,-r/2+a]),0),this._merge(this.transformPt([s/2+n,r/2+a]),0)}_processPath(t,e){if(t)for(const i of t){const t=i?i.length:0;if(t>1){this._merge(this.transformPt(i[0]),e);for(let s=1;s<t;s++)this._merge(this.transformPt(i[s]),e)}}}_merge(t,e){t[0]-e<this._xmin&&(this._xmin=t[0]-e),t[0]+e>this._xmax&&(this._xmax=t[0]+e),t[1]-e<this._ymin&&(this._ymin=t[1]-e),t[1]+e>this._ymax&&(this._ymax=t[1]+e)}}class F extends T{constructor(){super(...arguments),this._searchPoint=[0,0],this._searchDistPoint=0,this._textInfo=null}hitTest(t,e,s,r,n,a){const l=a*o.pt2px(1);this.setTransform(),this.setGeomUnitsPerPoint(l),this._searchPoint=[(t[0]+t[2])/2,(t[1]+t[3])/2],this._searchDistPoint=(t[2]-t[0])/2/l,this._textInfo=r;const h=e&&("CIMPointSymbol"===e.type&&"Map"!==e.angleAlignment||"CIMTextSymbol"===e.type);if(this._mapRotation=h?n:0,!i("esri-mobile")){const t=o.px2pt(i("hittest-2d-small-symbol-tolerance")*window.devicePixelRatio),s=o.px2pt(i("hittest-2d-small-symbol-tolerance-threshold"));!(("CIMLineSymbol"===e?.type||"CIMPolygonSymbol"===e?.type)&&e.symbolLayers?.some(x.isCIMFill))&&"CIMMeshSymbol"!==e?.type&&(x.getSize(e)??0)<s&&(this._searchDistPoint=t)}return this._earlyReturn=!1,this.drawSymbol(e,s),this._earlyReturn}drawSolidFill(t,e){this._hitTestFill(t)}drawHatchFill(t,e){this._hitTestFill(t)}drawPictureFill(t,e){this._hitTestFill(t)}drawGradientFill(t,e){this._hitTestFill(t)}drawSolidStroke(t,e,i,s,r,n){this._hitTestStroke(t,i)}drawPictureStroke(t,e){this._hitTestStroke(t,e.width)}drawGradientStroke(t,e){this._hitTestStroke(t,e.width)}drawMarkerLayer(t,e){t.markerPlacement&&("CIMMarkerPlacementInsidePolygon"===t.markerPlacement.type||"CIMMarkerPlacementPolygonCenter"===t.markerPlacement.type&&t.markerPlacement.clipAtBoundary)?this._hitTestFill(e):super.drawMarkerLayer(t,e)}pushClipPath(t){}popClipPath(){}drawImage(t,e){const{url:i}=t,s=x.getValue(t.scaleX,1),r=this._resourceManager.getResource(i);if(null==r||0===r.height||0===e)return;const n=e*this.geomUnitsPerPoint(),o=n*s*(r.width/r.height),a=this.reverseTransformPt(this._searchPoint),l=this._searchDistPoint;Math.abs(a[0])<o/2+l&&Math.abs(a[1])<n/2+l&&(this._earlyReturn=!0)}drawText(t,e){const i=this._textInfo;if(!i)return;const s=i.get(t);if(!s)return;if(!s.glyphMosaicItems.glyphs.length)return;const r=x.getValue(t.height,y.defaultCIMValues.CIMTextSymbol.height),{lineGapType:n,lineGap:o}=t,a=n?L(n,x.getValue(o),r):0,l="CIMBackgroundCallout"===t.callout?.type,h=w.shapeGlyphs(s.glyphMosaicItems,{scale:r/M.glyphSize,angle:0,xOffset:0,yOffset:0,horizontalAlignment:t.horizontalAlignment,verticalAlignment:t.verticalAlignment,maxLineWidth:512,lineHeight:M.magicLabelLineHeight*Math.max(.25,Math.min(a||1,4)),decoration:t.font.decoration||"none",useCIMAngleBehavior:!0,hasBackground:l}),c=this.reverseTransformPt(this._searchPoint),m=c[0],u=c[1];for(const f of h.glyphs)if(m>f.xTopLeft&&m<f.xBottomRight&&u>-f.yBottomRight&&u<-f.yTopLeft){this._earlyReturn=!0;break}}_hitTestFill(t){let e=null;if(m.isExtent(t)){const i=t;e=[[[i.xmin,i.ymin],[i.xmin,i.ymax],[i.xmax,i.ymax],[i.xmax,i.ymin],[i.xmin,i.ymin]]]}else if(m.isPolygon(t))e=t.rings;else{if(!m.isPolyline(t))return;e=t.paths}const i=this.reverseTransformPt(this._searchPoint);if(this._pointInPolygon(i,e)&&(this._earlyReturn=!0),!this._earlyReturn){const t=this.reverseTransformScalar(this._searchDistPoint)*this.prevGeomUnitsPerPoint();this._nearLine(i,e,t)&&(this._earlyReturn=!0)}}_hitTestStroke(t,e){let i=null;if(m.isExtent(t)){const e=t;i=[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]}else if(m.isPolygon(t))i=t.rings;else{if(!m.isPolyline(t))return;i=t.paths}const s=this.reverseTransformPt(this._searchPoint),r=x.getValue(e,y.defaultCIMValues.CIMSolidStroke.width)*this.geomUnitsPerPoint(),n=this.reverseTransformScalar(this._searchDistPoint)*this.prevGeomUnitsPerPoint();this._nearLine(s,i,r/2+n)&&(this._earlyReturn=!0)}_pointInPolygon(t,e){let i=0;for(const s of e){const e=s.length;for(let r=1;r<e;r++){const e=s[r-1],n=s[r];if(e[1]>t[1]==n[1]>t[1])continue;(n[0]-e[0])*(t[1]-e[1])-(n[1]-e[1])*(t[0]-e[0])>0?i++:i--}}return 0!==i}_nearLine(t,e,i){for(const s of e){const e=s.length;for(let r=1;r<e;r++){const e=s[r-1],n=s[r];let o=(n[0]-e[0])*(n[0]-e[0])+(n[1]-e[1])*(n[1]-e[1]);if(0===o)continue;o=Math.sqrt(o);const a=((n[0]-e[0])*(t[1]-e[1])-(n[1]-e[1])*(t[0]-e[0]))/o;if(Math.abs(a)<i){const s=((n[0]-e[0])*(t[0]-e[0])+(n[1]-e[1])*(t[1]-e[1]))/o;if(s>-i&&s<o+i)return!0}}}return!1}}class v extends T{constructor(t,e,i,s){super(e,i),this._applyAdditionalRenderProps=s,this._colorSubstitutionHelper=new f,this._ctx=t}drawSolidFill(t,e){if(!t)return;if(m.isPolygon(t))this._buildPath(t.rings,!0);else if(m.isPolyline(t))this._buildPath(t.paths,!0);else if(m.isExtent(t))this._buildPath(z(t).rings,!0);else{if(!m.isMultipoint(t))return;console.log("CanvasDrawHelper.drawSolidFill - No implementation!")}const i=this._ctx;i.fillStyle="string"==typeof e?e:"rgba("+Math.round(e[0])+","+Math.round(e[1])+","+Math.round(e[2])+","+(e[3]??255)/255+")",i.fill("evenodd")}drawSolidStroke(t,e,i,s,r,n){if(!t||!e||0===i)return;if(m.isPolygon(t))this._buildPath(t.rings,!0);else if(m.isPolyline(t))this._buildPath(t.paths,!1);else{if(!m.isExtent(t))return void console.log("CanvasDrawHelper.drawSolidStroke isn't implemented!");this._buildPath(z(t).rings,!0)}const o=this._ctx;o.strokeStyle="string"==typeof e?e:"rgba("+Math.round(e[0])+","+Math.round(e[1])+","+Math.round(e[2])+","+(e[3]??255)/255+")",o.lineWidth=Math.max(this.transformSize(i),C),this._setCapStyle(s),this._setJoinStyle(r),o.miterLimit=n,o.stroke()}pushClipPath(t){if(this._ctx.save(),m.isPolygon(t))this._buildPath(t.rings,!0);else if(m.isPolyline(t))this._buildPath(t.paths,!0);else{if(!m.isExtent(t))return;this._buildPath(z(t).rings,!0)}this._ctx.clip("evenodd")}popClipPath(){this._ctx.restore()}drawImage(t,e){const{colorSubstitutions:i,url:s,tintColor:r}=t,n=x.getValue(t.scaleX,1),o=this._resourceManager.getResource(s);if(null==o)return;let a=e*(o.width/o.height),l=e;e||(a=o.width,l=o.height);const h=x.isSVGImage(s)||"src"in o&&x.isSVGImage(o.src);let c="getFrame"in o?_.getFirstFrame(o):o;i&&(c=this._colorSubstitutionHelper.applyColorSubstituition(c,i)),this._applyAdditionalRenderProps&&!h&&r&&(c=this._colorSubstitutionHelper.tintImageData(c,r));const m=this.transformPt([0,0]),[u,f]=this.getTransformAngle(),g=this.transformSize(1),d=this._ctx;d.save(),d.setTransform({m11:n*g*u,m12:n*g*f,m21:-g*f,m22:g*u,m41:m[0],m42:m[1]}),d.drawImage(c,-a/2,-l/2,a,l),d.restore()}drawText(t,e){if(!e||0===e.length)return;this._textRasterizer||(this._textRasterizer=new S);const i=A(t);i.size*=this.transformSize(o.px2pt(1));const s=this._textRasterizer.rasterizeText(e,i);if(!s)return;const{size:r,anchorX:n,anchorY:a,canvas:l}=s,h=r[0]*(n+.5),c=r[1]*(a-.5),m=this._ctx,u=this.transformPt([0,0]),[f,g]=this.getTransformAngle(),d=1;m.save(),m.setTransform({m11:d*f,m12:d*g,m21:-d*g,m22:d*f,m41:u[0]-d*h,m42:u[1]+d*c}),m.drawImage(l,0,0),m.restore()}drawPictureFill(t,e){if(!t)return;let{colorSubstitutions:i,height:s,offsetX:r,offsetY:n,rotation:o,scaleX:a,tintColor:l,url:h}=e;const c=this._resourceManager.getResource(h);if(null==c)return;if(m.isPolygon(t))this._buildPath(t.rings,!0);else if(m.isPolyline(t))this._buildPath(t.paths,!0);else if(m.isExtent(t))this._buildPath(z(t).rings,!0);else{if(!m.isMultipoint(t))return;console.log("CanvasDrawHelper.drawPictureFill - No implementation!")}const u=this._ctx,f=x.isSVGImage(h)||"src"in c&&x.isSVGImage(c.src);let g,d="getFrame"in c?_.getFirstFrame(c):c;if(i&&(d=this._colorSubstitutionHelper.applyColorSubstituition(d,i)),this._applyAdditionalRenderProps){f||l&&(d=this._colorSubstitutionHelper.tintImageData(d,l)),g=u.createPattern(d,"repeat");const t=this.transformSize(1);o||(o=0),r?r*=t:r=0,n?n*=t:n=0,s&&(s*=t);const e=s?s/c.height:1,i=a&&s?a*s/c.width:1;if(0!==o||1!==e||1!==i||0!==r||0!==n){const t=new DOMMatrix;t.rotateSelf(0,0,-o).translateSelf(r,n).scaleSelf(i,e,1),g.setTransform(t)}}else g=u.createPattern(d,"repeat");u.save(),u.fillStyle=g,u.fill("evenodd"),u.restore()}drawPictureStroke(t,e){if(!t)return;let{colorSubstitutions:i,capStyle:r,joinStyle:n,miterLimit:a,tintColor:l,url:h,width:c}=e;const u=this._resourceManager.getResource(h);if(null==u)return;let f;if(m.isPolygon(t))f=t.rings;else if(m.isPolyline(t))f=t.paths;else{if(!m.isExtent(t))return m.isMultipoint(t)?void console.log("CanvasDrawHelper.drawPictureStroke - No implementation!"):void 0;f=z(t).rings}c||(c=u.width);const g=x.isSVGImage(h)||"src"in u&&x.isSVGImage(u.src);let d="getFrame"in u?_.getFirstFrame(u):u;i&&(d=this._colorSubstitutionHelper.applyColorSubstituition(d,i)),this._applyAdditionalRenderProps&&(g||l&&(d=this._colorSubstitutionHelper.tintImageData(d,l)));const y=Math.max(this.transformSize(o.pt2px(c)),.5),p=y/d.width,P=this._ctx,S=P.createPattern(d,"repeat-y");let M,w;P.save(),this._setCapStyle(r),this._setJoinStyle(n),void 0!==a&&(P.miterLimit=a),P.lineWidth=y;for(let o of f)if(o=s.clone(o),G(o),o&&!(o.length<=1)){M=this.transformPt(o[0]);for(let t=1;t<o.length;t++){w=this.transformPt(o[t]);const e=V(M,w),i=new DOMMatrix;i.translateSelf(0,M[1]-y/2).scaleSelf(p,p,1).rotateSelf(0,0,90-e),S.setTransform(i),P.strokeStyle=S,P.beginPath(),P.moveTo(M[0],M[1]),P.lineTo(w[0],w[1]),P.stroke(),M=w}}P.restore()}_buildPath(t,e){const i=this._ctx;if(i.beginPath(),t)for(const s of t){const t=s?s.length:0;if(t>1){let r=this.transformPt(s[0]);i.moveTo(r[0],r[1]);for(let e=1;e<t;e++)r=this.transformPt(s[e]),i.lineTo(r[0],r[1]);e&&i.closePath()}}}_setCapStyle(t){switch(t){case p.LineCapStyle.Butt:this._ctx.lineCap="butt";break;case p.LineCapStyle.Round:this._ctx.lineCap="round";break;case p.LineCapStyle.Square:this._ctx.lineCap="square"}}_setJoinStyle(t){switch(t){case p.LineJoinStyle.Bevel:this._ctx.lineJoin="bevel";break;case p.LineJoinStyle.Round:this._ctx.lineJoin="round";break;case p.LineJoinStyle.Miter:this._ctx.lineJoin="miter"}}}function V(t,e){const i=e[0]-t[0],s=e[1]-t[1];return 180/Math.PI*Math.atan2(s,i)}const z=t=>t?{spatialReference:t.spatialReference,rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]}:null,L=(t,e,i)=>{switch(t){case"ExtraLeading":return 1+e/i;case"Multiple":return e;case"Exact":return e/i}};function A(t,i=1){const s=x.fromCIMFontDecoration(t),r=x.fromCIMFontStyle(t.fontStyleName),n=t.fontFamilyName??e.defaultFontFamily,{weight:o,style:a}=r,l=i*(t.height||5),h=x.fromCIMHorizontalAlignment(t.horizontalAlignment),c=x.fromCIMVerticalAlignment(t.verticalAlignment),m=x.getFillColor(t),u=x.getFillColor(t.haloSymbol),f=null!=u?i*(t.haloSize??0):0,g="CIMBackgroundCallout"===t.callout?.type?t.callout.backgroundSymbol:null,d=x.getFillColor(g),y=x.getStrokeWidth(g),p=x.getStrokeColor(g);return{color:m,size:l,horizontalAlignment:h,verticalAlignment:c,font:{family:n,style:x.getFontStyle(a),weight:x.getFontWeight(o),decoration:s},halo:{size:f||0,color:u,style:a},backgroundColor:d,borderLine:null!=y&&null!=p?{size:y,color:p}:null,pixelRatio:1,premultiplyColors:!0}}const H=1e-4;function G(t){let e,i,s,r,n,o=t[0],a=1;for(;a<t.length;)e=t[a][0]-o[0],i=t[a][1]-o[1],r=0!==e?i/e:Math.PI/2,void 0!==s&&r-s<=H?(t.splice(a-1,1),o=n):(n=o,o=t[a],a++),s=r}t.CIMSymbolDrawHelper=T,t.CanvasDrawHelper=v,t.EnvDrawHelper=R,t.HittestDrawHelper=F,t.Transformation=I,t.cDegToRad=b,t.lineGapType2LineHeight=L,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
