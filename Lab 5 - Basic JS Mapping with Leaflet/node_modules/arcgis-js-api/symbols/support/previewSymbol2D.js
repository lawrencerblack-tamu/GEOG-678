/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../Color","../../core/colorUtils","../../core/Error","../../core/fontUtils","../../core/screenUtils","./gfxUtils","./previewUtils","./renderUtils","./textUtils"],(function(e,t,a,n,l,o,i,s,r,c){"use strict";const h="picture-fill",u="picture-marker",d="simple-fill",m="simple-line",p="simple-marker",f="text",g="Aa",y=s.SymbolSizeDefaults.size,w=s.SymbolSizeDefaults.maxSize,b=s.SymbolSizeDefaults.maxOutlineSize,x=s.SymbolSizeDefaults.lineWidth,v=225,k=document.createElement("canvas");function M(e,t){const a=k.getContext("2d"),n=[];t&&(t.weight&&n.push(t.weight),t.size&&n.push(t.size+"px"),t.family&&n.push(t.family)),a.font=n.join(" ");const{width:l,actualBoundingBoxLeft:o,actualBoundingBoxRight:i,actualBoundingBoxAscent:s,actualBoundingBoxDescent:r}=a.measureText(e);return{width:Math.ceil(Math.max(l,o+i)),height:Math.ceil(s+r),x:Math.floor(o),y:Math.floor((s-r)/2)}}function z(e){const t=e?.size;return{width:null!=t&&"object"==typeof t&&"width"in t?o.pt2px(t.width):null,height:null!=t&&"object"==typeof t&&"height"in t?o.pt2px(t.height):null}}async function L(e,t){const a=t.fill,n=e.color;if("pattern"===a?.type&&n&&e.type!==h){const e=await i.getPatternUrlWithColor(a.src,n.toCss(!0));a.src=e,t.fill=a}}async function S(e,t,a,n){if(!("font"in e)||!e.font||"text"!==t.shape.type)return;try{await l.loadFont(e.font)}catch{}const{width:o,height:i}=z(n);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){const{width:l,height:s,x:r,y:c}=M(t.shape.text,{weight:t.font?.weight,size:t.font?.size,family:t.font?.family});a[0]=o??l,a[1]=i??s,t.shape.x=r,t.shape.y=c;const h=null!=n?.rotation?n.rotation:"angle"in e?e.angle:null;if(h){const e=h*(Math.PI/180),t=Math.abs(Math.sin(e)),n=Math.abs(Math.cos(e));a[1]=a[0]*t+a[1]*n}}}function C(e,t,a,n,l){if(null!=e.haloColor&&null!=e.haloSize){l.masking??=a.map((()=>[]));const i=o.pt2px(e.haloSize);n[0]+=i,n[1]+=i,a.unshift([{...t,fill:null,stroke:{color:e.haloColor,width:2*i,join:"round",cap:"round"}}]),l.masking.unshift([{shape:{type:"rect",x:0,y:0,width:n[0]+2*c.backgroundPadding,height:n[1]+2*c.backgroundPadding},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}null==e.backgroundColor&&null==e.borderLineColor||(n[0]+=2*c.backgroundPadding,n[1]+=2*c.backgroundPadding,a.unshift([{shape:{type:"rect",x:0,y:0,width:n[0],height:n[1]},fill:e.backgroundColor,stroke:{color:e.borderLineColor,width:o.pt2px(e.borderLineSize)}}]),l.masking?.unshift([]))}function B(e,t){return e>t?"dark":"light"}function D(e,t){const a="number"==typeof t?.size?t?.size:null,n=null!=a?o.pt2px(a):null,l=null!=t?.maxSize?o.pt2px(t.maxSize):null,r=null!=t?.rotation?t.rotation:"angle"in e?e.angle:null,c=i.getFill(e);let v=i.getStroke(e);"dark"!==j(e,245)||t?.ignoreWhiteSymbols||(v={width:.75,...v,color:"#bdc3c7"});const k={shape:null,fill:c,stroke:v,offset:[0,0]};v?.width&&(v.width=Math.min(v.width,b));const L=v?.width||0;let S=null!=t?.size&&(null==t?.scale||t?.scale),C=0,B=0,D=!1;switch(e.type){case p:{const a=e.style,{width:i,height:s}=z(t),c=i===s&&null!=i?i:null!=n?n:Math.min(o.pt2px(e.size),l||w);switch(C=c,B=c,a){case"circle":k.shape={type:"circle",cx:0,cy:0,r:.5*c},S||(C+=L,B+=L);break;case"cross":k.shape={type:"path",path:[{command:"M",values:[0,.5*B]},{command:"L",values:[C,.5*B]},{command:"M",values:[.5*C,0]},{command:"L",values:[.5*C,B]}]};break;case"diamond":k.shape={type:"path",path:[{command:"M",values:[0,.5*B]},{command:"L",values:[.5*C,0]},{command:"L",values:[C,.5*B]},{command:"L",values:[.5*C,B]},{command:"Z",values:[]}]},S||(C+=L,B+=L);break;case"square":k.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,0]},{command:"L",values:[C,B]},{command:"L",values:[0,B]},{command:"Z",values:[]}]},S||(C+=L,B+=L),r&&(D=!0);break;case"triangle":k.shape={type:"path",path:[{command:"M",values:[.5*C,0]},{command:"L",values:[C,B]},{command:"L",values:[0,B]},{command:"Z",values:[]}]},S||(C+=L,B+=L),r&&(D=!0);break;case"x":k.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,B]},{command:"M",values:[C,0]},{command:"L",values:[0,B]}]},r&&(D=!0);break;case"path":k.shape={type:"path",path:e.path||""},S||(C+=L,B+=L),r&&(D=!0),S=!0}break}case m:{const{width:e,height:a}=z(t),l=i.getDashArray(v).reduce(((e,t)=>e+t),0),o=l&&Math.ceil(x/l),s=a??n??L,r=e??(l*o||x);v&&(v.width=s),C=r,B=s,S=!0,k.shape={type:"path",path:[{command:"M",values:[s/2,B/2]},{command:"L",values:[C-s/2,B/2]}]};break}case h:case d:{const e="object"==typeof t?.symbolConfig&&!!t?.symbolConfig?.isSquareFill,{width:a,height:l}=z(t);C=!e&&a!==l||null==a?null!=n?n:y:a,B=!e&&a!==l||null==l?C:l,S||(C+=L,B+=L),S=!0,k.shape=e?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,0]},{command:"L",values:[C,B]},{command:"L",values:[0,B]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:s.shapes.fill[0];break}case u:{const a=Math.min(o.pt2px(e.width),l||w),i=Math.min(o.pt2px(e.height),l||w),{width:s,height:c}=z(t),h=s===c&&null!=s?s:null!=n?n:Math.max(a,i),u=a/i;C=u<=1?Math.ceil(h*u):h,B=u<=1?h:Math.ceil(h/u),k.shape={type:"image",x:-Math.round(C/2),y:-Math.round(B/2),width:C,height:B,src:e.url||""},r&&(D=!0);break}case f:{const a=e,i=t?.overrideText||a.text||g,s=a.font,{width:r,height:c}=z(t),h=null!=c?c:null!=n?n:Math.min(o.pt2px(s.size),l||w),{width:u,height:d}=M(i,{weight:s.weight,size:h,family:s.family}),m=/[\uE600-\uE6FF]/.test(i);C=r??(m?h:u),B=m?h:d;let p=.5*(m?h:d);m&&(p+=5),k.shape={type:"text",text:i,x:a.xoffset||0,y:a.yoffset||p,align:"middle",alignBaseline:a.verticalAlignment,decoration:s&&s.decoration,rotated:a.rotated,kerning:a.kerning},k.font=s&&{size:h,style:s.style,decoration:s.decoration,weight:s.weight,family:s.family};break}}return{shapeDescriptor:k,size:[C,B],renderOptions:{node:t?.node,scale:S,opacity:t?.opacity,rotation:r,useRotationSize:D,effectView:t?.effectView,ariaLabel:t?.ariaLabel}}}async function P(e,t){const{shapeDescriptor:a,size:l,renderOptions:o}=D(e,t);if(!a.shape)throw new n("symbolPreview: renderPreviewHTML2D","symbol not supported.");await L(e,a),await S(e,a,l,t);const i=[[a]];if("object"==typeof t?.symbolConfig&&t?.symbolConfig?.applyColorModulation){const e=.6*l[0];i.unshift([{...a,offset:[-e,0],fill:s.adjustColorBrightness(a.fill,-.3)}]),i.push([{...a,offset:[e,0],fill:s.adjustColorBrightness(a.fill,.3)}]),l[0]+=2*e,o.scale=!1}return"text"===e.type&&C(e,a,i,l,o),r.renderSymbol(i,l,o)}function j(e,n=v){const l=i.getFill(e),o=i.getStroke(e),s=!l||"type"in l?null:new t(l),r=o?.color?new t(o?.color):null,c=s?B(a.getColorLuminance(s),n):null,h=r?B(a.getColorLuminance(r),n):null;return h?c?c===h?c:n>=v?"light":"dark":h:c}e.getContrastingBackgroundTheme=j,e.getRenderSymbolParameters=D,e.previewSymbol2D=P,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
