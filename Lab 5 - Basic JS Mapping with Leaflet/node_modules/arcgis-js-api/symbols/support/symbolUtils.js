/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","exports","../../core/has","../../support/arcadeOnDemand","./gfxUtils","./previewUtils","./renderUtils","./utils","../../widgets/Legend/styles/support/relationshipUtils","../../widgets/Legend/support/relationshipRampUtils"],(function(e,t,l,a,i,r,n,o,s,c){"use strict";let u=null;const f=[255,255,255];function p(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function y(e,t,l){const{backgroundColor:a,outline:i,dotSize:n}=e,o=l?.swatchSize||r.SymbolSizeDefaults.size,s=.8,c=Math.round(o*o/Math.max(n,.5)**2*s),f=window.devicePixelRatio,y=document.createElement("canvas"),d=o*f;y.width=d,y.height=d,y.style.width=y.width/f+"px",y.style.height=y.height/f+"px";const h=y.getContext("2d");if(a&&(h.fillStyle=a.toCss(!0),h.fillRect(0,0,d,d),h.fill()),h.fillStyle=t?.toCss(!0)??"",u&&u.length/2===c)for(let r=0;r<2*c;r+=2){const e=u[r],t=u[r+1];h.fillRect(e,t,n*f,n*f),h.fill()}else{u=[];for(let e=0;e<2*c;e+=2){const e=p(0,d),t=p(0,d);u.push(e,t),h.fillRect(e,t,n*f,n*f),h.fill()}}i&&(i.color&&(h.strokeStyle=i.color.toCss(!0)),h.lineWidth=i.width,h.strokeRect(0,0,d,d));const b=new Image(o,o);return b.src=y.toDataURL(),b.ariaLabel=l?.ariaLabel??null,b.alt=l?.ariaLabel??"",b}function d(e,t={}){const l=t.radius||40,a=2*Math.PI*l,r=e.length,o=a/r,s=[],c=i.getStroke(t.outline);null!=c?.width&&(c.width*=2),(c||t.backgroundColor)&&s.push({shape:{type:"circle",cx:l,cy:l,r:l},fill:t.backgroundColor,stroke:c,offset:[0,0]});const u=t.values,p=u&&u.length===r&&100===u.reduce(((e,t)=>e+t),0),y=[0];for(let i=0;i<r;i++){let t=null;p&&(t=u[i]*a/100,y.push(t+y[i])),s.push({shape:{type:"circle",cx:l,cy:l,r:l/2},fill:[0,0,0,0],stroke:{width:l,dashArray:`${(t??o)/2} ${a}`,dashoffset:"-"+(p?y[i]/2:i*(o/2)),color:e[i]},offset:[0,0]})}let d=null;const h=2*l+(c?.width||0),b=t.holePercentage;if(b){c&&s.push({shape:{type:"circle",cx:l,cy:l,r:l*b},fill:null,stroke:c,offset:[0,0]});const e=h/2;d=[[{shape:{type:"circle",cx:e,cy:e,r:e},fill:f,stroke:c?{...c,color:f}:null,offset:[0,0]},{shape:{type:"circle",cx:e,cy:e,r:l*b},fill:[0,0,0],stroke:null,offset:[0,0]}]]}return n.renderSymbol([s],[h,h],{effectView:t.effectList,ignoreStrokeWidth:!0,masking:d,rotation:-90,ariaLabel:t.ariaLabel})}function h(e,t={}){const l=e?.authoringInfo;if(!("relationship"===l?.type)||!l?.numClasses||!e.uniqueValueInfos)return null;const{focus:a,numClasses:i}=l,r=c.getRelationshipRampElement({focus:a,numClasses:i,infos:e.uniqueValueInfos}),o=t?.node||document.createElement("div"),u=()=>s.renderRelationshipRamp(r,t.id||"relationship",{opacity:t.opacity||1,effectList:t.effectList,ariaLabel:t.ariaLabel});return n.renderOnce(o,u),o}function b(e,t={}){const l=24,a=75,i="horizontal"===t.align,r=i?a:l,n=i?l:a,o=t.width??r,s=t.height??n,c=t.gradient??!0,u=window.devicePixelRatio,f=o*u,p=s*u,y=document.createElement("canvas");y.width=f,y.height=p,y.ariaLabel=t.ariaLabel??null,y.style.width=`${o}px`,y.style.height=`${s}px`;const d=y.getContext("2d"),h=i?f:0,b=i?0:p;if(c){const t=d.createLinearGradient(0,0,h,b),l=e.length,a=1===l?0:1/(l-1);e.forEach(((e,l)=>t.addColorStop(l*a,e.toString()))),d.fillStyle=t,d.fillRect(0,0,f,p)}else{const t=i?f/e.length:f,l=i?p:p/e.length;let a=0,r=0;for(const n of e)d.fillStyle=n.toString(),d.fillRect(a,r,t,l),a=i?a+t:0,r=i?0:r+l}const m=document.createElement("div");return m.style.width=`${o}px`,m.style.height=`${s}px`,g(m,t?.effectList),m.appendChild(y),m}function g(e,t){if(!t)return;e.style.filter=o.getCSSFilterFromEffectList(t);const l=t.effects;if(l)for(const a of l)if("drop-shadow"===a?.type){a.offsetX<0?e.style.marginLeft=`${Math.abs(a.offsetX)}px`:e.style.marginRight=`${a.offsetX}px`;break}}async function m(t,l){switch(t.type){case"web-style":{const{previewWebStyleSymbol:a}=await new Promise(((t,l)=>e(["./previewWebStyleSymbol"],t,l)));return a(t,m,l)}case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":{const{previewSymbol3D:a}=await new Promise(((t,l)=>e(["./previewSymbol3D"],t,l)));return a(t,l)}case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":{const{previewSymbol2D:a}=await new Promise(((t,l)=>e(["./previewSymbol2D"],t,l)));return a(t,l)}case"cim":{const{previewCIMSymbol:a}=await new Promise(((t,l)=>e(["./previewCIMSymbol"],t,l)));return a(t,l)}default:return}}function w(e){return e&&"opacity"in e?e.opacity*w(e.parent):1}async function S(t,l){if(!t)return;const i=t.sourceLayer,r=(null!=l&&l.useSourceLayer?i:t.layer)??i,n=w(r);if(null!=t.symbol&&(null==l||!0!==l.ignoreGraphicSymbol)){const e="web-style"===t.symbol.type?await o.fetchWebStyleSymbol(t.symbol,{...l,cache:null!=l?l.webStyleCache:null}):t.symbol.clone();return o.applyColorToSymbol(e,null,n),e}const s=l?.renderer??L(r);let c=s&&"getSymbolAsync"in s?await s.getSymbolAsync(t,l):null;if(!c)return;if(c="web-style"===c.type?await c.fetchSymbol({...l,cache:null!=l?l.webStyleCache:null}):c.clone(),!s||!("visualVariables"in s)||!s.visualVariables?.length)return o.applyColorToSymbol(c,null,n),c;if("arcadeRequiredForVisualVariables"in s&&s.arcadeRequiredForVisualVariables&&null==l?.arcade){const e={...l};e.arcade=await a.loadArcade(),l=e}const{getColor:u,getOpacity:f,getAllSizes:p,getRotationAngle:y}=await new Promise(((t,l)=>e(["../../renderers/visualVariables/support/visualVariableUtils"],t,l))),d=[],h=[],b=[],g=[];for(const e of s.visualVariables)switch(e.type){case"color":d.push(e);break;case"opacity":h.push(e);break;case"rotation":g.push(e);break;case"size":e.target||b.push(e)}const m=!!d.length&&d[d.length-1],S=m?u(m,t,l):null,v=!!h.length&&h[h.length-1];let C=v?f(v,t,l):null;if(null!=n&&(C=null!=C?C*n:n),o.applyColorToSymbol(c,S,C),b.length){const e=p(b,t,l);await o.applySizesToSymbol(c,e)}for(const e of g)o.applyRotationToSymbol(c,y(e,t,l),e.axis);return c}async function v(t,l){if(!t)return;const{layer:i,sourceLayer:r}=t,n=w(i??r);if(null!=t.symbol&&(null==l||!0!==l.ignoreGraphicSymbol)){const e="web-style"===t.symbol.type?await o.fetchWebStyleSymbol(t.symbol,l):t.symbol.clone();return o.getColorFromSymbol(e,n)}const s=l?.renderer??L(i)??L(r);let c=s&&"getSymbolAsync"in s?await s.getSymbolAsync(t,l):void 0;if(!c)return;c="web-style"===c.type?await o.fetchWebStyleSymbol(c,l):c.clone();const u=o.getColorFromSymbol(c,n);if(!s||!("visualVariables"in s)||"visualVariables"in s&&!s.visualVariables||"visualVariables"in s&&!s.visualVariables?.length)return u;if("arcadeRequiredForVisualVariables"in s&&s.arcadeRequiredForVisualVariables&&null==l?.arcade){const e={...l};e.arcade=await a.loadArcade(),l=e}const{getColor:f,getOpacity:p}=await new Promise(((t,l)=>e(["../../renderers/visualVariables/support/visualVariableUtils"],t,l))),y=[],d=[];for(const e of s.visualVariables)switch(e.type){case"color":y.push(e);break;case"opacity":d.push(e)}const h=y.length>0?y[y.length-1]:null,b=h?f(h,t,l):u,g=d.length>0?d[d.length-1]:null;let m=g?p(g,t,l):null;return null!=n&&(m=null!=m?m*n:n),b?o.applyOpacityToColor(b,m):null}function L(e){if(e)return"renderer"in e?e.renderer:void 0}async function C(t,l,a){if(!t)return;const{layer:i,sourceLayer:r}=t,n=a?.renderer??L(i)??L(r);if(!n)return null;if("visualVariables"in n&&n.visualVariables?.length){const{getRampStops:r}=await new Promise(((t,l)=>e(["../../widgets/Legend/support/colorRampUtils"],t,l))),{getRampStops:o}=await new Promise(((t,l)=>e(["../../widgets/Legend/support/sizeRampUtils"],t,l))),{getDateFormatOptions:s}=await new Promise(((t,l)=>e(["../../widgets/Legend/support/utils"],t,l)));let c=null;for(const e of n.visualVariables){const u=l?s(i,e,l.timeZone):null;let f=null;switch(e.type){case"color":f=await r(e,null,u);break;case"opacity":f=await r(e);break;case"size":e.target||(f=await o(n,e,null,a?.scale||l?.scale,l,u))}if(f?.length){const l=f.find(((l,a)=>{const i=t.attributes[e.field];return 0===a?i>=l.value:a===f?.length-1?i<=l.value:l.value===i}));if(l){c=l.label;break}}}if(c)return c}switch(n.type){case"class-breaks":{const e="getClassBreakInfo"in n?await n.getClassBreakInfo(t,a):null;return e?.label??(e&&n.classBreakInfos?.length>1)?`${e.minValue} - ${e.maxValue}`:null}case"unique-value":{const e="getUniqueValueInfo"in n?await n.getUniqueValueInfo(t,a):null;return e?.label}}return null}t.getDisplayedColor=v,t.getDisplayedSymbol=S,t.getLegendLabel=C,t.renderColorRampPreviewHTML=b,t.renderDotDensityPreviewHTML=y,t.renderPieChartPreviewHTML=d,t.renderPreviewHTML=m,t.renderRelationshipRampPreviewHTML=h,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
