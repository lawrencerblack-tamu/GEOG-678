/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","exports","../../core/Error","../../core/MultiOriginJSONSupport","../../core/reactiveUtils","../../core/urlUtils","../../core/accessorSupport/originUtils","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../layers/support/arcgisLayerUrl","../../layers/support/layerUtils","../../portal/Portal","../../portal/PortalItem","../../portal/support/jsonContext","../../portal/support/portalItemUtils","../../rest/geometryService/project","../../rest/support/ProjectParameters","../../support/basemapUtils","./resourceUtils","./saveAPIKeyUtils","./saveUtils"],(function(e,t,a,r,o,i,n,s,l,p,c,d,y,u,w,m,f,v,h,g,T,b){"use strict";const K=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((e=>e.toLowerCase()));async function S(e,t,a){a??={},R(e,t),await o.whenOnce((()=>!t.updatingFromView)),await t.load(),await A(t),await b.beforeSave(t),await O(e,t);const r=t.portalItem,i=w.createForItemWrite(r,"web-map",!0),n=t.write({},i);return await Promise.all(i.resources.pendingOperations),b.evaluateWriteErrors(i,{errorName:`${e.name}:save`},a),await L(t,r),await pe(e,t,r,n,i),await Promise.all([t.updateItemThumbnail(),g.saveResources(t.resourceReferences,i)]),r}async function _(e,t,a,r){r??={};const i=I(e,a);await o.whenOnce((()=>!t.updatingFromView)),await t.load(),W(e,t),await A(t),await b.beforeSave(t),await O(e,t);const n=w.createForItemWrite(i,"web-map",!0),s=t.write({},n);await Promise.all(n.resources.pendingOperations),b.evaluateWriteErrors(n,{errorName:`${e.name}:save`},r),await J(t,i);const l=t.getThumbnailState();return await ce(e,t,i,s,n,r)&&(t.resourceReferences.portalItem=i),t.restoreThumbnailFromState(l),await Promise.all([t.updateItemThumbnail(),g.saveResources(t.resourceReferences,n)]),i}function R(e,t){if(!t.portalItem)throw new a(`${e.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");T.validateSaveAPIKey(t.portalItem),P(e,t.portalItem)}function P(e,t){if(t.type!==e.itemType)throw new a(`${e.name}:portal-item-wrong-type`,`Portal item needs to have type "${e.itemType}"`)}function W(e,t){const r=t.allLayers.filter((e=>"unsupported"===e.type&&"KnowledgeGraphLayer"===e.resourceInfo?.layerType));if(r.length)throw new a(`${e.name}:save-as-invalid-configuration`,`Failed to save a copy of ${e.name} to prevent persisting invalid configuration. See 'details.layers'`,{layers:r.toArray()})}async function O(e,t){if(!t.basemap?.baseLayers.length)throw new a(`${e.name}:save`,"Map does not have a valid basemap with a base layer.");let r=null;if(await o.whenOnce((()=>{const e=h.findSpatialReference(t.initialViewProperties,t.basemap);return r=e.spatialReference,!e.updating})),!l.equals(r,t.initialViewProperties.spatialReference))throw new a(`${e.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:t.initialViewProperties.spatialReference,actual:r})}function I(e,t){let a=u.from(t);return a.id&&(a=a.clone(),a.id=null),a.type||(a.type=e.itemType),a.portal||(a.portal=y.getDefault()),T.validateSaveAPIKey(a),P(e,a),a}function A(e){const t=[];return e.basemap&&t.push(e.basemap.load()),e.ground&&t.push(e.ground.load()),Promise.allSettled(t).then((()=>{}))}async function L(e,t){t.extent=await oe(e.portalItem,e.initialViewProperties.viewpoint.targetGeometry),await q(e,t)}const U=m.typeKeyword.JSAPI,M="CollectorDisabled",C="Collector",D="Data Editing",E="OfflineDisabled",G="Offline",V="Workforce Project",F="Workforce Worker",$="Workforce Dispatcher",B="Offline Map Areas",k="FieldMapsDisabled",N=m.typeKeyword.DEVELOPER_BASEMAP,j="UtilityNetwork",x="IPS";async function J(e,t){m.removeTypeKeyword(t,M),m.removeTypeKeyword(t,k),m.removeTypeKeyword(t,m.typeKeyword.METADATA),m.removeTypeKeyword(t,E),m.removeTypeKeyword(t,B),m.removeTypeKeyword(t,$),m.removeTypeKeyword(t,V),m.removeTypeKeyword(t,F),await L(e,t)}async function q(e,t){m.addTypeKeyword(t,U),await H(e),Y(e,t),Z(e,t),ee(e,t),te(e,t),ae(e,t),re(e,t),t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter(((e,t,a)=>a.indexOf(e)===t)))}function H(e){const t=z(e).map((e=>e.load())).toArray();return Promise.allSettled(t).then((()=>{}))}function z(e){return e.allLayers.concat(e.allTables)}function Q(e){return z(e).some((e=>e.loaded&&d.isLayerWithFeatureLayerSource(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&("subtype-group"!==e.type||e.sublayers.some((e=>e.editingEnabled)))))}function X(e){return z(e).filter((e=>"group"!==e.type)).every((t=>t.loaded&&se(e,t)))}function Y(e,t){m.hasTypeKeyword(t,M)||m.hasTypeKeyword(t,V)||m.hasTypeKeyword(t,F)||m.hasTypeKeyword(t,$)||!Q(e)?m.removeTypeKeyword(t,C):m.addTypeKeyword(t,C)}function Z(e,t){Q(e)?m.addTypeKeyword(t,D):m.removeTypeKeyword(t,D)}function ee(e,t){!m.hasTypeKeyword(t,E)&&X(e)?m.addTypeKeyword(t,G):m.removeTypeKeyword(t,G)}function te(e,t){h.hasDeveloperBasemapLayer(e.basemap)?m.addTypeKeyword(t,N):m.removeTypeKeyword(t,N)}function ae(e,t){e.utilityNetworks?.length?m.addTypeKeyword(t,j):m.removeTypeKeyword(t,j)}function re(e,t){e.ipsInfo?m.addTypeKeyword(t,x):m.removeTypeKeyword(t,x)}async function oe(e,t){const a=t.clone().normalize();let r;if(a.length>1)for(const o of a)r?o.width>r.width&&(r=o):r=o;else r=a[0];return ie(e,r)}async function ie(t,a){const r=a.spatialReference;if(r.isWGS84)return a.clone();if(r.isWebMercator)return p.webMercatorToGeographic(a);const{getGeometryServiceURL:o}=await new Promise(((t,a)=>e(["../../portal/support/geometryServiceUtils"],t,a))),i=await o(t),n=new v;n.geometries=[a],n.outSpatialReference=s.WGS84;return(await f.project(i,n))[0]}function ne(e){return d.isFeatureCollectionLayer(e)||"map-notes"===e.type||"route"===e.type}function se(e,t){return d.isLayerWithFeatureLayerSource(t)&&t.capabilities.operations.supportsSync||ne(t)&&!t.portalItem||("tile"===t.type||"vector-tile"===t.type)&&(t.capabilities.operations.supportsExportTiles||le(t)||h.isDeveloperBasemapLayer(t))&&t.spatialReference.equals(e.initialViewProperties.spatialReference)}function le(e){return"tile"===e.type&&(c.isServerOrServicesAGOLUrl(e.url)&&K.some((t=>e.url?.toLowerCase().includes("/"+t+"/"))))}async function pe(e,t,a,r,o){await a.update({data:r}),ue(e,t,a,r,o)}async function ce(e,t,r,o,i,n){const s=t.portalItem,l={item:s,authenticated:!(!s?.id||!s.portal.user)},p=r.portal;await p.signIn();const{copyAllowed:c,itemReloaded:d}=await de(l,p);if(l.authenticated||=d,!c)throw new a(`${e.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const y=await ye(r,l,o,n);return t.portalItem=r,ue(e,t,r,o,i),y}async function de(e,t){const{item:a,authenticated:r}=e;return a?.id&&a.typeKeywords?.includes("useOnly")?a.portal.portalHostname!==t.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(r||await a.reload(),{copyAllowed:"admin"===a.itemControl||"update"===a.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function ye(e,t,a,r){const o=e.portal,{item:n}=t,{folder:s,copyAllResources:l}=r;let p=!1;if(l&&n?.id&&i.hasSameCanonicalPortal(n.portal.url,o.url)&&parseInt(n.portal.currentVersion,10)>=2023){const{total:e}=await n.fetchResources();p=!!e}if(p){const t=await n.copy({copyResources:"all",folder:s});e.id=t.id,e.portal=t.portal;const r=e.toJSON();await e.load(),e.read(r),await e.update({data:a})}else await(o.user?.addItem({item:e,folder:s,data:a}));return p}function ue(e,t,a,o,s){r.MultiOriginJSONSupport.prototype.read.call(t,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{origin:e.origin,ignoreDefaults:!0,url:a.itemUrl?i.urlToObject(a.itemUrl):void 0}),n.updateOrigins(s),t.resourceInfo=o}t.save=S,t.saveAs=_,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
