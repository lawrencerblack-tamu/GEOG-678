/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","exports","../../core/Error","../../core/promiseUtils","../../core/uuid","../../portal/support/resourceUtils"],(function(e,t,r,o,s,a){"use strict";async function c(e,t,r){const o=await u(e,t,r);await p(o,t,r)}async function n(e,t,r,o,s){const a=await u(r,o,s);await e.update({data:t}),await p(a,o,s)}async function u(t,c,n){if(!c?.resources)return;const u=c.portalItem===t.portalItem?new Set(t.paths):new Set;t.paths.length=0,t.portalItem=c.portalItem;const p=new Set(c.resources.toKeep.map((e=>e.resource.path))),i=new Set,h=[];p.forEach((e=>{u.delete(e),t.paths.push(e)}));const l=[],f=[],d=[];for(const e of c.resources.toUpdate)if(u.delete(e.resource.path),p.has(e.resource.path)||i.has(e.resource.path)){const{resource:r,content:o,finish:c}=e,n=a.getSiblingOfSameTypeI(r,s.generateUUID());t.paths.push(n.path),l.push({resource:n,content:await a.contentToBlob(o),compress:e.compress}),c&&d.push((()=>c(n)))}else{t.paths.push(e.resource.path),f.push({resource:e.resource,content:await a.contentToBlob(e.content),compress:e.compress});const r=e.finish;r&&d.push((()=>r(e.resource))),i.add(e.resource.path)}for(const e of c.resources.toAdd)if(t.paths.push(e.resource.path),u.has(e.resource.path))u.delete(e.resource.path);else{l.push({resource:e.resource,content:await a.contentToBlob(e.content),compress:e.compress});const t=e.finish;t&&d.push((()=>t(e.resource)))}if(l.length||f.length){const{addOrUpdateResources:t}=await new Promise(((t,r)=>e(["../../portal/support/resourceUtils"],t,r)));await t(c.portalItem,l,"add",n),await t(c.portalItem,f,"update",n)}if(d.forEach((e=>e())),0===h.length)return u;const m=await o.allSettledErrors(h);if(o.throwIfAborted(n),m.length>0)throw new r("save:resources","Failed to save one or more resources",{errors:m});return u}async function p(e,t,r){if(!e||!t.portalItem)return;const s=[];for(const o of e){const e=t.portalItem.resourceFromPath(o);s.push(e.portalItem.removeResource(e,r))}await o.eachAlways(s)}t.saveResources=c,t.updateItemWithResources=n,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
