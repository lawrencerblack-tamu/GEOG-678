/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","exports","../../Viewpoint","../../core/Error","../../core/Logger","../../geometry/support/webMercatorUtils","../../portal/Portal","../../portal/support/jsonContext","../../rest/geometryService/project","../../rest/support/ProjectParameters"],(function(e,t,r,o,n,a,i,s,c,l){"use strict";function p(e,t){return t.resourceInfo?u(t,t.resourceInfo,{origin:e.origin}):t.portalItem?.id?m(e,t,t.portalItem):Promise.resolve()}function u(t,r,o){const n={context:{...o,layerContainerType:"operational-layers"}};return t.portalItem&&(n.context.portal=t.portalItem.portal||i.getDefault()),new Promise(((t,r)=>e(["../../layers/support/layersCreator"],t,r))).then((({populateOperationalLayers:e})=>{const o=[],a=r.operationalLayers;a?.length&&o.push(e(t.layers,a,n));const i={...n,context:{...n.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"},s=r.tables;return s?.length&&o.push(e(t.tables,s,i)),Promise.allSettled(o).then((()=>{}))}))}async function m(e,t,r){if(await r.load().catch((t=>{throw new o(`${e.name}:load-portal-item`,"Failed to load portal item",{error:t})})),r.type!==e.itemType)throw new o(`${e.name}:invalid-portal-item`,`Invalid portal item type '${r.type}', expected '${e.itemType}'`,{type:r.type});const a=await r.fetchData();t.resourceInfo=a;const i=s.createForItemRead(r,e.origin);await y(e,t,a,i),t.resourceReferences={portalItem:r,paths:i.readResourcePaths};const c=await w(t.initialViewProperties,r,n.getLogger(t));if(c){const r=t.initialViewProperties?.clone()??e.createInitialViewProperties();r.viewpoint=c,t.initialViewProperties=r}}function y(e,t,r,o){const n=f(e,r);return t.read(n,o),u(t,n,o)}function f(e,t){const r=e.parseVersion(t.version||"",e.name);return e.currentVersion.validate(r),t.version=`${r.major}.${r.minor}`,t}async function w(e,t,o){const n=e?.viewpoint?.targetGeometry;if(n)return null;const a=await g(e,t,o);if(!a)return null;return new r({targetGeometry:a})}async function g(t,r,o){const n=t?.spatialReference,i=r?.extent;if(!n||!i)return null;if(n.isWGS84)return i.clone();if(n.isWebMercator)return a.geographicToWebMercator(i);const{getGeometryServiceURL:s}=await new Promise(((t,r)=>e(["../../portal/support/geometryServiceUtils"],t,r)));try{const e=await s(r),t=new l;t.geometries=[i],t.outSpatialReference=n;return(await c.project(e,t))[0]}catch(p){o.error("Error projecting item's extent:",p)}return null}t.loadFromSource=p,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
