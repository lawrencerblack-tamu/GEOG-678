/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","../../chunks/tslib.es6","../../request","../../core/has","../../core/jsonMap","../../core/JSONSupport","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","../utils","../geoprocessor/GPOptions","../geoprocessor/utils","./GPMessage"],(function(e,t,r,s,o,a,i,n,c,u,l,p,b,d,h,j){"use strict";const m=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));var g;const y=o.strict()({esriJobCancelled:"job-cancelled",esriJobCancelling:"job-cancelling",esriJobDeleted:"job-deleted",esriJobDeleting:"job-deleting",esriJobTimedOut:"job-timed-out",esriJobExecuting:"job-executing",esriJobFailed:"job-failed",esriJobNew:"job-new",esriJobSubmitted:"job-submitted",esriJobSucceeded:"job-succeeded",esriJobWaiting:"job-waiting"},{ignoreUnknown:!1});let _=g=class extends a.JSONSupport{constructor(e){super(e),this.jobId=null,this.jobStatus=null,this.messages=null,this.progress=null,this.requestOptions=null,this.sourceUrl=null,this._timer=void 0}async cancelJob(e){const{jobId:t,sourceUrl:s}=this,{path:o}=b.parseUrl(s),a={...this.requestOptions,...e,query:{f:"json"}};this._clearTimer();const i=`${o}/jobs/${t}/cancel`,{data:n}=await r(i,a),{messages:c,jobStatus:u,progress:l}=g.fromJSON(n);return this.set({messages:c,jobStatus:u,progress:l}),this}destroy(){clearInterval(this._timer)}async checkJobStatus(e){const{path:t}=b.parseUrl(this.sourceUrl),s={...this.requestOptions,...e,query:{f:"json"}},o=`${t}/jobs/${this.jobId}`,{data:a}=await r(o,s),{messages:i,jobStatus:n,progress:c}=g.fromJSON(a);return this.set({messages:i,jobStatus:n,progress:c}),this}async fetchResultData(e,t,s){t=d.from(t||{});const{returnColumnName:o,returnFeatureCollection:a,returnM:i,returnZ:n,outSpatialReference:c}=t,{path:u}=b.parseUrl(this.sourceUrl),l={returnColumnName:o||null,returnFeatureCollection:a||null,returnM:i||null,returnZ:n||null,outSR:c,returnType:"data",f:"json"},p=h.gpEncode(l,null),j={...this.requestOptions,...s,query:p},m=`${u}/jobs/${this.jobId}/results/${e}`,{data:g}=await r(m,j);return h.decode(g)}async fetchResultImage(e,t,s){const{path:o}=b.parseUrl(this.sourceUrl),a={...t.toJSON(),f:"json"},i=h.gpEncode(a),n={...this.requestOptions,...s,query:i},c=`${o}/jobs/${this.jobId}/results/${e}`,{data:u}=await r(c,n);return h.decode(u)}async fetchResultMapImageLayer(){const{path:t}=b.parseUrl(this.sourceUrl),r=t.indexOf("/GPServer/"),s=`${t.substring(0,r)}/MapServer/jobs/${this.jobId}`;return new(0,(await new Promise(((t,r)=>e(["../../layers/MapImageLayer"],(e=>t(m(e))),r)))).default)({url:s})}async waitForJobCompletion(e={}){const{interval:t=1e3,signal:r,statusCallback:s}=e;return new Promise(((e,o)=>{i.onAbort(r,(()=>{this._clearTimer(),o(i.createAbortError())})),this._clearTimer();const a=setInterval((()=>{this._timer||o(i.createAbortError()),this.checkJobStatus(this.requestOptions).then((t=>{const{jobStatus:r}=t;switch(this.jobStatus=r,r){case"job-succeeded":this._clearTimer(),e(this);break;case"job-submitted":case"job-executing":case"job-waiting":case"job-new":s&&s(this);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-timed-out":case"job-failed":this._clearTimer(),o(this)}}))}),t);this._timer=a}))}_clearTimer(){clearInterval(this._timer),this._timer=void 0}};t.__decorate([n.property()],_.prototype,"jobId",void 0),t.__decorate([l.enumeration(y,{ignoreUnknown:!1})],_.prototype,"jobStatus",void 0),t.__decorate([n.property({type:[j]})],_.prototype,"messages",void 0),t.__decorate([n.property()],_.prototype,"progress",void 0),t.__decorate([n.property()],_.prototype,"requestOptions",void 0),t.__decorate([n.property({json:{write:!0}})],_.prototype,"sourceUrl",void 0),_=g=t.__decorate([p.subclass("esri.rest.support.JobInfo")],_);return _}));
