/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../core/sql","../../geometry/support/jsonUtils","../../geometry/support/scaleUtils","../../geometry/support/spatialReferenceUtils","../../layers/support/floorFilterUtils","../../layers/support/sublayerUtils"],(function(e,t,r,n,i,s,l){"use strict";function o(e,t){const{dpi:n,gdbVersion:s,geometry:l,geometryPrecision:o,height:y,historicMoment:f,layerOption:p,mapExtent:u,maxAllowableOffset:c,returnFieldName:m,returnGeometry:d,returnUnformattedValues:g,returnZ:x,spatialReference:S,timeExtent:b,tolerance:h,width:E}=e.toJSON(),{dynamicLayers:O,layerDefs:N,layerIds:R}=a(e),I=null!=t?.geometry?t.geometry:null,J={historicMoment:f,geometryPrecision:o,maxAllowableOffset:c,returnFieldName:m,returnGeometry:d,returnUnformattedValues:g,returnZ:x,tolerance:h},T=I&&I.toJSON()||l;J.imageDisplay=`${E},${y},${n}`,s&&(J.gdbVersion=s),T&&(delete T.spatialReference,J.geometry=JSON.stringify(T),J.geometryType=r.getJsonType(T));const $=S??T?.spatialReference??u?.spatialReference;if($&&(J.sr=i.srToRESTValue($)),J.time=b?[b.start,b.end].join(","):null,u){const{xmin:e,ymin:t,xmax:r,ymax:n}=u;J.mapExtent=`${e},${t},${r},${n}`}return N&&(J.layerDefs=N),O&&!N&&(J.dynamicLayers=O),J.layers="popup"===p?"visible":p,R&&!O&&(J.layers+=`:${R.join(",")}`),J}function a(e){const{mapExtent:t,floors:r,width:i,sublayers:o,layerIds:a,layerOption:f,gdbVersion:p}=e,u=o?.find((e=>null!=e.layer))?.layer?.serviceSublayers,c="popup"===f,m={},d={extent:t,width:i,spatialReference:t?.spatialReference},g=n.getScale(d),x=[],S=e=>{const t=0===g,r=0===e.minScale||g<=e.minScale,n=0===e.maxScale||g>=e.maxScale;if(e.visible&&(t||r&&n))if(e.sublayers)e.sublayers.forEach(S);else{if(!1===a?.includes(e.id)||c&&(!e.popupTemplate||!e.popupEnabled))return;x.unshift(e)}};if(o?.forEach(S),o&&!x.length)m.layerIds=[];else{const e=l.isExportDynamic(x,u,p),t=x.map((e=>{const t=s.getLayerFloorFilterClause(r,e);return e.toExportImageJSON(t)}));if(e)m.dynamicLayers=JSON.stringify(t);else{if(o){let e=x.map((({id:e})=>e));a&&(e=e.filter((e=>a.includes(e)))),m.layerIds=e}else a?.length&&(m.layerIds=a);const e=y(r,x);if(null!=e&&e.length){const t={};for(const r of e)r.definitionExpression&&(t[r.id]=r.definitionExpression);Object.keys(t).length&&(m.layerDefs=JSON.stringify(t))}}}return m}function y(e,r){const n=!!e?.length,i=r.filter((e=>null!=e.definitionExpression||n&&null!=e.floorInfo));return i.length?i.map((r=>{const n=s.getLayerFloorFilterClause(e,r),i=t.sqlAnd(n,r.definitionExpression);return{id:r.id,definitionExpression:i??void 0}})):null}e.identifyToIdentifyRESTParameters=o,e.toDynamicLayersJSON=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
