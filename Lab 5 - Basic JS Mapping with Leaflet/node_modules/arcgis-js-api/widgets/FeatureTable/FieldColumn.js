/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Logger","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../intl/date","../../intl/number","../../layers/support/CodedValue","../../layers/support/CodedValueDomain","../../layers/support/editableLayers","../../layers/support/fieldUtils","../../layers/support/layerUtils","../../smartMapping/support/utils","../FeatureForm/FieldInput","./Grid/EditorColumn","../support/dateUtils","../support/legacyIcon","../support/widgetUtils"],(function(e,t,i,n,a,o,r,l,s,d,u,p,c,m,h,y,_,f,g){"use strict";const v={cancelEdit:"Escape"},F="esri-field-column",b={headerRoot:`${F}__header-root`,headerRootEditable:`${F}__header-root--editable`,headerRootMenuEnabled:`${F}__header-root--menu-enabled`,headerContent:`${F}__header-content`,headerLabel:`${F}__header-label`,input:`${F}__cell-input`,inputContainer:`${F}__cell__input-container`,dateInputContainer:`${F}__cell__date-input-container`},C=r.convertDateFormatToIntlOptions("short-date-short-time"),D=r.convertDateFormatToIntlOptions("short-date"),E={useGrouping:!0,maximumFractionDigits:20};let I=class extends y{constructor(e){super(e),this._activeFieldInput=null,this.cellValueFormatFunction=({rowData:e,value:t})=>{if(this.formatFunction){const{template:e,field:i}=this;return this.formatFunction({template:e,field:i,value:g.renderingSanitizer.sanitize(t)})}if(null===t)return"&nbsp;";const{field:i}=this,n=this._getDomainForFeature(e?.item?.feature);if(n){const e=this._getComputedDomain(t,n);if("date"===i.type&&"range"===n.type)return this._formatDateValueForDisplay(i,e);if(p.isNumericField(i)&&"range"===n.type){const e=this.template?.format,i=e?l.convertNumberFormatToIntlOptions(e):E;return l.formatNumber(parseFloat(t),i)}return _.dateFieldsWithStringFieldValue.has(i.type)?"range"===n.type?g.renderingSanitizer.sanitize(_.getLabelForDateFieldValue(i,e)):g.renderingSanitizer.sanitize(e):e}if("date"===i.type||_.dateFieldsWithStringFieldValue.has(i.type))return this._formatDateValueForDisplay(i,t);if(p.isNumericField(i)){const e=this.template?.format,i=e?l.convertNumberFormatToIntlOptions(e):E;return l.formatNumber(parseFloat(t),i)}return g.renderingSanitizer.sanitize(t)},this.cellValueValidatorFunction=({oldValue:e,value:i})=>{const{field:n}=this;if(this.required&&(null==i||""===i))return!1;if(p.isNumericField(n)&&p.validateFieldValue(n,i))return t.getLogger(this).warn("value-exceeds-valid-range","Field value exceeds valid range. Attempted edit was rejected."),!1;if(this._isAnyDateOrTimeField){const e=n.type,t=this._effectiveRange;if(!_.dateTimeIsInRange({type:e,range:t,value:i}))return!1}return e!==i},this.editingEnabled=!1,this.expressionInfos=null,this.field=null,this.formatFunction=null,this.headerRenderFunction=e=>{const{root:t}=e,{editable:i,editingEnabled:n,headerMenuEnabled:a,menu:o,sortable:r}=this;if(!t.childElementCount){t.classList.add(b.headerRoot);const e=document.createElement("div");e.classList.add(b.headerContent),t.appendChild(e);const i=document.createElement("div");if(i.classList.add(f.legacyIcon.locked),e.appendChild(i),r&&this.sortElement)e.appendChild(this.sortElement);else{const t=document.createElement("span");t.classList.add(b.headerLabel),t.textContent=this.label,e.appendChild(t)}o?.container&&e.appendChild(o.container)}n&&!i?t.classList.add(b.headerRootEditable):t.classList.remove(b.headerRootEditable),a&&o?.items?.length?t.classList.add(b.headerRootMenuEnabled):t.classList.remove(b.headerRootMenuEnabled)},this.inputRenderFunction=({root:e,column:i,rowData:n})=>{if(this.activeEditInfo||!this.editable)return;const a=this.getCellValue(i,n),{field:o}=this;if(p.isNumericField(o)&&p.validateFieldValue(o,a))return void t.getLogger(this).warn("value-exceeds-valid-range","Field value is beyond supported limit. Editing is disabled for this field value.");const r=n?.item.feature;if(!r)return;this._activeFieldInput=this._setUpFieldInput(r,a);const l=document.createElement("div");l.classList.add(b.inputContainer);const s=[],d="coded-value"===this._effectiveDomain?.type;if(this._isAnyDateOrTimeField&&!d){const e=document.createElement("div");e.classList.add(b.dateInputContainer);const t=this._setUpDateComponents(a),i=this._setUpDateActionBar();t.forEach((t=>e.appendChild(t))),l.appendChild(e),l.appendChild(i),s.push(...t)}else{const t=this.createInputElement({root:e,column:i,rowData:n,value:a});l.appendChild(t),s.push(t)}this._set("activeEditInfo",{column:i,inputs:s,root:e,rowData:n,oldValue:a}),this.removeCellContent(e),e.appendChild(l),this._syncRowEditingState(e,!0),this.grid?.generateCellPartNames();const u=s[0];u&&(u.focus(),u instanceof HTMLInputElement&&u.select())},this.layer=null,this.parseInputValueFunction=({inputs:e})=>{const{activeEditInfo:t,field:i,includeTime:n}=this;if(!t||!e.length)return null;const a=e[0];if(this._isAnyDateOrTimeField){const o=t.oldValue??void 0;if("coded-value"===this._effectiveDomain?.type)return null!=a.value?parseFloat(a.value):null;switch(i.type){case"date-only":{const e=a.value;return""!==e?e:null}case"time-only":{const e=_.normalizeTimeOnlyString(a.value);return""!==e?e:null}case"timestamp-offset":{const t=n?e[1]:void 0,i=e.at(-1);return _.getISOFieldValueFromDateComponents({oldValue:o,dateComponent:a,timeComponent:t,timeZoneComponent:i,defaultTimeZone:this.timeZone})}case"date":{const{max:t,min:i}=this._effectiveRange;return _.getUnixFieldValueFromDateComponents({oldValue:o,dateComponent:a,timeComponent:e[1],timeZone:this.timeZone??void 0,max:t,min:i})}}return null}const o=a.value,{required:r}=this;return r||""!==o?p.isNumericField(i)?parseFloat(o):p.isStringField(i)?o.trim():o:null},this.sortable=!0,this.store=null,this.template=null,this.updateRowItemFunction=({rowData:e,column:t,value:i})=>{e&&t.path&&(e.item.feature.attributes[t.path]=i)},this.updateStoreItemFunction=async({rowData:e,column:t,value:i})=>{if(!e||!this.store||!t.path)return;const n=e.item.objectId,a=this.store.getObjectIdIndex(n)??e.index;await this.store.updateItem({index:a,name:t.path,value:i})}}get _effectiveDomain(){const e=this._activeFieldInput?.feature;return e?this._getDomainForFeature(e):null}get _effectiveRange(){return this._activeFieldInput?.range??{max:null,min:null}}get _isAnyDateOrTimeField(){const{field:e}=this;return m.isAnyDateField(e)||p.isTimeOnlyField(e)}get alias(){return this.field?.alias}get defaultValue(){return this.field?.defaultValue}get description(){return this.template?.description??this.field?.description??null}get editable(){const{editingEnabled:e,field:t,layer:i,template:n}=this;if(null==t||null==i)return!1;const a=u.isEditableLayer(i),o=c.getEffectiveLayerCapabilities(i),r=o?.operations.supportsUpdate;return!!(t.editable&&a&&r&&"oid"!==t.type)&&(e?!(!1===n?.editable):!!n?.editable)}get header(){return this.template?.label||this.alias||this.path||null}get includeTime(){const{field:e,template:t}=this;return"time-only"===e.type||"date-only"!==e.type&&(!t?.input||"includeTime"in t.input&&!1!==t.input.includeTime)}get loadingMessage(){return this.messages?.loading||"..."}get maxLength(){const{field:e,template:t}=this,i=e?.length??-1,n=t?.input&&"maxLength"in t.input?t.input.maxLength:null;return null!=n&&!isNaN(n)&&n>=-1&&(-1===i||n<=i)?n:i}get minLength(){const{template:e,maxLength:t}=this,i=e?.input&&"minLength"in e.input?e.input.minLength:null;return t&&i<=t?i:null}get name(){return this.field?.name}get nullable(){return this.field?.nullable??!1}get path(){return this.field?.name}get required(){return!(!this.editable||this.field?.nullable&&!this._activeFieldInput?.required&&!this.template?.required)}createInputElement({value:e}){const{_effectiveDomain:t,field:i,maxLength:n,minLength:a,required:o}=this;let r;"coded-value"===t?.type?(r=this._createSelectElement(e,t.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),o),r.onchange=()=>{r.onblur=null,s()}):(r=document.createElement("input"),r.type=p.isNumericField(i)?"number":"text",n>-1&&(r.maxLength=n),a>0&&(r.minLength=a)),r.classList.add(b.input),r.value=e,r.required=o;let l=!1;r.onkeydown=e=>{l=e.key===v.cancelEdit},r.onblur=()=>{r.onblur=null,s()};const s=()=>{l?this.cancel():this.submit()};return r}getCellValue({path:e},t){return e&&t?.item?.feature?.attributes?t.item.feature.attributes?.[e]:null}onEditComplete(){const e=this.activeEditInfo?.root;e&&this._syncRowEditingState(e,!1),this._activeFieldInput=null,super.onEditComplete()}_clearActiveEditValues(){this.activeEditInfo?.inputs?.forEach((e=>e.value=""))}_setUpDateActionBar(){const{cancel:e,clear:t,save:i}=this.messagesCommon,n=document.createElement("calcite-action-bar");return n.expandDisabled=!0,n.layout="horizontal",n.appendChild(this.createCalciteAction({text:i,icon:"save",click:()=>this.submit()})),this.required||n.appendChild(this.createCalciteAction({text:t,icon:"trash",click:()=>{this._clearActiveEditValues(),this.submit()}})),n.appendChild(this.createCalciteAction({text:e,icon:"x",click:()=>this.cancel()})),n}_formatDateValueForDisplay(e,t){const{timeZone:i,timeZoneName:n}=this;return null!=t?_.getLabelForDateFieldValue(e,t,{...this._getDateFormatOptions(),timeZone:i??void 0,timeZoneName:n??void 0}):null}_setUpDateComponents(e){const{_effectiveRange:{max:t,min:i,rawMax:n,rawMin:a},field:o,required:r}=this,l=this._getDateFieldValuesForComponents(o,e),s=[];if(m.isAnyDateField(o)){const e=this.createDateComponent(),d=p.isDateOnlyField(o)||p.isTimestampOffsetField(o)?n:t,u=p.isDateOnlyField(o)||p.isTimestampOffsetField(o)?a:i,c=this._getDateFieldValuesForComponents(o,d??null),m=this._getDateFieldValuesForComponents(o,u??null);e.value=l.date??"",e.max=c.date??"",e.min=m.date??"",e.required=r,e.addEventListener("calciteInputDatePickerOpen",(()=>this._onDateComponentOpen(e))),s.push(e)}if(this.includeTime){const e=this.createTimeComponent();e.value=l.time??"",e.required=r,e.addEventListener("calciteInputTimePickerOpen",(()=>this._onDateComponentOpen(e))),s.push(e)}if("timestamp-offset"===o.type){const e=this.createTimeZoneComponent();e.value=l.timeZoneOffset??"0",e.addEventListener("calciteInputTimeZoneOpen",(()=>this._onDateComponentOpen(e))),s.push(e)}return s}_onDateComponentOpen(e){this.activeEditInfo?.inputs.forEach((t=>{t!==e&&"open"in t&&(t.open=!1)}))}_syncRowEditingState(e,t=!1){const i=this.grid?.getRowContainingNode(e);i&&(t?i.setAttribute("editing","true"):i.removeAttribute("editing"))}_getDateFieldValuesForComponents(e,t){switch(e.type){case"date":return _.prepareUnixFieldValueForDateComponents(t,this.timeZone??void 0);case"date-only":return{date:t};case"time-only":return{time:t};case"timestamp-offset":return _.prepareISOFieldValueForDateComponents(t);default:return{}}}_createSelectElement(e,t,i=!1){let n=!1;const a=t.map((t=>{t.value===e&&(n=!0);const i=document.createElement("option");return i.text=t.name,i.value=t.value,i}));if(null!=e&&""!==e&&!n){const t=document.createElement("option");t.text=e,t.value=e,a.unshift(t)}if(!i&&null==e){const e=document.createElement("option");e.value="",a.unshift(e)}const o=document.createElement("select");return a.forEach((e=>o.add(e))),o.value=e,o}_setUpFieldInput(e,t){const{field:i,layer:n,timeZone:a}=this,o=new h({feature:e,field:i,initialFeature:e.clone(),layer:n,timeZone:a});return o.set("value",t),o}_isDomainCompatible(e){const{field:t}=this;if(e&&"coded-value"===e.type){const i=typeof e.codedValues[0].code;if("string"===i&&p.isStringField(t)||"number"===i&&p.isNumericField(t))return!0}return!(!e||"range"!==e.type||!p.isNumericField(t))}_getDomainForFeature(e){const{layer:t,name:i,template:n}=this;if(!t||!e)return null;if("wfs"===t.type||"geojson"===t.type||"csv"===t.type)return null;if(n?.domain&&this._isDomainCompatible(n.domain))return n.domain;const{typeIdField:a}=t,o=a===i,r=this.field.domain;if(o&&!r)return new d({name:"__internal-type-based-coded-value-domain__",codedValues:t.types?.map((({id:e,name:t})=>new s.CodedValue({code:e,name:t})))});return a&&null!=i&&t.getFieldDomain(i,{feature:e})||r}_getComputedDomain(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){const i=t.codedValues.filter((t=>t.hasOwnProperty("code")&&t.code===e));return i&&i.length?i[0].name:e}return null}_getDateFormatOptions(){const{template:e}=this,t=e?.format?.dateFormat;return t?r.convertDateFormatToIntlOptions(t):e?.input&&"includeTime"in e.input&&!1===e.input.includeTime?D:C}};e.__decorate([i.property()],I.prototype,"_effectiveDomain",null),e.__decorate([i.property()],I.prototype,"_activeFieldInput",void 0),e.__decorate([i.property()],I.prototype,"_effectiveRange",null),e.__decorate([i.property()],I.prototype,"_isAnyDateOrTimeField",null),e.__decorate([i.property({readOnly:!0})],I.prototype,"alias",null),e.__decorate([i.property()],I.prototype,"cellValueFormatFunction",void 0),e.__decorate([i.property()],I.prototype,"cellValueValidatorFunction",void 0),e.__decorate([i.property({readOnly:!0})],I.prototype,"defaultValue",null),e.__decorate([i.property({readOnly:!0})],I.prototype,"description",null),e.__decorate([i.property({readOnly:!0})],I.prototype,"editable",null),e.__decorate([i.property()],I.prototype,"editingEnabled",void 0),e.__decorate([i.property()],I.prototype,"expressionInfos",void 0),e.__decorate([i.property()],I.prototype,"field",void 0),e.__decorate([i.property()],I.prototype,"formatFunction",void 0),e.__decorate([i.property({readOnly:!0})],I.prototype,"header",null),e.__decorate([i.property()],I.prototype,"headerRenderFunction",void 0),e.__decorate([i.property()],I.prototype,"includeTime",null),e.__decorate([i.property()],I.prototype,"inputRenderFunction",void 0),e.__decorate([i.property()],I.prototype,"layer",void 0),e.__decorate([i.property({readOnly:!0})],I.prototype,"loadingMessage",null),e.__decorate([i.property()],I.prototype,"maxLength",null),e.__decorate([i.property()],I.prototype,"minLength",null),e.__decorate([i.property({readOnly:!0})],I.prototype,"name",null),e.__decorate([i.property({readOnly:!0})],I.prototype,"nullable",null),e.__decorate([i.property()],I.prototype,"parseInputValueFunction",void 0),e.__decorate([i.property({readOnly:!0})],I.prototype,"path",null),e.__decorate([i.property({readOnly:!0})],I.prototype,"required",null),e.__decorate([i.property()],I.prototype,"sortable",void 0),e.__decorate([i.property()],I.prototype,"store",void 0),e.__decorate([i.property()],I.prototype,"template",void 0),e.__decorate([i.property()],I.prototype,"updateRowItemFunction",void 0),e.__decorate([i.property()],I.prototype,"updateStoreItemFunction",void 0),I=e.__decorate([o.subclass("esri.widgets.FeatureTable.FieldColumn")],I);return I}));
