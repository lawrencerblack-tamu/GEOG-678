/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../core/Accessor","../../core/asyncUtils","../../core/Error","../../core/events","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/Point","../../layers/graphics/sources/support/uploadProgressWeights","../../layers/support/infoFor3D","../../support/progressUtils"],(function(e,r,o,t,s,l,a,i,n,p,c,d,u,h,y,f){"use strict";e.Upload=class extends o{constructor(){super({}),this.files=[],this.progress=0,this._uploadTask=null,this._layer=null}destroy(){this.cancel(),this.files=[],this._layer=null,this._uploadTask=null}get state(){const e=this._uploadTask;return e&&0!==this.files.length?e.finished?e.error?"error":"success":"pending":"default"}get result(){return this._uploadTask?.value??null}get error(){return this._uploadTask?.error??null}uploadTo(e){this.cancel(),this.files=[],this._layer=e,this._uploadTask=t.createTask((async r=>{const o=await _(e);a.throwIfAborted(r),this.progress=0,this.files=o;const t=f.makeProgressManager(h.uploadProgressWeights.upload,(e=>{this.progress=e}),"Upload.uploadTo");if(0===o.length)return null;a.throwIfAborted(r);const l=await e.extractAndFilterFiles(o);a.throwIfAborted(r),l.length>0&&(this.files=l);const i=new u({x:0,y:0,z:0,spatialReference:e.spatialReference}),n=await e.convertMesh(l,{location:i,signal:r,onProgress:t.makeOnProgress("createFromFiles")});if(a.throwIfAborted(r),!n)throw new s("editor:upload","could not upload or convert model");const p=l.reduce(((e,r)=>e+r.size),0),c=t.simulate("loadMesh",f.estimatedTransferTime(p));try{await n.load()}finally{c.remove()}return n}))}retry(){this._layer&&this.uploadTo(this._layer)}cancel(){this._uploadTask?.abort()}},r.__decorate([i.property()],e.Upload.prototype,"files",void 0),r.__decorate([i.property()],e.Upload.prototype,"progress",void 0),r.__decorate([i.property()],e.Upload.prototype,"state",null),r.__decorate([i.property()],e.Upload.prototype,"result",null),r.__decorate([i.property()],e.Upload.prototype,"error",null),r.__decorate([i.property()],e.Upload.prototype,"_uploadTask",void 0),r.__decorate([i.property()],e.Upload.prototype,"_layer",void 0),e.Upload=r.__decorate([d.subclass("esri.widgets.Editor.Upload")],e.Upload);let g=null;async function _(e){const{resolve:r,promise:o}=a.createResolver(),t=document.createElement("input");t.type="file",t.multiple=!1,t.accept=[...y.getSupportedExtensions(e.infoFor3D),".zip"].join(","),t.style.display="none",document.body.appendChild(t);const s=l.on(t,"change",(()=>r(t.files?Array.from(t.files):[])));return g?g(t):t.click(),o.finally((()=>{s.remove(),t.remove()}))}function m(e){g=r=>{Promise.resolve().then((()=>e)).then((e=>{if(!g)return;const o=new DataTransfer;e.forEach((e=>o.items.add(e))),r.files=o.files,r.dispatchEvent(new Event("change"))}))}}function v(){g=null}e.clearPromptForFilesStub=v,e.stubFilePickerToSelect=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
