/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../core/Error","../../core/handleUtils","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../layers/GraphicsLayer","../../views/support/layerViewUtils","./UpdateFeatureWorkflowData","./UpdateRecordWorkflow","./workflowUtils","../Sketch/SketchViewModel"],(function(e,t,i,a,s,o,r,l,d,h,n,c,p,u,w,y){"use strict";var k;const g={...u.handleKeys,highlights:Symbol(),sketchGraphics:Symbol(),sketchViewModel:Symbol()};e.UpdateFeatureWorkflow=k=class extends u.UpdateRecordWorkflow{constructor(e){super(e),this.type="update-feature",this._layerViewEditSession=null,this._sketchGraphicClone=null,this._sketchViewModel=null,this._webStyleCache=new Map}destroy(){this._layerViewEditSession?.rollback()}async commit(){this.removeHandles(g.sketchGraphics);try{const e=this.data.edits.stagedForDelete;await super.commit();const t=this._layerViewEditSession;e?t?.rollback():t?.commit()}catch(e){throw await this._configureSketchViewModel(),new i("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:e})}}async start(){return await super.start(),await this._initializeSketchViewModel()}_initializeFeatureFormViewModel(){super._initializeFeatureFormViewModel(),this.addHandles(this._featureFormViewModel.on("value-change",(e=>{this._layerViewEditSession?.setAttribute(e.fieldName,e.value)})))}_configureHighlight(){const{edits:e,layerView:t}=this.data;c.highlightsSupported(t)&&this.addHandles(t.highlight(e.feature),g.highlights)}async _configureSketchViewModel(){const e=this._sketchViewModel;if(!e)return;const{data:t,_featureFormViewModel:i,_sketchGraphicClone:a}=this,{edits:s,viewModel:o}=t,r=s.feature,{view:l}=o,d=w.getVisualVariableAttributes(r),h=await w.setUpGeometryUpdate({feature:r,featureClone:a,visualVariableAttributes:d,sketchViewModel:e,view:l,onUpdate:({geometry:e,attributes:t},a)=>{if(s.updateAttributes(t),s.updateGeometry(e),i.feature.geometry=e,null!=d.rotation){const{field:e}=d.rotation;i.setValue(e,t[e])}if(null!=d.size){const{field:e}=d.size;i.setValue(e,t[e])}("undo"===a.type||"redo"===a.type||"update"===a.type&&null!=a.toolEventInfo&&w.isTerminalUpdateEventType(a.toolEventInfo.type))&&i.notifyFeatureGeometryChanged()},webStyleCache:this._webStyleCache});this.addHandles(h,g.sketchGraphics),e.addHandles(h)}async _initializeSketchViewModel(){const{data:e,_sketchGraphicClone:t}=this,i=e.edits.feature,{capabilities:o,layer:r}=e.editorItem,{view:l}=e.viewModel;if(this.removeHandles([g.highlights,g.sketchGraphics,g.sketchViewModel]),!o.update.geometry)return{enter:async()=>{this.hasHandles(g.highlights)||this._configureHighlight()},exit:()=>this.removeHandles([g.highlights])};const d=new n({elevationInfo:r.elevationInfo,internal:!0,listMode:"hide"}),h=new y({allowDeleteKey:!1,layer:d,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:l});return this._sketchViewModel=h,l?.map.add(d),this.addHandles(a.makeHandle((()=>{l?.destroyed||l?.map.remove(d),d.destroy(),this._sketchViewModel=s.destroyMaybe(h)})),g.sketchViewModel),await w.updateGraphicSymbolWhenRequired(t,this._webStyleCache,"2d"===l?.type?l.scale:null),this.addHandles([await w.swapForEditingSession(h,i,t)]),{enter:async()=>{this.hasHandles(g.sketchGraphics)||await this._configureSketchViewModel()},exit:()=>this.removeHandles([g.sketchGraphics]),viewModel:h}}_onFullFeatureLoaded(e){super._onFullFeatureLoaded(e);const t=this._sketchGraphicClone=w.cloneGraphicExceptMesh(e),{edits:i,layerView:a}=this.data;i.updateGeometry(e.geometry),i.trackChanges(),w.canCreateInteractiveEditSession(a)&&(this._layerViewEditSession=a.createInteractiveEditSession(t))}static async create(e){const t=new k({data:await p.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}get test(){return{graphicClone:this._sketchGraphicClone,sketchViewModel:this._sketchViewModel}}},t.__decorate([o.property()],e.UpdateFeatureWorkflow.prototype,"_layerViewEditSession",void 0),t.__decorate([o.property()],e.UpdateFeatureWorkflow.prototype,"_sketchGraphicClone",void 0),t.__decorate([o.property()],e.UpdateFeatureWorkflow.prototype,"_sketchViewModel",void 0),e.UpdateFeatureWorkflow=k=t.__decorate([h.subclass("esri.widgets.Editor.UpdateFeatureWorkflow")],e.UpdateFeatureWorkflow),e.handleKeys=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
