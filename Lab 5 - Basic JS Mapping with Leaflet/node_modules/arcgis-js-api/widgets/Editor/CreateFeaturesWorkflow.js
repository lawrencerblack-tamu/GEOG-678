/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","../../chunks/tslib.es6","../../Graphic","../../core/arrayUtils","../../core/Error","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/uuid","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/subclass","../../layers/GraphicsLayer","../../layers/support/layerUtils","../../views/draw/support/helpMessageUtils","../../views/input/InputManager","../../views/interactive/sketch/SketchOptions","../../views/interactive/snapping/FeatureSnappingLayerSource","./CreateFeaturesWorkflowData","./modelUploadUtils","./Workflow","./workflowUtils","../FeatureForm/FeatureFormViewModel","../Sketch/SketchViewModel"],(function(e,t,a,i,r,n,s,o,l,d,c,h,p,u,f,g,w,m,y,_,v,M,F,b,k,I){"use strict";var V;const A=Symbol(),H=Symbol(),U=Symbol();let S=V=class extends F{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this.isNested=!1,this._getDrawMeshHelpMessage=void 0,this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._featureFormViewModel=new k,this._sketchViewModel=null,this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[],this._isActive=!0,this._updateGraphicDebounced=o.debounce(((e,t,a)=>b.updateGraphicSymbolWhenRequired(e,t,a)))}initialize(){this.isNested&&(this._isActive=!1),this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){if(this.numPendingFeatures>0)return!0;const{creationInfo:e,upload:t}=this.data,a=this._sketchViewModel,{activeComponent:i}=a,r=a.createGraphic?.geometry?.type;return!("polyline"!==r&&"polygon"!==r&&"multipoint"!==r||"draw-2d"!==i?.type&&"draw-3d"!==i?.type)&&i.drawOperation.committedVertices.length>0||(!(!t||"pending"!==t.state&&"success"!==t.state)||!!e?.geometryToPlace)}get helpMessage(){const{creationInfo:t,viewModel:a}=this.data;if("creating-features"!==this.stepId||!t)return;const i=t.layer.geometryType,r=this._sketchViewModel.createGraphic;if("mesh"===i){this._getDrawMeshHelpMessage||new Promise(((t,a)=>e(["../../views/draw/support/helpMessageUtils3d"],t,a))).then((e=>{this._getDrawMeshHelpMessage=e.getDrawMeshHelpMessage}));const{view:t}=a;return"3d"===t?.type?this._getDrawMeshHelpMessage?.(r,t):void 0}return w.getDrawHelpMessage(i,r?.geometry)}get layer(){return this.data.creationInfo?.layer}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){return this.data.editorItem?.capabilities.create.reliesOnOwnerAdminPrivileges??!1}get shouldShowAttachments(){return this.data.editorItem?.capabilities.create.attachments.enabled??!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){return{addAttachment:(e,t)=>{this._attachmentFileInfos.set(e,t)},sketchViewModel:this._sketchViewModel}}async enter(){this._isActive=!0,"awaiting-feature-creation-info"!==this.stepId&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=!1,this.removeHandles([U])}async updatePendingFeature(e,t){return this._preventDefaultActionOnCancel=!0,this._sketchViewModel.cancel(),i.remove(this._lastActiveGraphics,e),this._startUpdating(e,t)}async start(){return await super.start(),g.isTable(this.data.creationInfo?.layer)?null:{enter:async()=>{},exit:async()=>{},viewModel:this._sketchViewModel}}static create(e){const{addAttachmentsCallback:t,applyEditsCallback:a,isNested:i,creationInfo:r,parent:n,snappingManager:s,startAt:o,viewModel:l}=e,d=e.sketchOptions??new y,c=r?.layer,h=c?l.findEditorItemForLayer(c):void 0,p=new V({data:new v.CreateFeaturesWorkflowData({creationInfo:r,editorItem:h,parent:n,sketchOptions:d,snappingManager:s,viewModel:l}),isNested:i,onCommit:async e=>{const{creationInfo:i}=e;if(!i)return;const r=e.pendingFeatures.toArray(),{layer:n}=i,s=n.capabilities?.editing.supportsGlobalId&&"globalIdField"in n,o=p._attachmentFileInfos;if(s){const e=G(r,n,o);return void await a(n,e,{globalIdUsed:!0})}const l=await a(n,{addFeatures:r});if(o.size>0){const e=l?.addFeatureResults??[];await t(n,O(r,e,n,o))}}});return p._set("steps",this._createWorkflowSteps(p,o)),p}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",n.makeHandle((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,n.makeHandle((()=>e.opacity=t))}_highlight(e){const t=this.data.viewModel.view;"3d"===t?.type&&this._highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){s.removeMaybe(this._highlightHandles.get(e)),this._highlightHandles.delete(e)}async _startCreating(e){this.removeHandles(H);const{creationInfo:t}=this.data;if(!t)return;this.createFeatureState="create-new";const a=await b.startCreatingNewFeature(this._sketchViewModel,t,e);this.addHandles(a,H)}async _startUpdating(e,t){const{pendingFeatures:a}=this;a.includes(e)||a.add(e);const{_featureFormViewModel:i,_sketchViewModel:r}=this,{creationInfo:o,viewModel:d}=this.data,{attachmentsViewModel:c,layerInfos:h,view:p}=d;if(!p||!o)return;const u=o.layer,f=b.findLayerInfo(h,u),w=f?.formTemplate,m=p.spatialReference;i.set({arcadeEditType:"INSERT",feature:e,formTemplate:w,spatialReference:m,map:p.map}),"add"!==c.mode&&"edit"!==c.mode||d.activeWorkflow?.previous(),c.graphic=e,c.fileInfos.removeAll(),c.mode="view";if((this._attachmentFileInfos.get(e)||[]).forEach((({file:e,form:t})=>c.addFile(e,t))),this._removeHighlight(e),await b.updateGraphicSymbolWhenRequired(e,t,"2d"===p.type?p.scale:null),this.removeHandles(H),s.removeMaybe(this._featureFormHandle),"2d"===p.type){const a=l.watch((()=>p.scale),(a=>this._updateGraphicDebounced(e,t,a)));this.addHandles(a,H)}return this._featureFormHandle=n.handlesGroup([i.on("value-change",(async()=>{e.attributes=i.getValues(),await b.updateGraphicSymbolWhenRequired(e,t,"2d"===p.type?p.scale:null)})),r.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&null!=e.toolEventInfo&&b.isTerminalUpdateEventType(e.toolEventInfo.type))&&i.notifyFeatureGeometryChanged()}))]),this.createFeatureState="update-pending",this._visualVariableAttributes=b.getVisualVariableAttributes(e),g.isTable(u)?void 0:b.startUpdatingFeature({graphic:e,sketchViewModel:r,sourceLayer:u,visualVariables:this._visualVariableAttributes,webStyleCache:t})}static _createWorkflowSteps(e,t="awaiting-feature-creation-info"){const{data:a}=e,i={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const{creationInfo:t,viewModel:i}=a,{view:r}=i;r&&(M.isModelUpload(t)?e.addHandles(await M.handleModelUpload({view:r,data:a,next:()=>e.next(),cancel:()=>i.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(a.parent&&t&&(e.addHandles(i.lockFeatureTemplatesViewModel(),this.id),i.featureTemplatesViewModel.layers=[t.layer]),e.addHandles(i.featureTemplatesViewModel.on("select",(({item:t})=>{t&&(a.creationInfo={...a.creationInfo,layer:t.layer,template:t.template},e.next())})),this.id)))},async tearDown(){e.removeHandles([this.id,H])}}),"creating-features":()=>({id:"creating-features",async setUp(){e._isActive&&await e._setUpCreatingFeaturesStep()},async tearDown(t){const{viewModel:i}=a;t.canceled&&(e.removeHandles([U,A,H]),i.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}})},r=b.createWorkflowSteps(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],t,i);return b.avoidFeatureTemplateSelectionWithOnlyOneItem(a,r)}static _configureSketchViewModel(e,t){const{data:a}=e,{creationInfo:r,viewModel:s}=a,{view:o}=s,d=e._sketchViewModel;let c=null;const h=[];if(!o)return n.makeHandle();"2d"===o.type&&r&&h.push(e._fadeExistingFeatures(r.layer)),h.push(d.on("create",(async a=>{if("cancel"===a.state){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e._lastActiveGraphics.length<1)return e._startCreating(t);const a=e._lastActiveGraphics.pop();return e._startUpdating(a,t)}if("complete"===a.state&&a.graphic)return e._startUpdating(a.graphic,t)})),d.on("update",(async a=>{const{attachmentsViewModel:i}=s,{_featureFormViewModel:n}=e,d=a.graphics[0];if("complete"===a.state){if(d!==c&&(e._lastActiveGraphics.push(d),e._highlight(d)),c=null,e.numPendingFeatures===r?.maxFeatures){const a=e._lastActiveGraphics.pop();return e._startUpdating(a,t)}if(!n.submittable){n.submit();const a=e._lastActiveGraphics.pop();return e._startUpdating(a,t)}if("add"!==i.mode&&"edit"!==i.mode||s.activeWorkflow?.previous(),a.aborted&&e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);e.addHandles([b.showProgressCursor(o),o.on("click",(e=>e.preventDefault()))],A),await l.whenOnce((()=>!n.updating)),e.removeHandles(A),e._startCreating(t)}"start"===a.state&&e._removeHighlight(d);const h=e._visualVariableAttributes;await b.visualVariableInteractiveUpdate(o,d,a,h,t);const p=d.attributes,{rotation:u,size:f}=h;if(null!=u){const{field:e}=u;n.setValue(e,p[e])}if(null!=f){const{field:e}=f;n.setValue(e,p[e])}})),d.on("delete",(async t=>{const a=t.graphics[0];e.pendingFeatures.remove(a),i.remove(e._lastActiveGraphics,a),c=a})),o.on("immediate-click",(async a=>{if(M.isModelUpload(r))return;const{results:i}=await o.hitTest(a,{include:d.layer}),n=i.find((e=>"graphic"===e.type&&e.graphic.sourceLayer===r?.layer));if(!n)return;const s=n.graphic;if("transform"===d.activeTool||"reshape"===d.activeTool){if(d.updateGraphics.at(0)===s)return;if(!e._featureFormViewModel.submittable)return;await e.updatePendingFeature(s,t)}}),m.ViewEventPriorities.TOOL),n.makeHandle((()=>{e._preventDefaultActionOnCancel=!0,d.cancel()})),C(d,a));const p=n.handlesGroup(h);return d.addHandles(p),p}_initializeSketchViewModel(){const{data:e}=this,{view:t}=e.viewModel,a=new f({elevationInfo:e.creationInfo?.layer.elevationInfo,internal:!0,listMode:"hide"}),i=new I({layer:a,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:t});this._sketchViewModel=i,t?.map.add(a),this.addHandles(n.makeHandle((()=>{t?.destroyed||t?.map.remove(a),a.destroy()})))}async _setUpCreatingFeaturesStep(){if(this.hasHandles(U))return;const{creationInfo:e,viewModel:t}=this.data,{attachmentsViewModel:i,view:o}=t;if(!o||!e?.layer)throw new r("missing-parameters","CreateFeaturesWorkflow requires a view and creationInfo.");const{initialFeature:d,layer:c}=e,h=this._sketchViewModel,p=new Map,u=[];this._lastActiveGraphics=[],this._featureFormHandle=s.removeMaybe(this._featureFormHandle),this._visualVariableAttributes={rotation:null,size:null},this.data.editorItem=t.findEditorItemForLayer(e.layer),b.prepareAttachmentsForCreateFeaturesWorkflow(i),u.push(l.watch((()=>i.mode),(e=>{switch(e){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}})));const f=b.showProgressCursor(o);u.push(f);const w=g.isTable(e.layer);try{if(w){const t=d??new a({attributes:{...e.template?.prototype.attributes,...e.attributeOverrides},sourceLayer:c});await this._startUpdating(t,p)}else u.push(V._configureSketchViewModel(this,p)),d?(h.layer.add(d),await this._startUpdating(d,p)):await this._startCreating(p)}finally{f.remove()}const m=n.makeHandle((()=>this.pendingFeatures.drain((e=>h.layer.remove(e))))),y=l.watch((()=>o?.timeZone),(e=>this._featureFormViewModel.timeZone=e),l.initial),_=n.makeHandle((()=>{M.isModelUpload(e)&&t.cancelWorkflow({warnIfNoWorkflow:!1})}));this._featureFormHandle&&u.push(this._featureFormHandle),this.addHandles(u,this._handleKeys.beforeCommit),this.addHandles([n.makeHandle((()=>i.fileInfos.removeAll())),n.handlesGroup(u),_,m,y],U)}};function C(e,t){let a=null;const i=()=>e.snappingOptions.featureSources,r=()=>(a=new _({layer:e.layer}),i().add(a),a),o=()=>{null!=a&&(i().remove(a),a=s.destroyMaybe(a))};return n.handlesGroup([l.watch((()=>{const e=t.creationInfo?.layer,a=i().find((t=>t.layer===e));return{hasFeatureLayerSource:!!a,enabled:a?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{if(!e)return o();a??=r(),a.enabled=t}),l.syncAndInitial),n.makeHandle(o)])}function O(e,t,a,i){const r=[];return t.forEach(((t,n)=>{if(!t.error){const s=e[n],o=i.get(s)||[];s.attributes[a.objectIdField]=t.objectId,o.forEach((({form:e})=>r.push({feature:s,attachment:e})))}})),r}function G(e,t,a){const i=[],r=t.globalIdField;return e.forEach(((t,n)=>{e[n].attributes[r]??=d.generateBracedUUID(),(a?.get(t)||[]).forEach((({file:e})=>i.push({feature:t,attachment:{globalId:d.generateBracedUUID(),data:e}})))})),i.length?{addFeatures:e,addAttachments:i}:{addFeatures:e}}t.__decorate([c.property({constructOnly:!0})],S.prototype,"isNested",void 0),t.__decorate([c.property()],S.prototype,"featureFormViewModel",null),t.__decorate([c.property()],S.prototype,"hasPendingEdits",null),t.__decorate([c.property()],S.prototype,"_getDrawMeshHelpMessage",void 0),t.__decorate([c.property()],S.prototype,"helpMessage",null),t.__decorate([c.property()],S.prototype,"layer",null),t.__decorate([c.property()],S.prototype,"parent",null),t.__decorate([c.property()],S.prototype,"parentLayer",null),t.__decorate([c.property()],S.prototype,"keyboardCancellationEnabled",null),t.__decorate([c.property()],S.prototype,"reliesOnOwnerAdminPrivileges",null),t.__decorate([c.property()],S.prototype,"shouldShowAttachments",null),t.__decorate([c.property()],S.prototype,"shouldAllowAttachmentEditing",null),t.__decorate([c.property()],S.prototype,"sketchViewModel",null),S=V=t.__decorate([u.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],S);return S}));
