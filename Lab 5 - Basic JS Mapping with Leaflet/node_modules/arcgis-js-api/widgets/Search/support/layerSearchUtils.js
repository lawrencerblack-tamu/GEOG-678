/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../intl","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/unitUtils","../../../geometry/Polygon","../../../geometry/support/geometryUtils","../../../rest/support/FullTextSearch","../../../intl/substitute","../../../intl/date"],(function(e,t,r,i,n,l,o,s,u,a,c,d){"use strict";const f=/https?:\/\/services.*\.arcgis\.com/i,g=/(?:\{([^}]+)\})/g,p=()=>n.getLogger("esri.widgets.Search.support.layerSearchUtils");function y(e,t){const{exactMatch:i=!1,location:n,maxResults:l,spatialReference:s,source:u,sourceIndex:a,suggestResult:c,view:d}=e,{layer:f,filter:g,zoomScale:y}=u,m=d?.scale,T=h(u,d),E=t?.signal;return x(f).then((()=>{const e=f.popupTemplate;return e?e.getRequiredFields(f.fieldsIndex):null})).then((e=>{const{objectIdField:t,returnZ:h}=f,x=I(u);if(!R(f,x))throw p().error("invalid-field: displayField is invalid."),new r("getResults():invalid-field","displayField is invalid.");const M=e&&e.length?e:[x],q=u.outFields||M,C=F(q);q.includes(t)||C||q.push(t),f.floorInfo?.floorField&&q.push(f.floorInfo.floorField);if(!(C||L(f,q)))throw p().error("invalid-field: outField is invalid."),new r("getResults():invalid-field","outField is invalid.");const D=f.createQuery(),{orderByFields:N}=u;if(N&&(D.orderByFields=N),s){D.outSpatialReference=s;const e=1/o.getMetersPerUnitForSR(s);e&&(D.maxAllowableOffset=e)}const O="mesh"===f.geometryType||"multipatch"===f.geometryType,k=f.capabilities?.data?.supportsZ&&!O;if(D.returnZ=k&&!1!==h,D.returnGeometry=!0,D.multipatchOption=O?"xyFootprint":null,q&&(D.outFields=q),n)D.geometry=n;else if(c.key)D.objectIds=[c.key];else{const e=u.searchFields||[x];if(!L(f,e))throw p().error("invalid-field: search field is invalid."),new r("getResults():invalid-field","search field is invalid.");b(f)&&(D.num=l),T&&(D.geometry=T);const t=c.text?.trim();if(!t)return[];const n=c.text,{prefix:o="",suffix:s=""}=u,a=j(`${o}${n}${s}`);S(f)&&w(f,e)&&!i&&n&&(D.fullText=$({text:n,searchFields:e}));const d=A({searchTerm:a,layer:f,searchFields:e,filter:g,exactMatch:i,query:D,type:"search"});if(D.where=d,!v(D))return[]}return f.queryFeatures(D,{signal:E}).then((e=>V(e,d,u,a,x,m,y)))}))}function m(e,t){const{source:i,spatialReference:n,view:l,suggestTerm:o,maxSuggestions:s,sourceIndex:u,exactMatch:a}=e,{layer:c,filter:d}=i,f=t?.signal,y=h(i,l);return x(c).then((()=>{if(!b(c))return[];const e=I(i),t=i.searchFields||[e],l=[];i.suggestionTemplate?i.suggestionTemplate.replaceAll(g,((e,t)=>(l.push(t),e))):l.push(e);const m=F(l);l.includes(c.objectIdField)||m||l.push(c.objectIdField);const h=R(c,e),x=m||L(c,l),T=L(c,t);if(!h)throw p().error("invalid-field: displayField is invalid."),new r("getSuggestions():invalid-field","displayField is invalid.");if(!x)throw p().error("invalid-field: outField is invalid."),new r("getSuggestions():invalid-field","outField is invalid.");if(!T)throw p().error("invalid-field: search field is invalid."),new r("getSuggestions():invalid-field","search field is invalid.");const E=c.createQuery(),{orderByFields:M}=i;M&&(E.orderByFields=M),E.outSpatialReference=n,E.returnGeometry=!1,E.num=s,E.outFields=l,y&&(E.geometry=y);if(!o.trim())return[];const{prefix:q="",suffix:C=""}=i,D=j(`${q}${o}${C}`);S(c)&&w(c,t)&&!a&&o&&(E.fullText=$({text:o,searchFields:t}));const N=A({searchTerm:D,layer:c,searchFields:t,filter:d,exactMatch:a,query:E,type:"suggest"});return E.where=N,v(E)?c.queryFeatures(E,{signal:f}).then((t=>P(t,i,u,e))):[]}))}function h(e,t){const{filter:r,withinViewEnabled:i}=e,n=t?.extent,l=r?.geometry;return l??(i&&n?n:void 0)}function F(e){return e&&e.includes("*")}async function x(e){e&&await e.load()}function v(e){return!(!e.fullText&&!e.where)}function w(e,t){const r=e?.indexes;if(!r||!t?.length)return!1;return r.filter((e=>"FullText"===e.indexType)).some((e=>{const r=e.fields?.split(",").map((e=>e.trim().toLowerCase()))||[];return t.every((e=>r.includes(e.toLowerCase())))}))}function $({text:e,searchFields:t}){return e.trim().split(" ").filter((e=>!!e.trim())).map((e=>new a({onFields:t,searchTerm:e,searchType:"prefix"})))}function S(e){return e?.capabilities?.query?.supportsFullTextSearch??!1}function b(e){return e?.capabilities?.query?.supportsPagination??!1}function T(e){return e?.fieldsIndex?.fields?.find((e=>"string"===e.type))?.name??""}function I(e){return e.displayField||e.layer.displayField||T(e.layer)}function L(e,t){return!(!e||!t?.length)&&t.every((t=>R(e,t)))}function R(e,t){return!!e.getField(t)}function E(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}function M({codedValues:e},t,r){return l.mappedFind(e??[],(e=>{const i=e.name,n=r?i:i.toLowerCase();return(r?t:t.toLowerCase())===n?e.code.toString():null}))??null}function j(e){return e.replaceAll("'","''")}function q(e,t){const r=t?.where;return r?`(${e}) AND (${r})`:e}function C({currentTerm:e,field:t,filter:r,exactMatch:i,url:n,type:l}){const o=t?.type,s=t?.name;if("string"===o||"date"===o||"global-id"===o){const t=f.test(n??""),o=t&&E(e)?"N":"";if(i&&"search"===l)return q(`${s} = ${o}'${e}'`,r);if(t){return q(`${s} LIKE ${o}${`'${e}%'`}`,r)}return q(`${`LOWER(${s})`} LIKE ${o}${`'${e.toLowerCase()}%'`}`,r)}if("oid"===o||"small-integer"===o||"integer"===o||"single"===o||"double"===o){const t=Number(e);return isNaN(t)?null:q(`${s} = ${t}`,r)}return q(`${s} = ${e}`,r)}function D(e,t){return e?` OR (${t})`:`(${t})`}function A({searchTerm:e,layer:t,searchFields:r,filter:i,exactMatch:n,query:l,type:o}){const{definitionExpression:s,url:u}=t;let a="";return!l.fullText&&e&&r&&r.forEach((r=>{const l=t.getField(r),s="function"==typeof t.getFieldDomain&&t.getFieldDomain(r),c=(s&&"coded-value"===s.type?M(s,e,n):null)||e||null;if(null!==c){const e=C({currentTerm:c,field:l,filter:i,exactMatch:n,url:u,type:o});e&&(a+=D(a,e))}})),s&&a?`(${s}) AND (${a})`:s||a}function N(e,t){let r=null;const{codedValues:i}=e;return i&&i.length&&i.some((e=>e.code===t&&(r=e.name,!0))),r}function O(e,t){return e[t]??e[Object.keys(e).find((e=>e.toLowerCase()===t.toLowerCase()))]}function k(e,t,r){const i=e.sourceLayer,{attributes:n}=e,l="function"==typeof i.getFieldDomain&&i.getFieldDomain(r);if(t)return c.substitute(t,n);if(r&&n){const e=i.getField(r),t=O(n,r);return null==t?"":l&&"coded-value"===l.type?N(l,t)??"":"date"===e?.type?d.formatDate(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}return""}function B(e,t,r,i){const n=e.sourceLayer,{attributes:l}=e,{objectIdField:o}=n,s=o?l[o]:null;return{text:k(e,t.suggestionTemplate,i),key:s,sourceIndex:r}}function P(e,t,r,i){return e.features.map((e=>B(e,t,r,i)))}function U(e){return null!=e&&null!=e.minScale&&null!=e.maxScale}function G(e,t,r,n,l,o,a){const c=e.clone(),d=e.sourceLayer,f=d?.objectIdField,g=f?e.attributes[f]:null,p=k(e,r.searchTemplate,l);null!=o&&U(d)&&(d.minScale&&d.minScale<o?o=d.minScale:d.maxScale&&d.maxScale>o&&(o=d.maxScale));const y=c.geometry?u.createExtentFromGeometry(c.geometry,t??void 0,o??void 0):void 0,m="number"==typeof a&&y?u.scaleExtent(i.clone(y),t??void 0,a):y,h=e.clone();return null!=m&&(h.geometry=s.fromExtent(m)),{extent:m,target:h,feature:c,key:g,name:p,sourceIndex:n}}function V(e,t,r,i,n,l,o){return e.features.map((e=>G(e,t,r,i,n,l,o)))}e.createFullTextSearchInfos=$,e.getResults=y,e.getSuggestions=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
