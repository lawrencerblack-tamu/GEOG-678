/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../kernel","../../request","../../core/arrayUtils","../../core/Collection","../../core/Error","../../core/lang","../../core/Loadable","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/subclass","../../intl/date","../../intl/locale","../../portal/Portal","../../portal/PortalQueryParams","../../rest/geoprocessor/execute","../../rest/geoprocessor/GPOptions","../../config","../../geometry/Polygon","../../geometry/Polyline","../../geometry/support/normalizeUtilsCommon","../../geometry/support/spatialReferenceUtils","../../geometry/SpatialReference","../../geometry/support/Ellipsoid","../../geometry","../../geometry/Extent","../../geometry/Geometry","../../geometry/Multipoint","../../geometry/Point","../../core/urlUtils","../../layers/support/Field","../../layers/support/MapImage","../../rest/support/DataFile","../../rest/support/FeatureSet","../../rest/support/LinearUnit","../../rest/support/ParameterValue","../../rest/support/RasterData","../../rest/support/JobInfo","../../rest/print","../../rest/support/fileFormat","../../rest/support/layoutTemplate","../../rest/support/PrintParameters","../../rest/support/PrintTemplate","./CustomTemplate"],(function(e,t,r,o,s,i,a,l,n,p,c,u,m,d,y,h,f,v,_,T,w,g,S,P,x,L,O,E,b,U,C,I,N,F,D,A,J,M,R,k,q,G,V,j,z,Q){"use strict";const $=s.ofType(Q);function B(e){e.layoutOptions??={},e.layoutOptions.customTextElements??=[];const t="date";if(!e.layoutOptions.customTextElements.find((e=>t in e))){const{customTextElements:t}=e.layoutOptions;let r=d.formatDate(Date.now(),d.convertDateFormatToIntlOptions("short-date"));"ar"===y.getLanguage()&&(r="‏"+r),t.push({date:r})}}let H=class extends l{constructor(e){super(e),this._serviceTemplateCustomTextElements=null,this.allowedFormats="all",this.allowedLayouts="all",this.defaultTemplates=new $,this.error=null,this.extraParameters=null,this.includeDefaultTemplates=!0,this.portal=h.getDefault(),this.printServiceUrl=null,this.printTimeout=12e4,this.templatesInfo=null,this.updateDelay=1e3,this.view=null,this.templateCustomTextElements=null}destroy(){this.view=null}get effectivePrintServiceUrl(){return this.printServiceUrl??null}get effectiveTemplateCustomTextElements(){if(!this._serviceTemplateCustomTextElements)return{};const e=a.clone(this._serviceTemplateCustomTextElements);return this.templateCustomTextElements&&Object.keys(this.templateCustomTextElements).forEach((t=>{const r=e[t];if(r){const e=this.templateCustomTextElements?.[t];r.forEach((t=>{const[r]=Object.entries(t)[0];e?.forEach((e=>{const[o,s]=Object.entries(e)[0];r===o&&(t[r]=s)}))}))}})),Object.freeze(e)}get state(){return"loading"===this.loadStatus?"initializing":"failed"===this.loadStatus||this.error?"error":"loaded"===this.loadStatus&&this.view?.ready?"ready":"disabled"}async load(e){return this.addResolvingPromise(this._loadResources(e).catch((e=>this.error=e))),this}async getLayoutTemplateInfo(e,r){const{id:o}=e;"public"!==e.access&&t.id&&await t.id.getCredential(this._printServiceLayoutsUrl);const s={Layout_Item_ID:JSON.stringify({id:o})},{results:i}=await v.execute(this._printServiceLayoutsUrl,s,null,r),a=i[0].value[0],l=a.layoutOptions.mapSurroundInfos.find((({type:e})=>"CIMMarkerNorthArrow"===e));return l&&(this.templateToNorthArrowInfo[o]=l),a}async print(e){const{view:t,extraParameters:r,updateDelay:o}=this;if(!t)throw new i("print:view-required","view is not set");B(e);const s=new j({view:t,template:e,extraParameters:r,updateDelay:o});try{return await q.execute(this.effectivePrintServiceUrl,s,{timeout:this.printTimeout})}catch(a){throw new i("print:export-error","An error occurred while exporting the web map.",{error:a})}}toPrintTemplate({attributionEnabled:e,author:t,copyright:r,customTextElements:o,dpi:s,forceFeatureAttributes:i,format:a,height:l,includeTables:n,layout:p,layoutItem:c,legendEnabled:u,northArrowEnabled:m,scale:d,scaleEnabled:y,title:h,width:f}){const v=new z({attributionVisible:e,forceFeatureAttributes:i,format:a,includeTables:n,layout:p,layoutItem:c,layoutOptions:{authorText:t||"",copyrightText:r||"",customTextElements:o,titleText:h||""},outScale:d??0,scalePreserved:y});f&&(v.exportOptions.width=f),l&&(v.exportOptions.height=l),s&&(v.exportOptions.dpi=s),!u&&v.layoutOptions&&(v.layoutOptions.legendLayers=[]);const _=this.templateToNorthArrowInfo[c?.id??p];if(_){!(_.visible===m)&&v.layoutOptions&&(v.layoutOptions.elementOverrides={[_.name]:{visible:m}})}return v}async _loadResources(e){let t=[];if(!this.printServiceUrl){if(this.destroyed)return;try{await this.portal.load(e)}catch(a){throw new i("print:could-not-load-portal","Cannot load print resource information from portal",{error:a,url:this.effectivePrintServiceUrl})}const r=this.portal.helperServices?.printTask;r&&(this._set("effectivePrintServiceUrl",r.url),t=r.templates?.map((e=>Q.fromJSON(e)))??[])}this.defaultTemplates.addMany(t);const r=this.effectivePrintServiceUrl?.toLowerCase().split("/");if(!r?.includes("gpserver"))throw new i("print:invalid-print-service-url","Can't fetch print templates information from provided URL",{url:this.effectivePrintServiceUrl});const[o,s]=await Promise.all([this._getPrintServiceLayouts(e),this._getPrintServiceTemplates(e)]);if(this._processPrintServiceLayouts(o),this._processPrintServiceTemplates(s),!this.printServiceUrl){const t=await this._getPortalCustomTemplates(e);this.defaultTemplates.addMany(t)}}async _getPortalCustomTemplates(e){const{layoutGroupQuery:t}=this.portal;if(!t)return[];const r=new f({query:t,disableExtraQuery:!0}),o=await this.portal.queryGroups(r,e);if(!o.total)return[];const s=o.results[0],i=new f({num:100,query:"type:Layout"}),a=(await s.queryItems(i,e)).results;return a.length?a.map((e=>new Q({label:e.title,layoutItem:e}))):[]}_processPrintServiceTemplates(e){this._set("templatesInfo",e)}async _getPrintServiceLayouts(e){let t=[];const r=async t=>{this._printServiceLayoutsUrl=this.effectivePrintServiceUrl.replace(/(\/GPServer\/).+/i,`$1${encodeURI(t)}`);return(await v.execute(this._printServiceLayoutsUrl,null,null,e)).results[0].value};try{t=await r("Get Layout Templates Info Task")}catch{}if(!t||t.length<1)try{t=await r("Get Layout Templates Info")}catch{}return t}_processPrintServiceLayouts(e){const t={},r={};e.forEach((({layoutTemplate:e,layoutOptions:{customTextElements:o,mapSurroundInfos:s}})=>{const i=V.fromJSON(e);t[i]=o,s&&(r[i]=s.find((({type:e})=>"CIMMarkerNorthArrow"===e)))})),this._serviceTemplateCustomTextElements=Object.freeze(t),this.templateToNorthArrowInfo=r}async _getPrintServiceTemplates(e){let t;try{({data:t}=await r(this.effectivePrintServiceUrl,{...e,query:{f:"json"},timeout:this.printTimeout}))}catch(l){throw n.isAbortError(l)?l:new i("print:unavailable-service-info","Can't fetch templates info from service",{error:l})}const{parameters:o}=t,s=o.find((({name:e})=>"Format"===e)),a=o.find((({name:e})=>"Layout_Template"===e));return{format:this._getFormat(s),layout:this._getLayout(a)}}_getFormat(e){const t="all"===this.allowedFormats?e.choiceList:e.choiceList.filter((e=>this.allowedFormats.includes(G.fromJSON(e)))),r=(t.length?t:e.choiceList).map(G.fromJSON).filter(o.isSome),s=G.fromJSON(e.defaultValue),i=r.includes(s)?s:r[0];return{choiceList:r,defaultValue:i}}_getLayout(e){const t=e.choiceList.filter((e=>"map_only"!==e.toLowerCase())),r="all"===this.allowedLayouts?t:t.filter((e=>this.allowedLayouts.includes(V.fromJSON(e)))),s=(r.length?r:t).map(V.fromJSON).filter(o.isSome),i=V.fromJSON(e.defaultValue),a=s.includes(i)?i:s.find((e=>/(?=.*letter)(?=.*landscape)/i.test(e)))??s.find((e=>/(?=.*a4)(?=.*landscape)/i.test(e)))??s[0];return{choiceList:s,defaultValue:a}}};e.__decorate([p.property()],H.prototype,"_serviceTemplateCustomTextElements",void 0),e.__decorate([p.property()],H.prototype,"allowedFormats",void 0),e.__decorate([p.property()],H.prototype,"allowedLayouts",void 0),e.__decorate([p.property({type:$})],H.prototype,"defaultTemplates",void 0),e.__decorate([p.property()],H.prototype,"error",void 0),e.__decorate([p.property()],H.prototype,"extraParameters",void 0),e.__decorate([p.property()],H.prototype,"includeDefaultTemplates",void 0),e.__decorate([p.property({readOnly:!0})],H.prototype,"effectivePrintServiceUrl",null),e.__decorate([p.property()],H.prototype,"effectiveTemplateCustomTextElements",null),e.__decorate([p.property({type:h})],H.prototype,"portal",void 0),e.__decorate([p.property()],H.prototype,"printServiceUrl",void 0),e.__decorate([p.property()],H.prototype,"printTimeout",void 0),e.__decorate([p.property({readOnly:!0})],H.prototype,"state",null),e.__decorate([p.property({readOnly:!0})],H.prototype,"templatesInfo",void 0),e.__decorate([p.property()],H.prototype,"updateDelay",void 0),e.__decorate([p.property()],H.prototype,"view",void 0),e.__decorate([p.property()],H.prototype,"templateCustomTextElements",void 0),e.__decorate([p.property()],H.prototype,"templateToNorthArrowInfo",void 0),H=e.__decorate([m.subclass("esri.widgets.Print.PrintViewModel")],H);return H}));
