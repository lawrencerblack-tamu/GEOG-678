/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Accessor","../../core/Error","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/support/UpdatingHandles","../../portal/Portal","../../portal/support/utils","../../rest/featureService/utils","../../versionManagement/VersionManagementService"],(function(e,r,o,t,i,s,n,a,d,c,p,u,h,l){"use strict";let v=class extends r{constructor(e){super(e),this._initialValidationsFinished=!1,this._portalLookup=new Map,this._updatingHandles=new c.UpdatingHandles,this._validConstructProperties=!0,this.advancedEditingUserTypeExtensionLookup=new Map,this.executionError=void 0,this.featureServiceLookup=new Map,this.loadError=void 0,this.serverVersionLookup=new Map,this.serviceNameLookup=new Map,this.userLookup=new Map,this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionManagementServiceLookup=new Map}initialize(){this.addHandles([i.watch((()=>this.view?.map.layers.toArray()),(async()=>{await this._onLayersChange()}),i.initial)])}destroy(){this._updatingHandles.destroy()}get state(){return this.loadError||!this._validConstructProperties?"disabled":this.executionError?"failed":this._updatingHandles.updating?"executing":this._initialValidationsFinished?"ready":"loading"}set view(e){this._get("view")!==e&&this._set("view",e)}async alterVersion(e){"disabled"!==this.state?await this._updatingHandles.addPromise((async()=>{this._setExecutionError();const r=this.versionManagementServiceLookup.get(e.featureServerUrl);if(!r)return void this._logNoVersionManagementServiceFoundError();if(!this.serverVersionLookup.has(e.featureServerUrl)||this.serverVersionLookup.get(e.featureServerUrl)<=11.1)return void this._logError("execution-error","no-valid-enterprise-version");if(!this.advancedEditingUserTypeExtensionLookup.get(e.featureServerUrl))return void this._logError("execution-error","no-advanced-editing-user-type-extension");const{featureServerUrl:o,versionIdentifier:t,...i}=e;await r.alterVersion(t,i).catch((async e=>{await this.getVersionInfos(o,!0),this._logExecutionError(e)}))})()):this._logError("load-error",this.loadError)}async changeVersion(e,r,o){"disabled"!==this.state?await this._updatingHandles.addPromise((async()=>{this._setExecutionError();const t=this.versionManagementServiceLookup.get(e);if(!t)return void this._logNoVersionManagementServiceFoundError();const i=this.versionIdentifierLookup.get(e)??{name:t.defaultVersionIdentifier.name,guid:t.defaultVersionIdentifier.guid},s={name:r,guid:o};await t.changeVersion(this.view?.map,i,s).catch((e=>{this._logExecutionError(e)}))&&this.versionIdentifierLookup.set(e,s)})()):this._logError("load-error",this.loadError)}async createVersion(e){"disabled"!==this.state?await this._updatingHandles.addPromise((async()=>{this._setExecutionError();const r=e.featureServerUrl,o=this.versionManagementServiceLookup.get(r);if(!o)return void this._logNoVersionManagementServiceFoundError();const t=this.advancedEditingUserTypeExtensionLookup.get(e.featureServerUrl),i=this.userLookup.get(r).toUpperCase(),s=this._isEmptyString(e.ownerName)?i:e.ownerName?.trim().toUpperCase();if(s!==i){if(this.serverVersionLookup.get(r)<=11.1)return void this._logError("execution-error","versioning-api-error");if(!t)return void this._logError("execution-error","no-advanced-editing-user-type-extension")}if("SDE"===s?.toUpperCase()&&"DEFAULT"===e.versionName.toUpperCase()||this.versionInfoLookup.get(r)?.find((r=>r.versionIdentifier.name.toUpperCase()===(s+"."+e.versionName).toUpperCase()||r.versionIdentifier.name.toUpperCase()===(i+"."+e.versionName).toUpperCase())))return void this._logError("execution-error","no-valid-version-name");const n=await o.createVersion({versionName:e.versionName,access:s!==i?"public":e.access,description:e.description}).catch((e=>{this._logExecutionError(e)}));if(!this.executionError&&s!==i){const{guid:o,name:t}=n.versionIdentifier,a={featureServerUrl:r,versionIdentifier:{guid:o,name:t},access:e.access,ownerName:s};await this.alterVersion(a),this.executionError&&this.deleteVersion(r,i+"."+e.versionName,n.versionIdentifier.guid)}await this.getVersionInfos(r,!0)})()):this._logError("load-error",this.loadError)}async deleteVersion(e,r,o){"disabled"!==this.state?await this._updatingHandles.addPromise((async()=>{this._setExecutionError();const t=this.versionManagementServiceLookup.get(e);if(!t)return void this._logNoVersionManagementServiceFoundError();if(this.serverVersionLookup.get(e)<=11.1)return void this._logError("execution-error","versioning-api-error");if(!this.advancedEditingUserTypeExtensionLookup.get(e))return void this._logError("execution-error","no-advanced-editing-user-type-extension");const i={name:r,guid:o};await t.deleteVersion(i).catch((e=>{this._logExecutionError(e)}))&&await this.getVersionInfos(e,!0).catch((e=>{this._logExecutionError(e)}))})()):this._logError("load-error",this.loadError)}async getVersionInfos(e,r){if("disabled"!==this.state)return await this._updatingHandles.addPromise((async()=>{this._setExecutionError();const o=this.featureServiceLookup.get(e)?.featureService;if(!o)return void this._logError("execution-error","no-feature-service-found");if(!o.loaded){await o.load().catch((e=>{this._logExecutionError(e)}));const r=o.url;this.serverVersionLookup.set(r,o.sourceJSON?.currentVersion??0),this.serverVersionLookup.get(r)<=11.1&&this.advancedEditingUserTypeExtensionLookup.set(r,!1);const t=this.userLookup.get(e);this._portalLookup.get(e)&&t?this.advancedEditingUserTypeExtensionLookup.set(r,await u.hasUserTypeExtension(this._portalLookup.get(e),t,"advediting")):this.advancedEditingUserTypeExtensionLookup.set(r,!1)}o.versionManagementServiceUrl&&this.versionManagementServiceLookup.set(o.url,new l({url:o.versionManagementServiceUrl}));const t=this.versionManagementServiceLookup.get(e);if(t){if(t.loaded||await t.load().catch((e=>{this._logExecutionError(e)})),!this.versionInfoLookup.get(e)||r){const r=await t.getVersionInfos().catch((e=>{this._logExecutionError(e)}));this.versionInfoLookup.set(e,r)}}else this._logNoVersionManagementServiceFoundError()})()),this.versionInfoLookup.get(e);this._logError("load-error",this.loadError)}_isEmptyString(e){return!e||0===e.trim().length}_logError(e,r){switch(e){case"load-error":this._setLoadError(r),t.getLogger(this).error(new o(e,r));break;case"execution-error":this._setExecutionError(r),t.getLogger(this).error(new o(e,r))}}_logExecutionError(e){this._logError("execution-error",e.message)}_logNoVersionManagementServiceFoundError(){this._logError("execution-error","no-version-management-service-found")}async _onLayersChange(){if(this._initialValidationsFinished=!1,this._setLoadError(),this._validConstructProperties=!0,!this.view)return this._logError("load-error","no-view-property"),void(this._validConstructProperties=!1);if(this.featureServiceLookup=h.createFeatureServices(this.view.map.layers),!this.featureServiceLookup.size)return this._logError("load-error","no-feature-services"),void(this._validConstructProperties=!1);for(const e of this.featureServiceLookup.keys())if(!this.serviceNameLookup.has(e)){this.serviceNameLookup.set(e,e.split("/").at(-2));const r=new p({authMode:"immediate",url:new URL(e).origin+"/portal"});await r.load(),this._portalLookup.set(e,r);const o=r?.user?.username;o&&this.userLookup.set(e,o)}this._initialValidationsFinished=!0}_setExecutionError(e){this._set("executionError",e)}_setLoadError(e){this._set("loadError",e)}};e.__decorate([s.property()],v.prototype,"_initialValidationsFinished",void 0),e.__decorate([s.property({readOnly:!0})],v.prototype,"advancedEditingUserTypeExtensionLookup",void 0),e.__decorate([s.property({readOnly:!0})],v.prototype,"executionError",void 0),e.__decorate([s.property()],v.prototype,"featureServiceLookup",void 0),e.__decorate([s.property({readOnly:!0})],v.prototype,"loadError",void 0),e.__decorate([s.property({readOnly:!0})],v.prototype,"serverVersionLookup",void 0),e.__decorate([s.property()],v.prototype,"serviceNameLookup",void 0),e.__decorate([s.property({readOnly:!0})],v.prototype,"state",null),e.__decorate([s.property({readOnly:!0})],v.prototype,"userLookup",void 0),e.__decorate([s.property({readOnly:!0})],v.prototype,"versionIdentifierLookup",void 0),e.__decorate([s.property()],v.prototype,"versionInfoLookup",void 0),e.__decorate([s.property()],v.prototype,"versionManagementServiceLookup",void 0),e.__decorate([s.property()],v.prototype,"view",null),v=e.__decorate([d.subclass("esri.widgets.VersionManagement.VersionManagementViewModel")],v);return v}));
