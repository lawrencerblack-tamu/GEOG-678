/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","../../chunks/tslib.es6","../../core/arrayUtils","../../core/maybe","../../core/uid","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/subclass","../Widget","../../chunks/componentsUtils","./globalCss","./LabeledSwitch","./legacyIcon","./widgetUtils","./decorators/messageBundle","./jsxFactory","./SnappingControls/SnappingControlsViewModel","./SnappingControls/VisibleElements"],(function(e,t,l,s,i,n,a,r,o,c,d,p,g,h,u,_,y,b,m){"use strict";const L="esri-snapping-controls",w={base:L,widgetIcon:h.legacyIcon.vertexGps,container:`${L}__container`,item:`${L}__item`,toggleBlock:`${L}__toggle-block`,layerListBlock:`${L}__layer-list-block`,layerList:`${L}__layer-list`,layerListFilter:`${L}__layer-list__filter`,layerListButton:`${L}__layer-list__button`,layerListItem:`${L}__layer-list__item`,layerListGroup:`${L}__layer-list__group`,nestedContainer:`${L}__nested-container`},v={checked:"check-square-f",unchecked:"square",indeterminate:"minus-square"};let k=class extends c{constructor(e,t){super(e,t),this._defaultViewModel=null,this._layerListFilter=null,this.iconClass=w.widgetIcon,this.icon=null,this.layerListOpen=!0,this.messages=null,this.visibleElements=new m,this._enableSnappingSwitchChange=e=>{this.snappingOptions.enabled=e},this._featureEnabledSwitchChange=e=>{this.snappingOptions.featureEnabled=e},this._selfEnabledSwitchChange=e=>{this.snappingOptions.selfEnabled=e},this._onToggleLayersButtonClick=e=>{this.viewModel.toggleSnappingForAllLayers(!this.viewModel.allLayersEnabled),requestAnimationFrame((()=>e.target.setFocus()))};const{snappingOptions:l,view:s,viewModel:i}=e;this.viewModel=i??(this._defaultViewModel=new b({snappingOptions:l,view:s}))}normalizeCtorArgs(e){const{snappingOptions:t,view:l,viewModel:s,...i}=e;return i}destroy(){this.viewModel!==this._defaultViewModel&&(this._defaultViewModel=s.destroyMaybe(this._defaultViewModel))}loadDependencies(){return Promise.all([d.loadCalciteComponents({accordion:()=>new Promise(((t,l)=>e(["../../chunks/calcite-accordion"],t,l))),"accordion-item":()=>new Promise(((t,l)=>e(["../../chunks/calcite-accordion-item"],t,l))),action:()=>new Promise(((t,l)=>e(["../../chunks/calcite-action"],t,l))),block:()=>new Promise(((t,l)=>e(["../../chunks/calcite-block"],t,l))),button:()=>new Promise(((t,l)=>e(["../../chunks/calcite-button"],t,l))),icon:()=>new Promise(((t,l)=>e(["../../chunks/calcite-icon"],t,l))),input:()=>new Promise(((t,l)=>e(["../../chunks/calcite-input"],t,l))),list:()=>new Promise(((t,l)=>e(["../../chunks/calcite-list"],t,l))),"list-item":()=>new Promise(((t,l)=>e(["../../chunks/calcite-list-item"],t,l)))}),g.loadLabeledSwitchComponents()])}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get snappingOptions(){return this.viewModel.snappingOptions}set snappingOptions(e){this.viewModel.snappingOptions=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}set viewModel(e){e!==this._get("viewModel")&&(null!=this._defaultViewModel&&this._defaultViewModel===e||(this._defaultViewModel=s.destroyMaybe(this._defaultViewModel)),this._set("viewModel",e))}render(){const{label:e}=this;return y.tsx("div",{"aria-label":e,class:this.classes(w.base,p.globalCss.widget)},y.tsx("div",{class:w.container},this._renderContent()))}_renderContent(){return[this._renderToggles(),this._renderLayerList()]}_renderToggles(){const{visibleElements:e}=this,t=[e.selfEnabledToggle?this._renderSelfEnabledToggle():null,e.featureEnabledToggle?this._renderFeatureEnabledToggle():null].filter(l.isSome),s=[e.enabledToggle?this._renderEnabledToggle():null,t.length>0?y.tsx("div",{class:w.nestedContainer},t):null].filter(l.isSome);return 0===s.length?null:y.tsx("calcite-block",{class:w.toggleBlock,heading:e.header?this.label:"",key:"toggle-block",open:!0},s)}_renderEnabledToggle(){const{messages:e,viewModel:t}=this,{snappingOptions:l}=t;return y.tsx(g.LabeledSwitch,{checked:l.enabled,disabled:this._enabledToggleDisabled,key:`${this.id}__enabled-toggle`,label:e.enableSnapping,onChange:this._enableSnappingSwitchChange})}_renderSelfEnabledToggle(){const{messages:e,viewModel:t}=this,{snappingOptions:l}=t,s=l.enabled&&l.selfEnabled;return y.tsx(g.LabeledSwitch,{checked:s,disabled:this._secondaryElementsDisabled,key:`${this.id}__self-enabled-toggle`,label:e.geometryGuides,onChange:this._selfEnabledSwitchChange})}_renderFeatureEnabledToggle(){const{messages:e,viewModel:t}=this,{snappingOptions:l}=t,s=l.enabled&&l.featureEnabled;return y.tsx(g.LabeledSwitch,{checked:s,disabled:this._secondaryElementsDisabled,key:`${this.id}__feature-enabled-toggle`,label:e.featureToFeature,onChange:this._featureEnabledSwitchChange})}_renderLayerList(){if(!this.visibleElements.layerList)return null;const{messages:e,viewModel:t}=this,l=({target:{value:e}})=>{this._layerListFilter=""===e?null:new RegExp(e,"i")},s=t.layerListViewModel.operationalItems.length>9?y.tsx("calcite-input",{class:w.layerListFilter,clearable:!0,placeholder:e?.searchLayers,onCalciteInputInput:l}):null,i=this._secondaryElementsDisabled,n=this.layerListOpen&&!i;return y.tsx("calcite-block",{class:w.layerListBlock,collapsible:!0,disabled:this._secondaryElementsDisabled,heading:e.snappingLayers,key:"list-block",open:n,onCalciteBlockToggle:e=>this.layerListOpen=e.target.open},s,this._renderToggleLayersButton(),y.tsx("calcite-list",{class:w.layerList},this._renderLayerListItemCollection(t.layerListViewModel.operationalItems,this._layerListFilter)))}_renderLayerListItemCollection(e,t){return e.map((e=>{if(!t||this._itemTitleMatchesFilter(e,t))return e.children.length>0?this._renderLayerListItemGroup(e):this._renderLayerListItem(e);const l=e.children.filter((e=>this._itemTitleMatchesFilter(e,t)));return l.length>0?this._renderLayerListItemGroup(e,l):null})).toArray().filter(l.isSome)}_renderToggleLayersButton(){if(!this.visibleElements.layerListToggleLayersButton)return null;const{viewModel:{allLayersEnabled:e},messages:t}=this,l=e?t.disableAllLayers:t.enableAllLayers;return y.tsx("calcite-button",{appearance:"transparent",class:w.layerListButton,label:l,name:"layer-toggle",onclick:this._onToggleLayersButtonClick,scale:"m"},l)}_renderLayerListItem(e){const{messages:{untitledLayer:t}}=this,l=e.title||t,s=e.enabled,i=()=>{this._handleLayerListItemChange({checked:!s,value:e.layer.id})};return y.tsx("calcite-list-item",{class:w.layerListItem,key:`${this.id}-list-item-${e.uid}`,label:l,onCalciteListItemSelect:i},y.tsx("calcite-icon",{icon:s?v.checked:v.unchecked,scale:"s",slot:"content-start"}))}_renderLayerListItemGroup(e,t){const{allChildrenEnabled:l,children:s,hasChildrenEnabled:n,title:a}=e,r=this.messages,o=a||r.untitledLayer,c=a&&""!==a?a:i.generateUID(),d=!!t,p=t??s,g=l?v.checked:n?v.indeterminate:v.unchecked,h=l?r.disableAllLayers:r.enableAllLayers,u=()=>{this.viewModel.toggleSnappingForLayers(e.childLayerIds,!l)};return y.tsx("calcite-list-item",{class:w.layerListItem,key:c},y.tsx("calcite-accordion",{appearance:"transparent",class:w.layerListGroup},y.tsx("calcite-accordion-item",{expanded:d,heading:o,key:e.uid},y.tsx("calcite-action",{onclick:u,scale:"m",slot:"actions-start",text:h,textEnabled:!1},y.tsx("calcite-icon",{icon:g,scale:"s"})),y.tsx("calcite-list",null,this._renderLayerListItemCollection(p)))))}_itemTitleMatchesFilter(e,t){return null!=t&&t.test(e.title)}async _handleLayerListItemChange(e){e.checked?this.viewModel.enableSnappingForLayer(e.value):this.viewModel.disableSnappingForLayer(e.value)}get _enabledToggleDisabled(){const e=this.snappingOptions;return e.enabledToggled||e.forceDisabled}get _secondaryElementsDisabled(){return this._enabledToggleDisabled||!this.snappingOptions.enabled}};t.__decorate([n.property()],k.prototype,"_defaultViewModel",void 0),t.__decorate([n.property()],k.prototype,"_layerListFilter",void 0),t.__decorate([n.property()],k.prototype,"iconClass",void 0),t.__decorate([n.property()],k.prototype,"icon",void 0),t.__decorate([n.property()],k.prototype,"label",null),t.__decorate([n.property({type:Boolean,nonNullable:!0})],k.prototype,"layerListOpen",void 0),t.__decorate([n.property(),_.messageBundle("esri/widgets/support/SnappingControls/t9n/SnappingControls")],k.prototype,"messages",void 0),t.__decorate([n.property()],k.prototype,"snappingOptions",null),t.__decorate([n.property()],k.prototype,"view",null),t.__decorate([n.property()],k.prototype,"viewModel",null),t.__decorate([n.property({type:m,nonNullable:!0})],k.prototype,"visibleElements",void 0),t.__decorate([n.property()],k.prototype,"_enabledToggleDisabled",null),t.__decorate([n.property()],k.prototype,"_secondaryElementsDisabled",null),k=t.__decorate([o.subclass("esri.widgets.support.SnappingControls")],k);return k}));
