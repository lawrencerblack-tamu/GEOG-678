/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../intl","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../Widget","./datePickerUtils","./DatePickerViewModel","./globalCss","./legacyIcon","./Popover","./decorators/accessibleHandler","./decorators/messageBundle","./jsxFactory","./widgetUtils","../../chunks/datetime","../../intl/date","../../intl/locale"],(function(e,t,a,s,i,o,r,n,d,l,c,h,_,u,p,y,v,m,g,D,k){"use strict";const w="esri-date-picker",b={base:w,datePicker:`${w}__calendar`,monthPicker:`${w}__month-picker`,dayPicker:`${w}__day-picker`,week:`${w}__week-item`,nearbyMonth:`${w}__day-item--nearby-month`,activeDay:`${w}__day-item--active`,today:`${w}__day-item--today`,selectedDay:`${w}__day-item--selected`,day:`${w}__day-item`,dayHeader:`${w}__day-item--header`,yearPicker:`${w}__year-picker`,selectedYear:`${w}__year-picker-item--selected`,year:`${w}__year-picker-item`,monthDropdown:`${w}__month-dropdown`,date:`${w}__date`,datePickerToggle:`${w}__calendar-toggle`,dateInput:`${w}__input`,dateTextInput:`${w}__text-input`,leadingIcon:`${w}__icon--leading`},f=new Set([" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"]);let P=class extends d{constructor(e,t){super(e,t),this._calendarNode=null,this._inputOrButtonNode=null,this._rootNode=null,this._requestDayPickerFocusOnCreate=!1,this._activeDate=null,this._calendarPopover=new u({owner:this,placement:"bottom-start",anchorElement:()=>this._rootNode,renderContentFunction:this._renderCalendar}),this._isOpen=!1,this.dateInputEnabled=!1,this.messages=null,this.commitOnMonthChange=!1,this.viewModel=new c,this.disabled=!1,this.timeZone=void 0,this.toggle=this.toggle.bind(this)}initialize(){this.addHandles(s.watch((()=>({viewModel:this.viewModel,value:this.viewModel?.value})),(({viewModel:e,value:t})=>{!this.destroyed&&e&&null!=this.onChange&&this.onChange(t)}),s.sync))}destroy(){this._calendarPopover.destroy()}get _dateTimeFormatOptions(){return{year:"numeric",month:"2-digit",day:"2-digit",timeZone:this.timeZone||void 0}}get value(){return this.viewModel.value}set value(e){this.viewModel.value=e}get isOpen(){return this._isOpen}render(){return v.tsx("div",{afterCreate:m.storeNode,bind:this,class:this.classes(b.base,h.globalCss.widget),"data-node-ref":"_rootNode"},this.dateInputEnabled?this._renderInputAndButtonMode():this._renderButtonOnlyMode())}toggle(){this._isOpen?this.close():this.open()}open(e=!0){this._activeDate=g.DateTime.fromJSDate(this.viewModel.value),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=e}close(e=!0){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1,e&&this._inputOrButtonNode?.focus()}_renderButtonOnlyMode(){const e=D.formatDate(this.viewModel.value,this._dateTimeFormatOptions),{disabled:t,_isOpen:a,messages:s}=this;return v.tsx("div",{afterCreate:m.storeNode,"aria-controls":a?this._getCalendarId():null,"aria-expanded":a.toString(),"aria-haspopup":"true","aria-label":s.setDate,"aria-pressed":a.toString(),bind:this,class:this.classes(h.globalCss.widgetButton,h.globalCss.select,b.datePickerToggle),"data-node-ref":"_inputOrButtonNode",key:`date-button-${t}`,onclick:this.toggle,onkeydown:this._handleDateButtonKeyDown,role:"button",tabIndex:t?void 0:0},v.tsx("span",{class:b.date},e))}_renderInputAndButtonMode(){const e=D.formatDate(this.viewModel.value,this._dateTimeFormatOptions),{_isOpen:t,messages:a}=this;return v.tsx("div",{class:this.classes(b.dateInput)},v.tsx("input",{afterCreate:m.storeNode,"aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":a.setDate,bind:this,class:this.classes(b.dateTextInput,h.globalCss.input),"data-node-ref":"_inputOrButtonNode",key:"date-input",onblur:this._handleDateInputBlur,onclick:this._handleDateInputClick,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),v.tsx("span",{"aria-hidden":"true",class:this.classes(b.leadingIcon,_.legacyIcon.calendar)}))}_handleDateInputClick(){this.open(!1)}_handleDateInputKeyDown(e){const{key:t}=e;this._isOpen?"Enter"===t?this._handleDateText(e):"Escape"===t&&this.close():"ArrowDown"===t&&(this.open(),e.preventDefault())}_handleDateButtonKeyDown(e){const{key:t,shiftKey:a}=e;this._isOpen&&"Tab"===t&&a?this.close():m.isActivationKey(t)&&this.toggle()}_handleDateInputBlur(e){this._isOpen||this._handleDateText(e)}_handleDateText(e){const t=e.currentTarget;let s;try{s=l.parseDateIntoParts(t.value,this._dateTimeFormatOptions)}catch(o){return a.getLogger(this).warn(o),void(t.value=D.formatDate(this.viewModel.value,this._dateTimeFormatOptions))}const i=g.DateTime.fromObject(s);i.isValid?(this.viewModel.value=i.toJSDate(),this._activeDate=i):t.value=D.formatDate(this.viewModel.value,this._dateTimeFormatOptions)}_handleDatePickerKeydown(e){const{key:t}=e;"Escape"===t&&(this.close(),e.preventDefault(),e.stopPropagation())}_renderCalendar(){const e=this._activeDate;if(!e)return null;const t=g.DateTime.fromJSDate(this.viewModel.value);return v.tsx("div",{afterCreate:m.storeNode,bind:this,class:this.classes(b.datePicker,h.globalCss.widget),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",onfocusout:this._onCalendarFocusOut,onkeydown:this._handleDatePickerKeydown,tabIndex:-1},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))}_getCalendarId(){return`date-picker__calendar--${this.id}`}_onCalendarFocusOut(e){const t=e.relatedTarget;t&&t instanceof Node&&(this._calendarNode?.contains(t)||this._rootNode?.contains(t))||this.close(!1)}_renderMonthPicker(e){const t=m.isRTL(this.container),a=t?_.legacyIcon.right:_.legacyIcon.left,s=t?_.legacyIcon.left:_.legacyIcon.right,i=g.Info.months("long",{locale:k.getLocale()}).map(((t,a)=>{const s=e.month-1===a;return v.tsx("option",{selected:s,value:a.toString()},t)})),{disabled:o,messages:r}=this;return v.tsx("div",{class:b.monthPicker},v.tsx("div",{"aria-label":r.goToPreviousMonth,bind:this,class:h.globalCss.button,key:`previous-month-${o}`,onclick:this._setPreviousMonth,onkeydown:this._handlePreviousMonthKeyDown,role:"button",tabIndex:o?void 0:0,title:r.goToPreviousMonth},v.tsx("span",{"aria-hidden":"true",class:a})),v.tsx("select",{"aria-label":r.selectMonth,"aria-live":"assertive",bind:this,class:this.classes(b.monthDropdown,h.globalCss.select),disabled:o,id:`${this.id}__month-picker`,onchange:this._setMonth,onkeydown:this._setMonth,title:r.selectMonth},i),v.tsx("div",{"aria-label":r.goToNextMonth,bind:this,class:h.globalCss.button,key:`next-month-${o}`,onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:o?void 0:0,title:r.goToNextMonth},v.tsx("span",{"aria-hidden":"true",class:s})))}_renderDayPicker(e,t){const a=this._getWeekLabels(),s=this._getDayId(e),i=this._renderMonth(e,t),{id:o,disabled:r}=this;return v.tsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":s,"aria-labelledby":`${o}__month-picker ${o}__selected-year`,bind:this,class:b.dayPicker,id:`${o}__day-picker`,key:`day-picker-${r}`,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:r?void 0:0},v.tsx("div",{class:b.week,role:"row"},a.map((e=>v.tsx("div",{"aria-label":e.name,class:this.classes(b.day,b.dayHeader),role:"columnheader",title:e.name},e.abbr)))),i)}_getDayId(e){return`${this.id}__${D.formatDate(e.valueOf(),this._dateTimeFormatOptions)}`}_handleDayPickerCreate(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())}_getWeekLabels(){const e=[],t={weekday:"long"},a={weekday:"narrow"};let s=g.DateTime.now().set({weekday:l.getFirstDayOfWeek(k.getLocale())});for(let i=0;i<7;i++)e.push({name:D.formatDate(s.valueOf(),t),abbr:D.formatDate(s.valueOf(),a)}),s=s.plus({day:1});return e}_handleDayPickerKeydown(e){const{key:t,ctrlKey:a,shiftKey:s}=e;if(!f.has(t))return;let i=this._activeDate;if(i){if("ArrowLeft"===t)i=i.minus({day:1});else if("ArrowRight"===t)i=i.plus({day:1});else if("ArrowUp"===t)i=i.minus({week:1});else if("ArrowDown"===t)i=i.plus({week:1});else if("PageUp"===t){const e=s?"year":"month";i=i.minus({[e]:1})}else if("PageDown"===t){const e=s?"year":"month";i=i.plus({[e]:1})}else if("Home"===t){const e=a?"year":"month";i=i.startOf(e)}else if("End"===t){const e=a?"year":"month";i=i.endOf(e)}else m.isActivationKey(t)&&(this.viewModel.value=i.toJSDate(),this.close());this._activeDate=i,e.preventDefault(),e.stopPropagation()}}_renderMonth(e,t){const a=g.DateTime.now(),s=e.startOf("month"),i=e.endOf("month"),o=6,r=7;let n=s.minus({day:l.getLocaleDayOfWeek(k.getLocale(),s.weekday)});const d=[];for(let l=0;l<o;l++){const o=[];for(let d=0;d<r;d++){const r=n.day,d=n.hasSame(e,"day"),l=n.hasSame(t,"day"),c=this._getDayId(n),h=g.Interval.fromDateTimes(s,i),_={[b.nearbyMonth]:!h.contains(n),[b.today]:n.hasSame(a,"day"),[b.activeDay]:d,[b.selectedDay]:l};o.push(v.tsx("div",{"aria-label":r.toString(),"aria-selected":d.toString(),bind:this,class:this.classes(b.day,_),"data-iso-date":n.toISO(),id:c,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},r)),n=n.plus({day:1})}d.push(v.tsx("div",{class:b.week,role:"row"},o))}return d}_renderYearPicker(e){const t={year:"numeric"},a=e,s=D.formatDate(a.valueOf(),t),i=D.formatDate(a.plus({year:1}).valueOf(),t),o=D.formatDate(a.minus({year:1}).valueOf(),t),{disabled:r,messages:n}=this;return v.tsx("div",{class:b.yearPicker},v.tsx("div",{"aria-label":n.goToPreviousYear,bind:this,class:b.year,key:`previous-year-${r}`,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:r?void 0:0,title:n.goToPreviousYear},o),v.tsx("div",{class:this.classes(b.year,b.selectedYear),id:`${this.id}__selected-year`},s),v.tsx("div",{"aria-label":n.goToNextYear,bind:this,class:b.year,key:`next-year-${r}`,onclick:this._setNextYear,onkeydown:this._handleNextYearKeyDown,tabIndex:r?void 0:0,title:n.goToNextYear},i))}_setMonth(e){const t=e.target,a=Number(t.value)+1;this._activeDate&&(this._activeDate=this._activeDate.set({month:a}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))}_setPreviousMonth(){this._activeDate&&(this._activeDate=this._activeDate.minus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))}_handlePreviousMonthKeyDown(e){if("Tab"===e.key&&e.shiftKey)return e.preventDefault(),void this.close();m.isActivationKey(e.key)&&this._setPreviousMonth()}_setNextMonth(){this._activeDate&&(this._activeDate=this._activeDate.plus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))}_setPreviousYear(){this._activeDate=this._activeDate?.minus({year:1})??null}_setNextYear(){this._activeDate=this._activeDate?.plus({year:1})??null}_handleNextYearKeyDown(e){if("Tab"===e.key&&!e.shiftKey)return e.preventDefault(),void this.close();m.isActivationKey(e.key)&&this._setNextYear()}_handleSelectedDate(e){const t=e.target;this.viewModel.value=g.DateTime.fromISO(t.getAttribute("data-iso-date")).toJSDate(),this.close()}};e.__decorate([i.property()],P.prototype,"_activeDate",void 0),e.__decorate([i.property()],P.prototype,"_calendarPopover",void 0),e.__decorate([i.property()],P.prototype,"_isOpen",void 0),e.__decorate([i.property()],P.prototype,"_dateTimeFormatOptions",null),e.__decorate([i.property()],P.prototype,"dateInputEnabled",void 0),e.__decorate([i.property(),y.messageBundle("esri/widgets/support/t9n/DatePicker")],P.prototype,"messages",void 0),e.__decorate([i.property()],P.prototype,"value",null),e.__decorate([i.property()],P.prototype,"commitOnMonthChange",void 0),e.__decorate([i.property({type:c})],P.prototype,"viewModel",void 0),e.__decorate([i.property()],P.prototype,"onChange",void 0),e.__decorate([i.property()],P.prototype,"disabled",void 0),e.__decorate([i.property()],P.prototype,"timeZone",void 0),e.__decorate([i.property()],P.prototype,"isOpen",null),e.__decorate([p.accessibleHandler()],P.prototype,"_setNextMonth",null),e.__decorate([p.accessibleHandler()],P.prototype,"_setPreviousYear",null),e.__decorate([p.accessibleHandler()],P.prototype,"_handleSelectedDate",null),P=e.__decorate([n.subclass("esri.widgets.support.DatePicker")],P);return P}));
