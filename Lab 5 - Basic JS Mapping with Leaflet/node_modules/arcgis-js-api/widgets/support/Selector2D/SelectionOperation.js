/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../geometry","../../../core/asyncUtils","../../../core/Collection","../../../core/Evented","../../../core/handleUtils","../../../core/promiseUtils","../../../core/screenUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/coordsUtils","../../../views/draw/DrawScreenTool","../../../views/interactive/keybindings","./selectorUtils","../../../geometry/Point","../../../geometry/Polygon"],(function(e,t,o,s,r,c,i,n,l,a,p,d,h,y,u,g,_,m,v){"use strict";const w=100;let k=class extends r.EventedAccessor{constructor(e){super(e),this._processTask=null,this.options=null,this.selection=new s,this.sources=null,this._process=i.debounce((async(e,t)=>{const{callback:s,selector:r,completed:c}=e,n=o.createTask((async e=>{const{sources:t,selection:o,view:i}=this;if(!(!t?.length&&!i?.selectionManager.sources.length)&&i){if(r&&null!=t){const s=await _.getSelectionFromGeometry({currentSelection:o,selector:r,signal:e,sources:t,view:i});c&&i.selectionManager?.updateSelection({current:o.toArray(),...s})}s&&s()}else o.removeAll()}));return i.onAbort(t,(()=>n.abort())),this._processTask=n,n.promise}),w)}initialize(){this._setup()}cancel(){this.removeAllHandles(),this._processTask?.abort()}async _setup(){const{view:e}=this;if(await e.whenReady(),this.destroyed)return;const t=this.options,o=t?.createTool??"rectangle",s=t?.mode??("polygon"===o?"click":"hybrid"),r=Symbol();this._tool=new u.DrawScreenTool({view:e,mode:s,geometryType:o}),t?.selectOnComplete||this.addHandles(this._tool.on(["cursor-update","vertex-add","vertex-remove"],(()=>i.ignoreAbortErrors(this._process({selector:this._selectionArea})))),r),this.addHandles([e.on("key-down",(e=>{if(!e.repeat)switch(e.key){case g.sketchKeys.constraint:this._tool.uniformSizeToggled=!0,e.stopPropagation();break;case g.sketchKeys.center:this._tool.centeredToggled=!0,e.stopPropagation()}})),e.on("key-up",(e=>{switch(e.key){case g.sketchKeys.constraint:this._tool.uniformSizeToggled=!1,e.stopPropagation();break;case g.sketchKeys.center:this._tool.centeredToggled=!1,e.stopPropagation()}})),this._tool.on("complete",(async e=>{this.removeHandles(r);const t=()=>{this.removeAllHandles(),this.emit("complete",{aborted:e.aborted,selection:this.selection.toArray()})};e.aborted?(this.cancel(),this.selection.removeAll(),t()):await this._process({selector:this._selectionArea,callback:t,completed:!0})}))],r),this.addHandles(c.makeHandle((()=>e.tools.remove(this._tool)))),e.addAndActivateTool(this._tool)}get _selectionArea(){const e=n.createScreenPoint(),t=this._tool.coordinates,o=this.view.spatialReference,s=t=>{e.x=t[0],e.y=t[1];const{x:o,y:s}=this.view.toMap(e);return[o,s]};if(1===t.length){const[e,r]=s(t[0]);return new m({x:e,y:r,spatialReference:o})}const r=this._tool.coordinates.map(s);if(0===r.length)return;y.isClockwise(r)||r.reverse();return new v({spatialReference:o,rings:[r]})}};e.__decorate([l.property()],k.prototype,"options",void 0),e.__decorate([l.property({readOnly:!0})],k.prototype,"selection",void 0),e.__decorate([l.property()],k.prototype,"sources",void 0),e.__decorate([l.property({constructOnly:!0})],k.prototype,"view",void 0),k=e.__decorate([h.subclass("esri.widgets.support.Selector2D.SelectionOperation2D")],k);return k}));
