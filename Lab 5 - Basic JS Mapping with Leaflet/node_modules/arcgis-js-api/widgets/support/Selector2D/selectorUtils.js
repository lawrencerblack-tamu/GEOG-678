/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","exports","../../../core/promiseUtils","../../../layers/support/fieldUtils","../../../layers/support/layerUtils","../../../renderers/support/clickToleranceUtils","../../../views/support/drapedUtils","../../../views/support/layerViewUtils"],(function(e,r,t,n,s,i,a,o){"use strict";async function l(){return new Promise(((r,t)=>e(["../../../geometry/geometryEngineJSON"],r,t)))}async function c(){return l().then((({contains:e,intersects:r,overlaps:t,simplify:n})=>({contains:e,intersects:r,overlaps:t,simplify:n})))}async function u(e){const{currentSelection:r,selector:n,signal:s,sources:i,view:a}=e;if(!i?.length)return{added:[],removed:[]};const{layers:o,layerViews:l,graphicsLayers:c}=g(i),u=(await t.whenOrAbort(Promise.all([d(n,o,a,s),p(n,l,a,s),y(n,c,a)]),s)).flat();if(!r)return{added:u,removed:[]};const f=r.toArray(),h=u.filter((e=>!m(f,e))),w=f.filter((e=>!m(u,e)));return r.removeMany(w),r.addMany(h),{added:h,removed:w}}const y=async(e,r,t)=>b({candidates:r.flatMap((e=>e.graphics.toArray()))??[],selector:e,view:t}),d=async(e,r,n,s)=>{const i=await t.ignoreAbortErrors(w({selector:e,signal:s,layers:r,view:n}));return i?f(i):[]},p=async(e,r,n,s)=>{const i=await t.ignoreAbortErrors(h({selector:e,signal:s,layerViews:r,view:n}));return i?f(i):[]};function f(e){const r=[];for(let t=0;t<e.length;t++){const n=e[t];"fulfilled"===n.status&&r.push(...n.value)}return r}function g(e){const r=[],t=[],n=[];return e.forEach((e=>{s.isFeatureLayer(e)?r.push(e):(s.isKnowledgeGraphLayer(e)||s.isLinkChartLayer(e))&&e.layers?.length?r.push(...e.layers.toArray()):s.isMapNotesLayer(e)&&e.sublayers?.length?n.push(...e.sublayers.toArray()):s.isGraphicsLayer(e)?n.push(e):o.isSelectableLayerView2D(e)&&t.push(e)})),{layers:r,layerViews:t,graphicsLayers:n}}function m(e,r){if(e.includes(r))return!0;const t=r.getObjectId(),n=null!=t,{layer:s,uid:i}=r;return n?e.some((e=>{if(s===e.layer)return t===e.getObjectId()})):e.some((e=>{if(s===e.layer)return i===e.uid}))}async function h(e){const{layerViews:r,selector:n,signal:s,view:i}=e;return t.whenOrAbort(Promise.allSettled(r.map((async e=>{const r=e.createQuery(),{geometry:t}=F(n,e.layer,i);return r.outFields=["*"],r.geometry=t,r.returnGeometry=!0,r.outSpatialReference=i.spatialReference,e.queryFeatures(r,{signal:s}).then((({features:e})=>e))}))),s)}async function w(e){const{layers:r,selector:n,signal:s,view:i}=e;return t.whenOrAbort(Promise.allSettled(r.map((async e=>e.queryFeatures(v(e.createQuery(),n,e,i),{signal:s}).then((({features:e})=>e))))),s)}function F(e,r,t){const s="displayField"in r?r.displayField:null,o=n.getDisplayFieldName({displayField:s,fields:r.fields}),l=[r.objectIdField];null!=o&&r.fieldsIndex.has(o)&&l.push(o);const c="renderer"in r?i.calculateTolerance({renderer:r.renderer}):0;return{geometry:"point"===e.type?a.createQueryGeometry(e,c,t):e,outFields:l}}function v(e,r,t,n){const{outFields:s,geometry:i}=F(r,t,n);return e.outFields=s,e.geometry=i,e.returnGeometry=!0,e.outSpatialReference=n.spatialReference,e}async function b(e){const{selector:r,candidates:t,view:n}=e;if(!t?.length||!r)return[];const{spatialReference:s}=n,i=r,a=await c();return t.filter((e=>a.intersects(s,i,e.geometry)))}r.getGeometryEngineOperations=c,r.getQueryOptionsFromLayer=F,r.getSelectionFromFeatureLayerViews=h,r.getSelectionFromFeatureLayers=w,r.getSelectionFromGeometry=u,r.getSelectionFromGeometryEngine=b,r.importGeometryEngine=l,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));
