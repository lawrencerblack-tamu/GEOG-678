/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Accessor","../../core/Collection","../../core/collectionUtils","../../core/Logger","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../layers/BuildingSceneLayer","../../layers/support/BuildingFilter","./BuildingDisciplinesViewModel","./BuildingLevel","./BuildingPhase","./support/buildingLayerUtils","./support/filterUtils","./support/layerUtils"],(function(e,t,s,r,i,l,o,a,n,d,p,y,c,h,u,g,_,w,v){"use strict";let f=class extends t{constructor(e){super(e),this.view=null,this.state="disabled",this.level=new u,this.phase=new g,this.disciplines=new h,this._loadLayers=v.createLoadLayersFunction(),this.layers=new s}initialize(){this.addHandles([this.layers.on("change",(()=>this._onLayersChange())),o.watch((()=>({state:this.state,layers:this.layers,filter:this._filter})),(({state:e,layers:t,filter:s})=>{"ready"===e&&w.setFilterOnLayers(t,s)}),{initial:!0})]),this._onLayersChange()}destroy(){this.level.destroyed||this.level.destroy(),this.phase.destroyed||this.phase.destroy(),this.disciplines.destroyed||this.disciplines.destroy()}get isSupported(){return"3d"===this.view?.type}get layers(){return this._get("layers")}set layers(e){const t=e.filter((e=>e instanceof y));t.length!==e.length&&i.getLogger(this).error("Some layers are not BuildingSceneLayers but only BuildingSceneLayers can be passed to the widget."),this._set("layers",r.referenceSetter(t,this._get("layers")))}get _filter(){const e=this.level.filterExpressions,t=this.phase.filterExpressions,s=[],r=w.getFilterBlockSolid([e.solid,t.solid]);null!=r&&s.push(r);const i=w.getFilterBlockXRay([e.xRay,t.xRay]);return null!=i&&s.push(i),0===s.length?null:new c({id:w.generateFilterId(),name:"Building Explorer Filter",filterBlocks:s})}async _onLayersChange(){const e=this.layers;if(this.level.layers=e,this.phase.layers=e,this.disciplines.layers=e,0!==e.length){this._set("state","loading");try{await this._loadLayers(e),await Promise.all([o.whenOnce((()=>"ready"===this.level.state)),o.whenOnce((()=>"ready"===this.phase.state)),o.whenOnce((()=>"ready"===this.disciplines.state))]),e.forEach(_.showFullModel),this._set("state","ready")}catch(t){l.isAbortError(t)||this._set("state","failed")}}else this._set("state","disabled")}};e.__decorate([a.property({value:null})],f.prototype,"view",void 0),e.__decorate([a.property()],f.prototype,"isSupported",null),e.__decorate([a.property({type:s,nonNullable:!0})],f.prototype,"layers",null),e.__decorate([a.property({readOnly:!0})],f.prototype,"state",void 0),e.__decorate([a.property({readOnly:!0,type:u})],f.prototype,"level",void 0),e.__decorate([a.property({readOnly:!0,type:g})],f.prototype,"phase",void 0),e.__decorate([a.property({readOnly:!0,type:h})],f.prototype,"disciplines",void 0),e.__decorate([a.property()],f.prototype,"_filter",null),f=e.__decorate([p.subclass("esri.widgets.BuildingExplorer.BuildingExplorerViewModel")],f);return f}));
