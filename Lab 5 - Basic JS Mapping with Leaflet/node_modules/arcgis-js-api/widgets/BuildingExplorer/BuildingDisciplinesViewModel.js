/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Accessor","../../core/Collection","../../core/collectionUtils","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./support/buildingLayerUtils","./support/LayerTreeNode","./support/layerUtils"],(function(e,t,s,r,o,a,i,l,d,n,y,c,h){"use strict";let p=class extends t{constructor(e){super(e),this.root=new c.LayerTreeNode,this.state="disabled",this._loadLayers=h.createLoadLayersFunction(),this.layers=new s}initialize(){this.addHandles(this.layers.on("change",(()=>this._onLayersChange()))),this._onLayersChange()}destroy(){this._set("state","disabled"),this.root.destroy()}set layers(e){const t=this._get("layers");this._set("layers",r.referenceSetter(e,t))}_updateLayerTree(){this.root.destroy(),this._set("root",new c.LayerTreeNode({collapsed:!1}));const e=new Map,t=this.layers.length>1?"modelName":"id";return this.layers.forEach((s=>{const r=y.findFullModelSublayer(s);this._addNodesForSublayers(r??s,this.root,e,t)})),this}_addNodeForLayer(e,t,s,r){const o=String(e[r]).toLowerCase();if(null==o||e.isEmpty)return;const a=`${t.id}/${o}`;let i=s.get(a);i||(i=new c.LayerTreeNode({id:o,level:t.level+1}),s.set(a,i)),i.layers.push(e),t.children.push(i),this._addNodesForSublayers(e,i,s,r)}_addNodesForSublayers(e,t,s,r){("building-scene"===e.type||"building-group"===e.type&&!e.isEmpty)&&e.sublayers.forEach((e=>this._addNodeForLayer(e,t,s,r)))}async _onLayersChange(){if(this._set("state","loading"),0!==this.layers.length)try{await this._loadLayers(this.layers),this._updateLayerTree(),this._set("state","ready")}catch(e){o.isAbortError(e)||this._set("state","failed")}}};e.__decorate([a.property({readOnly:!0})],p.prototype,"root",void 0),e.__decorate([a.property({type:s,nonNullable:!0})],p.prototype,"layers",null),e.__decorate([a.property({readOnly:!0,nonNullable:!0})],p.prototype,"state",void 0),p=e.__decorate([n.subclass("esri.widgets.BuildingExplorer.BuildingDisciplineViewModel")],p);return p}));
