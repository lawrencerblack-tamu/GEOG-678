/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","exports","../../../core/Logger","../../../core/promiseUtils","../../../layers/FeatureLayer","./featureUtils","../../support/globalCss"],(function(e,r,t,a,i,o,n){"use strict";const s="esri.widgets.Feature.support.arcadeFeatureUtils",c=()=>t.getLogger(s);function p(e){return"string"==typeof e?o.applyTextFormattingHTML(o.htmlEntities(e)):Array.isArray(e)?l(e):"esri.arcade.Dictionary"===e?.declaredClass?u(e):e}function l(e){return`<ul class="esri-widget__list">${e.map((e=>`<li>${"string"==typeof e?o.applyTextFormattingHTML(o.htmlEntities(e)):e}</li>`)).join("")}</ul>`}function u(e){const r=e.keys().map((r=>{const t=e.field(r);return`<tr><th>${r}</th><td>${"string"==typeof t?o.applyTextFormattingHTML(o.htmlEntities(t)):t}</td></tr>`})).join("");return`<table class="${n.globalCss.table}">${r}</table>`}function d(){return new Promise(((r,t)=>e(["../../../arcade"],r,t)))}function y(e){return"createQuery"in e&&"queryFeatures"in e}async function g({graphic:e,view:r,options:t}){const{isAggregate:a,layer:i}=e;if(!a||!i||"2d"!==r?.type)return[];const o=await r.whenLayerView(i);if(!y(o))return[];const n=o.createQuery(),s=e.getObjectId();n.aggregateIds=null!=s?[s]:[];const{features:c}=await o.queryFeatures(n,t);return c}function f({layer:e,aggregatedFeatures:r,interceptor:t}){const{fields:a,objectIdField:o,geometryType:n,spatialReference:s,displayField:c}=e;return new i({fields:a,objectIdField:o,geometryType:n,spatialReference:s,displayField:c,interceptor:t,..."feature"===e.type?{templates:e.templates,typeIdField:e.typeIdField,types:e.types}:null,source:r})}async function m({expressionInfo:e,arcade:r,interceptor:t,spatialReference:a,map:i,graphic:o,location:n,view:s,options:p}){if(!e?.expression)return null;const{isAggregate:l}=o,u=(o.sourceLayer||o.layer)??void 0,d=l?"feature-reduction-popup":"popup",y=r.createArcadeProfile(d),m=r.createArcadeExecutor(e.expression,y).catch((r=>c().error("arcade-executor-error",{error:r,expressionInfo:e}))),[w,h]=await Promise.all([g({graphic:o,view:s,options:p}),m]);if(!h)return null;const x="feature-reduction-popup"===d?f({layer:u,aggregatedFeatures:w,interceptor:t}):void 0,F={..."feature-reduction-popup"===d?{$aggregatedFeatures:x}:{$datastore:u?.url,$layer:"feature"===u?.type||"subtype-sublayer"===u?.type?u:"scene"===u?.type&&null!=u.associatedLayer?u.associatedLayer:void 0,$map:i,$userInput:n,$graph:"knowledge-graph-sublayer"===u?.type?u?.parentCompositeLayer?.knowledgeGraph:void 0},$feature:o},b={abortSignal:p?.signal??void 0,interceptor:t??void 0,rawOutput:!0,spatialReference:a??void 0,timeZone:s?.timeZone};return await h.executeAsync(F,b).catch((r=>c().error("arcade-execution-error",{error:r,graphic:o,expressionInfo:e}))).finally((()=>x?.destroy()))}async function w({expressionInfos:e,spatialReference:r,graphic:t,interceptor:i,map:o,view:n,location:s,options:c}){if(!e?.length)return{};const l=await d(),u={};for(const a of e)u[`expression/${a.name}`]=m({expressionInfo:a,arcade:l,interceptor:i,spatialReference:r,map:o,graphic:t,location:s,view:n,options:c});const y=await a.eachAlways(u),g={};for(const a in y)g[a]=p(y[a].value);return g}r.createCompiledExpression=m,r.createCompiledExpressions=w,r.loadArcade=d,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));
