/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../request","../../../core/arrayUtils","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../layers/support/fieldUtils","../../../core/has","../../../layers/support/source/DataLayerSource","../../../rest/query/executeQueryJSON","../../../config","../../../kernel","../../../core/urlUtils","../../../core/unitUtils","../../../geometry/ellipsoidUtils","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/aaBoundingBox","../../../core/mathUtils","../../../geometry/Extent","../../../geometry/Geometry","../../../geometry/Multipoint","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/Polyline","../../../geometry/support/normalizeUtilsCommon","../../../geometry/SpatialReference","../../../geometry/support/Ellipsoid","../../../geometry","../../../core/pbf","../../../rest/support/FeatureSet","../../../rest/support/Query","../../../rest/query/support/AttachmentInfo","../../../rest/support/AttachmentQuery","../../../rest/support/RelationshipQuery","../../../rest/support/TopFeaturesQuery","../../../rest/support/StatisticDefinition","./featureUtils"],(function(e,t,r,i,o,s,n,a,l,u,c,d,f,p,y,g,h,m,F,S,I,w,b,R,q,N,O,U,$,T,v,A,j,J,L,Q,x){"use strict";const P="esri.widgets.Feature.support.relatedFeatureUtils",C=()=>o.getLogger(P),E=new Map;function k(e){if(!x.isRelatedField(e))return null;const[t,r]=e.split("/").slice(1);return{layerId:t,fieldName:r}}function D(e,t){if(!t.relationships)return null;let r=null;const{relationships:i}=t;return i.some((t=>t.id===parseInt(e,10)&&(r=t,!0))),r}function M({originRelationship:e,relationships:t,layerId:r}){return t.find((({relatedTableId:t,id:i})=>`${t}`===r&&i===e?.id))??null}function B(e,t){const r=t.toLowerCase();for(const i in e)if(i.toLowerCase()===r)return e[i];return null}function z(e,t){const r=D(e,t);if(!r)return;return{url:`${t.url}/${r.relatedTableId}`,sourceSpatialReference:t.spatialReference,relation:r,relatedFields:[],outStatistics:[]}}function G(e,t){if(!t)return;if(!e)return;const{features:r,statsFeatures:i}=e,o=r?.value;t.relatedFeatures=o?o.features:[];const s=i?.value;t.relatedStatsFeatures=s?s.features:[]}function H(e,t,r,i){const o=new J;return o.outFields=["*"],o.relationshipId="number"==typeof t.id?t.id:parseInt(t.id,10),o.objectIds=[e.attributes[r.objectIdField]],r.queryRelatedFeatures?.(o,i)??Promise.resolve({})}function K(e,t,r){let i=0;const o=[];for(;i<t.length;)o.push(`${e} IN (${t.slice(i,r+i)})`),i+=r;return o.join(" OR ")}function V(e){return e?r.unique(e):void 0}function W(e){return e?r.unique(e,((e,t)=>JSON.stringify(e.toJSON())===JSON.stringify(t.toJSON()))):void 0}async function X(e,t,r,i){const o=r.layerId.toString(),{layerInfo:a,relation:l,relatedFields:c,outStatistics:d,url:f,sourceSpatialReference:p}=t,y=V(c),g=W(d);if(!a||!l)return null;const h=M({originRelationship:l,relationships:a.relationships,layerId:o});if(h?.relationshipTableId&&h.keyFieldInRelationshipTable){const t=(await H(e,h,r,i))[e.attributes[r.objectIdField]];if(!t)return null;const o=t.features.map((e=>e.attributes[a.objectIdField]));if(g?.length&&a.supportsStatistics){const e=new v;e.where=K(a.objectIdField,o,1e3),e.outFields=y,e.outStatistics=g,e.sourceSpatialReference=p;const r={features:Promise.resolve(t),statsFeatures:u.executeQueryJSON(f,e)};return s.eachAlways(r)}}const m=h?.keyField;if(m){const t=n.isNumericField(te(a.fields,m)),r=B(e.attributes,l.keyField),o=t?`${m}=${r}`:`${m}='${r}'`,c=u.executeQueryJSON(f,new v({where:o,outFields:y,sourceSpatialReference:p}),i),d=!!g?.length&&a.supportsStatistics?u.executeQueryJSON(f,new v({where:o,outFields:y,outStatistics:g,sourceSpatialReference:p}),i):null,h={features:c};return d&&(h.statsFeatures=d),s.eachAlways(h)}return null}function Y(e,r){return t(e,{query:{f:"json"},signal:r?.signal})}function Z({relatedInfos:e,layer:t},r){const o={};return e.forEach(((e,r)=>{const{relation:s}=e;if(!s){const e=new i("relation-required","A relation is required on a layer to retrieve related records.");throw C().error(e),e}const{relatedTableId:n}=s;if("number"!=typeof n){const e=new i("A related table ID is required on a layer to retrieve related records.");throw C().error(e),e}const a=`${t.url}/${n}`,l=E.get(a),u=l??Y(a);l||E.set(a,u),o[r]=u})),s.whenOrAbort(s.eachAlways(o),r)}function _({graphic:e,relatedInfos:t,layer:r},i){const o={};return t.forEach(((t,s)=>{t.layerInfo&&(o[s]=X(e,t,r,i))})),s.eachAlways(o)}function ee({relatedInfo:e,fieldName:t,fieldInfo:r}){if(e.relatedFields?.push(t),r.statisticType){const i=new Q({statisticType:r.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics?.push(i)}}function te(e,t){if(null!=e){t=t.toLowerCase();for(const r of e)if(r&&r.name.toLowerCase()===t)return r}return null}e.createRelatedInfo=z,e.getDestinationRelation=M,e.getRelatedFieldInfo=k,e.getUniqueOutFields=V,e.getUniqueOutStatistics=W,e.queryLayerInfos=Z,e.queryRelatedFeatures=_,e.setRelatedFeatures=G,e.updateRelatedInfo=ee,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
