/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../geometry","../../Graphic","../../arcade/featureset/support/FeatureSetQueryInterceptor","../../core/Accessor","../../core/arrayUtils","../../core/Identifiable","../../core/Logger","../../core/promiseUtils","../../core/reactiveUtils","../../core/throttle","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/has","../../core/accessorSupport/decorators/subclass","../../popup/content/TextContent","../../time/timeZoneUtils","./FeatureAttachments/FeatureAttachmentsViewModel","./FeatureContent/FeatureContentViewModel","./FeatureExpression/FeatureExpressionViewModel","./FeatureFields/FeatureFieldsViewModel","./FeatureMedia/FeatureMediaViewModel","./FeatureRelationship/FeatureRelationshipViewModel","./support/arcadeFeatureUtils","./support/featureUtils","./support/relatedFeatureUtils","../../geometry/Point"],(function(e,t,r,i,o,s,a,n,l,c,p,d,u,h,f,_,m,y,b,g,I,A,F,M,w,x,v){"use strict";var C;const E=1,T="content-view-models",V="relationship-view-models",R={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0};let L=C=class extends(a.IdentifiableMixin(o)){constructor(e){super(e),this._error=null,this._featureAbortController=null,this._graphicChangedThrottled=p.throttle(this._graphicChanged,E,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...R},this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.location=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=e=>{const{abilities:t}=this;return"attachments"===e.type&&!!t.attachmentsContent||"custom"===e.type&&!!t.customContent||"fields"===e.type&&!!t.fieldsContent||"media"===e.type&&!!t.mediaContent||"text"===e.type&&!!t.textContent||"expression"===e.type&&!!t.expressionContent||"relationship"===e.type&&!!t.relationshipContent},this.addHandles(c.watch((()=>[this.graphic,this._effectivePopupTemplate,this.abilities,this.timeZone]),(()=>this._graphicChangedThrottled()),c.initial))}initialize(){this.addHandles(this._graphicChangedThrottled)}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return null!=this.graphic?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return w.createFieldInfoMap(w.getAllFieldInfos(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return w.getSourceLayer(this.graphic)}castAbilities(e){return{...R,...e}}get isTable(){return this._sourceLayer?.isTable||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(e){this._set("graphic",e?.clone()??null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get timeZone(){return this.view?.timeZone??m.system}set timeZone(e){this._overrideIfSome("timeZone",e)}get map(){return this.view?.map||null}set map(e){this._override("map",e)}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(e,t){const r=this.contentViewModels[e];r instanceof A&&r.setActiveMedia(t)}nextMedia(e){const t=this.contentViewModels[e];t instanceof A&&t.next()}previousMedia(e){const t=this.contentViewModels[e];t instanceof A&&t.previous()}async updateGeometry(){const{graphic:e,spatialReference:t,_sourceLayer:r}=this;await(r?.load());const i=r?.objectIdField;if(!i||!e||!r)return;const o=e?.attributes?.[i];if(null==o)return;const s=[o];if(!e.geometry){const i=await w.querySourceLayer({layer:r,graphic:e,outFields:[],objectIds:s,returnGeometry:!0,spatialReference:t}),o=i?.geometry;o&&(e.geometry=o)}}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async _graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:e}=this;if(!e)return;const t=new AbortController;this._featureAbortController=t;try{await this._queryFeature({signal:t.signal})}catch(r){l.isAbortError(r)||(this._error=r,n.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:r,graphic:e,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===t&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:e}=this;e&&e.abort(),this._featureAbortController=null}_compileContentElement(e,t){return"attachments"===e.type?this._compileAttachments(e,t):"custom"===e.type?this._compileCustom(e,t):"fields"===e.type?this._compileFields(e,t):"media"===e.type?this._compileMedia(e,t):"text"===e.type?this._compileText(e,t):"expression"===e.type?this._compileExpression(e,t):"relationship"===e.type?this._compileRelationship(e,t):void 0}_compileContent(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.filter(this._isAllowedContentType).map(((e,t)=>this._compileContentElement(e,t))).filter(s.isSome):"string"==typeof e?this._compileText(new _({text:e}),0).text:e}_destroyContentViewModels(){this.removeHandles(V),this.removeHandles(T),this.contentViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("contentViewModels",[])}_matchesFeature(e,t){const r=e?.graphic?.getObjectId(),i=t?.getObjectId();return null!=r&&null!=i&&r===i}_setRelatedFeaturesViewModels({relatedFeatureViewModels:e,relatedFeatures:t,map:r}){const{view:i,spatialReference:o}=this;t?.filter(Boolean).forEach((t=>{e.some((e=>this._matchesFeature(e,t)))||e.add(new C({abilities:{relationshipContent:!1},map:r,view:i,spatialReference:o,graphic:t}))})),e.forEach((r=>{const i=t?.find((e=>this._matchesFeature(r,e)));i||e.remove(r)}))}_setExpressionContentVM(e,t){const r=this.formattedAttributes,{contentElement:i,contentElementViewModel:o}=e,s=i?.type;o&&s&&("fields"===s&&(this._createFieldsFormattedAttributes({contentElement:i,contentElementIndex:t,formattedAttributes:r}),o.set(this._createFieldsVMParams(i,t))),"media"===s&&(this._createMediaFormattedAttributes({contentElement:i,contentElementIndex:t,formattedAttributes:r}),o.set(this._createMediaVMParams(i,t))),"text"===s&&o.set(this._createTextVMParams(i)))}_compileRelationship(e,t){const{displayCount:r,orderByFields:i,relationshipId:o,title:s,description:a}=e,{_sourceLayer:n,graphic:l,map:p}=this;if(!w.isRelatableFeatureSupportedLayer(n))return;const d=new F({displayCount:r,graphic:l,orderByFields:i,relationshipId:o,layer:n,map:p,...this._compileTitleAndDesc({title:s,description:a})});return this.contentViewModels[t]=d,this.addHandles(c.on((()=>d.relatedFeatures),"change",(()=>this._setRelatedFeaturesViewModels(d))),V),e}_compileExpression(e,t){const{expressionInfo:r}=e,{graphic:i,map:o,spatialReference:s,view:a,location:n}=this,l=new g({expressionInfo:r,graphic:i,interceptor:C.interceptor,map:o,spatialReference:s,view:a,location:n});return this.contentViewModels[t]=l,this.addHandles(c.watch((()=>l.contentElementViewModel),(()=>this._setExpressionContentVM(l,t)),c.initial),T),e}_compileAttachments(e,t){const{graphic:r}=this,{description:i,title:o}=e;return this.contentViewModels[t]=new y({graphic:r,...this._compileTitleAndDesc({title:o,description:i})}),e}_compileCustom(e,t){const{graphic:r}=this,{creator:i,destroyer:o}=e;return this.contentViewModels[t]=new b({graphic:r,creator:i,destroyer:o}),e}_compileTitleAndDesc({title:e,description:t}){const{_fieldInfoMap:r,_sourceLayer:i,graphic:o,formattedAttributes:s}=this,a=o?.attributes,n=this._expressionAttributes,l=s.global;return{title:w.substituteFieldsInLinksAndAttributes({attributes:a,fieldInfoMap:r,globalAttributes:l,expressionAttributes:n,layer:i,text:e}),description:w.substituteFieldsInLinksAndAttributes({attributes:a,fieldInfoMap:r,globalAttributes:l,expressionAttributes:n,layer:i,text:t})}}_createFieldsVMParams(e,t){const r=this._effectivePopupTemplate,i=this.formattedAttributes,o={...i?.global,...i?.content[t]},s=e?.fieldInfos||r?.fieldInfos,a=s?.filter((({fieldName:e})=>w.isExpressionField(e)||w.isRelatedField(e)||o.hasOwnProperty(e))),n=r?.expressionInfos,{description:l,title:c}=e;return{attributes:o,expressionInfos:n,fieldInfos:a,...this._compileTitleAndDesc({title:c,description:l})}}_compileFields(e,t){const r=e.clone(),i=new I(this._createFieldsVMParams(e,t));return this.contentViewModels[t]=i,r.fieldInfos=i.formattedFieldInfos.slice(0),r}_createMediaVMParams(e,t){const{abilities:r,graphic:i,_fieldInfoMap:o,_effectivePopupTemplate:s,relatedInfos:a,_sourceLayer:n,_expressionAttributes:l}=this,c=this.formattedAttributes,p=i?.attributes??{},{description:d,mediaInfos:u,title:h}=e;return{abilities:{chartAnimation:r.chartAnimation},activeMediaInfoIndex:e.activeMediaInfoIndex||0,attributes:p,isAggregate:i?.isAggregate,layer:n,fieldInfoMap:o,formattedAttributes:{...c?.global,...c?.content[t]},expressionAttributes:l,mediaInfos:u,popupTemplate:s,relatedInfos:a,...this._compileTitleAndDesc({title:h,description:d})}}_compileMedia(e,t){const r=e.clone(),i=new A(this._createMediaVMParams(e,t));return r.mediaInfos=i.formattedMediaInfos.slice(0),this.contentViewModels[t]=i,r}_createTextVMParams(e){const{graphic:t,_fieldInfoMap:r,_sourceLayer:i,_expressionAttributes:o}=this;if(e&&e.text){const s=t?.attributes??{},a=this.formattedAttributes?.global??{};e.text=w.substituteFieldsInLinksAndAttributes({attributes:s,fieldInfoMap:r,globalAttributes:a,expressionAttributes:o,layer:i,text:e.text})}return{graphic:t,creator:e.text}}_compileText(e,t){const r=e.clone();return this.contentViewModels[t]=new b(this._createTextVMParams(r)),r}_compileLastEditInfo(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:r,timeZone:i}=this;if(!e)return;const{lastEditInfoEnabled:o}=e,s=t?.editFieldsInfo;return o&&s?w.formatEditInfo(s,r?.attributes,i,t):void 0}_compileTitle(e){const{_fieldInfoMap:t,_sourceLayer:r,graphic:i,_expressionAttributes:o}=this,s=i?.attributes??{},a=this.formattedAttributes?.global??{};return w.substituteFieldsInLinksAndAttributes({attributes:s,fieldInfoMap:t,globalAttributes:a,expressionAttributes:o,layer:r,text:e})}async _getTitle(){const{_effectivePopupTemplate:e,graphic:t}=this;if(!t)return null;const r=e?.title;return w.graphicCallback(r,{graphic:t})}async _getContent(){const{_effectivePopupTemplate:e,graphic:t}=this;if(!t)return null;const r=e?.content;return w.graphicCallback(r,{graphic:t})}async _queryFeature(e){const{_featureAbortController:t,_sourceLayer:r,graphic:i,_effectivePopupTemplate:o}=this,s=this.map,a=this.view,n=this.spatialReference,c=this.location;if(t!==this._featureAbortController||!i)return;await w.queryUpdatedFeature({graphic:i,popupTemplate:o,layer:r,spatialReference:n},e);const{content:{value:p},title:{value:d}}=await l.eachAlways({content:this._getContent(),title:this._getTitle()}),{expressionAttributes:{value:u}}=await l.eachAlways({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:M.createCompiledExpressions({expressionInfos:o?.expressionInfos,spatialReference:n,graphic:i,map:s,interceptor:C.interceptor,view:a,options:e,location:c})});t===this._featureAbortController&&i&&(this._expressionAttributes=u,this._graphicExpressionAttributes={...i.attributes,...u},this._set("formattedAttributes",this._createFormattedAttributes(p)),this._set("title",this._compileTitle(d)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(p)||null))}_createMediaFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:r}){const{_effectivePopupTemplate:i,graphic:o,relatedInfos:s,_sourceLayer:a,_fieldInfoMap:n,_graphicExpressionAttributes:l,timeZone:c}=this;r.content[t]=w.formatAttributes({fieldInfos:i?.fieldInfos,graphic:o,attributes:{...l,...e.attributes},layer:a,fieldInfoMap:n,relatedInfos:s,timeZone:c})}_createFieldsFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:r}){if(e.fieldInfos){const{graphic:i,relatedInfos:o,_sourceLayer:s,_fieldInfoMap:a,_graphicExpressionAttributes:n,timeZone:l}=this;r.content[t]=w.formatAttributes({fieldInfos:e.fieldInfos,graphic:i,attributes:{...n,...e.attributes},layer:s,fieldInfoMap:a,relatedInfos:o,timeZone:l})}}_createFormattedAttributes(e){const{_effectivePopupTemplate:t,graphic:r,relatedInfos:i,_sourceLayer:o,_fieldInfoMap:s,_graphicExpressionAttributes:a,timeZone:n}=this,l=t?.fieldInfos,c={global:w.formatAttributes({fieldInfos:l,graphic:r,attributes:a,layer:o,fieldInfoMap:s,relatedInfos:i,timeZone:n}),content:[]};return Array.isArray(e)&&e.forEach(((e,t)=>{"fields"===e.type&&this._createFieldsFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:c}),"media"===e.type&&this._createMediaFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:c})})),c}_checkForRelatedFeatures(e){const{graphic:t,_effectivePopupTemplate:r}=this;return this._queryRelatedInfos(t,w.getAllFieldInfos(r),e)}async _queryRelatedInfos(e,t,r){const{relatedInfos:i,_sourceLayer:o}=this;i.clear();const s=null!=o?.associatedLayer?await(o?.associatedLayer.load(r)):o;if(!s||!e)return;const a=t.filter((e=>e&&w.isRelatedField(e.fieldName)));if(!a?.length)return;t.forEach((e=>this._configureRelatedInfo(e,s)));const n=await x.queryLayerInfos({relatedInfos:i,layer:s},r);Object.keys(n).forEach((e=>{const t=i.get(e.toString()),r=n[e]?.value;t&&r&&(t.layerInfo=r.data)}));const l=await x.queryRelatedFeatures({graphic:e,relatedInfos:i,layer:s},r);Object.keys(l).forEach((e=>{x.setRelatedFeatures(l[e]?.value,i.get(e.toString()))}))}_configureRelatedInfo(e,t){const{relatedInfos:r}=this,i=x.getRelatedFieldInfo(e.fieldName);if(!i)return;const{layerId:o,fieldName:s}=i;if(!o)return;const a=r.get(o.toString())||x.createRelatedInfo(o,t);a&&(x.updateRelatedInfo({relatedInfo:a,fieldName:s,fieldInfo:e}),this.relatedInfos.set(o,a))}};L.interceptor=new i.FeatureSetQueryInterceptor(w.preLayerQueryCallback,w.preRequestCallback),e.__decorate([d.property()],L.prototype,"_error",void 0),e.__decorate([d.property()],L.prototype,"_featureAbortController",void 0),e.__decorate([d.property({readOnly:!0})],L.prototype,"_effectivePopupTemplate",null),e.__decorate([d.property({readOnly:!0})],L.prototype,"_fieldInfoMap",null),e.__decorate([d.property({readOnly:!0})],L.prototype,"_sourceLayer",null),e.__decorate([d.property()],L.prototype,"abilities",void 0),e.__decorate([u.cast("abilities")],L.prototype,"castAbilities",null),e.__decorate([d.property({readOnly:!0})],L.prototype,"content",void 0),e.__decorate([d.property({readOnly:!0})],L.prototype,"contentViewModels",void 0),e.__decorate([d.property()],L.prototype,"description",void 0),e.__decorate([d.property({type:Boolean})],L.prototype,"defaultPopupTemplateEnabled",void 0),e.__decorate([d.property({readOnly:!0})],L.prototype,"isTable",null),e.__decorate([d.property({readOnly:!0})],L.prototype,"state",null),e.__decorate([d.property({readOnly:!0})],L.prototype,"formattedAttributes",void 0),e.__decorate([d.property({type:r,value:null})],L.prototype,"graphic",null),e.__decorate([d.property({readOnly:!0})],L.prototype,"lastEditInfo",void 0),e.__decorate([d.property({type:v})],L.prototype,"location",void 0),e.__decorate([d.property({readOnly:!0})],L.prototype,"relatedInfos",void 0),e.__decorate([d.property()],L.prototype,"spatialReference",null),e.__decorate([d.property()],L.prototype,"timeZone",null),e.__decorate([d.property({readOnly:!0})],L.prototype,"title",void 0),e.__decorate([d.property()],L.prototype,"map",null),e.__decorate([d.property({readOnly:!0})],L.prototype,"waitingForContent",null),e.__decorate([d.property()],L.prototype,"view",void 0),L=C=e.__decorate([f.subclass("esri.widgets.Feature.FeatureViewModel")],L);return L}));
