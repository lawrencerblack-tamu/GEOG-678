/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../geometry","../../../Graphic","../../../core/Accessor","../../../core/reactiveUtils","../../../core/throttle","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../popup/content/AttachmentsContent","../../../popup/content/Content","../../../popup/content/CustomContent","../../../popup/content/ExpressionContent","../../../popup/content/FieldsContent","../../../popup/content/MediaContent","../../../popup/content/RelationshipContent","../../../popup/content/TextContent","../../../popup/ElementExpressionInfo","../FeatureContent/FeatureContentViewModel","../FeatureFields/FeatureFieldsViewModel","../FeatureMedia/FeatureMediaViewModel","../support/arcadeFeatureUtils","../../../geometry/Point"],(function(e,t,o,n,r,i,s,l,p,a,c,d,h,u,_,y,m,w,C,f,E,v,b,x,M){"use strict";const g=1;let F=class extends n{constructor(e){super(e),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.location=null,this.view=null,this._cancelQuery=()=>{const{_abortController:e}=this;e&&e.abort(),this._abortController=null},this._createVM=()=>{const e=this.contentElement?.type;this.contentElementViewModel?.destroy();const t="fields"===e?new v:"media"===e?new b:"text"===e?new E:null;this._set("contentElementViewModel",t)},this._compile=async()=>{this._cancelQuery();const e=new AbortController;this._abortController=e,await this._compileExpression(),this._abortController===e&&(this._abortController=null)},this._compileThrottled=i.throttle(this._compile,g,this),this._compileExpression=async()=>{const{expressionInfo:e,graphic:t,interceptor:o,spatialReference:n,map:r,location:i,view:s,_abortController:l}=this;if(!e||!t)return void this._set("contentElement",null);const p=await x.loadArcade();if(l!==this._abortController)return;const a=await x.createCompiledExpression({arcade:p,expressionInfo:e,graphic:t,location:i,interceptor:o,map:r,spatialReference:n,view:s});if(!a||"esri.arcade.Dictionary"!==a.declaredClass)return void this._set("contentElement",null);const c=await a.castAsJsonAsync(l?.signal),d=c?.type,h="media"===d?m.fromJSON(c):"text"===d?C.fromJSON(c):"fields"===d?y.fromJSON(c):null;this._set("contentElement",h)},this.addHandles([r.watch((()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view]),(()=>this._compileThrottled()),r.initial),r.watch((()=>[this.contentElement]),(()=>this._createVM()),r.initial)])}initialize(){this.addHandles(this._compileThrottled)}destroy(){this._cancelQuery(),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){const{_abortController:e,contentElement:t,contentElementViewModel:o}=this;return e?"loading":t||o?"ready":"disabled"}get map(){return this.view?.map??null}set map(e){this._override("map",e)}};e.__decorate([s.property()],F.prototype,"_abortController",void 0),e.__decorate([s.property({type:f})],F.prototype,"expressionInfo",void 0),e.__decorate([s.property({type:o})],F.prototype,"graphic",void 0),e.__decorate([s.property({readOnly:!0})],F.prototype,"contentElement",void 0),e.__decorate([s.property({readOnly:!0})],F.prototype,"contentElementViewModel",void 0),e.__decorate([s.property()],F.prototype,"interceptor",void 0),e.__decorate([s.property({type:M})],F.prototype,"location",void 0),e.__decorate([s.property()],F.prototype,"spatialReference",null),e.__decorate([s.property({readOnly:!0})],F.prototype,"state",null),e.__decorate([s.property()],F.prototype,"map",null),e.__decorate([s.property()],F.prototype,"view",void 0),F=e.__decorate([c.subclass("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],F);return F}));
