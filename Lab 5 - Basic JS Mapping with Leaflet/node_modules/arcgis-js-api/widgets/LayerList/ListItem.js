/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Accessor","../../core/arrayUtils","../../core/Collection","../../core/Identifiable","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/has","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/get","../../support/actions/ActionBase","../../support/actions/ActionButton","../../support/actions/ActionSlider","../../support/actions/ActionToggle","./ListItemPanel","./support/layerListUtils"],(function(e,t,i,r,s,o,a,n,l,p,c,h,d,y,u,_,b){"use strict";var v;const w=r.ofType({key:"type",defaultKeyValue:"button",base:h,typeMap:{button:d,toggle:u,slider:y}}),g=r.ofType(w),S="layer",f="child-list-mode",m="hide",C="esri.widgets.LayerList.ListItem";let L=v=class extends(s.IdentifiableMixin(t)){constructor(e){super(e),this.actionsSections=new g,this.actionsOpen=!1,this.checkPublishStatusEnabled=!1,this.children=new(r.ofType(v)),this.childrenSortable=!0,this.hidden=!1,this.layer=null,this.layerView=null,this.listItemCreatedFunction=null,this.open=!1,this.panel=null,this.parent=null,this.sortable=!0,this.view=null}initialize(){if(this.addHandles([o.watch((()=>[this.layer,this.layer?.listMode]),(()=>this._watchLayerProperties(this.layer)),o.initial),o.watch((()=>this.checkPublishStatusEnabled),(e=>this._updateChildrenPublishing(e)),o.initial),o.watch((()=>this.view),(e=>this._updateChildrenView(e)),o.initial),o.watch((()=>this.panel),(e=>this._setListItemOnPanel(e)),o.initial),o.watch((()=>[this.layer,this.view]),(()=>this._getLayerView()),o.initial)]),"function"==typeof this.listItemCreatedFunction){const e={item:this};this.listItemCreatedFunction.call(null,e)}}destroy(){this.view=null}get connectionStatus(){const{layerView:e,publishing:t}=this;if(!t&&e&&"connectionStatus"in e)return e.connectionStatus}get error(){return this.layer?.loadError}get incompatible(){const{layerView:e}=this;return!(!e||!("spatialReferenceSupported"in e))&&!e.spatialReferenceSupported}castPanel(e){return this.panel?.open&&!e.hasOwnProperty("open")&&(e.open=!0),e?new _(e):null}get title(){const e=c.get(this,"layer.layer");return(!e||e&&c.get(this,"layer.layer.loaded"))&&c.get(this,"layer.title")||c.get(this,"layer.attributes.title")||""}set title(e){this._override("title",e)}get publishing(){const{layer:e,checkPublishStatusEnabled:t}=this;return t&&e&&"publishingInfo"in e&&"publishing"===e.publishingInfo?.status}get updating(){const{layerView:e,connectionStatus:t,layer:i,publishing:r}=this;return!r&&!t&&(e?e.updating:"loading"===i?.loadStatus||!1)}get visible(){return this.layer?.visible}set visible(e){const t=this.layer;t&&(t.visible=e)}get visibleAtCurrentScale(){return!b.isLayerOutsideScaleRange(this.layer,this.view?.scale)}get visibilityMode(){return b.findLayerVisibilityMode(this.layer)}clone(){return new v({actionsSections:this.actionsSections.clone(),actionsOpen:this.actionsOpen,checkPublishStatusEnabled:this.checkPublishStatusEnabled,children:this.children.clone(),childrenSortable:this.childrenSortable,hidden:this.hidden,layer:this.layer,listItemCreatedFunction:this.listItemCreatedFunction,open:this.open,panel:this.panel,parent:this.parent,sortable:this.sortable,title:this.title,view:this.view,visible:this.visible})}_setListItemOnPanel(e){e&&(e.listItem=this)}_updateChildrenPublishing(e){const t=this.children;t&&t.forEach((t=>t.checkPublishStatusEnabled=e))}_updateChildrenView(e){const t=this.children;t&&t.forEach((t=>t.view=e))}_addChildren(e){if(this.removeHandles(f),this.children.removeAll(),!e)return;e.forEach((t=>{this.addHandles(o.watch((()=>t.listMode),(()=>this._addChildren(e))),f)}));const t=e.filter((e=>b.findLayerListMode(e)!==m));this.children.addMany(this._makeChildren(t))}_watchSublayerChanges(e){e&&this.addHandles(e.on("change",(()=>{this._addChildren(e)})),S)}_initializeChildLayers(e){this._addChildren(e),this._watchSublayerChanges(e)}_makeChildren(e){return e.map((e=>b.canDisplayLayer(e)?new v({layer:e,checkPublishStatusEnabled:this.checkPublishStatusEnabled,listItemCreatedFunction:this.listItemCreatedFunction,parent:this,view:this.view}):null)).filter(i.isSome).reverse()}_watchLayerProperties(e){if(this.removeHandles(S),this.removeHandles(f),!e)return;if("hide-children"===b.findLayerListMode(e))return void this.children.removeAll();const t=b.getNormalizedChildLayerProperty(e);t&&this.addHandles(o.watch((()=>e[t]),(i=>{e.hasOwnProperty(t)&&this._initializeChildLayers(i)}),o.initial),S)}async _getLayerView(){const{layer:e,view:t}=this;if(e&&t)try{const i="subtype-sublayer"===e.type?e.parent:e,r=i&&await t.whenLayerView(i);if(r?.layer!==i)return;this._set("layerView",r)}catch{}}};e.__decorate([a.property({type:g})],L.prototype,"actionsSections",void 0),e.__decorate([a.property()],L.prototype,"actionsOpen",void 0),e.__decorate([a.property()],L.prototype,"checkPublishStatusEnabled",void 0),e.__decorate([a.property({type:r})],L.prototype,"children",void 0),e.__decorate([a.property()],L.prototype,"childrenSortable",void 0),e.__decorate([a.property({readOnly:!0})],L.prototype,"connectionStatus",null),e.__decorate([a.property({readOnly:!0})],L.prototype,"error",null),e.__decorate([a.property()],L.prototype,"hidden",void 0),e.__decorate([a.property({readOnly:!0})],L.prototype,"incompatible",null),e.__decorate([a.property()],L.prototype,"layer",void 0),e.__decorate([a.property({readOnly:!0})],L.prototype,"layerView",void 0),e.__decorate([a.property()],L.prototype,"listItemCreatedFunction",void 0),e.__decorate([a.property()],L.prototype,"open",void 0),e.__decorate([a.property({type:_})],L.prototype,"panel",void 0),e.__decorate([n.cast("panel")],L.prototype,"castPanel",null),e.__decorate([a.property()],L.prototype,"parent",void 0),e.__decorate([a.property()],L.prototype,"sortable",void 0),e.__decorate([a.property()],L.prototype,"title",null),e.__decorate([a.property({readOnly:!0})],L.prototype,"publishing",null),e.__decorate([a.property({readOnly:!0})],L.prototype,"updating",null),e.__decorate([a.property()],L.prototype,"view",void 0),e.__decorate([a.property()],L.prototype,"visible",null),e.__decorate([a.property({readOnly:!0})],L.prototype,"visibleAtCurrentScale",null),e.__decorate([a.property({readOnly:!0})],L.prototype,"visibilityMode",null),L=v=e.__decorate([p.subclass(C)],L);return L}));
