/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../core/Error","../../layers/support/arcgisLayerUrl","../../layers/support/fetchService","../../layers/support/LayerLoadContext","../../layers/support/layersCreator","../../layers/support/lazyLayerLoader","../Portal","./jsonContext","./loadUtils","./portalItemUtils","../../renderers/support/styleUtils","../../support/requestPresets"],(function(e,t,r,a,n,o,s,l,i,u,c,p,y){"use strict";async function d(e,t){const r=e.instance.portalItem;if(r?.id)return await r.load(t),f(e),e.validateItem&&e.validateItem(r),m(e,t)}function f(e){const r=e.instance.portalItem;if(!r?.type||!e.supportedTypes.includes(r.type))throw new t("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:r?.type,expectedType:e.supportedTypes.join(", ")})}async function m(e,t){const r=e.instance,a=r.portalItem;if(!a)return;const{url:o,title:s}=a,l=i.createForItemRead(a,"portal-item");if("group"===r.type)return h(r,l,e);o&&"media"!==r.type&&r.read({url:o},l);const u=new n.LayerLoadContext,c=await S(e,u,t);return c&&r.read(c,l),r.resourceReferences={portalItem:a,paths:l.readResourcePaths??[]},"subtype-group"!==r.type&&r.read({title:s},l),p.loadStyleRenderer(r,l)}async function h(e,r,a){const n=e.portalItem;if(!e.sourceIsPortalItem)return;const{title:o,type:s}=n;if("Group Layer"===s){if(!c.hasTypeKeyword(n,"Map"))throw new t("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return g(e)}return e.read({title:o},r),w(e,a)}async function g(e){const t=e.portalItem,r=await t.fetchData("json");if(!r)return;const a=i.createForItemRead(t,"web-map");e.read(r,a),await o.populateGroupLayer(e,r,{context:a}),e.resourceReferences={portalItem:t,paths:a.readResourcePaths??[]}}async function w(e,r){let a;const{portalItem:o}=e;if(!o)return;const s=o.type,l=r.layerModuleTypeMap;switch(s){case"Feature Service":case"Feature Collection":a=l.FeatureLayer;break;case"Stream Service":a=l.StreamLayer;break;case"Scene Service":a=l.SceneLayer;break;default:throw new t("portal:unsupported-item-type-as-group",`The item type '${s}' is not supported as a 'IGroupLayer'`)}const i=new n.LayerLoadContext;let[c,p]=await Promise.all([a(),S(r,i)]),y=()=>c;if("Feature Service"===s){const t=u.getFirstLayerOrTable(p)?.customParameters;p=o.url?await u.preprocessFSItemData(p,o.url,i):{};const r=u.getSubtypeGroupLayerIds(p),a=u.getOrientedImageryLayerIds(p),n=u.getCatalogLayerIds(p),s=[];if(r.length||a?.length){r.length&&s.push("SubtypeGroupLayer"),a?.length&&s.push("OrientedImageryLayer"),n?.length&&s.push("CatalogLayer");const e=[];for(const r of s){const t=l[r];e.push(t())}const t=await Promise.all(e),o=new Map;s.forEach(((e,r)=>{o.set(e,t[r])})),y=e=>e.layerType?o.get(e.layerType)??c:c}const d=await P(o.url,{customParameters:t,loadContext:i});return await I(e,y,p,d)}return"Scene Service"===s&&o.url&&(p=await u.populateSceneServiceItemData(o,p,i)),u.getNumLayersAndTables(p)>0?await I(e,y,p):await b(e,y)}async function b(e,t){const{portalItem:r}=e;if(!r?.url)return;const a=await y.fetchArcGISServiceJSON(r.url);a&&I(e,t,{layers:a.layers?.map(u.createSublayerData),tables:a.tables?.map(u.createSublayerData)})}async function I(e,t,r,a){let n=r.layers||[];const o=r.tables||[];if("Feature Collection"===e.portalItem?.type?(n.forEach(((e,t)=>{e.id=t,"Table"===e?.layerDefinition?.type&&o.push(e)})),n=n.filter((e=>"Table"!==e?.layerDefinition?.type))):(n.reverse(),o.reverse()),n.forEach((n=>{const o=a?.(n);if(o||!a){const a=L(e,t(n),r,n,o);e.add(a)}})),o.length){const t=await s.layerLookupMap.FeatureLayer();o.forEach((n=>{const o=a?.(n);if(o||!a){const a=L(e,t,r,n,o);e.tables.add(a)}}))}}function L(e,t,r,a,n){const o=e.portalItem,s={portalItem:o.clone(),layerId:a.id};null!=a.url&&(s.url=a.url);const i=new t(s);if("sourceJSON"in i&&(i.sourceJSON=n),"subtype-group"!==i.type&&"catalog"!==i.type&&(i.sublayerTitleMode="service-name"),"Feature Collection"===o.type){const e={origin:"portal-item",portal:o.portal||l.getDefault()};i.read(a,e);const t=r.showLegend;null!=t&&i.read({showLegend:t},e)}return i}async function S(e,t,r){if(!1===e.supportsData)return;const a=e.instance,n=a.portalItem;if(!n)return;let o=null;try{o=await n.fetchData("json",r)}catch(s){}if(F(a)){let e=null;const r=await T(n,o,t);if((o?.layers||o?.tables)&&r>0){if(null==a.layerId){const e=u.getSubtypeGroupLayerIds(o);a.layerId="subtype-group"===a.type?e?.[0]:u.getFirstLayerOrTableId(o)}e=v(o,a),e&&null!=o.showLegend&&(e.showLegend=o.showLegend)}return r>1&&"sublayerTitleMode"in a&&"service-name"!==a.sublayerTitleMode&&(a.sublayerTitleMode="item-title-and-service-name"),e}return o}async function T(e,t,a){if(t?.layers&&t?.tables)return u.getNumLayersAndTables(t);const n=r.parse(e.url);if(!n)return 1;const o=await a.fetchServiceMetadata(n.url.path,{customParameters:u.getFirstLayerOrTable(t)?.customParameters}).catch((()=>null));return(t?.layers?.length??o?.layers?.length??0)+(t?.tables?.length??o?.tables?.length??0)}function v(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&M(a,t)?a:null}function F(e){return"stream"!==e.type&&"layerId"in e}function M(e,t){return!("feature"===t.type&&"layerType"in e&&"SubtypeGroupLayer"===e.layerType||"subtype-group"===t.type&&!("layerType"in e))}async function P(e,t){const{layersJSON:r}=await a.fetchFeatureService(e,t);if(!r)return null;const n=[...r.layers,...r.tables];return e=>n.find((t=>t.id===e.id))}e.load=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
