/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../core/Logger","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../spatialReferenceEllipsoidUtils","../../projection/computeTranslationToOriginAndRotation","../../projection/projectBuffer","../spatialReferenceUtils","../webMercatorUtils","../buffer/BufferView","../../../chunks/vec3"],(function(r,e,t,o,f,n,a,i,c,u,m,l,s,P){"use strict";const p=()=>e.getLogger("esri.geometry.support.meshUtils.normalProjection");function V(r,e,t,o,f){return A(o)?(M(h.TO_PCPF,s.BufferViewVec3f.fromTypedArray(r),s.BufferViewVec3f64.fromTypedArray(e),s.BufferViewVec3f64.fromTypedArray(t),o,s.BufferViewVec3f.fromTypedArray(f)),f):(p().error("Cannot convert spatial reference to PCPF"),f)}function y(r,e,t,o,f){return A(o)?(M(h.FROM_PCPF,s.BufferViewVec3f.fromTypedArray(r),s.BufferViewVec3f64.fromTypedArray(e),s.BufferViewVec3f64.fromTypedArray(t),o,s.BufferViewVec3f.fromTypedArray(f)),f):(p().error("Cannot convert to spatial reference from PCPF"),f)}function T(r,e,t){return u.projectBuffer(r,e,0,t,i.getSphericalPCPF(e),0,r.length/3),t}function F(r,e,t){return u.projectBuffer(r,i.getSphericalPCPF(t),0,e,t,0,r.length/3),e}function g(r,e,o){return t.normalFromMat4(E,o),P.transformMat3(e,r,E),t.isOrthoNormal(E)||P.normalize(e,e),e}function C(r,e,o){if(t.normalFromMat4(E,o),P.transformMat3(e,r,E,4),t.isOrthoNormal(E)||P.normalize(e,e,4),r!==e)for(let t=3;t<r.length;t+=4)e[t]=r[t];return e}function d(r,e,t,o,f){if(!A(o))return p().error("Cannot convert spatial reference to PCPF"),f;M(h.TO_PCPF,s.BufferViewVec3f.fromTypedArray(r,4*Float32Array.BYTES_PER_ELEMENT),s.BufferViewVec3f64.fromTypedArray(e),s.BufferViewVec3f64.fromTypedArray(t),o,s.BufferViewVec3f.fromTypedArray(f,4*Float32Array.BYTES_PER_ELEMENT));for(let n=3;n<r.length;n+=4)f[n]=r[n];return f}function B(r,e,t,o,f){if(!A(o))return p().error("Cannot convert to spatial reference from PCPF"),f;M(h.FROM_PCPF,s.BufferViewVec3f.fromTypedArray(r,16),s.BufferViewVec3f64.fromTypedArray(e),s.BufferViewVec3f64.fromTypedArray(t),o,s.BufferViewVec3f.fromTypedArray(f,16));for(let n=3;n<r.length;n+=4)f[n]=r[n];return f}function M(r,e,o,f,a,u){if(!e)return;const m=o.count,s=i.getSphericalPCPF(a);if(w(a))for(let i=0;i<m;i++)f.getVec(i,_),e.getVec(i,j),c.computeTranslationToOriginAndRotation(s,_,R,s),t.fromMat4(E,R),r===h.FROM_PCPF&&t.transpose(E,E),n.transformMat3(j,j,E),u.setVec(i,j);else for(let i=0;i<m;i++){f.getVec(i,_),e.getVec(i,j),c.computeTranslationToOriginAndRotation(s,_,R,s),t.fromMat4(E,R);const a=l.y2lat(o.get(i,1));let m=Math.cos(a);r===h.TO_PCPF&&(m=1/m),E[0]*=m,E[1]*=m,E[2]*=m,E[3]*=m,E[4]*=m,E[5]*=m,r===h.FROM_PCPF&&t.transpose(E,E),n.transformMat3(j,j,E),n.normalize(j,j),u.setVec(i,j)}return u}function A(r){return w(r)||O(r)}function w(r){return r.isWGS84||m.isCGCS2000(r)||m.isMars(r)||m.isMoon(r)}function O(r){return r.isWebMercator}var h;!function(r){r[r.TO_PCPF=0]="TO_PCPF",r[r.FROM_PCPF=1]="FROM_PCPF"}(h||(h={}));const _=a.create(),j=a.create(),R=f.create(),E=o.create();r.projectFromPCPF=F,r.projectNormalFromPCPF=y,r.projectNormalToPCPF=V,r.projectTangentFromPCPF=B,r.projectTangentToPCPF=d,r.projectToPCPF=T,r.transformNormal=g,r.transformTangent=C,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));
