/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../core/unitUtils","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/libs/gl-matrix-2/math/mat3","../../projection","../../spatialReferenceEllipsoidUtils","../../projection/computeTranslationToOriginAndRotation","../../projection/projectBuffer","../DoubleArray","../MeshTransform","../meshVertexSpaceUtils","../../../chunks/vec3","./geographicUtils","./projection"],(function(e,t,n,r,o,a,i,l,c,s,u,f,p,g,m,h,y,x){"use strict";function T(e,t,n){return y.isGlobal(t.spatialReference,n?.geographic)?w(e,t,!1,n):b(e,t,n)}function F(e,t=o.IDENTITY){const{position:n,normal:r,tangent:a}=e;return{position:h.transformMat4(new Float64Array(n.length),n,t),normal:null!=r?x.transformNormal(r,new Float32Array(r.length),t):null,tangent:null!=a?x.transformTangent(a,new Float32Array(a.length),t):null}}function A(e,t,n,r){const{position:o,normal:a,tangent:i}=e;if(!m.isRelativeVertexSpace(t))return{position:o,normal:a,tangent:i};const l=m.vertexSpaceOriginToPoint(t,r);return T(F(e,n?.localMatrix),l,{geographic:"local"===t.type})}function P(e,t,n){const r=m.selectVertexSpace(t,n),o=t.spatialReference,a=m.isRelativeVertexSpace(r);if(!a)return{vertexAttributes:T(e,t,n),vertexSpace:r,transform:null};const{position:i,normal:l,tangent:c}=e,s=y.usesLocalTangentPlaneOnECEF(r,o);switch(r.type){case"georeferenced":return s?{vertexAttributes:w(e,t,a,n),vertexSpace:r,transform:null}:{vertexAttributes:{position:i,normal:l,tangent:c},vertexSpace:r,transform:new g};case"local":return{vertexAttributes:{position:i,normal:l,tangent:c},vertexSpace:r,transform:new g}}}function R(e,t,n){return y.isGlobal(t.spatialReference,n?.geographic)?C(e,t,n):d(e,t,n)}function S(e,t,n,r,o){if(!m.isRelativeVertexSpace(t))return R(e,r,o);const{spatialReference:a}=r,i=A(e,t,n,a);return r.equals(m.vertexSpaceOriginToPoint(t,a))?d(i,r,o):R(i,r,o)}function v({positions:e,transform:t,vertexSpace:n,inSpatialReference:l,outSpatialReference:g,outPositions:m,localMode:y}){const x=n.origin??i.ZEROS,T=null!=n.origin?t?.localMatrix??o.IDENTITY:o.IDENTITY;if("georeferenced"===n.type){const t=m??p.newDoubleArray(e.length);if(r.equals(T,o.IDENTITY)?p.copyInto(t,e):h.transformMat4(t,e,T),!a.exactEquals(x,i.ZEROS)){const[e,n,r]=x;for(let o=0;o<t.length;o+=3)t[o]+=e,t[o+1]+=n,t[o+2]+=r}return f.projectBuffer(t,l,0,t,g,0,t.length/3),t}let F=l;const A=s.getSphericalPCPF(l);F=g.isWebMercator&&y||!c.canProjectWithoutEngine(l,A)?F:A,u.computeTranslationToOriginAndRotation(l,x,B,F),r.multiply(B,B,T);const P=m??p.newDoubleArray(e.length);return h.transformMat4(P,e,B),f.projectBuffer(P,F,0,P,g,0,P.length/3),P}function b(e,t,n){const r=new Float64Array(e.position.length),o=e.position,a=t.x,i=t.y,l=t.z??0,c=U(n?n.unit:null,t.spatialReference);for(let s=0;s<o.length;s+=3)r[s]=o[s]*c+a,r[s+1]=o[s+1]*c+i,r[s+2]=o[s+2]*c+l;return{position:r,normal:e.normal,tangent:e.tangent}}function w(e,t,n,r){const o=t.spatialReference,a=I(t,r,B),i=new Float64Array(e.position.length),c=M(e.position,a,o,i),s=l.normalFromMat4(z,a),u=j(c,i,e.normal,s,o),f=E(c,i,e.tangent,s,o);if(n){const{x:e,y:n,z:r}=t;h.translate(c,c,[-e,-n,-(r??0)])}return{position:c,normal:u,tangent:f}}function M(e,t,n,r){h.transformMat4(r,e,t);const o=new Float64Array(e.length);return x.projectFromPCPF(r,o,n)}function j(e,t,n,r,o){if(null==n)return null;const a=new Float32Array(n.length);return h.transformMat3(a,n,r),x.projectNormalFromPCPF(a,e,t,o,a),a}function E(e,t,n,r,o){if(null==n)return null;const a=new Float32Array(n.length);h.transformMat3(a,n,r,4);for(let i=3;i<a.length;i+=4)a[i]=n[i];return x.projectTangentFromPCPF(a,e,t,o,a),a}function d(e,t,n){const r=new Float64Array(e.position.length),o=e.position,a=t.x,i=t.y,l=t.z??0,c=U(n?n.unit:null,t.spatialReference);for(let s=0;s<o.length;s+=3)r[s]=(o[s]-a)/c,r[s+1]=(o[s+1]-i)/c,r[s+2]=(o[s+2]-l)/c;return{position:r,normal:e.normal,tangent:e.tangent}}function C(e,t,n){const o=t.spatialReference;I(t,n,B);const a=r.invert(V,B),i=new Float64Array(e.position.length),c=O(e.position,o,a,i),s=l.normalFromMat4(z,a);return{position:c,normal:D(e.normal,e.position,i,o,s),tangent:N(e.tangent,e.position,i,o,s)}}function I(e,t,n){u.computeTranslationToOriginAndRotation(e.spatialReference,[e.x,e.y,e.z??0],n,s.getSphericalPCPF(e.spatialReference));const o=U(t?t.unit:null,e.spatialReference);return r.scale(n,n,[o,o,o]),n}function O(e,t,n,r){const o=x.projectToPCPF(e,t,r),a=new Float64Array(o.length);return h.transformMat4(a,o,n),a}function D(e,t,n,r,o){if(null==e)return null;const a=x.projectNormalToPCPF(e,t,n,r,new Float32Array(e.length));return h.transformMat3(a,a,o),a}function N(e,t,n,r,o){if(null==e)return null;const a=x.projectTangentToPCPF(e,t,n,r,new Float32Array(e.length));return h.transformMat3(a,a,o,4),a}function U(e,n){if(null==e)return 1;const r=t.getMetersPerCartesianUnitForSR(n);return 1/t.convertUnit(r,"meters",e)}const B=o.create(),V=o.create(),z=n.create();e.applyTransform=F,e.georeference=T,e.georeferenceApplyTransform=A,e.georeferenceByTransform=P,e.georeferenceGlobal=w,e.getUnitScale=U,e.project=v,e.ungeoreference=R,e.ungeoreferenceByTransform=S,e.ungeoreferenceGlobal=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
