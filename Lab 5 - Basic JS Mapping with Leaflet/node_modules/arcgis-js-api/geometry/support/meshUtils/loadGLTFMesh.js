/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../Color","../../../request","../../../core/MapUtils","../../../core/mathUtils","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../MeshComponent","../MeshMaterialMetallicRoughness","../MeshTexture","../MeshTextureTransform","../MeshVertexAttributes","../buffer/BufferView","../../../chunks/vec3","../../../chunks/vec4","../buffer/utils","./georeference","../../../views/3d/glTF/DefaultLoadingContext","../../../views/3d/glTF/loader","../../../views/3d/glTF/internal/indexUtils","../../../views/3d/glTF/internal/resourceUtils","../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA","../../../views/webgl/enums","../../../chunks/vec33","../../../chunks/vec43","../../../chunks/vec2"],(function(e,t,r,n,o,l,a,s,i,u,c,f,m,g,d,p,x,w,T,V,h,v,M,b,B,y,C,A){"use strict";async function E(e,t,r){const n=new V.DefaultLoadingContext(F(r)),o=(await h.loadGLTF(n,t,r,!0)).model,l=o.lods.shift(),a=new Map,s=new Map;o.textures.forEach(((e,t)=>a.set(t,$(e)))),o.materials.forEach(((e,t)=>s.set(t,L(e,a))));const i=O(l);for(const g of i.parts)k(i,g,s);const{position:u,normal:c,tangent:f,color:m,texCoord0:d}=i.vertexAttributes,p={position:u.typedBuffer,normal:null!=c?c.typedBuffer:null,tangent:null!=f?f.typedBuffer:null,uv:null!=d?d.typedBuffer:null,color:null!=m?m.typedBuffer:null},x=T.georeferenceByTransform(p,e,r);return{transform:x.transform,vertexSpace:x.vertexSpace,components:i.components,spatialReference:e.spatialReference,vertexAttributes:new g.MeshVertexAttributes({position:x.vertexAttributes.position,normal:x.vertexAttributes.normal,tangent:x.vertexAttributes.tangent,color:p.color,uv:p.uv})}}function F(e){const t=e?.resolveFile;return t?{busy:!1,request:async(e,n,o)=>{const l=t?.(e)??e,a="image"===n?"image":"binary"===n?"array-buffer":"json";return(await r(l,{responseType:a,signal:null!=o?o.signal:null})).data}}:null}function R(e,t){if(null==e)return"-";const r=e.typedBuffer;return`${n.getOrCreateMapValue(t,r.buffer,(()=>t.size))}/${r.byteOffset}/${r.byteLength}`}function S(e){return null!=e?e.toString():"-"}function O(e){let t=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1},o=new Map,l=new Map,a=[];for(const s of e.parts){const{attributes:{position:e,normal:i,color:u,tangent:c,texCoord0:f}}=s,m=`\n      ${R(e,o)}/\n      ${R(i,o)}/\n      ${R(u,o)}/\n      ${R(c,o)}/\n      ${R(f,o)}/\n      ${S(s.transform)}\n    `;let g=!1;const d=n.getOrCreateMapValue(l,m,(()=>(g=!0,{start:t,length:e.count})));g&&(t+=e.count),i&&(r.normal=!0),u&&(r.color=!0),c&&(r.tangent=!0),f&&(r.texCoord0=!0),a.push({gltf:s,writeVertices:g,region:d})}return{vertexAttributes:{position:w.createBuffer(d.BufferViewVec3f64,t),normal:r.normal?w.createBuffer(d.BufferViewVec3f,t):null,tangent:r.tangent?w.createBuffer(d.BufferViewVec4f,t):null,color:r.color?w.createBuffer(d.BufferViewVec4u8,t):null,texCoord0:r.texCoord0?w.createBuffer(d.BufferViewVec2f,t):null},parts:a,components:[]}}function $(e){return new f({data:(M.isEncodedMeshTexture(e.data),e.data),wrap:U(e.parameters.wrap)})}function L(e,r){const n=new t(I(e.color,e.opacity)),l=e.emissiveFactor?new t(_(e.emissiveFactor)):null,a=e=>e?new m({scale:e.scale?[e.scale[0],e.scale[1]]:[1,1],rotation:o.rad2deg(e.rotation??0),offset:e.offset?[e.offset[0],e.offset[1]]:[0,0]}):null;return new c({color:n,colorTexture:r.get(e.textureColor),normalTexture:r.get(e.textureNormal),emissiveColor:l,emissiveTexture:r.get(e.textureEmissive),occlusionTexture:r.get(e.textureOcclusion),alphaMode:P(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:r.get(e.textureMetallicRoughness),colorTextureTransform:a(e.colorTextureTransform),normalTextureTransform:a(e.normalTextureTransform),occlusionTextureTransform:a(e.occlusionTextureTransform),emissiveTextureTransform:a(e.emissiveTextureTransform),metallicRoughnessTextureTransform:a(e.metallicRoughnessTextureTransform)})}function k(e,t,r){t.writeVertices&&D(e,t);const{indices:n,attributes:o,primitiveType:l,material:a}=t.gltf;let s=v.convertPrimitiveToTriangles(n||o.position.count,l);const i=t.region.start;if(i){const e=new Uint32Array(s);for(let t=0;t<s.length;t++)e[t]+=i;s=e}e.components.push(new u({name:t.gltf.name,faces:s,material:r.get(a),shading:o.normal?"source":"flat",trustSourceNormals:!0}))}function D(e,t){const{position:r,normal:n,tangent:s,color:i,texCoord0:u}=e.vertexAttributes,c=t.region.start,{attributes:f,transform:m}=t.gltf,g=f.position.count;if(p.transformMat4View(r.slice(c,g),f.position,m),null!=f.normal&&null!=n){const e=l.normalFromMat4(a.create(),m),t=n.slice(c,g);p.transformMat3View(t,f.normal,e),o.hasScaling(e)&&p.normalizeView(t,t)}else null!=n&&y.fill(n,0,0,1,{dstIndex:c,count:g});if(null!=f.tangent&&null!=s){const e=l.normalFromMat4(a.create(),m),t=s.slice(c,g);x.transformMat3View(t,f.tangent,e),o.hasScaling(e)&&x.normalize(t,t)}else null!=s&&C.fill(s,0,0,1,1,{dstIndex:c,count:g});if(null!=f.texCoord0&&null!=u?A.normalizeIntegerBufferView(u.slice(c,g),f.texCoord0):null!=u&&A.fill(u,0,0,{dstIndex:c,count:g}),null!=f.color&&null!=i){const e=f.color,t=i.slice(c,g);if(4===e.elementCount)e instanceof d.BufferViewVec4f?x.scaleView(t,e,255):e instanceof d.BufferViewVec4u8?C.copyView(t,e):e instanceof d.BufferViewVec4u16&&x.scaleView(t,e,1/256);else{C.fill(t,255,255,255,255);const r=d.BufferViewVec3u8.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof d.BufferViewVec3f?p.scaleView(r,e,255):e instanceof d.BufferViewVec3u8?y.copyView(r,e):e instanceof d.BufferViewVec3u16&&p.scaleView(r,e,1/256)}}else null!=i&&C.fill(i.slice(c,g),255,255,255,255)}function P(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function U(e){return{horizontal:z(e.s),vertical:z(e.t)}}function z(e){switch(e){case B.TextureWrapMode.CLAMP_TO_EDGE:return"clamp";case B.TextureWrapMode.MIRRORED_REPEAT:return"mirror";case B.TextureWrapMode.REPEAT:return"repeat"}}function G(e){return e**(1/b.colorGamma)*255}function I(e,t){return i.fromValues(G(e[0]),G(e[1]),G(e[2]),t)}function _(e){return s.fromValues(G(e[0]),G(e[1]),G(e[2]))}e.loadGLTFMesh=E,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
