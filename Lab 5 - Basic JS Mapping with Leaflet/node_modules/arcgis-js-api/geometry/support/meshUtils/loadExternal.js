/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","exports","../../../core/Error","../../../core/promiseUtils","../../../core/urlUtils","../../Point"],(function(e,t,r,s,n,o){"use strict";async function i(t,r,n){const{source:i}=r,{loadGLTFMesh:c}=await s.whenOrAbort(new Promise(((t,r)=>e(["./loadGLTFMesh"],t,r))),n),u=await a(i,n);s.throwIfAborted(n);const f=c(new o({x:0,y:0,z:0,spatialReference:t.spatialReference}),u.url,{resolveFile:l(u),signal:n?.signal,expectedType:u.type});f.then((()=>u.dispose()),(()=>u.dispose()));const{vertexAttributes:m,components:p}=await f;t.vertexAttributes=m,t.components=p}function l(e){const t=n.removeFile(e.url);return r=>{const s=n.makeRelative(r,t,t),o=s?s.replace(/^ *\.\//,""):null;return(o?e.files.get(o):null)??r}}async function a(e,t){if(Array.isArray(e)){if(!e.length)throw new r("mesh-load-external:missing-assets","There must be at least one file to load");return e[0]instanceof File?f(e):m(e,t)}return u(e)}async function c(e,t){const{parts:r,assetMimeType:n,assetName:o}=e;if(1===r.length)return new y(r[0].partUrl);const i=await e.toBlob(t);return s.throwIfAborted(t),y.fromBlob(i,g(o,n))}function u(e){return y.fromBlob(e,g(e.name,e.type))}function f(e){return b(e.map((e=>({name:e.name,mimeType:e.type,source:u(e)}))))}async function m(e,t){const r=await s.allSettledValues(e.map((async e=>{const r=await c(e);return s.throwIfAborted(t),{name:e.assetName,mimeType:e.assetMimeType,source:r}})));if(s.isAborted(t))throw r.forEach((e=>e.source.dispose())),s.createAbortError();return b(r)}const p=/^model\/gltf\+json$/,d=/^model\/gltf-binary$/,h=/\.gltf$/i,w=/\.glb$/i;function b(e){const t=new Map;let s,n=null;for(const{name:r,mimeType:o,source:i}of e)null===n&&(p.test(o)||h.test(r)?(n=i.url,s="gltf"):(d.test(o)||w.test(r))&&(n=i.url,s="glb")),t.set(r,i.url),i.files.forEach(((e,r)=>t.set(r,e)));if(null==n)throw new r("mesh-load-external:missing-files","Missing files to load external mesh source");return new y(n,(()=>e.forEach((({source:e})=>e.dispose()))),t,s)}class y{constructor(e,t=(()=>{}),r=new Map,s){this.url=e,this.dispose=t,this.files=r,this.type=s}static fromBlob(e,t){const r=URL.createObjectURL(e);return new y(r,(()=>URL.revokeObjectURL(r)),void 0,t)}}function g(e,t){return p.test(t)||h.test(e)?"gltf":d.test(t)||h.test(e)?"glb":void 0}t.loadExternal=i,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
