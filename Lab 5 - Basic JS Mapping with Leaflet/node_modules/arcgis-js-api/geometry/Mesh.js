/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","../chunks/tslib.es6","../core/deprecate","../core/Error","../core/Loadable","../core/Logger","../core/Promise","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/subclass","../core/libs/gl-matrix-2/factories/vec3f64","./Extent","./Geometry","./Point","./Polygon","./support/axisAngleDegrees","./support/MeshComponent","./support/meshErrors","./support/MeshGeoreferencedVertexSpace","./support/MeshLocalVertexSpace","./support/MeshTransform","./support/MeshVertexAttributes","./support/meshVertexSpaceUtils","./support/triangulationUtils","./support/meshUtils/bounds","./support/meshUtils/centerAt","./support/meshUtils/loadExternal","./support/meshUtils/Metadata","./support/meshUtils/primitives","./support/meshUtils/rotate","./support/meshUtils/scale"],(function(e,t,r,o,n,s,a,i,c,p,l,h,u,d,m,f,x,y,v,g,S,w,_,M,b,A,F,L,U,P,R,E,V,C){"use strict";var z;const G="esri.geometry.Mesh";function B(){return s.getLogger(G)}const T={base:null,key:"type",defaultKeyValue:"georeferenced",typeMap:{georeferenced:w,local:_}};let O=z=class extends(n.LoadableMixin(a.EsriPromiseMixin(f))){constructor(e){super(e),this.components=null,this.vertexSpace=new w,this.transform=null,this.metadata=new R.Metadata,this.hasZ=!0,this.hasM=!1,this.vertexAttributes=new b.MeshVertexAttributes,this.type="mesh"}initialize(){(0===this.metadata.externalSources.length||this.vertexAttributes.position.length)&&(this.loadStatus="loaded"),this.when((()=>{this.addHandles(c.watch((()=>({vertexAttributes:this.vertexAttributes,components:this.components?.map((e=>e.clone()))})),(()=>this._clearSources()),{once:!0,sync:!0}))}))}get hasExtent(){return this.loaded?this.vertexAttributes.position.length>0&&(!this.components||this.components.length>0):null!=this.metadata.displaySource?.extent}get _transformedExtent(){const{components:e,spatialReference:t,vertexAttributes:r,vertexSpace:o}=this,n=r.position;if(0===n.length||e&&0===e.length)return new m({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:t});if(A.isRelativeVertexSpace(o)){const{_untransformedBounds:e,transform:r}=this;return L.getExtentFromBounds(e,r,o,t)}return L.getExtentFromPositions(n,t)}get _untransformedBounds(){return L.getBoundsFromPositions(this.vertexAttributes.position)}get anchor(){const e=A.vertexSpaceOriginToPoint(this.vertexSpace,this.spatialReference);if(null!=e)return e;const{center:t,zmin:r}=this._transformedExtent;return new x({x:t.x,y:t.y,z:r,spatialReference:this.spatialReference})}get origin(){const e=A.vertexSpaceOriginToPoint(this.vertexSpace,this.spatialReference);return null!=e?e:this._transformedExtent.center}get extent(){return this.loaded||null==this.metadata?.displaySource?.extent?this._transformedExtent:this.metadata.displaySource.extent.clone()}addComponent(e){this._checkIfLoaded("addComponent()")&&(this.components||(this.components=[]),this.components.push(g.from(e)),this.notifyChange("components"))}removeComponent(e){if(this._checkIfLoaded("removeComponent()")){if(this.components){const t=this.components.indexOf(e);if(-1!==t)return this.components.splice(t,1),void this.notifyChange("components")}B().error("removeComponent()",S.componentNotFoundMessage)}}rotate(e,t,r,o){return v.composeAxes(e,t,r,I),V.rotate(this,I,o),this}offset(e,t,r){if(!this._checkIfLoaded("offset()"))return this;const{vertexSpace:o,vertexAttributes:n}=this,s=n?.position;if(!s)return this;if(A.isRelativeVertexSpace(o)){const[n,s,a]=o.origin;o.origin=d.fromValues(n+e,s+t,a+r)}else{for(let o=0;o<s.length;o+=3)s[o]+=e,s[o+1]+=t,s[o+2]+=r;this.vertexAttributesChanged()}return this}scale(e,t){return this._checkIfLoaded("scale()")?(C.scale(this,e,t),this):this}centerAt(e,t){return this._checkIfLoaded("centerAt()")?(U.centerAt(this,e,t),this):this}load(e){const{metadata:{displaySource:t}}=this;return t&&this.addResolvingPromise(P.loadExternal(this,t,e)),Promise.resolve(this)}addExternalSources(e){this.metadata.externalSources.addMany(e)}updateDisplaySource(e){this.metadata.displaySource=e}clone(){return this.cloneWithVertexSpace(this.vertexSpace.clone())}cloneWithVertexSpace(e){let t=null;if(this.components){const e=new Map,r=new Map;t=this.components.map((t=>t.cloneWithDeduplication(e,r)))}const r={components:t,spatialReference:this.spatialReference,vertexAttributes:this.vertexAttributes.clone(),vertexSpace:e,transform:this.transform?.clone()??null,metadata:this.metadata.clone()};return new z(r)}cloneShallow(){return new z({components:this.components,spatialReference:this.spatialReference,vertexAttributes:this.vertexAttributes,vertexSpace:this.vertexSpace.clone(),transform:this.transform,metadata:this.metadata})}vertexAttributesChanged(){this.notifyChange("vertexAttributes")}async toBinaryGLTF(t){const r=new Promise(((t,r)=>e(["./support/meshUtils/exporters/gltf/gltfexport"],t,r))),o=this.load(),n=await Promise.all([r,o]),{toBinaryGLTF:s}=n[0];return s(this,t)}get memoryUsage(){let e=0;if(e+=this.vertexAttributes.memoryUsage,null!=this.components)for(const t of this.components)e+=t.memoryUsage;return e}_clearSources(){this.metadata.clearSources()}_checkIfLoaded(e){return!!this.loaded||(B().error(e,S.meshNotLoadedMessage),!1)}static createBox(e,t){if(!(e instanceof x))return B().error(".createBox()",S.invalidLocationMessage),null;const r=new z(E.convertUnitGeometry(E.createUnitSizeBox(),e,t));return t?.imageFace&&"all"!==t.imageFace?E.extractSingleFaceOfBox(r,t.imageFace):r}static createSphere(e,t){return e instanceof x?new z(E.convertUnitGeometry(E.createUnitSizeSphere(t?.densificationFactor||0),e,t)):(B().error(".createSphere()",S.invalidLocationMessage),null)}static createCylinder(e,t){return e instanceof x?new z(E.convertUnitGeometry(E.createUnitSizeCylinder(t?.densificationFactor||0),e,t)):(B().error(".createCylinder()",S.invalidLocationMessage),null)}static createPlane(e,t){if(!(e instanceof x))return B().error(".createPlane()",S.invalidLocationMessage),null;const r=t?.facing??"up",o=E.convertPlaneSizeParameter(r,t?.size);return new z(E.convertUnitGeometry(E.createUnitSizePlane(r),e,{...t,size:o}))}static createFromPolygon(e,t){if(!(e instanceof y))return B().error(".createFromPolygon()",S.invalidPolygonMessage),null;const r=F.triangulate(e);return new z({vertexAttributes:new b.MeshVertexAttributes({position:r.position}),components:[new g({faces:r.faces,shading:"flat",material:t?.material??null})],spatialReference:e.spatialReference,vertexSpace:new w})}static async createFromGLTF(t,r,o){if(!(t instanceof x)){const e=new S.InvalidLocationError;throw B().error(".createfromGLTF()",e.message),e}const{loadGLTFMesh:n}=await i.whenOrAbort(new Promise(((t,r)=>e(["./support/meshUtils/loadGLTFMesh"],t,r))),o);return new z(await n(t,r,o))}static async createFromFiles(e,t,n){r.deprecatedFunction(B(),"`Mesh.createFromFiles` is deprecated in favor of 'SceneLayer.convertMesh'",{replacement:"SceneLayer.convertMesh",version:"4.29"});const s=e=>B().error(".createFromFiles()",e.message);if(!(e instanceof x)){const e=new S.InvalidLocationError;throw s(e),e}if(!n?.layer)throw new o("invalid:no-layer","SceneLayer required for file to mesh conversion.");return n.layer.convertMesh(t,{location:e,...n})}static createWithExternalSource(e,t,r){const o=r?.extent??null,{x:n,y:s,z:a,spatialReference:i}=e,c=r?.transform?.clone()??new M,p=d.fromValues(n,s,a??0),l=A.createVertexSpace(r?.vertexSpace??A.preferredVertexSpaceTypeForSR(i),p),h={source:t,extent:o},u=new R.Metadata;return u.externalSources.push(h),new z({metadata:u,transform:c,vertexSpace:l,spatialReference:i})}static createIncomplete(e,t){const{x:r,y:n,z:s,spatialReference:a}=e,i=t?.transform?.clone()??new M,c=d.fromValues(r,n,s??0),p=A.createVertexSpace(t?.vertexSpace??A.preferredVertexSpaceTypeForSR(a),c),l=new z({transform:i,vertexSpace:p,spatialReference:a});return l.addResolvingPromise(Promise.reject(new o("mesh-incomplete","Mesh resources are not complete"))),l}};t.__decorate([p.property({type:[g],json:{write:!0}})],O.prototype,"components",void 0),t.__decorate([p.property({nonNullable:!0,types:T,constructOnly:!0,json:{write:!0}})],O.prototype,"vertexSpace",void 0),t.__decorate([p.property({type:M,json:{write:!0}})],O.prototype,"transform",void 0),t.__decorate([p.property({constructOnly:!0})],O.prototype,"metadata",void 0),t.__decorate([p.property()],O.prototype,"hasExtent",null),t.__decorate([p.property()],O.prototype,"_transformedExtent",null),t.__decorate([p.property()],O.prototype,"_untransformedBounds",null),t.__decorate([p.property()],O.prototype,"anchor",null),t.__decorate([p.property()],O.prototype,"origin",null),t.__decorate([p.property({readOnly:!0,json:{read:!1}})],O.prototype,"extent",null),t.__decorate([p.property({readOnly:!0,json:{read:!1,write:!0,default:!0}})],O.prototype,"hasZ",void 0),t.__decorate([p.property({readOnly:!0,json:{read:!1,write:!0,default:!1}})],O.prototype,"hasM",void 0),t.__decorate([p.property({type:b.MeshVertexAttributes,nonNullable:!0,json:{write:!0}})],O.prototype,"vertexAttributes",void 0),O=z=t.__decorate([u.subclass(G)],O);const I=v.create();return O}));
