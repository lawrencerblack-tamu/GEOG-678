/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../core/Cyclical","../core/mathUtils","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../geometry/ellipsoidUtils","../geometry/Extent","../geometry/SpatialReference","../geometry/support/webMercatorUtils","../views/3d/support/cameraUtilsInternal","../views/3d/support/earthUtils"],(function(e,t,a,i,n,o,r,c,s,l,d,h,g){"use strict";const u=r.fromValues(0,0,1),y=o.normalize(r.create(),r.fromValues(1,1,1)),f=new t.Cyclical(-180,180),m=n.create(),p=r.create(),M=r.create();function T(e,t,n,r=h.createDirectionUp()){o.cross(p,e,u),0===o.dot(p,p)&&o.cross(p,e,y),i.fromRotation(m,-a.deg2rad(t),e),i.rotate(m,m,-a.deg2rad(n),p);const{up:c,direction:s}=r;return o.cross(c,p,e),o.normalize(c,c),o.transformMat4(c,c,m),o.normalize(s,e),o.negate(s,s),o.transformMat4(s,s,m),r}function b(e,t,a,i){const n=p,r=M;return o.normalize(n,e),o.cross(M,n,u),0===o.dot(M,M)&&o.cross(M,n,y),o.cross(r,M,n),h.directionToHeadingTilt(t,a,i,n,r)}function x(e,t,i,n){const c={eye:r.create(),up:null,tilt:n,heading:i},s=p;s[0]=e[0],s[1]=e[2],s[2]=-e[1];const l=t,d=a.deg2rad(i),h=a.deg2rad(n),g=Math.sin(d),u=Math.cos(d),y=Math.sin(h),f=Math.cos(h),m=o.length(s);let M;if(Math.abs(h)<1e-8)M=l+m;else{const e=m/y,t=a.asinClamped(l/e),i=Math.PI-h-t;M=e*Math.sin(i)}const T=f*l,b=l*l*(y*y),x=u*u*b,C=M-T,I=C*C,P=x*(x+I-s[1]*s[1]);if(P<0)return o.scale(c.eye,s,M/m),c.tilt=0,U(c,e);const z=Math.sqrt(P),E=s[1]*C,v=x+I;let w;if(w=u>0?-z+E:z+E,Math.abs(v)<1e-8)return m<1e-8?(c.eye[0]=0,c.eye[1]=0,c.eye[2]=l):o.scale(c.eye,s,M/m),c.tilt=0,R(c.eye),U(c,e);c.eye[1]=w/v;const D=g*g*b,H=y*l,S=u*H*c.eye[1],W=c.eye[1]*c.eye[1],k=1-W,q=Math.sqrt(k),A=x*W+D-2*S*q*C+k*I;return Math.abs(A)<1e-8?(o.scale(c.eye,s,M/m),c.tilt=0,R(c.eye),U(c,e)):(c.eye[0]=(k*(M*s[0]-T*s[0])-H*q*(s[0]*c.eye[1]*u+s[2]*g))/A,c.eye[2]=(k*(M*s[2]-T*s[2])-H*q*(s[2]*c.eye[1]*u-s[0]*g))/A,o.scale(c.eye,c.eye,M),R(c.eye),U(c,e))}function R(e){const t=e[1];e[1]=-e[2],e[2]=t}function U(e,t){const a=T(t,e.heading,e.tilt);return e.up=a.up,e}function C(e,t,i){const n=o.length(t),r=Math.sqrt(i*i+n*n-2*i*n*Math.cos(Math.PI-e)),c=a.asinClamped(i/(r/Math.sin(e)));return a.rad2deg(e-c)}function I(e,t,i){const n=a.deg2rad(e),r=o.length(t);return a.asinClamped(i/(r/Math.sin(n)))+n}function P(e,i,n,o,r){let h,u,y,m;const p=i.latitude,M=c.getReferenceEllipsoid(e.spatialReference).radius,T=i.longitude,b=g.getLonDeltaForDistance(p,n,M)/2;h=T-b,u=T+b;const x=a.deg2rad(p),R=(1+Math.sin(x))/(1-Math.sin(x)),U=(R+1)*Math.tan(o/M/2),C=U*U;function I(e){const a=Math.PI/2;return(e=t.cyclical2PI.normalize(e,-a))>a&&(e=Math.PI-e),e}if(y=1.5*Math.PI-2*Math.atan(.5*(U+Math.sqrt(4*R+C))),m=y+o/M,y=I(y),m=I(m),m<y){const e=m;m=y,y=e}if(y=Math.max(a.rad2deg(y),-90),m=Math.min(a.rad2deg(m),90),u=f.monotonic(h,u),u-h>180){const e=(u-h-180)/2;h+=e,u-=e}const P=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:l.WGS84;return r?(r.xmin=h,r.ymin=y,r.xmax=u,r.ymax=m,r.spatialReference=P):r=new s(h,y,u,m,P),e.spatialReference&&e.spatialReference.isWebMercator&&d.geographicToWebMercator(r,!1,r),r}const z=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:b,eyeForCenterWithHeadingTilt:x,eyeTiltToLookAtTilt:I,headingTiltToDirectionUp:T,lookAtTiltToEyeTilt:C,toExtent:P},Symbol.toStringTag,{value:"Module"}));e.cameraUtilsSpherical=z,e.directionToHeadingTilt=b,e.eyeForCenterWithHeadingTilt=x,e.eyeTiltToLookAtTilt=I,e.headingTiltToDirectionUp=T,e.lookAtTiltToEyeTilt=C,e.toExtent=P}));
