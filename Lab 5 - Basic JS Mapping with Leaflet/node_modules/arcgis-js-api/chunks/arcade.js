/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","exports","../arcade/arcadeCompiler","../arcade/ArcadeModuleResolver","../arcade/arcadeRuntime","../arcade/executionError","../arcade/parser","../arcade/treeAnalysis","../arcade/functions/geomsync","../core/has","../core/maybe"],(function(e,r,t,n,c,i,s,u,o,a,l){"use strict";const d=new Set(["feature","angle","bearing","centroid","envelopeintersects","extent","geometry","isselfintersecting","ringisclockwise"]);let p=!1,f=!1,S=null,y=[];function m(e,r){if(!0===r.useAsync||!0===e.isAsync)return x(e,r);if(a("esri-csp-restrictions")){return function(r){return c.executeScript(e,r)}}try{return t.compileScript(e,r)}catch(n){if("esri.arcade.arcadeuncompilableerror"===n.declaredRootClass)return function(r){return c.executeScript(e,r)};throw n}}function x(e,r){if(null===S)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.AsyncNotEnabled,null);if(a("esri-csp-restrictions")){return function(r){return S.executeScript(e,r)}}try{return t.compileScript(e,r,!0)}catch(n){if("esri.arcade.arcadeuncompilableerror"===n.declaredRootClass)return function(r){return S.executeScript(e,r)};throw n}}function b(e){c.extend(e),t.extend(e,"sync"),null===S?y.push(e):(t.extend(e,"async"),S.extend(e))}function E(e,r=[]){return s.parseScript(e,r)}function w(e,r,t=[]){return A(s.parseScript(e,t),r)}function A(e,r){if(!0===r.useAsync||!0===e.isAsync){if(null===S)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.AsyncNotEnabled,null);return S.executeScript(e,r)}return c.executeScript(e,r)}function g(e,r){return u.referencesMember(e,r)}function F(e,r){return u.referencesFunction(e,r)}function h(e,r=!1){return void 0===r&&(r=!1),u.findFieldLiterals(e)}function M(e){return u.findExpectedFieldLiterals(e)}function G(e,r=[]){return void 0===e.usesGeometry&&u.findScriptDependencies(e,r),!0===e.usesGeometry}let I=null;function D(){return I||(I=P(),I)}async function P(){const r=await new Promise(((r,t)=>e(["../geometry/geometryEngine"],r,t)));return f=!0,o.setGeometryEngine(r),!0}let U=null;function v(){return null!==U||(U=C()),U}async function C(){await t.enableAsyncSupport(),S=await new Promise(((r,t)=>e(["../arcade/arcadeAsyncRuntime"],r,t)));for(const e of y)S.extend(e),t.extend(e,"async");return y=null,!0}function L(){return p}function R(){return!!S}function _(){return f}let k=null;function T(){return k||(k=j(),k)}async function j(){await v();const[r,n,c,i,s,u]=await Promise.all([new Promise(((r,t)=>e(["../arcade/featureSetUtils"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetbase"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetgeom"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetstats"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetstring"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/knowledgegraph"],r,t)))]);return Q=r,S.extend([n,c,i,s,u]),t.extend([n,c,i,s,u],"async"),p=!0,!0}function z(e,r=[]){return void 0===e.usesFeatureSet&&u.findScriptDependencies(e,r),!0===e.usesFeatureSet}function N(e,r=[]){return void 0===e.isAsync&&u.findScriptDependencies(e,r),!0===e.isAsync}function O(e,r){if(r){for(const t of r)if(g(e,t))return!0;return!1}return!1}async function q(e,r,t=[],n=!1,c=null){return B(new Set,e,r,t,n,c)}async function B(e,r,t,n=[],c=!1,i=null){const s="string"==typeof r?E(r):r,u=[];return s&&(!1===_()&&(G(s)||c)&&u.push(D()),!1===R()&&(!0===s.isAsync||t)&&u.push(v()),!1===L()&&(z(s)||O(s,n))&&u.push(T())),u.length&&await Promise.all(u),await J(e,s,i,t,c),!0}function H(e,r=[]){return void 0===e.usesModules&&u.findScriptDependencies(e,r),!0===e.usesModules}async function J(e,r,t=null,c=!1,s=!1){const o=u.findModuleImports(r);null===t&&o.length>0&&(t=n.ArcadeModuleResolver.getDefault()),r.loadedModules={};for(const n of o){l.assertIsSome(t);const u=t.normalizeModuleUri(n.source);if(e.has(u.uri))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.CircularModules,null);e.add(u.uri);const o=await t.fetchModule(u);await B(e,o,c,[],s,t),e.delete(u.uri),o.isAsync&&(r.isAsync=!0),o.usesFeatureSet&&(r.usesFeatureSet=!0),o.usesGeometry&&(r.usesGeometry=!0),r.loadedModules[n.libname]={uri:u.uri,script:o}}}function K(e){if(G(e))return!0;const r=u.findFunctionCalls(e);let t=!1;for(let n=0;n<r.length;n++)if(d.has(r[n])){t=!0;break}return t}let Q=null;function V(){return Q}const W=Object.freeze(Object.defineProperty({__proto__:null,_loadScriptDependenciesImpl:B,compileScript:m,enableAsyncSupport:v,enableAsyncSupportImpl:C,enableFeatureSetSupport:T,enableFeatureSetSupportImpl:j,enableGeometrySupport:D,enableGeometrySupportImpl:P,executeScript:A,extend:b,extractExpectedFieldLiterals:M,extractFieldLiterals:h,featureSetUtils:V,isAsyncEnabled:R,isFeatureSetSupportEnabled:L,isGeometryEnabled:_,loadDependentModules:J,loadScriptDependencies:q,parseAndExecuteScript:w,parseScript:E,referencesFunction:F,referencesMember:g,scriptIsAsync:N,scriptTouchesGeometry:K,scriptUsesFeatureSet:z,scriptUsesGeometryEngine:G,scriptUsesModules:H},Symbol.toStringTag,{value:"Module"}));r._loadScriptDependenciesImpl=B,r.arcade=W,r.compileScript=m,r.enableAsyncSupport=v,r.enableAsyncSupportImpl=C,r.enableFeatureSetSupport=T,r.enableFeatureSetSupportImpl=j,r.enableGeometrySupport=D,r.enableGeometrySupportImpl=P,r.executeScript=A,r.extend=b,r.extractExpectedFieldLiterals=M,r.extractFieldLiterals=h,r.featureSetUtils=V,r.isAsyncEnabled=R,r.isFeatureSetSupportEnabled=L,r.isGeometryEnabled=_,r.loadDependentModules=J,r.loadScriptDependencies=q,r.parseAndExecuteScript=w,r.parseScript=E,r.referencesFunction=F,r.referencesMember=g,r.scriptIsAsync=N,r.scriptTouchesGeometry=K,r.scriptUsesFeatureSet=z,r.scriptUsesGeometryEngine=G,r.scriptUsesModules=H}));
