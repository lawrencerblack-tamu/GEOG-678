/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../core/Error","../../core/accessorSupport/originUtils","../../portal/Portal","../../portal/PortalItem","../../portal/support/jsonContext","../../portal/support/portalItemUtils","../../webdoc/support/saveAPIKeyUtils","../../webdoc/support/saveUtils"],(function(e,t,r,a,o,i,n,s,l){"use strict";function p(e,r,a){const o=a(e);if(!o.isValid)throw new t(`${r}:invalid-parameters`,o.errorMessage,{layer:e})}async function c(e){const{layer:t,errorNamePrefix:r,validateLayer:a}=e;await t.load(),p(t,r,a)}function u(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function d(e){const{item:r,errorNamePrefix:a,layer:o,validateItem:i}=e;if(s.validateSaveAPIKey(r),m(e),i){const e=i(r);if(!e.isValid)throw new t(`${a}:invalid-parameters`,e.errorMessage,{layer:o})}}function m(e){const{item:r,itemType:a,additionalItemType:o,errorNamePrefix:i,layer:n}=e,s=[a];if(o&&s.push(o),!s.includes(r.type)){const e=s.map((e=>`'${e}'`)).join(", ");throw new t(`${i}:portal-item-wrong-type`,`Portal item type should be one of: "${e}"`,{item:r,layer:n})}}function y(e){const{layer:r,errorNamePrefix:a}=e,{portalItem:o}=r;if(!o)throw new t(`${a}:portal-item-not-set`,u(r,"requires the portalItem property to be set"));if(!o.loaded)throw new t(`${a}:portal-item-not-loaded`,u(r,"cannot be saved to a portal item that does not exist or is inaccessible"));d({...e,item:o})}function f(e){const{newItem:t,itemType:r}=e;let i=o.from(t);return i.id&&(i=i.clone(),i.id=null),i.type??=r,i.portal??=a.getDefault(),d({...e,item:i}),i}function w(e){return i.createForItemWrite(e,"portal-item")}async function I(e,t,r){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const a=e.write({},t);return await Promise.all(t.resources?.pendingOperations??[]),l.evaluateWriteErrors(t,{errorName:"layer-write:unsupported"},r),a}function v(e){n.addTypeKeyword(e,n.typeKeyword.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}async function g(e,t,r){const a=e.portal;await a.signIn(),await(a.user?.addItem({item:e,data:t,folder:r?.folder}))}async function P(e,t){const{layer:a,createItemData:o,createJSONContext:i,saveResources:n,supplementalUnsupportedErrors:s}=e;await c(e),y(e);const l=a.portalItem,p=i?i(l):w(l),u=await I(a,p,{...t,supplementalUnsupportedErrors:s}),d=await o({layer:a,layerJSON:u},l);return v(l),await l.update({data:d}),r.updateOrigins(p),await(n?.(l,p)),l}async function S(e,t){const{layer:a,createItemData:o,createJSONContext:i,setItemProperties:n,saveResources:s,supplementalUnsupportedErrors:l}=e;await c(e);const p=f(e),u=i?i(p):w(p),d=await I(a,u,{...t,supplementalUnsupportedErrors:l}),m=await o({layer:a,layerJSON:d},p);return await n(a,p),v(p),await g(p,m,t),a.portalItem=p,r.updateOrigins(u),await(s?.(p,u)),p}e.addItem=g,e.createErrorMessage=u,e.createJSONContextForWrite=w,e.ensureItemConfig=y,e.ensureLayerConfig=p,e.getLayerJSON=I,e.getPortalItem=f,e.save=P,e.saveAs=S,e.setCommonItemProperties=v,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
