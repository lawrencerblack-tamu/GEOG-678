/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/PieChartRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../support/AggregateField","../support/featureReductionUtils","../../renderers/visualVariables/SizeVariable","../../renderers/visualVariables/support/SizeStop","../../views/2d/layers/support/clusterUtils"],(function(e,r,t,s,i,n,a,u,l,o,d,c,f,p,R,h,b,v,y,V,_,m){"use strict";const C=e=>{let t=class extends e{constructor(...e){super(...e),this.addHandles(f.watch((()=>this.renderer),(()=>{if(this.featureReduction){const e=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",e)}}),f.sync))}set featureReduction(e){const r=this._normalizeFeatureReduction(e);this._set("featureReduction",r)}set renderer(e){}_withClusterVariable(e,r,t){const s=e.clone();if("visualVariables"in s){s.visualVariables||(s.visualVariables=[]);s.visualVariables.some((e=>"size"===e.type))||s.visualVariables.push(new V({field:"cluster_count",stops:[new _({value:1}),new _({useMinValue:!0,size:r}),new _({useMaxValue:!0,size:t})]}))}return s}_normalizeFeatureReduction(e){if("cluster"!==e?.type)return e;const r=e.clone(),t=[new v({name:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],s=(r.fields??[]).filter((e=>!e.isAutoGenerated)),i=e.renderer&&!e.renderer.authoringInfo?.isAutoGenerated,{clusterMinSize:n,clusterMaxSize:a}=r;if(i){r.fields=[...t,...s];const e=this._withClusterVariable(r.renderer,n,a);return r.effectiveFeatureRenderer=e,r.effectiveClusterRenderer=e,r}if(e.symbol){if(r.fields=[...t,...s],r.renderer=null,!this.renderer)return r.effectiveFeatureRenderer=null,r.effectiveClusterRenderer=null,r;const i=m.createInferredClusterRenderer(t,this.renderer),u=this._withClusterVariable(i,n,a),o="visualVariables"in u&&u.visualVariables?u.visualVariables:[],d=new l({symbol:e.symbol,visualVariables:o});return r.fields=[...t,...s],r.effectiveFeatureRenderer=u,r.effectiveClusterRenderer=d,r}if(!this.renderer)return e;const u=m.createInferredClusterRenderer(t,this.renderer);r.fields=[...t,...s],r.renderer=u;const o=this._withClusterVariable(u,n,a);return r.effectiveFeatureRenderer=o,r.effectiveClusterRenderer=o,r}};return r.__decorate([p.property(y.featureReductionProperty)],t.prototype,"featureReduction",null),t=r.__decorate([b.subclass("esri.layers.mixins.FeatureReductionLayer")],t),t};e.FeatureReductionLayer=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
