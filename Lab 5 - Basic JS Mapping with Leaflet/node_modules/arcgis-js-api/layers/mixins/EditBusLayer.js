/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../chunks/tslib.es6","../../core/Evented","../../core/lang","../../core/promiseUtils","../../core/Logger","../../core/has","../../core/Error","../../core/accessorSupport/decorators/subclass","../../versionManagement/support/versionManagementUtils"],(function(e,t,i,s,d,n,r,o,l,a){"use strict";const c=new i.EventEmitter;function h(e){return c.on("apply-edits",new WeakRef(e))}function u(e){return c.on("update-moment",new WeakRef(e))}function m(e,t,i=null,s=!1){const n=d.createResolver();return s=null==t||s,c.emit("apply-edits",{serviceUrl:e,layerId:t,gdbVersion:i,mayReceiveServiceEdits:s,result:n.promise}),n}function p(e,t,i=null,s){c.emit("update-moment",{serviceUrl:e,layerId:t,gdbVersion:i,moment:s})}const b="esri.layers.mixins.EditBusLayer",g=Symbol(b);function F(e){return null!=e&&"object"==typeof e&&g in e}function y(e){return null!=e&&"object"==typeof e&&"gdbVersion"in e}function I(e,t,i){const s=new URL(e).host,d=a.defaultVersionNameLookup.get(s),n=e=>!e||e===d;return n(t)&&n(i)||t===i}const f=e=>{var i;let d=class extends e{constructor(...e){super(...e),this[i]=!0,this._applyEditsHandler=e=>{const{serviceUrl:t,layerId:i,gdbVersion:d,mayReceiveServiceEdits:n,result:r}=e,o=t===this.url,l=null!=i&&null!=this.layerId&&i===this.layerId,c=y(this),h=y(this)&&I(t,d,this.gdbVersion);if(!o||c&&!h||!l&&!n)return;const u=r.then((e=>{if(l&&(e.addedFeatures.length||e.updatedFeatures.length||e.deletedFeatures.length||e.addedAttachments.length||e.updatedAttachments.length||e.deletedAttachments.length))return this.emit("edits",s.clone(e)),e;const t=e.editedFeatures?.find((({layerId:e})=>e===this.layerId));if(t){const{adds:i,updates:d,deletes:n}=t.editedFeatures,r={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:i?i.map((({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],deletedFeatures:n?n.map((({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],updatedFeatures:d?d.map((({current:{attributes:e}})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],editedFeatures:s.clone(e.editedFeatures),exceededTransferLimit:!1,historicMoment:s.clone(e.historicMoment)};return this.emit("edits",r),r}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:s.clone(e.editedFeatures),exceededTransferLimit:!1,historicMoment:s.clone(e.historicMoment)}})).then((e=>("historicMoment"in this&&this.historicMoment!==e.historicMoment&&a.isVersionInEditSession(t,d)&&(this.historicMoment=e.historicMoment),e)));this.emit("apply-edits",{result:u})},this._updateMomentHandler=e=>{const{serviceUrl:t,gdbVersion:i,moment:s}=e,d=t===this.url,n=y(this),r=y(this)&&I(t,i,this.gdbVersion),o=y(this)&&!I(t,this.gdbVersion,null);d&&n&&r&&o&&"historicMoment"in this&&this.historicMoment!==s&&(this.historicMoment=s)},this.when().then((()=>{this.addHandles(h(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(u(this._updateMomentHandler))}),(()=>{}))}};return i=g,d=t.__decorate([l.subclass(b)],d),d};e.EditBusLayer=f,e.emitApplyEditsEvent=m,e.emitUpdateMomentEvent=p,e.isEditBusLayer=F,e.isLayerWithGDBVersion=y,e.onApplyEditsEvent=h,e.onUpdateMomentEvent=u,e.versionMatches=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
