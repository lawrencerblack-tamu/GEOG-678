/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../chunks/tslib.es6","../request","../core/Error","../core/Logger","../core/mathUtils","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/accessorSupport/decorators/property","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/subclass","../chunks/vec32","../core/libs/gl-matrix-2/factories/vec3f64","../geometry/ellipsoidUtils","../geometry/Extent","../geometry/SpatialReference","../geometry/projection/projectBuffer","./Layer","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/CustomParametersMixin","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./support/commonProperties","../support/elevationInfoUtils"],(function(e,t,r,a,i,o,s,n,l,p,c,d,y,u,m,f,h,x,g,v,_,b,S,I,E,L){"use strict";let M=class extends(v.ArcGISService(b.OperationalLayer(S.PortalLayer(I.ScaleRangeLayer(o.MultiOriginJSONMixin(_.CustomParametersMixin(g.APIKeyMixin(x)))))))){constructor(e){super(e),this.operationalLayerType="IntegratedMesh3DTilesLayer",this.spatialReference=new f({wkid:4326,vcsWkid:115700}),this.fullExtent=new m(-180,-90,180,90,this.spatialReference),this.url=null,this.type="integrated-mesh-3dtiles",this.path=null,this.minScale=0,this.maxScale=0}set elevationInfo(e){this._set("elevationInfo",e),this._validateElevationInfo()}_verifyArray(e,t){if(!Array.isArray(e)||e.length<t)return!1;for(const r of e)if("number"!=typeof r)return!1;return!0}_initFullExtent(e){const t=e.root?.boundingVolume;if(!t)return;if(t.box){const e=t?.box;if(e[3]>7972671&&e[7]>7972671&&e[11]>7945940)return}const r=e.root?.transform,a=y.create();if(t.region&&this._verifyArray(t.region,6)){const e=t.region,r=i.rad2deg(e[0]),a=i.rad2deg(e[1]),o=e[4],s=i.rad2deg(e[2]),n=i.rad2deg(e[3]),l=e[5];this.fullExtent=new m({xmin:r,ymin:a,zmin:o,xmax:s,ymax:n,zmax:l,spatialReference:this.spatialReference})}else if(t.sphere&&this._verifyArray(t.sphere,4)){const e=t.sphere,i=y.fromValues(e[0],e[1],e[2]),o=e[3]/Math.sqrt(3),s=y.create();d.subtract(s,i,y.fromValues(-o,-o,-o));const n=y.create();if(d.add(n,i,y.fromValues(o,o,o)),r&&this._verifyArray(r,16)){const e=r;d.transformMat4(a,s,e),d.copy(s,a),d.transformMat4(a,n,e),d.copy(n,a)}h.projectBuffer(s,u.WGS84ECEFSpatialReferenceLike,0,s,f.WGS84,0,1),h.projectBuffer(n,u.WGS84ECEFSpatialReferenceLike,0,n,f.WGS84,0,1);const l=y.create(),p=y.create();d.min(l,s,n),d.max(p,s,n),this.fullExtent=new m({xmin:l[0],ymin:l[1],zmin:l[2],xmax:p[0],ymax:p[1],zmax:p[2],spatialReference:this.spatialReference})}else if(t.box&&this._verifyArray(t.box,12)){const e=t.box,a=y.fromValues(e[0],e[1],e[2]),i=y.fromValues(e[3],e[4],e[5]),o=y.fromValues(e[6],e[7],e[8]),s=y.fromValues(e[9],e[10],e[11]),n=[];for(let t=0;t<8;++t)n.push(y.create());if(d.add(n[0],a,i),d.add(n[0],n[0],o),d.add(n[0],n[0],s),d.sub(n[1],a,i),d.add(n[1],n[1],o),d.add(n[1],n[1],s),d.add(n[2],a,i),d.sub(n[2],n[2],o),d.add(n[2],n[2],s),d.sub(n[3],a,i),d.sub(n[3],n[3],o),d.add(n[3],n[3],s),d.add(n[4],a,i),d.add(n[4],n[4],o),d.sub(n[4],n[4],s),d.sub(n[5],a,i),d.add(n[5],n[5],o),d.sub(n[5],n[5],s),d.add(n[6],a,i),d.sub(n[6],n[6],o),d.sub(n[6],n[6],s),d.sub(n[7],a,i),d.sub(n[7],n[7],o),d.sub(n[7],n[7],s),r&&this._verifyArray(r,16)){const e=r;for(let t=0;t<8;++t)d.transformMat4(n[t],n[t],e)}const l=y.fromValues(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),p=y.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let t=0;t<8;++t)h.projectBuffer(n[t],u.WGS84ECEFSpatialReferenceLike,0,n[t],f.WGS84,0,1),d.min(p,p,n[t]),d.max(l,l,n[t]);this.fullExtent=new m({xmin:p[0],ymin:p[1],zmin:p[2],xmax:l[0],ymax:l[1],zmax:l[2],spatialReference:this.spatialReference})}}async load(e){return this.addResolvingPromise(this._doLoad(e)),this}async _doLoad(e){const a=null!=e?e.signal:null;try{await this.loadFromPortal({supportedTypes:["3DTiles Service"],validateItem:e=>{if(e.typeKeywords?.includes("IntegratedMesh"))return!0;throw new r("portal:invalid-layer-item-type","Invalid layer item, expected '${expectedType}' ",{expectedType:"3DTiles Service containing IntegratedMesh"})}},e)}catch(i){s.throwIfAbortError(i)}if(this.url){const e=t(this.url,{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:a}).then((e=>{this._initFullExtent(e.data)}),(e=>{s.throwIfAbortError(e)}));await e}}async fetchAttributionData(){return this.load().then((()=>({})))}_validateElevationInfo(){const e=this.elevationInfo,t="Integrated mesh 3d tiles layers";L.logInvalidElevationInfoWarning(a.getLogger(this),L.elevationModeRequiredMessage(t,"absolute-height",e)),L.logInvalidElevationInfoWarning(a.getLogger(this),L.featureExpressionUnsupportedMessage(t,e))}};e.__decorate([n.property({type:["IntegratedMesh3DTilesLayer"]})],M.prototype,"operationalLayerType",void 0),e.__decorate([n.property({type:f})],M.prototype,"spatialReference",void 0),e.__decorate([n.property({type:m})],M.prototype,"fullExtent",void 0),e.__decorate([n.property(E.elevationInfo)],M.prototype,"elevationInfo",null),e.__decorate([n.property({type:["show","hide"]})],M.prototype,"listMode",void 0),e.__decorate([n.property(E.url)],M.prototype,"url",void 0),e.__decorate([n.property({readOnly:!0})],M.prototype,"type",void 0),e.__decorate([n.property({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],M.prototype,"path",void 0),e.__decorate([n.property({type:Number,json:{origins:{"web-scene":{name:"layerDefinition.minScale",write:()=>{},read:()=>{}},"portal-item":{name:"layerDefinition.minScale",write:()=>{},read:()=>{}}}}})],M.prototype,"minScale",void 0),e.__decorate([n.property({type:Number,json:{origins:{"web-scene":{name:"layerDefinition.maxScale",write:()=>{},read:()=>{}},"portal-item":{name:"layerDefinition.maxScale",write:()=>{},read:()=>{}}}}})],M.prototype,"maxScale",void 0),M=e.__decorate([c.subclass("esri.layers.IntegratedMesh3DTilesLayer")],M);return M}));
