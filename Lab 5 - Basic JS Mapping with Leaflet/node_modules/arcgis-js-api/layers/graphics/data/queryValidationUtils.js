/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../core/Error","./attributeSupport","./projectionSupport","./spatialQuerySupport","../../../support/arcadeOnDemand"],(function(e,t,i,s,a,r){"use strict";const o="unsupported-query";async function l(e,{fieldsIndex:i,geometryType:r,spatialReference:l,availableFields:u}){if((e.distance??0)<0||null!=e.geometryPrecision||e.multipatchOption&&"xyFootprint"!==e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new t(o,"Unsupported query options",{query:e});return n(i,u,e),c(i,u,e),Promise.all([a.checkSpatialQuerySupport(e,r,l),s.checkProjectionSupport(l,e.outSR)]).then((()=>e))}function n(e,s,a){const{outFields:r,orderByFields:l,returnDistinctValues:n,outStatistics:u}=a,c=u?u.map((e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase())).filter(Boolean):[];if(l&&l.length>0){const t=" asc",r=" desc",o=l.map((e=>{const i=e.toLowerCase();return i.includes(t)?i.split(t)[0]:i.includes(r)?i.split(r)[0]:e})).filter((e=>!c.includes(e)));i.validateFields(e,s,o,{expressionName:"orderByFields",query:a})}if(r&&r.length>0)i.validateFields(e,s,r,{expressionName:"outFields",query:a,allowedFieldTypes:"all"});else if(n)throw new t(o,"outFields should be specified for returnDistinctValues",{query:a});i.validateWhere(e,s,a.where,a)}const u=new Set([...i.numericFieldTypes,...i.allDateAndTimeFieldTypes]);function c(e,s,a){const{outStatistics:r,groupByFieldsForStatistics:l,having:n}=a,c=l?.length,d=r?.length;if(n){if(!c||!d)throw new t(o,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:a});i.validateHaving(e,s,n,r,a)}if(d){if(!y(r))return;const n=r.map((e=>e.onStatisticField)).filter(Boolean);i.validateFields(e,s,n,{expressionName:"onStatisticFields",query:a}),c&&i.validateFields(e,s,l,{expressionName:"groupByFieldsForStatistics",query:a});for(const l of r){const{onStatisticField:r,statisticType:n}=l;if(("percentile_disc"===n||"percentile_cont"===n)&&"statisticParameters"in l){const{statisticParameters:e}=l;if(!e)throw new t(o,"statisticParameters should be set for percentile type",{definition:l,query:a})}else e.get(r)&&"count"!==n&&"min"!==n&&"max"!==n&&i.validateFields(e,s,[r],{expressionName:`outStatistics with '${n}' statistic type`,allowedFieldTypes:u,query:a})}}}async function d(e,i,{fieldsIndex:r,geometryType:l,spatialReference:u,availableFields:c}){if((e.distance??0)<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new t(o,"Unsupported query options",{query:e});return n(r,c,e),Promise.all([p(r,c,i,e),a.checkSpatialQuerySupport(e,l,u),s.checkProjectionSupport(u,e.outSR)]).then((()=>e))}async function p(e,s,a,l){let n=[];if(a.valueExpression){const{arcadeUtils:e}=await r.loadArcade();n=e.extractFieldNames(a.valueExpression)}if(a.field&&n.push(a.field),a.field2&&n.push(a.field2),a.field3&&n.push(a.field3),a.normalizationField&&n.push(a.normalizationField),!n.length&&!a.valueExpression)throw new t(o,"field or valueExpression is required",{params:a});i.validateFields(e,s,n,{expressionName:"statistics",query:l})}function y(e){return null!=e&&e.every((e=>"exceedslimit"!==e.statisticType))}e.validateQuery=l,e.validateStatisticsQuery=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
