/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","../../../chunks/tslib.es6","../../../geometry","../../../kernel","../../../request","../../../TimeExtent","../../../core/arrayUtils","../../../core/Error","../../../core/has","../../../core/jsonMap","../../../core/Loadable","../../../core/Logger","../../../core/object","../../../core/promiseUtils","../../../core/urlUtils","../../../core/uuid","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../../../geometry/support/meshVertexSpaceUtils","../../../geometry/support/meshUtils/External","../applyEditsUtils","./support/clientSideDefaults","./support/QueryTask","../../support/arcgisLayerUrl","../../support/featureLayerUtils","../../support/infoFor3D","../../../rest/query/executeQueryJSON","../../../rest/query/operations/editsZScale","../../../rest/support/Query","../../../versionManagement/support/versionManagementUtils","../../../geometry/SpatialReference"],(function(e,t,s,a,r,i,n,o,u,l,c,d,p,y,h,g,f,m,S,w,q,E,O,R,b,F,A,_,x,I,v,N){"use strict";const T=new l.JSONMap({originalAndCurrentFeatures:"original-and-current-features",none:"none"}),M=new Set(["Feature Layer","Oriented Imagery Layer","Table","Catalog Layer"]),J=new l.JSONMap({Started:"published",Publishing:"publishing",Stopped:"unavailable"});let U=class extends c{constructor(){super(...arguments),this.type="feature-layer",this.refresh=y.debounce((async()=>{await this.load();const e=this.sourceJSON.editingInfo?.lastEditDate;if(null==e)return{dataChanged:!0,updates:{}};try{await this._fetchService(null)}catch{return{dataChanged:!0,updates:{}}}const t=e!==this.sourceJSON.editingInfo?.lastEditDate;return{dataChanged:t,updates:t?{editingInfo:this.sourceJSON.editingInfo,extent:this.sourceJSON.extent}:null}})),this._ongoingAssetUploads=new Map}load(e){const t=this.layer.sourceJSON,s=this._fetchService(t,{...e}).then((()=>this.layer.setUserPrivileges(this.sourceJSON.serviceItemId,e))).then((()=>this._ensureLatestMetadata(e)));return this.addResolvingPromise(s),Promise.resolve(this)}get queryTask(){const{capabilities:e,parsedUrl:t,dynamicDataSource:s,infoFor3D:a,gdbVersion:r,spatialReference:i,fieldsIndex:n}=this.layer,o=u("featurelayer-pbf")&&e?.query.supportsFormatPBF&&null==a,l=e?.operations?.supportsQueryAttachments??!1;return new R({url:t.path,pbfSupported:o,fieldsIndex:n,infoFor3D:a,dynamicDataSource:s,gdbVersion:r,sourceSpatialReference:i,queryAttachmentsSupported:l})}async addAttachment(e,t){await this.load();const{layer:s}=this;await F.ensureLayerCredential(s,"editing");const a=e.attributes[s.objectIdField],i=s.parsedUrl.path+"/"+a+"/addAttachment",n=this._getLayerRequestOptions(),o=this._getFormDataForAttachment(t,n.query);try{const e=await r(i,{body:o});return E.createFeatureEditResult(e.data.addAttachmentResult)}catch(u){throw this._createAttachmentErrorResult(a,u)}}async updateAttachment(e,t,s){await this.load();const{layer:a}=this;await F.ensureLayerCredential(a,"editing");const i=e.attributes[a.objectIdField],n=a.parsedUrl.path+"/"+i+"/updateAttachment",o=this._getLayerRequestOptions({query:{attachmentId:t}}),u=this._getFormDataForAttachment(s,o.query);try{const e=await r(n,{body:u});return E.createFeatureEditResult(e.data.updateAttachmentResult)}catch(l){throw this._createAttachmentErrorResult(i,l)}}async applyEdits(e,t){await this.load();const{layer:s}=this;await F.ensureLayerCredential(s,"editing");const i=s.infoFor3D,u=null!=i,l=u||(t?.globalIdUsed??!1),c=u?await this._uploadMeshesAndGetAssetMapEditsJSON(e):null,d=e.addFeatures?.map((e=>E.getFeatureJSON(this.layer,e,i)))??[],p=(await Promise.all(d)).filter(n.isSome),y=e.updateFeatures?.map((e=>E.getFeatureJSON(this.layer,e,i)))??[],h=(await Promise.all(y)).filter(n.isSome),g=E.getFeatureIds(this.layer,e.deleteFeatures,l);x.unapplyEditsZUnitScaling(p,h,s.spatialReference);const f=await E.getAttachmentEditsJSON(this.layer,e),m=s.capabilities.editing.supportsAsyncApplyEdits&&u,S=t?.gdbVersion||s.gdbVersion,w={gdbVersion:S,rollbackOnFailure:t?.rollbackOnFailureEnabled,useGlobalIds:l,returnEditMoment:t?.returnEditMoment,usePreviousEditMoment:t?.usePreviousEditMoment,async:m};await v.isSafeToEditVersion(this.layer.url,S,!0);const q=v.isVersionInEditSession(this.layer.url,S||null);if(await v.isHistoricVersion(s.url,S,s.historicMoment))throw new o("feature-layer-source:historic-version","Editing a historic version is not allowed");t?.returnServiceEditsOption?(w.edits=JSON.stringify([{id:s.layerId,adds:p,updates:h,deletes:g,attachments:f,assetMaps:c}]),w.returnServiceEditsOption=T.toJSON(t?.returnServiceEditsOption),w.returnServiceEditsInSourceSR=t?.returnServiceEditsInSourceSR):(w.adds=p.length?JSON.stringify(p):null,w.updates=h.length?JSON.stringify(h):null,w.deletes=g.length?l?JSON.stringify(g):g.join(","):null,w.attachments=f&&JSON.stringify(f),w.assetMaps=null!=c?JSON.stringify(c):void 0);const O=this._getLayerRequestOptions({method:"post",query:w});q&&(O.authMode="immediate",O.query.returnEditMoment=!0,O.query.sessionId=v.currentSessionId);const R=t?.returnServiceEditsOption?s.url:s.parsedUrl.path;let b;try{b=m?await this._asyncApplyEdits(R+"/applyEdits",O):await r(R+"/applyEdits",O)}catch(A){if(!E.isProtectedOrPrivateVersionError(A))throw A;O.authMode="immediate",b=m?await this._asyncApplyEdits(R+"/applyEdits",O):await r(R+"/applyEdits",O)}if(!s.capabilities.operations?.supportsEditing&&s.effectiveCapabilities?.operations?.supportsEditing){const e=a.id?.findCredential(s.url);await(e?.refreshToken())}return this._createEditsResult(b)}async deleteAttachments(e,t){await this.load();const{layer:s}=this;await F.ensureLayerCredential(s,"editing");const a=e.attributes[s.objectIdField],i=s.parsedUrl.path+"/"+a+"/deleteAttachments";try{return(await r(i,this._getLayerRequestOptions({query:{attachmentIds:t.join(",")},method:"post"}))).data.deleteAttachmentResults.map(E.createFeatureEditResult)}catch(n){throw this._createAttachmentErrorResult(a,n)}}fetchRecomputedExtents(e={}){const t=e.signal;return this.load({signal:t}).then((async()=>{const t=this._getLayerRequestOptions({...e,query:{returnUpdates:!0}}),{layerId:s,url:a}=this.layer,{data:n}=await r(`${a}/${s}`,t),{id:o,extent:u,fullExtent:l,timeExtent:c}=n,d=u||l;return{id:o,fullExtent:d&&S.fromJSON(d),timeExtent:c&&i.fromJSON({start:c[0],end:c[1]})}}))}async queryAttachments(e,t={}){await this.load();const s=this._getLayerRequestOptions(t);return this.queryTask.executeAttachmentQuery(e,s)}async queryFeatures(e,t){await this.load();const s=await this.queryTask.execute(e,{...t,query:this._createRequestQueryOptions(t)});return e.outStatistics?.length&&s.features.length&&s.features.forEach((t=>{const s=t.attributes;e.outStatistics?.forEach((({outStatisticFieldName:e})=>{if(e){const t=e.toLowerCase();t&&t in s&&e!==t&&(s[e]=s[t],delete s[t])}}))})),s}async queryFeaturesJSON(e,t){return await this.load(),this.queryTask.executeJSON(e,{...t,query:this._createRequestQueryOptions(t)})}async queryObjectIds(e,t){return await this.load(),this.queryTask.executeForIds(e,{...t,query:this._createRequestQueryOptions(t)})}async queryFeatureCount(e,t){return await this.load(),this.queryTask.executeForCount(e,{...t,query:this._createRequestQueryOptions(t)})}async queryExtent(e,t){return await this.load(),this.queryTask.executeForExtent(e,{...t,query:this._createRequestQueryOptions(t)})}async queryRelatedFeatures(e,t){return await this.load(),this.queryTask.executeRelationshipQuery(e,{...t,query:this._createRequestQueryOptions(t)})}async queryRelatedFeaturesCount(e,t){return await this.load(),this.queryTask.executeRelationshipQueryForCount(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopFeatures(e,t){return await this.load(),this.queryTask.executeTopFeaturesQuery(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopObjectIds(e,t){return await this.load(),this.queryTask.executeForTopIds(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopExtents(e,t){return await this.load(),this.queryTask.executeForTopExtents(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopCount(e,t){return await this.load(),this.queryTask.executeForTopCount(e,{...t,query:this._createRequestQueryOptions(t)})}async fetchPublishingStatus(){if(!b.isHostedAgolService(this.layer.url))return"unavailable";const e=h.join(this.layer.url,"status"),t=await r(e,{query:{f:"json"}});return J.fromJSON(t.data.status)}async uploadAssets(t,s){const{uploadAssets:a}=await new Promise(((t,s)=>e(["./support/uploadAssets"],t,s)));return a(t,{layer:this.layer,ongoingUploads:this._ongoingAssetUploads},s)}async _asyncApplyEdits(e,t){const s=(await r(e,t)).data.statusUrl;for(;;){const e=(await r(s,{query:{f:"json"},responseType:"json"})).data;switch(e.status){case"Completed":return r(e.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new o("async-applyEdits-failed","asynchronous applyEdits call failed.");case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new o("async-applyEdits-failed","asynchronous applyEdits call failed (undefined response status)")}await y.after(k)}}_createRequestQueryOptions(e){const t={...this.layer.customParameters,token:this.layer.apiKey,...e?.query};return this.layer.datesInUnknownTimezone&&(t.timeReferenceUnknownClient=!0),t}async _fetchService(e,t){if(!e){const s={};u("featurelayer-advanced-symbols")&&(s.returnAdvancedSymbols=!0),t?.cacheBust&&(s._ts=Date.now());const{data:a}=await r(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:s,signal:t?.signal}));e=a}this.sourceJSON=await this._patchServiceJSON(e,t?.signal);const s=e.type;if(!M.has(s))throw new o("feature-layer-source:unsupported-type",`Source type "${s}" is not supported`)}async _patchServiceJSON(e,t){if("Table"!==e.type&&e.geometryType&&!e?.drawingInfo?.renderer&&!e.defaultSymbol){const t=O.createDrawingInfo(e.geometryType).renderer;p.setDeepValue("drawingInfo.renderer",t,e)}if("esriGeometryMultiPatch"===e.geometryType&&e.infoFor3D&&(e.geometryType="mesh"),null==e.extent)try{const{data:s}=await r(this.layer.url,this._getLayerRequestOptions({signal:t}));s.spatialReference&&(e.extent={xmin:0,ymin:0,xmax:0,ymax:0,spatialReference:s.spatialReference})}catch(s){y.throwIfAbortError(s)}return e}async _ensureLatestMetadata(e){if(this.layer.userHasUpdateItemPrivileges&&this.sourceJSON.cacheMaxAge>0)return this._fetchService(null,{...e,cacheBust:!0})}async _uploadMeshesAndGetAssetMapEditsJSON(e){const{addAssetFeatures:t}=e;if(!t?.length)return null;const s=await this._filterRedundantAssetMaps(t);if(!t?.length)return null;const a=new Array,r=new Map;for(const i of s){const{geometry:e}=i,{vertexSpace:t}=e;if(w.isRelativeVertexSpace(t))a.push(e);else{const t=w.toRelativeVertexSpace(e);r.set(t,e),i.geometry=t,a.push(t)}}await this.uploadAssets(a);for(const[i,n]of r)n.addExternalSources(i.metadata.externalSources.items);return{adds:this._getAssetMapEditsJSON(s),updates:[],deletes:[]}}_getAssetMapEditsJSON(e){const t=new Array,s=this.layer.globalIdField,a=this.layer.parsedUrl;for(const r of e){const e=r.geometry,{metadata:i}=e,n=i.getExternalSourcesOnService(a),o=r.getAttribute(s);if(0===n.length){d.getLogger(this).error(`Skipping feature ${o}. The mesh it is associated with has not been uploaded to the service and cannot be mapped to it.`);continue}const{source:u}=n.find(q.isOriginalExternal)??n[0];for(const s of u)1===s.parts.length?t.push({globalId:g.generateBracedUUID(),parentGlobalId:o,assetName:s.assetName,assetHash:s.parts[0].partHash,flags:[]}):d.getLogger(this).error(`Skipping asset ${s.assetName}. It does not have exactly one part, so we cannot map it to a feature.`)}return t}_createEditsResult(e){const t=e.data,{layerId:s}=this.layer,a=[];let r=null;if(Array.isArray(t))for(const n of t)a.push({id:n.id,editedFeatures:n.editedFeatures}),n.id===s&&(r={addResults:n.addResults??[],updateResults:n.updateResults??[],deleteResults:n.deleteResults??[],attachments:n.attachments,editMoment:n.editMoment});else r=t;const i=E.unpackEditResultData(r);if(a.length>0){i.editedFeatureResults=[];for(const e of a){const{editedFeatures:t}=e,s=t?.spatialReference?new N(t.spatialReference):null;i.editedFeatureResults.push({layerId:e.id,editedFeatures:E.createEditedFeatures(t,s)})}}return i}_createAttachmentErrorResult(e,t){const s=t.details.messages?.[0]||t.message,a=t.details.httpStatus||t.details.messageCode;return{objectId:e,globalId:null,error:new o("feature-layer-source:attachment-failure",s,{code:a})}}_getFormDataForAttachment(e,t){const s=e instanceof FormData?e:e&&e.elements?new FormData(e):null;if(s)for(const a in t){const e=t[a];null!=e&&(s.set?s.set(a,e):s.append(a,e))}return s}_getLayerRequestOptions(e={}){const{parsedUrl:t,gdbVersion:s,dynamicDataSource:a}=this.layer;return{...e,query:{gdbVersion:s,layer:a?JSON.stringify({source:a}):void 0,...t.query,f:"json",...this._createRequestQueryOptions(e)},responseType:"json"}}async _filterRedundantAssetMaps(e){const{layer:t}=this,{globalIdField:s,infoFor3D:a,parsedUrl:r}=t;if(null==a||null==s)return e;const i=A.getAssetMapTable(a);if(null==i)return e;const o=h.join(r.path,`../${i.id}`),u=new Array,l=new Array;for(const n of e)n.geometry.metadata.getExternalSourcesOnService(r).length>0?l.push(n):u.push(n);const c=l.map((e=>e.getAttribute(s))).filter(n.isSome);if(0===c.length)return e;const{assetMapFieldRoles:{parentGlobalId:d,assetHash:p}}=a,y=new I;y.where=`${d} IN (${c.map((e=>`'${e}'`))})`,y.outFields=[p,d],y.returnGeometry=!1;const g=await _.executeQueryJSON(o,y),{features:f}=g;return 0===f.length?e:[...u,...l.filter((e=>{const t=e.getAttribute(s);if(!t)return!0;const{metadata:a}=e.geometry,i=f.filter((e=>e.getAttribute(d)===t));if(0===i.length)return!0;const n=i.map((e=>e.getAttribute(p)));return a.getExternalSourcesOnService(r).flatMap((({source:e})=>e.flatMap((e=>e.parts.map((e=>e.partHash)))))).some((e=>n.every((t=>e!==t))))}))]}};t.__decorate([f.property()],U.prototype,"type",void 0),t.__decorate([f.property({constructOnly:!0})],U.prototype,"layer",void 0),t.__decorate([f.property({readOnly:!0})],U.prototype,"queryTask",null),U=t.__decorate([m.subclass("esri.layers.graphics.sources.FeatureLayerSource")],U);const k=1e3;return U}));
