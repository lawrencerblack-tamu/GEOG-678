/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../../request","../../../../core/promiseUtils","../../../../core/urlUtils","../../../support/arcgisLayerUrl","../../../../support/progressUtils"],(function(e,o,t,r,s,n){"use strict";const a=1e6,i=20*a,l=2e9,p=3;async function c({data:e,name:c,description:m},u,f){let h=null;try{const w=r.join(u,"uploads"),y=r.join(w,"info"),{data:j}=await o(y,{query:{f:"json"},responseType:"json"});t.throwIfAborted(f);const g=s.isHostedAgolService(u),A=j.maxUploadFileSize*a,I=g?l:A,T=g?Math.min(i,A):i;if(e.size>I)throw new Error("Data too large");const b=r.join(w,"register"),{data:P}=await o(b,{query:{f:"json",itemName:d(c),description:m},responseType:"json",method:"post"});if(t.throwIfAborted(f),!P.success)throw new Error("Registration failed");const{itemID:q}=P.item;h=r.join(w,q);const z=r.join(h,"uploadPart"),M=Math.ceil(e.size/T),U=new Array;for(let o=0;o<M;++o)U.push(e.slice(o*T,Math.min((o+1)*T,e.size)));const v=U.slice().reverse(),E=new Array,S=n.makeProgressManager(M,f?.onProgress,"uploadItem"),D=async()=>{for(;0!==v.length;){const e=U.length-v.length,r=v.pop(),s=new FormData,a=S.simulate(e,n.estimatedTransferTime(r.size));try{s.append("f","json"),s.append("file",r),s.append("partId",`${e}`);const{data:n}=await o(z,{timeout:0,body:s,responseType:"json",method:"post"});if(t.throwIfAborted(f),!n.success)throw new Error("Part upload failed")}finally{a.remove()}}};for(let e=0;e<p&&0!==v.length;++e)E.push(D());await Promise.all(E);const x=r.join(h,"commit"),{data:F}=await o(x,{query:{f:"json",parts:U.map(((e,o)=>o)).join(",")},responseType:"json",method:"post"});if(t.throwIfAborted(f),!F.success)throw new Error("Commit failed");return F.item}catch(w){if(null!=h){const e=r.join(h,"delete");await o(e,{query:{f:"json"},responseType:"json",method:"post"})}throw w}}function d(e){return e.replaceAll("/","_").replaceAll("\\","_")}e.uploadItem=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
