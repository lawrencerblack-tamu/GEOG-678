/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../Graphic","../../core/Error","../../core/Logger","../../core/unitUtils","../../core/urlUtils","../../geometry/projection","../../geometry/support/jsonUtils","../../geometry/support/spatialReferenceUtils","./editingSupport"],(function(e,t,a,r,s,o,n,l,i,u){"use strict";async function d(e,t,a){const{geometry:r}=t,o={...t.attributes};if(null!=a&&"mesh"===r?.type){const{transformFieldRoles:t}=a,{origin:l,spatialReference:u,transform:d,vertexSpace:c}=r,p="local"===c.type,g=e.spatialReference,m=g.isGeographic,f=i.equals(g,u),b=f||i.isWGS84(g)&&(i.isWGS84(u)||i.isWebMercator(u));if(!(p&&m&&b||!p&&!m&&f))return null;const R=n.projectWithoutEngine(l,u,g);if(null==R)return null;if(o[t.originX]=R.x,o[t.originY]=R.y,o[t.originZ]=R.z??0,null!=d){const{translation:e,scale:a,rotation:r}=d,n=p?1:s.getMetersPerCartesianUnitForSR(u)/s.getMetersPerCartesianUnitForSR(g);o[t.translationX]=e[0]*n,o[t.translationY]=e[2]*n,o[t.translationZ]=-e[1]*n,o[t.scaleX]=a[0],o[t.scaleY]=a[2],o[t.scaleZ]=a[1],o[t.rotationX]=r[0],o[t.rotationY]=r[2],o[t.rotationZ]=-r[1],o[t.rotationDeg]=r[3]}return{attributes:o}}return null==r?{attributes:o}:"mesh"===r.type||"extent"===r.type?null:{geometry:r.toJSON(),attributes:o}}async function c(e,t){const a=await Promise.all((t.addAttachments??[]).map((t=>p(e,t)))),r=await Promise.all((t.updateAttachments??[]).map((t=>p(e,t)))),s=t.deleteAttachments??[];return a.length||r.length||s.length?{adds:a,updates:r,deletes:[...s]}:null}async function p(e,t){const{feature:a,attachment:r}=t,{globalId:s,name:n,contentType:l,data:i,uploadId:u}=r,d={globalId:s};if(a&&("attributes"in a?d.parentGlobalId=a.attributes?.[e.globalIdField]:a.globalId&&(d.parentGlobalId=a.globalId)),u)d.uploadId=u;else if(i){const e=await o.parseData(i);e&&(d.contentType=e.mediaType,d.data=e.data),i instanceof File&&(d.name=i.name)}return n&&(d.name=n),l&&(d.contentType=l),d}function g(e,t,a){if(!t||0===t.length)return[];if(a&&u.isFeatureIdentifierArrayWithGlobalId(t))return t.map((e=>e.globalId));if(u.isFeatureIdentifierArrayWithObjectId(t))return t.map((e=>e.objectId));const r=a?e.globalIdField:e.objectIdField;return r?t.map((e=>e.getAttribute(r))):[]}function m(e){const t=e?.assetMaps;if(t){for(const e of t.addResults)e.success||r.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${e.globalId}.`);for(const e of t.updateResults)e.success||r.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${e.globalId}.`)}const a=e?.attachments,s={addFeatureResults:e?.addResults?.map(f)??[],updateFeatureResults:e?.updateResults?.map(f)??[],deleteFeatureResults:e?.deleteResults?.map(f)??[],addAttachmentResults:a?.addResults?a.addResults.map(f):[],updateAttachmentResults:a?.updateResults?a.updateResults.map(f):[],deleteAttachmentResults:a?.deleteResults?a.deleteResults.map(f):[]};return e?.editMoment&&(s.editMoment=e.editMoment),s}function f(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new a("feature-layer-source:edit-failure",t.description,{code:t.code}):null}}function b(e,a){return new t({attributes:e.attributes,geometry:l.fromJSON({...e.geometry,spatialReference:a})})}function R(e,t){return{adds:e?.adds?.map((e=>b(e,t)))||[],updates:e?.updates?.map((e=>({original:b(e[0],t),current:b(e[1],t)})))||[],deletes:e?.deletes?.map((e=>b(e,t)))||[],spatialReference:t}}function y(e){const t=e.details.raw,a=+t.code,r=+t.extendedCode;return 500===a&&(-2147217144===r||-2147467261===r)}e.createEditedFeatures=R,e.createFeatureEditResult=f,e.getAttachmentEditsJSON=c,e.getFeatureIds=g,e.getFeatureJSON=d,e.isProtectedOrPrivateVersionError=y,e.unpackEditResultData=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
