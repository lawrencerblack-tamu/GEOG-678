/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Collection","../../core/handleUtils","../../core/Logger","../../core/LRUCache","../../core/MapUtils","../../core/MultiOriginJSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../Layer","../mixins/BlendLayer","../mixins/ScaleRangeLayer","../support/commonProperties","../support/lazyLayerLoader","../support/OrderByInfo","../../portal/Portal","../../portal/PortalItem","../../statistics/utils"],(function(e,r,t,o,a,i,s,n,c,l,p,y,d,u,h,_,m,g,f,L){"use strict";class b{constructor(e,r){this.objectId=e,this.itemSource=r,this.count=0,this.layer=null,this.sortValue=void 0}}const R=new a.LRUCache(20,(e=>e.destroy()));let S=class extends(u.ScaleRangeLayer(d.BlendLayer(s.MultiOriginJSONMixin(y)))){constructor(e){super(e),this._oidToReference=new Map,this._layerToReference=new Map,this._portals=new Map,this.layers=new r,this.maximumVisibleSublayers=10,this.opacity=1,this.title="Layers In View",this.type="catalog-dynamic-group",this.visible=!0}load(e){return this.addResolvingPromise(this.parent.load()),Promise.resolve(this)}get _orderBy(){return this.parent.orderBy?.find((e=>!e.valueExpression&&e.field))??new m({field:this.parent.objectIdField})}get _referenceComparator(){const e=this._orderBy,r=this.parent.fieldsIndex.get(e.field),t=L.getAttributeComparator(r?.toJSON().type,"descending"===e.order);return(e,r)=>{const o=t(e.sortValue,r.sortValue);return o||e.objectId-e.objectId}}acquireLayer(e){const r=e.getObjectId(),o=i.getOrCreateMapValue(this._oidToReference,r,(()=>this._createLayerReference(e)));return o.count++,t.makeHandle((()=>{o.count--,o.count||this._disposeLayerReference(o)}))}_createLayerReference(e){const r=e.getObjectId(),t=e.getAttribute(this.parent.itemSourceField),a=new b(r,t);if(R.get(t))return this._addLayer(R.pop(t),a,e),a;let i;try{i=JSON.parse(t)}catch(s){return o.getLogger(this).error(s),a}return this._createLayer(i).then((r=>{this.destroyed||0===a.count?(R.get(t)||R.put(a.itemSource,r),a.layer=null):this._addLayer(r,a,e)})).catch((()=>{})),a}_addLayer(e,r,t){this._layerToReference.set(e,r),r.sortValue=t.getAttribute(this._orderBy.field),r.layer=e,e.parent=this,this.layers.add(e),this.layers.sort(((e,r)=>this._referenceComparator(this._layerToReference.get(e),this._layerToReference.get(r))))}_disposeLayerReference(e){e.layer&&(this._layerToReference.delete(e.layer),this.layers.remove(e.layer),R.put(e.itemSource,e.layer)),this._oidToReference.delete(e.objectId)}async _createLayer(e){if(!v(e)){return new(await _.layerLookupMap.UnsupportedLayer())}const{itemId:r,portalUrl:t}=e,o=i.getOrCreateMapValue(this._portals,t,(()=>new g({url:t})));return y.fromPortalItem(new f({id:r,portal:o}))}};e.__decorate([n.property()],S.prototype,"_orderBy",null),e.__decorate([n.property()],S.prototype,"_referenceComparator",null),e.__decorate([n.property({readOnly:!0})],S.prototype,"layers",void 0),e.__decorate([n.property()],S.prototype,"maximumVisibleSublayers",void 0),e.__decorate([n.property(h.opacity)],S.prototype,"opacity",void 0),e.__decorate([n.property({type:String,json:{name:"title",write:!0}})],S.prototype,"title",void 0),e.__decorate([n.property({json:{read:!1}})],S.prototype,"type",void 0),e.__decorate([n.property({type:Boolean,json:{name:"visibility",write:!0}})],S.prototype,"visible",void 0),S=e.__decorate([p.subclass("esri.layers.catalog.CatalogDynamicGroupLayer")],S);function v(e){return"object"==typeof e&&null!=e&&"itemId"in e&&"portalUrl"in e}return S}));
