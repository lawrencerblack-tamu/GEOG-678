/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../geometry","../../../core/mathUtils","../../../core/memoize","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec32","../../../geometry/support/webMercatorUtils","../core/cameraOrientationFactory","./utils","./worldToImage","../../../geometry/Point"],(function(e,a,t,r,o,n,c,i,s,l,f){"use strict";function m(e,a){const t=Array.isArray(e)?e:[e],{effectiveVerticalFieldOfView:r,imageVertices:o,scalingFactor:n,shouldConvertToLatLong:c,worldFootprint:i,localTangentPlane:s,cameraLocation:l}=p(a),f=new Array;for(const m of t){const e=g(i,o,{...m,z:1},l,a,s);f.push(d(e,l,n,(l.z??0)-a.cameraHeight,a.cameraPitch,r,c))}return 1===f.length?f[0]:f}function d(e,a,t,r,i,l,m){let d=e.clone();const g=Math.sqrt((e.z-a.z)**2+(Math.sqrt((e.x-a.x)**2+(e.y-a.y)**2)/t)**2)*t,u=s.scaleWithFactor(n.sub(o.zeros(),[e.x,e.y,e.z],[a.x,a.y,a.z]),1/g,1/t);if(e.z<r||i+l/2<90){const o=Math.abs((a.z-r)/-u[2])*t,n=s.scaleAndAddWithFactor([a.x,a.y,a.z],u,o,t);d=new f({x:n[0],y:n[1],z:n[2],spatialReference:e.spatialReference})}else d.z=r;return m&&(d=c.webMercatorToGeographic(e)),d}function g(e,a,t,r,o,n){let c=null;const i=9;let m,d=0,g=e,h=a;for(;d<=i;){const e=u(t,h,g,{...o,cameraLocation:r},t);if(m=e.error,c=e.transformedPoint,m<=1||d===i)break;g=[{x:t.x-m,y:t.y-m,z:1},{x:t.x+m,y:t.y-m,z:1},{x:t.x+m,y:t.y+m,z:1},{x:t.x-m,y:t.y+m,z:1}].map((e=>new f({...s.projectiveTransform2(e,a,g),spatialReference:r.spatialReference}))),h=l.worldToImageWithLTPFlag(n,g,o),d++}return c}function u(e,a,t,r,o){const{cameraLocation:n}=r,c=new f({...s.projectiveTransform2(e,a,t),spatialReference:n.spatialReference});return{transformedPoint:c,error:h(o,l.worldToImage(c,r))}}function h(e,a){return Math.abs(e.x-a.x)+Math.abs(e.y-a.y)}function p(e){const a="string"==typeof e.cameraOrientation?i.getCameraOrientation(e.cameraOrientation):e.cameraOrientation,t=4===a?.type,r=e.cameraLocation.spatialReference.isWGS84&&t;let o=new f(e.cameraLocation);if(t){const e=a;o=new f(s.ltpToGeographic(o,[e.latitude,e.longitude,e.ellipsoidRadius,e.squaredEccentricity]))}o.spatialReference.isGeographic&&(o=c.geographicToWebMercator(o));const n=l.getScalingFactor(o);o.z||(o.z=e.cameraHeight);const m=y({...e,scalingFactor:n});return{cameraOrientation:a,cameraLocation:o,imageVertices:l.worldToImageWithLTPFlag(t,m,e),localTangentPlane:t,effectiveVerticalFieldOfView:s.computeHFOVAndVFOV(e.horizontalFieldOfView,e.verticalFieldOfView,e.cameraRoll??0).vfov,worldFootprint:m,scalingFactor:n,shouldConvertToLatLong:r}}const y=r.memoize((e=>{const{cameraLocation:a,scalingFactor:r}=e,c=2*Math.tan(t.deg2rad(e.verticalFieldOfView)/2)*e.farDistance*r,i=2*Math.tan(t.deg2rad(e.horizontalFieldOfView)/2)*e.farDistance*r,l=s.calculateRotationMatrix("HPR",[e.cameraHeading,e.cameraPitch,e.cameraRoll??0]),m=s.transformMat3([0,0,-1],l),d=s.scaleAndAddWithFactor([a.x,a.y,a.z],m,e.farDistance*r,r),g=s.transformMat3([0,1,0],l),u=s.transformMat3([1,0,0],l),h=s.scaleWithFactor(g,c/2,r),p=s.scaleWithFactor(u,i/2,r),y=n.sub(o.zeros(),h,p),z=n.add(o.zeros(),h,p);return[n.add(o.zeros(),d,y),n.add(o.zeros(),d,z),n.sub(o.zeros(),d,y),n.sub(o.zeros(),d,z)].map((e=>{const[t,r,o]=e;return new f({x:t,y:r,z:o,spatialReference:a.spatialReference})}))}));e.imageToWorld=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
