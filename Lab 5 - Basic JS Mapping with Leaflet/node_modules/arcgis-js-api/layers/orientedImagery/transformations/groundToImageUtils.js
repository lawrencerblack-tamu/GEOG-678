/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/math/mat3","../../../geometry/Point","../../../geometry/projection","../../../geometry/support/aaBoundingRect","../../../geometry/support/pointUtils","../../../geometry/support/webMercatorUtils","../../ElevationLayer","../../ImageryLayer","../core/ElevationSourceDefinitions","./utils","../../support/ElevationSampler","../../support/ElevationTile","../../support/ElevationTileData","../../support/TileInfo","../../support/TileKey","../../../widgets/PanoramicViewer/constants"],(function(e,t,a,i,r,n,o,c,s,l,u,p,f,m,g,d,h,y,v,w){"use strict";const R=Math.PI/180;async function b(e,t,a=!1){if(!e)return[];e=e.map((e=>"esri.geometry.Point"===e.declaredClass?e:n.fromJSON(e)));const{feature:i}=t,{attributes:r}=i;if(isNaN(parseFloat(r.elevation))){const e=await P([i.geometry],t);i.attributes.elevation=e[0].z}return P(e,t,a).then((e=>E(e,t)))}async function P(e,t,a=!1){if(a)return e;const{feature:{attributes:{cameraOrientation:i,elevationSource:r,cameraHeight:n,location:o}}}=t;return r&&(f.isConstantElevation(r)||r.url?.length)?M(e,t):z(e,i&&"number"==typeof o.z?o.z-n:0)}async function M(e,t){const{feature:r,options:n,footprintExtent:s}=t,l=r.attributes.elevationSource;if(!l)return e;if(f.isConstantElevation(l)){const{constantElevation:t}=l;return"number"!=typeof t?e:z(e,t)}const{url:m}=l;if(!m)return e;const{elevationSample:w}=r;if(!w){if(!s)return e;const t=s.clone(),{error:o,isSupported:w,isDynamic:b}=await f.validateElevationSourceURL(m);if(!w){a.getLogger(l).warn(o);const{location:t,cameraHeight:i,cameraOrientation:n}=r.attributes;return z(e,n&&"number"==typeof t.z?t.z-i:0)}let P,M=e;try{if(b){P=new p({url:m,format:"lerc",rasterFunction:{functionName:l.rasterFunction??"None"}}),await P.load(n);let e,a=512,i=512;const o=s.width/s.height;o>1?(i/=o,e=t.height/i):(a*=o,e=t.width/a);const u=await P.fetchImage(s,a,i,n),f=y.create({scales:[e],size:512,spatialReference:s.spatialReference}),w=new v.TileKey(null,0,0,0,c.fromExtent(s)),R=new h.ElevationTileData(u.pixelData.pixelBlock.pixels[0],a,i,0),b=new d.ElevationTile(w,R);r.elevationSample=new g.TileElevationSampler(b,f,void 0)}else P=new u(m),await P.load(),r.elevationSample=await P.createElevationSampler(t,n);M=e.map(x(r.elevationSample))}catch(R){if(!i.isAbortError(R)){a.getLogger("esri.layers.orientedImagery.transformations.groundToImageUtils").warn(`#updateElevation() failed to update elevation using the provided elevation source URL: ${m}. Please provide a valid elevation source url.`,R);const{location:t,cameraHeight:i,cameraOrientation:n}=r.attributes;e=z(e,n&&"number"==typeof t.z?t.z-i:0)}}finally{P?.destroy()}return M}return await o.initializeProjection(e[0].spatialReference,w.spatialReference,null,t.options),e.map(x(w))}function x(e){return t=>{t.z=1;const a=e.queryElevation(o.project(t,e.spatialReference));return a?.z&&(t.z=a.z),t}}function z(e,t){return e.map((e=>(e.z=t,e)))}function E(e,t){const{attributes:a}=t.feature;return a.isSpherical||360===a.horizontalFieldOfView?S(e,t):a.cameraOrientation?.isAdvanced?W(e,t):Promise.resolve(O(e,t))}async function S(e,t){const a=Array.isArray(e)?e:[e],i=new Array,{location:r,cameraOrientation:n,cameraHeading:o}=t.feature.attributes,c=t.imageProperties.height??1,s=t.imageProperties.width??1;return await T(r,a,o,s,c,i,n),i}async function T(e,t,a,i,r,c,u){const p=e.spatialReference.isWGS84&&4!==u?.type?l.geographicToWebMercator(e):new n(e),{latitude:f,longitude:g,ellipsoidRadius:d,squaredEccentricity:h}=u??{};for(const l of t){const e=l.spatialReference.isWGS84&&4===u?.type?new n(m.geographicToLTP(l,[f,g,d,h])):l.spatialReference.equals(p.spatialReference)?new n(l):await o.projectWithZConversion(l,p.spatialReference),t=s.distance(p,e);e.x-=p.x,e.y-=p.y,e.z=(e.z??0)-(p.z??0);const y=m.convertSphereVertexToOrientation(e,t);y.heading=(y.heading-a)%360;const{x:v,y:R}=m.convertOrientationToPixelLocation(y.heading,y.pitch,i,r);c.push(new n(v,R,w.defaultImageSphereCenter.spatialReference))}}function O(e,t){const{feature:a,imageProperties:i}=t,{width:o,height:c}=i,{attributes:s}=a,u=m.calculateRotationMatrix("HPR",[s.cameraHeading,s.cameraPitch,s.cameraRoll]),p=Math.sin(s.imageRotation??0*R),f=Math.cos(s.imageRotation??0*R),g=o??1,d=c??1,h=[Math.abs(f*g+p*d),Math.abs(f*d-p*g)],y={horizontal:1/(2*Math.tan(s.horizontalFieldOfView*R/2)),vertical:1/(2*Math.tan(s.verticalFieldOfView*R/2))},v=[-y.horizontal,0,.5,0,y.vertical,.5,0,0,1];let w=new n(s.geometry);w.spatialReference.isWGS84&&4!==s.cameraOrientation?.type&&(w=l.geographicToWebMercator(w));const b=w.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*w.y/6378137))):1,P=r.mul(new Array(9),u,v);return e.map((e=>{let t=new n(e);if(t.spatialReference.isWGS84)if(4===s.cameraOrientation?.type){const e=s.cameraOrientation;t=new n(m.geographicToLTP(t,[e.latitude,e.longitude,e.ellipsoidRadius,e.squaredEccentricity]))}else t=new n(l.geographicToWebMercator(t));const a=(t.z??0)-(w.z??0),i=(t.x-w.x)/b,r=(t.y-w.y)/b,o=(P[0]*i+P[1]*r+P[2]*a)/(P[6]*i+P[7]*r+P[8]*a),c=(P[3]*i+P[4]*r+P[5]*a)/(P[6]*i+P[7]*r+P[8]*a),u={x:o*h[0],y:c*h[1]};return{x:f*(u.x-h[0]/2)+p*(u.y-h[1]/2)+g/2,y:-p*(u.x-h[0]/2)+f*(u.y-h[1]/2)+d/2}}))}function W(e,a){const{feature:i}=a,{attributes:r}=i,c=r.cameraOrientation;if(!c)throw new t("groundToImageUtils:missing-camera-orientation-parameters","CameraOrientation Parameters are required to perform advanced transformations");let s=new n(r.location);s.spatialReference.isWGS84&&4!==r.cameraOrientation?.type&&(s=l.geographicToWebMercator(s));const u=s.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*s.y/6378137))):1;let p;if("esri.layers.orientedImagery.core.CameraOrientationOPK"===c.declaredClass){const{omega:e,phi:t,kappa:a}=c;p=m.calculateRotationMatrix("OPK",[e,t,a])}else{const{cameraHeading:e,cameraPitch:t,cameraRoll:a}=r;p=m.calculateRotationMatrix("HPR",[e,t,a])}const{principalOffsetPoint:f,focalLength:g,radialDistortionCoefficients:d,affineTransformations:h,tangentialDistortionCoefficients:y}=c;return Promise.all(e.map((async t=>{let i;return t.spatialReference.equals(s.spatialReference)?(i=new n(t),c(i)):(await o.initializeProjection(e[0].spatialReference,s.spatialReference,null,a.options),i=o.project(t,s.spatialReference),i?c(i):null);function c(e){if(e.spatialReference.isWGS84)if(4===r.cameraOrientation?.type){const t=r.cameraOrientation;e=new n(m.geographicToLTP(e,[t.latitude,t.longitude,t.ellipsoidRadius,t.squaredEccentricity]))}else e=new n(l.geographicToWebMercator(e));const t=(e.z??0)-(s.z??0),a=(e.x-s.x)/u,i=(e.y-s.y)/u,o=(p[0]*a+p[1]*i+p[2]*t)/(p[6]*a+p[7]*i+p[8]*t),c=(p[3]*a+p[4]*i+p[5]*t)/(p[6]*a+p[7]*i+p[8]*t),v=o**2+c**2;let w=0,R=0,b=0,P=0,M=0,x=0,z=0;d&&(w=d[0]??0,R=d[1]??0,b=d[2]??0),y&&(P=y[0],M=y[1]),f&&(x=f[0]??0,z=f[1]??0);const E=1+(w||0)*v+(R||0)*v*v+(b||0)*v*v*v;let S=o*E+(P||0)*(v+2*o**2)+2*(M||0)*o*c,T=c*E+(M||0)*(v+2*c**2)+2*(P||0)*o*c;S=-(g??0)*S+x,T=-(g??0)*T+z;return{x:Number(h[0])+Number(h[1])*S+Number(h[2])*T,y:Number(h[3])+Number(h[4])*S+Number(h[5])*T}}})))}e.transformPoints=b,e.transformPointsEquirectangularPanorama=S,e.updateElevation=P,e.updateElevationUsingElevationSource=M,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
