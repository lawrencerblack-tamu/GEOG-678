/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../core/mathUtils","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/libs/gl-matrix-2/math/mat4","../../../geometry/projection","../../../geometry/support/Ellipsoid","../../../geometry/support/spatialReferenceUtils","../../../widgets/PanoramicViewer/constants"],(function(t,a,n,e,s,i,h,o,r,c){"use strict";function M(t,a,n){const[e,s,i,h]=a,[o,r,c,M]=n;return u(t,e,s,i,h,o,r,c,M)}function u(t,a,n,s,h,o,r,c,M){let u=!1;0===a.z&&0===n.z&&0===s.z&&0===h.z&&(a.z=n.z=s.z=h.z=1,t.z=1),a.z=a.z??1,n.z=n.z??1,s.z=s.z??1,h.z=h.z??1,0===o.z&&0===r.z&&0===c.z&&0===M.z&&(u=!0,o.z=r.z=c.z=M.z=1),o.z=o.z??1,r.z=r.z??1,c.z=c.z??1,M.z=M.z??1;const x=z(a,n,s,h),l=z(o,r,c,M),f=i.invertOrIdentity(e.create(),x),y=e.create();y[0]=l[0]*f[0]+l[1]*f[4]+l[2]*f[8]+l[3]*f[12],y[1]=l[0]*f[1]+l[1]*f[5]+l[2]*f[9]+l[3]*f[13],y[2]=l[0]*f[2]+l[1]*f[6]+l[2]*f[10]+l[3]*f[14],y[3]=l[0]*f[3]+l[1]*f[7]+l[2]*f[11]+l[3]*f[15],y[4]=l[4]*f[0]+l[5]*f[4]+l[6]*f[8]+l[7]*f[12],y[5]=l[4]*f[1]+l[5]*f[5]+l[6]*f[9]+l[7]*f[13],y[6]=l[4]*f[2]+l[5]*f[6]+l[6]*f[10]+l[7]*f[14],y[7]=l[4]*f[3]+l[5]*f[7]+l[6]*f[11]+l[7]*f[15],y[8]=l[8]*f[0]+l[9]*f[4]+l[10]*f[8]+l[11]*f[12],y[9]=l[8]*f[1]+l[9]*f[5]+l[10]*f[9]+l[11]*f[13],y[10]=l[8]*f[2]+l[9]*f[6]+l[10]*f[10]+l[11]*f[14],y[11]=l[8]*f[3]+l[9]*f[7]+l[10]*f[11]+l[11]*f[15],y[12]=l[12]*f[0]+l[13]*f[4]+l[14]*f[8]+l[15]*f[12],y[13]=l[12]*f[1]+l[13]*f[5]+l[14]*f[9]+l[15]*f[13],y[14]=l[12]*f[2]+l[13]*f[6]+l[14]*f[10]+l[15]*f[14],y[15]=l[12]*f[3]+l[13]*f[7]+l[14]*f[11]+l[15]*f[15];const m=y[0]*t.x+y[1]*t.y+y[2]*t.z+y[3],d=y[4]*t.x+y[5]*t.y+y[6]*t.z+y[7],g=y[8]*t.x+y[9]*t.y+y[10]*t.z+y[11];let p=y[12]*t.x+y[13]*t.y+y[14]*t.z+y[15];return 0===p&&(p=1),{x:m/p,y:d/p,z:u?0:g/p}}function z(t,a,n,e){const s=y([e.x,e.y,e.z,1],i.invertOrIdentity(new Array(16),[t.x,a.x,n.x,0,t.y,a.y,n.y,0,t.z,a.z,n.z,0,1,1,1,1])),h=s[0],o=s[1],r=s[2],c=new Array(16);return c[0]=h*t.x,c[1]=o*a.x,c[2]=r*n.x,c[3]=0,c[4]=h*t.y,c[5]=o*a.y,c[6]=r*n.y,c[7]=0,c[8]=h*t.z,c[9]=o*a.z,c[10]=r*n.z,c[11]=0,c[12]=h,c[13]=o,c[14]=r,c[15]=1,c}function x(t,a,n,e,i=s.zeros()){return i[0]=t[0]+a[0]*n,i[1]=t[1]+a[1]*n,i[2]=t[2]+a[2]*(n/e),i}function l(t,a,n){const e=s.zeros();return e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*(a/n),e}function f(t,a){const[n,e,i]=t,h=s.zeros();return h[0]=n*a[0]+e*a[3]+i*a[6],h[1]=n*a[1]+e*a[4]+i*a[7],h[2]=n*a[2]+e*a[5]+i*a[8],h}function y(t,a){const[n,e,s,i]=t,h=new Array(4);return h[0]=n*a[0]+e*a[1]+s*a[2]+i*a[3],h[1]=n*a[4]+e*a[5]+s*a[6]+i*a[7],h[2]=n*a[8]+e*a[9]+s*a[10]+i*a[11],h[3]=n*a[12]+e*a[13]+s*a[14]+i*a[15],h}function m(t,a){const e=Math.PI/180,s=n.create();if("OPK"===t){const t=Number(a[0])*e,n=Number(a[1])*e,i=Number(a[2])*e;s[0]=Math.cos(n)*Math.cos(i),s[1]=Math.cos(t)*Math.sin(i)+Math.sin(t)*Math.sin(n)*Math.cos(i),s[2]=Math.sin(t)*Math.sin(i)-Math.cos(t)*Math.sin(n)*Math.cos(i),s[3]=-Math.cos(n)*Math.sin(i),s[4]=Math.cos(t)*Math.cos(i)-Math.sin(t)*Math.sin(n)*Math.sin(i),s[5]=Math.sin(t)*Math.cos(i)+Math.cos(t)*Math.sin(n)*Math.sin(i),s[6]=Math.sin(n),s[7]=-Math.sin(t)*Math.cos(n),s[8]=Math.cos(t)*Math.cos(n)}else{const t=Number(a[0])*e,n=Number(a[1])*e,i=Number(a[2])*e;s[0]=Math.cos(t)*Math.cos(i)-Math.sin(t)*Math.cos(n)*Math.sin(i),s[1]=Math.sin(t)*Math.cos(i)*-1-Math.cos(t)*Math.cos(n)*Math.sin(i),s[2]=Math.sin(i)*Math.sin(n)*-1,s[3]=Math.cos(t)*Math.sin(i)+Math.sin(t)*Math.cos(n)*Math.cos(i),s[4]=Math.sin(t)*Math.sin(i)*-1+Math.cos(t)*Math.cos(n)*Math.cos(i),s[5]=Math.cos(i)*Math.sin(n),s[6]=Math.sin(t)*Math.sin(n)*-1,s[7]=Math.cos(t)*Math.sin(n)*-1,s[8]=Math.cos(n)}return s}function d(t,a,n){const e=Math.sin(n*Math.PI/180),s=Math.cos(n*Math.PI/180),i=[[t,0],[t,a],[0,a]];i.forEach(((t,a)=>{i[a]=[s*t[0]-e*t[1],e*t[0]+s*t[1]]}));const h={xmin:Math.min(0,i[0][0],i[1][0],i[2][0]),xmax:Math.max(0,i[0][0],i[1][0],i[2][0]),ymin:Math.min(0,i[0][1],i[1][1],i[2][1]),ymax:Math.max(0,i[0][1],i[1][1],i[2][1])};return{hfov:Math.abs(h.xmax-h.xmin),vfov:Math.abs(h.ymax-h.ymin)}}function g(t,a,n,e,s,i){const h=n*(a.x-t.x)+e*(a.y-t.y)+s*(a.z-t.z);if(0===h)return null;const o=-(n*t.x+e*t.y+s*t.z+i)/h;return{x:t.x+o*(a.x-t.x),y:t.y+o*(a.y-t.y),z:t.z+o*(a.z-t.z)}}function p(t,a){const n=Math.PI/180,e=t.y*n,s=t.x*n,i=t.z||0,h=a[0]*n,o=a[1]*n,r=a[2]/Math.sqrt(1-a[3]*Math.sin(h)**2),c=s-o,M=a[2]/Math.sqrt(1-a[3]*Math.sin(e)**2),u=a[3]*(r*Math.sin(h)-M*Math.sin(e));return{x:(M+i)*Math.cos(e)*Math.sin(c),y:(M+i)*(Math.sin(e)*Math.cos(h)-Math.sin(h)*Math.cos(e)*Math.cos(c))+u*Math.cos(h),z:(M+i)*(Math.sin(e)*Math.sin(h)+Math.cos(h)*Math.cos(e)*Math.cos(c))-r+u*Math.sin(h)}}function b(t,a){const n=Math.PI/180,e=Number(t.x),s=Number(t.y),i=Number(t.z),h=a[0]*n,o=a[1]*n,r=a[2]/Math.sqrt(1-a[3]*Math.sin(h)**2),c=e/r,M=s/r,u=i/r,z=Math.cos(h)-Math.sin(h)*M+Math.cos(h)*u,x=Math.sin(h)+Math.cos(h)*M+Math.sin(h)*u,l=Math.sqrt(z**2+c**2),f=a[3]*r*Math.sin(h),y=h,m=Math.atan(x/l-(f-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(y)**2))*Math.sin(y))/(r*l)),d=Math.atan(x/l-(f-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(m)**2))*Math.sin(m))/(r*l)),g=Math.atan(x/l-(f-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(d)**2))*Math.sin(d))/(r*l)),p=Math.atan(x/l-(f-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(g)**2))*Math.sin(g))/(r*l)),b=Math.atan(e/(r*z))+o;return{x:b/n,y:p/n,z:e/(Math.cos(p)*Math.sin(b-o))-a[2]/Math.sqrt(1-a[3]*Math.sin(p)**2),spatialReference:{wkid:4326}}}function P(t){return t&&r.isWebMercator(t?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*t.y/o.earth.radius))):1}function v(t,a,n){const e=360/a,s=180/n;return{heading:(t.x-a/2)*e,pitch:90-(t.y-n/2)*s}}function I(t,a,n,e=c.defaultImageSphereSize/2){const{heading:s,pitch:i}=T(t,e);return S(s,i,a,n)}function S(t,a,n,e){return{x:n/2+t/(360/n),y:e-a/(180/e),heading:t,pitch:a}}function T(t,n){const e=a.rad2deg(Math.acos(-t.z/n));return{heading:a.rad2deg(Math.atan2(t.x,t.y)),pitch:e}}function q(t,n,e=c.defaultImageSphereSize/2){return[e*(Math.sin(a.deg2rad(t))*Math.sin(a.deg2rad(n))),e*(Math.cos(a.deg2rad(t))*Math.sin(a.deg2rad(n))),e*Math.cos(a.deg2rad(180-n))]}async function N(t,n,e){await h.initializeProjection(n.spatialReference,t.spatialReference,null,e);const s=await h.projectWithZConversion(n,t.spatialReference,e);let i=a.rad2deg(Math.atan2(s.y-t.y,s.x-t.x));return i=i>=0&&i<=90?90-i:i>90&&i<=180?360-i+90:90+Math.abs(i),i}function w(t,a,n){const e=Math.cos(n),s=Math.sin(n),i=[1,0,0,1,0,0],h=i[0]*e+i[2]*s,o=i[1]*e+i[3]*s,r=-i[0]*s+i[2]*e,c=-i[1]*s+i[3]*e;i[0]=h,i[1]=o,i[2]=r,i[3]=c;return[t*i[0]+a*i[2]+i[4],t*i[1]+a*i[3]+i[5]]}t.calculateRotationMatrix=m,t.computeHFOVAndVFOV=d,t.convertHeadingPitchToSphereVertex=q,t.convertOrientationToPixelLocation=S,t.convertPixelToHeadingPitch=v,t.convertSphereVertexToOrientation=T,t.convertSphereVertexToPixelLocation=I,t.geographicToLTP=p,t.getInitialAngle=N,t.getPlaneLineIntersectionPoint=g,t.getWebMercatorScalingFactor=P,t.linearEquationSolve=z,t.ltpToGeographic=b,t.projectiveTransform=u,t.projectiveTransform2=M,t.rotatePixel=w,t.scaleAndAddWithFactor=x,t.scaleWithFactor=l,t.transformMat3=f,t.transformMat4=y,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
