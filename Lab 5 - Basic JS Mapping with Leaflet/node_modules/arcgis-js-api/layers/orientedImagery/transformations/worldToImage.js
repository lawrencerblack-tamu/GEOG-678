/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../geometry","../../../core/mathUtils","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/math/mat3","../../../geometry/support/Ellipsoid","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils","../core/cameraOrientationFactory","./utils","../../../geometry/Point"],(function(a,t,e,r,i,o,n,c,s,l,m){"use strict";function g(a,t){const{cameraOrientation:e,cameraLocation:r,pointsToTransform:i,rotationMatrix:o,scalingFactor:n}=p(a,t),c=new Array;return e?.isAdvanced?u(i,c,o,{...t,cameraOrientation:e,scalingFactor:n,cameraLocation:r}):h(i,c,o,{...t,cameraOrientation:e,scalingFactor:n,cameraLocation:r}),1===c.length?c[0]:c}function f(a,t,e){return g(a?t.map((a=>c.webMercatorToGeographic(a))):t,e).map((a=>({...a,z:1})))}function u(a,t,e,r){const{cameraOrientation:i,cameraLocation:o,scalingFactor:n}=r,{principalOffsetPoint:c,focalLength:s,radialDistortionCoefficients:l,affineTransformations:m,tangentialDistortionCoefficients:g}=i;for(const f of a){const[a,r,u]=d(f,i,o,n),p=(e[0]*a+e[1]*r+e[2]*u)/(e[6]*a+e[7]*r+e[8]*u),h=(e[3]*a+e[4]*r+e[5]*u)/(e[6]*a+e[7]*r+e[8]*u),y=p**2+h**2;let M=0,O=0,b=0,x=0,T=0,R=0,P=0;l&&(M=l[0]??0,O=l[1]??0,b=l[2]??0),g&&(x=g[0],T=g[1]),c&&(R=c[0]??0,P=c[1]??0);const F=1+(M||0)*y+(O||0)*y*y+(b||0)*y*y*y;let w=p*F+(x||0)*(y+2*p**2)+2*(T||0)*p*h,L=h*F+(T||0)*(y+2*h**2)+2*(x||0)*p*h;w=-(s??0)*w+R,L=-(s??0)*L+P;const z=Number(m[0])+Number(m[1])*w+Number(m[2])*L,W=Number(m[3])+Number(m[4])*w+Number(m[5])*L;t.push({x:z,y:W})}}function p(a,t){const e=Array.isArray(a)||"items"in a?a:[a],r="string"==typeof t.cameraOrientation?s.getCameraOrientation(t.cameraOrientation):t.cameraOrientation,i=y({...t,cameraOrientation:r});let o=new m(t.cameraLocation);(o.spatialReference.isWGS84&&4!==r?.type||o.spatialReference.isGeographic)&&(o=c.geographicToWebMercator(o)),o.z||(o.z=t.cameraHeight);return{cameraOrientation:r,pointsToTransform:e,rotationMatrix:i,scalingFactor:M(o),cameraLocation:o}}function h(a,t,o,n){const{horizontalFieldOfView:c,verticalFieldOfView:s,cameraOrientation:l,cameraLocation:m,scalingFactor:g}=n,f=e.deg2rad(n.imageRotation??0),u=Math.sin(f),p=Math.cos(f),h=n.imageWidth||1,y=n.imageHeight||1,M=[Math.abs(p*h+u*y),Math.abs(p*y-u*h)],O={horizontal:1/(2*Math.tan(e.deg2rad(c)/2)),vertical:1/(2*Math.tan(e.deg2rad(s)/2))},b=r.create();b[0]=-O.horizontal,b[2]=.5,b[4]=O.vertical,b[5]=.5;const x=i.mul(r.create(),o,b);for(const e of a){const[a,r,i]=d(e,l,m,g),o=(x[0]*a+x[1]*r+x[2]*i)/(x[6]*a+x[7]*r+x[8]*i),n=(x[3]*a+x[4]*r+x[5]*i)/(x[6]*a+x[7]*r+x[8]*i),c={x:o*M[0],y:n*M[1]};t.push({x:p*(c.x-M[0]/2)+u*(c.y-M[1]/2)+h/2,y:-u*(c.x-M[0]/2)+p*(c.y-M[1]/2)+y/2})}}function d(a,t,e,r){let i=new m(a);if(i.spatialReference.isGeographic)if(i.spatialReference.isWGS84&&4===t?.type){const{latitude:a,longitude:e,ellipsoidRadius:r,squaredEccentricity:o}=t;i=new m(l.geographicToLTP(i,[a,e,r,o]))}else i=c.geographicToWebMercator(i);const o=(i.z??0)-(e.z??0),n=(i.y-e.y)/r;return[(i.x-e.x)/r,n,o]}function y(a){const{cameraHeading:t,cameraPitch:e,cameraRoll:r,cameraOrientation:i}=a;if("OPK"===(i?.isAdvanced&&2===i.type?"OPK":"HPR")){const{omega:a,phi:t,kappa:e}=i;return l.calculateRotationMatrix("OPK",[a,t,e])}return l.calculateRotationMatrix("HPR",[t,e,r])}function M(a){return n.isWebMercator(a?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*a.y/o.earth.radius))):1}a.getScalingFactor=M,a.worldToImage=g,a.worldToImageWithLTPFlag=f,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})}));
