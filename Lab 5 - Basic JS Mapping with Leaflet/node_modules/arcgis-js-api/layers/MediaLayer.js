/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["require","../chunks/tslib.es6","../core/Collection","../core/Error","../core/Logger","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/RandomLCG","../core/has","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/accessorSupport/PropertyOrigin","./Layer","./mixins/BlendLayer","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./support/ImageElement","./support/LocalMediaElementSource","./support/mediaUtils","./support/VideoElement","../webdoc/interfaces"],(function(e,r,t,o,a,i,s,n,c,p,d,l,u,y,h,g,f,S,_,m,w,v,O,L,b){"use strict";function E(e){return"object"==typeof e&&null!=e&&"type"in e}function I(e){return E(e)&&"image"===e.type}let A=class extends(f.BlendLayer(m.ScaleRangeLayer(S.OperationalLayer(_.PortalLayer(i.MultiOriginJSONMixin(g)))))){constructor(r){super(r),this.effectiveSource=null,this.georeference=null,this.copyright=null,this.operationalLayerType="MediaLayer",this.spatialReference=null,this.type="media",this._debouncedSaveOperations=s.debounce((async(r,t,o)=>{const{save:a,saveAs:i}=await new Promise(((r,t)=>e(["./save/mediaLayerUtils"],r,t)));switch(r){case b.SaveOperationType.SAVE:return a(this,t);case b.SaveOperationType.SAVE_AS:return i(this,o,t)}})),this.source=new v}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}async _doLoad(e){await this.loadFromPortal({supportedTypes:["Media Layer"]},e);let r=this.source;if(!r)throw new o("media-layer:source-missing","Set 'MediaLayer.source' before loading the layer.");const a=this._getSourceOverride(r,this.georeference);a&&(this.setAtOrigin("source",a,"web-map"),r=a);const i=E(r)?new v({elements:new t([r])}):r;this._set("effectiveSource",i),this.spatialReference&&(i.spatialReference=this.spatialReference),await i.load(e),this.spatialReference=i.spatialReference}destroy(){this.effectiveSource?.destroy(),this.source?.destroy()}readGeoreference(e,r){return e&&"itemId"in r&&r.itemId?e:void 0}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}set source(e){"loaded"!==this.loadStatus&&"failed"!==this.loadStatus?this._set("source",e):a.getLogger(this).error("#source","source cannot be changed after the layer is loaded.")}castSource(e){return e?Array.isArray(e)?new v({elements:new t(e)}):e instanceof t?new v({elements:e}):e:null}readSource(e,r,t){if("itemId"in r&&r.itemId)return;const o=this._createSource(r);return o?.read(r,t),o}writeSource(e,r,t,a){I(e)?e.write(r,a):a?.messages&&a?.messages?.push(new o("media-layer:unsupported-source","source must be an 'ImageElement'"))}async save(e){return this._debouncedSaveOperations(b.SaveOperationType.SAVE,e)}async saveAs(e,r){return this._debouncedSaveOperations(b.SaveOperationType.SAVE_AS,r,e)}_createSource(e){if("mediaType"in e)switch(e.mediaType){case"image":return new w;case"video":return new L}return null}_getSourceOverride(e,r){if(E(e)&&this.originIdOf("source")===h.OriginId.PORTAL_ITEM&&r&&this.originIdOf("georeference")===h.OriginId.WEB_MAP){const t=e.toJSON(),o=this._createSource(t);return o.read({...t},{origin:"portal-item"}),o.read({georeference:r},{origin:"web-map"}),o}return null}};r.__decorate([n.property({readOnly:!0})],A.prototype,"effectiveSource",void 0),r.__decorate([n.property({readOnly:!0,json:{read:!1,write:!1,origins:{"web-map":{read:!0,write:!1}}}})],A.prototype,"georeference",void 0),r.__decorate([l.reader("web-map","georeference")],A.prototype,"readGeoreference",null),r.__decorate([n.property({type:String})],A.prototype,"copyright",void 0),r.__decorate([n.property({readOnly:!0})],A.prototype,"fullExtent",null),r.__decorate([n.property({type:["MediaLayer"]})],A.prototype,"operationalLayerType",void 0),r.__decorate([n.property({type:["show","hide"]})],A.prototype,"listMode",void 0),r.__decorate([n.property({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1,overridePolicy(e,r,t){return{enabled:!0,allowNull:!1,ignoreOrigin:O.isWritingLayerFromItemToWebDocument(this,t?.origin)&&I(e)&&!!e.georeference&&e.originIdOf("georeference")>h.OriginId.PORTAL_ITEM}}}}})],A.prototype,"source",null),r.__decorate([c.cast("source")],A.prototype,"castSource",null),r.__decorate([l.reader("source",["url"])],A.prototype,"readSource",null),r.__decorate([y.writer("source")],A.prototype,"writeSource",null),r.__decorate([n.property()],A.prototype,"spatialReference",void 0),r.__decorate([n.property({readOnly:!0})],A.prototype,"type",void 0),A=r.__decorate([u.subclass("esri.layers.MediaLayer")],A);return A}));
