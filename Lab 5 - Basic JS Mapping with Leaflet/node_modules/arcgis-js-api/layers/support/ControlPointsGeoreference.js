/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../core/Accessor","../../core/Error","../../core/JSONSupport","../../core/Logger","../../core/perspectiveUtils","../../core/screenUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../core/libs/gl-matrix-2/math/mat3","../../core/libs/gl-matrix-2/factories/mat3f64","../../core/libs/gl-matrix-2/math/vec2","../../core/libs/gl-matrix-2/factories/vec2f64","../../geometry/Point","../../geometry/Polygon","../../geometry/projection","../../geometry/SpatialReference","./GeoreferenceBase"],(function(t,e,o,r,n,i,s,c,l,a,u,p,P,f,h,m,d,y,g,v,_,w){"use strict";const x=h.create(),R=d.create();let j=class extends e{constructor(){super(...arguments),this.sourcePoint=null,this.mapPoint=null}};t.__decorate([c.property()],j.prototype,"sourcePoint",void 0),t.__decorate([c.property({type:y})],j.prototype,"mapPoint",void 0),j=t.__decorate([p.subclass("esri.layers.support.ControlPoint")],j);let S=class extends(r.JSONSupportMixin(w)){constructor(t){super(t),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(t,e){const o=_.fromJSON(e.spatialReference),r=h.fromValues(...e.coefficients,1);return t.map((t=>(m.set(R,t.x,t.y),i.transformProjective(R,R,r),{sourcePoint:t,mapPoint:new y({x:R[0],y:R[1],spatialReference:o})})))}writeControlPoints(t,e,r,i){if(null!=this.transform)null!=t&&C(t[0])&&(e.controlPoints=t.map((t=>{const e=t.sourcePoint;return{x:e.x,y:e.y}})),e.spatialReference=t[0].mapPoint.spatialReference.toJSON(),e.coefficients=this.transform.slice(0,8));else{const t=new o("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:i?.layer,georeference:this});i?.messages?i.messages.push(t):n.getLogger(this).error(t.name,t.message)}}get coords(){if(null==this.controlPoints)return null;const t=this._updateTransform(x);if(null==t||!C(this.controlPoints[0]))return null;const e=this.controlPoints[0].mapPoint.spatialReference;return W(t,this.width,this.height,e)}set coords(t){if(null==this.controlPoints||!C(this.controlPoints[0]))return;const e=this.controlPoints[0].mapPoint.spatialReference;if(null==(t=this.projectOrWarn(t,e)))return;const{width:o,height:r}=this,{rings:[[n,c,l,a]]}=t,u={sourcePoint:s.createScreenPoint(0,r),mapPoint:new y({x:n[0],y:n[1],spatialReference:e})},p={sourcePoint:s.createScreenPoint(0,0),mapPoint:new y({x:c[0],y:c[1],spatialReference:e})},P={sourcePoint:s.createScreenPoint(o,0),mapPoint:new y({x:l[0],y:l[1],spatialReference:e})},f={sourcePoint:s.createScreenPoint(o,r),mapPoint:new y({x:a[0],y:a[1],spatialReference:e})};C(u)&&C(p)&&C(P)&&C(f)&&(U(x,u,p,P,f),this.controlPoints=this.controlPoints.map((({sourcePoint:t})=>(m.set(R,t.x,t.y),i.transformProjective(R,R,x),{sourcePoint:t,mapPoint:new y({x:R[0],y:R[1],spatialReference:e})}))))}get inverseTransform(){return null==this.transform?null:f.invert(h.create(),this.transform)}get transform(){return this._updateTransform()}toMap(t){if(null==t||null==this.transform||null==this.controlPoints||!C(this.controlPoints[0]))return null;m.set(R,t.x,t.y);const e=this.controlPoints[0].mapPoint.spatialReference;return i.transformProjective(R,R,this.transform),new y({x:R[0],y:R[1],spatialReference:e})}toSource(t){if(null==t||null==this.inverseTransform||null==this.controlPoints||!C(this.controlPoints[0]))return null;const e=this.controlPoints[0].mapPoint.spatialReference;return t=t.normalize(),null==(t=v.projectOrLoad(t,e).geometry)?null:(m.set(R,t.x,t.y),i.transformProjective(R,R,this.inverseTransform),s.createScreenPoint(R[0],R[1]))}toSourceNormalized(t){const e=this.toSource(t);return null!=e&&(e.x/=this.width,e.y/=this.height),e}_updateTransform(t){const{controlPoints:e,width:o,height:r}=this;if(!(null!=e&&o>0&&r>0))return null;const[n,i,s,c]=e;if(!C(n))return null;const l=n.mapPoint.spatialReference,a=this._projectControlPoint(i,l),u=this._projectControlPoint(s,l),p=this._projectControlPoint(c,l);if(!a.valid||!u.valid||!p.valid)return null;if(!C(a.controlPoint))return null;null==t&&(t=h.create());let P=null;return P=C(u.controlPoint)&&C(p.controlPoint)?U(t,n,a.controlPoint,u.controlPoint,p.controlPoint):C(u.controlPoint)?z(t,n,a.controlPoint,u.controlPoint):G(t,n,a.controlPoint),P.every((t=>0===t))?null:P}_projectControlPoint(t,e){if(!C(t))return{valid:!0,controlPoint:t};const{sourcePoint:o,mapPoint:r}=t,{geometry:i,pending:s}=v.projectOrLoad(r,e);return s?{valid:!1,controlPoint:null}:s||i?{valid:!0,controlPoint:{sourcePoint:o,mapPoint:i}}:(n.getLogger(this).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:t,sourceSpatialReference:r.spatialReference,targetSpatialReference:e}),{valid:!1,controlPoint:null})}};function C(t){return null!=t?.sourcePoint&&null!=t.mapPoint}t.__decorate([c.property({type:[j],json:{write:{allowNull:!1,isRequired:!0}}})],S.prototype,"controlPoints",void 0),t.__decorate([u.reader("controlPoints")],S.prototype,"readControlPoints",null),t.__decorate([P.writer("controlPoints")],S.prototype,"writeControlPoints",null),t.__decorate([c.property()],S.prototype,"coords",null),t.__decorate([c.property({json:{write:!0}})],S.prototype,"height",void 0),t.__decorate([c.property({readOnly:!0})],S.prototype,"inverseTransform",null),t.__decorate([c.property({readOnly:!0})],S.prototype,"transform",null),t.__decorate([c.property({json:{write:!0}})],S.prototype,"width",void 0),S=t.__decorate([p.subclass("esri.layers.support.ControlPointsGeoreference")],S);const b=d.create(),O=d.create(),T=d.create(),L=d.create(),N=d.create(),M=d.create(),V=d.create(),I=d.create(),J=Math.PI/2;function A(t,e,o){m.set(t,o.sourcePoint.x,o.sourcePoint.y),m.set(e,o.mapPoint.x,o.mapPoint.y)}function G(t,e,o){return A(b,N,e),A(O,M,o),m.rotate(T,O,b,J),m.rotate(L,b,O,J),m.rotate(V,M,N,-J),m.rotate(I,N,M,-J),E(t,b,O,T,L,N,M,V,I)}function z(t,e,o,r){return A(b,N,e),A(O,M,o),A(T,V,r),m.lerp(L,b,O,.5),m.rotate(L,T,L,Math.PI),m.lerp(I,N,M,.5),m.rotate(I,V,I,Math.PI),E(t,b,O,T,L,N,M,V,I)}function U(t,e,o,r,n){return A(b,N,e),A(O,M,o),A(T,V,r),A(L,I,n),E(t,b,O,T,L,N,M,V,I)}const k=new Array(8).fill(0),q=new Array(8).fill(0);function B(t,e,o,r,n){return t[0]=e[0],t[1]=e[1],t[2]=o[0],t[3]=o[1],t[4]=r[0],t[5]=r[1],t[6]=n[0],t[7]=n[1],t}function E(t,e,o,r,n,s,c,l,a){return i.getProjectiveTransform(t,B(k,e,o,r,n),B(q,s,c,l,a))}function W(t,e,o,r){const n=d.fromValues(0,o),s=d.fromValues(0,0),c=d.fromValues(e,0),l=d.fromValues(e,o);return i.transformProjective(n,n,t),i.transformProjective(s,s,t),i.transformProjective(c,c,t),i.transformProjective(l,l,t),new g({rings:[[n,s,c,l,n]],spatialReference:r})}return S}));
