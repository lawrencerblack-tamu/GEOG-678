/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../core/has","../../../core/jsonMap","../PixelBlock","./mirror"],(function(t,e,o,n,s){"use strict";const i=new o.JSONMap({1:"min",2:"max",3:"mean",4:"stddev",5:"median",6:"majority",7:"minority"},{useNumericKeys:!0});function r(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:i,mask:r,outBand:l}=t;if(o&&!r)return void l.set(n);const{statisticsType:a,kernelRows:c,kernelCols:f}=e,h="stddev"===a,u=s*i,d=new Float64Array(u),m=new Float64Array(u),y=new Uint32Array(u);for(let A=0;A<i;A++){const t=A*s;let e=0,o=0,i=0;for(let s=0;s<f;s++)r&&!r[t+s]||(e+=n[t+s],h&&(o+=n[t+s]**2),i++);d[t]=e,m[t]=o,y[t]=i;for(let l=1;l<=s-f;l++){const s=t+l-1,a=s+f;r?(r[s]&&(i--,e-=n[s],h&&(o-=n[s]**2)),r[a]&&(i++,e+=n[a],h&&(o+=n[a]**2))):(e-=n[s],e+=n[a],h&&(o-=n[s]**2,o+=n[a]**2)),d[t+l]=e,y[t+l]=i,h&&(m[t+l]=o)}}const k=new Float64Array(u),p=new Float64Array(u),w=new Uint32Array(u),M=c*s;for(let A=0;A<=s-f;A++){let t=0,e=0,o=0;for(let n=0;n<c;n++){const i=n*s+A;t+=d[i],o+=y[i],h&&(e+=m[i])}k[A]=t,p[A]=e,w[A]=o;for(let n=1;n<=i-c;n++){const i=(n-1)*s+A,r=i+M;t-=d[i],t+=d[r],o-=y[i],o+=y[r],h&&(e-=m[i],e+=m[r]),k[n*s+A]=t,p[n*s+A]=e,w[n*s+A]=o}}const g=Math.floor(c/2),b=Math.floor(f/2);for(let A=g;A<i-g;A++){const t=A*s;for(let e=b;e<s-b;e++){const n=(A-g)*s+e-b,i=w[n];if(0===i||o&&(!r||r[t+e]))continue;const a=k[n]/i,c=h?Math.sqrt((p[n]-k[n]*a)/i):a;l[t+e]=c,r&&(r[t+e]=255)}}}function l(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:i,mask:r,outBand:l}=t;if(o&&!r)return void l.set(n);const{kernelRows:a,kernelCols:c,statisticsType:f}=e,h=Math.floor(a/2),u=Math.floor(c/2),d="min"===f,m=l.slice(),y=new Uint32Array(s*i);for(let k=h;k<i-h;k++){const t=k*s;for(let e=u;e<s-u;e++){let o=d?Number.MAX_VALUE:-Number.MAX_VALUE,i=0;for(let l=0;l<a;l++)for(let a=0;a<c;a++){const c=t+e+(l-h)*s+a-u;r&&!r[c]||(o=d?Math.min(o,n[c]):Math.max(o,n[c]),i++)}r?(m[t+e]=0===i?0:o,y[t+e]=i):l[t+e]=0===i?0:o}}if(r)for(let k=h;k<i-h;k++){const t=k*s;for(let e=u;e<s-u;e++)if(y[t+e]){if(o&&r[t+e])continue;l[t+e]=m[t+e],r[t+e]=255}}}function a(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:i,mask:r,outBand:l}=t;if(o&&!r)return void l.set(n);const{kernelRows:a,kernelCols:c}=e,f=Math.floor(a/2),h=Math.floor(c/2),u=l.slice(),d=new Uint32Array(s*i);for(let m=f;m<i-f;m++){const t=m*s;for(let e=h;e<s-h;e++){if(o&&r&&r[t+e])continue;const i=[];for(let o=0;o<a;o++)for(let l=0;l<c;l++){const a=t+e+(o-f)*s+l-h;r&&!r[a]||i.push(n[a])}i.length&&(i.sort(((t,e)=>t-e)),r?(u[t+e]=i[Math.floor((i.length-1)/2)],d[t+e]=i.length):l[t+e]=i[Math.floor((i.length-1)/2)])}}if(r)for(let m=f;m<i-f;m++){const t=m*s;for(let e=h;e<s-h;e++)if(d[t+e]){if(o&&r[t+e])continue;l[t+e]=u[t+e],r[t+e]=255}}}function c(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:i,mask:r,outBand:l}=t;if(o&&!r)return void l.set(n);const{kernelRows:a,kernelCols:c}=e,f=Math.floor(a/2),h=Math.floor(c/2),u="majority"===e.statisticsType,d=a*c,m=l.slice(),y=new Uint32Array(s*i);for(let k=f;k<i-f;k++){const t=k*s;for(let e=h;e<s-h;e++){if(o&&r&&r[t+e])continue;const i=new Map;for(let o=0;o<a;o++)for(let l=0;l<c;l++){const a=t+e+(o-f)*s+l-h;if(r&&!r[a])continue;const c=n[a];i.set(c,i.has(c)?i.get(c)+1:1)}if(0===i.size)continue;let k=0,p=0,w=u?0:d+1;for(const t of i.keys())p=i.get(t),u===p>w&&(w=p,k=t);r?(m[t+e]=k,y[t+e]=i.size):l[t+e]=k}}if(r)for(let k=f;k<i-f;k++){const t=k*s;for(let e=h;e<s-h;e++)if(y[t+e]){if(o&&r[t+e])continue;l[t+e]=m[t+e],r[t+e]=255}}}function f(t,e){const{mask:o}=t,{fillNoDataOnly:i}=e;if(i&&!o)return t;const{pixels:f,width:h,height:u,bandMasks:d,pixelType:m}=t,y=f.length,k=h*u,p=[],{kernelRows:w,kernelCols:M,statisticsType:g,mirrorEdges:b}=e;if(i&&!o)return t;const A=e.outputPixelType??m,x=[];for(let v=0;v<y;v++){const t=f[v],m=n.createEmptyBand(A,k);i&&m.set(t);const y=d?.[v]??o,N=y?.slice()??null,T={band:t,width:h,height:u,mask:N,outBand:m};switch(g){case"min":case"max":l(T,e);break;case"mean":case"stddev":r(T,e);break;case"median":a(T,e);break;case"majority":case"minority":c(T,e)}b&&!i&&s.mirror(m,h,u,w,M),p.push(m),N&&x.push(N)}let N=x[0]??o;x.length!==y&&(x.length=0),y>1&&d?.length&&(N=n.combineBandMasks(d));const T=new n({pixelType:A,width:h,height:u,pixels:p,bandMasks:d&&x.length?x:null,mask:N});return T.updateStatistics(),T}t.computeFocalStatistics=f,t.statisticsTypeMap=i,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
