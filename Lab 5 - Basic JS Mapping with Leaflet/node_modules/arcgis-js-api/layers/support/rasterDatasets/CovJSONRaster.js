/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../../chunks/tslib.es6","../../../core/Error","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./BaseRaster","./covJSONParser","./InMemoryRaster","../rasterFunctions/stretchUtils","../../../rest/support/FeatureSet"],(function(e,t,s,r,a,i,o,n,c,l,p,d){"use strict";let h=class extends n{constructor(){super(...arguments),this.datasetFormat="CovJSON"}async open(e){await this.init();const{extent:t,pixelBlocks:s,multidimensionalInfo:r,attributeTable:a,bandNames:i}=await this._fetchData(e),{statistics:o,histograms:n}=p.computeStatisticsHistograms(s[0]),c=i?.map((e=>({BandName:e}))),h={DataType:a?"Thematic":r?"Scientific":"Generic",BandProperties:c},u=new l({source:{extent:t,pixelBlocks:s,attributeTable:a?d.fromJSON(a):null,multidimensionalInfo:r,statistics:o,histograms:n,keyProperties:h,isPseudoSpatialReference:!1}});await u.open(),this._inMemoryRaster=u;const g=this.source?"":this.url.slice(this.url.lastIndexOf("/")+1);this._set("datasetName",g.slice(0,g.indexOf("."))),this._set("rasterInfo",u.rasterInfo)}fetchRawTile(e,t,s,r={}){return this._inMemoryRaster.fetchRawTile(e,t,s,r)}async _fetchData(e){const s=this.source??(await this.request(this.url,{signal:e?.signal})).data,r="imagery-tile-layer:open-coverage-json";if("coverage"!==s.type?.toLowerCase()||"grid"!==s.domain?.domainType?.toLowerCase())throw new t(r,"Only coverage with Grid domain type is supported");if(!s.ranges)throw new t(r,"Missing ranges in the grid coverage data");if(!s.domain.referencing?.length)throw new t(r,"Missing domain referencing in the grid coverage data");const a=Object.values(s.ranges);for(let i=0;i<a.length;i++){const{axisNames:e,shape:s,type:o,values:n}=a[i];if(!("ndarray"===o.toLowerCase()&&n?.length&&e?.length&&s?.length))throw new t(r,"Only ranges with valid NdArray, axisNames, shape, and inline values are supported");if(!(c.isXAxis(e[e.length-1])&&c.isYAxis(e[e.length-2])))throw new t(r,"Only row-major ordered pixel values are supported. X axis must be the last axis.")}return c.parseGridCoverage(s)}};e.__decorate([s.property({type:String,json:{write:!0}})],h.prototype,"datasetFormat",void 0),e.__decorate([s.property({constructOnly:!0})],h.prototype,"source",void 0),h=e.__decorate([o.subclass("esri.layers.support.rasterDatasets.CovJSONRaster")],h);return h}));
