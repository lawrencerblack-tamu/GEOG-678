/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../Color","../../../geometry","../../../geometry/Extent","../../../intl/locale","../PixelBlock","../rasterFormats/pixelRangeUtils","../../../geometry/SpatialReference"],(function(e,t,n,l,s,a,i,r){"use strict";function o(e){return["x","e","east","long","longitude"].includes(e.toLowerCase())}function u(e){return["y","n","west","lat","latitude"].includes(e.toLowerCase())}function c(e){const{axes:t}=e.domain,n=Object.keys(t),s=[],a=[];let i=-1,c=-1,d=[];for(let l=0;l<n.length;l++){const e=n[l];o(e)?i=l:u(e)&&(c=l);const r=t[e],m=[];if("values"in r){r.values.forEach((e=>m.push("string"==typeof e?new Date(e).getTime():e)));const e=m[1]-m[0];s.push([m[0]-.5*e,m[m.length-1]+.5*e]),a.push(e)}else{const{start:e,stop:t,num:n}=r,l=(t-e)/(n-1);s.push([e-.5*l,t+.5*l]),a.push(l);for(let s=0;s<n;s++)m.push(e+l*s)}d.push({name:e,values:m,extent:[m[0],m[m.length-1]]})}i>-1&&-1===c?c=0===i?1:0:c>-1&&-1===i?i=0===c?1:0:-1===c&&-1===i&&(i=0,c=1),d=d.filter(((e,t)=>!(t===i||t===c)));const{referencing:m}=e.domain,f=m.find((e=>e.coordinates.includes(n[i]))).system.id,p=f?.slice(f.lastIndexOf("/")+1),g=null==p||"CRS84"===p?4326:Number(p),h=new r({wkid:g}),[b,y]=s[i],[x,v]=s[c],T=new l({xmin:b,xmax:y,ymin:x,ymax:v,spatialReference:h});return{width:Math.round(T.width/a[i]),height:Math.round(T.height/a[c]),extent:T,dimensions:d}}function d(e){const t=s.getLanguage();return t?e[t]??Object.values(e)[0]:Object.values(e)[0]}function m(){return Math.round(255*Math.random())}function f(e){const n={},{parameters:l}=e;if(!l)return n;for(const[s,a]of Object.entries(l)){const{type:e,description:l,unit:i,categoryEncoding:r,observedProperty:o}=a;if("Parameter"===e&&(n[s]={},l&&(n[s].description=d(l)),i&&(n[s].unit=i.label?d(i.label):null,n[s].symbol=i.symbol?.value),r)){const e=Object.entries(r).map(((e,t)=>({OID:t,Value:Number(e[1]),ClassName:e[0].slice(e[0].lastIndexOf("/")+1),Count:1})));let l=!1;o?.categories?.length&&(o.categories.forEach((n=>{if(!n.id)return;const s=n.id.slice(n.id.lastIndexOf("/")+1),a=e.find((e=>e.ClassName===s));if(!a)return;const i=n.label?d(n.label):null;if(a.Label=i,n.preferredColor){const e=t.fromHex(n.preferredColor);e&&(l=!0,a.Red=e.r,a.Green=e.g,a.Blue=e.b)}})),l&&e.forEach((e=>{null==e.Red&&(e.Red=m(),e.Green=m(),e.Blue=m())})));const a={objectIdFieldName:"",fields:[{name:"OID",type:"esriFieldTypeOID",alias:"OID",domain:null},{name:"Value",type:"esriFieldTypeInteger",alias:"Value",domain:null},{name:"Count",type:"esriFieldTypeDouble",alias:"Count",domain:null},{name:"ClassName",type:"esriFieldTypeString",alias:"ClassName",domain:null,length:50},{name:"Label",type:"esriFieldTypeString",alias:"Label",domain:null,length:50}],features:e.map((e=>({attributes:e})))};l&&a.fields.push({name:"Red",type:"esriFieldTypeInteger",alias:"Red",domain:null},{name:"Green",type:"esriFieldTypeInteger",alias:"Green",domain:null},{name:"Blue",type:"esriFieldTypeInteger",alias:"Blue",domain:null}),n[s].attributeTable=a}}return n}function p(e){let t=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let l=0;l<e.length;l++){const s=e[l];null!=s&&(s<t&&(t=s),s>n&&(n=s))}return i.getIntegerPixelType(t,n)}function g(e,t,n){const l=e.map(((e,n)=>({name:e,count:t[n]}))).sort(((e,t)=>e.name>t.name?-1:1)),s=(a=1,e=>a*=e.count);var a;const i=[...l.slice(1),{name:"",count:1}].reverse().map(s).reverse();let r=0;for(let o=e.length-1;o>=0;o--){r+=i[l.findIndex((({name:t})=>t===e[o]))]*(n%t[o]),n=Math.floor(n/t[o])}return r}function h(e){const{width:t,height:n,extent:l,dimensions:s}=c(e),{ranges:i}=e,r=Object.keys(i).sort(((e,t)=>e<t?-1:1)),o=[];for(let a=0;a<r.length;a++){const e=r[a];s?.length&&o.push({name:e,dimensions:s})}const u=f(e);o.forEach((e=>u[e.name]&&Object.assign(e,u[e.name])));const d=o.length?{variables:o}:void 0,m=[];for(let c=0;c<r.length;c++){const e=r[c],{values:l,dataType:o,axisNames:u,shape:d}=i[e],f=d.length>2?c*d.slice(0,-2).reduce(((e,t)=>e*t)):0,h=u.slice(0,-2),b=d.slice(0,-2),y="float"===o?"f32":p(l),x=t*n,v=l.length/x;for(let i=0;i<v;i++){const e=a.createEmptyBand(y,x),r=new Uint8Array(x).fill(255);let o=!1;const u=i*x;for(let t=0;t<x;t++){const n=l[u+t];null==n?(r[t]=0,o=!0):e[t]=n}if(0===c||s?.length){const l=new a({width:t,height:n,mask:o?r:null,pixels:[e],pixelType:y});if(l.updateStatistics(),s?.length){m[g(h,b,i)+f]=l}else m.push(l)}else{const t=m[i];t.pixels.push(e),o?t.mask&&(t.mask=a.combineBandMasks([t.mask,r])):t.mask=o?r:null}}}const h=Object.values(u).find((e=>e.attributeTable))?.attributeTable;return{extent:l,pixelBlocks:m,multidimensionalInfo:d,attributeTable:h,bandNames:d?void 0:r}}e.isXAxis=o,e.isYAxis=u,e.parseGridCoverage=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
