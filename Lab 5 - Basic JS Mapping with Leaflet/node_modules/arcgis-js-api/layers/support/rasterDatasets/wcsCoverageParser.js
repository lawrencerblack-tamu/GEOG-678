/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../../geometry/Extent","../../../geometry/Polygon","../../ogc/crsUtils","../RasterInfo","./xmlUtilities"],(function(e,t,n,i,a,l){"use strict";function s(e){return{requestResponseCRSs:l.getElementValues(e,"requestResponseCRSs").map((e=>e.split(":")[1])),nativeCRSs:l.getElementValues(e,"nativeCRSs").map((e=>e.split(":")[1]))}}function o(e,t){const n="1.0.0"===t?"interpolationMethod":"InterpolationMethod",i=l.getElementValues(e,n),a="1.0.0"===t?e.getAttribute("default"):l.getElementValue(e,"InterpolationMethods/Default");return null!=a?[a].concat(i.filter((e=>e.toLowerCase()!==a.toLowerCase()))):i}function r(e){return null==e?["nearest"]:e.map((e=>{const t=e.toLowerCase();return t.includes("nearest")?"nearest":t.includes("linear")?"bilinear":t.includes("cubic")?"cubic":null})).filter((e=>!!e))}function m(e){const n=l.getElements(e,"pos"),i=l.getSpaceDelimitedNumericValues(n[0]),a=l.getSpaceDelimitedNumericValues(n[1]);return new t({xmin:i[0],ymin:i[1],xmax:a[0],ymax:a[1],spatialReference:{wkid:4326}})}function u(e,t){const n=l.getElementValues(e,t);return n?.length&&""!==n[0]&&!isNaN(Number(n[0]))?n.map((e=>Number(e))):null}function g(e){const t=l.getSpaceDelimitedNumericValues(e,"MinimumValue"),n=l.getSpaceDelimitedNumericValues(e,"MaximumValue");return t.length&&n.length?t.map(((e,t)=>({min:e,max:n[t],avg:-1,stddev:-1}))):null}function p(e){return null==e?null:e.every((t=>t===e[0]))?e[0]:e}function c(e){const t=[],n=l.getElements(e,"RangeSet");let i=[];for(let a=0;a<n.length;a++){const e=l.getElementValue(n[a],"name"),s=l.getElementValue(n[a],"label"),o=[],r=u(n[a],"nullValues/singleValue"),m=l.getElements(n[a],"AxisDescription");for(let t=0;t<m.length;t++){const e=l.getElementValue(m[t],"name"),n=l.getElementValue(m[t],"label"),a=l.getElementValues(m[t],"singleValue");if(0===a.length){const e=l.getElementValue(m[t],"min"),n=l.getElementValue(m[t],"max"),i=Number(l.getElementValue(m[t],"res"))||1;if(null!==e&&null!==n)for(let t=parseInt(e,10);t<=parseInt(n,10);t+=i)a.push(t.toString())}"band"===e.toLowerCase()&&(i=a),o.push({name:e,label:n,values:a})}t.push({name:e,label:s,nullValues:r,axis:o})}return{rangeSet:t,bandNames:i}}function d(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const n=["Y","M","D"],i=["H","M","S"],a=["Years","Months","Days","Hours","Minutes","Seconds"];let l,s,o;return t.includes("PT")?(t=t.slice(2),o=i.findIndex((e=>t.includes(e))),l=a[3+o],s=parseFloat(t.substring(0,t.length-1))):(t=t.slice(1),o=n.findIndex((e=>t.includes(e))),o>-1&&(l=a[o]),s=parseFloat(t.substring(0,t.length-1))),{resolution:s,units:l}}function f(e){const t=l.getElements(e,"timeposition");if(t.length>0){const e=[];for(let n=0;n<t.length;n++)e.push(new Date(l.getElementValue(t[n])));return{begin:e[0],end:e[e.length-1],values:e}}const n=l.getElement(e,"timePeriod")||l.getElement(e,"TimePeriod");if(n){return{begin:new Date(l.getElementValue(n,"beginPosition")||l.getElementValue(n,"BeginPosition")),end:new Date(l.getElementValue(n,"endPosition")||l.getElementValue(n,"EndPosition")),...d(l.getElementValue(n,"timeResolution")||l.getElementValue(n,"TimeResolution"))}}return null}function h(e){const n=l.getElement(e,"spatialDomain"),i=l.getElement(n,"Envelope")||l.getElement(n,"EnvelopeWithTimePeriod"),a=i.getAttribute("srsName").split(":"),s=a[a.length-1],o=l.getElements(i,"pos"),r=l.getSpaceDelimitedNumericValues(o[0]),m=l.getSpaceDelimitedNumericValues(o[1]),u=parseInt(s,10),g=isNaN(u)?null:{wkid:u},p=new t({xmin:r[0],ymin:r[1],xmax:m[0],ymax:m[1],spatialReference:g}),c=l.getElement(n,"RectifiedGrid"),d=l.getElementValue(c,"low").split(" "),h=l.getElementValue(c,"high").split(" "),E=parseInt(h[0],10)-parseInt(d[0],10)+1,b=parseInt(h[1],10)-parseInt(d[1],10)+1,S=l.getSpaceDelimitedNumericValues(n,"origin/pos"),x=l.getElements(n,"offsetVector"),V={envelope:p,columns:E,rows:b,offset:{x:parseFloat(l.getElementValue(x[0]).split(" ")[0]),y:parseFloat(l.getElementValue(x[1]).split(" ")[1])},origin:{x:S[0],y:S[1]}},v=l.getElement(e,"temporalDomain")||l.getElement(e,"TemporalDomain");return{spatialDomain:V,temporalDomain:v?f(v):null}}function E(e){const t={version:"1.0"};let n,i=[];for(let a=0;a<e.childNodes.length;a++){const r=e.childNodes[a];if(1===r.nodeType)if(l.isSameTagIgnoreNS(r,"description"))t.description=l.getElementValue(r);else if(l.isSameTagIgnoreNS(r,"name"))t.name=l.getElementValue(r);else if(l.isSameTagIgnoreNS(r,"label"))t.label=l.getElementValue(r);else if(l.isSameTagIgnoreNS(r,"supportedFormats"))t.supportedFormats=l.getElementValues(r,"formats");else if(l.isSameTagIgnoreNS(r,"supportedCRSs"))t.supportedCRSs=s(r);else if(l.isSameTagIgnoreNS(r,"supportedInterpolations"))t.supportedInterpolations=o(r,"1.0.0");else if(l.isSameTagIgnoreNS(r,"lonLatEnvelope"))t.lonLatEnvelope=m(r);else if(l.isSameTagIgnoreNS(r,"rangeSet")){const e=c(r);t.rangeSet=e.rangeSet,i=e.bandNames;const a=e.rangeSet[0].nullValues;a?.length&&(n=p(a))}else l.isSameTagIgnoreNS(r,"domainSet")&&(t.domainSet=h(r))}const u=r(t.supportedInterpolations),{name:g,description:d,label:f,lonLatEnvelope:E,supportedFormats:S}=t,{spatialDomain:x}=t.domainSet,V={x:Math.abs(x.offset.x),y:Math.abs(x.offset.y)},v=b(t.domainSet),D=new a({width:x.columns,height:x.rows,pixelSize:V,extent:x.envelope,spatialReference:x.envelope.spatialReference,bandCount:i.length||1,noDataValue:n,multidimensionalInfo:v});return{id:g,title:t.name,description:d||f,lonLatEnvelope:E,rasterInfo:D,bandNames:i,supportedFormats:S,supportedInterpolations:u,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}function b(e){if(!e.temporalDomain)return null;const{begin:t,end:n,values:i,units:a,resolution:l}=e.temporalDomain;return{variables:[{name:"default",description:"",dimensions:[{name:"StdTime",description:"",unit:"ISO8601",values:i?.map((e=>e.getTime())),hasRegularIntervals:!i,interval:l,intervalUnit:a,extent:[t.getTime(),n.getTime()]}]}]}}function S(e,t){const n=[],i=l.getElements(e,"Field");let a,s=[];for(let r=0;r<i.length;r++){const e=l.getElementValue(i[r],"Identifier"),m=l.getElementValue(i[r],"Description"),p=l.getElementValue(i[r],"Definition"),c=l.getElementValue(i[r],"Abstract"),d=l.getElementValue(i[r],"Title"),f=u(i[r],"NullValue"),h=l.getElement(i[r],"AllowedValues"),E=h?g(h):null,b=o(i[r],"1.1.0"),S=[],x=l.getElements(i[r],"Axis");for(let n=0;n<x.length;n++){const e=x[n].getAttribute("identifier"),i=l.getElementValue(x[n],"UOM"),o=l.getElementValue(x[n],"DataType"),r=l.getElementValues(x[n],"Key");t&&!e.toLowerCase().includes("band")||(s=r,a=f),S.push({identifier:e,uom:i,dataType:o,values:r,bandNoDataValues:a})}n.push({identifier:e,description:m,definition:p,abstract:c,title:d,supportedInterpolations:b,axis:S,nullValues:f,statistics:E})}return{rangeSet:n,bandNames:s,bandNoDataValues:a,statistics:n[0].statistics}}function x(e,t){if(!t.temporalDomain)return null;const n=e.filter((e=>!e.identifier.toLowerCase().includes("field_1")&&!e.axis.some((e=>e.identifier.includes("band"))))),i=[];if(n.length&&n.forEach((e=>{const t=e.axis.map((e=>{const t=e.values.map((t=>{if("ISO8601"===e.uom){return(t=t.trim()).toLowerCase().includes("z")?new Date(t).getTime():new Date(t+"Z").getTime()}return parseFloat(t.trim())})),n=[Math.min.apply(null,t),Math.max.apply(null,t)];return{name:e.identifier.trim(),description:"",field:e.identifier.trim(),unit:e.uom?e.uom.trim():"",hasRegularIntervals:!1,values:t,extent:n}}));i.push({name:e.identifier.trim(),description:e.description?.trim()??"",unit:"",dimensions:t,statistics:e.statistics})})),t.temporalDomain){const{begin:e,end:n,values:a,units:l,resolution:s}=t.temporalDomain;i.some((e=>e.dimensions.some((e=>"stdtime"===e.name.toLowerCase()))))||i.forEach((t=>{t.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:a?.map((e=>e.getTime())),hasRegularIntervals:!a,interval:s,intervalUnit:l,extent:[e.getTime(),n.getTime()]})}))}return i.length?{variables:i}:null}function V(e){const n=l.getElement(e,"SpatialDomain"),a=l.getElement(n,"GridCRS"),s=l.getElementValue(a,"GridBaseCRS"),o=l.getElementValue(a,"GridOrigin"),r=o?.split(" ").map((e=>parseFloat(e)))??[0,0],m=l.getSpaceDelimitedNumericValues(a,"GridOffsets"),u=l.getElements(n,"BoundingBox");let g,p,c,d;for(let i=0;i<u.length;i++){const e=u[i].getAttribute("crs")?.toLowerCase();if(null!=e)if(e.includes("imagecrs")){const e=l.getSpaceDelimitedNumericValues(u[i],"LowerCorner"),t=l.getSpaceDelimitedNumericValues(u[i],"UpperCorner");g=t[0]-e[0]+1,p=t[1]-e[1]+1}else if(e.indexOf("epsg")>0){const n=e.split(":");c=parseInt(n[n.length-1],10);const a=l.getSpaceDelimitedNumericValues(u[i],"LowerCorner"),s=l.getSpaceDelimitedNumericValues(u[i],"UpperCorner");d=new t({xmin:a[0],ymin:a[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:c}})}}const h=g>p,E=d.xmax-d.xmin>d.ymax-d.ymin;let b=!1;i.isAxesOrderReversedForWkid(c)&&(h===E?b=!1:(b=!0,d=new t({xmin:d.ymin,ymin:d.xmin,xmax:d.ymax,ymax:d.xmax,spatialReference:{wkid:c}})));const S={columns:g,rows:p,origin:{x:r[0],y:r[1]},offset:{x:m[0],y:m[m.length-1]},gridBaseCRS:s,envelope:d,useEPSGAxis:b},x=l.getElement(e,"temporalDomain")||l.getElement(e,"TemporalDomain");return{spatialDomain:S,temporalDomain:x?f(x):null}}function v(e,t){const n=[],i=[],s={supportedFormats:n,supportedCRSs:i,version:"1.1"};let o,m,u=[];for(let a=0;a<e.childNodes.length;a++){const t=e.childNodes[a];if(1!==t.nodeType)continue;const r=l.getNodeNameIgnoreNS(t).toLowerCase();switch(r){case"title":case"abstract":case"identifier":s[r]=l.getElementValue(t);break;case"supportedformat":{const e=l.getElementValue(t);n.includes(e)||n.push(e)}break;case"supportedcrs":{const e=l.getElementValue(t);i.includes(e)||i.push(e)}break;case"range":{const e=S(t,!!s.domain?.temporalDomain);s.range=e.rangeSet,u=e.bandNames;const{bandNoDataValues:n}=e;n?.length&&(o=p(n)),m=e.statistics}break;case"domain":s.domain=V(t)}}const g=r(s.range[0].supportedInterpolations),{identifier:c,abstract:d,title:f,domain:h,range:E}=s,b={x:Math.abs(h.spatialDomain.offset.x),y:Math.abs(h.spatialDomain.offset.y)},v=x(E,h);v&&(o=E[0].nullValues,1===o?.length&&(o=o[0]));const D=new a({width:h.spatialDomain.columns,height:h.spatialDomain.rows,pixelSize:b,extent:h.spatialDomain.envelope,spatialReference:h.spatialDomain.envelope.spatialReference,bandCount:u.length||1,noDataValue:o,statistics:m,multidimensionalInfo:v});return{id:c,title:s.title,description:d||f,lonLatEnvelope:null,bandNames:u,rasterInfo:D,supportedFormats:n,supportedInterpolations:g,coverageDescription:s,version:t,useEPSGAxis:h.spatialDomain.useEPSGAxis}}function D(e){const n=l.getElement(e,"Envelope")||l.getElement(e,"EnvelopeWithTimePeriod"),i=n.getAttribute("srsName"),a=i.slice(i.lastIndexOf("/")+1),s=n.getAttribute("axisLabels").split(" ").map((e=>e.trim())).filter((e=>""!==e.trim())),o=l.getSpaceDelimitedNumericValues(n,"lowerCorner"),r=l.getSpaceDelimitedNumericValues(n,"upperCorner"),m=!["y","lat","latitude","north","nor","n","b"].includes(s[0].toLowerCase());let u;const g=parseInt(a,10),p=isNaN(g)?null:{wkid:g};u=new t(m?{xmin:o[0],ymin:o[1],xmax:r[0],ymax:r[1],spatialReference:p}:{xmin:o[1],ymin:o[0],xmax:r[1],ymax:r[0],spatialReference:p});const c={mins:o,maxs:r},d=n.getAttribute("uomLabels").trim().split(" ");let f,h;if(l.isSameTagIgnoreNS(n,"EnvelopeWithTimePeriod")){f=new Date(l.getElementValue(e,"beginPosition")||l.getElementValue(e,"BeginPosition")),h=new Date(l.getElementValue(e,"endPosition")||l.getElementValue(e,"EndPosition"));const t=d?.findIndex((e=>"oledatetime"===e?.toLowerCase()));t>-1&&(d[t]="ISO8601")}return{envelope:u,axisLabels:s,uomLabels:d.length?d:null,envelopeAllDims:c,beginPosition:f,endPosition:h,isEastFirst:m}}function N(e,t){const n=[],i=l.getElements(e,"DataRecord"),a=[];let s,o=[];for(let r=0;r<i.length;r++){const e=l.getElements(i[r],"field"),m=[];for(let n=0;n<e.length;n++){const i=e[n].getAttribute("name"),r=l.getElementValue(e[n],"description")||"",g=l.getElement(e[n],"uom")?.getAttribute("code")||"",p=l.getSpaceDelimitedNumericValues(e[n],"interval"),c=u(e[n],"nilValue")?.[0];t&&!i.toLowerCase().includes("band")||(a.push(i),p?.length&&(s=s||[],s.push({min:p[0],max:p[1],avg:-1,stddev:-1})),o.push(c)),m.push({name:i,description:r,uom:g,allowedValues:p,nilValue:c})}n.push(m)}return o.some((e=>null!=e))||(o=null),{rangeType:n,bandNames:a,bandStats:s,bandNoDataValues:o}}function y(e){let t=1,n="";const i=.01;return Math.abs(e-1/24)<1/24*i?n="Hours":Math.abs(e-1)<1*i?n="Days":e<1?(t=Math.round(24*e),n="Hours"):e>28-i&&e<31+i||Math.round(e/30)<12?n="Months":e>365-i&&e<366+i&&(n="Years"),{interval:t,intervalUnit:n}}function I(e,t,n){if(n.axisLabels.length<=2)return null;const i=[];for(let l=0;l<e.length;l++){const t=e[l];for(let e=0;e<t.length;e++)t[e].name.toLowerCase().includes("band")||i.push(t[e])}const a=[];if(i.length){const e=[];for(let i=2;i<n.axisLabels.length;i++){const a=(t.uomLabels?.length??0)>i?t.uomLabels?.[i]:"",l=n.axisLabels[i].toLowerCase().includes("time")||"iso8601"===a.toLowerCase()||"oledatetime"===a.toLowerCase();let s,o;if(l){const e=y(n.offset[i]);s=e.interval,o=e.intervalUnit}else s=n.offset[i],o=a;const r=[];l?(r.push((new Date).setTime(24*(t.envelopeAllDims.mins[i]-25569)*3600*1e3)),r.push((new Date).setTime(24*(t.envelopeAllDims.maxs[i]-25569)*3600*1e3))):(r.push(t.envelopeAllDims.mins[i]),r.push(t.envelopeAllDims.maxs[i])),e.push({name:n.axisLabels[i].trim(),description:n.axisLabels[i].trim(),unit:t.uomLabels&&t.uomLabels.length>i?t.uomLabels[i].trim():"",hasRegularIntervals:!0,extent:r,interval:s,intervalUnit:o})}if(i.forEach((t=>{const{allowedValues:n}=t,i=2===n?.length?[{min:n[0],max:n[1],avg:-1,stddev:-1}]:null;a.push({name:t.name.trim(),description:t.description?.trim()??"",unit:t.uom.trim(),statistics:i,dimensions:e})})),a.length)return{variables:a}}return null}function w(e,t){const n=l.getElement(e,"RectifiedGrid"),i=l.getSpaceDelimitedNumericValues(n,"low"),a=l.getSpaceDelimitedNumericValues(n,"high"),s=[];for(let l=0;l<i.length;l++)s.push(a[l]-i[l]+1);const o=l.getElementValue(n,"axisLabels").split(" "),r=l.getSpaceDelimitedNumericValues(n,"origin/pos"),m=l.getElements(n,"offsetVector"),u=[];for(let E=0;E<m.length;E++){const e=l.getSpaceDelimitedNumericValues(m[E]),t=e.findIndex((e=>0!==e));u[t]=e[t]}const g=["y","lat","latitude","north","nor","n","b"];let p=!1;if(t?.length&&o?.length){p=[...t].sort(((e,t)=>e<t?-1:1)).join(",")===[...o].sort(((e,t)=>e<t?-1:1)).join(",")}const c=p?o:t;let d,f,h;return g.includes(c[0].toLowerCase())?(d=s[1],f=s[0],h={y:Math.abs(u[0]),x:Math.abs(u[1])}):(d=s[0],f=s[1],h={x:Math.abs(u[0]),y:Math.abs(u[1])}),{columns:d,rows:f,origin:r,offset:u,resolution:h,gridSamples:s,axisLabels:o,hasSameAxisLabelsAsBoundedBy:p}}function T(e){const t=l.getElement(e,"EarthObservation");if(!t)return null;const i=l.getElement(t,"phenomenonTime"),a=i?f(i):null,s=l.getElement(t,"phenomenonTime"),o=s?f(s):null,r=l.getElementValue(t,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let m=null;if(r){const e=r.split(" ").map((e=>e.trim())).filter((e=>null!=e&&""!==e));if(e.length){const t=[];for(let n=0;n<e.length/2;n+=2)t.push(e[n],e[n+1]);m=new n({rings:[t],spatialReference:{wkid:4326}})}}return{observation:{phenomenonTime:a,resultTime:o,footprint:m,identifier:l.getElementValue(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:l.getElementValue(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:l.getElementValue(e,"metaDataProperty/EarthObservationMetaData/status")}}}function L(e){const t={version:"2.0"};let n,i,s=[];for(let a=0;a<e.childNodes.length;a++){const o=e.childNodes[a];if(1===o.nodeType)if(l.isSameTagIgnoreNS(o,"coverageId"))t.coverageId=l.getElementValue(o);else if(l.isSameTagIgnoreNS(o,"ServiceParameters"))t.serviceParameters={supportedFormats:l.getElementValues(o,"nativeFormat")};else if(l.isSameTagIgnoreNS(o,"boundedBy"))t.boundedBy=D(o);else if(l.isSameTagIgnoreNS(o,"rangeType")){const e=N(o,t.boundedBy?.axisLabels.length>2||t.domainSet?.axisLabels.length>2);t.rangeType=e.rangeType,s=e.bandNames,n=e.bandStats;const{bandNoDataValues:a}=e;a?.length&&(i=p(a))}else if(l.isSameTagIgnoreNS(o,"domainSet"))t.domainSet=w(o,t.boundedBy?.axisLabels);else if(l.isSameTagIgnoreNS(o,"metadata")){const e=l.getElement(o,"EOMetadata");t.eoMetadata=e?T(e):null}}const{coverageId:o,boundedBy:r,domainSet:m,rangeType:u,serviceParameters:g}=t,c=I(u,r,m);!n&&c&&(n=c?.variables[0].statistics),null!=c&&(i=u[0][0].nilValue);return{id:o,title:o,description:o,lonLatEnvelope:null,bandNames:s,rasterInfo:new a({width:m.columns,height:m.rows,pixelSize:m.resolution,extent:r.envelope,spatialReference:r.envelope.spatialReference,bandCount:s.length||1,statistics:n,noDataValue:i,multidimensionalInfo:c}),supportedFormats:g.supportedFormats,supportedInterpolations:null,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}function C(e,t){let n=null;if("string"==typeof e){n=(new DOMParser).parseFromString(e,"text/xml")}else n=e;if("1.0.0"===t){return l.getElements(n,"CoverageOffering").map((e=>E(e)))}const i=l.getElements(n,"CoverageDescription");return"1.1.0"===t||"1.1.1"===t||"1.1.2"===t?i.map((e=>v(e,t))):i.map((e=>L(e)))}e.parseCoverages=C,e.standardizeInterpolations=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
