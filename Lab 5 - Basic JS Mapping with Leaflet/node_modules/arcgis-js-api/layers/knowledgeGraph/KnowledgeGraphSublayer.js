/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../../chunks/tslib.es6","../../geometry","../../PopupTemplate","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/PieChartRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../renderers/support/types","../../core/workers/workers","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/projection","../../geometry/support/spatialReferenceUtils","../Layer","../graphics/data/FeatureStore","../graphics/data/QueryEngine","../graphics/sources/support/clientSideDefaults","./KnowledgeGraphLayerDataManager","./KnowledgeGraphSublayerBase","../mixins/BlendLayer","../mixins/FeatureReductionLayer","../mixins/RefreshableLayer","../mixins/ScaleRangeLayer","../support/commonProperties","../support/Field","../support/fieldUtils","../../rest/support/FeatureSet","../../rest/support/Query","../../support/popupUtils","../../core/workers/RemoteClient","../../geometry/Extent","../../geometry/Polygon","../../geometry/Polyline","../../geometry/support/typeUtils"],(function(e,t,r,o,a,i,s,n,p,y,l,d,u,c,h,g,m,f,b,_,T,w,F,S,N,O,L,x,Q,j,E,v,C,R,I,J,M,k,D,G,q,P){"use strict";let K=class extends(Q.FeatureReductionLayer(L.KnowledgeGraphSublayerBase(x.BlendLayer(E.ScaleRangeLayer(j.RefreshableLayer(w)))))){constructor(e){if(super(e),this.capabilities=N.createCapabilities(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=O.mockOidFieldName,this.objectType=null,this.parentCompositeLayer=null,this.popupEnabled=!0,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new k(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const r=J.fromJSON(e);return this.queryFeaturesJSON(r,t)}}}),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=O.mockLayoutGeometryFieldName;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?P.featureGeometryTypeKebabDictionary.fromJSON(t.geometryType):null;const r=t?.name,o=r?e.objectType.properties?.[r]:null;o?(this.hasM=o.hasM??!1,this.hasZ=o.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach((e=>{let t=null,r=e.fieldType;"esriFieldTypeOID"===r&&(r="esriFieldTypeInteger"),this.fields.push(C.fromJSON({name:e.name,type:r,alias:e.alias,defaultValue:t,editable:e.editable,nullable:e.nullable}))})),this.fields.push(C.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this.fields.push(C.fromJSON({name:O.mockAggregationCountFieldName,type:"esriFieldTypeInteger",alias:O.mockAggregationCountFieldName,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=d.fromJSON(N.createDrawingInfo(P.featureGeometryTypeKebabDictionary.toJSON("polyline")).renderer):this.renderer=d.fromJSON(N.createDrawingInfo(P.featureGeometryTypeKebabDictionary.toJSON("point")).renderer):this.renderer=d.fromJSON(N.createDrawingInfo(P.featureGeometryTypeKebabDictionary.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){R.fixRendererFields(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return M.createPopupTemplate(this,e)}createQuery(){return new J({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e),a=I.fromJSON(await o.executeQuery(r.toJSON(),t?.signal));return a.features.forEach((e=>{e.sourceLayer=this})),a}async queryFeaturesJSON(e,t){const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e);return await o.executeQuery(r.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e);return o.executeQueryForCount(r.toJSON(),t?.signal)}async queryExtent(e={},t){const r={...e,returnGeometry:!0},{resolvedQuery:o,queryEngine:a}=await this._setupQueryObjects(r),i=await a.executeQueryForExtent(o.toJSON(),t?.signal);let s;return s=null!=i.extent?.xmin&&null!=i.extent?.xmax&&null!=i.extent?.ymin&&null!=i.extent?.ymax?new D(i.extent):new D,{count:i.count,extent:s}}async queryObjectIds(e,t){const r=J.from(e);let o;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)o=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(r,this,t);o=this.loadQueryEngine(e)}return o.executeQueryForIds(r.toJSON(),t?.signal)}loadQueryEngine(e){const t=new F({geometryType:P.featureGeometryTypeKebabDictionary.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new S.QueryEngine({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:P.featureGeometryTypeKebabDictionary.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return r.featureStore.addMany(e),r}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new J({where:"1=1",outFields:[O.mockOidFieldName]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const r=J.from(e),o=r.geometry;let a;if(o&&!o.spatialReference?.isWGS84&&(await _.initializeProjection(o.spatialReference,T.wgs84),r.geometry=o instanceof G||o instanceof q?_.project(o,T.wgs84):_.project(o.extent,T.wgs84)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)a=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(r,this,t);a=this.loadQueryEngine(e)}return{resolvedQuery:r,queryEngine:a}}};e.__decorate([h.property()],K.prototype,"capabilities",void 0),e.__decorate([h.property({readOnly:!0})],K.prototype,"defaultPopupTemplate",null),e.__decorate([h.property()],K.prototype,"definitionExpression",void 0),e.__decorate([h.property()],K.prototype,"displayField",void 0),e.__decorate([h.property()],K.prototype,"elevationInfo",void 0),e.__decorate([h.property()],K.prototype,"geometryType",void 0),e.__decorate([h.property()],K.prototype,"geometryFieldName",void 0),e.__decorate([h.property()],K.prototype,"graphType",void 0),e.__decorate([h.property()],K.prototype,"hasM",void 0),e.__decorate([h.property()],K.prototype,"hasZ",void 0),e.__decorate([h.property()],K.prototype,"labelsVisible",void 0),e.__decorate([h.property()],K.prototype,"labelingInfo",void 0),e.__decorate([h.property()],K.prototype,"objectIdField",void 0),e.__decorate([h.property()],K.prototype,"objectType",void 0),e.__decorate([h.property()],K.prototype,"parentCompositeLayer",void 0),e.__decorate([h.property(v.popupEnabled)],K.prototype,"popupEnabled",void 0),e.__decorate([h.property({type:r,json:{name:"popupInfo",write:!0}})],K.prototype,"popupTemplate",void 0),e.__decorate([h.property({types:u.rendererTypes,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],K.prototype,"renderer",null),e.__decorate([h.property()],K.prototype,"source",void 0),e.__decorate([h.property({json:{read:!1}})],K.prototype,"type",void 0),K=e.__decorate([b.subclass("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],K);return K}));
