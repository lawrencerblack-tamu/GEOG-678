/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../request","../../core/Error","../graphics/featureConversionUtils","../graphics/OptimizedGeometry","../../rest/knowledgeGraphService","../../rest/knowledgeGraph/GraphQueryStreaming","../../rest/knowledgeGraph/ProtoFeatureCollection","../../rest/knowledgeGraph/wasmInterface/knowledgeWasmAccess","../../rest/knowledgeGraph/wasmInterface/WasmDataModelWrapperInterfaces","../../rest/knowledgeGraph/wasmInterface/WasmSerializedLayerData","../../rest/knowledgeGraph/wasmInterface/wasmToFeatureFactories"],(function(e,t,n,i,r,o,a,s,l,d,c,u){"use strict";function m(e){if(!e.spatialReference.isWGS84)throw new n("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let t;return t=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],t}async function y(e,t){const n=[],i=new Map,r=[];if(t.dataModel?.relationshipTypes)for(const o of t.dataModel.relationshipTypes)o.name&&i.set(o.name,[]);for(const o of e)i.has(o.typeName)&&i.get(o.typeName)?.push(o.id);for(const[s,l]of i){if(l.length<1)continue;const e=new a({openCypherQuery:`MATCH (n)-[r:${s}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:l}});r.push(o.executeQueryStreaming(t,e).then((async e=>{const t=e.resultRowsStream.getReader();for(;;){const{done:e,value:i}=await t.read();if(e)break;for(const t of i)n.push({id:t[0],typeName:t[1]}),n.push({id:t[2],typeName:t[3]})}})))}return await Promise.all(r),n}async function p(e,t){const n=new Map,i=new Map,r=[];if(t.dataModel?.relationshipTypes)for(const o of t.dataModel.relationshipTypes)o.name&&i.set(o.name,[]);for(const o of e)i.has(o.typeName)&&i.get(o.typeName)?.push(o.id);for(const[s,l]of i){if(l.length<1)continue;const e=new a({openCypherQuery:`MATCH (n)-[r:${s}]->(m) WHERE id(r) in $ids RETURN id(r), id(n), id(m)`,bindParameters:{ids:l}});r.push(o.executeQueryStreaming(t,e).then((async e=>{const t=e.resultRowsStream.getReader();for(;;){const{done:e,value:i}=await t.read();if(e)break;for(const t of i)n.set(t[0],[t[1],t[2]])}})))}return await Promise.all(r),n}async function f(e){const t=[],n={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(b(e.entitiesUrl).then((e=>{C(e,n)}))),e.relationshipsUrl&&t.push(b(e.relationshipsUrl).then((e=>{C(e,n)}))),e.idCollectionsUrl&&t.push(I(e.idCollectionsUrl).then((e=>{E(e,n)}))),await Promise.all(t),n}async function h(e){const t={generateAllSublayers:!1,namedTypeDefinitions:new Map};return await I(e).then((e=>{E(e,t)})),t}async function g(e,t,n){const i=await l.getWasmInterface(),r=new i.FeatureCollection,o=new i.FeatureCollection;try{x(r,i,e,"entities",t,n),x(o,i,e,"relationships",t,n);const a=new i.FeatureCollectionEncoder,s=new i.FeatureCollectionEncoder,l=M(r,a),d=structuredClone(l),c=M(o,s),u={entitiesFC:d,relationshipsFC:structuredClone(c),idCollections:await w(e)};return a.delete(),s.delete(),u}finally{r.delete(),o.delete()}}async function w(e){const t=await l.getWasmInterface(),i=new t.MapOfObjectIdentifierSets;_(i,t,e);const r=new t.MapOfObjectIdentifierSetsEncoder;try{r.set_map_of_identifier_sets(i),r.encode();const e=r.get_encoding_result();if(0!==e.error.error_code)throw new n("knowledge-graph:layer-support-utils",e.error.error_message);const t=structuredClone(e.get_byte_buffer());return r.delete(),t}finally{i.delete()}}function x(e,t,n,r,o,a){e.version="";const l=new t.QueryResult,u=new t.FeatureResult,m="entities"===r?s.ProtoOutboundEntityFeatureCollectionAttributionIndexes:s.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes;u.unique_id_field={name:m[m.ELEMENTUID],isSystemMaintained:!1},u.globalid_field_name=m[m.ELEMENTUID],u.geohash_field_name="",u.geometry_properties={shapeAreaFieldName:"",shapeLengthFieldName:"",units:""},u.spatial_reference={wkid:4326,latestWkid:4326,vcsWkid:0,latestVcsWkid:0,wkt:""},u.exceeded_transfer_limit=!1,u.has_z=!1,u.has_m=!1,u.transform={quantizeOriginPosition:{value:c.WasmQuantizeOriginPositionTypeCode.upperLeft},scale:{xScale:1e-9,yScale:1e-9,mScale:1e-4,zScale:1e-4},translate:{xTranslate:-400,yTranslate:-400,mTranslate:-1e5,zTranslate:-1e5}};for(const i of Object.keys(m).filter((e=>isNaN(Number(e))))){const e=new t.Field;if(e.name=i,e.alias=i,e.sql_type={value:c.SqlTypeCode.sqlTypeBigInt},"entities"===r)switch(i){case m[m.ELEMENTUID]:case m[m.TYPENAME]:e.field_type={value:d.EsriFieldTypes.esriFieldTypeString}}else switch(i){case m[m.ELEMENTUID]:case m[m.TYPENAME]:case s.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes[s.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes.FROMUID]:case s.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes[s.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes.TOUID]:e.field_type={value:d.EsriFieldTypes.esriFieldTypeString}}e.domain="",u.add_field(e),e.delete()}const y=new Map;for(const i of o.dataModel.entityTypes)y.set(i.name,"entities");for(const i of o.dataModel.relationshipTypes)y.set(i.name,"relationships");for(const[d,c]of n.namedTypeDefinitions)if(r===y.get(d))for(const e of c.members.values()){const n=new t.Feature;for(const i of Object.keys(m).filter((e=>isNaN(Number(e)))))if("entities"===r)switch(i){case m[m.ELEMENTUID]:n.add_attribute(e.id,t.esriFieldType.esriFieldTypeString);break;case m[m.TYPENAME]:n.add_attribute(d,t.esriFieldType.esriFieldTypeString)}else switch(i){case m[m.ELEMENTUID]:n.add_attribute(e.id,t.esriFieldType.esriFieldTypeString);break;case s.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes[s.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes.FROMUID]:n.add_attribute(a.has(e.id)?a.get(e.id)[0]:"",t.esriFieldType.esriFieldTypeString);break;case s.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes[s.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes.TOUID]:n.add_attribute(a.has(e.id)?a.get(e.id)[1]:"",t.esriFieldType.esriFieldTypeString);break;case m[m.TYPENAME]:n.add_attribute(d,t.esriFieldType.esriFieldTypeString)}let o;if(e.linkChartLocation&&"x"in e.linkChartLocation?o=i.convertFromGeometry(e.linkChartLocation):e.linkChartLocation&&(o=e.linkChartLocation),e.linkChartLocation&&o){const e=new t.FeatureCollectionGeometry;switch(r){case"entities":e.geometry_type=t.esriGeometryType.esriGeometryPoint;break;case"relationships":e.geometry_type=t.esriGeometryType.esriGeometryPolyline}e.coords=new Float64Array(o.coords),e.lengths=new Uint32Array(o.lengths),n.set_compressed_geometry(e),e.delete()}u.add_feature(n),n.delete()}switch(r){case"entities":u.geometry_type=t.esriGeometryType.esriGeometryPoint;break;case"relationships":u.geometry_type=t.esriGeometryType.esriGeometryPolyline}return l.set_feature_result(u),e.set_query_result(l),u.delete(),l.delete(),e}function _(e,t,n){for(const[i,r]of n.namedTypeDefinitions){if(!r.members||r.useAllData)continue;const n=r.members.keys(),o=new t.GlobalIdArray,a=new t.ObjectIdentifierSet;for(const e of n)o.add_globalid(e);a.set_globalid_array(o),o.delete(),e.put_identifier_set(i,a),a.delete()}return e}async function b(e){const n=await t(e,{responseType:"array-buffer"});return T(await n.data)}async function T(e){const t=new((await l.getWasmInterface()).FeatureCollectionDecoder),i=t.decode(new Uint8Array(e));if(0!==i.error_code)throw new n("knowledge-graph:layer-support-utils",i.error_message);const r=t.get_feature_collection(),o=u.wasmToProtoFeatureCollection(r);return t.delete(),o}async function I(e){const n=await t(e,{responseType:"array-buffer"}),i=await n.data;return F(new Uint8Array(i))}async function F(e){const t=new((await l.getWasmInterface()).MapOfObjectIdentifierSetsDecoder),i=t.decode(new Uint8Array(e)),r=new Map;if(0!==i.error_code)throw new n("knowledge-graph:layer-support-utils",i.error_message);const o=t.get_map_of_identifier_sets(),a=o.keys,s=a.size();for(let l=0;l<s;l++){const e=a.get(l),t=o.query_identifier_set(e),i=[];if(t.id_array_type.value===c.IdArrayType.GLOBALID_ARRAY){const e=t.get_globalid_array(),n=e.count();for(let t=0;t<n;t++)i.push(e.get_globalid_at(t))}else{if(t.id_array_type.value!==c.IdArrayType.IDENTIFIER_ARRAY)throw new n("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const e=t.get_identifier_array(),n=e.count();for(let t=0;t<n;t++)i.push(e.get_identifier_at(t).toString())}}r.set(e,i)}return t.delete(),r}function C(e,t){if(!e?.queryResult?.featureResult)return t;const n=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const i of e.queryResult.featureResult.features){const e=i.attributes[n[s.ProtoInboundFeatureCollectionAttributionNames.TYPENAME]],o=A(t.namedTypeDefinitions,e,(()=>({useAllData:!1,members:new Map}))),a=i.attributes[n[s.ProtoInboundFeatureCollectionAttributionNames.ELEMENTUID]];i.compressedGeometry?.coords?.length>0?o.members.set(a,{id:a,linkChartLocation:new r(i.compressedGeometry.lengths,i.compressedGeometry.coords)}):o.members.set(a,{id:a})}return t}function E(e,t){for(const[n,i]of e){const e=A(t.namedTypeDefinitions,n,(()=>({useAllData:!1,members:new Map})));for(const t of i)e.members.has(t)||e.members.set(t,{id:t})}return t}const A=(e,t,n)=>(e.has(t)||e.set(t,n()),e.get(t)),M=(e,t)=>{t.set_feature_collection(e),t.encode();const i=t.get_encoding_result();if(0!==i.error.error_code)throw new n("knowledge-graph:layer-support-utils",i.error.error_message);return i.get_byte_buffer()};e.addFeatureCollectionToInclusionDefinition=C,e.addIdMapToInclusionDefinition=E,e.deserializeFeatureCollection=T,e.deserializeIdCollectionMap=F,e.extentToInBoundsRings=m,e.fetchAndConvertSerializedKgIdMap=h,e.fetchAndConvertSerializedLinkChart=f,e.fetchAndDeserializeFeatureCollection=b,e.fetchAndDeserializeIdCollectionMap=I,e.getRelationshipEndNodeIds=y,e.getRelationshipEndNodeMap=p,e.serializeInclusionDefinitionToAllPbf=g,e.serializeInclusionDefinitionToIdCollectionsMapPbf=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
