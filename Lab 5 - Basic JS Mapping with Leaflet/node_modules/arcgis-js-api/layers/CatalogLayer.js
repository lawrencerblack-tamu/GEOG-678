/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["../chunks/tslib.es6","../request","../core/Clonable","../core/Collection","../core/Error","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/urlUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Layer","./catalog/CatalogDynamicGroupLayer","./catalog/CatalogFootprintLayer","./graphics/sources/FeatureLayerSource","./graphics/sources/support/clientSideDefaults","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/BlendLayer","./mixins/CustomParametersMixin","./mixins/FeatureLayerBase","./mixins/OperationalLayer","./mixins/OrderedLayer","./mixins/PortalLayer","./mixins/RefreshableLayer","./mixins/ScaleRangeLayer","./mixins/TemporalLayer","./support/featureLayerUtils","./support/fieldProperties","./support/versionUtils","../rest/support/Query"],(function(e,r,t,i,o,a,s,n,l,p,y,c,u,d,h,m,f,g,L,_,x,S,v,I,w,F,O,C,P,b,q,T,E){"use strict";const R="esri.layers.CatalogLayer",j=q.defineFieldProperties();let G=class extends(v.FeatureLayerBase(x.BlendLayer(w.OrderedLayer(P.TemporalLayer(C.ScaleRangeLayer(O.RefreshableLayer(_.ArcGISService(I.OperationalLayer(F.PortalLayer(a.MultiOriginJSONMixin(S.CustomParametersMixin(L.APIKeyMixin(t.ClonableMixin(d)))))))))))))){constructor(e){super(e),this.dynamicGroupLayer=new h({parent:this}),this.fields=null,this.fieldsIndex=null,this.footprintLayer=new m({parent:this}),this.itemSourceField="cd_itemsource",this.itemTypeField="cd_itemtype",this.layers=new i([this.dynamicGroupLayer,this.footprintLayer]),this.source=new f({layer:this}),this.type="catalog"}load(e){const r=null!=e?e.signal:null,t=this.loadFromPortal({supportedTypes:["Feature Service"]},e).catch(s.throwIfAbortError).then((async()=>{if(!this.url)throw new o("catalog-layer:missing-url","Catalog layer must be created with a url");if(this.url&&null==this.layerId){const e=await this._fetchFirstValidLayerId(r);if(null==e)throw new o("catalog-layer:missing-layerId","There is no Catalog Layer in the service",{service:this.url});this.layerId=e}await this.source.load(),this.source.sourceJSON&&(this.sourceJSON=this.source.sourceJSON,this.read(this.source.sourceJSON,{origin:"service",portalItem:this.portalItem,portal:this.portalItem?.portal,url:this.parsedUrl}))})).then((()=>b.ensureLayerCredential(this,"load",e)));return this.addResolvingPromise(t),Promise.resolve(this)}get createQueryVersion(){return this.commitProperty("definitionExpression"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("capabilities"),(this._get("createQueryVersion")??0)+1}get parsedUrl(){const e=n.urlToObject(this.url);return null!=e&&null!=this.layerId&&(e.path=n.join(e.path,this.layerId.toString())),e}createQuery(){const e=new E,r=this.capabilities?.query;e.returnGeometry=!0,r&&(e.compactGeometryEnabled=r.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=r.supportsDefaultSpatialReference),e.outFields=["*"];const{timeOffset:t,timeExtent:i}=this;return e.timeExtent=null!=t&&null!=i?i.offset(-t.value,t.unit):i||null,e}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,r){return this.fieldsIndex.get(e)?.domain}async queryFeatures(e,r){const t=await this.load(),i=await t.source.queryFeatures(E.from(e)??t.createQuery(),r);if(i?.features)for(const o of i.features)o.layer=o.sourceLayer=t.footprintLayer;return i}async queryObjectIds(e,r){return(await this.load()).source.queryObjectIds(E.from(e)??this.createQuery(),r)}async queryFeatureCount(e,r){return(await this.load()).source.queryFeatureCount(E.from(e)??this.createQuery(),r)}async queryExtent(e,r){return(await this.load()).source.queryExtent(E.from(e)??this.createQuery(),r)}serviceSupportsSpatialReference(e){return this.loaded&&T.serviceSupportsSpatialReference(this,e)}read(e,r){super.read(e,r);let t=e.footprintLayer;t||"service"!==r?.origin||(t={layerDefinition:{drawingInfo:g.createDrawingInfo(e.geometryType)}}),this.footprintLayer.read(t,r)}_fetchFirstValidLayerId(e){return r(this.url,{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e}).then((e=>{const r=e.data;if(r)return Array.isArray(r.layers)?r.layers.find((e=>"Catalog Layer"===e.type))?.id:void 0}))}};e.__decorate([l.property({readOnly:!0})],G.prototype,"createQueryVersion",null),e.__decorate([l.property({...j.fields,json:{origins:{service:{name:"fields"}}}})],G.prototype,"fields",void 0),e.__decorate([l.property(j.fieldsIndex)],G.prototype,"fieldsIndex",void 0),e.__decorate([l.property({json:{read:!1,write:!1}})],G.prototype,"footprintLayer",void 0),e.__decorate([l.property()],G.prototype,"itemSourceField",void 0),e.__decorate([l.property()],G.prototype,"itemTypeField",void 0),e.__decorate([l.property()],G.prototype,"layers",void 0),e.__decorate([l.property({value:"CatalogLayer",type:["CatalogLayer"]})],G.prototype,"operationalLayerType",void 0),e.__decorate([l.property()],G.prototype,"outFields",void 0),e.__decorate([l.property({readOnly:!0})],G.prototype,"parsedUrl",null),e.__decorate([l.property()],G.prototype,"source",void 0),e.__decorate([l.property({json:{read:!1}})],G.prototype,"type",void 0),G=e.__decorate([u.subclass(R)],G);return G}));
