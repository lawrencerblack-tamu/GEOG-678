/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../Color","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/PieChartRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/Logger","../../core/Error","../../renderers/support/AuthoringInfo","../../renderers/support/HeatmapColorStop","../../renderers/support/heatmapUtils","./support/utils","../statistics/heatmapStatistics","../support/utils","../support/adapters/support/layerUtils","../symbology/heatmap"],(function(e,r,a,t,n,s,i,o,l,d,m,p,u,c,y,h,f,w,b,g,R){"use strict";const T=.01;async function L(e){if(!e?.layer||!e.view)throw new u("heatmap-renderer:missing-parameters","'layer' and 'view' parameters are required");const r={...e,layer:e.layer,view:e.view};r.radius??=null==r.blurRadius?18:h.gaussianBlurRadiusPxToKernelDensityRadiusPt(r.blurRadius),r.minRatio??=.01,r.maxRatio??=1,r.fadeRatio??=.2,r.fadeToTransparent??=!0;const a=[g.LayerType.CSVLayer,g.LayerType.FeatureLayer,g.LayerType.GeoJSONLayer,g.LayerType.OGCFeatureLayer,g.LayerType.OrientedImageryLayer,g.LayerType.StreamLayer,g.LayerType.WFSLayer],t=g.createLayerAdapter(r.layer,a);if(!t)throw new u("heatmap-renderer:invalid-parameters","'layer' must be one of these types: "+g.getLayerTypeLabels(a).join(", "));r.layer=t;const n=null!=r.signal?{signal:r.signal}:null;await t.load(n);const s=await b.getFieldsList({field:r.field}),i=f.verifyBasicFieldValidity(t,s,"heatmap-renderer:invalid-parameters");if(i)throw i;return r}async function S(e){let r=e.scheme,a=null,t=null;const n=await f.getBasemapInfo(e.basemap,e.view);if(a=null!=n.basemapId?n.basemapId:null,t=null!=n.basemapTheme?n.basemapTheme:null,r)return{scheme:R.cloneScheme(r),basemapId:a,basemapTheme:t};const s=R.getSchemes({basemapTheme:t});return s&&(r=s.primaryScheme,a=s.basemapId,t=s.basemapTheme),{scheme:r,basemapId:a,basemapTheme:t}}async function I(e,a){const{field:t,basemap:n,radius:i,fadeToTransparent:o,heatmapScheme:l,view:d}=a,{scheme:m,basemapId:p,basemapTheme:u}=await S({basemap:n,scheme:l,view:d}),h=m.colors,w=h.length,b=null==e.min,g=b?[0,.04]:[e.min,e.max];let L;const I=a.fadeRatio??0,x=a.maxRatio??0,C=a.minRatio??0,D=(x-C)/(w-1),F=h[0],U=o?C:T,B=[new y({ratio:0,color:new r([F.r,F.g,F.b,0])}),new y({ratio:T,color:new r([F.r,F.g,F.b,0])}),new y({ratio:U,color:new r([F.r,F.g,F.b,U])})];f.createColors(h,w).forEach(((e,r)=>{const a=C+D*r;B.push(new y({ratio:a,color:e}))})),o&&(v(B,I),L=new c({fadeRatio:I}));return{renderer:new s({authoringInfo:L,radius:i,colorStops:B,field:t,minDensity:g[0],maxDensity:g[1]}),statistics:e,defaultValuesUsed:b,scheme:R.cloneScheme(m),basemapId:p,basemapTheme:u}}function v(e,r){const a=10*(1-r)+1,t=e.length-3,n=e[2].color.a;e.forEach(((e,s)=>{if(s<=2)return;const{color:i}=e,o=(s-3)/t;i.a=0===r?1:Math.min(Math.max(o*a+o+n,n),1)}))}async function x(e){const r=await L(e);return I(r.statistics??await w({layer:r.layer,field:r.field,radius:r.radius,view:r.view,signal:r.signal}),r)}function C(e){const{fadeRatio:r,renderer:a}=e,t=a.clone(),n=r??(t?.authoringInfo?.fadeRatio||0);return v(t.colorStops,n),t.authoringInfo?t.authoringInfo.fadeRatio=n:t.authoringInfo=new c({fadeRatio:n}),t}e.createRenderer=x,e.updateRenderer=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
