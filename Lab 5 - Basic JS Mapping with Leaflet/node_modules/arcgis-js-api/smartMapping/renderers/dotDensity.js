/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/PieChartRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/Logger","../../core/Error","../../geometry/support/scaleUtils","../../renderers/support/AuthoringInfo","../heuristics/outline","./support/dotDensityUtils","./support/utils","../statistics/spatialStatistics","../statistics/summaryStatisticsForAttributes","../statistics/support/attributeDensity","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils","../symbology/dotDensity"],(function(e,r,t,a,n,i,s,l,o,u,d,p,c,y,m,g,b,f,h,w,v,S,V,T){"use strict";const x=500;async function E(e){const r=e.view;if(!(e?.layer&&r&&e.attributes?.length))throw new p("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>8)throw new p("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");e.forBinning&&v.verifyBinningParams(e,"dot-density-renderer");const t={...e,view:r,layer:e.layer,attributes:e.attributes},a=[V.LayerType.FeatureLayer,V.LayerType.OGCFeatureLayer,V.LayerType.GeoJSONLayer,V.LayerType.WFSLayer],n=e.forBinning?V.binningCapableLayerTypes:a,i=V.createLayerAdapter(t.layer,n,e.forBinning);if(!i)throw new p("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+V.getLayerTypeLabels(n).join(", "));t.layer=i,t.dotBlendingEnabled??=!0,t.dotValueOptimizationEnabled??=!0;const s=null!=t.signal?{signal:t.signal}:null;await Promise.all([r.when(),i.load(s)]);if("polygon"!==i.geometryType)throw new p("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");const l=[],o=t.attributes;for(const d of o){const e=await S.getFieldsList({field:d.field,valueExpression:d.valueExpression});l.push(...e)}const u=b.verifyBasicFieldValidity(i,l.filter(Boolean),"dot-density-renderer:invalid-parameters");if(u)throw u;return t}async function L(e){let r=e.dotDensityScheme,t=null,a=null;const n=await b.getBasemapInfo(e.basemap,e.view);if(t=null!=n.basemapId?n.basemapId:null,a=null!=n.basemapTheme?n.basemapTheme:null,r)return{scheme:T.cloneScheme(r),basemapId:t,basemapTheme:a};const i=T.getSchemes({numColors:e.attributes.length,basemapTheme:a});return i&&(r=i.primaryScheme,t=i.basemapId,a=i.basemapTheme),{scheme:r,basemapId:t,basemapTheme:a}}function D(e){return{dotValue:1,referenceScale:e.scale,minSliderValue:1,maxSliderValue:100}}async function F(e){const{view:r,layer:t,attributes:a,signal:n}=e,i=await t.getSampleFeatures({view:r,sampleSize:x,returnGeometry:!0,signal:n},"json"),[s,l]=await Promise.all([f({features:i,geometryType:t.geometryType}),h({layer:t,attributes:a,includeZeros:!1,includeNegatives:!1,view:r,signal:n})]),o=null!=s&&"avgSize"in s&&s.avgSize,u=l.avg;if(!o||!u)return D(r);const d=c.getResolutionForScale(r.scale,r.spatialReference),p=o*o/(d*d)*.1;return{dotValue:g.roundValue(u/p)||1,referenceScale:r.scale,minSliderValue:1,maxSliderValue:g.roundValue(u)}}async function R(e){const{view:r,layer:t,attributes:a,signal:n}=e,i=[];for(const c of a){const e=await S.getFieldsList({field:c.field,valueExpression:c.valueExpression});i.push(...e)}const s=await t.getSampleFeatures({view:r,sampleSize:x,requiredFields:i,returnGeometry:!0,signal:n},"json"),{minDensity:l,maxDensity:o,avgDensity:u}=await w({features:s,attributes:a,includeZeros:!1,includeNegatives:!1,view:r});if(!u||!l||!o)return D(r);const d=c.getResolutionForScale(r.scale,r.spatialReference),p=d*d,y=g.roundValue(l*p),m=g.roundValue(o*p),b=10;let f=g.roundValue(u*p*b)||1;return f>m&&(f=m),{dotValue:f,referenceScale:r.scale,minSliderValue:y,maxSliderValue:m}}async function B(e){const r=await E(e),t=r.layer,n=t.geometryType,i=await L(r),s=i?.scheme;if(!s)throw new p("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");const l=r.view,o={layer:t,view:l,attributes:r.attributes,signal:r.signal},u={layer:r.layer,view:l,signal:r.signal},[d,c]=await Promise.all([r.trueDensity?R(o):F(o),r.outlineOptimizationEnabled?m(u).catch(b.errorCallback):null]),{dotValue:g,referenceScale:f,minSliderValue:h,maxSliderValue:w}=d,v=b.createColors(s.colors,r.attributes.length),S=r.attributes.map(((e,r)=>({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:v[r]}))),V=new a({attributes:S,dotBlendingEnabled:r.dotBlendingEnabled,outline:c?b.getSymbolOutlineFromScheme(s,n,c.opacity):null,dotValue:g,referenceScale:r.dotValueOptimizationEnabled?f:null,legendOptions:r.legendOptions});return c&&c.visualVariables&&c.visualVariables.length&&(V.visualVariables=c.visualVariables.map((e=>e.clone()))),V.authoringInfo=new y({type:"dot-density",minSliderValue:h,maxSliderValue:w}),{renderer:V,dotDensityScheme:s,basemapId:i.basemapId,basemapTheme:i.basemapTheme}}e.createRenderer=B,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
