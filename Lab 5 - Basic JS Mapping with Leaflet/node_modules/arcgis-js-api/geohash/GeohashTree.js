/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
define(["exports","./geohashUtils","../geometry/SpatialReference","../layers/graphics/featureConversionUtils","../layers/graphics/OptimizedGeometry","../layers/graphics/data/projectionSupport","../views/2d/layers/features/aggregation/AccumulatedStatistics"],(function(t,e,o,s,i,h,r){"use strict";class n{static create(t,e,o,s){const i=r.AccumulatedStatistics.create(t),h=new Array(32);for(let r=0;r<h.length;r++)h[r]=null;return new n(i,e,o,s,h)}constructor(t,e,o,s,i){this._statistics=t,this.xNode=e,this.yNode=o,this.depth=s,this.children=i,this._objectIds=new Set,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._xGeohashTotal=0,this._yGeohashTotal=0,this.next=null}get id(){return`${this.xNode}.${this.yNode}`}get objectIds(){return this._objectIds}clone(){const t=new n(this._statistics.clone(),this.xNode,this.yNode,this.depth,this.children);return t._count=this._count,t._xWorldTotal=this._xWorldTotal,t._yWorldTotal=this._yWorldTotal,t._xGeohashTotal=this._xGeohashTotal,t._yGeohashTotal=this._yGeohashTotal,t.next=this.next,t.cachedFeature=this.cachedFeature,t._objectIds=new Set(this._objectIds),t}insert(t,e,o,s,i,h){this._count+=1,this._xWorldTotal+=e,this._yWorldTotal+=o,this._xGeohashTotal+=s,this._yGeohashTotal+=i,this._statistics.insert(t,h),this._objectIds.add(t.getObjectId())}merge(t){if(0!==t._count){this._count+=t._count,this._xWorldTotal+=t._xWorldTotal,this._yWorldTotal+=t._yWorldTotal,this._xGeohashTotal+=t._xWorldTotal,this._yGeohashTotal+=t._yWorldTotal,this._statistics.merge(t._statistics);for(const e of t._objectIds.values())this._objectIds.add(e)}}getGeometry(t,e){const r=this._getLngLatBounds(),[n,a,l,c]=r,d={rings:[[[n,a],[n,c],[l,c],[l,a],[n,a]]]},u=h.project(d,o.WGS84,t),_=s.convertFromPolygon(new i,u,!1,!1);if(null!=e){return s.quantizeOptimizedGeometry(new i,_,!1,!1,"esriGeometryPolygon",e,!1,!1)}return _}getGeometryCentroid(t,e){const r=this._getLngLatBounds(),[n,a,l,c]=r,d={x:(n+l)/2,y:(a+c)/2},u=h.project(d,o.WGS84,t),_=s.convertFromPoint(new i,u);if(null!=e){return s.quantizeOptimizedGeometry(new i,_,!1,!1,"esriGeometryPoint",e,!1,!1)}return _}getAttributes(){const t={aggregateId:this.id};for(const e of this._statistics.values())t[e.field.name]=e.value;return t.aggregateCount=this._count,t}_getLngLatBounds(){const t=this.depth,o=Math.ceil(t/2),s=Math.floor(t/2),i=30-(3*o+2*s),h=30-(2*o+3*s),r=this.xNode<<i,n=this.yNode<<h;return e.decodeGeohashXY({geohashX:r,geohashY:n},this.depth)}}class a{constructor(t){this._fields=t,this._root=n.create(this._fields,0,0,0)}destroy(){}insert(t,e,o,s,i,h,r){let a=this._root,l=0,c=0,d=0;for(;null!==a;){if(a.insert(t,e,o,s,i,r),l>=h)return;const u=Math.ceil((l+1)/2),_=Math.floor((l+1)/2),g=1-l%2,y=30-(3*u+2*_),x=30-(2*u+3*_),f=(s&7*g+3*(1-g)<<y)>>y,T=(i&3*g+7*(1-g)<<x)>>x,m=f+T*(8*g+4*(1-g));c=c<<3*g+2*(1-g)|f,d=d<<2*g+3*(1-g)|T,null==a.children[m]&&(a.children[m]=n.create(this._fields,c,d,l+1)),l+=1,a=a.children[m]}}putBins(t,e){for(const o of this.getNodes(e)){const e=t.get(o.id);e?e.merge(o):t.set(o.id,o.clone())}}getNodes(t){const e=[],{geohashBounds:o,level:s}=t;let i=this._root;for(;null!==i;){const t=i.depth,h=i.xNode,r=i.yNode;if(t>=s){e.push(i),i=i.next;continue}const n=Math.ceil((t+1)/2),a=Math.floor((t+1)/2),l=1-t%2,c=30-(3*n+2*a),d=30-(2*n+3*a),u=~((1<<c)-1),_=~((1<<d)-1),g=(o.xLL&u)>>c,y=(o.yLL&_)>>d,x=(o.xTR&u)>>c,f=(o.yTR&_)>>d,T=h<<3*l+2*(1-l),m=r<<2*l+3*(1-l),G=T+8*l+4*(1-l),p=m+4*l+8*(1-l),W=Math.max(T,g),j=Math.max(m,y),b=Math.min(G,x),N=Math.min(p,f);let M=null,w=null;for(let e=j;e<=N;e++)for(let t=W;t<=b;t++){const o=t-T+(e-m)*(8*l+4*(1-l)),s=i.children[o];s&&(M||(M=s,M.next=i.next),w&&(w.next=s),w=s,s.next=i.next)}i=M||i.next}return e}}t.GeohashCell=n,t.GeohashTree=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
